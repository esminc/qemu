cscope 15 /mnt/external2/qemu/qemu-1.2.0/hw/usb               0000703561
	@bus.c

1 
	~"hw/hw.h
"

2 
	~"hw/usb.h
"

3 
	~"hw/qdev.h
"

4 
	~"sy£mu.h
"

5 
	~"mÚ™Ü.h
"

6 
	~"Œaû.h
"

8 
usb_bus_dev_´št
(
MÚ™Ü
 *
mÚ
, 
DeviûS‹
 *
qdev
, 
šd’t
);

10 *
usb_g‘_dev_·th
(
DeviûS‹
 *
dev
);

11 *
usb_g‘_fw_dev_·th
(
DeviûS‹
 *
qdev
);

12 
usb_qdev_ex™
(
DeviûS‹
 *
qdev
);

14 
Prİ”ty
 
	gusb_´İs
[] = {

15 
DEFINE_PROP_STRING
("pÜt", 
USBDeviû
, 
pÜt_·th
),

16 
DEFINE_PROP_BIT
("fuÎ-·th", 
USBDeviû
, 
æags
,

17 
USB_DEV_FLAG_FULL_PATH
, 
Œue
),

18 
DEFINE_PROP_END_OF_LIST
()

21 
	$usb_bus_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

23 
BusCÏss
 *
k
 = 
	`BUS_CLASS
(
kÏss
);

25 
k
->
´št_dev
 = 
usb_bus_dev_´št
;

26 
k
->
g‘_dev_·th
 = 
usb_g‘_dev_·th
;

27 
k
->
g‘_fw_dev_·th
 = 
usb_g‘_fw_dev_·th
;

28 
	}
}

30 cÚ¡ 
Ty³Info
 
	gusb_bus_šfo
 = {

31 .
Çme
 = 
TYPE_USB_BUS
,

32 .
	g·»Á
 = 
TYPE_BUS
,

33 .
	gš¡ªû_size
 = (
USBBus
),

34 .
	gşass_š™
 = 
usb_bus_şass_š™
,

37 
	gÃxt_usb_bus
 = 0;

38 
	$QTAILQ_HEAD
(, 
USBBus
è
bus£s
 = 
	`QTAILQ_HEAD_INITIALIZER
(busses);

40 
	$usb_deviû_po¡_lßd
(*
İaque
, 
v”siÚ_id
)

42 
USBDeviû
 *
dev
 = 
İaque
;

44 ià(
dev
->
¡©e
 =ğ
USB_STATE_NOTATTACHED
) {

45 
dev
->
©ched
 = 0;

47 
dev
->
©ched
 = 1;

50 
	}
}

52 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_deviû
 = {

53 .
Çme
 = "USBDevice",

54 .
	gv”siÚ_id
 = 1,

55 .
	gmšimum_v”siÚ_id
 = 1,

56 .
	gpo¡_lßd
 = 
usb_deviû_po¡_lßd
,

57 .
	gf›lds
 = (
VMS‹F›ld
 []) {

58 
VMSTATE_UINT8
(
addr
, 
USBDeviû
),

59 
VMSTATE_INT32
(
¡©e
, 
USBDeviû
),

60 
VMSTATE_INT32
(
»mÙe_wakeup
, 
USBDeviû
),

61 
VMSTATE_INT32
(
£tup_¡©e
, 
USBDeviû
),

62 
VMSTATE_INT32
(
£tup_Ën
, 
USBDeviû
),

63 
VMSTATE_INT32
(
£tup_šdex
, 
USBDeviû
),

64 
VMSTATE_UINT8_ARRAY
(
£tup_buf
, 
USBDeviû
, 8),

65 
VMSTATE_END_OF_LIST
(),

69 
	$usb_bus_Ãw
(
USBBus
 *
bus
, 
USBBusOps
 *
İs
, 
DeviûS‹
 *
ho¡
)

71 
	`qbus_ü—‹_š¶aû
(&
bus
->
qbus
, 
TYPE_USB_BUS
, 
ho¡
, 
NULL
);

72 
bus
->
İs
 = ops;

73 
bus
->
bu¢r
 = 
Ãxt_usb_bus
++;

74 
bus
->
qbus
.
®low_hÙ¶ug
 = 1;

75 
	`QTAILQ_INIT
(&
bus
->
ä“
);

76 
	`QTAILQ_INIT
(&
bus
->
u£d
);

77 
	`QTAILQ_INSERT_TAIL
(&
bus£s
, 
bus
, 
Ãxt
);

78 
	}
}

80 
USBBus
 *
	$usb_bus_fšd
(
bu¢r
)

82 
USBBus
 *
bus
;

84 ià(-1 =ğ
bu¢r
)

85  
	`QTAILQ_FIRST
(&
bus£s
);

86 
	`QTAILQ_FOREACH
(
bus
, &
bus£s
, 
Ãxt
) {

87 ià(
bus
->
bu¢r
 == busnr)

88  
bus
;

90  
NULL
;

91 
	}
}

93 
	$usb_deviû_š™
(
USBDeviû
 *
dev
)

95 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

96 ià(
kÏss
->
š™
) {

97  
kÏss
->
	`š™
(
dev
);

100 
	}
}

102 
USBDeviû
 *
	$usb_deviû_fšd_deviû
(
USBDeviû
 *
dev
, 
ušt8_t
 
addr
)

104 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

105 ià(
kÏss
->
fšd_deviû
) {

106  
kÏss
->
	`fšd_deviû
(
dev
, 
addr
);

108  
NULL
;

109 
	}
}

111 
	$usb_deviû_hªdË_de¡roy
(
USBDeviû
 *
dev
)

113 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

114 ià(
kÏss
->
hªdË_de¡roy
) {

115 
kÏss
->
	`hªdË_de¡roy
(
dev
);

117 
	}
}

119 
	$usb_deviû_ÿnûl_·ck‘
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

121 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

122 ià(
kÏss
->
ÿnûl_·ck‘
) {

123 
kÏss
->
	`ÿnûl_·ck‘
(
dev
, 
p
);

125 
	}
}

127 
	$usb_deviû_hªdË_©ch
(
USBDeviû
 *
dev
)

129 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

130 ià(
kÏss
->
hªdË_©ch
) {

131 
kÏss
->
	`hªdË_©ch
(
dev
);

133 
	}
}

135 
	$usb_deviû_hªdË_»£t
(
USBDeviû
 *
dev
)

137 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

138 ià(
kÏss
->
hªdË_»£t
) {

139 
kÏss
->
	`hªdË_»£t
(
dev
);

141 
	}
}

143 
	$usb_deviû_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
, 
»que¡
,

144 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

146 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

147 ià(
kÏss
->
hªdË_cÚŒŞ
) {

148  
kÏss
->
	`hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
,

149 
d©a
);

151  -
ENOSYS
;

152 
	}
}

154 
	$usb_deviû_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

156 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

157 ià(
kÏss
->
hªdË_d©a
) {

158  
kÏss
->
	`hªdË_d©a
(
dev
, 
p
);

160  -
ENOSYS
;

161 
	}
}

163 cÚ¡ *
	$usb_deviû_g‘_´oduù_desc
(
USBDeviû
 *
dev
)

165 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

166  
kÏss
->
´oduù_desc
;

167 
	}
}

169 cÚ¡ 
USBDesc
 *
	$usb_deviû_g‘_usb_desc
(
USBDeviû
 *
dev
)

171 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

172  
kÏss
->
usb_desc
;

173 
	}
}

175 
	$usb_deviû_£t_š‹rçû
(
USBDeviû
 *
dev
, 
š‹rçû
,

176 
®t_Şd
, 
®t_Ãw
)

178 
USBDeviûCÏss
 *
kÏss
 = 
	`USB_DEVICE_GET_CLASS
(
dev
);

179 ià(
kÏss
->
£t_š‹rçû
) {

180 
kÏss
->
	`£t_š‹rçû
(
dev
, 
š‹rçû
, 
®t_Şd
, 
®t_Ãw
);

182 
	}
}

184 
	$usb_qdev_š™
(
DeviûS‹
 *
qdev
)

186 
USBDeviû
 *
dev
 = 
	`USB_DEVICE
(
qdev
);

187 
rc
;

189 
	`p¡rıy
(
dev
->
´oduù_desc
, (dev->product_desc),

190 
	`usb_deviû_g‘_´oduù_desc
(
dev
));

191 
dev
->
auto_©ch
 = 1;

192 
	`QLIST_INIT
(&
dev
->
¡ršgs
);

193 
	`usb_•_š™
(
dev
);

194 
rc
 = 
	`usb_şaim_pÜt
(
dev
);

195 ià(
rc
 != 0) {

196  
rc
;

198 
rc
 = 
	`usb_deviû_š™
(
dev
);

199 ià(
rc
 != 0) {

200 
	`usb_»Ëa£_pÜt
(
dev
);

201  
rc
;

203 ià(
dev
->
auto_©ch
) {

204 
rc
 = 
	`usb_deviû_©ch
(
dev
);

205 ià(
rc
 != 0) {

206 
	`usb_qdev_ex™
(
qdev
);

207  
rc
;

211 
	}
}

213 
	$usb_qdev_ex™
(
DeviûS‹
 *
qdev
)

215 
USBDeviû
 *
dev
 = 
	`USB_DEVICE
(
qdev
);

217 ià(
dev
->
©ched
) {

218 
	`usb_deviû_d‘ach
(
dev
);

220 
	`usb_deviû_hªdË_de¡roy
(
dev
);

221 ià(
dev
->
pÜt
) {

222 
	`usb_»Ëa£_pÜt
(
dev
);

225 
	}
}

227 
	sLegacyUSBFaùÜy


229 cÚ¡ *
	mÇme
;

230 cÚ¡ *
	musbdeviû_Çme
;

231 
	mUSBDeviû
 *(*
	musbdeviû_š™
)(
USBBus
 *
	mbus
, cÚ¡ *
	m·¿ms
);

232 } 
	tLegacyUSBFaùÜy
;

234 
GSLi¡
 *
	gËgacy_usb_çùÜy
;

236 
usb_Ëgacy_»gi¡”
(cÚ¡ *
ty³Çme
, cÚ¡ *
usbdeviû_Çme
,

237 
USBDeviû
 *(*
usbdeviû_š™
)(
USBBus
 *
bus
,

238 cÚ¡ *
·¿ms
))

240 ià(
	gusbdeviû_Çme
) {

241 
LegacyUSBFaùÜy
 *
	gf
 = 
g_m®loc0
((*
f
));

242 
	gf
->
	gÇme
 = 
ty³Çme
;

243 
	gf
->
	gusbdeviû_Çme
 = 
usbdeviû_Çme
;

244 
	gf
->
	gusbdeviû_š™
 = 
usbdeviû_š™
;

245 
	gËgacy_usb_çùÜy
 = 
g_¦i¡_­³nd
(
Ëgacy_usb_çùÜy
, 
f
);

249 
USBDeviû
 *
	$usb_ü—‹
(
USBBus
 *
bus
, cÚ¡ *
Çme
)

251 
DeviûS‹
 *
dev
;

253 
dev
 = 
	`qdev_ü—‹
(&
bus
->
qbus
, 
Çme
);

254  
	`USB_DEVICE
(
dev
);

255 
	}
}

257 
USBDeviû
 *
	$usb_ü—‹_sim¶e
(
USBBus
 *
bus
, cÚ¡ *
Çme
)

259 
USBDeviû
 *
dev
 = 
	`usb_ü—‹
(
bus
, 
Çme
);

260 
rc
;

262 ià(!
dev
) {

263 
	`”rÜ_»pÜt
("FaedØü—‹ USB deviû '%s'", 
Çme
);

264  
NULL
;

266 
rc
 = 
	`qdev_š™
(&
dev
->
qdev
);

267 ià(
rc
 < 0) {

268 
	`”rÜ_»pÜt
("FaedØš™ŸlizUSB deviû '%s'", 
Çme
);

269  
NULL
;

271  
dev
;

272 
	}
}

274 
	$usb_fl_pÜt
(
USBPÜt
 *
pÜt
, *
İaque
, 
šdex
,

275 
USBPÜtOps
 *
İs
, 
¥“dmask
)

277 
pÜt
->
İaque
 = opaque;

278 
pÜt
->
šdex
 = index;

279 
pÜt
->
İs
 = ops;

280 
pÜt
->
¥“dmask
 = speedmask;

281 
	`usb_pÜt_loÿtiÚ
(
pÜt
, 
NULL
, 
šdex
 + 1);

282 
	}
}

284 
	$usb_»gi¡”_pÜt
(
USBBus
 *
bus
, 
USBPÜt
 *
pÜt
, *
İaque
, 
šdex
,

285 
USBPÜtOps
 *
İs
, 
¥“dmask
)

287 
	`usb_fl_pÜt
(
pÜt
, 
İaque
, 
šdex
, 
İs
, 
¥“dmask
);

288 
	`QTAILQ_INSERT_TAIL
(&
bus
->
ä“
, 
pÜt
, 
Ãxt
);

289 
bus
->
nä“
++;

290 
	}
}

292 
	$usb_»gi¡”_com·niÚ
(cÚ¡ *
ma¡”bus
, 
USBPÜt
 *
pÜts
[],

293 
ušt32_t
 
pÜtcouÁ
, ušt32_ˆ
fœ¡pÜt
,

294 *
İaque
, 
USBPÜtOps
 *
İs
, 
¥“dmask
)

296 
USBBus
 *
bus
;

297 
i
;

299 
	`QTAILQ_FOREACH
(
bus
, &
bus£s
, 
Ãxt
) {

300 ià(
	`¡rcmp
(
bus
->
qbus
.
Çme
, 
ma¡”bus
) == 0) {

305 ià(!
bus
 || !bus->
İs
->
»gi¡”_com·niÚ
) {

306 
	`q”rÜ_»pÜt
(
QERR_INVALID_PARAMETER_VALUE
, "masterbus",

308 ià(
bus
) {

309 
	`”rÜ_´štf_uÆess_qmp
(

311 
ma¡”bus
);

316 
i
 = 0; i < 
pÜtcouÁ
; i++) {

317 
	`usb_fl_pÜt
(
pÜts
[
i
], 
İaque
, i, 
İs
, 
¥“dmask
);

320  
bus
->
İs
->
	`»gi¡”_com·niÚ
(bus, 
pÜts
, 
pÜtcouÁ
, 
fœ¡pÜt
);

321 
	}
}

323 
	$usb_pÜt_loÿtiÚ
(
USBPÜt
 *
down¡»am
, USBPÜˆ*
up¡»am
, 
pÜŠr
)

325 ià(
up¡»am
) {

326 
	`¢´štf
(
down¡»am
->
·th
, (downstream->path), "%s.%d",

327 
up¡»am
->
·th
, 
pÜŠr
);

329 
	`¢´štf
(
down¡»am
->
·th
, (down¡»am->·th), "%d", 
pÜŠr
);

331 
	}
}

333 
	$usb_uÄegi¡”_pÜt
(
USBBus
 *
bus
, 
USBPÜt
 *
pÜt
)

335 ià(
pÜt
->
dev
)

336 
	`qdev_ä“
(&
pÜt
->
dev
->
qdev
);

337 
	`QTAILQ_REMOVE
(&
bus
->
ä“
, 
pÜt
, 
Ãxt
);

338 
bus
->
nä“
--;

339 
	}
}

341 
	$usb_şaim_pÜt
(
USBDeviû
 *
dev
)

343 
USBBus
 *
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

344 
USBPÜt
 *
pÜt
;

346 
	`as£¹
(
dev
->
pÜt
 =ğ
NULL
);

348 ià(
dev
->
pÜt_·th
) {

349 
	`QTAILQ_FOREACH
(
pÜt
, &
bus
->
ä“
, 
Ãxt
) {

350 ià(
	`¡rcmp
(
pÜt
->
·th
, 
dev
->
pÜt_·th
) == 0) {

354 ià(
pÜt
 =ğ
NULL
) {

355 
	`”rÜ_»pÜt
("Error: usb…ort %s (bus %s)‚ot found (in use?)",

356 
dev
->
pÜt_·th
, 
bus
->
qbus
.
Çme
);

360 ià(
bus
->
nä“
 =ğ1 && 
	`¡rcmp
(
	`objeù_g‘_ty³Çme
(
	`OBJECT
(
dev
)), "usb-hub") != 0) {

362 
	`usb_ü—‹_sim¶e
(
bus
, "usb-hub");

364 ià(
bus
->
nä“
 == 0) {

365 
	`”rÜ_»pÜt
("Error:riedo‡ttach usb device %so‡ bus "

366 "w™h‚Øä“…Üts", 
dev
->
´oduù_desc
);

369 
pÜt
 = 
	`QTAILQ_FIRST
(&
bus
->
ä“
);

371 
	`Œaû_usb_pÜt_şaim
(
bus
->
bu¢r
, 
pÜt
->
·th
);

373 
	`QTAILQ_REMOVE
(&
bus
->
ä“
, 
pÜt
, 
Ãxt
);

374 
bus
->
nä“
--;

376 
dev
->
pÜt
 =…ort;

377 
pÜt
->
dev
 = dev;

379 
	`QTAILQ_INSERT_TAIL
(&
bus
->
u£d
, 
pÜt
, 
Ãxt
);

380 
bus
->
nu£d
++;

382 
	}
}

384 
	$usb_»Ëa£_pÜt
(
USBDeviû
 *
dev
)

386 
USBBus
 *
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

387 
USBPÜt
 *
pÜt
 = 
dev
->port;

389 
	`as£¹
(
pÜt
 !ğ
NULL
);

390 
	`Œaû_usb_pÜt_»Ëa£
(
bus
->
bu¢r
, 
pÜt
->
·th
);

392 
	`QTAILQ_REMOVE
(&
bus
->
u£d
, 
pÜt
, 
Ãxt
);

393 
bus
->
nu£d
--;

395 
dev
->
pÜt
 = 
NULL
;

396 
pÜt
->
dev
 = 
NULL
;

398 
	`QTAILQ_INSERT_TAIL
(&
bus
->
ä“
, 
pÜt
, 
Ãxt
);

399 
bus
->
nä“
++;

400 
	}
}

402 
	$usb_deviû_©ch
(
USBDeviû
 *
dev
)

404 
USBBus
 *
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

405 
USBPÜt
 *
pÜt
 = 
dev
->port;

407 
	`as£¹
(
pÜt
 !ğ
NULL
);

408 
	`as£¹
(!
dev
->
©ched
);

409 
	`Œaû_usb_pÜt_©ch
(
bus
->
bu¢r
, 
pÜt
->
·th
);

411 ià(!(
pÜt
->
¥“dmask
 & 
dev
->speedmask)) {

412 
	`”rÜ_»pÜt
("Warning: speed mismatchryingo‡ttach "

414 
dev
->
´oduù_desc
, 
bus
->
qbus
.
Çme
);

418 
dev
->
©ched
++;

419 
	`usb_©ch
(
pÜt
);

422 
	}
}

424 
	$usb_deviû_d‘ach
(
USBDeviû
 *
dev
)

426 
USBBus
 *
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

427 
USBPÜt
 *
pÜt
 = 
dev
->port;

429 
	`as£¹
(
pÜt
 !ğ
NULL
);

430 
	`as£¹
(
dev
->
©ched
);

431 
	`Œaû_usb_pÜt_d‘ach
(
bus
->
bu¢r
, 
pÜt
->
·th
);

433 
	`usb_d‘ach
(
pÜt
);

434 
dev
->
©ched
--;

436 
	}
}

438 
	$usb_deviû_d–‘e_addr
(
bu¢r
, 
addr
)

440 
USBBus
 *
bus
;

441 
USBPÜt
 *
pÜt
;

442 
USBDeviû
 *
dev
;

444 
bus
 = 
	`usb_bus_fšd
(
bu¢r
);

445 ià(!
bus
)

448 
	`QTAILQ_FOREACH
(
pÜt
, &
bus
->
u£d
, 
Ãxt
) {

449 ià(
pÜt
->
dev
->
addr
 ==‡ddr)

452 ià(!
pÜt
)

454 
dev
 = 
pÜt
->dev;

456 
	`qdev_ä“
(&
dev
->
qdev
);

458 
	}
}

460 cÚ¡ *
	$usb_¥“d
(
¥“d
)

462 cÚ¡ *
txt
[] = {

463 [ 
USB_SPEED_LOW
 ] = "1.5",

464 [ 
USB_SPEED_FULL
 ] = "12",

465 [ 
USB_SPEED_HIGH
 ] = "480",

466 [ 
USB_SPEED_SUPER
 ] = "5000",

468 ià(
¥“d
 >ğ
	`ARRAY_SIZE
(
txt
))

470  
txt
[
¥“d
];

471 
	}
}

473 
	$usb_bus_dev_´št
(
MÚ™Ü
 *
mÚ
, 
DeviûS‹
 *
qdev
, 
šd’t
)

475 
USBDeviû
 *
dev
 = 
	`USB_DEVICE
(
qdev
);

476 
USBBus
 *
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

478 
	`mÚ™Ü_´štf
(
mÚ
, "%*saddr %d.%d,…ort %s, speed %s,‚ame %s%s\n",

479 
šd’t
, "", 
bus
->
bu¢r
, 
dev
->
addr
,

480 
dev
->
pÜt
 ? dev->pÜt->
·th
 : "-",

481 
	`usb_¥“d
(
dev
->
¥“d
), dev->
´oduù_desc
,

482 
dev
->
©ched
 ? ",‡ttached" : "");

483 
	}
}

485 *
	$usb_g‘_dev_·th
(
DeviûS‹
 *
qdev
)

487 
USBDeviû
 *
dev
 = 
	`USB_DEVICE
(
qdev
);

488 
DeviûS‹
 *
hcd
 = 
qdev
->
·»Á_bus
->
·»Á
;

489 *
id
 = 
NULL
;

491 ià(
dev
->
æags
 & (1 << 
USB_DEV_FLAG_FULL_PATH
)) {

492 
id
 = 
	`qdev_g‘_dev_·th
(
hcd
);

494 ià(
id
) {

495 *
»t
 = 
	`g_¡rdup_´štf
("%s/%s", 
id
, 
dev
->
pÜt
->
·th
);

496 
	`g_ä“
(
id
);

497  
»t
;

499  
	`g_¡rdup
(
dev
->
pÜt
->
·th
);

501 
	}
}

503 *
	$usb_g‘_fw_dev_·th
(
DeviûS‹
 *
qdev
)

505 
USBDeviû
 *
dev
 = 
	`USB_DEVICE
(
qdev
);

506 *
fw_·th
, *
š
;

507 
ssize_t
 
pos
 = 0, 
fw_Ën
;

508 
Ä
;

510 
fw_Ën
 = 32 + 
	`¡¾’
(
dev
->
pÜt
->
·th
) * 6;

511 
fw_·th
 = 
	`g_m®loc
(
fw_Ën
);

512 
š
 = 
dev
->
pÜt
->
·th
;

513 
fw_Ën
 - 
pos
 > 0) {

514 
Ä
 = 
	`¡¹Ş
(
š
, &in, 10);

515 ià(
š
[0] == '.') {

517 
pos
 +ğ
	`¢´štf
(
fw_·th
 +…os, 
fw_Ën
 -…os, "hub@%ld/", 
Ä
);

518 
š
++;

521 
pos
 +ğ
	`¢´štf
(
fw_·th
 +…os, 
fw_Ën
 -…os, "%s@%ld",

522 
	`qdev_fw_Çme
(
qdev
), 
Ä
);

526  
fw_·th
;

527 
	}
}

529 
	$usb_šfo
(
MÚ™Ü
 *
mÚ
)

531 
USBBus
 *
bus
;

532 
USBDeviû
 *
dev
;

533 
USBPÜt
 *
pÜt
;

535 ià(
	`QTAILQ_EMPTY
(&
bus£s
)) {

536 
	`mÚ™Ü_´štf
(
mÚ
, "USB support‚otƒnabled\n");

540 
	`QTAILQ_FOREACH
(
bus
, &
bus£s
, 
Ãxt
) {

541 
	`QTAILQ_FOREACH
(
pÜt
, &
bus
->
u£d
, 
Ãxt
) {

542 
dev
 = 
pÜt
->dev;

543 ià(!
dev
)

545 
	`mÚ™Ü_´štf
(
mÚ
, " Device %d.%d, Port %s, Speed %s Mb/s, Product %s\n",

546 
bus
->
bu¢r
, 
dev
->
addr
, 
pÜt
->
·th
, 
	`usb_¥“d
(dev->
¥“d
),

547 
dev
->
´oduù_desc
);

550 
	}
}

553 
USBDeviû
 *
	$usbdeviû_ü—‹
(cÚ¡ *
cmdlše
)

555 
USBBus
 *
bus
 = 
	`usb_bus_fšd
(-1 );

556 
LegacyUSBFaùÜy
 *
f
 = 
NULL
;

557 
GSLi¡
 *
i
;

558 
driv”
[32];

559 cÚ¡ *
·¿ms
;

560 
Ën
;

562 
·¿ms
 = 
	`¡rchr
(
cmdlše
,':');

563 ià(
·¿ms
) {

564 
·¿ms
++;

565 
Ën
 = 
·¿ms
 - 
cmdlše
;

566 ià(
Ën
 > (
driv”
))

567 
Ën
 = (
driv”
);

568 
	`p¡rıy
(
driv”
, 
Ën
, 
cmdlše
);

570 
·¿ms
 = "";

571 
	`p¡rıy
(
driv”
, (driv”), 
cmdlše
);

574 
i
 = 
Ëgacy_usb_çùÜy
; i; i = i->
Ãxt
) {

575 
f
 = 
i
->
d©a
;

576 ià(
	`¡rcmp
(
f
->
usbdeviû_Çme
, 
driv”
) == 0) {

580 ià(
i
 =ğ
NULL
) {

583 
	`”rÜ_»pÜt
("usbdeviû % nÙ found", 
driv”
);

585  
NULL
;

588 ià(!
f
->
usbdeviû_š™
) {

589 ià(*
·¿ms
) {

590 
	`”rÜ_»pÜt
("usbdeviû % acû± nØ·¿ms", 
driv”
);

591  
NULL
;

593  
	`usb_ü—‹_sim¶e
(
bus
, 
f
->
Çme
);

595  
f
->
	`usbdeviû_š™
(
bus
, 
·¿ms
);

596 
	}
}

598 
	$usb_deviû_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

600 
DeviûCÏss
 *
k
 = 
	`DEVICE_CLASS
(
kÏss
);

601 
k
->
bus_ty³
 = 
TYPE_USB_BUS
;

602 
k
->
š™
 = 
usb_qdev_š™
;

603 
k
->
uÅlug
 = 
qdev_sim¶e_uÅlug_cb
;

604 
k
->
ex™
 = 
usb_qdev_ex™
;

605 
k
->
´İs
 = 
usb_´İs
;

606 
	}
}

608 
Ty³Info
 
	gusb_deviû_ty³_šfo
 = {

609 .
Çme
 = 
TYPE_USB_DEVICE
,

610 .
	g·»Á
 = 
TYPE_DEVICE
,

611 .
	gš¡ªû_size
 = (
USBDeviû
),

612 .
	gab¡¿ù
 = 
Œue
,

613 .
	gşass_size
 = (
USBDeviûCÏss
),

614 .
	gşass_š™
 = 
usb_deviû_şass_š™
,

617 
	$usb_»gi¡”_ty³s
()

619 
	`ty³_»gi¡”_¡©ic
(&
usb_bus_šfo
);

620 
	`ty³_»gi¡”_¡©ic
(&
usb_deviû_ty³_šfo
);

621 
	}
}

623 
ty³_š™
(
usb_»gi¡”_ty³s
)

	@core.c

26 
	~"qemu-commÚ.h
"

27 
	~"hw/usb.h
"

28 
	~"iov.h
"

29 
	~"Œaû.h
"

31 
	$usb_©ch
(
USBPÜt
 *
pÜt
)

33 
USBDeviû
 *
dev
 = 
pÜt
->dev;

35 
	`as£¹
(
dev
 !ğ
NULL
);

36 
	`as£¹
(
dev
->
©ched
);

37 
	`as£¹
(
dev
->
¡©e
 =ğ
USB_STATE_NOTATTACHED
);

38 
pÜt
->
İs
->
	`©ch
(port);

39 
dev
->
¡©e
 = 
USB_STATE_ATTACHED
;

40 
	`usb_deviû_hªdË_©ch
(
dev
);

41 
	}
}

43 
	$usb_d‘ach
(
USBPÜt
 *
pÜt
)

45 
USBDeviû
 *
dev
 = 
pÜt
->dev;

47 
	`as£¹
(
dev
 !ğ
NULL
);

48 
	`as£¹
(
dev
->
¡©e
 !ğ
USB_STATE_NOTATTACHED
);

49 
pÜt
->
İs
->
	`d‘ach
(port);

50 
dev
->
¡©e
 = 
USB_STATE_NOTATTACHED
;

51 
	}
}

53 
	$usb_pÜt_»£t
(
USBPÜt
 *
pÜt
)

55 
USBDeviû
 *
dev
 = 
pÜt
->dev;

57 
	`as£¹
(
dev
 !ğ
NULL
);

58 
	`usb_d‘ach
(
pÜt
);

59 
	`usb_©ch
(
pÜt
);

60 
	`usb_deviû_»£t
(
dev
);

61 
	}
}

63 
	$usb_deviû_»£t
(
USBDeviû
 *
dev
)

65 ià(
dev
 =ğ
NULL
 || !dev->
©ched
) {

68 
dev
->
»mÙe_wakeup
 = 0;

69 
dev
->
addr
 = 0;

70 
dev
->
¡©e
 = 
USB_STATE_DEFAULT
;

71 
	`usb_deviû_hªdË_»£t
(
dev
);

72 
	}
}

74 
	$usb_wakeup
(
USBEndpošt
 *
•
)

76 
USBDeviû
 *
dev
 = 
•
->dev;

77 
USBBus
 *
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

79 ià(
dev
->
»mÙe_wakeup
 && dev->
pÜt
 && dev->pÜt->
İs
->
wakeup
) {

80 
dev
->
pÜt
->
İs
->
	`wakeup
(dev->port);

82 ià(
bus
->
İs
->
wakeup_’dpošt
) {

83 
bus
->
İs
->
	`wakeup_’dpošt
(bus, 
•
);

85 
	}
}

94 
	#SETUP_STATE_IDLE
 0

	)

95 
	#SETUP_STATE_SETUP
 1

	)

96 
	#SETUP_STATE_DATA
 2

	)

97 
	#SETUP_STATE_ACK
 3

	)

98 
	#SETUP_STATE_PARAM
 4

	)

100 
	$do_tok’_£tup
(
USBDeviû
 *
s
, 
USBPack‘
 *
p
)

102 
»que¡
, 
v®ue
, 
šdex
;

103 
»t
 = 0;

105 ià(
p
->
iov
.
size
 != 8) {

106  
USB_RET_STALL
;

109 
	`usb_·ck‘_cİy
(
p
, 
s
->
£tup_buf
,…->
iov
.
size
);

110 
p
->
»suÉ
 = 0;

111 
s
->
£tup_Ën
 = (s->
£tup_buf
[7] << 8) | s->setup_buf[6];

112 
s
->
£tup_šdex
 = 0;

114 
»que¡
 = (
s
->
£tup_buf
[0] << 8) | s->setup_buf[1];

115 
v®ue
 = (
s
->
£tup_buf
[3] << 8) | s->setup_buf[2];

116 
šdex
 = (
s
->
£tup_buf
[5] << 8) | s->setup_buf[4];

118 ià(
s
->
£tup_buf
[0] & 
USB_DIR_IN
) {

119 
»t
 = 
	`usb_deviû_hªdË_cÚŒŞ
(
s
, 
p
, 
»que¡
, 
v®ue
, 
šdex
,

120 
s
->
£tup_Ën
, s->
d©a_buf
);

121 ià(
»t
 =ğ
USB_RET_ASYNC
) {

122 
s
->
£tup_¡©e
 = 
SETUP_STATE_SETUP
;

123  
USB_RET_ASYNC
;

125 ià(
»t
 < 0)

126  
»t
;

128 ià(
»t
 < 
s
->
£tup_Ën
)

129 
s
->
£tup_Ën
 = 
»t
;

130 
s
->
£tup_¡©e
 = 
SETUP_STATE_DATA
;

132 ià(
s
->
£tup_Ën
 > (s->
d©a_buf
)) {

133 
	`årštf
(
¡d”r
,

135 
s
->
£tup_Ën
, (s->
d©a_buf
));

136  
USB_RET_STALL
;

138 ià(
s
->
£tup_Ën
 == 0)

139 
s
->
£tup_¡©e
 = 
SETUP_STATE_ACK
;

141 
s
->
£tup_¡©e
 = 
SETUP_STATE_DATA
;

144  
»t
;

145 
	}
}

147 
	$do_tok’_š
(
USBDeviû
 *
s
, 
USBPack‘
 *
p
)

149 
»que¡
, 
v®ue
, 
šdex
;

150 
»t
 = 0;

152 
	`as£¹
(
p
->
•
->
Ä
 == 0);

154 
»que¡
 = (
s
->
£tup_buf
[0] << 8) | s->setup_buf[1];

155 
v®ue
 = (
s
->
£tup_buf
[3] << 8) | s->setup_buf[2];

156 
šdex
 = (
s
->
£tup_buf
[5] << 8) | s->setup_buf[4];

158 
s
->
£tup_¡©e
) {

159 
SETUP_STATE_ACK
:

160 ià(!(
s
->
£tup_buf
[0] & 
USB_DIR_IN
)) {

161 
»t
 = 
	`usb_deviû_hªdË_cÚŒŞ
(
s
, 
p
, 
»que¡
, 
v®ue
, 
šdex
,

162 
s
->
£tup_Ën
, s->
d©a_buf
);

163 ià(
»t
 =ğ
USB_RET_ASYNC
) {

164  
USB_RET_ASYNC
;

166 
s
->
£tup_¡©e
 = 
SETUP_STATE_IDLE
;

167 ià(
»t
 > 0)

169  
»t
;

175 
SETUP_STATE_DATA
:

176 ià(
s
->
£tup_buf
[0] & 
USB_DIR_IN
) {

177 
Ën
 = 
s
->
£tup_Ën
 - s->
£tup_šdex
;

178 ià(
Ën
 > 
p
->
iov
.
size
) {

179 
Ën
 = 
p
->
iov
.
size
;

181 
	`usb_·ck‘_cİy
(
p
, 
s
->
d©a_buf
 + s->
£tup_šdex
, 
Ën
);

182 
s
->
£tup_šdex
 +ğ
Ën
;

183 ià(
s
->
£tup_šdex
 >ğs->
£tup_Ën
)

184 
s
->
£tup_¡©e
 = 
SETUP_STATE_ACK
;

185  
Ën
;

188 
s
->
£tup_¡©e
 = 
SETUP_STATE_IDLE
;

189  
USB_RET_STALL
;

192  
USB_RET_STALL
;

194 
	}
}

196 
	$do_tok’_out
(
USBDeviû
 *
s
, 
USBPack‘
 *
p
)

198 
	`as£¹
(
p
->
•
->
Ä
 == 0);

200 
s
->
£tup_¡©e
) {

201 
SETUP_STATE_ACK
:

202 ià(
s
->
£tup_buf
[0] & 
USB_DIR_IN
) {

203 
s
->
£tup_¡©e
 = 
SETUP_STATE_IDLE
;

210 
SETUP_STATE_DATA
:

211 ià(!(
s
->
£tup_buf
[0] & 
USB_DIR_IN
)) {

212 
Ën
 = 
s
->
£tup_Ën
 - s->
£tup_šdex
;

213 ià(
Ën
 > 
p
->
iov
.
size
) {

214 
Ën
 = 
p
->
iov
.
size
;

216 
	`usb_·ck‘_cİy
(
p
, 
s
->
d©a_buf
 + s->
£tup_šdex
, 
Ën
);

217 
s
->
£tup_šdex
 +ğ
Ën
;

218 ià(
s
->
£tup_šdex
 >ğs->
£tup_Ën
)

219 
s
->
£tup_¡©e
 = 
SETUP_STATE_ACK
;

220  
Ën
;

223 
s
->
£tup_¡©e
 = 
SETUP_STATE_IDLE
;

224  
USB_RET_STALL
;

227  
USB_RET_STALL
;

229 
	}
}

231 
	$do_·¿m‘”
(
USBDeviû
 *
s
, 
USBPack‘
 *
p
)

233 
»que¡
, 
v®ue
, 
šdex
;

234 
i
, 
»t
 = 0;

236 
i
 = 0; i < 8; i++) {

237 
s
->
£tup_buf
[
i
] = 
p
->
·¿m‘”
 >> (i*8);

240 
s
->
£tup_¡©e
 = 
SETUP_STATE_PARAM
;

241 
s
->
£tup_Ën
 = (s->
£tup_buf
[7] << 8) | s->setup_buf[6];

242 
s
->
£tup_šdex
 = 0;

244 
»que¡
 = (
s
->
£tup_buf
[0] << 8) | s->setup_buf[1];

245 
v®ue
 = (
s
->
£tup_buf
[3] << 8) | s->setup_buf[2];

246 
šdex
 = (
s
->
£tup_buf
[5] << 8) | s->setup_buf[4];

248 ià(
s
->
£tup_Ën
 > (s->
d©a_buf
)) {

249 
	`årštf
(
¡d”r
,

251 
s
->
£tup_Ën
, (s->
d©a_buf
));

252  
USB_RET_STALL
;

255 ià(
p
->
pid
 =ğ
USB_TOKEN_OUT
) {

256 
	`usb_·ck‘_cİy
(
p
, 
s
->
d©a_buf
, s->
£tup_Ën
);

259 
»t
 = 
	`usb_deviû_hªdË_cÚŒŞ
(
s
, 
p
, 
»que¡
, 
v®ue
, 
šdex
,

260 
s
->
£tup_Ën
, s->
d©a_buf
);

261 ià(
»t
 < 0) {

262  
»t
;

265 ià(
»t
 < 
s
->
£tup_Ën
) {

266 
s
->
£tup_Ën
 = 
»t
;

268 ià(
p
->
pid
 =ğ
USB_TOKEN_IN
) {

269 
	`usb_·ck‘_cİy
(
p
, 
s
->
d©a_buf
, s->
£tup_Ën
);

272  
»t
;

273 
	}
}

279 
	$usb_g’”ic_async_ù¾_com¶‘e
(
USBDeviû
 *
s
, 
USBPack‘
 *
p
)

281 ià(
p
->
»suÉ
 < 0) {

282 
s
->
£tup_¡©e
 = 
SETUP_STATE_IDLE
;

285 
s
->
£tup_¡©e
) {

286 
SETUP_STATE_SETUP
:

287 ià(
p
->
»suÉ
 < 
s
->
£tup_Ën
) {

288 
s
->
£tup_Ën
 = 
p
->
»suÉ
;

290 
s
->
£tup_¡©e
 = 
SETUP_STATE_DATA
;

291 
p
->
»suÉ
 = 8;

294 
SETUP_STATE_ACK
:

295 
s
->
£tup_¡©e
 = 
SETUP_STATE_IDLE
;

296 
p
->
»suÉ
 = 0;

299 
SETUP_STATE_PARAM
:

300 ià(
p
->
»suÉ
 < 
s
->
£tup_Ën
) {

301 
s
->
£tup_Ën
 = 
p
->
»suÉ
;

303 ià(
p
->
pid
 =ğ
USB_TOKEN_IN
) {

304 
p
->
»suÉ
 = 0;

305 
	`usb_·ck‘_cİy
(
p
, 
s
->
d©a_buf
, s->
£tup_Ën
);

312 
	`usb_·ck‘_com¶‘e
(
s
, 
p
);

313 
	}
}

316 
	$£t_usb_¡ršg
(
ušt8_t
 *
buf
, cÚ¡ *
¡r
)

318 
Ën
, 
i
;

319 
ušt8_t
 *
q
;

321 
q
 = 
buf
;

322 
Ën
 = 
	`¡¾’
(
¡r
);

323 *
q
++ = 2 * 
Ën
 + 2;

324 *
q
++ = 3;

325 
i
 = 0; i < 
Ën
; i++) {

326 *
q
++ = 
¡r
[
i
];

327 *
q
++ = 0;

329  
q
 - 
buf
;

330 
	}
}

332 
USBDeviû
 *
	$usb_fšd_deviû
(
USBPÜt
 *
pÜt
, 
ušt8_t
 
addr
)

334 
USBDeviû
 *
dev
 = 
pÜt
->dev;

336 ià(
dev
 =ğ
NULL
 || !dev->
©ched
 || dev->
¡©e
 !ğ
USB_STATE_DEFAULT
) {

337  
NULL
;

339 ià(
dev
->
addr
 ==‡ddr) {

340  
dev
;

342  
	`usb_deviû_fšd_deviû
(
dev
, 
addr
);

343 
	}
}

345 
	$usb_´oûss_Úe
(
USBPack‘
 *
p
)

347 
USBDeviû
 *
dev
 = 
p
->
•
->dev;

349 ià(
p
->
•
->
Ä
 == 0) {

351 ià(
p
->
·¿m‘”
) {

352  
	`do_·¿m‘”
(
dev
, 
p
);

354 
p
->
pid
) {

355 
USB_TOKEN_SETUP
:

356  
	`do_tok’_£tup
(
dev
, 
p
);

357 
USB_TOKEN_IN
:

358  
	`do_tok’_š
(
dev
, 
p
);

359 
USB_TOKEN_OUT
:

360  
	`do_tok’_out
(
dev
, 
p
);

362  
USB_RET_STALL
;

366  
	`usb_deviû_hªdË_d©a
(
dev
, 
p
);

368 
	}
}

373 
	$usb_hªdË_·ck‘
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

375 
»t
;

377 ià(
dev
 =ğ
NULL
) {

378  
USB_RET_NODEV
;

380 
	`as£¹
(
dev
 =ğ
p
->
•
->dev);

381 
	`as£¹
(
dev
->
¡©e
 =ğ
USB_STATE_DEFAULT
);

382 
	`usb_·ck‘_check_¡©e
(
p
, 
USB_PACKET_SETUP
);

383 
	`as£¹
(
p
->
•
 !ğ
NULL
);

386 ià(
p
->
•
->
h®‹d
) {

387 
	`as£¹
(
	`QTAILQ_EMPTY
(&
p
->
•
->
queue
));

388 
p
->
•
->
h®‹d
 = 
çl£
;

391 ià(
	`QTAILQ_EMPTY
(&
p
->
•
->
queue
è||…->•->
p–še
) {

392 
»t
 = 
	`usb_´oûss_Úe
(
p
);

393 ià(
»t
 =ğ
USB_RET_ASYNC
) {

394 
	`usb_·ck‘_£t_¡©e
(
p
, 
USB_PACKET_ASYNC
);

395 
	`QTAILQ_INSERT_TAIL
(&
p
->
•
->
queue
,…, queue);

401 
	`as£¹
(!
p
->
•
->
p–še
);

402 
p
->
»suÉ
 = 
»t
;

403 
	`usb_·ck‘_£t_¡©e
(
p
, 
USB_PACKET_COMPLETE
);

406 
»t
 = 
USB_RET_ASYNC
;

407 
	`usb_·ck‘_£t_¡©e
(
p
, 
USB_PACKET_QUEUED
);

408 
	`QTAILQ_INSERT_TAIL
(&
p
->
•
->
queue
,…, queue);

410  
»t
;

411 
	}
}

413 
	$__usb_·ck‘_com¶‘e
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

415 
USBEndpošt
 *
•
 = 
p
->ep;

417 
	`as£¹
(
p
->
»suÉ
 !ğ
USB_RET_ASYNC
 &&…->»suÉ !ğ
USB_RET_NAK
);

419 ià(
p
->
»suÉ
 < 0) {

420 
•
->
h®‹d
 = 
Œue
;

422 
	`usb_·ck‘_£t_¡©e
(
p
, 
USB_PACKET_COMPLETE
);

423 
	`QTAILQ_REMOVE
(&
•
->
queue
, 
p
, queue);

424 
dev
->
pÜt
->
İs
->
	`com¶‘e
(dev->pÜt, 
p
);

425 
	}
}

430 
	$usb_·ck‘_com¶‘e
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

432 
USBEndpošt
 *
•
 = 
p
->ep;

433 
»t
;

435 
	`usb_·ck‘_check_¡©e
(
p
, 
USB_PACKET_ASYNC
);

436 
	`as£¹
(
	`QTAILQ_FIRST
(&
•
->
queue
è=ğ
p
);

437 
	`__usb_·ck‘_com¶‘e
(
dev
, 
p
);

439 !
•
->
h®‹d
 && !
	`QTAILQ_EMPTY
(&•->
queue
)) {

440 
p
 = 
	`QTAILQ_FIRST
(&
•
->
queue
);

441 ià(
p
->
¡©e
 =ğ
USB_PACKET_ASYNC
) {

444 
	`usb_·ck‘_check_¡©e
(
p
, 
USB_PACKET_QUEUED
);

445 
»t
 = 
	`usb_´oûss_Úe
(
p
);

446 ià(
»t
 =ğ
USB_RET_ASYNC
) {

447 
	`usb_·ck‘_£t_¡©e
(
p
, 
USB_PACKET_ASYNC
);

450 
p
->
»suÉ
 = 
»t
;

451 
	`__usb_·ck‘_com¶‘e
(
•
->
dev
, 
p
);

453 
	}
}

458 
	$usb_ÿnûl_·ck‘
(
USBPack‘
 * 
p
)

460 
boŞ
 
ÿÎback
 = (
p
->
¡©e
 =ğ
USB_PACKET_ASYNC
);

461 
	`as£¹
(
	`usb_·ck‘_is_šæight
(
p
));

462 
	`usb_·ck‘_£t_¡©e
(
p
, 
USB_PACKET_CANCELED
);

463 
	`QTAILQ_REMOVE
(&
p
->
•
->
queue
,…, queue);

464 ià(
ÿÎback
) {

465 
	`usb_deviû_ÿnûl_·ck‘
(
p
->
•
->
dev
,…);

467 
	}
}

470 
	$usb_·ck‘_š™
(
USBPack‘
 *
p
)

472 
	`qemu_iovec_š™
(&
p
->
iov
, 1);

473 
	}
}

475 cÚ¡ *
	$usb_·ck‘_¡©e_Çme
(
USBPack‘S‹
 
¡©e
)

477 cÚ¡ *
Çme
[] = {

478 [
USB_PACKET_UNDEFINED
] = "undef",

479 [
USB_PACKET_SETUP
] = "setup",

480 [
USB_PACKET_QUEUED
] = "queued",

481 [
USB_PACKET_ASYNC
] = "async",

482 [
USB_PACKET_COMPLETE
] = "complete",

483 [
USB_PACKET_CANCELED
] = "canceled",

485 ià(
¡©e
 < 
	`ARRAY_SIZE
(
Çme
)) {

486  
Çme
[
¡©e
];

489 
	}
}

491 
	$usb_·ck‘_check_¡©e
(
USBPack‘
 *
p
, 
USBPack‘S‹
 
ex³ùed
)

493 
USBDeviû
 *
dev
;

494 
USBBus
 *
bus
;

496 ià(
p
->
¡©e
 =ğ
ex³ùed
) {

499 
dev
 = 
p
->
•
->dev;

500 
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

501 
	`Œaû_usb_·ck‘_¡©e_çuÉ
(
bus
->
bu¢r
, 
dev
->
pÜt
->
·th
, 
p
->
•
->
Ä
,…,

502 
	`usb_·ck‘_¡©e_Çme
(
p
->
¡©e
),

503 
	`usb_·ck‘_¡©e_Çme
(
ex³ùed
));

504 
	`as£¹
(!"usb…acket state check failed");

505 
	}
}

507 
	$usb_·ck‘_£t_¡©e
(
USBPack‘
 *
p
, 
USBPack‘S‹
 
¡©e
)

509 ià(
p
->
•
) {

510 
USBDeviû
 *
dev
 = 
p
->
•
->dev;

511 
USBBus
 *
bus
 = 
	`usb_bus_äom_deviû
(
dev
);

512 
	`Œaû_usb_·ck‘_¡©e_chªge
(
bus
->
bu¢r
, 
dev
->
pÜt
->
·th
, 
p
->
•
->
Ä
,…,

513 
	`usb_·ck‘_¡©e_Çme
(
p
->
¡©e
),

514 
	`usb_·ck‘_¡©e_Çme
(
¡©e
));

516 
	`Œaû_usb_·ck‘_¡©e_chªge
(-1, "", -1, 
p
,

517 
	`usb_·ck‘_¡©e_Çme
(
p
->
¡©e
),

518 
	`usb_·ck‘_¡©e_Çme
(
¡©e
));

520 
p
->
¡©e
 = state;

521 
	}
}

523 
	$usb_·ck‘_£tup
(
USBPack‘
 *
p
, 
pid
, 
USBEndpošt
 *
•
, 
ušt64_t
 
id
)

525 
	`as£¹
(!
	`usb_·ck‘_is_šæight
(
p
));

526 
	`as£¹
(
p
->
iov
.iov !ğ
NULL
);

527 
p
->
id
 = id;

528 
p
->
pid
 =…id;

529 
p
->
•
 =ƒp;

530 
p
->
»suÉ
 = 0;

531 
p
->
·¿m‘”
 = 0;

532 
	`qemu_iovec_»£t
(&
p
->
iov
);

533 
	`usb_·ck‘_£t_¡©e
(
p
, 
USB_PACKET_SETUP
);

534 
	}
}

536 
	$usb_·ck‘_addbuf
(
USBPack‘
 *
p
, *
±r
, 
size_t
 
Ën
)

538 
	`qemu_iovec_add
(&
p
->
iov
, 
±r
, 
Ën
);

539 
	}
}

541 
	$usb_·ck‘_cİy
(
USBPack‘
 *
p
, *
±r
, 
size_t
 
by‹s
)

543 
	`as£¹
(
p
->
»suÉ
 >= 0);

544 
	`as£¹
(
p
->
»suÉ
 + 
by‹s
 <ğp->
iov
.
size
);

545 
p
->
pid
) {

546 
USB_TOKEN_SETUP
:

547 
USB_TOKEN_OUT
:

548 
	`iov_to_buf
(
p
->
iov
.iov,…->iov.
niov
,…->
»suÉ
, 
±r
, 
by‹s
);

550 
USB_TOKEN_IN
:

551 
	`iov_äom_buf
(
p
->
iov
.iov,…->iov.
niov
,…->
»suÉ
, 
±r
, 
by‹s
);

554 
	`årštf
(
¡d”r
, "%s: inv®id…id: %x\n", 
__func__
, 
p
->
pid
);

555 
	`abÜt
();

557 
p
->
»suÉ
 +ğ
by‹s
;

558 
	}
}

560 
	$usb_·ck‘_sk
(
USBPack‘
 *
p
, 
size_t
 
by‹s
)

562 
	`as£¹
(
p
->
»suÉ
 >= 0);

563 
	`as£¹
(
p
->
»suÉ
 + 
by‹s
 <ğp->
iov
.
size
);

564 ià(
p
->
pid
 =ğ
USB_TOKEN_IN
) {

565 
	`iov_mem£t
(
p
->
iov
.iov,…->iov.
niov
,…->
»suÉ
, 0, 
by‹s
);

567 
p
->
»suÉ
 +ğ
by‹s
;

568 
	}
}

570 
	$usb_·ck‘_ş—nup
(
USBPack‘
 *
p
)

572 
	`as£¹
(!
	`usb_·ck‘_is_šæight
(
p
));

573 
	`qemu_iovec_de¡roy
(&
p
->
iov
);

574 
	}
}

576 
	$usb_•_»£t
(
USBDeviû
 *
dev
)

578 
•
;

580 
dev
->
•_ùl
.
Ä
 = 0;

581 
dev
->
•_ùl
.
ty³
 = 
USB_ENDPOINT_XFER_CONTROL
;

582 
dev
->
•_ùl
.
iâum
 = 0;

583 
dev
->
•_ùl
.dev = dev;

584 
dev
->
•_ùl
.
p–še
 = 
çl£
;

585 
•
 = 0;ƒ°< 
USB_MAX_ENDPOINTS
;ƒp++) {

586 
dev
->
•_š
[
•
].
Ä
 =ƒp + 1;

587 
dev
->
•_out
[
•
].
Ä
 =ƒp + 1;

588 
dev
->
•_š
[
•
].
pid
 = 
USB_TOKEN_IN
;

589 
dev
->
•_out
[
•
].
pid
 = 
USB_TOKEN_OUT
;

590 
dev
->
•_š
[
•
].
ty³
 = 
USB_ENDPOINT_XFER_INVALID
;

591 
dev
->
•_out
[
•
].
ty³
 = 
USB_ENDPOINT_XFER_INVALID
;

592 
dev
->
•_š
[
•
].
iâum
 = 
USB_INTERFACE_INVALID
;

593 
dev
->
•_out
[
•
].
iâum
 = 
USB_INTERFACE_INVALID
;

594 
dev
->
•_š
[
•
].dev = dev;

595 
dev
->
•_out
[
•
].dev = dev;

596 
dev
->
•_š
[
•
].
p–še
 = 
çl£
;

597 
dev
->
•_out
[
•
].
p–še
 = 
çl£
;

599 
	}
}

601 
	$usb_•_š™
(
USBDeviû
 *
dev
)

603 
•
;

605 
	`usb_•_»£t
(
dev
);

606 
	`QTAILQ_INIT
(&
dev
->
•_ùl
.
queue
);

607 
•
 = 0;ƒ°< 
USB_MAX_ENDPOINTS
;ƒp++) {

608 
	`QTAILQ_INIT
(&
dev
->
•_š
[
•
].
queue
);

609 
	`QTAILQ_INIT
(&
dev
->
•_out
[
•
].
queue
);

611 
	}
}

613 
	$usb_•_dump
(
USBDeviû
 *
dev
)

615 cÚ¡ *
Šame
[] = {

616 [
USB_ENDPOINT_XFER_CONTROL
] = "control",

617 [
USB_ENDPOINT_XFER_ISOC
] = "isoc",

618 [
USB_ENDPOINT_XFER_BULK
] = "bulk",

619 [
USB_ENDPOINT_XFER_INT
] = "int",

621 
iâum
, 
•
, 
fœ¡
;

623 
	`årštf
(
¡d”r
, "Device \"%s\", config %d\n",

624 
dev
->
´oduù_desc
, dev->
cÚfigu¿tiÚ
);

625 
iâum
 = 0; ifnum < 16; ifnum++) {

626 
fœ¡
 = 1;

627 
•
 = 0;ƒ°< 
USB_MAX_ENDPOINTS
;ƒp++) {

628 ià(
dev
->
•_š
[
•
].
ty³
 !ğ
USB_ENDPOINT_XFER_INVALID
 &&

629 
dev
->
•_š
[
•
].
iâum
 == ifnum) {

630 ià(
fœ¡
) {

631 
fœ¡
 = 0;

632 
	`årštf
(
¡d”r
, " Interface %d,‡lternative %d\n",

633 
iâum
, 
dev
->
®t£‰šg
[ifnum]);

635 
	`årštf
(
¡d”r
, " Endpošˆ%d, IN, %s, %d max\n", 
•
,

636 
Šame
[
dev
->
•_š
[
•
].
ty³
],

637 
dev
->
•_š
[
•
].
max_·ck‘_size
);

639 ià(
dev
->
•_out
[
•
].
ty³
 !ğ
USB_ENDPOINT_XFER_INVALID
 &&

640 
dev
->
•_out
[
•
].
iâum
 == ifnum) {

641 ià(
fœ¡
) {

642 
fœ¡
 = 0;

643 
	`årštf
(
¡d”r
, " Interface %d,‡lternative %d\n",

644 
iâum
, 
dev
->
®t£‰šg
[ifnum]);

646 
	`årštf
(
¡d”r
, " Endpošˆ%d, OUT, %s, %d max\n", 
•
,

647 
Šame
[
dev
->
•_out
[
•
].
ty³
],

648 
dev
->
•_out
[
•
].
max_·ck‘_size
);

652 
	`årštf
(
¡d”r
, "--\n");

653 
	}
}

655 
USBEndpošt
 *
	$usb_•_g‘
(
USBDeviû
 *
dev
, 
pid
, 
•
)

657 
USBEndpošt
 *
•s
;

659 ià(
dev
 =ğ
NULL
) {

660  
NULL
;

662 
•s
 = (
pid
 =ğ
USB_TOKEN_IN
è? 
dev
->
•_š
 : dev->
•_out
;

663 ià(
•
 == 0) {

664  &
dev
->
•_ùl
;

666 
	`as£¹
(
pid
 =ğ
USB_TOKEN_IN
 ||…id =ğ
USB_TOKEN_OUT
);

667 
	`as£¹
(
•
 > 0 &&ƒ°<ğ
USB_MAX_ENDPOINTS
);

668  
•s
 + 
•
 - 1;

669 
	}
}

671 
ušt8_t
 
	$usb_•_g‘_ty³
(
USBDeviû
 *
dev
, 
pid
, 
•
)

673 
USBEndpošt
 *
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
);

674  
u•
->
ty³
;

675 
	}
}

677 
	$usb_•_£t_ty³
(
USBDeviû
 *
dev
, 
pid
, 
•
, 
ušt8_t
 
ty³
)

679 
USBEndpošt
 *
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
);

680 
u•
->
ty³
 =ype;

681 
	}
}

683 
ušt8_t
 
	$usb_•_g‘_iâum
(
USBDeviû
 *
dev
, 
pid
, 
•
)

685 
USBEndpošt
 *
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
);

686  
u•
->
iâum
;

687 
	}
}

689 
	$usb_•_£t_iâum
(
USBDeviû
 *
dev
, 
pid
, 
•
, 
ušt8_t
 
iâum
)

691 
USBEndpošt
 *
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
);

692 
u•
->
iâum
 = ifnum;

693 
	}
}

695 
	$usb_•_£t_max_·ck‘_size
(
USBDeviû
 *
dev
, 
pid
, 
•
,

696 
ušt16_t
 
¿w
)

698 
USBEndpošt
 *
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
);

699 
size
, 
miüoäames
;

701 
size
 = 
¿w
 & 0x7ff;

702 (
¿w
 >> 11) & 3) {

704 
miüoäames
 = 2;

707 
miüoäames
 = 3;

710 
miüoäames
 = 1;

713 
u•
->
max_·ck‘_size
 = 
size
 * 
miüoäames
;

714 
	}
}

716 
	$usb_•_g‘_max_·ck‘_size
(
USBDeviû
 *
dev
, 
pid
, 
•
)

718 
USBEndpošt
 *
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
);

719  
u•
->
max_·ck‘_size
;

720 
	}
}

722 
	$usb_•_£t_p–še
(
USBDeviû
 *
dev
, 
pid
, 
•
, 
boŞ
 
’abËd
)

724 
USBEndpošt
 *
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
);

725 
u•
->
p–še
 = 
’abËd
;

726 
	}
}

	@desc.c

1 
	~<ùy³.h
>

3 
	~"hw/usb.h
"

4 
	~"hw/usb/desc.h
"

5 
	~"Œaû.h
"

9 
ušt8_t
 
	$usb_lo
(
ušt16_t
 
v®
)

11  
v®
 & 0xff;

12 
	}
}

14 
ušt8_t
 
	$usb_hi
(
ušt16_t
 
v®
)

16  (
v®
 >> 8) & 0xff;

17 
	}
}

19 
	$usb_desc_deviû
(cÚ¡ 
USBDescID
 *
id
, cÚ¡ 
USBDescDeviû
 *
dev
,

20 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

22 
ušt8_t
 
bL’gth
 = 0x12;

23 
USBDesütÜ
 *
d
 = (*)
de¡
;

25 ià(
Ën
 < 
bL’gth
) {

29 
d
->
bL’gth
 = bLength;

30 
d
->
bDesütÜTy³
 = 
USB_DT_DEVICE
;

32 
d
->
u
.
deviû
.
bcdUSB_lo
 = 
	`usb_lo
(
dev
->
bcdUSB
);

33 
d
->
u
.
deviû
.
bcdUSB_hi
 = 
	`usb_hi
(
dev
->
bcdUSB
);

34 
d
->
u
.
deviû
.
bDeviûCÏss
 = 
dev
->bDeviceClass;

35 
d
->
u
.
deviû
.
bDeviûSubCÏss
 = 
dev
->bDeviceSubClass;

36 
d
->
u
.
deviû
.
bDeviûPrÙocŞ
 = 
dev
->bDeviceProtocol;

37 
d
->
u
.
deviû
.
bMaxPack‘Size0
 = 
dev
->bMaxPacketSize0;

39 
d
->
u
.
deviû
.
idV’dÜ_lo
 = 
	`usb_lo
(
id
->
idV’dÜ
);

40 
d
->
u
.
deviû
.
idV’dÜ_hi
 = 
	`usb_hi
(
id
->
idV’dÜ
);

41 
d
->
u
.
deviû
.
idProduù_lo
 = 
	`usb_lo
(
id
->
idProduù
);

42 
d
->
u
.
deviû
.
idProduù_hi
 = 
	`usb_hi
(
id
->
idProduù
);

43 
d
->
u
.
deviû
.
bcdDeviû_lo
 = 
	`usb_lo
(
id
->
bcdDeviû
);

44 
d
->
u
.
deviû
.
bcdDeviû_hi
 = 
	`usb_hi
(
id
->
bcdDeviû
);

45 
d
->
u
.
deviû
.
iMªuçùu»r
 = 
id
->iManufacturer;

46 
d
->
u
.
deviû
.
iProduù
 = 
id
->iProduct;

47 
d
->
u
.
deviû
.
iS”ŸlNumb”
 = 
id
->iSerialNumber;

49 
d
->
u
.
deviû
.
bNumCÚfigu¿tiÚs
 = 
dev
->bNumConfigurations;

51  
bL’gth
;

52 
	}
}

54 
	$usb_desc_deviû_qu®if›r
(cÚ¡ 
USBDescDeviû
 *
dev
,

55 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

57 
ušt8_t
 
bL’gth
 = 0x0a;

58 
USBDesütÜ
 *
d
 = (*)
de¡
;

60 ià(
Ën
 < 
bL’gth
) {

64 
d
->
bL’gth
 = bLength;

65 
d
->
bDesütÜTy³
 = 
USB_DT_DEVICE_QUALIFIER
;

67 
d
->
u
.
deviû_qu®if›r
.
bcdUSB_lo
 = 
	`usb_lo
(
dev
->
bcdUSB
);

68 
d
->
u
.
deviû_qu®if›r
.
bcdUSB_hi
 = 
	`usb_hi
(
dev
->
bcdUSB
);

69 
d
->
u
.
deviû_qu®if›r
.
bDeviûCÏss
 = 
dev
->bDeviceClass;

70 
d
->
u
.
deviû_qu®if›r
.
bDeviûSubCÏss
 = 
dev
->bDeviceSubClass;

71 
d
->
u
.
deviû_qu®if›r
.
bDeviûPrÙocŞ
 = 
dev
->bDeviceProtocol;

72 
d
->
u
.
deviû_qu®if›r
.
bMaxPack‘Size0
 = 
dev
->bMaxPacketSize0;

73 
d
->
u
.
deviû_qu®if›r
.
bNumCÚfigu¿tiÚs
 = 
dev
->bNumConfigurations;

74 
d
->
u
.
deviû_qu®if›r
.
bRe£rved
 = 0;

76  
bL’gth
;

77 
	}
}

79 
	$usb_desc_cÚfig
(cÚ¡ 
USBDescCÚfig
 *
cÚf
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

81 
ušt8_t
 
bL’gth
 = 0x09;

82 
ušt16_t
 
wTÙ®L’gth
 = 0;

83 
USBDesütÜ
 *
d
 = (*)
de¡
;

84 
i
, 
rc
;

86 ià(
Ën
 < 
bL’gth
) {

90 
d
->
bL’gth
 = bLength;

91 
d
->
bDesütÜTy³
 = 
USB_DT_CONFIG
;

93 
d
->
u
.
cÚfig
.
bNumIÁ”çûs
 = 
cÚf
->bNumInterfaces;

94 
d
->
u
.
cÚfig
.
bCÚfigu¿tiÚV®ue
 = 
cÚf
->bConfigurationValue;

95 
d
->
u
.
cÚfig
.
iCÚfigu¿tiÚ
 = 
cÚf
->iConfiguration;

96 
d
->
u
.
cÚfig
.
bmA‰ribu‹s
 = 
cÚf
->bmAttributes;

97 
d
->
u
.
cÚfig
.
bMaxPow”
 = 
cÚf
->bMaxPower;

98 
wTÙ®L’gth
 +ğ
bL’gth
;

101 
i
 = 0; i < 
cÚf
->
nif_groups
; i++) {

102 
rc
 = 
	`usb_desc_içû_group
(&(
cÚf
->
if_groups
[
i
]),

103 
de¡
 + 
wTÙ®L’gth
,

104 
Ën
 - 
wTÙ®L’gth
);

105 ià(
rc
 < 0) {

106  
rc
;

108 
wTÙ®L’gth
 +ğ
rc
;

112 
i
 = 0; i < 
cÚf
->
nif
; i++) {

113 
rc
 = 
	`usb_desc_içû
(
cÚf
->
ifs
 + 
i
, 
de¡
 + 
wTÙ®L’gth
, 
Ën
 - wTotalLength);

114 ià(
rc
 < 0) {

115  
rc
;

117 
wTÙ®L’gth
 +ğ
rc
;

120 
d
->
u
.
cÚfig
.
wTÙ®L’gth_lo
 = 
	`usb_lo
(
wTÙ®L’gth
);

121 
d
->
u
.
cÚfig
.
wTÙ®L’gth_hi
 = 
	`usb_hi
(
wTÙ®L’gth
);

122  
wTÙ®L’gth
;

123 
	}
}

125 
	$usb_desc_içû_group
(cÚ¡ 
USBDescIçûAssoc
 *
Ÿd
, 
ušt8_t
 *
de¡
,

126 
size_t
 
Ën
)

128 
pos
 = 0;

129 
i
 = 0;

132 
ušt8_t
 
bL’gth
 = 0x08;

134 ià(
Ën
 < 
bL’gth
) {

138 
de¡
[0x00] = 
bL’gth
;

139 
de¡
[0x01] = 
USB_DT_INTERFACE_ASSOC
;

140 
de¡
[0x02] = 
Ÿd
->
bFœ¡IÁ”çû
;

141 
de¡
[0x03] = 
Ÿd
->
bIÁ”çûCouÁ
;

142 
de¡
[0x04] = 
Ÿd
->
bFunùiÚCÏss
;

143 
de¡
[0x05] = 
Ÿd
->
bFunùiÚSubCÏss
;

144 
de¡
[0x06] = 
Ÿd
->
bFunùiÚPrÙocŞ
;

145 
de¡
[0x07] = 
Ÿd
->
iFunùiÚ
;

146 
pos
 +ğ
bL’gth
;

149 
i
 = 0; i < 
Ÿd
->
nif
; i++) {

150 
rc
 = 
	`usb_desc_içû
(&(
Ÿd
->
ifs
[
i
]), 
de¡
 + 
pos
, 
Ën
 -…os);

151 ià(
rc
 < 0) {

152  
rc
;

154 
pos
 +ğ
rc
;

157  
pos
;

158 
	}
}

160 
	$usb_desc_içû
(cÚ¡ 
USBDescIçû
 *
içû
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

162 
ušt8_t
 
bL’gth
 = 0x09;

163 
i
, 
rc
, 
pos
 = 0;

164 
USBDesütÜ
 *
d
 = (*)
de¡
;

166 ià(
Ën
 < 
bL’gth
) {

170 
d
->
bL’gth
 = bLength;

171 
d
->
bDesütÜTy³
 = 
USB_DT_INTERFACE
;

173 
d
->
u
.
š‹rçû
.
bIÁ”çûNumb”
 = 
içû
->bInterfaceNumber;

174 
d
->
u
.
š‹rçû
.
bAÉ”Ç‹S‘tšg
 = 
içû
->bAlternateSetting;

175 
d
->
u
.
š‹rçû
.
bNumEndpošts
 = 
içû
->bNumEndpoints;

176 
d
->
u
.
š‹rçû
.
bIÁ”çûCÏss
 = 
içû
->bInterfaceClass;

177 
d
->
u
.
š‹rçû
.
bIÁ”çûSubCÏss
 = 
içû
->bInterfaceSubClass;

178 
d
->
u
.
š‹rçû
.
bIÁ”çûPrÙocŞ
 = 
içû
->bInterfaceProtocol;

179 
d
->
u
.
š‹rçû
.
iIÁ”çû
 = 
içû
->iInterface;

180 
pos
 +ğ
bL’gth
;

182 
i
 = 0; i < 
içû
->
ndesc
; i++) {

183 
rc
 = 
	`usb_desc_Ùh”
(
içû
->
descs
 + 
i
, 
de¡
 + 
pos
, 
Ën
 -…os);

184 ià(
rc
 < 0) {

185  
rc
;

187 
pos
 +ğ
rc
;

190 
i
 = 0; i < 
içû
->
bNumEndpošts
; i++) {

191 
rc
 = 
	`usb_desc_’dpošt
(
içû
->
•s
 + 
i
, 
de¡
 + 
pos
, 
Ën
 -…os);

192 ià(
rc
 < 0) {

193  
rc
;

195 
pos
 +ğ
rc
;

198  
pos
;

199 
	}
}

201 
	$usb_desc_’dpošt
(cÚ¡ 
USBDescEndpošt
 *
•
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

203 
ušt8_t
 
bL’gth
 = 
•
->
is_audio
 ? 0x09 : 0x07;

204 
ušt8_t
 
exŒ®’
 = 
•
->
exŒa
 ?ƒp->extra[0] : 0;

205 
USBDesütÜ
 *
d
 = (*)
de¡
;

207 ià(
Ën
 < 
bL’gth
 + 
exŒ®’
) {

211 
d
->
bL’gth
 = bLength;

212 
d
->
bDesütÜTy³
 = 
USB_DT_ENDPOINT
;

214 
d
->
u
.
’dpošt
.
bEndpoštAdd»ss
 = 
•
->bEndpointAddress;

215 
d
->
u
.
’dpošt
.
bmA‰ribu‹s
 = 
•
->bmAttributes;

216 
d
->
u
.
’dpošt
.
wMaxPack‘Size_lo
 = 
	`usb_lo
(
•
->
wMaxPack‘Size
);

217 
d
->
u
.
’dpošt
.
wMaxPack‘Size_hi
 = 
	`usb_hi
(
•
->
wMaxPack‘Size
);

218 
d
->
u
.
’dpošt
.
bIÁ”v®
 = 
•
->bInterval;

219 ià(
•
->
is_audio
) {

220 
d
->
u
.
’dpošt
.
bReäesh
 = 
•
->bRefresh;

221 
d
->
u
.
’dpošt
.
bSynchAdd»ss
 = 
•
->bSynchAddress;

223 ià(
•
->
exŒa
) {

224 
	`memıy
(
de¡
 + 
bL’gth
, 
•
->
exŒa
, 
exŒ®’
);

227  
bL’gth
 + 
exŒ®’
;

228 
	}
}

230 
	$usb_desc_Ùh”
(cÚ¡ 
USBDescOth”
 *
desc
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

232 
bL’gth
 = 
desc
->
Ëngth
 ? desc->Ëngth : desc->
d©a
[0];

234 ià(
Ën
 < 
bL’gth
) {

238 
	`memıy
(
de¡
, 
desc
->
d©a
, 
bL’gth
);

239  
bL’gth
;

240 
	}
}

244 
	$usb_desc_•_š™
(
USBDeviû
 *
dev
)

246 cÚ¡ 
USBDescIçû
 *
içû
;

247 
i
, 
e
, 
pid
, 
•
;

249 
	`usb_•_š™
(
dev
);

250 
i
 = 0; i < 
dev
->
nš‹rçûs
; i++) {

251 
içû
 = 
dev
->
içûs
[
i
];

252 ià(
içû
 =ğ
NULL
) {

255 
e
 = 0;ƒ < 
içû
->
bNumEndpošts
;ƒ++) {

256 
pid
 = (
içû
->
•s
[
e
].
bEndpoštAdd»ss
 & 
USB_DIR_IN
) ?

257 
USB_TOKEN_IN
 : 
USB_TOKEN_OUT
;

258 
•
 = 
içû
->
•s
[
e
].
bEndpoštAdd»ss
 & 0x0f;

259 
	`usb_•_£t_ty³
(
dev
, 
pid
, 
•
, 
içû
->
•s
[
e
].
bmA‰ribu‹s
 & 0x03);

260 
	`usb_•_£t_iâum
(
dev
, 
pid
, 
•
, 
içû
->
bIÁ”çûNumb”
);

261 
	`usb_•_£t_max_·ck‘_size
(
dev
, 
pid
, 
•
,

262 
içû
->
•s
[
e
].
wMaxPack‘Size
);

265 
	}
}

267 cÚ¡ 
USBDescIçû
 *
	$usb_desc_fšd_š‹rçû
(
USBDeviû
 *
dev
,

268 
nif
, 
®t
)

270 cÚ¡ 
USBDescIçû
 *
içû
;

271 
g
, 
i
;

273 ià(!
dev
->
cÚfig
) {

274  
NULL
;

276 
g
 = 0; g < 
dev
->
cÚfig
->
nif_groups
; g++) {

277 
i
 = 0; i < 
dev
->
cÚfig
->
if_groups
[
g
].
nif
; i++) {

278 
içû
 = &
dev
->
cÚfig
->
if_groups
[
g
].
ifs
[
i
];

279 ià(
içû
->
bIÁ”çûNumb”
 =ğ
nif
 &&

280 
içû
->
bAÉ”Ç‹S‘tšg
 =ğ
®t
) {

281  
içû
;

285 
i
 = 0; i < 
dev
->
cÚfig
->
nif
; i++) {

286 
içû
 = &
dev
->
cÚfig
->
ifs
[
i
];

287 ià(
içû
->
bIÁ”çûNumb”
 =ğ
nif
 &&

288 
içû
->
bAÉ”Ç‹S‘tšg
 =ğ
®t
) {

289  
içû
;

292  
NULL
;

293 
	}
}

295 
	$usb_desc_£t_š‹rçû
(
USBDeviû
 *
dev
, 
šdex
, 
v®ue
)

297 cÚ¡ 
USBDescIçû
 *
içû
;

298 
Şd
;

300 
içû
 = 
	`usb_desc_fšd_š‹rçû
(
dev
, 
šdex
, 
v®ue
);

301 ià(
içû
 =ğ
NULL
) {

305 
Şd
 = 
dev
->
®t£‰šg
[
šdex
];

306 
dev
->
®t£‰šg
[
šdex
] = 
v®ue
;

307 
dev
->
içûs
[
šdex
] = 
içû
;

308 
	`usb_desc_•_š™
(
dev
);

310 ià(
Şd
 !ğ
v®ue
) {

311 
	`usb_deviû_£t_š‹rçû
(
dev
, 
šdex
, 
Şd
, 
v®ue
);

314 
	}
}

316 
	$usb_desc_£t_cÚfig
(
USBDeviû
 *
dev
, 
v®ue
)

318 
i
;

320 ià(
v®ue
 == 0) {

321 
dev
->
cÚfigu¿tiÚ
 = 0;

322 
dev
->
nš‹rçûs
 = 0;

323 
dev
->
cÚfig
 = 
NULL
;

325 
i
 = 0; i < 
dev
->
deviû
->
bNumCÚfigu¿tiÚs
; i++) {

326 ià(
dev
->
deviû
->
cÚfs
[
i
].
bCÚfigu¿tiÚV®ue
 =ğ
v®ue
) {

327 
dev
->
cÚfigu¿tiÚ
 = 
v®ue
;

328 
dev
->
nš‹rçûs
 = dev->
deviû
->
cÚfs
[
i
].
bNumIÁ”çûs
;

329 
dev
->
cÚfig
 = dev->
deviû
->
cÚfs
 + 
i
;

330 
	`as£¹
(
dev
->
nš‹rçûs
 <ğ
USB_MAX_INTERFACES
);

333 ià(
i
 < 
dev
->
deviû
->
bNumCÚfigu¿tiÚs
) {

338 
i
 = 0; i < 
dev
->
nš‹rçûs
; i++) {

339 
	`usb_desc_£t_š‹rçû
(
dev
, 
i
, 0);

341 ; 
i
 < 
USB_MAX_INTERFACES
; i++) {

342 
dev
->
®t£‰šg
[
i
] = 0;

343 
dev
->
içûs
[
i
] = 
NULL
;

347 
	}
}

349 
	$usb_desc_£tdeçuÉs
(
USBDeviû
 *
dev
)

351 cÚ¡ 
USBDesc
 *
desc
 = 
	`usb_deviû_g‘_usb_desc
(
dev
);

353 
	`as£¹
(
desc
 !ğ
NULL
);

354 
dev
->
¥“d
) {

355 
USB_SPEED_LOW
:

356 
USB_SPEED_FULL
:

357 
dev
->
deviû
 = 
desc
->
fuÎ
;

359 
USB_SPEED_HIGH
:

360 
dev
->
deviû
 = 
desc
->
high
;

363 
	`usb_desc_£t_cÚfig
(
dev
, 0);

364 
	}
}

366 
	$usb_desc_š™
(
USBDeviû
 *
dev
)

368 cÚ¡ 
USBDesc
 *
desc
 = 
	`usb_deviû_g‘_usb_desc
(
dev
);

370 
	`as£¹
(
desc
 !ğ
NULL
);

371 
dev
->
¥“d
 = 
USB_SPEED_FULL
;

372 
dev
->
¥“dmask
 = 0;

373 ià(
desc
->
fuÎ
) {

374 
dev
->
¥“dmask
 |ğ
USB_SPEED_MASK_FULL
;

376 ià(
desc
->
high
) {

377 
dev
->
¥“dmask
 |ğ
USB_SPEED_MASK_HIGH
;

379 
	`usb_desc_£tdeçuÉs
(
dev
);

380 
	}
}

382 
	$usb_desc_©ch
(
USBDeviû
 *
dev
)

384 cÚ¡ 
USBDesc
 *
desc
 = 
	`usb_deviû_g‘_usb_desc
(
dev
);

386 
	`as£¹
(
desc
 !ğ
NULL
);

387 ià(
desc
->
high
 && (
dev
->
pÜt
->
¥“dmask
 & 
USB_SPEED_MASK_HIGH
)) {

388 
dev
->
¥“d
 = 
USB_SPEED_HIGH
;

389 } ià(
desc
->
fuÎ
 && (
dev
->
pÜt
->
¥“dmask
 & 
USB_SPEED_MASK_FULL
)) {

390 
dev
->
¥“d
 = 
USB_SPEED_FULL
;

392 
	`årštf
(
¡d”r
, "usb:…ort/device speed mismatch for \"%s\"\n",

393 
	`usb_deviû_g‘_´oduù_desc
(
dev
));

396 
	`usb_desc_£tdeçuÉs
(
dev
);

397 
	}
}

399 
	$usb_desc_£t_¡ršg
(
USBDeviû
 *
dev
, 
ušt8_t
 
šdex
, cÚ¡ *
¡r
)

401 
USBDescSŒšg
 *
s
;

403 
	`QLIST_FOREACH
(
s
, &
dev
->
¡ršgs
, 
Ãxt
) {

404 ià(
s
->
šdex
 == index) {

408 ià(
s
 =ğ
NULL
) {

409 
s
 = 
	`g_m®loc0
((*s));

410 
s
->
šdex
 = index;

411 
	`QLIST_INSERT_HEAD
(&
dev
->
¡ršgs
, 
s
, 
Ãxt
);

413 
	`g_ä“
(
s
->
¡r
);

414 
s
->
¡r
 = 
	`g_¡rdup
(str);

415 
	}
}

429 
	$usb_desc_ü—‹_£rŸl
(
USBDeviû
 *
dev
)

431 
DeviûS‹
 *
hcd
 = 
dev
->
qdev
.
·»Á_bus
->
·»Á
;

432 cÚ¡ 
USBDesc
 *
desc
 = 
	`usb_deviû_g‘_usb_desc
(
dev
);

433 
šdex
 = 
desc
->
id
.
iS”ŸlNumb”
;

434 
£rŸl
[64];

435 *
·th
;

436 
d¡
;

438 
	`as£¹
(
šdex
 !ğ0 && 
desc
->
¡r
[šdex] !ğ
NULL
);

439 
d¡
 = 
	`¢´štf
(
£rŸl
, (£rŸl), "%s", 
desc
->
¡r
[
šdex
]);

440 
·th
 = 
	`qdev_g‘_dev_·th
(
hcd
);

441 ià(
·th
) {

442 
d¡
 +ğ
	`¢´štf
(
£rŸl
+d¡, (£rŸl)-d¡, "-%s", 
·th
);

444 
d¡
 +ğ
	`¢´štf
(
£rŸl
+d¡, (£rŸl)-d¡, "-%s", 
dev
->
pÜt
->
·th
);

445 
	`usb_desc_£t_¡ršg
(
dev
, 
šdex
, 
£rŸl
);

446 
	}
}

448 cÚ¡ *
	$usb_desc_g‘_¡ršg
(
USBDeviû
 *
dev
, 
ušt8_t
 
šdex
)

450 
USBDescSŒšg
 *
s
;

452 
	`QLIST_FOREACH
(
s
, &
dev
->
¡ršgs
, 
Ãxt
) {

453 ià(
s
->
šdex
 == index) {

454  
s
->
¡r
;

457  
NULL
;

458 
	}
}

460 
	$usb_desc_¡ršg
(
USBDeviû
 *
dev
, 
šdex
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

462 
ušt8_t
 
bL’gth
, 
pos
, 
i
;

463 cÚ¡ *
¡r
;

465 ià(
Ën
 < 4) {

469 ià(
šdex
 == 0) {

471 
de¡
[0] = 4;

472 
de¡
[1] = 
USB_DT_STRING
;

473 
de¡
[2] = 0x09;

474 
de¡
[3] = 0x04;

478 
¡r
 = 
	`usb_desc_g‘_¡ršg
(
dev
, 
šdex
);

479 ià(
¡r
 =ğ
NULL
) {

480 
¡r
 = 
	`usb_deviû_g‘_usb_desc
(
dev
)->¡r[
šdex
];

481 ià(
¡r
 =ğ
NULL
) {

486 
bL’gth
 = 
	`¡¾’
(
¡r
) * 2 + 2;

487 
de¡
[0] = 
bL’gth
;

488 
de¡
[1] = 
USB_DT_STRING
;

489 
i
 = 0; 
pos
 = 2;

490 
pos
+1 < 
bL’gth
 &&…os+1 < 
Ën
) {

491 
de¡
[
pos
++] = 
¡r
[
i
++];

492 
de¡
[
pos
++] = 0;

494  
pos
;

495 
	}
}

497 
	$usb_desc_g‘_desütÜ
(
USBDeviû
 *
dev
, 
v®ue
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
)

499 cÚ¡ 
USBDesc
 *
desc
 = 
	`usb_deviû_g‘_usb_desc
(
dev
);

500 cÚ¡ 
USBDescDeviû
 *
Ùh”_dev
;

501 
ušt8_t
 
buf
[256];

502 
ušt8_t
 
ty³
 = 
v®ue
 >> 8;

503 
ušt8_t
 
šdex
 = 
v®ue
 & 0xff;

504 
»t
 = -1;

506 ià(
dev
->
¥“d
 =ğ
USB_SPEED_HIGH
) {

507 
Ùh”_dev
 = 
	`usb_deviû_g‘_usb_desc
(
dev
)->
fuÎ
;

509 
Ùh”_dev
 = 
	`usb_deviû_g‘_usb_desc
(
dev
)->
high
;

512 
ty³
) {

513 
USB_DT_DEVICE
:

514 
»t
 = 
	`usb_desc_deviû
(&
desc
->
id
, 
dev
->
deviû
, 
buf
, (buf));

515 
	`Œaû_usb_desc_deviû
(
dev
->
addr
, 
Ën
, 
»t
);

517 
USB_DT_CONFIG
:

518 ià(
šdex
 < 
dev
->
deviû
->
bNumCÚfigu¿tiÚs
) {

519 
»t
 = 
	`usb_desc_cÚfig
(
dev
->
deviû
->
cÚfs
 + 
šdex
, 
buf
, (buf));

521 
	`Œaû_usb_desc_cÚfig
(
dev
->
addr
, 
šdex
, 
Ën
, 
»t
);

523 
USB_DT_STRING
:

524 
»t
 = 
	`usb_desc_¡ršg
(
dev
, 
šdex
, 
buf
, (buf));

525 
	`Œaû_usb_desc_¡ršg
(
dev
->
addr
, 
šdex
, 
Ën
, 
»t
);

528 
USB_DT_DEVICE_QUALIFIER
:

529 ià(
Ùh”_dev
 !ğ
NULL
) {

530 
»t
 = 
	`usb_desc_deviû_qu®if›r
(
Ùh”_dev
, 
buf
, (buf));

532 
	`Œaû_usb_desc_deviû_qu®if›r
(
dev
->
addr
, 
Ën
, 
»t
);

534 
USB_DT_OTHER_SPEED_CONFIG
:

535 ià(
Ùh”_dev
 !ğ
NULL
 && 
šdex
 < oth”_dev->
bNumCÚfigu¿tiÚs
) {

536 
»t
 = 
	`usb_desc_cÚfig
(
Ùh”_dev
->
cÚfs
 + 
šdex
, 
buf
, (buf));

537 
buf
[0x01] = 
USB_DT_OTHER_SPEED_CONFIG
;

539 
	`Œaû_usb_desc_Ùh”_¥“d_cÚfig
(
dev
->
addr
, 
šdex
, 
Ën
, 
»t
);

542 
USB_DT_DEBUG
:

547 
	`årštf
(
¡d”r
, "%s: %d unknowÀty³ %d (ËÀ%zd)\n", 
__FUNCTION__
,

548 
dev
->
addr
, 
ty³
, 
Ën
);

552 ià(
»t
 > 0) {

553 ià(
»t
 > 
Ën
) {

554 
»t
 = 
Ën
;

556 
	`memıy
(
de¡
, 
buf
, 
»t
);

558  
»t
;

559 
	}
}

561 
	$usb_desc_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

562 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

564 cÚ¡ 
USBDesc
 *
desc
 = 
	`usb_deviû_g‘_usb_desc
(
dev
);

565 
»t
 = -1;

567 
	`as£¹
(
desc
 !ğ
NULL
);

568 
»que¡
) {

569 
DeviûOutReque¡
 | 
USB_REQ_SET_ADDRESS
:

570 
dev
->
addr
 = 
v®ue
;

571 
	`Œaû_usb_£t_addr
(
dev
->
addr
);

572 
»t
 = 0;

575 
DeviûReque¡
 | 
USB_REQ_GET_DESCRIPTOR
:

576 
»t
 = 
	`usb_desc_g‘_desütÜ
(
dev
, 
v®ue
, 
d©a
, 
Ëngth
);

579 
DeviûReque¡
 | 
USB_REQ_GET_CONFIGURATION
:

584 
d©a
[0] = 
dev
->
cÚfig
 ? dev->cÚfig->
bCÚfigu¿tiÚV®ue
 : 0;

585 
»t
 = 1;

587 
DeviûOutReque¡
 | 
USB_REQ_SET_CONFIGURATION
:

588 
»t
 = 
	`usb_desc_£t_cÚfig
(
dev
, 
v®ue
);

589 
	`Œaû_usb_£t_cÚfig
(
dev
->
addr
, 
v®ue
, 
»t
);

592 
DeviûReque¡
 | 
USB_REQ_GET_STATUS
: {

593 cÚ¡ 
USBDescCÚfig
 *
cÚfig
 = 
dev
->config ?

594 
dev
->
cÚfig
 : &dev->
deviû
->
cÚfs
[0];

596 
d©a
[0] = 0;

603 ià(
cÚfig
->
bmA‰ribu‹s
 & 0x40) {

604 
d©a
[0] |ğ1 << 
USB_DEVICE_SELF_POWERED
;

606 ià(
dev
->
»mÙe_wakeup
) {

607 
d©a
[0] |ğ1 << 
USB_DEVICE_REMOTE_WAKEUP
;

609 
d©a
[1] = 0x00;

610 
»t
 = 2;

613 
DeviûOutReque¡
 | 
USB_REQ_CLEAR_FEATURE
:

614 ià(
v®ue
 =ğ
USB_DEVICE_REMOTE_WAKEUP
) {

615 
dev
->
»mÙe_wakeup
 = 0;

616 
»t
 = 0;

618 
	`Œaû_usb_ş—r_deviû_ã©u»
(
dev
->
addr
, 
v®ue
, 
»t
);

620 
DeviûOutReque¡
 | 
USB_REQ_SET_FEATURE
:

621 ià(
v®ue
 =ğ
USB_DEVICE_REMOTE_WAKEUP
) {

622 
dev
->
»mÙe_wakeup
 = 1;

623 
»t
 = 0;

625 
	`Œaû_usb_£t_deviû_ã©u»
(
dev
->
addr
, 
v®ue
, 
»t
);

628 
IÁ”çûReque¡
 | 
USB_REQ_GET_INTERFACE
:

629 ià(
šdex
 < 0 || index >ğ
dev
->
nš‹rçûs
) {

632 
d©a
[0] = 
dev
->
®t£‰šg
[
šdex
];

633 
»t
 = 1;

635 
IÁ”çûOutReque¡
 | 
USB_REQ_SET_INTERFACE
:

636 
»t
 = 
	`usb_desc_£t_š‹rçû
(
dev
, 
šdex
, 
v®ue
);

637 
	`Œaû_usb_£t_š‹rçû
(
dev
->
addr
, 
šdex
, 
v®ue
, 
»t
);

641  
»t
;

642 
	}
}

	@desc.h

1 #iâdeà
QEMU_HW_USB_DESC_H


2 
	#QEMU_HW_USB_DESC_H


	)

4 
	~<š‰y³s.h
>

7 
	sUSBDesütÜ
 {

8 
ušt8_t
 
	mbL’gth
;

9 
ušt8_t
 
	mbDesütÜTy³
;

12 
ušt8_t
 
	mbcdUSB_lo
;

13 
ušt8_t
 
	mbcdUSB_hi
;

14 
ušt8_t
 
	mbDeviûCÏss
;

15 
ušt8_t
 
	mbDeviûSubCÏss
;

16 
ušt8_t
 
	mbDeviûPrÙocŞ
;

17 
ušt8_t
 
	mbMaxPack‘Size0
;

18 
ušt8_t
 
	midV’dÜ_lo
;

19 
ušt8_t
 
	midV’dÜ_hi
;

20 
ušt8_t
 
	midProduù_lo
;

21 
ušt8_t
 
	midProduù_hi
;

22 
ušt8_t
 
	mbcdDeviû_lo
;

23 
ušt8_t
 
	mbcdDeviû_hi
;

24 
ušt8_t
 
	miMªuçùu»r
;

25 
ušt8_t
 
	miProduù
;

26 
ušt8_t
 
	miS”ŸlNumb”
;

27 
ušt8_t
 
	mbNumCÚfigu¿tiÚs
;

28 } 
	mdeviû
;

30 
ušt8_t
 
	mbcdUSB_lo
;

31 
ušt8_t
 
	mbcdUSB_hi
;

32 
ušt8_t
 
	mbDeviûCÏss
;

33 
ušt8_t
 
	mbDeviûSubCÏss
;

34 
ušt8_t
 
	mbDeviûPrÙocŞ
;

35 
ušt8_t
 
	mbMaxPack‘Size0
;

36 
ušt8_t
 
	mbNumCÚfigu¿tiÚs
;

37 
ušt8_t
 
	mbRe£rved
;

38 } 
	mdeviû_qu®if›r
;

40 
ušt8_t
 
	mwTÙ®L’gth_lo
;

41 
ušt8_t
 
	mwTÙ®L’gth_hi
;

42 
ušt8_t
 
	mbNumIÁ”çûs
;

43 
ušt8_t
 
	mbCÚfigu¿tiÚV®ue
;

44 
ušt8_t
 
	miCÚfigu¿tiÚ
;

45 
ušt8_t
 
	mbmA‰ribu‹s
;

46 
ušt8_t
 
	mbMaxPow”
;

47 } 
	mcÚfig
;

49 
ušt8_t
 
	mbIÁ”çûNumb”
;

50 
ušt8_t
 
	mbAÉ”Ç‹S‘tšg
;

51 
ušt8_t
 
	mbNumEndpošts
;

52 
ušt8_t
 
	mbIÁ”çûCÏss
;

53 
ušt8_t
 
	mbIÁ”çûSubCÏss
;

54 
ušt8_t
 
	mbIÁ”çûPrÙocŞ
;

55 
ušt8_t
 
	miIÁ”çû
;

56 } 
	mš‹rçû
;

58 
ušt8_t
 
	mbEndpoštAdd»ss
;

59 
ušt8_t
 
	mbmA‰ribu‹s
;

60 
ušt8_t
 
	mwMaxPack‘Size_lo
;

61 
ušt8_t
 
	mwMaxPack‘Size_hi
;

62 
ušt8_t
 
	mbIÁ”v®
;

63 
ušt8_t
 
	mbReäesh
;

64 
ušt8_t
 
	mbSynchAdd»ss
;

65 } 
	m’dpošt
;

66 } 
	mu
;

67 } 
	tQEMU_PACKED
 
	tUSBDesütÜ
;

69 
	sUSBDescID
 {

70 
ušt16_t
 
	midV’dÜ
;

71 
ušt16_t
 
	midProduù
;

72 
ušt16_t
 
	mbcdDeviû
;

73 
ušt8_t
 
	miMªuçùu»r
;

74 
ušt8_t
 
	miProduù
;

75 
ušt8_t
 
	miS”ŸlNumb”
;

78 
	sUSBDescDeviû
 {

79 
ušt16_t
 
	mbcdUSB
;

80 
ušt8_t
 
	mbDeviûCÏss
;

81 
ušt8_t
 
	mbDeviûSubCÏss
;

82 
ušt8_t
 
	mbDeviûPrÙocŞ
;

83 
ušt8_t
 
	mbMaxPack‘Size0
;

84 
ušt8_t
 
	mbNumCÚfigu¿tiÚs
;

86 cÚ¡ 
USBDescCÚfig
 *
	mcÚfs
;

89 
	sUSBDescCÚfig
 {

90 
ušt8_t
 
	mbNumIÁ”çûs
;

91 
ušt8_t
 
	mbCÚfigu¿tiÚV®ue
;

92 
ušt8_t
 
	miCÚfigu¿tiÚ
;

93 
ušt8_t
 
	mbmA‰ribu‹s
;

94 
ušt8_t
 
	mbMaxPow”
;

97 
ušt8_t
 
	mnif_groups
;

98 cÚ¡ 
USBDescIçûAssoc
 *
	mif_groups
;

101 
ušt8_t
 
	mnif
;

102 cÚ¡ 
USBDescIçû
 *
	mifs
;

106 
	sUSBDescIçûAssoc
 {

107 
ušt8_t
 
	mbFœ¡IÁ”çû
;

108 
ušt8_t
 
	mbIÁ”çûCouÁ
;

109 
ušt8_t
 
	mbFunùiÚCÏss
;

110 
ušt8_t
 
	mbFunùiÚSubCÏss
;

111 
ušt8_t
 
	mbFunùiÚPrÙocŞ
;

112 
ušt8_t
 
	miFunùiÚ
;

114 
ušt8_t
 
	mnif
;

115 cÚ¡ 
USBDescIçû
 *
	mifs
;

118 
	sUSBDescIçû
 {

119 
ušt8_t
 
	mbIÁ”çûNumb”
;

120 
ušt8_t
 
	mbAÉ”Ç‹S‘tšg
;

121 
ušt8_t
 
	mbNumEndpošts
;

122 
ušt8_t
 
	mbIÁ”çûCÏss
;

123 
ušt8_t
 
	mbIÁ”çûSubCÏss
;

124 
ušt8_t
 
	mbIÁ”çûPrÙocŞ
;

125 
ušt8_t
 
	miIÁ”çû
;

127 
ušt8_t
 
	mndesc
;

128 
USBDescOth”
 *
	mdescs
;

129 
USBDescEndpošt
 *
	m•s
;

132 
	sUSBDescEndpošt
 {

133 
ušt8_t
 
	mbEndpoštAdd»ss
;

134 
ušt8_t
 
	mbmA‰ribu‹s
;

135 
ušt16_t
 
	mwMaxPack‘Size
;

136 
ušt8_t
 
	mbIÁ”v®
;

137 
ušt8_t
 
	mbReäesh
;

138 
ušt8_t
 
	mbSynchAdd»ss
;

140 
ušt8_t
 
	mis_audio
;

141 
ušt8_t
 *
	mexŒa
;

144 
	sUSBDescOth”
 {

145 
ušt8_t
 
	mËngth
;

146 cÚ¡ 
ušt8_t
 *
	md©a
;

149 cÚ¡ *
	tUSBDescSŒšgs
[256];

151 
	sUSBDesc
 {

152 
USBDescID
 
	mid
;

153 cÚ¡ 
USBDescDeviû
 *
	mfuÎ
;

154 cÚ¡ 
USBDescDeviû
 *
	mhigh
;

155 cÚ¡ * cÚ¡ *
	m¡r
;

159 
usb_desc_deviû
(cÚ¡ 
USBDescID
 *
id
, cÚ¡ 
USBDescDeviû
 *
dev
,

160 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

161 
usb_desc_deviû_qu®if›r
(cÚ¡ 
USBDescDeviû
 *
dev
,

162 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

163 
usb_desc_cÚfig
(cÚ¡ 
USBDescCÚfig
 *
cÚf
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

164 
usb_desc_içû_group
(cÚ¡ 
USBDescIçûAssoc
 *
Ÿd
, 
ušt8_t
 *
de¡
,

165 
size_t
 
Ën
);

166 
usb_desc_içû
(cÚ¡ 
USBDescIçû
 *
içû
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

167 
usb_desc_’dpošt
(cÚ¡ 
USBDescEndpošt
 *
•
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

168 
usb_desc_Ùh”
(cÚ¡ 
USBDescOth”
 *
desc
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

171 
usb_desc_š™
(
USBDeviû
 *
dev
);

172 
usb_desc_©ch
(
USBDeviû
 *
dev
);

173 
usb_desc_£t_¡ršg
(
USBDeviû
 *
dev
, 
ušt8_t
 
šdex
, cÚ¡ *
¡r
);

174 
usb_desc_ü—‹_£rŸl
(
USBDeviû
 *
dev
);

175 cÚ¡ *
usb_desc_g‘_¡ršg
(
USBDeviû
 *
dev
, 
ušt8_t
 
šdex
);

176 
usb_desc_¡ršg
(
USBDeviû
 *
dev
, 
šdex
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

177 
usb_desc_g‘_desütÜ
(
USBDeviû
 *
dev
, 
v®ue
, 
ušt8_t
 *
de¡
, 
size_t
 
Ën
);

178 
usb_desc_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

179 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
);

	@dev-audio.c

32 
	~"qemu-commÚ.h
"

33 
	~"hw/usb.h
"

34 
	~"hw/usb/desc.h
"

35 
	~"hw/hw.h
"

36 
	~"hw/audiodev.h
"

37 
	~"audio/audio.h
"

39 
	#USBAUDIO_VENDOR_NUM
 0x46f4

	)

40 
	#USBAUDIO_PRODUCT_NUM
 0x0002

	)

42 
	#DEV_CONFIG_VALUE
 1

	)

45 
	#DST_AC_HEADER
 1

	)

46 
	#DST_AC_INPUT_TERMINAL
 2

	)

47 
	#DST_AC_OUTPUT_TERMINAL
 3

	)

48 
	#DST_AC_FEATURE_UNIT
 6

	)

50 
	#DST_AS_GENERAL
 1

	)

51 
	#DST_AS_FORMAT_TYPE
 2

	)

53 
	#DST_EP_GENERAL
 1

	)

55 
	eusb_audio_¡ršgs
 {

56 
	mSTRING_NULL
,

57 
	mSTRING_MANUFACTURER
,

58 
	mSTRING_PRODUCT
,

59 
	mSTRING_SERIALNUMBER
,

60 
	mSTRING_CONFIG
,

61 
	mSTRING_USBAUDIO_CONTROL
,

62 
	mSTRING_INPUT_TERMINAL
,

63 
	mSTRING_FEATURE_UNIT
,

64 
	mSTRING_OUTPUT_TERMINAL
,

65 
	mSTRING_NULL_STREAM
,

66 
	mSTRING_REAL_STREAM
,

69 cÚ¡ 
USBDescSŒšgs
 
	gusb_audio_¡ršgbË
 = {

70 [
STRING_MANUFACTURER
] = "QEMU",

71 [
STRING_PRODUCT
] = "QEMU USB Audio",

72 [
STRING_SERIALNUMBER
] = "1",

73 [
STRING_CONFIG
] = "Audio Configuration",

74 [
STRING_USBAUDIO_CONTROL
] = "Audio Device",

75 [
STRING_INPUT_TERMINAL
] = "Audio Output Pipe",

76 [
STRING_FEATURE_UNIT
] = "Audio Output Volume Control",

77 [
STRING_OUTPUT_TERMINAL
] = "Audio Output Terminal",

78 [
STRING_NULL_STREAM
] = "Audio Output - Disabled",

79 [
STRING_REAL_STREAM
] = "Audio Output - 48 kHz Stereo",

82 
	#U16
(
x
è((xè& 0xff), (((xè>> 8è& 0xff)

	)

83 
	#U24
(
x
è
	`U16
(x), (((xè>> 16è& 0xff)

	)

84 
	#U32
(
x
è
	`U24
(x), (((xè>> 24è& 0xff)

	)

89 
	#USBAUDIO_PACKET_SIZE
 192

	)

90 
	#USBAUDIO_SAMPLE_RATE
 48000

	)

91 
	#USBAUDIO_PACKET_INTERVAL
 1

	)

93 cÚ¡ 
USBDescIçû
 
	gdesc_içû
[] = {

95 .
bIÁ”çûNumb”
 = 0,

96 .
	gbNumEndpošts
 = 0,

97 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_AUDIO
,

98 .
	gbIÁ”çûSubCÏss
 = 
USB_SUBCLASS_AUDIO_CONTROL
,

99 .
	gbIÁ”çûPrÙocŞ
 = 0x04,

100 .
	giIÁ”çû
 = 
STRING_USBAUDIO_CONTROL
,

101 .
	gndesc
 = 4,

102 .
	gdescs
 = (
USBDescOth”
[]) {

105 .
d©a
 = (
ušt8_t
[]) {

107 
USB_DT_CS_INTERFACE
,

108 
DST_AC_HEADER
,

109 
U16
(0x0100),

110 
U16
(0x2b),

116 .
	gd©a
 = (
ušt8_t
[]) {

118 
USB_DT_CS_INTERFACE
,

119 
DST_AC_INPUT_TERMINAL
,

121 
U16
(0x0101),

124 
U16
(0x0003),

126 
STRING_INPUT_TERMINAL
,

130 .
	gd©a
 = (
ušt8_t
[]) {

132 
USB_DT_CS_INTERFACE
,

133 
DST_AC_FEATURE_UNIT
,

137 
U16
(0x0001),

138 
U16
(0x0002),

139 
U16
(0x0002),

140 
STRING_FEATURE_UNIT
,

144 .
	gd©a
 = (
ušt8_t
[]) {

146 
USB_DT_CS_INTERFACE
,

147 
DST_AC_OUTPUT_TERMINAL
,

149 
U16
(0x0301),

152 
STRING_OUTPUT_TERMINAL
,

157 .
	gbIÁ”çûNumb”
 = 1,

158 .
	gbAÉ”Ç‹S‘tšg
 = 0,

159 .
	gbNumEndpošts
 = 0,

160 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_AUDIO
,

161 .
	gbIÁ”çûSubCÏss
 = 
USB_SUBCLASS_AUDIO_STREAMING
,

162 .
	giIÁ”çû
 = 
STRING_NULL_STREAM
,

164 .
	gbIÁ”çûNumb”
 = 1,

165 .
	gbAÉ”Ç‹S‘tšg
 = 1,

166 .
	gbNumEndpošts
 = 1,

167 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_AUDIO
,

168 .
	gbIÁ”çûSubCÏss
 = 
USB_SUBCLASS_AUDIO_STREAMING
,

169 .
	giIÁ”çû
 = 
STRING_REAL_STREAM
,

170 .
	gndesc
 = 2,

171 .
	gdescs
 = (
USBDescOth”
[]) {

174 .
d©a
 = (
ušt8_t
[]) {

176 
USB_DT_CS_INTERFACE
,

177 
DST_AS_GENERAL
,

184 .
	gd©a
 = (
ušt8_t
[]) {

186 
USB_DT_CS_INTERFACE
,

187 
DST_AS_FORMAT_TYPE
,

193 
U24
(
USBAUDIO_SAMPLE_RATE
),

197 .
	g•s
 = (
USBDescEndpošt
[]) {

199 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 0x01,

200 .
	gbmA‰ribu‹s
 = 0x0d,

201 .
	gwMaxPack‘Size
 = 
USBAUDIO_PACKET_SIZE
,

202 .
	gbIÁ”v®
 = 1,

203 .
	gis_audio
 = 1,

206 .
	gexŒa
 = (
ušt8_t
[]) {

208 
USB_DT_CS_ENDPOINT
,

209 
DST_EP_GENERAL
,

212 
U16
(0x0000),

219 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû
 = {

220 .
bcdUSB
 = 0x0200,

221 .
	gbMaxPack‘Size0
 = 64,

222 .
	gbNumCÚfigu¿tiÚs
 = 1,

223 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

225 .
bNumIÁ”çûs
 = 2,

226 .
	gbCÚfigu¿tiÚV®ue
 = 
DEV_CONFIG_VALUE
,

227 .
	giCÚfigu¿tiÚ
 = 
STRING_CONFIG
,

228 .
	gbmA‰ribu‹s
 = 0xc0,

229 .
	gbMaxPow”
 = 0x32,

230 .
	gnif
 = 
ARRAY_SIZE
(
desc_içû
),

231 .
	gifs
 = 
desc_içû
,

236 cÚ¡ 
USBDesc
 
	gdesc_audio
 = {

237 .
id
 = {

238 .
idV’dÜ
 = 
USBAUDIO_VENDOR_NUM
,

239 .
	gidProduù
 = 
USBAUDIO_PRODUCT_NUM
,

240 .
	gbcdDeviû
 = 0,

241 .
	giMªuçùu»r
 = 
STRING_MANUFACTURER
,

242 .
	giProduù
 = 
STRING_PRODUCT
,

243 .
	giS”ŸlNumb”
 = 
STRING_SERIALNUMBER
,

245 .
	gfuÎ
 = &
desc_deviû
,

246 .
	g¡r
 = 
usb_audio_¡ršgbË
,

257 
	eusb_audio_®t£t
 {

258 
	mALTSET_OFF
 = 0x00,

259 
	mALTSET_ON
 = 0x01,

265 
	#CR_SET_CUR
 0x01

	)

266 
	#CR_GET_CUR
 0x81

	)

267 
	#CR_SET_MIN
 0x02

	)

268 
	#CR_GET_MIN
 0x82

	)

269 
	#CR_SET_MAX
 0x03

	)

270 
	#CR_GET_MAX
 0x83

	)

271 
	#CR_SET_RES
 0x04

	)

272 
	#CR_GET_RES
 0x84

	)

273 
	#CR_SET_MEM
 0x05

	)

274 
	#CR_GET_MEM
 0x85

	)

275 
	#CR_GET_STAT
 0xff

	)

280 
	#MUTE_CONTROL
 0x01

	)

281 
	#VOLUME_CONTROL
 0x02

	)

282 
	#BASS_CONTROL
 0x03

	)

283 
	#MID_CONTROL
 0x04

	)

284 
	#TREBLE_CONTROL
 0x05

	)

285 
	#GRAPHIC_EQUALIZER_CONTROL
 0x06

	)

286 
	#AUTOMATIC_GAIN_CONTROL
 0x07

	)

287 
	#DELAY_CONTROL
 0x08

	)

288 
	#BASS_BOOST_CONTROL
 0x09

	)

289 
	#LOUDNESS_CONTROL
 0x0a

	)

295 
	s¡»ambuf
 {

296 
ušt8_t
 *
	md©a
;

297 
ušt32_t
 
	msize
;

298 
ušt32_t
 
	m´od
;

299 
ušt32_t
 
	mcÚs
;

302 
	$¡»ambuf_š™
(
¡»ambuf
 *
buf
, 
ušt32_t
 
size
)

304 
	`g_ä“
(
buf
->
d©a
);

305 
buf
->
size
 = siz- (siz% 
USBAUDIO_PACKET_SIZE
);

306 
buf
->
d©a
 = 
	`g_m®loc
(buf->
size
);

307 
buf
->
´od
 = 0;

308 
buf
->
cÚs
 = 0;

309 
	}
}

311 
	$¡»ambuf_fši
(
¡»ambuf
 *
buf
)

313 
	`g_ä“
(
buf
->
d©a
);

314 
buf
->
d©a
 = 
NULL
;

315 
	}
}

317 
	$¡»ambuf_put
(
¡»ambuf
 *
buf
, 
USBPack‘
 *
p
)

319 
ušt32_t
 
ä“
 = 
buf
->
size
 - (buf->
´od
 - buf->
cÚs
);

321 ià(!
ä“
) {

324 
	`as£¹
(
ä“
 >ğ
USBAUDIO_PACKET_SIZE
);

325 
	`usb_·ck‘_cİy
(
p
, 
buf
->
d©a
 + (buf->
´od
 % buf->
size
),

326 
USBAUDIO_PACKET_SIZE
);

327 
buf
->
´od
 +ğ
USBAUDIO_PACKET_SIZE
;

328  
USBAUDIO_PACKET_SIZE
;

329 
	}
}

331 
ušt8_t
 *
	$¡»ambuf_g‘
(
¡»ambuf
 *
buf
)

333 
ušt32_t
 
u£d
 = 
buf
->
´od
 - buf->
cÚs
;

334 
ušt8_t
 *
d©a
;

336 ià(!
u£d
) {

337  
NULL
;

339 
	`as£¹
(
u£d
 >ğ
USBAUDIO_PACKET_SIZE
);

340 
d©a
 = 
buf
->d©¨+ (buf->
cÚs
 % buf->
size
);

341 
buf
->
cÚs
 +ğ
USBAUDIO_PACKET_SIZE
;

342  
d©a
;

343 
	}
}

345 
	sUSBAudioS‹
 {

347 
USBDeviû
 
	mdev
;

348 
QEMUSoundC¬d
 
	mÿrd
;

352 
usb_audio_®t£t
 
	m®t£t
;

353 
aud£‰šgs
 
	mas
;

354 
SWVoiûOut
 *
	mvoiû
;

355 
boŞ
 
	mmu‹
;

356 
ušt8_t
 
	mvŞ
[2];

357 
¡»ambuf
 
	mbuf
;

358 } 
	mout
;

361 
ušt32_t
 
	mdebug
;

362 
ušt32_t
 
	mbufãr
;

363 } 
	tUSBAudioS‹
;

365 
	$ouut_ÿÎback
(*
İaque
, 
ava
)

367 
USBAudioS‹
 *
s
 = 
İaque
;

368 
ušt8_t
 *
d©a
;

371 ià(
ava
 < 
USBAUDIO_PACKET_SIZE
) {

374 
d©a
 = 
	`¡»ambuf_g‘
(&
s
->
out
.
buf
);

375 ià(
NULL
 =ğ
d©a
) {

378 
	`AUD_wr™e
(
s
->
out
.
voiû
, 
d©a
, 
USBAUDIO_PACKET_SIZE
);

379 
ava
 -ğ
USBAUDIO_PACKET_SIZE
;

381 
	}
}

383 
	$usb_audio_£t_ouut_®t£t
(
USBAudioS‹
 *
s
, 
®t£t
)

385 
®t£t
) {

386 
ALTSET_OFF
:

387 
	`¡»ambuf_š™
(&
s
->
out
.
buf
, s->
bufãr
);

388 
	`AUD_£t_aùive_out
(
s
->
out
.
voiû
, 
çl£
);

390 
ALTSET_ON
:

391 
	`AUD_£t_aùive_out
(
s
->
out
.
voiû
, 
Œue
);

397 ià(
s
->
debug
) {

398 
	`årštf
(
¡d”r
, "usb-audio: s‘ iÁ”çû %d\n", 
®t£t
);

400 
s
->
out
.
®t£t
 =‡ltset;

402 
	}
}

407 
	#ATTRIB_ID
(
cs
, 
©Œib
, 
idif
) \

408 (((
cs
è<< 24è| ((
©Œib
è<< 16è| (
idif
))

	)

410 
	$usb_audio_g‘_cÚŒŞ
(
USBAudioS‹
 *
s
, 
ušt8_t
 
©Œib
,

411 
ušt16_t
 
csú
, ušt16_ˆ
idif
,

412 
Ëngth
, 
ušt8_t
 *
d©a
)

414 
ušt8_t
 
cs
 = 
csú
 >> 8;

415 
ušt8_t
 
ú
 = 
csú
 - 1;

416 
ušt32_t
 
aid
 = 
	`ATTRIB_ID
(
cs
, 
©Œib
, 
idif
);

417 
»t
 = 
USB_RET_STALL
;

419 
aid
) {

420 
	`ATTRIB_ID
(
MUTE_CONTROL
, 
CR_GET_CUR
, 0x0200):

421 
d©a
[0] = 
s
->
out
.
mu‹
;

422 
»t
 = 1;

424 
	`ATTRIB_ID
(
VOLUME_CONTROL
, 
CR_GET_CUR
, 0x0200):

425 ià(
ú
 < 2) {

426 
ušt16_t
 
vŞ
 = (
s
->
out
.vŞ[
ú
] * 0x8800 + 127) / 255 + 0x8000;

427 
d©a
[0] = 
vŞ
;

428 
d©a
[1] = 
vŞ
 >> 8;

429 
»t
 = 2;

432 
	`ATTRIB_ID
(
VOLUME_CONTROL
, 
CR_GET_MIN
, 0x0200):

433 ià(
ú
 < 2) {

434 
d©a
[0] = 0x01;

435 
d©a
[1] = 0x80;

436 
»t
 = 2;

439 
	`ATTRIB_ID
(
VOLUME_CONTROL
, 
CR_GET_MAX
, 0x0200):

440 ià(
ú
 < 2) {

441 
d©a
[0] = 0x00;

442 
d©a
[1] = 0x08;

443 
»t
 = 2;

446 
	`ATTRIB_ID
(
VOLUME_CONTROL
, 
CR_GET_RES
, 0x0200):

447 ià(
ú
 < 2) {

448 
d©a
[0] = 0x88;

449 
d©a
[1] = 0x00;

450 
»t
 = 2;

455  
»t
;

456 
	}
}

457 
	$usb_audio_£t_cÚŒŞ
(
USBAudioS‹
 *
s
, 
ušt8_t
 
©Œib
,

458 
ušt16_t
 
csú
, ušt16_ˆ
idif
,

459 
Ëngth
, 
ušt8_t
 *
d©a
)

461 
ušt8_t
 
cs
 = 
csú
 >> 8;

462 
ušt8_t
 
ú
 = 
csú
 - 1;

463 
ušt32_t
 
aid
 = 
	`ATTRIB_ID
(
cs
, 
©Œib
, 
idif
);

464 
»t
 = 
USB_RET_STALL
;

465 
boŞ
 
£t_vŞ
 = 
çl£
;

467 
aid
) {

468 
	`ATTRIB_ID
(
MUTE_CONTROL
, 
CR_SET_CUR
, 0x0200):

469 
s
->
out
.
mu‹
 = 
d©a
[0] & 1;

470 
£t_vŞ
 = 
Œue
;

471 
»t
 = 0;

473 
	`ATTRIB_ID
(
VOLUME_CONTROL
, 
CR_SET_CUR
, 0x0200):

474 ià(
ú
 < 2) {

475 
ušt16_t
 
vŞ
 = 
d©a
[0] + (data[1] << 8);

477 ià(
s
->
debug
) {

478 
	`årštf
(
¡d”r
, "usb-audio: vŞ %04x\n", (
ušt16_t
)
vŞ
);

481 
vŞ
 -= 0x8000;

482 
vŞ
 = (vol * 255 + 0x4400) / 0x8800;

483 ià(
vŞ
 > 255) {

484 
vŞ
 = 255;

487 
s
->
out
.
vŞ
[
ú
] = vol;

488 
£t_vŞ
 = 
Œue
;

489 
»t
 = 0;

494 ià(
£t_vŞ
) {

495 ià(
s
->
debug
) {

496 
	`årštf
(
¡d”r
, "usb-audio: mute %d,†vol %3d,„vol %3d\n",

497 
s
->
out
.
mu‹
, s->out.
vŞ
[0], s->out.vol[1]);

499 
	`AUD_£t_vŞume_out
(
s
->
out
.
voiû
, s->out.
mu‹
,

500 
s
->
out
.
vŞ
[0], s->out.vol[1]);

503  
»t
;

504 
	}
}

506 
	$usb_audio_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

507 
»que¡
, 
v®ue
, 
šdex
,

508 
Ëngth
, 
ušt8_t
 *
d©a
)

510 
USBAudioS‹
 *
s
 = 
	`DO_UPCAST
(USBAudioS‹, 
dev
, dev);

511 
»t
 = 0;

513 ià(
s
->
debug
) {

514 
	`årštf
(
¡d”r
, "usb-audio: controlransaction: "

516 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
);

519 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

520 ià(
»t
 >= 0) {

521  
»t
;

524 
»que¡
) {

525 
CÏssIÁ”çûReque¡
 | 
CR_GET_CUR
:

526 
CÏssIÁ”çûReque¡
 | 
CR_GET_MIN
:

527 
CÏssIÁ”çûReque¡
 | 
CR_GET_MAX
:

528 
CÏssIÁ”çûReque¡
 | 
CR_GET_RES
:

529 
»t
 = 
	`usb_audio_g‘_cÚŒŞ
(
s
, 
»que¡
 & 0xff, 
v®ue
, 
šdex
,

530 
Ëngth
, 
d©a
);

531 ià(
»t
 < 0) {

532 ià(
s
->
debug
) {

533 
	`årštf
(
¡d”r
, "usb-audio: fail: get control\n");

535 
ç
;

539 
CÏssIÁ”çûOutReque¡
 | 
CR_SET_CUR
:

540 
CÏssIÁ”çûOutReque¡
 | 
CR_SET_MIN
:

541 
CÏssIÁ”çûOutReque¡
 | 
CR_SET_MAX
:

542 
CÏssIÁ”çûOutReque¡
 | 
CR_SET_RES
:

543 
»t
 = 
	`usb_audio_£t_cÚŒŞ
(
s
, 
»que¡
 & 0xff, 
v®ue
, 
šdex
,

544 
Ëngth
, 
d©a
);

545 ià(
»t
 < 0) {

546 ià(
s
->
debug
) {

547 
	`årštf
(
¡d”r
, "usb-audio: fail: set control\n");

549 
ç
;

554 
ç
:

555 ià(
s
->
debug
) {

556 
	`årštf
(
¡d”r
, "usb-audio: failed controlransaction: "

558 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
);

560 
»t
 = 
USB_RET_STALL
;

563  
»t
;

564 
	}
}

566 
	$usb_audio_£t_š‹rçû
(
USBDeviû
 *
dev
, 
içû
,

567 
Şd
, 
v®ue
)

569 
USBAudioS‹
 *
s
 = 
	`DO_UPCAST
(USBAudioS‹, 
dev
, dev);

571 ià(
içû
 == 1) {

572 
	`usb_audio_£t_ouut_®t£t
(
s
, 
v®ue
);

574 
	}
}

576 
	$usb_audio_hªdË_»£t
(
USBDeviû
 *
dev
)

578 
USBAudioS‹
 *
s
 = 
	`DO_UPCAST
(USBAudioS‹, 
dev
, dev);

580 ià(
s
->
debug
) {

581 
	`årštf
(
¡d”r
, "usb-audio:„eset\n");

583 
	`usb_audio_£t_ouut_®t£t
(
s
, 
ALTSET_OFF
);

584 
	}
}

586 
	$usb_audio_hªdË_d©aout
(
USBAudioS‹
 *
s
, 
USBPack‘
 *
p
)

588 
rc
;

590 ià(
s
->
out
.
®t£t
 =ğ
ALTSET_OFF
) {

591  
USB_RET_STALL
;

594 
rc
 = 
	`¡»ambuf_put
(&
s
->
out
.
buf
, 
p
);

595 ià(
rc
 < 
p
->
iov
.
size
 && 
s
->
debug
 > 1) {

596 
	`årštf
(
¡d”r
, "usb-audio: output overrun (%zd bytes)\n",

597 
p
->
iov
.
size
 - 
rc
);

601 
	}
}

603 
	$usb_audio_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

605 
USBAudioS‹
 *
s
 = (USBAudioS‹ *è
dev
;

606 
»t
 = 0;

608 
p
->
pid
) {

609 
USB_TOKEN_OUT
:

610 
p
->
•
->
Ä
) {

612 
»t
 = 
	`usb_audio_hªdË_d©aout
(
s
, 
p
);

615 
ç
;

620 
ç
:

621 
»t
 = 
USB_RET_STALL
;

624 ià(
»t
 =ğ
USB_RET_STALL
 && 
s
->
debug
) {

625 
	`årštf
(
¡d”r
, "usb-audio: failed dataransaction: "

627 
p
->
pid
,…->
•
->
Ä
,…->
iov
.
size
);

629  
»t
;

630 
	}
}

632 
	$usb_audio_hªdË_de¡roy
(
USBDeviû
 *
dev
)

634 
USBAudioS‹
 *
s
 = 
	`DO_UPCAST
(USBAudioS‹, 
dev
, dev);

636 ià(
s
->
debug
) {

637 
	`årštf
(
¡d”r
, "usb-audio: destroy\n");

640 
	`usb_audio_£t_ouut_®t£t
(
s
, 
ALTSET_OFF
);

641 
	`AUD_şo£_out
(&
s
->
ÿrd
, s->
out
.
voiû
);

642 
	`AUD_»move_ÿrd
(&
s
->
ÿrd
);

644 
	`¡»ambuf_fši
(&
s
->
out
.
buf
);

645 
	}
}

647 
	$usb_audio_š™â
(
USBDeviû
 *
dev
)

649 
USBAudioS‹
 *
s
 = 
	`DO_UPCAST
(USBAudioS‹, 
dev
, dev);

651 
	`usb_desc_ü—‹_£rŸl
(
dev
);

652 
	`usb_desc_š™
(
dev
);

653 
s
->
dev
.
İaque
 = s;

654 
	`AUD_»gi¡”_ÿrd
("usb-audio", &
s
->
ÿrd
);

656 
s
->
out
.
®t£t
 = 
ALTSET_OFF
;

657 
s
->
out
.
mu‹
 = 
çl£
;

658 
s
->
out
.
vŞ
[0] = 240;

659 
s
->
out
.
vŞ
[1] = 240;

660 
s
->
out
.
as
.
äeq
 = 
USBAUDIO_SAMPLE_RATE
;

661 
s
->
out
.
as
.
nchªÃls
 = 2;

662 
s
->
out
.
as
.
fmt
 = 
AUD_FMT_S16
;

663 
s
->
out
.
as
.
’dŸÂess
 = 0;

664 
	`¡»ambuf_š™
(&
s
->
out
.
buf
, s->
bufãr
);

666 
s
->
out
.
voiû
 = 
	`AUD_İ’_out
(&s->
ÿrd
, s->out.voice, "usb-audio",

667 
s
, 
ouut_ÿÎback
, &s->
out
.
as
);

668 
	`AUD_£t_vŞume_out
(
s
->
out
.
voiû
, s->out.
mu‹
, s->out.
vŞ
[0], s->out.vol[1]);

669 
	`AUD_£t_aùive_out
(
s
->
out
.
voiû
, 0);

671 
	}
}

673 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_audio
 = {

674 .
Çme
 = "usb-audio",

675 .
	gunmig¿bË
 = 1,

678 
Prİ”ty
 
	gusb_audio_´İ”t›s
[] = {

679 
DEFINE_PROP_UINT32
("debug", 
USBAudioS‹
, 
debug
, 0),

680 
DEFINE_PROP_UINT32
("bufãr", 
USBAudioS‹
, 
bufãr
,

681 8 * 
USBAUDIO_PACKET_SIZE
),

682 
DEFINE_PROP_END_OF_LIST
(),

685 
	$usb_audio_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

687 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

688 
USBDeviûCÏss
 *
k
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

690 
dc
->
vmsd
 = &
vm¡©e_usb_audio
;

691 
dc
->
´İs
 = 
usb_audio_´İ”t›s
;

692 
k
->
´oduù_desc
 = "QEMU USB Audio Interface";

693 
k
->
usb_desc
 = &
desc_audio
;

694 
k
->
š™
 = 
usb_audio_š™â
;

695 
k
->
hªdË_»£t
 = 
usb_audio_hªdË_»£t
;

696 
k
->
hªdË_cÚŒŞ
 = 
usb_audio_hªdË_cÚŒŞ
;

697 
k
->
hªdË_d©a
 = 
usb_audio_hªdË_d©a
;

698 
k
->
hªdË_de¡roy
 = 
usb_audio_hªdË_de¡roy
;

699 
k
->
£t_š‹rçû
 = 
usb_audio_£t_š‹rçû
;

700 
	}
}

702 
Ty³Info
 
	gusb_audio_šfo
 = {

703 .
Çme
 = "usb-audio",

704 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

705 .
	gš¡ªû_size
 = (
USBAudioS‹
),

706 .
	gşass_š™
 = 
usb_audio_şass_š™
,

709 
	$usb_audio_»gi¡”_ty³s
()

711 
	`ty³_»gi¡”_¡©ic
(&
usb_audio_šfo
);

712 
	`usb_Ëgacy_»gi¡”
("usb-audio", "audio", 
NULL
);

713 
	}
}

715 
ty³_š™
(
usb_audio_»gi¡”_ty³s
)

	@dev-bluetooth.c

21 
	~"qemu-commÚ.h
"

22 
	~"hw/usb.h
"

23 
	~"hw/usb/desc.h
"

24 
	~"Ãt.h
"

25 
	~"hw/bt.h
"

27 
	sUSBBtS‹
 {

28 
USBDeviû
 
	mdev
;

29 
HCIInfo
 *
	mhci
;

31 
	mcÚfig
;

33 
	#CFIFO_LEN_MASK
 255

	)

34 
	#DFIFO_LEN_MASK
 4095

	)

35 
	susb_hci_š_fifo_s
 {

36 
ušt8_t
 
	md©a
[(
DFIFO_LEN_MASK
 + 1) * 2];

38 
ušt8_t
 *
	md©a
;

39 
	mËn
;

40 } 
	mfifo
[
CFIFO_LEN_MASK
 + 1];

41 
	md¡¬t
, 
	mdËn
, 
	mdsize
, 
	m¡¬t
, 
	mËn
;

42 } 
	mevt
, 
	maş
, 
	msco
;

44 
	susb_hci_out_fifo_s
 {

45 
ušt8_t
 
	md©a
[4096];

46 
	mËn
;

47 } 
	moutcmd
, 
	mouş
, 
	moutsco
;

50 
	#USB_EVT_EP
 1

	)

51 
	#USB_ACL_EP
 2

	)

52 
	#USB_SCO_EP
 3

	)

55 
	mSTR_MANUFACTURER
 = 1,

56 
	mSTR_SERIALNUMBER
,

59 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

60 [
STR_MANUFACTURER
] = "QEMU",

61 [
STR_SERIALNUMBER
] = "1",

64 cÚ¡ 
USBDescIçû
 
	gdesc_içû_blu‘oÙh
[] = {

66 .
bIÁ”çûNumb”
 = 0,

67 .
	gbNumEndpošts
 = 3,

68 .
	gbIÁ”çûCÏss
 = 0xe0,

69 .
	gbIÁ”çûSubCÏss
 = 0x01,

70 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

71 .
	g•s
 = (
USBDescEndpošt
[]) {

73 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_EVT_EP
,

74 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

75 .
	gwMaxPack‘Size
 = 0x10,

76 .
	gbIÁ”v®
 = 0x02,

79 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
USB_ACL_EP
,

80 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

81 .
	gwMaxPack‘Size
 = 0x40,

82 .
	gbIÁ”v®
 = 0x0a,

85 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_ACL_EP
,

86 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

87 .
	gwMaxPack‘Size
 = 0x40,

88 .
	gbIÁ”v®
 = 0x0a,

92 .
	gbIÁ”çûNumb”
 = 1,

93 .
	gbAÉ”Ç‹S‘tšg
 = 0,

94 .
	gbNumEndpošts
 = 2,

95 .
	gbIÁ”çûCÏss
 = 0xe0,

96 .
	gbIÁ”çûSubCÏss
 = 0x01,

97 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

98 .
	g•s
 = (
USBDescEndpošt
[]) {

100 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
USB_SCO_EP
,

101 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

102 .
	gwMaxPack‘Size
 = 0,

103 .
	gbIÁ”v®
 = 0x01,

106 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_SCO_EP
,

107 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

108 .
	gwMaxPack‘Size
 = 0,

109 .
	gbIÁ”v®
 = 0x01,

113 .
	gbIÁ”çûNumb”
 = 1,

114 .
	gbAÉ”Ç‹S‘tšg
 = 1,

115 .
	gbNumEndpošts
 = 2,

116 .
	gbIÁ”çûCÏss
 = 0xe0,

117 .
	gbIÁ”çûSubCÏss
 = 0x01,

118 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

119 .
	g•s
 = (
USBDescEndpošt
[]) {

121 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
USB_SCO_EP
,

122 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

123 .
	gwMaxPack‘Size
 = 0x09,

124 .
	gbIÁ”v®
 = 0x01,

127 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_SCO_EP
,

128 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

129 .
	gwMaxPack‘Size
 = 0x09,

130 .
	gbIÁ”v®
 = 0x01,

134 .
	gbIÁ”çûNumb”
 = 1,

135 .
	gbAÉ”Ç‹S‘tšg
 = 2,

136 .
	gbNumEndpošts
 = 2,

137 .
	gbIÁ”çûCÏss
 = 0xe0,

138 .
	gbIÁ”çûSubCÏss
 = 0x01,

139 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

140 .
	g•s
 = (
USBDescEndpošt
[]) {

142 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
USB_SCO_EP
,

143 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

144 .
	gwMaxPack‘Size
 = 0x11,

145 .
	gbIÁ”v®
 = 0x01,

148 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_SCO_EP
,

149 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

150 .
	gwMaxPack‘Size
 = 0x11,

151 .
	gbIÁ”v®
 = 0x01,

155 .
	gbIÁ”çûNumb”
 = 1,

156 .
	gbAÉ”Ç‹S‘tšg
 = 3,

157 .
	gbNumEndpošts
 = 2,

158 .
	gbIÁ”çûCÏss
 = 0xe0,

159 .
	gbIÁ”çûSubCÏss
 = 0x01,

160 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

161 .
	g•s
 = (
USBDescEndpošt
[]) {

163 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
USB_SCO_EP
,

164 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

165 .
	gwMaxPack‘Size
 = 0x19,

166 .
	gbIÁ”v®
 = 0x01,

169 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_SCO_EP
,

170 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

171 .
	gwMaxPack‘Size
 = 0x19,

172 .
	gbIÁ”v®
 = 0x01,

176 .
	gbIÁ”çûNumb”
 = 1,

177 .
	gbAÉ”Ç‹S‘tšg
 = 4,

178 .
	gbNumEndpošts
 = 2,

179 .
	gbIÁ”çûCÏss
 = 0xe0,

180 .
	gbIÁ”çûSubCÏss
 = 0x01,

181 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

182 .
	g•s
 = (
USBDescEndpošt
[]) {

184 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
USB_SCO_EP
,

185 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

186 .
	gwMaxPack‘Size
 = 0x21,

187 .
	gbIÁ”v®
 = 0x01,

190 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_SCO_EP
,

191 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

192 .
	gwMaxPack‘Size
 = 0x21,

193 .
	gbIÁ”v®
 = 0x01,

197 .
	gbIÁ”çûNumb”
 = 1,

198 .
	gbAÉ”Ç‹S‘tšg
 = 5,

199 .
	gbNumEndpošts
 = 2,

200 .
	gbIÁ”çûCÏss
 = 0xe0,

201 .
	gbIÁ”çûSubCÏss
 = 0x01,

202 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

203 .
	g•s
 = (
USBDescEndpošt
[]) {

205 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
USB_SCO_EP
,

206 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

207 .
	gwMaxPack‘Size
 = 0x31,

208 .
	gbIÁ”v®
 = 0x01,

211 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
USB_SCO_EP
,

212 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_ISOC
,

213 .
	gwMaxPack‘Size
 = 0x31,

214 .
	gbIÁ”v®
 = 0x01,

220 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_blu‘oÙh
 = {

221 .
bcdUSB
 = 0x0110,

222 .
	gbDeviûCÏss
 = 0xe0,

223 .
	gbDeviûSubCÏss
 = 0x01,

224 .
	gbDeviûPrÙocŞ
 = 0x01,

225 .
	gbMaxPack‘Size0
 = 64,

226 .
	gbNumCÚfigu¿tiÚs
 = 1,

227 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

229 .
bNumIÁ”çûs
 = 2,

230 .
	gbCÚfigu¿tiÚV®ue
 = 1,

231 .
	gbmA‰ribu‹s
 = 0xc0,

232 .
	gbMaxPow”
 = 0,

233 .
	gnif
 = 
ARRAY_SIZE
(
desc_içû_blu‘oÙh
),

234 .
	gifs
 = 
desc_içû_blu‘oÙh
,

239 cÚ¡ 
USBDesc
 
	gdesc_blu‘oÙh
 = {

240 .
id
 = {

241 .
idV’dÜ
 = 0x0a12,

242 .
	gidProduù
 = 0x0001,

243 .
	gbcdDeviû
 = 0x1958,

244 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

245 .
	giProduù
 = 0,

246 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

248 .
	gfuÎ
 = &
desc_deviû_blu‘oÙh
,

249 .
	g¡r
 = 
desc_¡ršgs
,

252 
	$usb_bt_fifo_»£t
(
usb_hci_š_fifo_s
 *
fifo
)

254 
fifo
->
d¡¬t
 = 0;

255 
fifo
->
dËn
 = 0;

256 
fifo
->
dsize
 = 
DFIFO_LEN_MASK
 + 1;

257 
fifo
->
¡¬t
 = 0;

258 
fifo
->
Ën
 = 0;

259 
	}
}

261 
	$usb_bt_fifo_’queue
(
usb_hci_š_fifo_s
 *
fifo
,

262 cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

264 
off
 = 
fifo
->
d¡¬t
 + fifo->
dËn
;

265 
ušt8_t
 *
buf
;

267 
fifo
->
dËn
 +ğ
Ën
;

268 ià(
off
 <ğ
DFIFO_LEN_MASK
) {

269 ià(
off
 + 
Ën
 > 
DFIFO_LEN_MASK
 + 1 &&

270 (
fifo
->
dsize
 = 
off
 + 
Ën
è> (
DFIFO_LEN_MASK
 + 1) * 2) {

271 
	`årštf
(
¡d”r
, "%s: cª'ˆ®loø%˜by‹s\n", 
__FUNCTION__
, 
Ën
);

272 
	`ex™
(-1);

274 
buf
 = 
fifo
->
d©a
 + 
off
;

276 ià(
fifo
->
dËn
 > fifo->
dsize
) {

277 
	`årštf
(
¡d”r
, "%s: cª'ˆ®loø%˜by‹s\n", 
__FUNCTION__
, 
Ën
);

278 
	`ex™
(-1);

280 
buf
 = 
fifo
->
d©a
 + 
off
 - fifo->
dsize
;

283 
off
 = (
fifo
->
¡¬t
 + fifo->
Ën
 ++è& 
CFIFO_LEN_MASK
;

284 
fifo
->fifo[
off
].
d©a
 = 
	`memıy
(
buf
, d©a, 
Ën
);

285 
fifo
->fifo[
off
].
Ën
 =†en;

286 
	}
}

288 
šlše
 
	$usb_bt_fifo_dequeue
(
usb_hci_š_fifo_s
 *
fifo
,

289 
USBPack‘
 *
p
)

291 
Ën
;

293 ià(
	`lik–y
(!
fifo
->
Ën
))

294  
USB_RET_STALL
;

296 
Ën
 = 
	`MIN
(
p
->
iov
.
size
, 
fifo
->fifo[fifo->
¡¬t
].len);

297 
	`usb_·ck‘_cİy
(
p
, 
fifo
->fifo[fifo->
¡¬t
].
d©a
, 
Ën
);

298 ià(
Ën
 =ğ
p
->
iov
.
size
) {

299 
fifo
->fifo[fifo->
¡¬t
].
Ën
 -=†en;

300 
fifo
->fifo[fifo->
¡¬t
].
d©a
 +ğ
Ën
;

302 
fifo
->
¡¬t
 ++;

303 
fifo
->
¡¬t
 &ğ
CFIFO_LEN_MASK
;

304 
fifo
->
Ën
 --;

307 
fifo
->
d¡¬t
 +ğ
Ën
;

308 
fifo
->
dËn
 -ğ
Ën
;

309 ià(
fifo
->
d¡¬t
 >ğfifo->
dsize
) {

310 
fifo
->
d¡¬t
 = 0;

311 
fifo
->
dsize
 = 
DFIFO_LEN_MASK
 + 1;

314  
Ën
;

315 
	}
}

317 
šlše
 
usb_bt_fifo_out_’queue
(
USBBtS‹
 *
s
,

318 
usb_hci_out_fifo_s
 *
fifo
,

319 (*
£nd
)(
HCIInfo
 *, cÚ¡ 
ušt8_t
 *, ),

320 (*
com¶‘e
)(cÚ¡ 
ušt8_t
 *, ),

321 
USBPack‘
 *
p
)

323 
	`usb_·ck‘_cİy
(
p
, 
fifo
->
d©a
 + fifo->
Ën
,…->
iov
.
size
);

324 
fifo
->
Ën
 +ğ
p
->
iov
.
size
;

325 ià(
	`com¶‘e
(
fifo
->
d©a
, fifo->
Ën
)) {

326 
	`£nd
(
s
->
hci
, 
fifo
->
d©a
, fifo->
Ën
);

327 
fifo
->
Ën
 = 0;

331 
	}
}

333 
	$usb_bt_hci_cmd_com¶‘e
(cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

335 
Ën
 -ğ
HCI_COMMAND_HDR_SIZE
;

336  
Ën
 >= 0 &&

337 
Ën
 >ğ((
hci_commªd_hdr
 *è
d©a
)->
¶’
;

338 
	}
}

340 
	$usb_bt_hci_aş_com¶‘e
(cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

342 
Ën
 -ğ
HCI_ACL_HDR_SIZE
;

343  
Ën
 >= 0 &&

344 
Ën
 >ğ
	`Ë16_to_ıu
(((
hci_aş_hdr
 *è
d©a
)->
dËn
);

345 
	}
}

347 
	$usb_bt_hci_sco_com¶‘e
(cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

349 
Ën
 -ğ
HCI_SCO_HDR_SIZE
;

350  
Ën
 >= 0 &&

351 
Ën
 >ğ((
hci_sco_hdr
 *è
d©a
)->
dËn
;

352 
	}
}

354 
	$usb_bt_hªdË_»£t
(
USBDeviû
 *
dev
)

356 
USBBtS‹
 *
s
 = (USBBtS‹ *è
dev
->
İaque
;

358 
	`usb_bt_fifo_»£t
(&
s
->
evt
);

359 
	`usb_bt_fifo_»£t
(&
s
->
aş
);

360 
	`usb_bt_fifo_»£t
(&
s
->
sco
);

361 
s
->
outcmd
.
Ën
 = 0;

362 
s
->
ouş
.
Ën
 = 0;

363 
s
->
outsco
.
Ën
 = 0;

364 
	}
}

366 
	$usb_bt_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

367 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

369 
USBBtS‹
 *
s
 = (USBBtS‹ *è
dev
->
İaque
;

370 
»t
;

372 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

373 ià(
»t
 >= 0) {

374 
»que¡
) {

375 
DeviûReque¡
 | 
USB_REQ_GET_CONFIGURATION
:

376 
s
->
cÚfig
 = 0;

378 
DeviûOutReque¡
 | 
USB_REQ_SET_CONFIGURATION
:

379 
s
->
cÚfig
 = 1;

380 
	`usb_bt_fifo_»£t
(&
s
->
evt
);

381 
	`usb_bt_fifo_»£t
(&
s
->
aş
);

382 
	`usb_bt_fifo_»£t
(&
s
->
sco
);

385  
»t
;

388 
»t
 = 0;

389 
»que¡
) {

390 
IÁ”çûReque¡
 | 
USB_REQ_GET_STATUS
:

391 
EndpoštReque¡
 | 
USB_REQ_GET_STATUS
:

392 
d©a
[0] = 0x00;

393 
d©a
[1] = 0x00;

394 
»t
 = 2;

396 
IÁ”çûOutReque¡
 | 
USB_REQ_CLEAR_FEATURE
:

397 
EndpoštOutReque¡
 | 
USB_REQ_CLEAR_FEATURE
:

398 
ç
;

399 
IÁ”çûOutReque¡
 | 
USB_REQ_SET_FEATURE
:

400 
EndpoštOutReque¡
 | 
USB_REQ_SET_FEATURE
:

401 
ç
;

403 ((
USB_DIR_OUT
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_DEVICE
) << 8):

404 ià(
s
->
cÚfig
)

405 
	`usb_bt_fifo_out_’queue
(
s
, &s->
outcmd
, s->
hci
->
cmd_£nd
,

406 
usb_bt_hci_cmd_com¶‘e
, 
p
);

409 
ç
:

410 
»t
 = 
USB_RET_STALL
;

413  
»t
;

414 
	}
}

416 
	$usb_bt_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

418 
USBBtS‹
 *
s
 = (USBBtS‹ *è
dev
->
İaque
;

419 
»t
 = 0;

421 ià(!
s
->
cÚfig
)

422 
ç
;

424 
p
->
pid
) {

425 
USB_TOKEN_IN
:

426 
p
->
•
->
Ä
) {

427 
USB_EVT_EP
:

428 
»t
 = 
	`usb_bt_fifo_dequeue
(&
s
->
evt
, 
p
);

431 
USB_ACL_EP
:

432 
»t
 = 
	`usb_bt_fifo_dequeue
(&
s
->
aş
, 
p
);

435 
USB_SCO_EP
:

436 
»t
 = 
	`usb_bt_fifo_dequeue
(&
s
->
sco
, 
p
);

440 
ç
;

444 
USB_TOKEN_OUT
:

445 
p
->
•
->
Ä
) {

446 
USB_ACL_EP
:

447 
	`usb_bt_fifo_out_’queue
(
s
, &s->
ouş
, s->
hci
->
aş_£nd
,

448 
usb_bt_hci_aş_com¶‘e
, 
p
);

451 
USB_SCO_EP
:

452 
	`usb_bt_fifo_out_’queue
(
s
, &s->
outsco
, s->
hci
->
sco_£nd
,

453 
usb_bt_hci_sco_com¶‘e
, 
p
);

457 
ç
;

462 
ç
:

463 
»t
 = 
USB_RET_STALL
;

467  
»t
;

468 
	}
}

470 
	$usb_bt_out_hci_·ck‘_ev’t
(*
İaque
,

471 cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

473 
USBBtS‹
 *
s
 = (USBBtS‹ *è
İaque
;

475 
	`usb_bt_fifo_’queue
(&
s
->
evt
, 
d©a
, 
Ën
);

476 
	}
}

478 
	$usb_bt_out_hci_·ck‘_aş
(*
İaque
,

479 cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

481 
USBBtS‹
 *
s
 = (USBBtS‹ *è
İaque
;

483 
	`usb_bt_fifo_’queue
(&
s
->
aş
, 
d©a
, 
Ën
);

484 
	}
}

486 
	$usb_bt_hªdË_de¡roy
(
USBDeviû
 *
dev
)

488 
USBBtS‹
 *
s
 = (USBBtS‹ *è
dev
->
İaque
;

490 
s
->
hci
->
İaque
 = 
NULL
;

491 
s
->
hci
->
evt_»cv
 = 
NULL
;

492 
s
->
hci
->
aş_»cv
 = 
NULL
;

493 
	}
}

495 
	$usb_bt_š™â
(
USBDeviû
 *
dev
)

497 
	`usb_desc_ü—‹_£rŸl
(
dev
);

498 
	`usb_desc_š™
(
dev
);

500 
	}
}

502 
USBDeviû
 *
	$usb_bt_š™
(
USBBus
 *
bus
, 
HCIInfo
 *
hci
)

504 
USBDeviû
 *
dev
;

505 
USBBtS‹
 *
s
;

507 ià(!
hci
)

508  
NULL
;

509 
dev
 = 
	`usb_ü—‹_sim¶e
(
bus
, "usb-bt-dongle");

510 ià(!
dev
) {

511  
NULL
;

513 
s
 = 
	`DO_UPCAST
(
USBBtS‹
, 
dev
, dev);

514 
s
->
dev
.
İaque
 = s;

516 
s
->
hci
 = hci;

517 
s
->
hci
->
İaque
 = s;

518 
s
->
hci
->
evt_»cv
 = 
usb_bt_out_hci_·ck‘_ev’t
;

519 
s
->
hci
->
aş_»cv
 = 
usb_bt_out_hci_·ck‘_aş
;

521 
	`usb_bt_hªdË_»£t
(&
s
->
dev
);

523  
dev
;

524 
	}
}

526 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_bt
 = {

527 .
Çme
 = "usb-bt",

528 .
	gunmig¿bË
 = 1,

531 
	$usb_bt_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

533 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

534 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

536 
uc
->
š™
 = 
usb_bt_š™â
;

537 
uc
->
´oduù_desc
 = "QEMU BT dongle";

538 
uc
->
usb_desc
 = &
desc_blu‘oÙh
;

539 
uc
->
hªdË_»£t
 = 
usb_bt_hªdË_»£t
;

540 
uc
->
hªdË_cÚŒŞ
 = 
usb_bt_hªdË_cÚŒŞ
;

541 
uc
->
hªdË_d©a
 = 
usb_bt_hªdË_d©a
;

542 
uc
->
hªdË_de¡roy
 = 
usb_bt_hªdË_de¡roy
;

543 
dc
->
vmsd
 = &
vm¡©e_usb_bt
;

544 
	}
}

546 
Ty³Info
 
	gbt_šfo
 = {

547 .
Çme
 = "usb-bt-dongle",

548 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

549 .
	gš¡ªû_size
 = (
USBBtS‹
),

550 .
	gşass_š™
 = 
usb_bt_şass_š™â
,

553 
	$usb_bt_»gi¡”_ty³s
()

555 
	`ty³_»gi¡”_¡©ic
(&
bt_šfo
);

556 
	}
}

558 
ty³_š™
(
usb_bt_»gi¡”_ty³s
)

	@dev-hid.c

25 
	~"hw/hw.h
"

26 
	~"cÚsŞe.h
"

27 
	~"hw/usb.h
"

28 
	~"hw/usb/desc.h
"

29 
	~"qemu-tim”.h
"

30 
	~"hw/hid.h
"

33 
	#GET_REPORT
 0xa101

	)

34 
	#GET_IDLE
 0xa102

	)

35 
	#GET_PROTOCOL
 0xa103

	)

36 
	#SET_REPORT
 0x2109

	)

37 
	#SET_IDLE
 0x210a

	)

38 
	#SET_PROTOCOL
 0x210b

	)

41 
	#USB_DT_HID
 0x21

	)

42 
	#USB_DT_REPORT
 0x22

	)

43 
	#USB_DT_PHY
 0x23

	)

45 
	sUSBHIDS‹
 {

46 
USBDeviû
 
	mdev
;

47 
USBEndpošt
 *
	mšŒ
;

48 
HIDS‹
 
	mhid
;

49 } 
	tUSBHIDS‹
;

52 
	mSTR_MANUFACTURER
 = 1,

53 
	mSTR_PRODUCT_MOUSE
,

54 
	mSTR_PRODUCT_TABLET
,

55 
	mSTR_PRODUCT_KEYBOARD
,

56 
	mSTR_SERIALNUMBER
,

57 
	mSTR_CONFIG_MOUSE
,

58 
	mSTR_CONFIG_TABLET
,

59 
	mSTR_CONFIG_KEYBOARD
,

62 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

63 [
STR_MANUFACTURER
] = "QEMU",

64 [
STR_PRODUCT_MOUSE
] = "QEMU USB Mouse",

65 [
STR_PRODUCT_TABLET
] = "QEMU USB Tablet",

66 [
STR_PRODUCT_KEYBOARD
] = "QEMU USB Keyboard",

67 [
STR_SERIALNUMBER
] = "42",

68 [
STR_CONFIG_MOUSE
] = "HID Mouse",

69 [
STR_CONFIG_TABLET
] = "HID Tablet",

70 [
STR_CONFIG_KEYBOARD
] = "HID Keyboard",

73 cÚ¡ 
USBDescIçû
 
	gdesc_içû_mou£
 = {

74 .
bIÁ”çûNumb”
 = 0,

75 .
	gbNumEndpošts
 = 1,

76 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_HID
,

77 .
	gbIÁ”çûSubCÏss
 = 0x01,

78 .
	gbIÁ”çûPrÙocŞ
 = 0x02,

79 .
	gndesc
 = 1,

80 .
	gdescs
 = (
USBDescOth”
[]) {

83 .
d©a
 = (
ušt8_t
[]) {

85 
USB_DT_HID
,

89 
USB_DT_REPORT
,

94 .
	g•s
 = (
USBDescEndpošt
[]) {

96 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

97 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

98 .
	gwMaxPack‘Size
 = 4,

99 .
	gbIÁ”v®
 = 0x0a,

104 cÚ¡ 
USBDescIçû
 
	gdesc_içû_bËt
 = {

105 .
bIÁ”çûNumb”
 = 0,

106 .
	gbNumEndpošts
 = 1,

107 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_HID
,

108 .
	gbIÁ”çûPrÙocŞ
 = 0x02,

109 .
	gndesc
 = 1,

110 .
	gdescs
 = (
USBDescOth”
[]) {

113 .
d©a
 = (
ušt8_t
[]) {

115 
USB_DT_HID
,

119 
USB_DT_REPORT
,

124 .
	g•s
 = (
USBDescEndpošt
[]) {

126 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

127 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

128 .
	gwMaxPack‘Size
 = 8,

129 .
	gbIÁ”v®
 = 0x0a,

134 cÚ¡ 
USBDescIçû
 
	gdesc_içû_keybßrd
 = {

135 .
bIÁ”çûNumb”
 = 0,

136 .
	gbNumEndpošts
 = 1,

137 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_HID
,

138 .
	gbIÁ”çûSubCÏss
 = 0x01,

139 .
	gbIÁ”çûPrÙocŞ
 = 0x01,

140 .
	gndesc
 = 1,

141 .
	gdescs
 = (
USBDescOth”
[]) {

144 .
d©a
 = (
ušt8_t
[]) {

146 
USB_DT_HID
,

150 
USB_DT_REPORT
,

155 .
	g•s
 = (
USBDescEndpošt
[]) {

157 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

158 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

159 .
	gwMaxPack‘Size
 = 8,

160 .
	gbIÁ”v®
 = 0x0a,

165 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_mou£
 = {

166 .
bcdUSB
 = 0x0100,

167 .
	gbMaxPack‘Size0
 = 8,

168 .
	gbNumCÚfigu¿tiÚs
 = 1,

169 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

171 .
bNumIÁ”çûs
 = 1,

172 .
	gbCÚfigu¿tiÚV®ue
 = 1,

173 .
	giCÚfigu¿tiÚ
 = 
STR_CONFIG_MOUSE
,

174 .
	gbmA‰ribu‹s
 = 0xa0,

175 .
	gbMaxPow”
 = 50,

176 .
	gnif
 = 1,

177 .
	gifs
 = &
desc_içû_mou£
,

182 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_bËt
 = {

183 .
bcdUSB
 = 0x0100,

184 .
	gbMaxPack‘Size0
 = 8,

185 .
	gbNumCÚfigu¿tiÚs
 = 1,

186 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

188 .
bNumIÁ”çûs
 = 1,

189 .
	gbCÚfigu¿tiÚV®ue
 = 1,

190 .
	giCÚfigu¿tiÚ
 = 
STR_CONFIG_TABLET
,

191 .
	gbmA‰ribu‹s
 = 0xa0,

192 .
	gbMaxPow”
 = 50,

193 .
	gnif
 = 1,

194 .
	gifs
 = &
desc_içû_bËt
,

199 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_keybßrd
 = {

200 .
bcdUSB
 = 0x0100,

201 .
	gbMaxPack‘Size0
 = 8,

202 .
	gbNumCÚfigu¿tiÚs
 = 1,

203 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

205 .
bNumIÁ”çûs
 = 1,

206 .
	gbCÚfigu¿tiÚV®ue
 = 1,

207 .
	giCÚfigu¿tiÚ
 = 
STR_CONFIG_KEYBOARD
,

208 .
	gbmA‰ribu‹s
 = 0xa0,

209 .
	gbMaxPow”
 = 50,

210 .
	gnif
 = 1,

211 .
	gifs
 = &
desc_içû_keybßrd
,

216 cÚ¡ 
USBDesc
 
	gdesc_mou£
 = {

217 .
id
 = {

218 .
idV’dÜ
 = 0x0627,

219 .
	gidProduù
 = 0x0001,

220 .
	gbcdDeviû
 = 0,

221 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

222 .
	giProduù
 = 
STR_PRODUCT_MOUSE
,

223 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

225 .
	gfuÎ
 = &
desc_deviû_mou£
,

226 .
	g¡r
 = 
desc_¡ršgs
,

229 cÚ¡ 
USBDesc
 
	gdesc_bËt
 = {

230 .
id
 = {

231 .
idV’dÜ
 = 0x0627,

232 .
	gidProduù
 = 0x0001,

233 .
	gbcdDeviû
 = 0,

234 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

235 .
	giProduù
 = 
STR_PRODUCT_TABLET
,

236 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

238 .
	gfuÎ
 = &
desc_deviû_bËt
,

239 .
	g¡r
 = 
desc_¡ršgs
,

242 cÚ¡ 
USBDesc
 
	gdesc_keybßrd
 = {

243 .
id
 = {

244 .
idV’dÜ
 = 0x0627,

245 .
	gidProduù
 = 0x0001,

246 .
	gbcdDeviû
 = 0,

247 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

248 .
	giProduù
 = 
STR_PRODUCT_KEYBOARD
,

249 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

251 .
	gfuÎ
 = &
desc_deviû_keybßrd
,

252 .
	g¡r
 = 
desc_¡ršgs
,

255 cÚ¡ 
ušt8_t
 
	gqemu_mou£_hid_»pÜt_desütÜ
[] = {

285 cÚ¡ 
ušt8_t
 
	gqemu_bËt_hid_»pÜt_desütÜ
[] = {

325 cÚ¡ 
ušt8_t
 
	gqemu_keybßrd_hid_»pÜt_desütÜ
[] = {

360 
	$usb_hid_chªged
(
HIDS‹
 *
hs
)

362 
USBHIDS‹
 *
us
 = 
	`cÚš”_of
(
hs
, USBHIDS‹, 
hid
);

364 
	`usb_wakeup
(
us
->
šŒ
);

365 
	}
}

367 
	$usb_hid_hªdË_»£t
(
USBDeviû
 *
dev
)

369 
USBHIDS‹
 *
us
 = 
	`DO_UPCAST
(USBHIDS‹, 
dev
, dev);

371 
	`hid_»£t
(&
us
->
hid
);

372 
	}
}

374 
	$usb_hid_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

375 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

377 
USBHIDS‹
 *
us
 = 
	`DO_UPCAST
(USBHIDS‹, 
dev
, dev);

378 
HIDS‹
 *
hs
 = &
us
->
hid
;

379 
»t
;

381 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

382 ià(
»t
 >= 0) {

383  
»t
;

386 
»t
 = 0;

387 
»que¡
) {

389 
IÁ”çûReque¡
 | 
USB_REQ_GET_DESCRIPTOR
:

390 
v®ue
 >> 8) {

392 ià(
hs
->
kšd
 =ğ
HID_MOUSE
) {

393 
	`memıy
(
d©a
, 
qemu_mou£_hid_»pÜt_desütÜ
,

394 (
qemu_mou£_hid_»pÜt_desütÜ
));

395 
»t
 = (
qemu_mou£_hid_»pÜt_desütÜ
);

396 } ià(
hs
->
kšd
 =ğ
HID_TABLET
) {

397 
	`memıy
(
d©a
, 
qemu_bËt_hid_»pÜt_desütÜ
,

398 (
qemu_bËt_hid_»pÜt_desütÜ
));

399 
»t
 = (
qemu_bËt_hid_»pÜt_desütÜ
);

400 } ià(
hs
->
kšd
 =ğ
HID_KEYBOARD
) {

401 
	`memıy
(
d©a
, 
qemu_keybßrd_hid_»pÜt_desütÜ
,

402 (
qemu_keybßrd_hid_»pÜt_desütÜ
));

403 
»t
 = (
qemu_keybßrd_hid_»pÜt_desütÜ
);

407 
ç
;

410 
GET_REPORT
:

411 ià(
hs
->
kšd
 =ğ
HID_MOUSE
 || hs->kšd =ğ
HID_TABLET
) {

412 
»t
 = 
	`hid_poš‹r_pŞl
(
hs
, 
d©a
, 
Ëngth
);

413 } ià(
hs
->
kšd
 =ğ
HID_KEYBOARD
) {

414 
»t
 = 
	`hid_keybßrd_pŞl
(
hs
, 
d©a
, 
Ëngth
);

417 
SET_REPORT
:

418 ià(
hs
->
kšd
 =ğ
HID_KEYBOARD
) {

419 
»t
 = 
	`hid_keybßrd_wr™e
(
hs
, 
d©a
, 
Ëngth
);

421 
ç
;

424 
GET_PROTOCOL
:

425 ià(
hs
->
kšd
 !ğ
HID_KEYBOARD
 && hs->kšd !ğ
HID_MOUSE
) {

426 
ç
;

428 
»t
 = 1;

429 
d©a
[0] = 
hs
->
´ÙocŞ
;

431 
SET_PROTOCOL
:

432 ià(
hs
->
kšd
 !ğ
HID_KEYBOARD
 && hs->kšd !ğ
HID_MOUSE
) {

433 
ç
;

435 
»t
 = 0;

436 
hs
->
´ÙocŞ
 = 
v®ue
;

438 
GET_IDLE
:

439 
»t
 = 1;

440 
d©a
[0] = 
hs
->
idË
;

442 
SET_IDLE
:

443 
hs
->
idË
 = (
ušt8_t
è(
v®ue
 >> 8);

444 
	`hid_£t_Ãxt_idË
(
hs
, 
	`qemu_g‘_şock_ns
(
vm_şock
));

445 ià(
hs
->
kšd
 =ğ
HID_MOUSE
 || hs->kšd =ğ
HID_TABLET
) {

446 
	`hid_poš‹r_aùiv©e
(
hs
);

448 
»t
 = 0;

451 
ç
:

452 
»t
 = 
USB_RET_STALL
;

455  
»t
;

456 
	}
}

458 
	$usb_hid_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

460 
USBHIDS‹
 *
us
 = 
	`DO_UPCAST
(USBHIDS‹, 
dev
, dev);

461 
HIDS‹
 *
hs
 = &
us
->
hid
;

462 
ušt8_t
 
buf
[
p
->
iov
.
size
];

463 
»t
 = 0;

465 
p
->
pid
) {

466 
USB_TOKEN_IN
:

467 ià(
p
->
•
->
Ä
 == 1) {

468 
št64_t
 
cu¹ime
 = 
	`qemu_g‘_şock_ns
(
vm_şock
);

469 ià(
hs
->
kšd
 =ğ
HID_MOUSE
 || hs->kšd =ğ
HID_TABLET
) {

470 
	`hid_poš‹r_aùiv©e
(
hs
);

472 ià(!
	`hid_has_ev’ts
(
hs
) &&

473 (!
hs
->
idË
 || hs->
Ãxt_idË_şock
 - 
cu¹ime
 > 0)) {

474  
USB_RET_NAK
;

476 
	`hid_£t_Ãxt_idË
(
hs
, 
cu¹ime
);

477 ià(
hs
->
kšd
 =ğ
HID_MOUSE
 || hs->kšd =ğ
HID_TABLET
) {

478 
»t
 = 
	`hid_poš‹r_pŞl
(
hs
, 
buf
, 
p
->
iov
.
size
);

479 } ià(
hs
->
kšd
 =ğ
HID_KEYBOARD
) {

480 
»t
 = 
	`hid_keybßrd_pŞl
(
hs
, 
buf
, 
p
->
iov
.
size
);

482 
	`usb_·ck‘_cİy
(
p
, 
buf
, 
»t
);

484 
ç
;

487 
USB_TOKEN_OUT
:

489 
ç
:

490 
»t
 = 
USB_RET_STALL
;

493  
»t
;

494 
	}
}

496 
	$usb_hid_hªdË_de¡roy
(
USBDeviû
 *
dev
)

498 
USBHIDS‹
 *
us
 = 
	`DO_UPCAST
(USBHIDS‹, 
dev
, dev);

500 
	`hid_ä“
(&
us
->
hid
);

501 
	}
}

503 
	$usb_hid_š™â
(
USBDeviû
 *
dev
, 
kšd
)

505 
USBHIDS‹
 *
us
 = 
	`DO_UPCAST
(USBHIDS‹, 
dev
, dev);

507 
	`usb_desc_š™
(
dev
);

508 
us
->
šŒ
 = 
	`usb_•_g‘
(
dev
, 
USB_TOKEN_IN
, 1);

509 
	`hid_š™
(&
us
->
hid
, 
kšd
, 
usb_hid_chªged
);

511 
	}
}

513 
	$usb_bËt_š™â
(
USBDeviû
 *
dev
)

515  
	`usb_hid_š™â
(
dev
, 
HID_TABLET
);

516 
	}
}

518 
	$usb_mou£_š™â
(
USBDeviû
 *
dev
)

520  
	`usb_hid_š™â
(
dev
, 
HID_MOUSE
);

521 
	}
}

523 
	$usb_keybßrd_š™â
(
USBDeviû
 *
dev
)

525  
	`usb_hid_š™â
(
dev
, 
HID_KEYBOARD
);

526 
	}
}

528 
	$usb_±r_po¡_lßd
(*
İaque
, 
v”siÚ_id
)

530 
USBHIDS‹
 *
s
 = 
İaque
;

532 ià(
s
->
dev
.
»mÙe_wakeup
) {

533 
	`hid_poš‹r_aùiv©e
(&
s
->
hid
);

536 
	}
}

538 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_±r
 = {

539 .
Çme
 = "usb-ptr",

540 .
	gv”siÚ_id
 = 1,

541 .
	gmšimum_v”siÚ_id
 = 1,

542 .
	gpo¡_lßd
 = 
usb_±r_po¡_lßd
,

543 .
	gf›lds
 = (
VMS‹F›ld
 []) {

544 
VMSTATE_USB_DEVICE
(
dev
, 
USBHIDS‹
),

545 
VMSTATE_HID_POINTER_DEVICE
(
hid
, 
USBHIDS‹
),

546 
VMSTATE_END_OF_LIST
()

550 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_kbd
 = {

551 .
Çme
 = "usb-kbd",

552 .
	gv”siÚ_id
 = 1,

553 .
	gmšimum_v”siÚ_id
 = 1,

554 .
	gf›lds
 = (
VMS‹F›ld
 []) {

555 
VMSTATE_USB_DEVICE
(
dev
, 
USBHIDS‹
),

556 
VMSTATE_HID_KEYBOARD_DEVICE
(
hid
, 
USBHIDS‹
),

557 
VMSTATE_END_OF_LIST
()

561 
	$usb_hid_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

563 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

565 
uc
->
hªdË_»£t
 = 
usb_hid_hªdË_»£t
;

566 
uc
->
hªdË_cÚŒŞ
 = 
usb_hid_hªdË_cÚŒŞ
;

567 
uc
->
hªdË_d©a
 = 
usb_hid_hªdË_d©a
;

568 
uc
->
hªdË_de¡roy
 = 
usb_hid_hªdË_de¡roy
;

569 
	}
}

571 
	$usb_bËt_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

573 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

574 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

576 
	`usb_hid_şass_š™â
(
kÏss
, 
d©a
);

577 
uc
->
š™
 = 
usb_bËt_š™â
;

578 
uc
->
´oduù_desc
 = "QEMU USB Tablet";

579 
uc
->
usb_desc
 = &
desc_bËt
;

580 
dc
->
vmsd
 = &
vm¡©e_usb_±r
;

581 
	}
}

583 
Ty³Info
 
	gusb_bËt_šfo
 = {

584 .
Çme
 = "usb-tablet",

585 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

586 .
	gš¡ªû_size
 = (
USBHIDS‹
),

587 .
	gşass_š™
 = 
usb_bËt_şass_š™â
,

590 
	$usb_mou£_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

592 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

593 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

595 
	`usb_hid_şass_š™â
(
kÏss
, 
d©a
);

596 
uc
->
š™
 = 
usb_mou£_š™â
;

597 
uc
->
´oduù_desc
 = "QEMU USB Mouse";

598 
uc
->
usb_desc
 = &
desc_mou£
;

599 
dc
->
vmsd
 = &
vm¡©e_usb_±r
;

600 
	}
}

602 
Ty³Info
 
	gusb_mou£_šfo
 = {

603 .
Çme
 = "usb-mouse",

604 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

605 .
	gš¡ªû_size
 = (
USBHIDS‹
),

606 .
	gşass_š™
 = 
usb_mou£_şass_š™â
,

609 
	$usb_keybßrd_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

611 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

612 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

614 
	`usb_hid_şass_š™â
(
kÏss
, 
d©a
);

615 
uc
->
š™
 = 
usb_keybßrd_š™â
;

616 
uc
->
´oduù_desc
 = "QEMU USB Keyboard";

617 
uc
->
usb_desc
 = &
desc_keybßrd
;

618 
dc
->
vmsd
 = &
vm¡©e_usb_kbd
;

619 
	}
}

621 
Ty³Info
 
	gusb_keybßrd_šfo
 = {

622 .
Çme
 = "usb-kbd",

623 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

624 .
	gš¡ªû_size
 = (
USBHIDS‹
),

625 .
	gşass_š™
 = 
usb_keybßrd_şass_š™â
,

628 
	$usb_hid_»gi¡”_ty³s
()

630 
	`ty³_»gi¡”_¡©ic
(&
usb_bËt_šfo
);

631 
	`usb_Ëgacy_»gi¡”
("usb-bËt", "bËt", 
NULL
);

632 
	`ty³_»gi¡”_¡©ic
(&
usb_mou£_šfo
);

633 
	`usb_Ëgacy_»gi¡”
("usb-mou£", "mou£", 
NULL
);

634 
	`ty³_»gi¡”_¡©ic
(&
usb_keybßrd_šfo
);

635 
	`usb_Ëgacy_»gi¡”
("usb-kbd", "keybßrd", 
NULL
);

636 
	}
}

638 
ty³_š™
(
usb_hid_»gi¡”_ty³s
)

	@dev-hub.c

24 
	~"qemu-commÚ.h
"

25 
	~"Œaû.h
"

26 
	~"hw/usb.h
"

27 
	~"hw/usb/desc.h
"

29 
	#NUM_PORTS
 8

	)

31 
	sUSBHubPÜt
 {

32 
USBPÜt
 
	mpÜt
;

33 
ušt16_t
 
	mwPÜtStus
;

34 
ušt16_t
 
	mwPÜtChªge
;

35 } 
	tUSBHubPÜt
;

37 
	sUSBHubS‹
 {

38 
USBDeviû
 
	mdev
;

39 
USBEndpošt
 *
	mšŒ
;

40 
USBHubPÜt
 
	mpÜts
[
NUM_PORTS
];

41 } 
	tUSBHubS‹
;

43 
	#CË¬HubF—tu»
 (0x2000 | 
USB_REQ_CLEAR_FEATURE
)

	)

44 
	#CË¬PÜtF—tu»
 (0x2300 | 
USB_REQ_CLEAR_FEATURE
)

	)

45 
	#G‘HubDesütÜ
 (0xa000 | 
USB_REQ_GET_DESCRIPTOR
)

	)

46 
	#G‘HubStus
 (0xa000 | 
USB_REQ_GET_STATUS
)

	)

47 
	#G‘PÜtStus
 (0xa300 | 
USB_REQ_GET_STATUS
)

	)

48 
	#S‘HubF—tu»
 (0x2000 | 
USB_REQ_SET_FEATURE
)

	)

49 
	#S‘PÜtF—tu»
 (0x2300 | 
USB_REQ_SET_FEATURE
)

	)

51 
	#PORT_STAT_CONNECTION
 0x0001

	)

52 
	#PORT_STAT_ENABLE
 0x0002

	)

53 
	#PORT_STAT_SUSPEND
 0x0004

	)

54 
	#PORT_STAT_OVERCURRENT
 0x0008

	)

55 
	#PORT_STAT_RESET
 0x0010

	)

56 
	#PORT_STAT_POWER
 0x0100

	)

57 
	#PORT_STAT_LOW_SPEED
 0x0200

	)

58 
	#PORT_STAT_HIGH_SPEED
 0x0400

	)

59 
	#PORT_STAT_TEST
 0x0800

	)

60 
	#PORT_STAT_INDICATOR
 0x1000

	)

62 
	#PORT_STAT_C_CONNECTION
 0x0001

	)

63 
	#PORT_STAT_C_ENABLE
 0x0002

	)

64 
	#PORT_STAT_C_SUSPEND
 0x0004

	)

65 
	#PORT_STAT_C_OVERCURRENT
 0x0008

	)

66 
	#PORT_STAT_C_RESET
 0x0010

	)

68 
	#PORT_CONNECTION
 0

	)

69 
	#PORT_ENABLE
 1

	)

70 
	#PORT_SUSPEND
 2

	)

71 
	#PORT_OVERCURRENT
 3

	)

72 
	#PORT_RESET
 4

	)

73 
	#PORT_POWER
 8

	)

74 
	#PORT_LOWSPEED
 9

	)

75 
	#PORT_HIGHSPEED
 10

	)

76 
	#PORT_C_CONNECTION
 16

	)

77 
	#PORT_C_ENABLE
 17

	)

78 
	#PORT_C_SUSPEND
 18

	)

79 
	#PORT_C_OVERCURRENT
 19

	)

80 
	#PORT_C_RESET
 20

	)

81 
	#PORT_TEST
 21

	)

82 
	#PORT_INDICATOR
 22

	)

87 
	mSTR_MANUFACTURER
 = 1,

88 
	mSTR_PRODUCT
,

89 
	mSTR_SERIALNUMBER
,

92 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

93 [
STR_MANUFACTURER
] = "QEMU",

94 [
STR_PRODUCT
] = "QEMU USB Hub",

95 [
STR_SERIALNUMBER
] = "314159",

98 cÚ¡ 
USBDescIçû
 
	gdesc_içû_hub
 = {

99 .
bIÁ”çûNumb”
 = 0,

100 .
	gbNumEndpošts
 = 1,

101 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_HUB
,

102 .
	g•s
 = (
USBDescEndpošt
[]) {

104 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

105 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

106 .
	gwMaxPack‘Size
 = 1 + (
NUM_PORTS
 + 7) / 8,

107 .
	gbIÁ”v®
 = 0xff,

112 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_hub
 = {

113 .
bcdUSB
 = 0x0110,

114 .
	gbDeviûCÏss
 = 
USB_CLASS_HUB
,

115 .
	gbMaxPack‘Size0
 = 8,

116 .
	gbNumCÚfigu¿tiÚs
 = 1,

117 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

119 .
bNumIÁ”çûs
 = 1,

120 .
	gbCÚfigu¿tiÚV®ue
 = 1,

121 .
	gbmA‰ribu‹s
 = 0xe0,

122 .
	gnif
 = 1,

123 .
	gifs
 = &
desc_içû_hub
,

128 cÚ¡ 
USBDesc
 
	gdesc_hub
 = {

129 .
id
 = {

130 .
idV’dÜ
 = 0x0409,

131 .
	gidProduù
 = 0x55aa,

132 .
	gbcdDeviû
 = 0x0101,

133 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

134 .
	giProduù
 = 
STR_PRODUCT
,

135 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

137 .
	gfuÎ
 = &
desc_deviû_hub
,

138 .
	g¡r
 = 
desc_¡ršgs
,

141 cÚ¡ 
ušt8_t
 
	gqemu_hub_hub_desütÜ
[] =

154 
	$usb_hub_©ch
(
USBPÜt
 *
pÜt1
)

156 
USBHubS‹
 *
s
 = 
pÜt1
->
İaque
;

157 
USBHubPÜt
 *
pÜt
 = &
s
->
pÜts
[
pÜt1
->
šdex
];

159 
	`Œaû_usb_hub_©ch
(
s
->
dev
.
addr
, 
pÜt1
->
šdex
 + 1);

160 
pÜt
->
wPÜtStus
 |ğ
PORT_STAT_CONNECTION
;

161 
pÜt
->
wPÜtChªge
 |ğ
PORT_STAT_C_CONNECTION
;

162 ià(
pÜt
->pÜt.
dev
->
¥“d
 =ğ
USB_SPEED_LOW
) {

163 
pÜt
->
wPÜtStus
 |ğ
PORT_STAT_LOW_SPEED
;

165 
pÜt
->
wPÜtStus
 &ğ~
PORT_STAT_LOW_SPEED
;

167 
	`usb_wakeup
(
s
->
šŒ
);

168 
	}
}

170 
	$usb_hub_d‘ach
(
USBPÜt
 *
pÜt1
)

172 
USBHubS‹
 *
s
 = 
pÜt1
->
İaque
;

173 
USBHubPÜt
 *
pÜt
 = &
s
->
pÜts
[
pÜt1
->
šdex
];

175 
	`Œaû_usb_hub_d‘ach
(
s
->
dev
.
addr
, 
pÜt1
->
šdex
 + 1);

176 
	`usb_wakeup
(
s
->
šŒ
);

179 
s
->
dev
.
pÜt
->
İs
->
	`chd_d‘ach
(s->dev.pÜt, 
pÜt1
->dev);

181 
pÜt
->
wPÜtStus
 &ğ~
PORT_STAT_CONNECTION
;

182 
pÜt
->
wPÜtChªge
 |ğ
PORT_STAT_C_CONNECTION
;

183 ià(
pÜt
->
wPÜtStus
 & 
PORT_STAT_ENABLE
) {

184 
pÜt
->
wPÜtStus
 &ğ~
PORT_STAT_ENABLE
;

185 
pÜt
->
wPÜtChªge
 |ğ
PORT_STAT_C_ENABLE
;

187 
	}
}

189 
	$usb_hub_chd_d‘ach
(
USBPÜt
 *
pÜt1
, 
USBDeviû
 *
chd
)

191 
USBHubS‹
 *
s
 = 
pÜt1
->
İaque
;

194 
s
->
dev
.
pÜt
->
İs
->
	`chd_d‘ach
(s->dev.pÜt, 
chd
);

195 
	}
}

197 
	$usb_hub_wakeup
(
USBPÜt
 *
pÜt1
)

199 
USBHubS‹
 *
s
 = 
pÜt1
->
İaque
;

200 
USBHubPÜt
 *
pÜt
 = &
s
->
pÜts
[
pÜt1
->
šdex
];

202 ià(
pÜt
->
wPÜtStus
 & 
PORT_STAT_SUSPEND
) {

203 
pÜt
->
wPÜtChªge
 |ğ
PORT_STAT_C_SUSPEND
;

204 
	`usb_wakeup
(
s
->
šŒ
);

206 
	}
}

208 
	$usb_hub_com¶‘e
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
·ck‘
)

210 
USBHubS‹
 *
s
 = 
pÜt
->
İaque
;

222 
s
->
dev
.
pÜt
->
İs
->
	`com¶‘e
(s->dev.pÜt, 
·ck‘
);

223 
	}
}

225 
USBDeviû
 *
	$usb_hub_fšd_deviû
(
USBDeviû
 *
dev
, 
ušt8_t
 
addr
)

227 
USBHubS‹
 *
s
 = 
	`DO_UPCAST
(USBHubS‹, 
dev
, dev);

228 
USBHubPÜt
 *
pÜt
;

229 
USBDeviû
 *
down¡»am
;

230 
i
;

232 
i
 = 0; i < 
NUM_PORTS
; i++) {

233 
pÜt
 = &
s
->
pÜts
[
i
];

234 ià(!(
pÜt
->
wPÜtStus
 & 
PORT_STAT_ENABLE
)) {

237 
down¡»am
 = 
	`usb_fšd_deviû
(&
pÜt
->pÜt, 
addr
);

238 ià(
down¡»am
 !ğ
NULL
) {

239  
down¡»am
;

242  
NULL
;

243 
	}
}

245 
	$usb_hub_hªdË_»£t
(
USBDeviû
 *
dev
)

247 
USBHubS‹
 *
s
 = 
	`DO_UPCAST
(USBHubS‹, 
dev
, dev);

248 
USBHubPÜt
 *
pÜt
;

249 
i
;

251 
	`Œaû_usb_hub_»£t
(
s
->
dev
.
addr
);

252 
i
 = 0; i < 
NUM_PORTS
; i++) {

253 
pÜt
 = 
s
->
pÜts
 + 
i
;

254 
pÜt
->
wPÜtStus
 = 
PORT_STAT_POWER
;

255 
pÜt
->
wPÜtChªge
 = 0;

256 ià(
pÜt
->pÜt.
dev
 &&…Üt->pÜt.dev->
©ched
) {

257 
pÜt
->
wPÜtStus
 |ğ
PORT_STAT_CONNECTION
;

258 
pÜt
->
wPÜtChªge
 |ğ
PORT_STAT_C_CONNECTION
;

259 ià(
pÜt
->pÜt.
dev
->
¥“d
 =ğ
USB_SPEED_LOW
) {

260 
pÜt
->
wPÜtStus
 |ğ
PORT_STAT_LOW_SPEED
;

264 
	}
}

266 cÚ¡ *
	$ã©u»_Çme
(
ã©u»
)

268 cÚ¡ *
Çme
[] = {

269 [
PORT_CONNECTION
] = "connection",

270 [
PORT_ENABLE
] = "enable",

271 [
PORT_SUSPEND
] = "suspend",

272 [
PORT_OVERCURRENT
] = "overcurrent",

273 [
PORT_RESET
] = "reset",

274 [
PORT_POWER
] = "power",

275 [
PORT_LOWSPEED
] = "lowspeed",

276 [
PORT_HIGHSPEED
] = "highspeed",

277 [
PORT_C_CONNECTION
] = "change connection",

278 [
PORT_C_ENABLE
] = "changeƒnable",

279 [
PORT_C_SUSPEND
] = "change suspend",

280 [
PORT_C_OVERCURRENT
] = "change overcurrent",

281 [
PORT_C_RESET
] = "change„eset",

282 [
PORT_TEST
] = "test",

283 [
PORT_INDICATOR
] = "indicator",

285 ià(
ã©u»
 < 0 || f—tu» >ğ
	`ARRAY_SIZE
(
Çme
)) {

288  
Çme
[
ã©u»
] ?: "?";

289 
	}
}

291 
	$usb_hub_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

292 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

294 
USBHubS‹
 *
s
 = (USBHubS‹ *)
dev
;

295 
»t
;

297 
	`Œaû_usb_hub_cÚŒŞ
(
s
->
dev
.
addr
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
);

299 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

300 ià(
»t
 >= 0) {

301  
»t
;

304 
»que¡
) {

305 
EndpoštOutReque¡
 | 
USB_REQ_CLEAR_FEATURE
:

306 ià(
v®ue
 =ğ0 && 
šdex
 != 0x81) {

307 
ç
;

309 
»t
 = 0;

312 
G‘HubStus
:

313 
d©a
[0] = 0;

314 
d©a
[1] = 0;

315 
d©a
[2] = 0;

316 
d©a
[3] = 0;

317 
»t
 = 4;

319 
G‘PÜtStus
:

321 
n
 = 
šdex
 - 1;

322 
USBHubPÜt
 *
pÜt
;

323 ià(
n
 >ğ
NUM_PORTS
) {

324 
ç
;

326 
pÜt
 = &
s
->
pÜts
[
n
];

327 
	`Œaû_usb_hub_g‘_pÜt_¡©us
(
s
->
dev
.
addr
, 
šdex
,

328 
pÜt
->
wPÜtStus
,

329 
pÜt
->
wPÜtChªge
);

330 
d©a
[0] = 
pÜt
->
wPÜtStus
;

331 
d©a
[1] = 
pÜt
->
wPÜtStus
 >> 8;

332 
d©a
[2] = 
pÜt
->
wPÜtChªge
;

333 
d©a
[3] = 
pÜt
->
wPÜtChªge
 >> 8;

334 
»t
 = 4;

337 
S‘HubF—tu»
:

338 
CË¬HubF—tu»
:

339 ià(
v®ue
 == 0 || value == 1) {

341 
ç
;

343 
»t
 = 0;

345 
S‘PÜtF—tu»
:

347 
n
 = 
šdex
 - 1;

348 
USBHubPÜt
 *
pÜt
;

349 
USBDeviû
 *
dev
;

351 
	`Œaû_usb_hub_£t_pÜt_ã©u»
(
s
->
dev
.
addr
, 
šdex
,

352 
	`ã©u»_Çme
(
v®ue
));

354 ià(
n
 >ğ
NUM_PORTS
) {

355 
ç
;

357 
pÜt
 = &
s
->
pÜts
[
n
];

358 
dev
 = 
pÜt
->port.dev;

359 
v®ue
) {

360 
PORT_SUSPEND
:

361 
pÜt
->
wPÜtStus
 |ğ
PORT_STAT_SUSPEND
;

363 
PORT_RESET
:

364 ià(
dev
 && dev->
©ched
) {

365 
	`usb_deviû_»£t
(
dev
);

366 
pÜt
->
wPÜtChªge
 |ğ
PORT_STAT_C_RESET
;

368 
pÜt
->
wPÜtStus
 |ğ
PORT_STAT_ENABLE
;

371 
PORT_POWER
:

374 
ç
;

376 
»t
 = 0;

379 
CË¬PÜtF—tu»
:

381 
n
 = 
šdex
 - 1;

382 
USBHubPÜt
 *
pÜt
;

384 
	`Œaû_usb_hub_ş—r_pÜt_ã©u»
(
s
->
dev
.
addr
, 
šdex
,

385 
	`ã©u»_Çme
(
v®ue
));

387 ià(
n
 >ğ
NUM_PORTS
) {

388 
ç
;

390 
pÜt
 = &
s
->
pÜts
[
n
];

391 
v®ue
) {

392 
PORT_ENABLE
:

393 
pÜt
->
wPÜtStus
 &ğ~
PORT_STAT_ENABLE
;

395 
PORT_C_ENABLE
:

396 
pÜt
->
wPÜtChªge
 &ğ~
PORT_STAT_C_ENABLE
;

398 
PORT_SUSPEND
:

399 
pÜt
->
wPÜtStus
 &ğ~
PORT_STAT_SUSPEND
;

401 
PORT_C_SUSPEND
:

402 
pÜt
->
wPÜtChªge
 &ğ~
PORT_STAT_C_SUSPEND
;

404 
PORT_C_CONNECTION
:

405 
pÜt
->
wPÜtChªge
 &ğ~
PORT_STAT_C_CONNECTION
;

407 
PORT_C_OVERCURRENT
:

408 
pÜt
->
wPÜtChªge
 &ğ~
PORT_STAT_C_OVERCURRENT
;

410 
PORT_C_RESET
:

411 
pÜt
->
wPÜtChªge
 &ğ~
PORT_STAT_C_RESET
;

414 
ç
;

416 
»t
 = 0;

419 
G‘HubDesütÜ
:

421 
n
, 
lim™
, 
v¬_hub_size
 = 0;

422 
	`memıy
(
d©a
, 
qemu_hub_hub_desütÜ
,

423 (
qemu_hub_hub_desütÜ
));

424 
d©a
[2] = 
NUM_PORTS
;

427 
lim™
 = ((
NUM_PORTS
 + 1 + 7) / 8) + 7;

428 
n
 = 7;‚ < 
lim™
;‚++) {

429 
d©a
[
n
] = 0x00;

430 
v¬_hub_size
++;

434 
lim™
 =†im™ + ((
NUM_PORTS
 + 7) / 8);

435 ;
n
 < 
lim™
;‚++) {

436 
d©a
[
n
] = 0xff;

437 
v¬_hub_size
++;

440 
»t
 = (
qemu_hub_hub_desütÜ
è+ 
v¬_hub_size
;

441 
d©a
[0] = 
»t
;

445 
ç
:

446 
»t
 = 
USB_RET_STALL
;

449  
»t
;

450 
	}
}

452 
	$usb_hub_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

454 
USBHubS‹
 *
s
 = (USBHubS‹ *)
dev
;

455 
»t
;

457 
p
->
pid
) {

458 
USB_TOKEN_IN
:

459 ià(
p
->
•
->
Ä
 == 1) {

460 
USBHubPÜt
 *
pÜt
;

461 
¡©us
;

462 
ušt8_t
 
buf
[4];

463 
i
, 
n
;

464 
n
 = (
NUM_PORTS
 + 1 + 7) / 8;

465 ià(
p
->
iov
.
size
 == 1) {

466 
n
 = 1;

467 } ià(
n
 > 
p
->
iov
.
size
) {

468  
USB_RET_BABBLE
;

470 
¡©us
 = 0;

471 
i
 = 0; i < 
NUM_PORTS
; i++) {

472 
pÜt
 = &
s
->
pÜts
[
i
];

473 ià(
pÜt
->
wPÜtChªge
)

474 
¡©us
 |ğ(1 << (
i
 + 1));

476 ià(
¡©us
 != 0) {

477 
i
 = 0; i < 
n
; i++) {

478 
buf
[
i
] = 
¡©us
 >> (8 * i);

480 
	`usb_·ck‘_cİy
(
p
, 
buf
, 
n
);

481 
»t
 = 
n
;

483 
»t
 = 
USB_RET_NAK
;

486 
ç
;

489 
USB_TOKEN_OUT
:

491 
ç
:

492 
»t
 = 
USB_RET_STALL
;

495  
»t
;

496 
	}
}

498 
	$usb_hub_hªdË_de¡roy
(
USBDeviû
 *
dev
)

500 
USBHubS‹
 *
s
 = (USBHubS‹ *)
dev
;

501 
i
;

503 
i
 = 0; i < 
NUM_PORTS
; i++) {

504 
	`usb_uÄegi¡”_pÜt
(
	`usb_bus_äom_deviû
(
dev
),

505 &
s
->
pÜts
[
i
].
pÜt
);

507 
	}
}

509 
USBPÜtOps
 
	gusb_hub_pÜt_İs
 = {

510 .
©ch
 = 
usb_hub_©ch
,

511 .
	gd‘ach
 = 
usb_hub_d‘ach
,

512 .
	gchd_d‘ach
 = 
usb_hub_chd_d‘ach
,

513 .
	gwakeup
 = 
usb_hub_wakeup
,

514 .
	gcom¶‘e
 = 
usb_hub_com¶‘e
,

517 
	$usb_hub_š™â
(
USBDeviû
 *
dev
)

519 
USBHubS‹
 *
s
 = 
	`DO_UPCAST
(USBHubS‹, 
dev
, dev);

520 
USBHubPÜt
 *
pÜt
;

521 
i
;

523 
	`usb_desc_ü—‹_£rŸl
(
dev
);

524 
	`usb_desc_š™
(
dev
);

525 
s
->
šŒ
 = 
	`usb_•_g‘
(
dev
, 
USB_TOKEN_IN
, 1);

526 
i
 = 0; i < 
NUM_PORTS
; i++) {

527 
pÜt
 = &
s
->
pÜts
[
i
];

528 
	`usb_»gi¡”_pÜt
(
	`usb_bus_äom_deviû
(
dev
),

529 &
pÜt
->pÜt, 
s
, 
i
, &
usb_hub_pÜt_İs
,

530 
USB_SPEED_MASK_LOW
 | 
USB_SPEED_MASK_FULL
);

531 
	`usb_pÜt_loÿtiÚ
(&
pÜt
->pÜt, 
dev
->pÜt, 
i
+1);

533 
	`usb_hub_hªdË_»£t
(
dev
);

535 
	}
}

537 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_hub_pÜt
 = {

538 .
Çme
 = "usb-hub-port",

539 .
	gv”siÚ_id
 = 1,

540 .
	gmšimum_v”siÚ_id
 = 1,

541 .
	gf›lds
 = (
VMS‹F›ld
 []) {

542 
VMSTATE_UINT16
(
wPÜtStus
, 
USBHubPÜt
),

543 
VMSTATE_UINT16
(
wPÜtChªge
, 
USBHubPÜt
),

544 
VMSTATE_END_OF_LIST
()

548 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_hub
 = {

549 .
Çme
 = "usb-hub",

550 .
	gv”siÚ_id
 = 1,

551 .
	gmšimum_v”siÚ_id
 = 1,

552 .
	gf›lds
 = (
VMS‹F›ld
 []) {

553 
VMSTATE_USB_DEVICE
(
dev
, 
USBHubS‹
),

554 
VMSTATE_STRUCT_ARRAY
(
pÜts
, 
USBHubS‹
, 
NUM_PORTS
, 0,

555 
vm¡©e_usb_hub_pÜt
, 
USBHubPÜt
),

556 
VMSTATE_END_OF_LIST
()

560 
	$usb_hub_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

562 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

563 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

565 
uc
->
š™
 = 
usb_hub_š™â
;

566 
uc
->
´oduù_desc
 = "QEMU USB Hub";

567 
uc
->
usb_desc
 = &
desc_hub
;

568 
uc
->
fšd_deviû
 = 
usb_hub_fšd_deviû
;

569 
uc
->
hªdË_»£t
 = 
usb_hub_hªdË_»£t
;

570 
uc
->
hªdË_cÚŒŞ
 = 
usb_hub_hªdË_cÚŒŞ
;

571 
uc
->
hªdË_d©a
 = 
usb_hub_hªdË_d©a
;

572 
uc
->
hªdË_de¡roy
 = 
usb_hub_hªdË_de¡roy
;

573 
dc
->
fw_Çme
 = "hub";

574 
dc
->
vmsd
 = &
vm¡©e_usb_hub
;

575 
	}
}

577 
Ty³Info
 
	ghub_šfo
 = {

578 .
Çme
 = "usb-hub",

579 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

580 .
	gš¡ªû_size
 = (
USBHubS‹
),

581 .
	gşass_š™
 = 
usb_hub_şass_š™â
,

584 
	$usb_hub_»gi¡”_ty³s
()

586 
	`ty³_»gi¡”_¡©ic
(&
hub_šfo
);

587 
	}
}

589 
ty³_š™
(
usb_hub_»gi¡”_ty³s
)

	@dev-network.c

26 
	~"qemu-commÚ.h
"

27 
	~"hw/usb.h
"

28 
	~"hw/usb/desc.h
"

29 
	~"Ãt.h
"

30 
	~"qemu-queue.h
"

31 
	~"sy£mu.h
"

32 
	~"iov.h
"

38 
	#CDC_VENDOR_NUM
 0x0525

	)

39 
	#CDC_PRODUCT_NUM
 0xa4a1

	)

43 
	#RNDIS_VENDOR_NUM
 0x0525

	)

44 
	#RNDIS_PRODUCT_NUM
 0xa4a2

	)

46 
	eusb¡ršg_idx
 {

47 
	mSTRING_MANUFACTURER
 = 1,

48 
	mSTRING_PRODUCT
,

49 
	mSTRING_ETHADDR
,

50 
	mSTRING_DATA
,

51 
	mSTRING_CONTROL
,

52 
	mSTRING_RNDIS_CONTROL
,

53 
	mSTRING_CDC
,

54 
	mSTRING_SUBSET
,

55 
	mSTRING_RNDIS
,

56 
	mSTRING_SERIALNUMBER
,

59 
	#DEV_CONFIG_VALUE
 1

	)

60 
	#DEV_RNDIS_CONFIG_VALUE
 2

	)

62 
	#USB_CDC_SUBCLASS_ACM
 0x02

	)

63 
	#USB_CDC_SUBCLASS_ETHERNET
 0x06

	)

65 
	#USB_CDC_PROTO_NONE
 0

	)

66 
	#USB_CDC_ACM_PROTO_VENDOR
 0xff

	)

68 
	#USB_CDC_HEADER_TYPE
 0x00

	)

69 
	#USB_CDC_CALL_MANAGEMENT_TYPE
 0x01

	)

70 
	#USB_CDC_ACM_TYPE
 0x02

	)

71 
	#USB_CDC_UNION_TYPE
 0x06

	)

72 
	#USB_CDC_ETHERNET_TYPE
 0x0à

	)

74 
	#USB_CDC_SEND_ENCAPSULATED_COMMAND
 0x00

	)

75 
	#USB_CDC_GET_ENCAPSULATED_RESPONSE
 0x01

	)

76 
	#USB_CDC_REQ_SET_LINE_CODING
 0x20

	)

77 
	#USB_CDC_REQ_GET_LINE_CODING
 0x21

	)

78 
	#USB_CDC_REQ_SET_CONTROL_LINE_STATE
 0x22

	)

79 
	#USB_CDC_REQ_SEND_BREAK
 0x23

	)

80 
	#USB_CDC_SET_ETHERNET_MULTICAST_FILTERS
 0x40

	)

81 
	#USB_CDC_SET_ETHERNET_PM_PATTERN_FILTER
 0x41

	)

82 
	#USB_CDC_GET_ETHERNET_PM_PATTERN_FILTER
 0x42

	)

83 
	#USB_CDC_SET_ETHERNET_PACKET_FILTER
 0x43

	)

84 
	#USB_CDC_GET_ETHERNET_STATISTIC
 0x44

	)

86 
	#LOG2_STATUS_INTERVAL_MSEC
 5

	)

87 
	#STATUS_BYTECOUNT
 16

	)

89 
	#ETH_FRAME_LEN
 1514

	)

91 cÚ¡ 
USBDescSŒšgs
 
	gusb_Ãt_¡ršgbË
 = {

92 [
STRING_MANUFACTURER
] = "QEMU",

93 [
STRING_PRODUCT
] = "RNDIS/QEMU USB Network Device",

94 [
STRING_ETHADDR
] = "400102030405",

95 [
STRING_DATA
] = "QEMU USB Net Data Interface",

96 [
STRING_CONTROL
] = "QEMU USB Net Control Interface",

97 [
STRING_RNDIS_CONTROL
] = "QEMU USB Net RNDIS Control Interface",

98 [
STRING_CDC
] = "QEMU USB Net CDC",

99 [
STRING_SUBSET
] = "QEMU USB Net Subset",

100 [
STRING_RNDIS
] = "QEMU USB Net RNDIS",

101 [
STRING_SERIALNUMBER
] = "1",

104 cÚ¡ 
USBDescIçû
 
	gdesc_içû_ºdis
[] = {

107 .
bIÁ”çûNumb”
 = 0,

108 .
	gbNumEndpošts
 = 1,

109 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_COMM
,

110 .
	gbIÁ”çûSubCÏss
 = 
USB_CDC_SUBCLASS_ACM
,

111 .
	gbIÁ”çûPrÙocŞ
 = 
USB_CDC_ACM_PROTO_VENDOR
,

112 .
	giIÁ”çû
 = 
STRING_RNDIS_CONTROL
,

113 .
	gndesc
 = 4,

114 .
	gdescs
 = (
USBDescOth”
[]) {

117 .
d©a
 = (
ušt8_t
[]) {

119 
USB_DT_CS_INTERFACE
,

120 
USB_CDC_HEADER_TYPE
,

125 .
	gd©a
 = (
ušt8_t
[]) {

127 
USB_DT_CS_INTERFACE
,

128 
USB_CDC_CALL_MANAGEMENT_TYPE
,

134 .
	gd©a
 = (
ušt8_t
[]) {

136 
USB_DT_CS_INTERFACE
,

137 
USB_CDC_ACM_TYPE
,

142 .
	gd©a
 = (
ušt8_t
[]) {

144 
USB_DT_CS_INTERFACE
,

145 
USB_CDC_UNION_TYPE
,

151 .
	g•s
 = (
USBDescEndpošt
[]) {

153 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

154 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

155 .
	gwMaxPack‘Size
 = 
STATUS_BYTECOUNT
,

156 .
	gbIÁ”v®
 = 1 << 
LOG2_STATUS_INTERVAL_MSEC
,

161 .
	gbIÁ”çûNumb”
 = 1,

162 .
	gbNumEndpošts
 = 2,

163 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_CDC_DATA
,

164 .
	giIÁ”çû
 = 
STRING_DATA
,

165 .
	g•s
 = (
USBDescEndpošt
[]) {

167 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x02,

168 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

169 .
	gwMaxPack‘Size
 = 0x40,

171 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 0x02,

172 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

173 .
	gwMaxPack‘Size
 = 0x40,

179 cÚ¡ 
USBDescIçû
 
	gdesc_içû_cdc
[] = {

182 .
bIÁ”çûNumb”
 = 0,

183 .
	gbNumEndpošts
 = 1,

184 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_COMM
,

185 .
	gbIÁ”çûSubCÏss
 = 
USB_CDC_SUBCLASS_ETHERNET
,

186 .
	gbIÁ”çûPrÙocŞ
 = 
USB_CDC_PROTO_NONE
,

187 .
	giIÁ”çû
 = 
STRING_CONTROL
,

188 .
	gndesc
 = 3,

189 .
	gdescs
 = (
USBDescOth”
[]) {

192 .
d©a
 = (
ušt8_t
[]) {

194 
USB_DT_CS_INTERFACE
,

195 
USB_CDC_HEADER_TYPE
,

200 .
	gd©a
 = (
ušt8_t
[]) {

202 
USB_DT_CS_INTERFACE
,

203 
USB_CDC_UNION_TYPE
,

209 .
	gd©a
 = (
ušt8_t
[]) {

211 
USB_DT_CS_INTERFACE
,

212 
USB_CDC_ETHERNET_TYPE
,

213 
STRING_ETHADDR
,

215 
ETH_FRAME_LEN
 & 0xff,

216 
ETH_FRAME_LEN
 >> 8,

222 .
	g•s
 = (
USBDescEndpošt
[]) {

224 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

225 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

226 .
	gwMaxPack‘Size
 = 
STATUS_BYTECOUNT
,

227 .
	gbIÁ”v®
 = 1 << 
LOG2_STATUS_INTERVAL_MSEC
,

232 .
	gbIÁ”çûNumb”
 = 1,

233 .
	gbAÉ”Ç‹S‘tšg
 = 0,

234 .
	gbNumEndpošts
 = 0,

235 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_CDC_DATA
,

238 .
	gbIÁ”çûNumb”
 = 1,

239 .
	gbAÉ”Ç‹S‘tšg
 = 1,

240 .
	gbNumEndpošts
 = 2,

241 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_CDC_DATA
,

242 .
	giIÁ”çû
 = 
STRING_DATA
,

243 .
	g•s
 = (
USBDescEndpošt
[]) {

245 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x02,

246 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

247 .
	gwMaxPack‘Size
 = 0x40,

249 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 0x02,

250 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

251 .
	gwMaxPack‘Size
 = 0x40,

257 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_Ãt
 = {

258 .
bcdUSB
 = 0x0200,

259 .
	gbDeviûCÏss
 = 
USB_CLASS_COMM
,

260 .
	gbMaxPack‘Size0
 = 0x40,

261 .
	gbNumCÚfigu¿tiÚs
 = 2,

262 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

264 .
bNumIÁ”çûs
 = 2,

265 .
	gbCÚfigu¿tiÚV®ue
 = 
DEV_RNDIS_CONFIG_VALUE
,

266 .
	giCÚfigu¿tiÚ
 = 
STRING_RNDIS
,

267 .
	gbmA‰ribu‹s
 = 0xc0,

268 .
	gbMaxPow”
 = 0x32,

269 .
	gnif
 = 
ARRAY_SIZE
(
desc_içû_ºdis
),

270 .
	gifs
 = 
desc_içû_ºdis
,

272 .
	gbNumIÁ”çûs
 = 2,

273 .
	gbCÚfigu¿tiÚV®ue
 = 
DEV_CONFIG_VALUE
,

274 .
	giCÚfigu¿tiÚ
 = 
STRING_CDC
,

275 .
	gbmA‰ribu‹s
 = 0xc0,

276 .
	gbMaxPow”
 = 0x32,

277 .
	gnif
 = 
ARRAY_SIZE
(
desc_içû_cdc
),

278 .
	gifs
 = 
desc_içû_cdc
,

283 cÚ¡ 
USBDesc
 
	gdesc_Ãt
 = {

284 .
id
 = {

285 .
idV’dÜ
 = 
RNDIS_VENDOR_NUM
,

286 .
	gidProduù
 = 
RNDIS_PRODUCT_NUM
,

287 .
	gbcdDeviû
 = 0,

288 .
	giMªuçùu»r
 = 
STRING_MANUFACTURER
,

289 .
	giProduù
 = 
STRING_PRODUCT
,

290 .
	giS”ŸlNumb”
 = 
STRING_SERIALNUMBER
,

292 .
	gfuÎ
 = &
desc_deviû_Ãt
,

293 .
	g¡r
 = 
usb_Ãt_¡ršgbË
,

299 
	#RNDIS_MAXIMUM_FRAME_SIZE
 1518

	)

300 
	#RNDIS_MAX_TOTAL_SIZE
 1558

	)

303 
	#RNDIS_MAJOR_VERSION
 1

	)

304 
	#RNDIS_MINOR_VERSION
 0

	)

307 
	#RNDIS_STATUS_SUCCESS
 0x00000000U

	)

308 
	#RNDIS_STATUS_FAILURE
 0xc0000001U

	)

309 
	#RNDIS_STATUS_INVALID_DATA
 0xc0010015U

	)

310 
	#RNDIS_STATUS_NOT_SUPPORTED
 0xc00000bbU

	)

311 
	#RNDIS_STATUS_MEDIA_CONNECT
 0x4001000bU

	)

312 
	#RNDIS_STATUS_MEDIA_DISCONNECT
 0x4001000cU

	)

316 
	mRNDIS_PACKET_MSG
 = 1,

317 
	mRNDIS_INITIALIZE_MSG
 = 2,

318 
	mRNDIS_HALT_MSG
 = 3,

319 
	mRNDIS_QUERY_MSG
 = 4,

320 
	mRNDIS_SET_MSG
 = 5,

321 
	mRNDIS_RESET_MSG
 = 6,

322 
	mRNDIS_INDICATE_STATUS_MSG
 = 7,

323 
	mRNDIS_KEEPALIVE_MSG
 = 8,

328 
	mRNDIS_INITIALIZE_CMPLT
 = 0x80000002U,

329 
	mRNDIS_QUERY_CMPLT
 = 0x80000004U,

330 
	mRNDIS_SET_CMPLT
 = 0x80000005U,

331 
	mRNDIS_RESET_CMPLT
 = 0x80000006U,

332 
	mRNDIS_KEEPALIVE_CMPLT
 = 0x80000008U,

337 
	mRNDIS_DF_CONNECTIONLESS
 = 1,

338 
	mRNDIS_DF_CONNECTIONORIENTED
 = 2,

341 
	#RNDIS_MEDIUM_802_3
 0x00000000U

	)

344 
	#OID_PNP_CAPABILITIES
 0xfd010100

	)

345 
	#OID_PNP_SET_POWER
 0xfd010101

	)

346 
	#OID_PNP_QUERY_POWER
 0xfd010102

	)

347 
	#OID_PNP_ADD_WAKE_UP_PATTERN
 0xfd010103

	)

348 
	#OID_PNP_REMOVE_WAKE_UP_PATTERN
 0xfd010104

	)

349 
	#OID_PNP_ENABLE_WAKE_UP
 0xfd010106

	)

351 
ušt32_t
 
	tË32
;

353 
	sºdis_š™_msg_ty³
 {

354 
Ë32
 
	mMes§geTy³
;

355 
Ë32
 
	mMes§geL’gth
;

356 
Ë32
 
	mReque¡ID
;

357 
Ë32
 
	mMajÜV”siÚ
;

358 
Ë32
 
	mMšÜV”siÚ
;

359 
Ë32
 
	mMaxT¿nsãrSize
;

360 } 
	tºdis_š™_msg_ty³
;

362 
	sºdis_š™_cm¶t_ty³
 {

363 
Ë32
 
	mMes§geTy³
;

364 
Ë32
 
	mMes§geL’gth
;

365 
Ë32
 
	mReque¡ID
;

366 
Ë32
 
	mStus
;

367 
Ë32
 
	mMajÜV”siÚ
;

368 
Ë32
 
	mMšÜV”siÚ
;

369 
Ë32
 
	mDeviûFÏgs
;

370 
Ë32
 
	mMedium
;

371 
Ë32
 
	mMaxPack‘sP”T¿nsãr
;

372 
Ë32
 
	mMaxT¿nsãrSize
;

373 
Ë32
 
	mPack‘Alignm’tFaùÜ
;

374 
Ë32
 
	mAFLi¡Off£t
;

375 
Ë32
 
	mAFLi¡Size
;

376 } 
	tºdis_š™_cm¶t_ty³
;

378 
	sºdis_h®t_msg_ty³
 {

379 
Ë32
 
	mMes§geTy³
;

380 
Ë32
 
	mMes§geL’gth
;

381 
Ë32
 
	mReque¡ID
;

382 } 
	tºdis_h®t_msg_ty³
;

384 
	sºdis_qu”y_msg_ty³
 {

385 
Ë32
 
	mMes§geTy³
;

386 
Ë32
 
	mMes§geL’gth
;

387 
Ë32
 
	mReque¡ID
;

388 
Ë32
 
	mOID
;

389 
Ë32
 
	mInfÜm©iÚBufãrL’gth
;

390 
Ë32
 
	mInfÜm©iÚBufãrOff£t
;

391 
Ë32
 
	mDeviûVcHªdË
;

392 } 
	tºdis_qu”y_msg_ty³
;

394 
	sºdis_qu”y_cm¶t_ty³
 {

395 
Ë32
 
	mMes§geTy³
;

396 
Ë32
 
	mMes§geL’gth
;

397 
Ë32
 
	mReque¡ID
;

398 
Ë32
 
	mStus
;

399 
Ë32
 
	mInfÜm©iÚBufãrL’gth
;

400 
Ë32
 
	mInfÜm©iÚBufãrOff£t
;

401 } 
	tºdis_qu”y_cm¶t_ty³
;

403 
	sºdis_£t_msg_ty³
 {

404 
Ë32
 
	mMes§geTy³
;

405 
Ë32
 
	mMes§geL’gth
;

406 
Ë32
 
	mReque¡ID
;

407 
Ë32
 
	mOID
;

408 
Ë32
 
	mInfÜm©iÚBufãrL’gth
;

409 
Ë32
 
	mInfÜm©iÚBufãrOff£t
;

410 
Ë32
 
	mDeviûVcHªdË
;

411 } 
	tºdis_£t_msg_ty³
;

413 
	sºdis_£t_cm¶t_ty³
 {

414 
Ë32
 
	mMes§geTy³
;

415 
Ë32
 
	mMes§geL’gth
;

416 
Ë32
 
	mReque¡ID
;

417 
Ë32
 
	mStus
;

418 } 
	tºdis_£t_cm¶t_ty³
;

420 
	sºdis_»£t_msg_ty³
 {

421 
Ë32
 
	mMes§geTy³
;

422 
Ë32
 
	mMes§geL’gth
;

423 
Ë32
 
	mRe£rved
;

424 } 
	tºdis_»£t_msg_ty³
;

426 
	sºdis_»£t_cm¶t_ty³
 {

427 
Ë32
 
	mMes§geTy³
;

428 
Ë32
 
	mMes§geL’gth
;

429 
Ë32
 
	mStus
;

430 
Ë32
 
	mAdd»ssšgRe£t
;

431 } 
	tºdis_»£t_cm¶t_ty³
;

433 
	sºdis_šdiÿ‹_¡©us_msg_ty³
 {

434 
Ë32
 
	mMes§geTy³
;

435 
Ë32
 
	mMes§geL’gth
;

436 
Ë32
 
	mStus
;

437 
Ë32
 
	mStusBufãrL’gth
;

438 
Ë32
 
	mStusBufãrOff£t
;

439 } 
	tºdis_šdiÿ‹_¡©us_msg_ty³
;

441 
	sºdis_k“·live_msg_ty³
 {

442 
Ë32
 
	mMes§geTy³
;

443 
Ë32
 
	mMes§geL’gth
;

444 
Ë32
 
	mReque¡ID
;

445 } 
	tºdis_k“·live_msg_ty³
;

447 
	sºdis_k“·live_cm¶t_ty³
 {

448 
Ë32
 
	mMes§geTy³
;

449 
Ë32
 
	mMes§geL’gth
;

450 
Ë32
 
	mReque¡ID
;

451 
Ë32
 
	mStus
;

452 } 
	tºdis_k“·live_cm¶t_ty³
;

454 
	sºdis_·ck‘_msg_ty³
 {

455 
Ë32
 
	mMes§geTy³
;

456 
Ë32
 
	mMes§geL’gth
;

457 
Ë32
 
	mD©aOff£t
;

458 
Ë32
 
	mD©aL’gth
;

459 
Ë32
 
	mOOBD©aOff£t
;

460 
Ë32
 
	mOOBD©aL’gth
;

461 
Ë32
 
	mNumOOBD©aEËm’ts
;

462 
Ë32
 
	mP”Pack‘InfoOff£t
;

463 
Ë32
 
	mP”Pack‘InfoL’gth
;

464 
Ë32
 
	mVcHªdË
;

465 
Ë32
 
	mRe£rved
;

468 
	sºdis_cÚfig_·¿m‘”
 {

469 
Ë32
 
	mP¬am‘”NameOff£t
;

470 
Ë32
 
	mP¬am‘”NameL’gth
;

471 
Ë32
 
	mP¬am‘”Ty³
;

472 
Ë32
 
	mP¬am‘”V®ueOff£t
;

473 
Ë32
 
	mP¬am‘”V®ueL’gth
;

477 
	eºdis_¡©e


479 
	mRNDIS_UNINITIALIZED
,

480 
	mRNDIS_INITIALIZED
,

481 
	mRNDIS_DATA_INITIALIZED
,

485 
	endis_oid
 {

487 
	mOID_GEN_SUPPORTED_LIST
 = 0x00010101,

488 
	mOID_GEN_HARDWARE_STATUS
 = 0x00010102,

489 
	mOID_GEN_MEDIA_SUPPORTED
 = 0x00010103,

490 
	mOID_GEN_MEDIA_IN_USE
 = 0x00010104,

491 
	mOID_GEN_MAXIMUM_LOOKAHEAD
 = 0x00010105,

492 
	mOID_GEN_MAXIMUM_FRAME_SIZE
 = 0x00010106,

493 
	mOID_GEN_LINK_SPEED
 = 0x00010107,

494 
	mOID_GEN_TRANSMIT_BUFFER_SPACE
 = 0x00010108,

495 
	mOID_GEN_RECEIVE_BUFFER_SPACE
 = 0x00010109,

496 
	mOID_GEN_TRANSMIT_BLOCK_SIZE
 = 0x0001010a,

497 
	mOID_GEN_RECEIVE_BLOCK_SIZE
 = 0x0001010b,

498 
	mOID_GEN_VENDOR_ID
 = 0x0001010c,

499 
	mOID_GEN_VENDOR_DESCRIPTION
 = 0x0001010d,

500 
	mOID_GEN_CURRENT_PACKET_FILTER
 = 0x0001010e,

501 
	mOID_GEN_CURRENT_LOOKAHEAD
 = 0x0001010f,

502 
	mOID_GEN_DRIVER_VERSION
 = 0x00010110,

503 
	mOID_GEN_MAXIMUM_TOTAL_SIZE
 = 0x00010111,

504 
	mOID_GEN_PROTOCOL_OPTIONS
 = 0x00010112,

505 
	mOID_GEN_MAC_OPTIONS
 = 0x00010113,

506 
	mOID_GEN_MEDIA_CONNECT_STATUS
 = 0x00010114,

507 
	mOID_GEN_MAXIMUM_SEND_PACKETS
 = 0x00010115,

508 
	mOID_GEN_VENDOR_DRIVER_VERSION
 = 0x00010116,

509 
	mOID_GEN_SUPPORTED_GUIDS
 = 0x00010117,

510 
	mOID_GEN_NETWORK_LAYER_ADDRESSES
 = 0x00010118,

511 
	mOID_GEN_TRANSPORT_HEADER_OFFSET
 = 0x00010119,

512 
	mOID_GEN_MACHINE_NAME
 = 0x0001021a,

513 
	mOID_GEN_RNDIS_CONFIG_PARAMETER
 = 0x0001021b,

514 
	mOID_GEN_VLAN_ID
 = 0x0001021c,

517 
	mOID_GEN_MEDIA_CAPABILITIES
 = 0x00010201,

518 
	mOID_GEN_PHYSICAL_MEDIUM
 = 0x00010202,

521 
	mOID_GEN_XMIT_OK
 = 0x00020101,

522 
	mOID_GEN_RCV_OK
 = 0x00020102,

523 
	mOID_GEN_XMIT_ERROR
 = 0x00020103,

524 
	mOID_GEN_RCV_ERROR
 = 0x00020104,

525 
	mOID_GEN_RCV_NO_BUFFER
 = 0x00020105,

528 
	mOID_GEN_DIRECTED_BYTES_XMIT
 = 0x00020201,

529 
	mOID_GEN_DIRECTED_FRAMES_XMIT
 = 0x00020202,

530 
	mOID_GEN_MULTICAST_BYTES_XMIT
 = 0x00020203,

531 
	mOID_GEN_MULTICAST_FRAMES_XMIT
 = 0x00020204,

532 
	mOID_GEN_BROADCAST_BYTES_XMIT
 = 0x00020205,

533 
	mOID_GEN_BROADCAST_FRAMES_XMIT
 = 0x00020206,

534 
	mOID_GEN_DIRECTED_BYTES_RCV
 = 0x00020207,

535 
	mOID_GEN_DIRECTED_FRAMES_RCV
 = 0x00020208,

536 
	mOID_GEN_MULTICAST_BYTES_RCV
 = 0x00020209,

537 
	mOID_GEN_MULTICAST_FRAMES_RCV
 = 0x0002020a,

538 
	mOID_GEN_BROADCAST_BYTES_RCV
 = 0x0002020b,

539 
	mOID_GEN_BROADCAST_FRAMES_RCV
 = 0x0002020c,

540 
	mOID_GEN_RCV_CRC_ERROR
 = 0x0002020d,

541 
	mOID_GEN_TRANSMIT_QUEUE_LENGTH
 = 0x0002020e,

542 
	mOID_GEN_GET_TIME_CAPS
 = 0x0002020f,

543 
	mOID_GEN_GET_NETCARD_TIME
 = 0x00020210,

544 
	mOID_GEN_NETCARD_LOAD
 = 0x00020211,

545 
	mOID_GEN_DEVICE_PROFILE
 = 0x00020212,

546 
	mOID_GEN_INIT_TIME_MS
 = 0x00020213,

547 
	mOID_GEN_RESET_COUNTS
 = 0x00020214,

548 
	mOID_GEN_MEDIA_SENSE_COUNTS
 = 0x00020215,

549 
	mOID_GEN_FRIENDLY_NAME
 = 0x00020216,

550 
	mOID_GEN_MINIPORT_INFO
 = 0x00020217,

551 
	mOID_GEN_RESET_VERIFY_PARAMETERS
 = 0x00020218,

554 
	mOID_802_3_PERMANENT_ADDRESS
 = 0x01010101,

555 
	mOID_802_3_CURRENT_ADDRESS
 = 0x01010102,

556 
	mOID_802_3_MULTICAST_LIST
 = 0x01010103,

557 
	mOID_802_3_MAXIMUM_LIST_SIZE
 = 0x01010104,

558 
	mOID_802_3_MAC_OPTIONS
 = 0x01010105,

559 
	mOID_802_3_RCV_ERROR_ALIGNMENT
 = 0x01020101,

560 
	mOID_802_3_XMIT_ONE_COLLISION
 = 0x01020102,

561 
	mOID_802_3_XMIT_MORE_COLLISIONS
 = 0x01020103,

562 
	mOID_802_3_XMIT_DEFERRED
 = 0x01020201,

563 
	mOID_802_3_XMIT_MAX_COLLISIONS
 = 0x01020202,

564 
	mOID_802_3_RCV_OVERRUN
 = 0x01020203,

565 
	mOID_802_3_XMIT_UNDERRUN
 = 0x01020204,

566 
	mOID_802_3_XMIT_HEARTBEAT_FAILURE
 = 0x01020205,

567 
	mOID_802_3_XMIT_TIMES_CRS_LOST
 = 0x01020206,

568 
	mOID_802_3_XMIT_LATE_COLLISIONS
 = 0x01020207,

571 cÚ¡ 
ušt32_t
 
	goid_suµÜ‹d_li¡
[] =

574 
OID_GEN_SUPPORTED_LIST
,

575 
OID_GEN_HARDWARE_STATUS
,

576 
OID_GEN_MEDIA_SUPPORTED
,

577 
OID_GEN_MEDIA_IN_USE
,

578 
OID_GEN_MAXIMUM_FRAME_SIZE
,

579 
OID_GEN_LINK_SPEED
,

580 
OID_GEN_TRANSMIT_BLOCK_SIZE
,

581 
OID_GEN_RECEIVE_BLOCK_SIZE
,

582 
OID_GEN_VENDOR_ID
,

583 
OID_GEN_VENDOR_DESCRIPTION
,

584 
OID_GEN_VENDOR_DRIVER_VERSION
,

585 
OID_GEN_CURRENT_PACKET_FILTER
,

586 
OID_GEN_MAXIMUM_TOTAL_SIZE
,

587 
OID_GEN_MEDIA_CONNECT_STATUS
,

588 
OID_GEN_PHYSICAL_MEDIUM
,

591 
OID_GEN_XMIT_OK
,

592 
OID_GEN_RCV_OK
,

593 
OID_GEN_XMIT_ERROR
,

594 
OID_GEN_RCV_ERROR
,

595 
OID_GEN_RCV_NO_BUFFER
,

599 
OID_802_3_PERMANENT_ADDRESS
,

600 
OID_802_3_CURRENT_ADDRESS
,

601 
OID_802_3_MULTICAST_LIST
,

602 
OID_802_3_MAC_OPTIONS
,

603 
OID_802_3_MAXIMUM_LIST_SIZE
,

606 
OID_802_3_RCV_ERROR_ALIGNMENT
,

607 
OID_802_3_XMIT_ONE_COLLISION
,

608 
OID_802_3_XMIT_MORE_COLLISIONS
,

611 
	#NDIS_MAC_OPTION_COPY_LOOKAHEAD_DATA
 (1 << 0)

	)

612 
	#NDIS_MAC_OPTION_RECEIVE_SERIALIZED
 (1 << 1)

	)

613 
	#NDIS_MAC_OPTION_TRANSFERS_NOT_PEND
 (1 << 2)

	)

614 
	#NDIS_MAC_OPTION_NO_LOOPBACK
 (1 << 3)

	)

615 
	#NDIS_MAC_OPTION_FULL_DUPLEX
 (1 << 4)

	)

616 
	#NDIS_MAC_OPTION_EOTX_INDICATION
 (1 << 5)

	)

617 
	#NDIS_MAC_OPTION_8021P_PRIORITY
 (1 << 6)

	)

619 
	sºdis_»¥Ú£
 {

620 
QTAILQ_ENTRY
(
ºdis_»¥Ú£
è
	m’Œ›s
;

621 
ušt32_t
 
	mËngth
;

622 
ušt8_t
 
	mbuf
[0];

625 
	sUSBN‘S‹
 {

626 
USBDeviû
 
	mdev
;

628 
ºdis_¡©e
 
	mºdis_¡©e
;

629 
ušt32_t
 
	mmedium
;

630 
ušt32_t
 
	m¥“d
;

631 
ušt32_t
 
	mmedŸ_¡©e
;

632 
ušt16_t
 
	mf‹r
;

633 
ušt32_t
 
	mv’dÜid
;

635 
	mout_±r
;

636 
ušt8_t
 
	mout_buf
[2048];

638 
USBPack‘
 *
	mšpkt
;

639 
	mš_±r
, 
	mš_Ën
;

640 
ušt8_t
 
	mš_buf
[2048];

642 
	musb¡ršg_mac
[13];

643 
NICS‹
 *
	mnic
;

644 
NICCÚf
 
	mcÚf
;

645 
QTAILQ_HEAD
(
ºdis_»¥_h—d
, 
ºdis_»¥Ú£
è
	mºdis_»¥
;

646 } 
	tUSBN‘S‹
;

648 
	$is_ºdis
(
USBN‘S‹
 *
s
)

650  
s
->
dev
.
cÚfig
->
bCÚfigu¿tiÚV®ue
 =ğ
DEV_RNDIS_CONFIG_VALUE
;

651 
	}
}

653 
	$ndis_qu”y
(
USBN‘S‹
 *
s
, 
ušt32_t
 
oid
,

654 
ušt8_t
 *
šbuf
, 
šËn
, ušt8_ˆ*
outbuf
,

655 
size_t
 
ou’
)

657 
i
;

659 
oid
) {

662 
OID_GEN_SUPPORTED_LIST
:

663 
i
 = 0; i < 
	`ARRAY_SIZE
(
oid_suµÜ‹d_li¡
); i++)

664 ((
Ë32
 *è
outbuf
)[
i
] = 
	`ıu_to_Ë32
(
oid_suµÜ‹d_li¡
[i]);

665  (
oid_suµÜ‹d_li¡
);

668 
OID_GEN_HARDWARE_STATUS
:

669 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

670  (
Ë32
);

673 
OID_GEN_MEDIA_SUPPORTED
:

674 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
s
->
medium
);

675  (
Ë32
);

678 
OID_GEN_MEDIA_IN_USE
:

679 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
s
->
medium
);

680  (
Ë32
);

683 
OID_GEN_MAXIMUM_FRAME_SIZE
:

684 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
ETH_FRAME_LEN
);

685  (
Ë32
);

688 
OID_GEN_LINK_SPEED
:

689 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
s
->
¥“d
);

690  (
Ë32
);

693 
OID_GEN_TRANSMIT_BLOCK_SIZE
:

694 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
ETH_FRAME_LEN
);

695  (
Ë32
);

698 
OID_GEN_RECEIVE_BLOCK_SIZE
:

699 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
ETH_FRAME_LEN
);

700  (
Ë32
);

703 
OID_GEN_VENDOR_ID
:

704 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
s
->
v’dÜid
);

705  (
Ë32
);

708 
OID_GEN_VENDOR_DESCRIPTION
:

709 
	`p¡rıy
((*)
outbuf
, 
ou’
, "QEMU USB RNDIS Net");

710  
	`¡¾’
((*)
outbuf
) + 1;

712 
OID_GEN_VENDOR_DRIVER_VERSION
:

713 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(1);

714  (
Ë32
);

717 
OID_GEN_CURRENT_PACKET_FILTER
:

718 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
s
->
f‹r
);

719  (
Ë32
);

722 
OID_GEN_MAXIMUM_TOTAL_SIZE
:

723 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
RNDIS_MAX_TOTAL_SIZE
);

724  (
Ë32
);

727 
OID_GEN_MEDIA_CONNECT_STATUS
:

728 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(
s
->
medŸ_¡©e
);

729  (
Ë32
);

731 
OID_GEN_PHYSICAL_MEDIUM
:

732 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

733  (
Ë32
);

735 
OID_GEN_MAC_OPTIONS
:

736 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(

737 
NDIS_MAC_OPTION_RECEIVE_SERIALIZED
 |

738 
NDIS_MAC_OPTION_FULL_DUPLEX
);

739  (
Ë32
);

743 
OID_GEN_XMIT_OK
:

744 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

745  (
Ë32
);

748 
OID_GEN_RCV_OK
:

749 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

750  (
Ë32
);

753 
OID_GEN_XMIT_ERROR
:

754 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

755  (
Ë32
);

758 
OID_GEN_RCV_ERROR
:

759 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

760  (
Ë32
);

763 
OID_GEN_RCV_NO_BUFFER
:

764 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

765  (
Ë32
);

769 
OID_802_3_PERMANENT_ADDRESS
:

770 
	`memıy
(
outbuf
, 
s
->
cÚf
.
maÿddr
.
a
, 6);

774 
OID_802_3_CURRENT_ADDRESS
:

775 
	`memıy
(
outbuf
, 
s
->
cÚf
.
maÿddr
.
a
, 6);

779 
OID_802_3_MULTICAST_LIST
:

780 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0xe0000000);

781  (
Ë32
);

784 
OID_802_3_MAXIMUM_LIST_SIZE
:

785 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(1);

786  (
Ë32
);

788 
OID_802_3_MAC_OPTIONS
:

793 
OID_802_3_RCV_ERROR_ALIGNMENT
:

794 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

795  (
Ë32
);

798 
OID_802_3_XMIT_ONE_COLLISION
:

799 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

800  (
Ë32
);

803 
OID_802_3_XMIT_MORE_COLLISIONS
:

804 *((
Ë32
 *è
outbuf
èğ
	`ıu_to_Ë32
(0);

805  (
Ë32
);

808 
	`årštf
(
¡d”r
, "usbÃt: unknowÀOID 0x%08x\n", 
oid
);

812 
	}
}

814 
	$ndis_£t
(
USBN‘S‹
 *
s
, 
ušt32_t
 
oid
,

815 
ušt8_t
 *
šbuf
, 
šËn
)

817 
oid
) {

818 
OID_GEN_CURRENT_PACKET_FILTER
:

819 
s
->
f‹r
 = 
	`Ë32_to_ıup
((
Ë32
 *è
šbuf
);

820 ià(
s
->
f‹r
) {

821 
s
->
ºdis_¡©e
 = 
RNDIS_DATA_INITIALIZED
;

823 
s
->
ºdis_¡©e
 = 
RNDIS_INITIALIZED
;

827 
OID_802_3_MULTICAST_LIST
:

831 
	}
}

833 
	$ºdis_g‘_»¥Ú£
(
USBN‘S‹
 *
s
, 
ušt8_t
 *
buf
)

835 
»t
 = 0;

836 
ºdis_»¥Ú£
 *
r
 = 
s
->
ºdis_»¥
.
tqh_fœ¡
;

838 ià(!
r
)

839  
»t
;

841 
	`QTAILQ_REMOVE
(&
s
->
ºdis_»¥
, 
r
, 
’Œ›s
);

842 
»t
 = 
r
->
Ëngth
;

843 
	`memıy
(
buf
, 
r
->buf,„->
Ëngth
);

844 
	`g_ä“
(
r
);

846  
»t
;

847 
	}
}

849 *
	$ºdis_queue_»¥Ú£
(
USBN‘S‹
 *
s
, 
Ëngth
)

851 
ºdis_»¥Ú£
 *
r
 =

852 
	`g_m®loc0
((
ºdis_»¥Ú£
è+ 
Ëngth
);

854 
	`QTAILQ_INSERT_TAIL
(&
s
->
ºdis_»¥
, 
r
, 
’Œ›s
);

855 
r
->
Ëngth
 =†ength;

857  &
r
->
buf
[0];

858 
	}
}

860 
	$ºdis_ş—r_»¥Ú£queue
(
USBN‘S‹
 *
s
)

862 
ºdis_»¥Ú£
 *
r
;

864 (
r
 = 
s
->
ºdis_»¥
.
tqh_fœ¡
)) {

865 
	`QTAILQ_REMOVE
(&
s
->
ºdis_»¥
, 
r
, 
’Œ›s
);

866 
	`g_ä“
(
r
);

868 
	}
}

870 
	$ºdis_š™_»¥Ú£
(
USBN‘S‹
 *
s
, 
ºdis_š™_msg_ty³
 *
buf
)

872 
ºdis_š™_cm¶t_ty³
 *
»¥
 =

873 
	`ºdis_queue_»¥Ú£
(
s
, (
ºdis_š™_cm¶t_ty³
));

875 ià(!
»¥
)

876  
USB_RET_STALL
;

878 
»¥
->
Mes§geTy³
 = 
	`ıu_to_Ë32
(
RNDIS_INITIALIZE_CMPLT
);

879 
»¥
->
Mes§geL’gth
 = 
	`ıu_to_Ë32
((
ºdis_š™_cm¶t_ty³
));

880 
»¥
->
Reque¡ID
 = 
buf
->RequestID;

881 
»¥
->
Stus
 = 
	`ıu_to_Ë32
(
RNDIS_STATUS_SUCCESS
);

882 
»¥
->
MajÜV”siÚ
 = 
	`ıu_to_Ë32
(
RNDIS_MAJOR_VERSION
);

883 
»¥
->
MšÜV”siÚ
 = 
	`ıu_to_Ë32
(
RNDIS_MINOR_VERSION
);

884 
»¥
->
DeviûFÏgs
 = 
	`ıu_to_Ë32
(
RNDIS_DF_CONNECTIONLESS
);

885 
»¥
->
Medium
 = 
	`ıu_to_Ë32
(
RNDIS_MEDIUM_802_3
);

886 
»¥
->
MaxPack‘sP”T¿nsãr
 = 
	`ıu_to_Ë32
(1);

887 
»¥
->
MaxT¿nsãrSize
 = 
	`ıu_to_Ë32
(
ETH_FRAME_LEN
 +

888 (
ºdis_·ck‘_msg_ty³
) + 22);

889 
»¥
->
Pack‘Alignm’tFaùÜ
 = 
	`ıu_to_Ë32
(0);

890 
»¥
->
AFLi¡Off£t
 = 
	`ıu_to_Ë32
(0);

891 
»¥
->
AFLi¡Size
 = 
	`ıu_to_Ë32
(0);

893 
	}
}

895 
	$ºdis_qu”y_»¥Ú£
(
USBN‘S‹
 *
s
,

896 
ºdis_qu”y_msg_ty³
 *
buf
, 
Ëngth
)

898 
ºdis_qu”y_cm¶t_ty³
 *
»¥
;

900 
ušt8_t
 
šfobuf
[(
oid_suµÜ‹d_li¡
)];

901 
ušt32_t
 
bufoffs
, 
buæ’
;

902 
šfobuæ’
;

903 
»¥Ën
;

905 
bufoffs
 = 
	`Ë32_to_ıu
(
buf
->
InfÜm©iÚBufãrOff£t
) + 8;

906 
buæ’
 = 
	`Ë32_to_ıu
(
buf
->
InfÜm©iÚBufãrL’gth
);

907 ià(
bufoffs
 + 
buæ’
 > 
Ëngth
)

908  
USB_RET_STALL
;

910 
šfobuæ’
 = 
	`ndis_qu”y
(
s
, 
	`Ë32_to_ıu
(
buf
->
OID
),

911 
bufoffs
 + (
ušt8_t
 *è
buf
, 
buæ’
, 
šfobuf
,

912 (
šfobuf
));

913 
»¥Ën
 = (
ºdis_qu”y_cm¶t_ty³
) +

914 ((
šfobuæ’
 < 0) ? 0 : infobuflen);

915 
»¥
 = 
	`ºdis_queue_»¥Ú£
(
s
, 
»¥Ën
);

916 ià(!
»¥
)

917  
USB_RET_STALL
;

919 
»¥
->
Mes§geTy³
 = 
	`ıu_to_Ë32
(
RNDIS_QUERY_CMPLT
);

920 
»¥
->
Reque¡ID
 = 
buf
->RequestID;

921 
»¥
->
Mes§geL’gth
 = 
	`ıu_to_Ë32
(
»¥Ën
);

923 ià(
šfobuæ’
 < 0) {

925 
»¥
->
Stus
 = 
	`ıu_to_Ë32
(
RNDIS_STATUS_NOT_SUPPORTED
);

926 
»¥
->
InfÜm©iÚBufãrL’gth
 = 
	`ıu_to_Ë32
(0);

927 
»¥
->
InfÜm©iÚBufãrOff£t
 = 
	`ıu_to_Ë32
(0);

931 
»¥
->
Stus
 = 
	`ıu_to_Ë32
(
RNDIS_STATUS_SUCCESS
);

932 
»¥
->
InfÜm©iÚBufãrOff£t
 =

933 
	`ıu_to_Ë32
(
šfobuæ’
 ? (
ºdis_qu”y_cm¶t_ty³
) - 8 : 0);

934 
»¥
->
InfÜm©iÚBufãrL’gth
 = 
	`ıu_to_Ë32
(
šfobuæ’
);

935 
	`memıy
(
»¥
 + 1, 
šfobuf
, 
šfobuæ’
);

938 
	}
}

940 
	$ºdis_£t_»¥Ú£
(
USBN‘S‹
 *
s
,

941 
ºdis_£t_msg_ty³
 *
buf
, 
Ëngth
)

943 
ºdis_£t_cm¶t_ty³
 *
»¥
 =

944 
	`ºdis_queue_»¥Ú£
(
s
, (
ºdis_£t_cm¶t_ty³
));

945 
ušt32_t
 
bufoffs
, 
buæ’
;

946 
»t
;

948 ià(!
»¥
)

949  
USB_RET_STALL
;

951 
bufoffs
 = 
	`Ë32_to_ıu
(
buf
->
InfÜm©iÚBufãrOff£t
) + 8;

952 
buæ’
 = 
	`Ë32_to_ıu
(
buf
->
InfÜm©iÚBufãrL’gth
);

953 ià(
bufoffs
 + 
buæ’
 > 
Ëngth
)

954  
USB_RET_STALL
;

956 
»t
 = 
	`ndis_£t
(
s
, 
	`Ë32_to_ıu
(
buf
->
OID
),

957 
bufoffs
 + (
ušt8_t
 *è
buf
, 
buæ’
);

958 
»¥
->
Mes§geTy³
 = 
	`ıu_to_Ë32
(
RNDIS_SET_CMPLT
);

959 
»¥
->
Reque¡ID
 = 
buf
->RequestID;

960 
»¥
->
Mes§geL’gth
 = 
	`ıu_to_Ë32
((
ºdis_£t_cm¶t_ty³
));

961 ià(
»t
 < 0) {

963 
»¥
->
Stus
 = 
	`ıu_to_Ë32
(
RNDIS_STATUS_NOT_SUPPORTED
);

966 
»¥
->
Stus
 = 
	`ıu_to_Ë32
(
RNDIS_STATUS_SUCCESS
);

969 
	}
}

971 
	$ºdis_»£t_»¥Ú£
(
USBN‘S‹
 *
s
, 
ºdis_»£t_msg_ty³
 *
buf
)

973 
ºdis_»£t_cm¶t_ty³
 *
»¥
 =

974 
	`ºdis_queue_»¥Ú£
(
s
, (
ºdis_»£t_cm¶t_ty³
));

976 ià(!
»¥
)

977  
USB_RET_STALL
;

979 
»¥
->
Mes§geTy³
 = 
	`ıu_to_Ë32
(
RNDIS_RESET_CMPLT
);

980 
»¥
->
Mes§geL’gth
 = 
	`ıu_to_Ë32
((
ºdis_»£t_cm¶t_ty³
));

981 
»¥
->
Stus
 = 
	`ıu_to_Ë32
(
RNDIS_STATUS_SUCCESS
);

982 
»¥
->
Add»ssšgRe£t
 = 
	`ıu_to_Ë32
(1);

985 
	}
}

987 
	$ºdis_k“·live_»¥Ú£
(
USBN‘S‹
 *
s
,

988 
ºdis_k“·live_msg_ty³
 *
buf
)

990 
ºdis_k“·live_cm¶t_ty³
 *
»¥
 =

991 
	`ºdis_queue_»¥Ú£
(
s
, (
ºdis_k“·live_cm¶t_ty³
));

993 ià(!
»¥
)

994  
USB_RET_STALL
;

996 
»¥
->
Mes§geTy³
 = 
	`ıu_to_Ë32
(
RNDIS_KEEPALIVE_CMPLT
);

997 
»¥
->
Mes§geL’gth
 = 
	`ıu_to_Ë32
((
ºdis_k“·live_cm¶t_ty³
));

998 
»¥
->
Reque¡ID
 = 
buf
->RequestID;

999 
»¥
->
Stus
 = 
	`ıu_to_Ë32
(
RNDIS_STATUS_SUCCESS
);

1002 
	}
}

1004 
	$ºdis_·r£
(
USBN‘S‹
 *
s
, 
ušt8_t
 *
d©a
, 
Ëngth
)

1006 
ušt32_t
 
msg_ty³
;

1007 
Ë32
 *
tmp
 = (Ë32 *è
d©a
;

1009 
msg_ty³
 = 
	`Ë32_to_ıup
(
tmp
);

1011 
msg_ty³
) {

1012 
RNDIS_INITIALIZE_MSG
:

1013 
s
->
ºdis_¡©e
 = 
RNDIS_INITIALIZED
;

1014  
	`ºdis_š™_»¥Ú£
(
s
, (
ºdis_š™_msg_ty³
 *è
d©a
);

1016 
RNDIS_HALT_MSG
:

1017 
s
->
ºdis_¡©e
 = 
RNDIS_UNINITIALIZED
;

1020 
RNDIS_QUERY_MSG
:

1021  
	`ºdis_qu”y_»¥Ú£
(
s
, (
ºdis_qu”y_msg_ty³
 *è
d©a
, 
Ëngth
);

1023 
RNDIS_SET_MSG
:

1024  
	`ºdis_£t_»¥Ú£
(
s
, (
ºdis_£t_msg_ty³
 *è
d©a
, 
Ëngth
);

1026 
RNDIS_RESET_MSG
:

1027 
	`ºdis_ş—r_»¥Ú£queue
(
s
);

1028 
s
->
out_±r
 = s->
š_±r
 = s->
š_Ën
 = 0;

1029  
	`ºdis_»£t_»¥Ú£
(
s
, (
ºdis_»£t_msg_ty³
 *è
d©a
);

1031 
RNDIS_KEEPALIVE_MSG
:

1033  
	`ºdis_k“·live_»¥Ú£
(
s
, (
ºdis_k“·live_msg_ty³
 *è
d©a
);

1036  
USB_RET_STALL
;

1037 
	}
}

1039 
	$usb_Ãt_hªdË_»£t
(
USBDeviû
 *
dev
)

1041 
	}
}

1043 
	$usb_Ãt_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

1044 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

1046 
USBN‘S‹
 *
s
 = (USBN‘S‹ *è
dev
;

1047 
»t
;

1049 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

1050 ià(
»t
 >= 0) {

1051  
»t
;

1054 
»t
 = 0;

1055 
»que¡
) {

1056 
CÏssIÁ”çûOutReque¡
 | 
USB_CDC_SEND_ENCAPSULATED_COMMAND
:

1057 ià(!
	`is_ºdis
(
s
è|| 
v®ue
 || 
šdex
 != 0) {

1058 
ç
;

1060 #ifdeà
TRAFFIC_DEBUG


1062 
i
;

1063 
	`årštf
(
¡d”r
, "SEND_ENCAPSULATED_COMMAND:");

1064 
i
 = 0; i < 
Ëngth
; i++) {

1065 ià(!(
i
 & 15))

1066 
	`årštf
(
¡d”r
, "\n%04x:", 
i
);

1067 
	`årštf
(
¡d”r
, " %02x", 
d©a
[
i
]);

1069 
	`årštf
(
¡d”r
, "\n\n");

1072 
»t
 = 
	`ºdis_·r£
(
s
, 
d©a
, 
Ëngth
);

1075 
CÏssIÁ”çûReque¡
 | 
USB_CDC_GET_ENCAPSULATED_RESPONSE
:

1076 ià(!
	`is_ºdis
(
s
è|| 
v®ue
 || 
šdex
 != 0) {

1077 
ç
;

1079 
»t
 = 
	`ºdis_g‘_»¥Ú£
(
s
, 
d©a
);

1080 ià(!
»t
) {

1081 
d©a
[0] = 0;

1082 
»t
 = 1;

1084 #ifdeà
TRAFFIC_DEBUG


1086 
i
;

1087 
	`årštf
(
¡d”r
, "GET_ENCAPSULATED_RESPONSE:");

1088 
i
 = 0; i < 
»t
; i++) {

1089 ià(!(
i
 & 15))

1090 
	`årštf
(
¡d”r
, "\n%04x:", 
i
);

1091 
	`årštf
(
¡d”r
, " %02x", 
d©a
[
i
]);

1093 
	`årštf
(
¡d”r
, "\n\n");

1099 
ç
:

1100 
	`årštf
(
¡d”r
, "usbnet: failed controlransaction: "

1102 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
);

1103 
»t
 = 
USB_RET_STALL
;

1106  
»t
;

1107 
	}
}

1109 
	$usb_Ãt_hªdË_¡©usš
(
USBN‘S‹
 *
s
, 
USBPack‘
 *
p
)

1111 
Ë32
 
buf
[2];

1112 
»t
 = 8;

1114 ià(
p
->
iov
.
size
 < 8) {

1115  
USB_RET_STALL
;

1118 
buf
[0] = 
	`ıu_to_Ë32
(1);

1119 
buf
[1] = 
	`ıu_to_Ë32
(0);

1120 
	`usb_·ck‘_cİy
(
p
, 
buf
, 8);

1121 ià(!
s
->
ºdis_»¥
.
tqh_fœ¡
)

1122 
»t
 = 
USB_RET_NAK
;

1124 #ifdeà
TRAFFIC_DEBUG


1125 
	`årštf
(
¡d”r
, "usbnet: interrupt…oll†en %zu„eturn %d",

1126 
p
->
iov
.
size
, 
»t
);

1127 
	`iov_hexdump
(
p
->
iov
.iov,…->iov.
niov
, 
¡d”r
, "usbÃt", 
»t
);

1130  
»t
;

1131 
	}
}

1133 
	$usb_Ãt_hªdË_d©aš
(
USBN‘S‹
 *
s
, 
USBPack‘
 *
p
)

1135 
»t
 = 
USB_RET_NAK
;

1137 ià(
s
->
š_±r
 > s->
š_Ën
) {

1138 
s
->
š_±r
 = s->
š_Ën
 = 0;

1139 
»t
 = 
USB_RET_NAK
;

1140  
»t
;

1142 ià(!
s
->
š_Ën
) {

1143 
»t
 = 
USB_RET_NAK
;

1144  
»t
;

1146 
»t
 = 
s
->
š_Ën
 - s->
š_±r
;

1147 ià(
»t
 > 
p
->
iov
.
size
) {

1148 
»t
 = 
p
->
iov
.
size
;

1150 
	`usb_·ck‘_cİy
(
p
, &
s
->
š_buf
[s->
š_±r
], 
»t
);

1151 
s
->
š_±r
 +ğ
»t
;

1152 ià(
s
->
š_±r
 >ğs->
š_Ën
 &&

1153 (
	`is_ºdis
(
s
è|| (s->
š_Ën
 & (64 - 1)è|| !
»t
)) {

1155 
s
->
š_±r
 = s->
š_Ën
 = 0;

1158 #ifdeà
TRAFFIC_DEBUG


1159 
	`årštf
(
¡d”r
, "usbÃt: d©¨š†’ %zu„‘uº %d", 
p
->
iov
.
size
, 
»t
);

1160 
	`iov_hexdump
(
p
->
iov
.iov,…->iov.
niov
, 
¡d”r
, "usbÃt", 
»t
);

1163  
»t
;

1164 
	}
}

1166 
	$usb_Ãt_hªdË_d©aout
(
USBN‘S‹
 *
s
, 
USBPack‘
 *
p
)

1168 
»t
 = 
p
->
iov
.
size
;

1169 
sz
 = (
s
->
out_buf
è- s->
out_±r
;

1170 
ºdis_·ck‘_msg_ty³
 *
msg
 =

1171 (
ºdis_·ck‘_msg_ty³
 *è
s
->
out_buf
;

1172 
ušt32_t
 
Ën
;

1174 #ifdeà
TRAFFIC_DEBUG


1175 
	`årštf
(
¡d”r
, "usbÃt: d©¨ouˆËÀ%zu\n", 
p
->
iov
.
size
);

1176 
	`iov_hexdump
(
p
->
iov
.iov,…->iov.
niov
, 
¡d”r
, "usbÃt",…->iov.
size
);

1179 ià(
sz
 > 
»t
)

1180 
sz
 = 
»t
;

1181 
	`usb_·ck‘_cİy
(
p
, &
s
->
out_buf
[s->
out_±r
], 
sz
);

1182 
s
->
out_±r
 +ğ
sz
;

1184 ià(!
	`is_ºdis
(
s
)) {

1185 ià(
»t
 < 64) {

1186 
	`qemu_£nd_·ck‘
(&
s
->
nic
->
nc
, s->
out_buf
, s->
out_±r
);

1187 
s
->
out_±r
 = 0;

1189  
»t
;

1191 
Ën
 = 
	`Ë32_to_ıu
(
msg
->
Mes§geL’gth
);

1192 ià(
s
->
out_±r
 < 8 || s->out_±¸< 
Ën
)

1193  
»t
;

1194 ià(
	`Ë32_to_ıu
(
msg
->
Mes§geTy³
è=ğ
RNDIS_PACKET_MSG
) {

1195 
ušt32_t
 
offs
 = 8 + 
	`Ë32_to_ıu
(
msg
->
D©aOff£t
);

1196 
ušt32_t
 
size
 = 
	`Ë32_to_ıu
(
msg
->
D©aL’gth
);

1197 ià(
offs
 + 
size
 <ğ
Ën
)

1198 
	`qemu_£nd_·ck‘
(&
s
->
nic
->
nc
, s->
out_buf
 + 
offs
, 
size
);

1200 
s
->
out_±r
 -ğ
Ën
;

1201 
	`memmove
(
s
->
out_buf
, &s->out_buf[
Ën
], s->
out_±r
);

1203  
»t
;

1204 
	}
}

1206 
	$usb_Ãt_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

1208 
USBN‘S‹
 *
s
 = (USBN‘S‹ *è
dev
;

1209 
»t
 = 0;

1211 
p
->
pid
) {

1212 
USB_TOKEN_IN
:

1213 
p
->
•
->
Ä
) {

1215 
»t
 = 
	`usb_Ãt_hªdË_¡©usš
(
s
, 
p
);

1219 
»t
 = 
	`usb_Ãt_hªdË_d©aš
(
s
, 
p
);

1223 
ç
;

1227 
USB_TOKEN_OUT
:

1228 
p
->
•
->
Ä
) {

1230 
»t
 = 
	`usb_Ãt_hªdË_d©aout
(
s
, 
p
);

1234 
ç
;

1239 
ç
:

1240 
»t
 = 
USB_RET_STALL
;

1243 ià(
»t
 =ğ
USB_RET_STALL
)

1244 
	`årštf
(
¡d”r
, "usbnet: failed dataransaction: "

1246 
p
->
pid
,…->
•
->
Ä
,…->
iov
.
size
);

1247  
»t
;

1248 
	}
}

1250 
ssize_t
 
	$usbÃt_»ûive
(
N‘Cl›ÁS‹
 *
nc
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
size
)

1252 
USBN‘S‹
 *
s
 = 
	`DO_UPCAST
(
NICS‹
, 
nc
,‚c)->
İaque
;

1253 
ºdis_·ck‘_msg_ty³
 *
msg
;

1255 ià(
	`is_ºdis
(
s
)) {

1256 
msg
 = (
ºdis_·ck‘_msg_ty³
 *è
s
->
š_buf
;

1257 ià(
s
->
ºdis_¡©e
 !ğ
RNDIS_DATA_INITIALIZED
) {

1260 ià(
size
 + (
ºdis_·ck‘_msg_ty³
è> (
s
->
š_buf
))

1263 
	`mem£t
(
msg
, 0, (
ºdis_·ck‘_msg_ty³
));

1264 
msg
->
Mes§geTy³
 = 
	`ıu_to_Ë32
(
RNDIS_PACKET_MSG
);

1265 
msg
->
Mes§geL’gth
 = 
	`ıu_to_Ë32
(
size
 + (
ºdis_·ck‘_msg_ty³
));

1266 
msg
->
D©aOff£t
 = 
	`ıu_to_Ë32
((
ºdis_·ck‘_msg_ty³
) - 8);

1267 
msg
->
D©aL’gth
 = 
	`ıu_to_Ë32
(
size
);

1276 
	`memıy
(
msg
 + 1, 
buf
, 
size
);

1277 
s
->
š_Ën
 = 
size
 + (
ºdis_·ck‘_msg_ty³
);

1279 ià(
size
 > (
s
->
š_buf
))

1281 
	`memıy
(
s
->
š_buf
, 
buf
, 
size
);

1282 
s
->
š_Ën
 = 
size
;

1284 
s
->
š_±r
 = 0;

1285  
size
;

1286 
	}
}

1288 
	$usbÃt_ÿn_»ûive
(
N‘Cl›ÁS‹
 *
nc
)

1290 
USBN‘S‹
 *
s
 = 
	`DO_UPCAST
(
NICS‹
, 
nc
,‚c)->
İaque
;

1292 ià(
	`is_ºdis
(
s
è&& s->
ºdis_¡©e
 !ğ
RNDIS_DATA_INITIALIZED
) {

1296  !
s
->
š_Ën
;

1297 
	}
}

1299 
	$usbÃt_ş—nup
(
N‘Cl›ÁS‹
 *
nc
)

1301 
USBN‘S‹
 *
s
 = 
	`DO_UPCAST
(
NICS‹
, 
nc
,‚c)->
İaque
;

1303 
s
->
nic
 = 
NULL
;

1304 
	}
}

1306 
	$usb_Ãt_hªdË_de¡roy
(
USBDeviû
 *
dev
)

1308 
USBN‘S‹
 *
s
 = (USBN‘S‹ *è
dev
;

1311 
	`ºdis_ş—r_»¥Ú£queue
(
s
);

1312 
	`qemu_d–_Ãt_ş›Á
(&
s
->
nic
->
nc
);

1313 
	}
}

1315 
N‘Cl›ÁInfo
 
	gÃt_usbÃt_šfo
 = {

1316 .
ty³
 = 
NET_CLIENT_OPTIONS_KIND_NIC
,

1317 .
	gsize
 = (
NICS‹
),

1318 .
	gÿn_»ûive
 = 
usbÃt_ÿn_»ûive
,

1319 .
	g»ûive
 = 
usbÃt_»ûive
,

1320 .
	gş—nup
 = 
usbÃt_ş—nup
,

1323 
	$usb_Ãt_š™â
(
USBDeviû
 *
dev
)

1325 
USBN‘S‹
 *
s
 = 
	`DO_UPCAST
(USBN‘S‹, 
dev
, dev);

1327 
	`usb_desc_ü—‹_£rŸl
(
dev
);

1328 
	`usb_desc_š™
(
dev
);

1330 
s
->
ºdis_¡©e
 = 
RNDIS_UNINITIALIZED
;

1331 
	`QTAILQ_INIT
(&
s
->
ºdis_»¥
);

1333 
s
->
medium
 = 0;

1334 
s
->
¥“d
 = 1000000;

1335 
s
->
medŸ_¡©e
 = 0; ;

1336 
s
->
f‹r
 = 0;

1337 
s
->
v’dÜid
 = 0x1234;

1339 
	`qemu_maÿddr_deçuÉ_if_un£t
(&
s
->
cÚf
.
maÿddr
);

1340 
s
->
nic
 = 
	`qemu_Ãw_nic
(&
Ãt_usbÃt_šfo
, &s->
cÚf
,

1341 
	`objeù_g‘_ty³Çme
(
	`OBJECT
(
s
)), s->
dev
.
qdev
.
id
, s);

1342 
	`qemu_fÜm©_nic_šfo_¡r
(&
s
->
nic
->
nc
, s->
cÚf
.
maÿddr
.
a
);

1343 
	`¢´štf
(
s
->
usb¡ršg_mac
, (s->usbstring_mac),

1346 
s
->
cÚf
.
maÿddr
.
a
[1],

1347 
s
->
cÚf
.
maÿddr
.
a
[2],

1348 
s
->
cÚf
.
maÿddr
.
a
[3],

1349 
s
->
cÚf
.
maÿddr
.
a
[4],

1350 
s
->
cÚf
.
maÿddr
.
a
[5]);

1351 
	`usb_desc_£t_¡ršg
(
dev
, 
STRING_ETHADDR
, 
s
->
usb¡ršg_mac
);

1353 
	`add_boÙ_deviû_·th
(
s
->
cÚf
.
boÙšdex
, &
dev
->
qdev
, "/ethernet@0");

1355 
	}
}

1357 
USBDeviû
 *
	$usb_Ãt_š™
(
USBBus
 *
bus
, cÚ¡ *
cmdlše
)

1359 
E¼Ü
 *
loÿl_”r
 = 
NULL
;

1360 
USBDeviû
 *
dev
;

1361 
QemuO±s
 *
İts
;

1362 
idx
;

1364 
İts
 = 
	`qemu_İts_·r£
(
	`qemu_fšd_İts
("Ãt"), 
cmdlše
, 0);

1365 ià(!
İts
) {

1366  
NULL
;

1368 
	`qemu_İt_£t
(
İts
, "type", "nic");

1369 
	`qemu_İt_£t
(
İts
, "model", "usb");

1371 
idx
 = 
	`Ãt_ş›Á_š™
(
İts
, 0, &
loÿl_”r
);

1372 ià(
	`”rÜ_is_£t
(&
loÿl_”r
)) {

1373 
	`q”rÜ_»pÜt_”r
(
loÿl_”r
);

1374 
	`”rÜ_ä“
(
loÿl_”r
);

1375  
NULL
;

1378 
dev
 = 
	`usb_ü—‹
(
bus
, "usb-net");

1379 ià(!
dev
) {

1380  
NULL
;

1382 
	`qdev_£t_nic_´İ”t›s
(&
dev
->
qdev
, &
nd_bË
[
idx
]);

1383 
	`qdev_š™_noç
(&
dev
->
qdev
);

1384  
dev
;

1385 
	}
}

1387 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_Ãt
 = {

1388 .
Çme
 = "usb-net",

1389 .
	gunmig¿bË
 = 1,

1392 
Prİ”ty
 
	gÃt_´İ”t›s
[] = {

1393 
DEFINE_NIC_PROPERTIES
(
USBN‘S‹
, 
cÚf
),

1394 
DEFINE_PROP_END_OF_LIST
(),

1397 
	$usb_Ãt_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1399 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1400 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

1402 
uc
->
š™
 = 
usb_Ãt_š™â
;

1403 
uc
->
´oduù_desc
 = "QEMU USB Network Interface";

1404 
uc
->
usb_desc
 = &
desc_Ãt
;

1405 
uc
->
hªdË_»£t
 = 
usb_Ãt_hªdË_»£t
;

1406 
uc
->
hªdË_cÚŒŞ
 = 
usb_Ãt_hªdË_cÚŒŞ
;

1407 
uc
->
hªdË_d©a
 = 
usb_Ãt_hªdË_d©a
;

1408 
uc
->
hªdË_de¡roy
 = 
usb_Ãt_hªdË_de¡roy
;

1409 
dc
->
fw_Çme
 = "network";

1410 
dc
->
vmsd
 = &
vm¡©e_usb_Ãt
;

1411 
dc
->
´İs
 = 
Ãt_´İ”t›s
;

1412 
	}
}

1414 
Ty³Info
 
	gÃt_šfo
 = {

1415 .
Çme
 = "usb-net",

1416 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

1417 .
	gš¡ªû_size
 = (
USBN‘S‹
),

1418 .
	gşass_š™
 = 
usb_Ãt_şass_š™â
,

1421 
	$usb_Ãt_»gi¡”_ty³s
()

1423 
	`ty³_»gi¡”_¡©ic
(&
Ãt_šfo
);

1424 
	`usb_Ëgacy_»gi¡”
("usb-Ãt", "Ãt", 
usb_Ãt_š™
);

1425 
	}
}

1427 
ty³_š™
(
usb_Ãt_»gi¡”_ty³s
)

	@dev-serial.c

11 
	~"qemu-commÚ.h
"

12 
	~"qemu-”rÜ.h
"

13 
	~"hw/usb.h
"

14 
	~"hw/usb/desc.h
"

15 
	~"qemu-ch¬.h
"

19 #ifdeà
DEBUG_S”Ÿl


20 
	#DPRINTF
(
fmt
, ...) \

21 dØ{ 
	`´štf
("usb-£rŸl: " 
fmt
 , ## 
__VA_ARGS__
); } 0)

	)

23 
	#DPRINTF
(
fmt
, ...èdØ{} 0)

	)

26 
	#RECV_BUF
 384

	)

29 
	#FTDI_RESET
 0

	)

30 
	#FTDI_SET_MDM_CTRL
 1

	)

31 
	#FTDI_SET_FLOW_CTRL
 2

	)

32 
	#FTDI_SET_BAUD
 3

	)

33 
	#FTDI_SET_DATA
 4

	)

34 
	#FTDI_GET_MDM_ST
 5

	)

35 
	#FTDI_SET_EVENT_CHR
 6

	)

36 
	#FTDI_SET_ERROR_CHR
 7

	)

37 
	#FTDI_SET_LATENCY
 9

	)

38 
	#FTDI_GET_LATENCY
 10

	)

40 
	#DeviûOutV’dÜ
 ((
USB_DIR_OUT
|
USB_TYPE_VENDOR
|
USB_RECIP_DEVICE
)<<8)

	)

41 
	#DeviûInV’dÜ
 ((
USB_DIR_IN
 |
USB_TYPE_VENDOR
|
USB_RECIP_DEVICE
)<<8)

	)

45 
	#FTDI_RESET_SIO
 0

	)

46 
	#FTDI_RESET_RX
 1

	)

47 
	#FTDI_RESET_TX
 2

	)

51 
	#FTDI_DTR
 1

	)

52 
	#FTDI_SET_DTR
 (
FTDI_DTR
 << 8)

	)

53 
	#FTDI_RTS
 2

	)

54 
	#FTDI_SET_RTS
 (
FTDI_RTS
 << 8)

	)

58 
	#FTDI_RTS_CTS_HS
 1

	)

59 
	#FTDI_DTR_DSR_HS
 2

	)

60 
	#FTDI_XON_XOFF_HS
 4

	)

64 
	#FTDI_PARITY
 (0x7 << 8)

	)

65 
	#FTDI_ODD
 (0x1 << 8)

	)

66 
	#FTDI_EVEN
 (0x2 << 8)

	)

67 
	#FTDI_MARK
 (0x3 << 8)

	)

68 
	#FTDI_SPACE
 (0x4 << 8)

	)

70 
	#FTDI_STOP
 (0x3 << 11)

	)

71 
	#FTDI_STOP1
 (0x0 << 11)

	)

72 
	#FTDI_STOP15
 (0x1 << 11)

	)

73 
	#FTDI_STOP2
 (0x2 << 11)

	)

77 
	#FTDI_CTS
 (1<<4)

78 
	#FTDI_DSR
 (1<<5)

79 
	#FTDI_RI
 (1<<6)

80 
	#FTDI_RLSD
 (1<<7)

81 

	)

84 
	#FTDI_DR
 (1<<0)

85 
	#FTDI_OE
 (1<<1)

86 
	#FTDI_PE
 (1<<2)

87 
	#FTDI_FE
 (1<<3)

88 
	#FTDI_BI
 (1<<4)

89 
	#FTDI_THRE
 (1<<5)

90 
	#FTDI_TEMT
 (1<<6)

91 
	#FTDI_FIFO
 (1<<7)

92 

	)

94 
USBDeviû
 
	mdev
;

95 
ušt8_t
 
	m»cv_buf
[
RECV_BUF
];

96 
ušt16_t
 
	m»cv_±r
;

97 
ušt16_t
 
	m»cv_u£d
;

98 
ušt8_t
 
	mev’t_chr
;

99 
ušt8_t
 
	m”rÜ_chr
;

100 
ušt8_t
 
	mev’t_Œigg”
;

101 
QEMUS”ŸlS‘P¬ams
 
	m·¿ms
;

102 
	mÏ‹ncy
;

103 
Ch¬Driv”S‹
 *
	mcs
;

104 } 
	tUSBS”ŸlS‹
;

107 
	mSTR_MANUFACTURER
 = 1,

108 
	mSTR_PRODUCT_SERIAL
,

109 
	mSTR_PRODUCT_BRAILLE
,

110 
	mSTR_SERIALNUMBER
,

113 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

114 [
STR_MANUFACTURER
] = "QEMU",

115 [
STR_PRODUCT_SERIAL
] = "QEMU USB SERIAL",

116 [
STR_PRODUCT_BRAILLE
] = "QEMU USB BRAILLE",

117 [
STR_SERIALNUMBER
] = "1",

120 cÚ¡ 
USBDescIçû
 
	gdesc_içû0
 = {

121 .
bIÁ”çûNumb”
 = 0,

122 .
	gbNumEndpošts
 = 2,

123 .
	gbIÁ”çûCÏss
 = 0xff,

124 .
	gbIÁ”çûSubCÏss
 = 0xff,

125 .
	gbIÁ”çûPrÙocŞ
 = 0xff,

126 .
	g•s
 = (
USBDescEndpošt
[]) {

128 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

129 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

130 .
	gwMaxPack‘Size
 = 64,

132 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 0x02,

133 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

134 .
	gwMaxPack‘Size
 = 64,

139 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû
 = {

140 .
bcdUSB
 = 0x0200,

141 .
	gbMaxPack‘Size0
 = 8,

142 .
	gbNumCÚfigu¿tiÚs
 = 1,

143 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

145 .
bNumIÁ”çûs
 = 1,

146 .
	gbCÚfigu¿tiÚV®ue
 = 1,

147 .
	gbmA‰ribu‹s
 = 0x80,

148 .
	gbMaxPow”
 = 50,

149 .
	gnif
 = 1,

150 .
	gifs
 = &
desc_içû0
,

155 cÚ¡ 
USBDesc
 
	gdesc_£rŸl
 = {

156 .
id
 = {

157 .
idV’dÜ
 = 0x0403,

158 .
	gidProduù
 = 0x6001,

159 .
	gbcdDeviû
 = 0x0400,

160 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

161 .
	giProduù
 = 
STR_PRODUCT_SERIAL
,

162 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

164 .
	gfuÎ
 = &
desc_deviû
,

165 .
	g¡r
 = 
desc_¡ršgs
,

168 cÚ¡ 
USBDesc
 
	gdesc_b¿Ë
 = {

169 .
id
 = {

170 .
idV’dÜ
 = 0x0403,

171 .
	gidProduù
 = 0xfe72,

172 .
	gbcdDeviû
 = 0x0400,

173 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

174 .
	giProduù
 = 
STR_PRODUCT_BRAILLE
,

175 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

177 .
	gfuÎ
 = &
desc_deviû
,

178 .
	g¡r
 = 
desc_¡ršgs
,

181 
	$usb_£rŸl_»£t
(
USBS”ŸlS‹
 *
s
)

184 
s
->
ev’t_chr
 = 0x0d;

185 
s
->
ev’t_Œigg”
 = 0;

186 
s
->
»cv_±r
 = 0;

187 
s
->
»cv_u£d
 = 0;

189 
	}
}

191 
	$usb_£rŸl_hªdË_»£t
(
USBDeviû
 *
dev
)

193 
USBS”ŸlS‹
 *
s
 = (USBS”ŸlS‹ *)
dev
;

195 
	`DPRINTF
("Reset\n");

197 
	`usb_£rŸl_»£t
(
s
);

199 
	}
}

201 
ušt8_t
 
	$usb_g‘_modem_lšes
(
USBS”ŸlS‹
 *
s
)

203 
æags
;

204 
ušt8_t
 
»t
;

206 ià(
	`qemu_chr_ã_ioùl
(
s
->
cs
, 
CHR_IOCTL_SERIAL_GET_TIOCM
, &
æags
è=ğ-
ENOTSUP
)

207  
FTDI_CTS
|
FTDI_DSR
|
FTDI_RLSD
;

209 
»t
 = 0;

210 ià(
æags
 & 
CHR_TIOCM_CTS
)

211 
»t
 |ğ
FTDI_CTS
;

212 ià(
æags
 & 
CHR_TIOCM_DSR
)

213 
»t
 |ğ
FTDI_DSR
;

214 ià(
æags
 & 
CHR_TIOCM_RI
)

215 
»t
 |ğ
FTDI_RI
;

216 ià(
æags
 & 
CHR_TIOCM_CAR
)

217 
»t
 |ğ
FTDI_RLSD
;

219  
»t
;

220 
	}
}

222 
	$usb_£rŸl_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

223 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

225 
USBS”ŸlS‹
 *
s
 = (USBS”ŸlS‹ *)
dev
;

226 
»t
;

228 
	`DPRINTF
("gÙ cÚŒŞ %x, v®u%x\n",
»que¡
, 
v®ue
);

229 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

230 ià(
»t
 >= 0) {

231  
»t
;

234 
»t
 = 0;

235 
»que¡
) {

236 
EndpoštOutReque¡
 | 
USB_REQ_CLEAR_FEATURE
:

237 
»t
 = 0;

241 
DeviûOutV’dÜ
 | 
FTDI_RESET
:

242 
v®ue
) {

243 
FTDI_RESET_SIO
:

244 
	`usb_£rŸl_»£t
(
s
);

246 
FTDI_RESET_RX
:

247 
s
->
»cv_±r
 = 0;

248 
s
->
»cv_u£d
 = 0;

251 
FTDI_RESET_TX
:

256 
DeviûOutV’dÜ
 | 
FTDI_SET_MDM_CTRL
:

258 
æags
;

259 
	`qemu_chr_ã_ioùl
(
s
->
cs
,
CHR_IOCTL_SERIAL_GET_TIOCM
, &
æags
);

260 ià(
v®ue
 & 
FTDI_SET_RTS
) {

261 ià(
v®ue
 & 
FTDI_RTS
)

262 
æags
 |ğ
CHR_TIOCM_RTS
;

264 
æags
 &ğ~
CHR_TIOCM_RTS
;

266 ià(
v®ue
 & 
FTDI_SET_DTR
) {

267 ià(
v®ue
 & 
FTDI_DTR
)

268 
æags
 |ğ
CHR_TIOCM_DTR
;

270 
æags
 &ğ~
CHR_TIOCM_DTR
;

272 
	`qemu_chr_ã_ioùl
(
s
->
cs
,
CHR_IOCTL_SERIAL_SET_TIOCM
, &
æags
);

275 
DeviûOutV’dÜ
 | 
FTDI_SET_FLOW_CTRL
:

278 
DeviûOutV’dÜ
 | 
FTDI_SET_BAUD
: {

279 cÚ¡ 
subdivisÜs8
[8] = { 0, 4, 2, 1, 3, 5, 6, 7 };

280 
subdivisÜ8
 = 
subdivisÜs8
[((
v®ue
 & 0xc000) >> 14)

281 | ((
šdex
 & 1) << 2)];

282 
divisÜ
 = 
v®ue
 & 0x3fff;

285 ià(
divisÜ
 =ğ1 && 
subdivisÜ8
 == 0)

286 
subdivisÜ8
 = 4;

287 ià(
divisÜ
 =ğ0 && 
subdivisÜ8
 == 0)

288 
divisÜ
 = 1;

290 
s
->
·¿ms
.
¥“d
 = (48000000 / 2è/ (8 * 
divisÜ
 + 
subdivisÜ8
);

291 
	`qemu_chr_ã_ioùl
(
s
->
cs
, 
CHR_IOCTL_SERIAL_SET_PARAMS
, &s->
·¿ms
);

294 
DeviûOutV’dÜ
 | 
FTDI_SET_DATA
:

295 
v®ue
 & 
FTDI_PARITY
) {

297 
s
->
·¿ms
.
·r™y
 = 'N';

299 
FTDI_ODD
:

300 
s
->
·¿ms
.
·r™y
 = 'O';

302 
FTDI_EVEN
:

303 
s
->
·¿ms
.
·r™y
 = 'E';

306 
	`DPRINTF
("unsuµÜ‹d…¬™y %d\n", 
v®ue
 & 
FTDI_PARITY
);

307 
ç
;

309 
v®ue
 & 
FTDI_STOP
) {

310 
FTDI_STOP1
:

311 
s
->
·¿ms
.
¡İ_b™s
 = 1;

313 
FTDI_STOP2
:

314 
s
->
·¿ms
.
¡İ_b™s
 = 2;

317 
	`DPRINTF
("unsuµÜ‹d stİ b™ %d\n", 
v®ue
 & 
FTDI_STOP
);

318 
ç
;

320 
	`qemu_chr_ã_ioùl
(
s
->
cs
, 
CHR_IOCTL_SERIAL_SET_PARAMS
, &s->
·¿ms
);

323 
DeviûInV’dÜ
 | 
FTDI_GET_MDM_ST
:

324 
d©a
[0] = 
	`usb_g‘_modem_lšes
(
s
) | 1;

325 
d©a
[1] = 0;

326 
»t
 = 2;

328 
DeviûOutV’dÜ
 | 
FTDI_SET_EVENT_CHR
:

330 
s
->
ev’t_chr
 = 
v®ue
;

332 
DeviûOutV’dÜ
 | 
FTDI_SET_ERROR_CHR
:

334 
s
->
”rÜ_chr
 = 
v®ue
;

336 
DeviûOutV’dÜ
 | 
FTDI_SET_LATENCY
:

337 
s
->
Ï‹ncy
 = 
v®ue
;

339 
DeviûInV’dÜ
 | 
FTDI_GET_LATENCY
:

340 
d©a
[0] = 
s
->
Ï‹ncy
;

341 
»t
 = 1;

344 
ç
:

345 
	`DPRINTF
("gÙ unsuµÜ‹d/bogu cÚŒŞ %x, v®u%x\n", 
»que¡
, 
v®ue
);

346 
»t
 = 
USB_RET_STALL
;

349  
»t
;

350 
	}
}

352 
	$usb_£rŸl_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

354 
USBS”ŸlS‹
 *
s
 = (USBS”ŸlS‹ *)
dev
;

355 
i
, 
»t
 = 0;

356 
ušt8_t
 
dev•
 = 
p
->
•
->
Ä
;

357 
iovec
 *
iov
;

358 
ušt8_t
 
h—d”
[2];

359 
fœ¡_Ën
, 
Ën
;

361 
p
->
pid
) {

362 
USB_TOKEN_OUT
:

363 ià(
dev•
 != 2)

364 
ç
;

365 
i
 = 0; i < 
p
->
iov
.
niov
; i++) {

366 
iov
 = 
p
->iov.iov + 
i
;

367 
	`qemu_chr_ã_wr™e
(
s
->
cs
, 
iov
->
iov_ba£
, iov->
iov_Ën
);

371 
USB_TOKEN_IN
:

372 ià(
dev•
 != 1)

373 
ç
;

374 
fœ¡_Ën
 = 
RECV_BUF
 - 
s
->
»cv_±r
;

375 
Ën
 = 
p
->
iov
.
size
;

376 ià(
Ën
 <= 2) {

377 
»t
 = 
USB_RET_NAK
;

380 
h—d”
[0] = 
	`usb_g‘_modem_lšes
(
s
) | 1;

383 ià(
s
->
ev’t_Œigg”
 && s->ev’t_Œigg” & 
FTDI_BI
) {

384 
s
->
ev’t_Œigg”
 &ğ~
FTDI_BI
;

385 
h—d”
[1] = 
FTDI_BI
;

386 
	`usb_·ck‘_cİy
(
p
, 
h—d”
, 2);

387 
»t
 = 2;

390 
h—d”
[1] = 0;

392 
Ën
 -= 2;

393 ià(
Ën
 > 
s
->
»cv_u£d
)

394 
Ën
 = 
s
->
»cv_u£d
;

395 ià(!
Ën
) {

396 
»t
 = 
USB_RET_NAK
;

399 ià(
fœ¡_Ën
 > 
Ën
)

400 
fœ¡_Ën
 = 
Ën
;

401 
	`usb_·ck‘_cİy
(
p
, 
h—d”
, 2);

402 
	`usb_·ck‘_cİy
(
p
, 
s
->
»cv_buf
 + s->
»cv_±r
, 
fœ¡_Ën
);

403 ià(
Ën
 > 
fœ¡_Ën
)

404 
	`usb_·ck‘_cİy
(
p
, 
s
->
»cv_buf
, 
Ën
 - 
fœ¡_Ën
);

405 
s
->
»cv_u£d
 -ğ
Ën
;

406 
s
->
»cv_±r
 = (s->»cv_±¸+ 
Ën
è% 
RECV_BUF
;

407 
»t
 = 
Ën
 + 2;

411 
	`DPRINTF
("Badoken\n");

412 
ç
:

413 
»t
 = 
USB_RET_STALL
;

417  
»t
;

418 
	}
}

420 
	$usb_£rŸl_hªdË_de¡roy
(
USBDeviû
 *
dev
)

422 
USBS”ŸlS‹
 *
s
 = (USBS”ŸlS‹ *)
dev
;

424 
	`qemu_chr_d–‘e
(
s
->
cs
);

425 
	}
}

427 
	$usb_£rŸl_ÿn_»ad
(*
İaque
)

429 
USBS”ŸlS‹
 *
s
 = 
İaque
;

430  
RECV_BUF
 - 
s
->
»cv_u£d
;

431 
	}
}

433 
	$usb_£rŸl_»ad
(*
İaque
, cÚ¡ 
ušt8_t
 *
buf
, 
size
)

435 
USBS”ŸlS‹
 *
s
 = 
İaque
;

436 
fœ¡_size
, 
¡¬t
;

439 ià(
size
 > (
RECV_BUF
 - 
s
->
»cv_u£d
))

440 
size
 = 
RECV_BUF
 - 
s
->
»cv_u£d
;

442 
¡¬t
 = 
s
->
»cv_±r
 + s->
»cv_u£d
;

443 ià(
¡¬t
 < 
RECV_BUF
) {

445 
fœ¡_size
 = 
RECV_BUF
 - 
¡¬t
;

446 ià(
fœ¡_size
 > 
size
)

447 
fœ¡_size
 = 
size
;

449 
	`memıy
(
s
->
»cv_buf
 + 
¡¬t
, 
buf
, 
fœ¡_size
);

452 ià(
size
 > 
fœ¡_size
)

453 
	`memıy
(
s
->
»cv_buf
, 
buf
 + 
fœ¡_size
, 
size
 - first_size);

455 
¡¬t
 -ğ
RECV_BUF
;

456 
	`memıy
(
s
->
»cv_buf
 + 
¡¬t
, 
buf
, 
size
);

458 
s
->
»cv_u£d
 +ğ
size
;

459 
	}
}

461 
	$usb_£rŸl_ev’t
(*
İaque
, 
ev’t
)

463 
USBS”ŸlS‹
 *
s
 = 
İaque
;

465 
ev’t
) {

466 
CHR_EVENT_BREAK
:

467 
s
->
ev’t_Œigg”
 |ğ
FTDI_BI
;

469 
CHR_EVENT_FOCUS
:

471 
CHR_EVENT_OPENED
:

472 
	`usb_£rŸl_»£t
(
s
);

476 
	}
}

478 
	$usb_£rŸl_š™â
(
USBDeviû
 *
dev
)

480 
USBS”ŸlS‹
 *
s
 = 
	`DO_UPCAST
(USBS”ŸlS‹, 
dev
, dev);

482 
	`usb_desc_ü—‹_£rŸl
(
dev
);

483 
	`usb_desc_š™
(
dev
);

485 ià(!
s
->
cs
) {

486 
	`”rÜ_»pÜt
("Property chardev is„equired");

490 
	`qemu_chr_add_hªdËrs
(
s
->
cs
, 
usb_£rŸl_ÿn_»ad
, 
usb_£rŸl_»ad
,

491 
usb_£rŸl_ev’t
, 
s
);

492 
	`usb_£rŸl_hªdË_»£t
(
dev
);

494 
	}
}

496 
USBDeviû
 *
	$usb_£rŸl_š™
(
USBBus
 *
bus
, cÚ¡ *
f’ame
)

498 
USBDeviû
 *
dev
;

499 
Ch¬Driv”S‹
 *
cdrv
;

500 
ušt32_t
 
v’dÜid
 = 0, 
´oduùid
 = 0;

501 
Ïb–
[32];

502 
šdex
;

504 *
f’ame
 && *filename != ':') {

505 cÚ¡ *
p
;

506 *
e
;

507 ià(
	`¡r¡¬t
(
f’ame
, "v’dÜid=", &
p
)) {

508 
v’dÜid
 = 
	`¡¹Ş
(
p
, &
e
, 16);

509 ià(
e
 =ğ
p
 || (*e && *e != ',' && *e != ':')) {

510 
	`”rÜ_»pÜt
("bogu v’dÜ ID %s", 
p
);

511  
NULL
;

513 
f’ame
 = 
e
;

514 } ià(
	`¡r¡¬t
(
f’ame
, "´oduùid=", &
p
)) {

515 
´oduùid
 = 
	`¡¹Ş
(
p
, &
e
, 16);

516 ià(
e
 =ğ
p
 || (*e && *e != ',' && *e != ':')) {

517 
	`”rÜ_»pÜt
("bogu ´oduù ID %s", 
p
);

518  
NULL
;

520 
f’ame
 = 
e
;

522 
	`”rÜ_»pÜt
("uÄecognized s”ŸÈUSB o±iÚ %s", 
f’ame
);

523  
NULL
;

525 *
f’ame
 == ',')

526 
f’ame
++;

528 ià(!*
f’ame
) {

529 
	`”rÜ_»pÜt
("character device specification‚eeded");

530  
NULL
;

532 
f’ame
++;

534 
	`¢´štf
(
Ïb–
, Öab–), "usb£rŸl%d", 
šdex
++);

535 
cdrv
 = 
	`qemu_chr_Ãw
(
Ïb–
, 
f’ame
, 
NULL
);

536 ià(!
cdrv
)

537  
NULL
;

539 
dev
 = 
	`usb_ü—‹
(
bus
, "usb-serial");

540 ià(!
dev
) {

541  
NULL
;

543 
	`qdev_´İ_£t_chr
(&
dev
->
qdev
, "ch¬dev", 
cdrv
);

544 ià(
v’dÜid
)

545 
	`qdev_´İ_£t_ušt16
(&
dev
->
qdev
, "v’dÜid", 
v’dÜid
);

546 ià(
´oduùid
)

547 
	`qdev_´İ_£t_ušt16
(&
dev
->
qdev
, "´oduùid", 
´oduùid
);

548 
	`qdev_š™_noç
(&
dev
->
qdev
);

550  
dev
;

551 
	}
}

553 
USBDeviû
 *
	$usb_b¿Ë_š™
(
USBBus
 *
bus
, cÚ¡ *
unu£d
)

555 
USBDeviû
 *
dev
;

556 
Ch¬Driv”S‹
 *
cdrv
;

558 
cdrv
 = 
	`qemu_chr_Ãw
("b¿Ë", "b¿Ë", 
NULL
);

559 ià(!
cdrv
)

560  
NULL
;

562 
dev
 = 
	`usb_ü—‹
(
bus
, "usb-braille");

563 
	`qdev_´İ_£t_chr
(&
dev
->
qdev
, "ch¬dev", 
cdrv
);

564 
	`qdev_š™_noç
(&
dev
->
qdev
);

566  
dev
;

567 
	}
}

569 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_£rŸl
 = {

570 .
Çme
 = "usb-serial",

571 .
	gunmig¿bË
 = 1,

574 
Prİ”ty
 
	g£rŸl_´İ”t›s
[] = {

575 
DEFINE_PROP_CHR
("ch¬dev", 
USBS”ŸlS‹
, 
cs
),

576 
DEFINE_PROP_END_OF_LIST
(),

579 
	$usb_£rŸl_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

581 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

582 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

584 
uc
->
š™
 = 
usb_£rŸl_š™â
;

585 
uc
->
´oduù_desc
 = "QEMU USB Serial";

586 
uc
->
usb_desc
 = &
desc_£rŸl
;

587 
uc
->
hªdË_»£t
 = 
usb_£rŸl_hªdË_»£t
;

588 
uc
->
hªdË_cÚŒŞ
 = 
usb_£rŸl_hªdË_cÚŒŞ
;

589 
uc
->
hªdË_d©a
 = 
usb_£rŸl_hªdË_d©a
;

590 
uc
->
hªdË_de¡roy
 = 
usb_£rŸl_hªdË_de¡roy
;

591 
dc
->
vmsd
 = &
vm¡©e_usb_£rŸl
;

592 
dc
->
´İs
 = 
£rŸl_´İ”t›s
;

593 
	}
}

595 
Ty³Info
 
	g£rŸl_šfo
 = {

596 .
Çme
 = "usb-serial",

597 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

598 .
	gš¡ªû_size
 = (
USBS”ŸlS‹
),

599 .
	gşass_š™
 = 
usb_£rŸl_şass_š™â
,

602 
Prİ”ty
 
	gb¿Ë_´İ”t›s
[] = {

603 
DEFINE_PROP_CHR
("ch¬dev", 
USBS”ŸlS‹
, 
cs
),

604 
DEFINE_PROP_END_OF_LIST
(),

607 
	$usb_b¿Ë_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

609 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

610 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

612 
uc
->
š™
 = 
usb_£rŸl_š™â
;

613 
uc
->
´oduù_desc
 = "QEMU USB Braille";

614 
uc
->
usb_desc
 = &
desc_b¿Ë
;

615 
uc
->
hªdË_»£t
 = 
usb_£rŸl_hªdË_»£t
;

616 
uc
->
hªdË_cÚŒŞ
 = 
usb_£rŸl_hªdË_cÚŒŞ
;

617 
uc
->
hªdË_d©a
 = 
usb_£rŸl_hªdË_d©a
;

618 
uc
->
hªdË_de¡roy
 = 
usb_£rŸl_hªdË_de¡roy
;

619 
dc
->
vmsd
 = &
vm¡©e_usb_£rŸl
;

620 
dc
->
´İs
 = 
b¿Ë_´İ”t›s
;

621 
	}
}

623 
Ty³Info
 
	gb¿Ë_šfo
 = {

624 .
Çme
 = "usb-braille",

625 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

626 .
	gš¡ªû_size
 = (
USBS”ŸlS‹
),

627 .
	gşass_š™
 = 
usb_b¿Ë_şass_š™â
,

630 
	$usb_£rŸl_»gi¡”_ty³s
()

632 
	`ty³_»gi¡”_¡©ic
(&
£rŸl_šfo
);

633 
	`usb_Ëgacy_»gi¡”
("usb-£rŸl", "£rŸl", 
usb_£rŸl_š™
);

634 
	`ty³_»gi¡”_¡©ic
(&
b¿Ë_šfo
);

635 
	`usb_Ëgacy_»gi¡”
("usb-b¿Ë", "b¿Ë", 
usb_b¿Ë_š™
);

636 
	}
}

638 
ty³_š™
(
usb_£rŸl_»gi¡”_ty³s
)

	@dev-smartcard-reader.c

37 
	~"qemu-commÚ.h
"

38 
	~"qemu-”rÜ.h
"

39 
	~"hw/usb.h
"

40 
	~"hw/usb/desc.h
"

41 
	~"mÚ™Ü.h
"

43 
	~"hw/ccid.h
"

45 
	#DPRINTF
(
s
, 
lvl
, 
fmt
, ...) \

47 ià(
lvl
 <ğ
s
->
debug
) { \

48 
	`´štf
("usb-ccid: " 
fmt
 , ## 
__VA_ARGS__
); \

50 } 0)

	)

52 
	#D_WARN
 1

	)

53 
	#D_INFO
 2

	)

54 
	#D_MORE_INFO
 3

	)

55 
	#D_VERBOSE
 4

	)

57 
	#CCID_DEV_NAME
 "usb-ccid"

	)

65 
	#BULK_OUT_DATA_SIZE
 65536

	)

66 
	#PENDING_ANSWERS_NUM
 128

	)

68 
	#BULK_IN_BUF_SIZE
 384

	)

69 
	#BULK_IN_PENDING_NUM
 8

	)

71 
	#IÁ”çûOutCÏss
 \

72 ((
USB_DIR_OUT
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
)<<8)

	)

74 
	#IÁ”çûInCÏss
 \

75 ((
USB_DIR_IN
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
)<<8)

	)

77 
	#CCID_MAX_PACKET_SIZE
 64

	)

79 
	#CCID_CONTROL_ABORT
 0x1

	)

80 
	#CCID_CONTROL_GET_CLOCK_FREQUENCIES
 0x2

	)

81 
	#CCID_CONTROL_GET_DATA_RATES
 0x3

	)

83 
	#CCID_PRODUCT_DESCRIPTION
 "QEMU USB CCID"

	)

84 
	#CCID_VENDOR_DESCRIPTION
 "QEMU"

	)

85 
	#CCID_INTERFACE_NAME
 "CCID IÁ”çû"

	)

86 
	#CCID_SERIAL_NUMBER_STRING
 "1"

	)

94 
	#CCID_VENDOR_ID
 0x08e6

	)

95 
	#CCID_PRODUCT_ID
 0x4433

	)

96 
	#CCID_DEVICE_VERSION
 0x0000

	)

102 
	#CCID_MESSAGE_TYPE_PC_to_RDR_IccPow”On
 0x62

	)

103 
	#CCID_MESSAGE_TYPE_PC_to_RDR_IccPow”Off
 0x63

	)

104 
	#CCID_MESSAGE_TYPE_PC_to_RDR_G‘SlÙStus
 0x65

	)

105 
	#CCID_MESSAGE_TYPE_PC_to_RDR_XäBlock
 0x6f

	)

106 
	#CCID_MESSAGE_TYPE_PC_to_RDR_G‘P¬am‘”s
 0x6c

	)

107 
	#CCID_MESSAGE_TYPE_PC_to_RDR_Re£tP¬am‘”s
 0x6d

	)

108 
	#CCID_MESSAGE_TYPE_PC_to_RDR_S‘P¬am‘”s
 0x61

	)

109 
	#CCID_MESSAGE_TYPE_PC_to_RDR_Esÿ³
 0x6b

	)

110 
	#CCID_MESSAGE_TYPE_PC_to_RDR_IccClock
 0x6e

	)

111 
	#CCID_MESSAGE_TYPE_PC_to_RDR_T0APDU
 0x6a

	)

112 
	#CCID_MESSAGE_TYPE_PC_to_RDR_Secu»
 0x69

	)

113 
	#CCID_MESSAGE_TYPE_PC_to_RDR_Mechªiÿl
 0x71

	)

114 
	#CCID_MESSAGE_TYPE_PC_to_RDR_AbÜt
 0x72

	)

115 
	#CCID_MESSAGE_TYPE_PC_to_RDR_S‘D©aR©eAndClockF»qu’cy
 0x73

	)

121 
	#CCID_MESSAGE_TYPE_RDR_to_PC_D©aBlock
 0x80

	)

122 
	#CCID_MESSAGE_TYPE_RDR_to_PC_SlÙStus
 0x81

	)

123 
	#CCID_MESSAGE_TYPE_RDR_to_PC_P¬am‘”s
 0x82

	)

124 
	#CCID_MESSAGE_TYPE_RDR_to_PC_Esÿ³
 0x83

	)

125 
	#CCID_MESSAGE_TYPE_RDR_to_PC_D©aR©eAndClockF»qu’cy
 0x84

	)

131 
	#CCID_MESSAGE_TYPE_RDR_to_PC_NÙifySlÙChªge
 0x50

	)

132 
	#CCID_MESSAGE_TYPE_RDR_to_PC_H¬dw¬eE¼Ü
 0x51

	)

140 
	#CCID_INT_IN_EP
 1

	)

141 
	#CCID_BULK_IN_EP
 2

	)

142 
	#CCID_BULK_OUT_EP
 3

	)

145 
	#SLOT_0_STATE_MASK
 1

	)

146 
	#SLOT_0_CHANGED_MASK
 2

	)

150 
	mICC_STATUS_PRESENT_ACTIVE
 = 0,

151 
	mICC_STATUS_PRESENT_INACTIVE
,

152 
	mICC_STATUS_NOT_PRESENT


156 
	mCOMMAND_STATUS_NO_ERROR
 = 0,

157 
	mCOMMAND_STATUS_FAILED
,

158 
	mCOMMAND_STATUS_TIME_EXTENSION_REQUIRED


163 
	mERROR_CMD_NOT_SUPPORTED
 = 0,

164 
	mERROR_CMD_ABORTED
 = -1,

165 
	mERROR_ICC_MUTE
 = -2,

166 
	mERROR_XFR_PARITY_ERROR
 = -3,

167 
	mERROR_XFR_OVERRUN
 = -4,

168 
	mERROR_HW_ERROR
 = -5,

173 
	mCLOCK_STATUS_RUNNING
 = 0,

180 
QEMU_PACKED
 
	tCCID_H—d”
 {

181 
ušt8_t
 
	gbMes§geTy³
;

182 
ušt32_t
 
	gdwL’gth
;

183 
ušt8_t
 
	gbSlÙ
;

184 
ušt8_t
 
	gbSeq
;

185 } 
	tCCID_H—d”
;

187 
QEMU_PACKED
 
	tCCID_BULK_IN
 {

188 
CCID_H—d”
 
	ghdr
;

189 
ušt8_t
 
	gbStus
;

190 
ušt8_t
 
	gbE¼Ü
;

191 } 
	tCCID_BULK_IN
;

193 
QEMU_PACKED
 
	tCCID_SlÙStus
 {

194 
CCID_BULK_IN
 
	gb
;

195 
ušt8_t
 
	gbClockStus
;

196 } 
	tCCID_SlÙStus
;

198 
QEMU_PACKED
 
	tCCID_P¬am‘”
 {

199 
CCID_BULK_IN
 
	gb
;

200 
ušt8_t
 
	gbPrÙocŞNum
;

201 
ušt8_t
 
	gabPrÙocŞD©aSŒuùu»
[0];

202 } 
	tCCID_P¬am‘”
;

204 
QEMU_PACKED
 
	tCCID_D©aBlock
 {

205 
CCID_BULK_IN
 
	gb
;

206 
ušt8_t
 
	gbChašP¬am‘”
;

207 
ušt8_t
 
	gabD©a
[0];

208 } 
	tCCID_D©aBlock
;

211 
QEMU_PACKED
 
	tCCID_XãrBlock
 {

212 
CCID_H—d”
 
	ghdr
;

213 
ušt8_t
 
	gbBWI
;

214 
ušt16_t
 
	gwLev–P¬am‘”
;

215 
ušt8_t
 
	gabD©a
[0];

216 } 
	tCCID_XãrBlock
;

218 
QEMU_PACKED
 
	tCCID_IccPow”On
 {

219 
CCID_H—d”
 
	ghdr
;

220 
ušt8_t
 
	gbPow”S–eù
;

221 
ušt16_t
 
	gabRFU
;

222 } 
	tCCID_IccPow”On
;

224 
QEMU_PACKED
 
	tCCID_IccPow”Off
 {

225 
CCID_H—d”
 
	ghdr
;

226 
ušt16_t
 
	gabRFU
;

227 } 
	tCCID_IccPow”Off
;

229 
QEMU_PACKED
 
	tCCID_S‘P¬am‘”s
 {

230 
CCID_H—d”
 
	ghdr
;

231 
ušt8_t
 
	gbPrÙocŞNum
;

232 
ušt16_t
 
	gabRFU
;

233 
ušt8_t
 
	gabPrÙocŞD©aSŒuùu»
[0];

234 } 
	tCCID_S‘P¬am‘”s
;

236 
	sCCID_NÙify_SlÙ_Chªge
 {

237 
ušt8_t
 
	mbMes§geTy³
;

238 
ušt8_t
 
	mbmSlÙICCS‹
;

239 } 
	tCCID_NÙify_SlÙ_Chªge
;

242 
	sAnsw”
 {

243 
ušt8_t
 
	m¦Ù
;

244 
ušt8_t
 
	m£q
;

245 } 
	tAnsw”
;

248 
	sBulkIn
 {

249 
ušt8_t
 
	md©a
[
BULK_IN_BUF_SIZE
];

250 
ušt32_t
 
	mËn
;

251 
ušt32_t
 
	mpos
;

252 } 
	tBulkIn
;

255 
	mMIGRATION_NONE
,

256 
	mMIGRATION_MIGRATED
,

259 
	sCCIDBus
 {

260 
BusS‹
 
	mqbus
;

261 } 
	tCCIDBus
;

263 
	#MAX_PROTOCOL_SIZE
 7

	)

268 
	sUSBCCIDS‹
 {

269 
USBDeviû
 
	mdev
;

270 
USBEndpošt
 *
	mšŒ
;

271 
CCIDBus
 
	mbus
;

272 
CCIDC¬dS‹
 *
	mÿrd
;

273 
BulkIn
 
	mbulk_š_³ndšg
[
BULK_IN_PENDING_NUM
];

274 
ušt32_t
 
	mbulk_š_³ndšg_¡¬t
;

275 
ušt32_t
 
	mbulk_š_³ndšg_’d
;

276 
ušt32_t
 
	mbulk_š_³ndšg_num
;

277 
BulkIn
 *
	mcu¼’t_bulk_š
;

278 
ušt8_t
 
	mbulk_out_d©a
[
BULK_OUT_DATA_SIZE
];

279 
ušt32_t
 
	mbulk_out_pos
;

280 
ušt64_t
 
	mÏ¡_ªsw”_”rÜ
;

281 
Answ”
 
	m³ndšg_ªsw”s
[
PENDING_ANSWERS_NUM
];

282 
ušt32_t
 
	m³ndšg_ªsw”s_¡¬t
;

283 
ušt32_t
 
	m³ndšg_ªsw”s_’d
;

284 
ušt32_t
 
	m³ndšg_ªsw”s_num
;

285 
ušt8_t
 
	mbE¼Ü
;

286 
ušt8_t
 
	mbmCommªdStus
;

287 
ušt8_t
 
	mbPrÙocŞNum
;

288 
ušt8_t
 
	mabPrÙocŞD©aSŒuùu»
[
MAX_PROTOCOL_SIZE
];

289 
ušt32_t
 
	mulPrÙocŞD©aSŒuùu»Size
;

290 
ušt32_t
 
	m¡©e_vm¡©e
;

291 
ušt32_t
 
	mmig¿tiÚ_rg‘_
;

292 
ušt16_t
 
	mmig¿tiÚ_rg‘_pÜt
;

293 
ušt8_t
 
	mmig¿tiÚ_¡©e
;

294 
ušt8_t
 
	mbmSlÙICCS‹
;

295 
ušt8_t
 
	mpow”ed
;

296 
ušt8_t
 
	mnÙify_¦Ù_chªge
;

297 
ušt8_t
 
	mdebug
;

298 } 
	tUSBCCIDS‹
;

310 cÚ¡ 
ušt8_t
 
	gqemu_ccid_desütÜ
[] = {

397 
	mSTR_MANUFACTURER
 = 1,

398 
	mSTR_PRODUCT
,

399 
	mSTR_SERIALNUMBER
,

400 
	mSTR_INTERFACE
,

403 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

404 [
STR_MANUFACTURER
] = "QEMU",

405 [
STR_PRODUCT
] = "QEMU USB CCID",

406 [
STR_SERIALNUMBER
] = "1",

407 [
STR_INTERFACE
] = "CCID Interface",

410 cÚ¡ 
USBDescIçû
 
	gdesc_içû0
 = {

411 .
bIÁ”çûNumb”
 = 0,

412 .
	gbNumEndpošts
 = 3,

413 .
	gbIÁ”çûCÏss
 = 0x0b,

414 .
	gbIÁ”çûSubCÏss
 = 0x00,

415 .
	gbIÁ”çûPrÙocŞ
 = 0x00,

416 .
	giIÁ”çû
 = 
STR_INTERFACE
,

417 .
	gndesc
 = 1,

418 .
	gdescs
 = (
USBDescOth”
[]) {

421 .
d©a
 = 
qemu_ccid_desütÜ
,

424 .
	g•s
 = (
USBDescEndpošt
[]) {

426 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
CCID_INT_IN_EP
,

427 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

428 .
	gbIÁ”v®
 = 255,

429 .
	gwMaxPack‘Size
 = 64,

431 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
CCID_BULK_IN_EP
,

432 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

433 .
	gwMaxPack‘Size
 = 64,

435 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
CCID_BULK_OUT_EP
,

436 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

437 .
	gwMaxPack‘Size
 = 64,

442 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû
 = {

443 .
bcdUSB
 = 0x0110,

444 .
	gbMaxPack‘Size0
 = 64,

445 .
	gbNumCÚfigu¿tiÚs
 = 1,

446 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

448 .
bNumIÁ”çûs
 = 1,

449 .
	gbCÚfigu¿tiÚV®ue
 = 1,

450 .
	gbmA‰ribu‹s
 = 0xe0,

451 .
	gbMaxPow”
 = 50,

452 .
	gnif
 = 1,

453 .
	gifs
 = &
desc_içû0
,

458 cÚ¡ 
USBDesc
 
	gdesc_ccid
 = {

459 .
id
 = {

460 .
idV’dÜ
 = 
CCID_VENDOR_ID
,

461 .
	gidProduù
 = 
CCID_PRODUCT_ID
,

462 .
	gbcdDeviû
 = 
CCID_DEVICE_VERSION
,

463 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

464 .
	giProduù
 = 
STR_PRODUCT
,

465 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

467 .
	gfuÎ
 = &
desc_deviû
,

468 .
	g¡r
 = 
desc_¡ršgs
,

471 cÚ¡ 
ušt8_t
 *
	$ccid_ÿrd_g‘_©r
(
CCIDC¬dS‹
 *
ÿrd
, 
ušt32_t
 *
Ën
)

473 
CCIDC¬dCÏss
 *
cc
 = 
	`CCID_CARD_GET_CLASS
(
ÿrd
);

474 ià(
cc
->
g‘_©r
) {

475  
cc
->
	`g‘_©r
(
ÿrd
, 
Ën
);

477  
NULL
;

478 
	}
}

480 
	$ccid_ÿrd_­du_äom_gue¡
(
CCIDC¬dS‹
 *
ÿrd
,

481 cÚ¡ 
ušt8_t
 *
­du
,

482 
ušt32_t
 
Ën
)

484 
CCIDC¬dCÏss
 *
cc
 = 
	`CCID_CARD_GET_CLASS
(
ÿrd
);

485 ià(
cc
->
­du_äom_gue¡
) {

486 
cc
->
	`­du_äom_gue¡
(
ÿrd
, 
­du
, 
Ën
);

488 
	}
}

490 
	$ccid_ÿrd_ex™â
(
CCIDC¬dS‹
 *
ÿrd
)

492 
CCIDC¬dCÏss
 *
cc
 = 
	`CCID_CARD_GET_CLASS
(
ÿrd
);

493 ià(
cc
->
ex™â
) {

494  
cc
->
	`ex™â
(
ÿrd
);

497 
	}
}

499 
	$ccid_ÿrd_š™â
(
CCIDC¬dS‹
 *
ÿrd
)

501 
CCIDC¬dCÏss
 *
cc
 = 
	`CCID_CARD_GET_CLASS
(
ÿrd
);

502 ià(
cc
->
š™â
) {

503  
cc
->
	`š™â
(
ÿrd
);

506 
	}
}

508 
boŞ
 
	$ccid_has_³ndšg_ªsw”s
(
USBCCIDS‹
 *
s
)

510  
s
->
³ndšg_ªsw”s_num
 > 0;

511 
	}
}

513 
	$ccid_ş—r_³ndšg_ªsw”s
(
USBCCIDS‹
 *
s
)

515 
s
->
³ndšg_ªsw”s_num
 = 0;

516 
s
->
³ndšg_ªsw”s_¡¬t
 = 0;

517 
s
->
³ndšg_ªsw”s_’d
 = 0;

518 
	}
}

520 
	$ccid_´št_³ndšg_ªsw”s
(
USBCCIDS‹
 *
s
)

522 
Answ”
 *
ªsw”
;

523 
i
, 
couÁ
;

525 
	`DPRINTF
(
s
, 
D_VERBOSE
, "usb-ccid:…ending‡nswers:");

526 ià(!
	`ccid_has_³ndšg_ªsw”s
(
s
)) {

527 
	`DPRINTF
(
s
, 
D_VERBOSE
, "ƒmpty\n");

530 
i
 = 
s
->
³ndšg_ªsw”s_¡¬t
, 
couÁ
 = s->
³ndšg_ªsw”s_num
 ;

531 
couÁ
 > 0; couÁ--, 
i
++) {

532 
ªsw”
 = &
s
->
³ndšg_ªsw”s
[
i
 % 
PENDING_ANSWERS_NUM
];

533 ià(
couÁ
 == 1) {

534 
	`DPRINTF
(
s
, 
D_VERBOSE
, "%d:%d\n", 
ªsw”
->
¦Ù
,‡nsw”->
£q
);

536 
	`DPRINTF
(
s
, 
D_VERBOSE
, "%d:%d,", 
ªsw”
->
¦Ù
,‡nsw”->
£q
);

539 
	}
}

541 
	$ccid_add_³ndšg_ªsw”
(
USBCCIDS‹
 *
s
, 
CCID_H—d”
 *
hdr
)

543 
Answ”
 *
ªsw”
;

545 
	`as£¹
(
s
->
³ndšg_ªsw”s_num
 < 
PENDING_ANSWERS_NUM
);

546 
s
->
³ndšg_ªsw”s_num
++;

547 
ªsw”
 =

548 &
s
->
³ndšg_ªsw”s
[(s->
³ndšg_ªsw”s_’d
++è% 
PENDING_ANSWERS_NUM
];

549 
ªsw”
->
¦Ù
 = 
hdr
->
bSlÙ
;

550 
ªsw”
->
£q
 = 
hdr
->
bSeq
;

551 
	`ccid_´št_³ndšg_ªsw”s
(
s
);

552 
	}
}

554 
	$ccid_»move_³ndšg_ªsw”
(
USBCCIDS‹
 *
s
,

555 
ušt8_t
 *
¦Ù
, ušt8_ˆ*
£q
)

557 
Answ”
 *
ªsw”
;

559 
	`as£¹
(
s
->
³ndšg_ªsw”s_num
 > 0);

560 
s
->
³ndšg_ªsw”s_num
--;

561 
ªsw”
 =

562 &
s
->
³ndšg_ªsw”s
[(s->
³ndšg_ªsw”s_¡¬t
++è% 
PENDING_ANSWERS_NUM
];

563 *
¦Ù
 = 
ªsw”
->slot;

564 *
£q
 = 
ªsw”
->seq;

565 
	`ccid_´št_³ndšg_ªsw”s
(
s
);

566 
	}
}

568 
	$ccid_bulk_š_ş—r
(
USBCCIDS‹
 *
s
)

570 
s
->
bulk_š_³ndšg_¡¬t
 = 0;

571 
s
->
bulk_š_³ndšg_’d
 = 0;

572 
s
->
bulk_š_³ndšg_num
 = 0;

573 
	}
}

575 
	$ccid_bulk_š_»Ëa£
(
USBCCIDS‹
 *
s
)

577 
	`as£¹
(
s
->
cu¼’t_bulk_š
 !ğ
NULL
);

578 
s
->
cu¼’t_bulk_š
->
pos
 = 0;

579 
s
->
cu¼’t_bulk_š
 = 
NULL
;

580 
	}
}

582 
	$ccid_bulk_š_g‘
(
USBCCIDS‹
 *
s
)

584 ià(
s
->
cu¼’t_bulk_š
 !ğ
NULL
 || s->
bulk_š_³ndšg_num
 == 0) {

587 
	`as£¹
(
s
->
bulk_š_³ndšg_num
 > 0);

588 
s
->
bulk_š_³ndšg_num
--;

589 
s
->
cu¼’t_bulk_š
 =

590 &
s
->
bulk_š_³ndšg
[(s->
bulk_š_³ndšg_¡¬t
++è% 
BULK_IN_PENDING_NUM
];

591 
	}
}

593 *
	$ccid_»£rve_»cv_buf
(
USBCCIDS‹
 *
s
, 
ušt16_t
 
Ën
)

595 
BulkIn
 *
bulk_š
;

597 
	`DPRINTF
(
s
, 
D_VERBOSE
, "%s: QUEUE:„e£rv%d by‹s\n", 
__func__
, 
Ën
);

600 ià(
Ën
 > 
BULK_IN_BUF_SIZE
) {

601 
	`DPRINTF
(
s
, 
D_WARN
, "usb-ccid.c: %s:†en†argerhen max (%d>%d). "

603 
__func__
, 
Ën
, 
BULK_IN_BUF_SIZE
);

604  
NULL
;

606 ià(
s
->
bulk_š_³ndšg_num
 >ğ
BULK_IN_PENDING_NUM
) {

607 
	`DPRINTF
(
s
, 
D_WARN
, "usb-ccid.c: %s: No free bulk_in buffers. "

608 "disÿrdšg mes§ge.\n", 
__func__
);

609  
NULL
;

611 
bulk_š
 =

612 &
s
->
bulk_š_³ndšg
[(s->
bulk_š_³ndšg_’d
++è% 
BULK_IN_PENDING_NUM
];

613 
s
->
bulk_š_³ndšg_num
++;

614 
bulk_š
->
Ën
 =†en;

615  
bulk_š
->
d©a
;

616 
	}
}

618 
	$ccid_»£t
(
USBCCIDS‹
 *
s
)

620 
	`ccid_bulk_š_ş—r
(
s
);

621 
	`ccid_ş—r_³ndšg_ªsw”s
(
s
);

622 
	}
}

624 
	$ccid_d‘ach
(
USBCCIDS‹
 *
s
)

626 
	`ccid_»£t
(
s
);

627 
	}
}

629 
	$ccid_hªdË_»£t
(
USBDeviû
 *
dev
)

631 
USBCCIDS‹
 *
s
 = 
	`DO_UPCAST
(USBCCIDS‹, 
dev
, dev);

633 
	`DPRINTF
(
s
, 1, "Reset\n");

635 
	`ccid_»£t
(
s
);

636 
	}
}

638 
	$ccid_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
, 
»que¡
,

639 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

641 
USBCCIDS‹
 *
s
 = 
	`DO_UPCAST
(USBCCIDS‹, 
dev
, dev);

642 
»t
 = 0;

644 
	`DPRINTF
(
s
, 1, "gÙ cÚŒŞ %x, v®u%x\n", 
»que¡
, 
v®ue
);

645 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

646 ià(
»t
 >= 0) {

647  
»t
;

650 
»que¡
) {

652 
IÁ”çûOutCÏss
 | 
CCID_CONTROL_ABORT
:

653 
	`DPRINTF
(
s
, 1, "ccid_control‡bort UNIMPLEMENTED\n");

654 
»t
 = 
USB_RET_STALL
;

656 
IÁ”çûInCÏss
 | 
CCID_CONTROL_GET_CLOCK_FREQUENCIES
:

657 
	`DPRINTF
(
s
, 1, "ccid_control get clock frequencies UNIMPLEMENTED\n");

658 
»t
 = 
USB_RET_STALL
;

660 
IÁ”çûInCÏss
 | 
CCID_CONTROL_GET_DATA_RATES
:

661 
	`DPRINTF
(
s
, 1, "ccid_control get data„ates UNIMPLEMENTED\n");

662 
»t
 = 
USB_RET_STALL
;

665 
	`DPRINTF
(
s
, 1, "got unsupported/bogus control %x, value %x\n",

666 
»que¡
, 
v®ue
);

667 
»t
 = 
USB_RET_STALL
;

670  
»t
;

671 
	}
}

673 
boŞ
 
	$ccid_ÿrd_š£¹ed
(
USBCCIDS‹
 *
s
)

675  
s
->
bmSlÙICCS‹
 & 
SLOT_0_STATE_MASK
;

676 
	}
}

678 
ušt8_t
 
	$ccid_ÿrd_¡©us
(
USBCCIDS‹
 *
s
)

680  
	`ccid_ÿrd_š£¹ed
(
s
)

681 ? (
s
->
pow”ed
 ?

682 
ICC_STATUS_PRESENT_ACTIVE


683 : 
ICC_STATUS_PRESENT_INACTIVE


685 : 
ICC_STATUS_NOT_PRESENT
;

686 
	}
}

688 
ušt8_t
 
	$ccid_ÿlc_¡©us
(
USBCCIDS‹
 *
s
)

694 
ušt8_t
 
»t
 = 
	`ccid_ÿrd_¡©us
(
s
è| (s->
bmCommªdStus
 << 6);

695 
	`DPRINTF
(
s
, 
D_VERBOSE
, "¡©u ğ%d\n", 
»t
);

696  
»t
;

697 
	}
}

699 
	$ccid_»£t_”rÜ_¡©us
(
USBCCIDS‹
 *
s
)

701 
s
->
bE¼Ü
 = 
ERROR_CMD_NOT_SUPPORTED
;

702 
s
->
bmCommªdStus
 = 
COMMAND_STATUS_NO_ERROR
;

703 
	}
}

705 
	$ccid_wr™e_¦Ù_¡©us
(
USBCCIDS‹
 *
s
, 
CCID_H—d”
 *
»cv
)

707 
CCID_SlÙStus
 *
h
 = 
	`ccid_»£rve_»cv_buf
(
s
, (CCID_SlotStatus));

708 ià(
h
 =ğ
NULL
) {

711 
h
->
b
.
hdr
.
bMes§geTy³
 = 
CCID_MESSAGE_TYPE_RDR_to_PC_SlÙStus
;

712 
h
->
b
.
hdr
.
dwL’gth
 = 0;

713 
h
->
b
.
hdr
.
bSlÙ
 = 
»cv
->bSlot;

714 
h
->
b
.
hdr
.
bSeq
 = 
»cv
->bSeq;

715 
h
->
b
.
bStus
 = 
	`ccid_ÿlc_¡©us
(
s
);

716 
h
->
b
.
bE¼Ü
 = 
s
->bError;

717 
h
->
bClockStus
 = 
CLOCK_STATUS_RUNNING
;

718 
	`ccid_»£t_”rÜ_¡©us
(
s
);

719 
	}
}

721 
	$ccid_wr™e_·¿m‘”s
(
USBCCIDS‹
 *
s
, 
CCID_H—d”
 *
»cv
)

723 
CCID_P¬am‘”
 *
h
;

724 
ušt32_t
 
Ën
 = 
s
->
ulPrÙocŞD©aSŒuùu»Size
;

726 
h
 = 
	`ccid_»£rve_»cv_buf
(
s
, (
CCID_P¬am‘”
è+ 
Ën
);

727 ià(
h
 =ğ
NULL
) {

730 
h
->
b
.
hdr
.
bMes§geTy³
 = 
CCID_MESSAGE_TYPE_RDR_to_PC_P¬am‘”s
;

731 
h
->
b
.
hdr
.
dwL’gth
 = 0;

732 
h
->
b
.
hdr
.
bSlÙ
 = 
»cv
->bSlot;

733 
h
->
b
.
hdr
.
bSeq
 = 
»cv
->bSeq;

734 
h
->
b
.
bStus
 = 
	`ccid_ÿlc_¡©us
(
s
);

735 
h
->
b
.
bE¼Ü
 = 
s
->bError;

736 
h
->
bPrÙocŞNum
 = 
s
->bProtocolNum;

737 
	`memıy
(
h
->
abPrÙocŞD©aSŒuùu»
, 
s
->abPrÙocŞD©aSŒuùu», 
Ën
);

738 
	`ccid_»£t_”rÜ_¡©us
(
s
);

739 
	}
}

741 
	$ccid_wr™e_d©a_block
(
USBCCIDS‹
 *
s
, 
ušt8_t
 
¦Ù
, ušt8_ˆ
£q
,

742 cÚ¡ 
ušt8_t
 *
d©a
, 
ušt32_t
 
Ën
)

744 
CCID_D©aBlock
 *
p
 = 
	`ccid_»£rve_»cv_buf
(
s
, (*pè+ 
Ën
);

746 ià(
p
 =ğ
NULL
) {

749 
p
->
b
.
hdr
.
bMes§geTy³
 = 
CCID_MESSAGE_TYPE_RDR_to_PC_D©aBlock
;

750 
p
->
b
.
hdr
.
dwL’gth
 = 
	`ıu_to_Ë32
(
Ën
);

751 
p
->
b
.
hdr
.
bSlÙ
 = 
¦Ù
;

752 
p
->
b
.
hdr
.
bSeq
 = 
£q
;

753 
p
->
b
.
bStus
 = 
	`ccid_ÿlc_¡©us
(
s
);

754 
p
->
b
.
bE¼Ü
 = 
s
->bError;

755 ià(
p
->
b
.
bE¼Ü
) {

756 
	`DPRINTF
(
s
, 
D_VERBOSE
, "”rÜ %d", 
p
->
b
.
bE¼Ü
);

758 
	`memıy
(
p
->
abD©a
, 
d©a
, 
Ën
);

759 
	`ccid_»£t_”rÜ_¡©us
(
s
);

760 
	}
}

762 
	$ccid_wr™e_d©a_block_ªsw”
(
USBCCIDS‹
 *
s
,

763 cÚ¡ 
ušt8_t
 *
d©a
, 
ušt32_t
 
Ën
)

765 
ušt8_t
 
£q
;

766 
ušt8_t
 
¦Ù
;

768 ià(!
	`ccid_has_³ndšg_ªsw”s
(
s
)) {

769 
	`abÜt
();

771 
	`ccid_»move_³ndšg_ªsw”
(
s
, &
¦Ù
, &
£q
);

772 
	`ccid_wr™e_d©a_block
(
s
, 
¦Ù
, 
£q
, 
d©a
, 
Ën
);

773 
	}
}

775 
	$ccid_wr™e_d©a_block_©r
(
USBCCIDS‹
 *
s
, 
CCID_H—d”
 *
»cv
)

777 cÚ¡ 
ušt8_t
 *
©r
 = 
NULL
;

778 
ušt32_t
 
Ën
 = 0;

780 ià(
s
->
ÿrd
) {

781 
©r
 = 
	`ccid_ÿrd_g‘_©r
(
s
->
ÿrd
, &
Ën
);

783 
	`ccid_wr™e_d©a_block
(
s
, 
»cv
->
bSlÙ
,„ecv->
bSeq
, 
©r
, 
Ën
);

784 
	}
}

786 
	$ccid_£t_·¿m‘”s
(
USBCCIDS‹
 *
s
, 
CCID_H—d”
 *
»cv
)

788 
CCID_S‘P¬am‘”s
 *
ph
 = (CCID_S‘P¬am‘” *è
»cv
;

789 
ušt32_t
 
Ën
 = 0;

790 ià((
ph
->
bPrÙocŞNum
 & 3) == 0) {

791 
Ën
 = 5;

793 ià((
ph
->
bPrÙocŞNum
 & 3) == 1) {

794 
Ën
 = 7;

796 ià(
Ën
 == 0) {

797 
s
->
bmCommªdStus
 = 
COMMAND_STATUS_FAILED
;

798 
s
->
bE¼Ü
 = 7;

801 
s
->
bPrÙocŞNum
 = 
ph
->bProtocolNum;

802 
	`memıy
(
s
->
abPrÙocŞD©aSŒuùu»
, 
ph
->abPrÙocŞD©aSŒuùu», 
Ën
);

803 
s
->
ulPrÙocŞD©aSŒuùu»Size
 = 
Ën
;

804 
	`DPRINTF
(
s
, 1, "%s: usšg†’ %d\n", 
__func__
, 
Ën
);

805 
	}
}

811 cÚ¡ 
ušt8_t
 
	gabDeçuÉPrÙocŞD©aSŒuùu»
[7] = {

814 
	$ccid_»£t_·¿m‘”s
(
USBCCIDS‹
 *
s
)

816 
ušt32_t
 
Ën
 = (
abDeçuÉPrÙocŞD©aSŒuùu»
);

818 
s
->
bPrÙocŞNum
 = 1;

819 
s
->
ulPrÙocŞD©aSŒuùu»Size
 = 
Ën
;

820 
	`memıy
(
s
->
abPrÙocŞD©aSŒuùu»
, 
abDeçuÉPrÙocŞD©aSŒuùu»
, 
Ën
);

821 
	}
}

823 
	$ccid_»pÜt_”rÜ_çed
(
USBCCIDS‹
 *
s
, 
ušt8_t
 
”rÜ
)

825 
s
->
bmCommªdStus
 = 
COMMAND_STATUS_FAILED
;

826 
s
->
bE¼Ü
 = 
”rÜ
;

827 
	}
}

830 
	$ccid_Ú_¦Ù_chªge
(
USBCCIDS‹
 *
s
, 
boŞ
 
fuÎ
)

833 
ušt8_t
 
cu¼’t
 = 
s
->
bmSlÙICCS‹
;

834 ià(
fuÎ
) {

835 
s
->
bmSlÙICCS‹
 |ğ
SLOT_0_STATE_MASK
;

837 
s
->
bmSlÙICCS‹
 &ğ~
SLOT_0_STATE_MASK
;

839 ià(
cu¼’t
 !ğ
s
->
bmSlÙICCS‹
) {

840 
s
->
bmSlÙICCS‹
 |ğ
SLOT_0_CHANGED_MASK
;

842 
s
->
nÙify_¦Ù_chªge
 = 
Œue
;

843 
	`usb_wakeup
(
s
->
šŒ
);

844 
	}
}

846 
	$ccid_wr™e_d©a_block_”rÜ
(

847 
USBCCIDS‹
 *
s
, 
ušt8_t
 
¦Ù
, ušt8_ˆ
£q
)

849 
	`ccid_wr™e_d©a_block
(
s
, 
¦Ù
, 
£q
, 
NULL
, 0);

850 
	}
}

852 
	$ccid_Ú_­du_äom_gue¡
(
USBCCIDS‹
 *
s
, 
CCID_XãrBlock
 *
»cv
)

854 
ušt32_t
 
Ën
;

856 ià(
	`ccid_ÿrd_¡©us
(
s
è!ğ
ICC_STATUS_PRESENT_ACTIVE
) {

857 
	`DPRINTF
(
s
, 1,

859 
	`ccid_wr™e_d©a_block_”rÜ
(
s
, 
»cv
->
hdr
.
bSlÙ
,„ecv->hdr.
bSeq
);

862 
Ën
 = 
	`Ë32_to_ıu
(
»cv
->
hdr
.
dwL’gth
);

863 
	`DPRINTF
(
s
, 1, "%s: seq %d,†’ %d\n", 
__func__
,

864 
»cv
->
hdr
.
bSeq
, 
Ën
);

865 
	`ccid_add_³ndšg_ªsw”
(
s
, (
CCID_H—d”
 *)
»cv
);

866 ià(
s
->
ÿrd
) {

867 
	`ccid_ÿrd_­du_äom_gue¡
(
s
->
ÿrd
, 
»cv
->
abD©a
, 
Ën
);

869 
	`DPRINTF
(
s
, 
D_WARN
, "warning: discarded‡pdu\n");

871 
	}
}

879 
	$ccid_hªdË_bulk_out
(
USBCCIDS‹
 *
s
, 
USBPack‘
 *
p
)

881 
CCID_H—d”
 *
ccid_h—d”
;

883 ià(
p
->
iov
.
size
 + 
s
->
bulk_out_pos
 > 
BULK_OUT_DATA_SIZE
) {

884  
USB_RET_STALL
;

886 
ccid_h—d”
 = (
CCID_H—d”
 *)
s
->
bulk_out_d©a
;

887 
	`usb_·ck‘_cİy
(
p
, 
s
->
bulk_out_d©a
 + s->
bulk_out_pos
,…->
iov
.
size
);

888 
s
->
bulk_out_pos
 +ğ
p
->
iov
.
size
;

889 ià(
p
->
iov
.
size
 =ğ
CCID_MAX_PACKET_SIZE
) {

890 
	`DPRINTF
(
s
, 
D_VERBOSE
,

892 
p
->
iov
.
size
, 
ccid_h—d”
->
dwL’gth
);

895 ià(
s
->
bulk_out_pos
 < 10) {

896 
	`DPRINTF
(
s
, 1,

898 
__func__
);

900 
	`DPRINTF
(
s
, 
D_MORE_INFO
, "% %x\n", 
__func__
, 
ccid_h—d”
->
bMes§geTy³
);

901 
ccid_h—d”
->
bMes§geTy³
) {

902 
CCID_MESSAGE_TYPE_PC_to_RDR_G‘SlÙStus
:

903 
	`ccid_wr™e_¦Ù_¡©us
(
s
, 
ccid_h—d”
);

905 
CCID_MESSAGE_TYPE_PC_to_RDR_IccPow”On
:

906 
	`DPRINTF
(
s
, 1, "PowerOn: %d\n",

907 ((
CCID_IccPow”On
 *)(
ccid_h—d”
))->
bPow”S–eù
);

908 
s
->
pow”ed
 = 
Œue
;

909 ià(!
	`ccid_ÿrd_š£¹ed
(
s
)) {

910 
	`ccid_»pÜt_”rÜ_çed
(
s
, 
ERROR_ICC_MUTE
);

913 
	`ccid_wr™e_d©a_block_©r
(
s
, 
ccid_h—d”
);

915 
CCID_MESSAGE_TYPE_PC_to_RDR_IccPow”Off
:

916 
	`DPRINTF
(
s
, 1, "PowerOff\n");

917 
	`ccid_»£t_”rÜ_¡©us
(
s
);

918 
s
->
pow”ed
 = 
çl£
;

919 
	`ccid_wr™e_¦Ù_¡©us
(
s
, 
ccid_h—d”
);

921 
CCID_MESSAGE_TYPE_PC_to_RDR_XäBlock
:

922 
	`ccid_Ú_­du_äom_gue¡
(
s
, (
CCID_XãrBlock
 *)s->
bulk_out_d©a
);

924 
CCID_MESSAGE_TYPE_PC_to_RDR_S‘P¬am‘”s
:

925 
	`ccid_»£t_”rÜ_¡©us
(
s
);

926 
	`ccid_£t_·¿m‘”s
(
s
, 
ccid_h—d”
);

927 
	`ccid_wr™e_·¿m‘”s
(
s
, 
ccid_h—d”
);

929 
CCID_MESSAGE_TYPE_PC_to_RDR_Re£tP¬am‘”s
:

930 
	`ccid_»£t_”rÜ_¡©us
(
s
);

931 
	`ccid_»£t_·¿m‘”s
(
s
);

932 
	`ccid_wr™e_·¿m‘”s
(
s
, 
ccid_h—d”
);

934 
CCID_MESSAGE_TYPE_PC_to_RDR_G‘P¬am‘”s
:

935 
	`ccid_»£t_”rÜ_¡©us
(
s
);

936 
	`ccid_wr™e_·¿m‘”s
(
s
, 
ccid_h—d”
);

939 
	`DPRINTF
(
s
, 1,

941 
ccid_h—d”
->
bMes§geTy³
);

946 
	`ccid_»pÜt_”rÜ_çed
(
s
, 
ERROR_CMD_NOT_SUPPORTED
);

947 
	`ccid_wr™e_¦Ù_¡©us
(
s
, 
ccid_h—d”
);

951 
s
->
bulk_out_pos
 = 0;

953 
	}
}

955 
	$ccid_bulk_š_cİy_to_gue¡
(
USBCCIDS‹
 *
s
, 
USBPack‘
 *
p
)

957 
»t
 = 0;

959 
	`as£¹
(
p
->
iov
.
size
 > 0);

960 
	`ccid_bulk_š_g‘
(
s
);

961 ià(
s
->
cu¼’t_bulk_š
 !ğ
NULL
) {

962 
»t
 = 
	`MIN
(
s
->
cu¼’t_bulk_š
->
Ën
 - s->cu¼’t_bulk_š->
pos
,

963 
p
->
iov
.
size
);

964 
	`usb_·ck‘_cİy
(
p
, 
s
->
cu¼’t_bulk_š
->
d©a
 +

965 
s
->
cu¼’t_bulk_š
->
pos
, 
»t
);

966 
s
->
cu¼’t_bulk_š
->
pos
 +ğ
»t
;

967 ià(
s
->
cu¼’t_bulk_š
->
pos
 =ğs->cu¼’t_bulk_š->
Ën
) {

968 
	`ccid_bulk_š_»Ëa£
(
s
);

972 
»t
 = 
USB_RET_NAK
;

974 ià(
»t
 > 0) {

975 
	`DPRINTF
(
s
, 
D_MORE_INFO
,

977 
__func__
, 
p
->
iov
.
size
, 
»t
);

979 ià(
»t
 !ğ
USB_RET_NAK
 &&„‘ < 
p
->
iov
.
size
) {

980 
	`DPRINTF
(
s
, 1,

982 
__func__
, 
»t
, 
p
->
iov
.
size
);

984  
»t
;

985 
	}
}

987 
	$ccid_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

989 
USBCCIDS‹
 *
s
 = 
	`DO_UPCAST
(USBCCIDS‹, 
dev
, dev);

990 
»t
 = 0;

991 
ušt8_t
 
buf
[2];

993 
p
->
pid
) {

994 
USB_TOKEN_OUT
:

995 
»t
 = 
	`ccid_hªdË_bulk_out
(
s
, 
p
);

998 
USB_TOKEN_IN
:

999 
p
->
•
->
Ä
) {

1000 
CCID_BULK_IN_EP
:

1001 ià(!
p
->
iov
.
size
) {

1002 
»t
 = 
USB_RET_NAK
;

1004 
»t
 = 
	`ccid_bulk_š_cİy_to_gue¡
(
s
, 
p
);

1007 
CCID_INT_IN_EP
:

1008 ià(
s
->
nÙify_¦Ù_chªge
) {

1010 
buf
[0] = 
CCID_MESSAGE_TYPE_RDR_to_PC_NÙifySlÙChªge
;

1011 
buf
[1] = 
s
->
bmSlÙICCS‹
;

1012 
	`usb_·ck‘_cİy
(
p
, 
buf
, 2);

1013 
»t
 = 2;

1014 
s
->
nÙify_¦Ù_chªge
 = 
çl£
;

1015 
s
->
bmSlÙICCS‹
 &ğ~
SLOT_0_CHANGED_MASK
;

1016 
	`DPRINTF
(
s
, 
D_INFO
,

1019 
s
->
bmSlÙICCS‹
, 
p
->
iov
.
size
);

1023 
	`DPRINTF
(
s
, 1, "Badƒndpoint\n");

1024 
»t
 = 
USB_RET_STALL
;

1029 
	`DPRINTF
(
s
, 1, "Badoken\n");

1030 
»t
 = 
USB_RET_STALL
;

1034  
»t
;

1035 
	}
}

1037 
	$ccid_hªdË_de¡roy
(
USBDeviû
 *
dev
)

1039 
USBCCIDS‹
 *
s
 = 
	`DO_UPCAST
(USBCCIDS‹, 
dev
, dev);

1041 
	`ccid_bulk_š_ş—r
(
s
);

1042 
	}
}

1044 
	$ccid_æush_³ndšg_ªsw”s
(
USBCCIDS‹
 *
s
)

1046 
	`ccid_has_³ndšg_ªsw”s
(
s
)) {

1047 
	`ccid_wr™e_d©a_block_ªsw”
(
s
, 
NULL
, 0);

1049 
	}
}

1051 
Answ”
 *
	$ccid_³ek_Ãxt_ªsw”
(
USBCCIDS‹
 *
s
)

1053  
s
->
³ndšg_ªsw”s_num
 == 0

1054 ? 
NULL


1055 : &
s
->
³ndšg_ªsw”s
[s->
³ndšg_ªsw”s_¡¬t
 % 
PENDING_ANSWERS_NUM
];

1056 
	}
}

1058 
Prİ”ty
 
	gccid_´İs
[] = {

1059 
DEFINE_PROP_UINT32
("¦Ù", 
CCIDC¬dS‹
, 
¦Ù
, 0),

1060 
DEFINE_PROP_END_OF_LIST
(),

1063 
	#TYPE_CCID_BUS
 "ccid-bus"

	)

1064 
	#CCID_BUS
(
obj
è
	`OBJECT_CHECK
(
CCIDBus
, (obj), 
TYPE_CCID_BUS
)

	)

1066 cÚ¡ 
Ty³Info
 
	gccid_bus_šfo
 = {

1067 .
Çme
 = 
TYPE_CCID_BUS
,

1068 .
	g·»Á
 = 
TYPE_BUS
,

1069 .
	gš¡ªû_size
 = (
CCIDBus
),

1072 
	$ccid_ÿrd_£nd_­du_to_gue¡
(
CCIDC¬dS‹
 *
ÿrd
,

1073 
ušt8_t
 *
­du
, 
ušt32_t
 
Ën
)

1075 
USBCCIDS‹
 *
s
 = 
	`DO_UPCAST
(USBCCIDS‹, 
dev
.
qdev
,

1076 
ÿrd
->
qdev
.
·»Á_bus
->
·»Á
);

1077 
Answ”
 *
ªsw”
;

1079 ià(!
	`ccid_has_³ndšg_ªsw”s
(
s
)) {

1080 
	`DPRINTF
(
s
, 1, "CCID ERROR: got‡n APDU without…ending‡nswers\n");

1083 
s
->
bmCommªdStus
 = 
COMMAND_STATUS_NO_ERROR
;

1084 
ªsw”
 = 
	`ccid_³ek_Ãxt_ªsw”
(
s
);

1085 ià(
ªsw”
 =ğ
NULL
) {

1086 
	`abÜt
();

1088 
	`DPRINTF
(
s
, 1, "APDU„eturnedo guest %d (answer seq %d, slot %d)\n",

1089 
Ën
, 
ªsw”
->
£q
,‡nsw”->
¦Ù
);

1090 
	`ccid_wr™e_d©a_block_ªsw”
(
s
, 
­du
, 
Ën
);

1091 
	}
}

1093 
	$ccid_ÿrd_ÿrd_»moved
(
CCIDC¬dS‹
 *
ÿrd
)

1095 
USBCCIDS‹
 *
s
 =

1096 
	`DO_UPCAST
(
USBCCIDS‹
, 
dev
.
qdev
, 
ÿrd
->qdev.
·»Á_bus
->
·»Á
);

1098 
	`ccid_Ú_¦Ù_chªge
(
s
, 
çl£
);

1099 
	`ccid_æush_³ndšg_ªsw”s
(
s
);

1100 
	`ccid_»£t
(
s
);

1101 
	}
}

1103 
	$ccid_ÿrd_ccid_©ch
(
CCIDC¬dS‹
 *
ÿrd
)

1105 
USBCCIDS‹
 *
s
 =

1106 
	`DO_UPCAST
(
USBCCIDS‹
, 
dev
.
qdev
, 
ÿrd
->qdev.
·»Á_bus
->
·»Á
);

1108 
	`DPRINTF
(
s
, 1, "CCID Attach\n");

1109 ià(
s
->
mig¿tiÚ_¡©e
 =ğ
MIGRATION_MIGRATED
) {

1110 
s
->
mig¿tiÚ_¡©e
 = 
MIGRATION_NONE
;

1113 
	}
}

1115 
	$ccid_ÿrd_ccid_d‘ach
(
CCIDC¬dS‹
 *
ÿrd
)

1117 
USBCCIDS‹
 *
s
 =

1118 
	`DO_UPCAST
(
USBCCIDS‹
, 
dev
.
qdev
, 
ÿrd
->qdev.
·»Á_bus
->
·»Á
);

1120 
	`DPRINTF
(
s
, 1, "CCID Detach\n");

1121 ià(
	`ccid_ÿrd_š£¹ed
(
s
)) {

1122 
	`ccid_Ú_¦Ù_chªge
(
s
, 
çl£
);

1124 
	`ccid_d‘ach
(
s
);

1125 
	}
}

1127 
	$ccid_ÿrd_ÿrd_”rÜ
(
CCIDC¬dS‹
 *
ÿrd
, 
ušt64_t
 
”rÜ
)

1129 
USBCCIDS‹
 *
s
 =

1130 
	`DO_UPCAST
(
USBCCIDS‹
, 
dev
.
qdev
, 
ÿrd
->qdev.
·»Á_bus
->
·»Á
);

1132 
s
->
bmCommªdStus
 = 
COMMAND_STATUS_FAILED
;

1133 
s
->
Ï¡_ªsw”_”rÜ
 = 
”rÜ
;

1134 
	`DPRINTF
(
s
, 1, "VSC_E¼Ü: %" 
PRIX64
 "\n", s->
Ï¡_ªsw”_”rÜ
);

1140 ià(
	`ccid_has_³ndšg_ªsw”s
(
s
)) {

1141 
	`ccid_wr™e_d©a_block_ªsw”
(
s
, 
NULL
, 0);

1143 
	}
}

1145 
	$ccid_ÿrd_ÿrd_š£¹ed
(
CCIDC¬dS‹
 *
ÿrd
)

1147 
USBCCIDS‹
 *
s
 =

1148 
	`DO_UPCAST
(
USBCCIDS‹
, 
dev
.
qdev
, 
ÿrd
->qdev.
·»Á_bus
->
·»Á
);

1150 
s
->
bmCommªdStus
 = 
COMMAND_STATUS_NO_ERROR
;

1151 
	`ccid_æush_³ndšg_ªsw”s
(
s
);

1152 
	`ccid_Ú_¦Ù_chªge
(
s
, 
Œue
);

1153 
	}
}

1155 
	$ccid_ÿrd_ex™
(
DeviûS‹
 *
qdev
)

1157 
»t
 = 0;

1158 
CCIDC¬dS‹
 *
ÿrd
 = 
	`CCID_CARD
(
qdev
);

1159 
USBCCIDS‹
 *
s
 =

1160 
	`DO_UPCAST
(
USBCCIDS‹
, 
dev
.
qdev
, 
ÿrd
->qdev.
·»Á_bus
->
·»Á
);

1162 ià(
	`ccid_ÿrd_š£¹ed
(
s
)) {

1163 
	`ccid_ÿrd_ÿrd_»moved
(
ÿrd
);

1165 
»t
 = 
	`ccid_ÿrd_ex™â
(
ÿrd
);

1166 
s
->
ÿrd
 = 
NULL
;

1167  
»t
;

1168 
	}
}

1170 
	$ccid_ÿrd_š™
(
DeviûS‹
 *
qdev
)

1172 
CCIDC¬dS‹
 *
ÿrd
 = 
	`CCID_CARD
(
qdev
);

1173 
USBCCIDS‹
 *
s
 =

1174 
	`DO_UPCAST
(
USBCCIDS‹
, 
dev
.
qdev
, 
ÿrd
->qdev.
·»Á_bus
->
·»Á
);

1175 
»t
 = 0;

1177 ià(
ÿrd
->
¦Ù
 != 0) {

1178 
	`”rÜ_»pÜt
("Warning: usb-ccid supports one slot, can't‡dd %d",

1179 
ÿrd
->
¦Ù
);

1182 ià(
s
->
ÿrd
 !ğ
NULL
) {

1183 
	`”rÜ_»pÜt
("Warning: usb-ccid card‡lready full,‚ot‡dding");

1186 
»t
 = 
	`ccid_ÿrd_š™â
(
ÿrd
);

1187 ià(
»t
 == 0) {

1188 
s
->
ÿrd
 = card;

1190  
»t
;

1191 
	}
}

1193 
	$ccid_š™â
(
USBDeviû
 *
dev
)

1195 
USBCCIDS‹
 *
s
 = 
	`DO_UPCAST
(USBCCIDS‹, 
dev
, dev);

1197 
	`usb_desc_ü—‹_£rŸl
(
dev
);

1198 
	`usb_desc_š™
(
dev
);

1199 
	`qbus_ü—‹_š¶aû
(&
s
->
bus
.
qbus
, 
TYPE_CCID_BUS
, &
dev
->
qdev
, 
NULL
);

1200 
s
->
šŒ
 = 
	`usb_•_g‘
(
dev
, 
USB_TOKEN_IN
, 
CCID_INT_IN_EP
);

1201 
s
->
bus
.
qbus
.
®low_hÙ¶ug
 = 1;

1202 
s
->
ÿrd
 = 
NULL
;

1203 
s
->
mig¿tiÚ_¡©e
 = 
MIGRATION_NONE
;

1204 
s
->
mig¿tiÚ_rg‘_
 = 0;

1205 
s
->
mig¿tiÚ_rg‘_pÜt
 = 0;

1206 
s
->
dev
.
¥“d
 = 
USB_SPEED_FULL
;

1207 
s
->
dev
.
¥“dmask
 = 
USB_SPEED_MASK_FULL
;

1208 
s
->
nÙify_¦Ù_chªge
 = 
çl£
;

1209 
s
->
pow”ed
 = 
Œue
;

1210 
s
->
³ndšg_ªsw”s_num
 = 0;

1211 
s
->
Ï¡_ªsw”_”rÜ
 = 0;

1212 
s
->
bulk_š_³ndšg_¡¬t
 = 0;

1213 
s
->
bulk_š_³ndšg_’d
 = 0;

1214 
s
->
cu¼’t_bulk_š
 = 
NULL
;

1215 
	`ccid_»£t_”rÜ_¡©us
(
s
);

1216 
s
->
bulk_out_pos
 = 0;

1217 
	`ccid_»£t_·¿m‘”s
(
s
);

1218 
	`ccid_»£t
(
s
);

1220 
	}
}

1222 
	$ccid_po¡_lßd
(*
İaque
, 
v”siÚ_id
)

1224 
USBCCIDS‹
 *
s
 = 
İaque
;

1232 
s
->
dev
.
¡©e
 = s->
¡©e_vm¡©e
;

1234 
	}
}

1236 
	$ccid_´e_§ve
(*
İaque
)

1238 
USBCCIDS‹
 *
s
 = 
İaque
;

1240 
s
->
¡©e_vm¡©e
 = s->
dev
.
¡©e
;

1241 ià(
s
->
dev
.
©ched
) {

1246 
s
->
mig¿tiÚ_¡©e
 = 
MIGRATION_MIGRATED
;

1248 
	}
}

1250 
VMS‹DesütiÚ
 
	gbulk_š_vm¡©e
 = {

1251 .
Çme
 = "CCID BulkIn state",

1252 .
	gv”siÚ_id
 = 1,

1253 .
	gmšimum_v”siÚ_id
 = 1,

1254 .
	gf›lds
 = (
VMS‹F›ld
[]) {

1255 
VMSTATE_BUFFER
(
d©a
, 
BulkIn
),

1256 
VMSTATE_UINT32
(
Ën
, 
BulkIn
),

1257 
VMSTATE_UINT32
(
pos
, 
BulkIn
),

1258 
VMSTATE_END_OF_LIST
()

1262 
VMS‹DesütiÚ
 
	gªsw”_vm¡©e
 = {

1263 .
Çme
 = "CCID Answer state",

1264 .
	gv”siÚ_id
 = 1,

1265 .
	gmšimum_v”siÚ_id
 = 1,

1266 .
	gf›lds
 = (
VMS‹F›ld
[]) {

1267 
VMSTATE_UINT8
(
¦Ù
, 
Answ”
),

1268 
VMSTATE_UINT8
(
£q
, 
Answ”
),

1269 
VMSTATE_END_OF_LIST
()

1273 
VMS‹DesütiÚ
 
	gusb_deviû_vm¡©e
 = {

1274 .
Çme
 = "usb_device",

1275 .
	gv”siÚ_id
 = 1,

1276 .
	gmšimum_v”siÚ_id
 = 1,

1277 .
	gf›lds
 = (
VMS‹F›ld
[]) {

1278 
VMSTATE_UINT8
(
addr
, 
USBDeviû
),

1279 
VMSTATE_BUFFER
(
£tup_buf
, 
USBDeviû
),

1280 
VMSTATE_BUFFER
(
d©a_buf
, 
USBDeviû
),

1281 
VMSTATE_END_OF_LIST
()

1285 
VMS‹DesütiÚ
 
	gccid_vm¡©e
 = {

1286 .
Çme
 = 
CCID_DEV_NAME
,

1287 .
	gv”siÚ_id
 = 1,

1288 .
	gmšimum_v”siÚ_id
 = 1,

1289 .
	gpo¡_lßd
 = 
ccid_po¡_lßd
,

1290 .
	g´e_§ve
 = 
ccid_´e_§ve
,

1291 .
	gf›lds
 = (
VMS‹F›ld
[]) {

1292 
VMSTATE_STRUCT
(
dev
, 
USBCCIDS‹
, 1, 
usb_deviû_vm¡©e
, 
USBDeviû
),

1293 
VMSTATE_UINT8
(
debug
, 
USBCCIDS‹
),

1294 
VMSTATE_BUFFER
(
bulk_out_d©a
, 
USBCCIDS‹
),

1295 
VMSTATE_UINT32
(
bulk_out_pos
, 
USBCCIDS‹
),

1296 
VMSTATE_UINT8
(
bmSlÙICCS‹
, 
USBCCIDS‹
),

1297 
VMSTATE_UINT8
(
pow”ed
, 
USBCCIDS‹
),

1298 
VMSTATE_UINT8
(
nÙify_¦Ù_chªge
, 
USBCCIDS‹
),

1299 
VMSTATE_UINT64
(
Ï¡_ªsw”_”rÜ
, 
USBCCIDS‹
),

1300 
VMSTATE_UINT8
(
bE¼Ü
, 
USBCCIDS‹
),

1301 
VMSTATE_UINT8
(
bmCommªdStus
, 
USBCCIDS‹
),

1302 
VMSTATE_UINT8
(
bPrÙocŞNum
, 
USBCCIDS‹
),

1303 
VMSTATE_BUFFER
(
abPrÙocŞD©aSŒuùu»
, 
USBCCIDS‹
),

1304 
VMSTATE_UINT32
(
ulPrÙocŞD©aSŒuùu»Size
, 
USBCCIDS‹
),

1305 
VMSTATE_STRUCT_ARRAY
(
bulk_š_³ndšg
, 
USBCCIDS‹
,

1306 
BULK_IN_PENDING_NUM
, 1, 
bulk_š_vm¡©e
, 
BulkIn
),

1307 
VMSTATE_UINT32
(
bulk_š_³ndšg_¡¬t
, 
USBCCIDS‹
),

1308 
VMSTATE_UINT32
(
bulk_š_³ndšg_’d
, 
USBCCIDS‹
),

1309 
VMSTATE_STRUCT_ARRAY
(
³ndšg_ªsw”s
, 
USBCCIDS‹
,

1310 
PENDING_ANSWERS_NUM
, 1, 
ªsw”_vm¡©e
, 
Answ”
),

1311 
VMSTATE_UINT32
(
³ndšg_ªsw”s_num
, 
USBCCIDS‹
),

1312 
VMSTATE_UINT8
(
mig¿tiÚ_¡©e
, 
USBCCIDS‹
),

1313 
VMSTATE_UINT32
(
¡©e_vm¡©e
, 
USBCCIDS‹
),

1314 
VMSTATE_END_OF_LIST
()

1318 
Prİ”ty
 
	gccid_´İ”t›s
[] = {

1319 
DEFINE_PROP_UINT8
("debug", 
USBCCIDS‹
, 
debug
, 0),

1320 
DEFINE_PROP_END_OF_LIST
(),

1323 
	$ccid_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1325 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1326 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

1328 
uc
->
š™
 = 
ccid_š™â
;

1329 
uc
->
´oduù_desc
 = "QEMU USB CCID";

1330 
uc
->
usb_desc
 = &
desc_ccid
;

1331 
uc
->
hªdË_»£t
 = 
ccid_hªdË_»£t
;

1332 
uc
->
hªdË_cÚŒŞ
 = 
ccid_hªdË_cÚŒŞ
;

1333 
uc
->
hªdË_d©a
 = 
ccid_hªdË_d©a
;

1334 
uc
->
hªdË_de¡roy
 = 
ccid_hªdË_de¡roy
;

1335 
dc
->
desc
 = "CCID Rev 1.1 smartcard„eader";

1336 
dc
->
vmsd
 = &
ccid_vm¡©e
;

1337 
dc
->
´İs
 = 
ccid_´İ”t›s
;

1338 
	}
}

1340 
Ty³Info
 
	gccid_šfo
 = {

1341 .
Çme
 = 
CCID_DEV_NAME
,

1342 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

1343 .
	gš¡ªû_size
 = (
USBCCIDS‹
),

1344 .
	gşass_š™
 = 
ccid_şass_š™â
,

1347 
	$ccid_ÿrd_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1349 
DeviûCÏss
 *
k
 = 
	`DEVICE_CLASS
(
kÏss
);

1350 
k
->
bus_ty³
 = 
TYPE_CCID_BUS
;

1351 
k
->
š™
 = 
ccid_ÿrd_š™
;

1352 
k
->
ex™
 = 
ccid_ÿrd_ex™
;

1353 
k
->
´İs
 = 
ccid_´İs
;

1354 
	}
}

1356 
Ty³Info
 
	gccid_ÿrd_ty³_šfo
 = {

1357 .
Çme
 = 
TYPE_CCID_CARD
,

1358 .
	g·»Á
 = 
TYPE_DEVICE
,

1359 .
	gš¡ªû_size
 = (
CCIDC¬dS‹
),

1360 .
	gab¡¿ù
 = 
Œue
,

1361 .
	gşass_size
 = (
CCIDC¬dCÏss
),

1362 .
	gşass_š™
 = 
ccid_ÿrd_şass_š™
,

1365 
	$ccid_»gi¡”_ty³s
()

1367 
	`ty³_»gi¡”_¡©ic
(&
ccid_bus_šfo
);

1368 
	`ty³_»gi¡”_¡©ic
(&
ccid_ÿrd_ty³_šfo
);

1369 
	`ty³_»gi¡”_¡©ic
(&
ccid_šfo
);

1370 
	`usb_Ëgacy_»gi¡”
(
CCID_DEV_NAME
, "ccid", 
NULL
);

1371 
	}
}

1373 
ty³_š™
(
ccid_»gi¡”_ty³s
)

	@dev-storage.c

10 
	~"qemu-commÚ.h
"

11 
	~"qemu-İtiÚ.h
"

12 
	~"qemu-cÚfig.h
"

13 
	~"hw/usb.h
"

14 
	~"hw/usb/desc.h
"

15 
	~"hw/scsi.h
"

16 
	~"cÚsŞe.h
"

17 
	~"mÚ™Ü.h
"

18 
	~"sy£mu.h
"

19 
	~"blockdev.h
"

23 #ifdeà
DEBUG_MSD


24 
	#DPRINTF
(
fmt
, ...) \

25 dØ{ 
	`´štf
("usb-msd: " 
fmt
 , ## 
__VA_ARGS__
); } 0)

	)

27 
	#DPRINTF
(
fmt
, ...èdØ{} 0)

	)

31 
	#MassStÜageRe£t
 0xff

	)

32 
	#G‘MaxLun
 0xã

	)

34 
	eUSBMSDMode
 {

35 
	mUSB_MSDM_CBW
,

36 
	mUSB_MSDM_DATAOUT
,

37 
	mUSB_MSDM_DATAIN
,

38 
	mUSB_MSDM_CSW


41 
	susb_msd_csw
 {

42 
ušt32_t
 
	msig
;

43 
ušt32_t
 
	mg
;

44 
ušt32_t
 
	m»sidue
;

45 
ušt8_t
 
	m¡©us
;

49 
USBDeviû
 
	mdev
;

50 
USBMSDMode
 
	mmode
;

51 
ušt32_t
 
	mscsi_off
;

52 
ušt32_t
 
	mscsi_Ën
;

53 
ušt32_t
 
	md©a_Ën
;

54 
usb_msd_csw
 
	mcsw
;

55 
SCSIReque¡
 *
	m»q
;

56 
SCSIBus
 
	mbus
;

57 
BlockCÚf
 
	mcÚf
;

58 *
	m£rŸl
;

59 
SCSIDeviû
 *
	mscsi_dev
;

60 
ušt32_t
 
	m»movabË
;

62 
USBPack‘
 *
	m·ck‘
;

63 } 
	tMSDS‹
;

65 
	susb_msd_cbw
 {

66 
ušt32_t
 
	msig
;

67 
ušt32_t
 
	mg
;

68 
ušt32_t
 
	md©a_Ën
;

69 
ušt8_t
 
	mæags
;

70 
ušt8_t
 
	mlun
;

71 
ušt8_t
 
	mcmd_Ën
;

72 
ušt8_t
 
	mcmd
[16];

76 
	mSTR_MANUFACTURER
 = 1,

77 
	mSTR_PRODUCT
,

78 
	mSTR_SERIALNUMBER
,

79 
	mSTR_CONFIG_FULL
,

80 
	mSTR_CONFIG_HIGH
,

83 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

84 [
STR_MANUFACTURER
] = "QEMU",

85 [
STR_PRODUCT
] = "QEMU USB HARDDRIVE",

86 [
STR_SERIALNUMBER
] = "1",

87 [
STR_CONFIG_FULL
] = "Full speed config (usb 1.1)",

88 [
STR_CONFIG_HIGH
] = "High speed config (usb 2.0)",

91 cÚ¡ 
USBDescIçû
 
	gdesc_içû_fuÎ
 = {

92 .
bIÁ”çûNumb”
 = 0,

93 .
	gbNumEndpošts
 = 2,

94 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_MASS_STORAGE
,

95 .
	gbIÁ”çûSubCÏss
 = 0x06,

96 .
	gbIÁ”çûPrÙocŞ
 = 0x50,

97 .
	g•s
 = (
USBDescEndpošt
[]) {

99 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

100 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

101 .
	gwMaxPack‘Size
 = 64,

103 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 0x02,

104 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

105 .
	gwMaxPack‘Size
 = 64,

110 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_fuÎ
 = {

111 .
bcdUSB
 = 0x0200,

112 .
	gbMaxPack‘Size0
 = 8,

113 .
	gbNumCÚfigu¿tiÚs
 = 1,

114 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

116 .
bNumIÁ”çûs
 = 1,

117 .
	gbCÚfigu¿tiÚV®ue
 = 1,

118 .
	giCÚfigu¿tiÚ
 = 
STR_CONFIG_FULL
,

119 .
	gbmA‰ribu‹s
 = 0xc0,

120 .
	gnif
 = 1,

121 .
	gifs
 = &
desc_içû_fuÎ
,

126 cÚ¡ 
USBDescIçû
 
	gdesc_içû_high
 = {

127 .
bIÁ”çûNumb”
 = 0,

128 .
	gbNumEndpošts
 = 2,

129 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_MASS_STORAGE
,

130 .
	gbIÁ”çûSubCÏss
 = 0x06,

131 .
	gbIÁ”çûPrÙocŞ
 = 0x50,

132 .
	g•s
 = (
USBDescEndpošt
[]) {

134 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

135 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

136 .
	gwMaxPack‘Size
 = 512,

138 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 0x02,

139 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

140 .
	gwMaxPack‘Size
 = 512,

145 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_high
 = {

146 .
bcdUSB
 = 0x0200,

147 .
	gbMaxPack‘Size0
 = 64,

148 .
	gbNumCÚfigu¿tiÚs
 = 1,

149 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

151 .
bNumIÁ”çûs
 = 1,

152 .
	gbCÚfigu¿tiÚV®ue
 = 1,

153 .
	giCÚfigu¿tiÚ
 = 
STR_CONFIG_HIGH
,

154 .
	gbmA‰ribu‹s
 = 0xc0,

155 .
	gnif
 = 1,

156 .
	gifs
 = &
desc_içû_high
,

161 cÚ¡ 
USBDesc
 
	gdesc
 = {

162 .
id
 = {

163 .
idV’dÜ
 = 0x46f4,

164 .
	gidProduù
 = 0x0001,

165 .
	gbcdDeviû
 = 0,

166 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

167 .
	giProduù
 = 
STR_PRODUCT
,

168 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

170 .
	gfuÎ
 = &
desc_deviû_fuÎ
,

171 .
	ghigh
 = &
desc_deviû_high
,

172 .
	g¡r
 = 
desc_¡ršgs
,

175 
	$usb_msd_cİy_d©a
(
MSDS‹
 *
s
, 
USBPack‘
 *
p
)

177 
ušt32_t
 
Ën
;

178 
Ën
 = 
p
->
iov
.
size
 -…->
»suÉ
;

179 ià(
Ën
 > 
s
->
scsi_Ën
)

180 
Ën
 = 
s
->
scsi_Ën
;

181 
	`usb_·ck‘_cİy
(
p
, 
	`scsi_»q_g‘_buf
(
s
->
»q
è+ s->
scsi_off
, 
Ën
);

182 
s
->
scsi_Ën
 -ğ
Ën
;

183 
s
->
scsi_off
 +ğ
Ën
;

184 
s
->
d©a_Ën
 -ğ
Ën
;

185 ià(
s
->
scsi_Ën
 =ğ0 || s->
d©a_Ën
 == 0) {

186 
	`scsi_»q_cÚtšue
(
s
->
»q
);

188 
	}
}

190 
	$usb_msd_£nd_¡©us
(
MSDS‹
 *
s
, 
USBPack‘
 *
p
)

192 
Ën
;

194 
	`DPRINTF
("Command status %dag 0x%x,†en %zd\n",

195 
s
->
csw
.
¡©us
, 
	`Ë32_to_ıu
(s->csw.
g
), 
p
->
iov
.
size
);

197 
	`as£¹
(
s
->
csw
.
sig
 =ğ
	`ıu_to_Ë32
(0x53425355));

198 
Ën
 = 
	`MIN
((
s
->
csw
), 
p
->
iov
.
size
);

199 
	`usb_·ck‘_cİy
(
p
, &
s
->
csw
, 
Ën
);

200 
	`mem£t
(&
s
->
csw
, 0, (s->csw));

201 
	}
}

203 
	$usb_msd_·ck‘_com¶‘e
(
MSDS‹
 *
s
)

205 
USBPack‘
 *
p
 = 
s
->
·ck‘
;

210 
	`DPRINTF
("Pack‘ com¶‘%p\n", 
p
);

211 
s
->
·ck‘
 = 
NULL
;

212 
	`usb_·ck‘_com¶‘e
(&
s
->
dev
, 
p
);

213 
	}
}

215 
	$usb_msd_Œªsãr_d©a
(
SCSIReque¡
 *
»q
, 
ušt32_t
 
Ën
)

217 
MSDS‹
 *
s
 = 
	`DO_UPCAST
(MSDS‹, 
dev
.
qdev
, 
»q
->
bus
->
qbus
.
·»Á
);

218 
USBPack‘
 *
p
 = 
s
->
·ck‘
;

220 
	`as£¹
((
s
->
mode
 =ğ
USB_MSDM_DATAOUT
è=ğ(
»q
->
cmd
.mod=ğ
SCSI_XFER_TO_DEV
));

221 
s
->
scsi_Ën
 = 
Ën
;

222 
s
->
scsi_off
 = 0;

223 ià(
p
) {

224 
	`usb_msd_cİy_d©a
(
s
, 
p
);

225 
p
 = 
s
->
·ck‘
;

226 ià(
p
 &&…->
»suÉ
 =ğp->
iov
.
size
) {

227 
	`usb_msd_·ck‘_com¶‘e
(
s
);

230 
	}
}

232 
	$usb_msd_commªd_com¶‘e
(
SCSIReque¡
 *
»q
, 
ušt32_t
 
¡©us
, 
size_t
 
»sid
)

234 
MSDS‹
 *
s
 = 
	`DO_UPCAST
(MSDS‹, 
dev
.
qdev
, 
»q
->
bus
->
qbus
.
·»Á
);

235 
USBPack‘
 *
p
 = 
s
->
·ck‘
;

237 
	`DPRINTF
("Commªd com¶‘%dag 0x%x\n", 
¡©us
, 
»q
->
g
);

239 
s
->
csw
.
sig
 = 
	`ıu_to_Ë32
(0x53425355);

240 
s
->
csw
.
g
 = 
	`ıu_to_Ë32
(
»q
->tag);

241 
s
->
csw
.
»sidue
 = 
	`ıu_to_Ë32
(s->
d©a_Ën
);

242 
s
->
csw
.
¡©us
 = status != 0;

244 ià(
s
->
·ck‘
) {

245 ià(
s
->
d©a_Ën
 =ğ0 && s->
mode
 =ğ
USB_MSDM_DATAOUT
) {

248 
	`usb_msd_£nd_¡©us
(
s
, 
p
);

249 
s
->
mode
 = 
USB_MSDM_CBW
;

250 } ià(
s
->
mode
 =ğ
USB_MSDM_CSW
) {

251 
	`usb_msd_£nd_¡©us
(
s
, 
p
);

252 
s
->
mode
 = 
USB_MSDM_CBW
;

254 ià(
s
->
d©a_Ën
) {

255 
Ën
 = (
p
->
iov
.
size
 -…->
»suÉ
);

256 
	`usb_·ck‘_sk
(
p
, 
Ën
);

257 
s
->
d©a_Ën
 -ğ
Ën
;

259 ià(
s
->
d©a_Ën
 == 0) {

260 
s
->
mode
 = 
USB_MSDM_CSW
;

263 
	`usb_msd_·ck‘_com¶‘e
(
s
);

264 } ià(
s
->
d©a_Ën
 == 0) {

265 
s
->
mode
 = 
USB_MSDM_CSW
;

267 
	`scsi_»q_uÄef
(
»q
);

268 
s
->
»q
 = 
NULL
;

269 
	}
}

271 
	$usb_msd_»que¡_ÿnûÎed
(
SCSIReque¡
 *
»q
)

273 
MSDS‹
 *
s
 = 
	`DO_UPCAST
(MSDS‹, 
dev
.
qdev
, 
»q
->
bus
->
qbus
.
·»Á
);

275 ià(
»q
 =ğ
s
->req) {

276 
	`scsi_»q_uÄef
(
s
->
»q
);

277 
s
->
»q
 = 
NULL
;

278 
s
->
scsi_Ën
 = 0;

280 
	}
}

282 
	$usb_msd_hªdË_»£t
(
USBDeviû
 *
dev
)

284 
MSDS‹
 *
s
 = (MSDS‹ *)
dev
;

286 
	`DPRINTF
("Reset\n");

287 ià(
s
->
»q
) {

288 
	`scsi_»q_ÿnûl
(
s
->
»q
);

290 
	`as£¹
(
s
->
»q
 =ğ
NULL
);

292 ià(
s
->
·ck‘
) {

293 
s
->
·ck‘
->
»suÉ
 = 
USB_RET_STALL
;

294 
	`usb_msd_·ck‘_com¶‘e
(
s
);

297 
s
->
mode
 = 
USB_MSDM_CBW
;

298 
	}
}

300 
	$usb_msd_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

301 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

303 
MSDS‹
 *
s
 = (MSDS‹ *)
dev
;

304 
»t
;

306 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

307 ià(
»t
 >= 0) {

308  
»t
;

311 
»t
 = 0;

312 
»que¡
) {

313 
EndpoštOutReque¡
 | 
USB_REQ_CLEAR_FEATURE
:

314 
»t
 = 0;

317 
CÏssIÁ”çûOutReque¡
 | 
MassStÜageRe£t
:

319 
s
->
mode
 = 
USB_MSDM_CBW
;

320 
»t
 = 0;

322 
CÏssIÁ”çûReque¡
 | 
G‘MaxLun
:

323 
d©a
[0] = 0;

324 
»t
 = 1;

327 
»t
 = 
USB_RET_STALL
;

330  
»t
;

331 
	}
}

333 
	$usb_msd_ÿnûl_io
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

335 
MSDS‹
 *
s
 = 
	`DO_UPCAST
(MSDS‹, 
dev
, dev);

337 
	`as£¹
(
s
->
·ck‘
 =ğ
p
);

338 
s
->
·ck‘
 = 
NULL
;

340 ià(
s
->
»q
) {

341 
	`scsi_»q_ÿnûl
(
s
->
»q
);

343 
	}
}

345 
	$usb_msd_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

347 
MSDS‹
 *
s
 = (MSDS‹ *)
dev
;

348 
ušt32_t
 
g
;

349 
»t
 = 0;

350 
usb_msd_cbw
 
cbw
;

351 
ušt8_t
 
dev•
 = 
p
->
•
->
Ä
;

353 
p
->
pid
) {

354 
USB_TOKEN_OUT
:

355 ià(
dev•
 != 2)

356 
ç
;

358 
s
->
mode
) {

359 
USB_MSDM_CBW
:

360 ià(
p
->
iov
.
size
 != 31) {

361 
	`årštf
(
¡d”r
, "usb-msd: Bad CBW size");

362 
ç
;

364 
	`usb_·ck‘_cİy
(
p
, &
cbw
, 31);

365 ià(
	`Ë32_to_ıu
(
cbw
.
sig
) != 0x43425355) {

366 
	`årštf
(
¡d”r
, "usb-msd: Bad signature %08x\n",

367 
	`Ë32_to_ıu
(
cbw
.
sig
));

368 
ç
;

370 
	`DPRINTF
("Commªd oÀLUN %d\n", 
cbw
.
lun
);

371 ià(
cbw
.
lun
 != 0) {

372 
	`årštf
(
¡d”r
, "usb-msd: Bad LUN %d\n", 
cbw
.
lun
);

373 
ç
;

375 
g
 = 
	`Ë32_to_ıu
(
cbw
.tag);

376 
s
->
d©a_Ën
 = 
	`Ë32_to_ıu
(
cbw
.data_len);

377 ià(
s
->
d©a_Ën
 == 0) {

378 
s
->
mode
 = 
USB_MSDM_CSW
;

379 } ià(
cbw
.
æags
 & 0x80) {

380 
s
->
mode
 = 
USB_MSDM_DATAIN
;

382 
s
->
mode
 = 
USB_MSDM_DATAOUT
;

384 
	`DPRINTF
("Commandag 0x%x flags %08x†en %d data %d\n",

385 
g
, 
cbw
.
æags
, cbw.
cmd_Ën
, 
s
->
d©a_Ën
);

386 
	`as£¹
(
	`Ë32_to_ıu
(
s
->
csw
.
»sidue
) == 0);

387 
s
->
scsi_Ën
 = 0;

388 
s
->
»q
 = 
	`scsi_»q_Ãw
(s->
scsi_dev
, 
g
, 0, 
cbw
.
cmd
, 
NULL
);

389 #ifdeà
DEBUG_MSD


390 
	`scsi_»q_´št
(
s
->
»q
);

392 
	`scsi_»q_’queue
(
s
->
»q
);

393 ià(
s
->
»q
 && s->»q->
cmd
.
xãr
 !ğ
SCSI_XFER_NONE
) {

394 
	`scsi_»q_cÚtšue
(
s
->
»q
);

396 
»t
 = 
p
->
»suÉ
;

399 
USB_MSDM_DATAOUT
:

400 
	`DPRINTF
("D©¨ouˆ%zd/%d\n", 
p
->
iov
.
size
, 
s
->
d©a_Ën
);

401 ià(
p
->
iov
.
size
 > 
s
->
d©a_Ën
) {

402 
ç
;

405 ià(
s
->
scsi_Ën
) {

406 
	`usb_msd_cİy_d©a
(
s
, 
p
);

408 ià(
	`Ë32_to_ıu
(
s
->
csw
.
»sidue
)) {

409 
Ën
 = 
p
->
iov
.
size
 -…->
»suÉ
;

410 ià(
Ën
) {

411 
	`usb_·ck‘_sk
(
p
, 
Ën
);

412 
s
->
d©a_Ën
 -ğ
Ën
;

413 ià(
s
->
d©a_Ën
 == 0) {

414 
s
->
mode
 = 
USB_MSDM_CSW
;

418 ià(
p
->
»suÉ
 <…->
iov
.
size
) {

419 
	`DPRINTF
("Deã¼šg…ack‘ %°[wa™ d©a-out]\n", 
p
);

420 
s
->
·ck‘
 = 
p
;

421 
»t
 = 
USB_RET_ASYNC
;

423 
»t
 = 
p
->
»suÉ
;

428 
	`DPRINTF
("UÃx³ùed wr™Ö’ %zd)\n", 
p
->
iov
.
size
);

429 
ç
;

433 
USB_TOKEN_IN
:

434 ià(
dev•
 != 1)

435 
ç
;

437 
s
->
mode
) {

438 
USB_MSDM_DATAOUT
:

439 ià(
s
->
d©a_Ën
 !ğ0 || 
p
->
iov
.
size
 < 13) {

440 
ç
;

443 
s
->
·ck‘
 = 
p
;

444 
»t
 = 
USB_RET_ASYNC
;

447 
USB_MSDM_CSW
:

448 ià(
p
->
iov
.
size
 < 13) {

449 
ç
;

452 ià(
s
->
»q
) {

454 
	`DPRINTF
("Deã¼šg…ack‘ %°[wa™ stus]\n", 
p
);

455 
s
->
·ck‘
 = 
p
;

456 
»t
 = 
USB_RET_ASYNC
;

458 
	`usb_msd_£nd_¡©us
(
s
, 
p
);

459 
s
->
mode
 = 
USB_MSDM_CBW
;

460 
»t
 = 13;

464 
USB_MSDM_DATAIN
:

465 
	`DPRINTF
("Data in %zd/%d, scsi_len %d\n",

466 
p
->
iov
.
size
, 
s
->
d©a_Ën
, s->
scsi_Ën
);

467 ià(
s
->
scsi_Ën
) {

468 
	`usb_msd_cİy_d©a
(
s
, 
p
);

470 ià(
	`Ë32_to_ıu
(
s
->
csw
.
»sidue
)) {

471 
Ën
 = 
p
->
iov
.
size
 -…->
»suÉ
;

472 ià(
Ën
) {

473 
	`usb_·ck‘_sk
(
p
, 
Ën
);

474 
s
->
d©a_Ën
 -ğ
Ën
;

475 ià(
s
->
d©a_Ën
 == 0) {

476 
s
->
mode
 = 
USB_MSDM_CSW
;

480 ià(
p
->
»suÉ
 <…->
iov
.
size
) {

481 
	`DPRINTF
("Deã¼šg…ack‘ %°[wa™ d©a-š]\n", 
p
);

482 
s
->
·ck‘
 = 
p
;

483 
»t
 = 
USB_RET_ASYNC
;

485 
»t
 = 
p
->
»suÉ
;

490 
	`DPRINTF
("UÃx³ùed„—d (ËÀ%zd)\n", 
p
->
iov
.
size
);

491 
ç
;

496 
	`DPRINTF
("Badoken\n");

497 
ç
:

498 
»t
 = 
USB_RET_STALL
;

502  
»t
;

503 
	}
}

505 
	$usb_msd_·sswÜd_cb
(*
İaque
, 
”r
)

507 
MSDS‹
 *
s
 = 
İaque
;

509 ià(!
”r
)

510 
”r
 = 
	`usb_deviû_©ch
(&
s
->
dev
);

512 ià(
”r
)

513 
	`qdev_uÅlug
(&
s
->
dev
.
qdev
, 
NULL
);

514 
	}
}

516 *
	$usb_msd_lßd_»que¡
(
QEMUFe
 *
f
, 
SCSIReque¡
 *
»q
)

518 
MSDS‹
 *
s
 = 
	`DO_UPCAST
(MSDS‹, 
dev
.
qdev
, 
»q
->
bus
->
qbus
.
·»Á
);

521 
	`as£¹
(
s
->
»q
 =ğ
NULL
);

522 
	`scsi_»q_»f
(
»q
);

523 
s
->
»q
 =„eq;

524  
NULL
;

525 
	}
}

527 cÚ¡ 
SCSIBusInfo
 
	gusb_msd_scsi_šfo
 = {

528 .
tcq
 = 
çl£
,

529 .
	gmax_rg‘
 = 0,

530 .
	gmax_lun
 = 0,

532 .
	gŒªsãr_d©a
 = 
usb_msd_Œªsãr_d©a
,

533 .
	gcom¶‘e
 = 
usb_msd_commªd_com¶‘e
,

534 .
	gÿnûl
 = 
usb_msd_»que¡_ÿnûÎed
,

535 .
	glßd_»que¡
 = 
usb_msd_lßd_»que¡
,

538 
	$usb_msd_š™â
(
USBDeviû
 *
dev
)

540 
MSDS‹
 *
s
 = 
	`DO_UPCAST
(MSDS‹, 
dev
, dev);

541 
BlockDriv”S‹
 *
bs
 = 
s
->
cÚf
.bs;

543 ià(!
bs
) {

544 
	`”rÜ_»pÜt
("drive…roperty‚ot set");

548 
	`blkcÚf_£rŸl
(&
s
->
cÚf
, &s->
£rŸl
);

559 
	`bdrv_d‘ach_dev
(
bs
, &
s
->
dev
.
qdev
);

560 
s
->
cÚf
.
bs
 = 
NULL
;

562 ià(
s
->
£rŸl
) {

563 
	`usb_desc_£t_¡ršg
(
dev
, 
STR_SERIALNUMBER
, 
s
->
£rŸl
);

565 
	`usb_desc_ü—‹_£rŸl
(
dev
);

568 
	`usb_desc_š™
(
dev
);

569 
	`scsi_bus_Ãw
(&
s
->
bus
, &s->
dev
.
qdev
, &
usb_msd_scsi_šfo
);

570 
s
->
scsi_dev
 = 
	`scsi_bus_Ëgacy_add_drive
(&s->
bus
, 
bs
, 0, !!s->
»movabË
,

571 
s
->
cÚf
.
boÙšdex
);

572 ià(!
s
->
scsi_dev
) {

575 
s
->
bus
.
qbus
.
®low_hÙ¶ug
 = 0;

576 
	`usb_msd_hªdË_»£t
(
dev
);

578 ià(
	`bdrv_key_»quœed
(
bs
)) {

579 ià(
cur_mÚ
) {

580 
	`mÚ™Ü_»ad_bdrv_key_¡¬t
(
cur_mÚ
, 
bs
, 
usb_msd_·sswÜd_cb
, 
s
);

581 
s
->
dev
.
auto_©ch
 = 0;

583 
auto¡¬t
 = 0;

588 
	}
}

590 
USBDeviû
 *
	$usb_msd_š™
(
USBBus
 *
bus
, cÚ¡ *
f’ame
)

592 
Ä
=0;

593 
id
[8];

594 
QemuO±s
 *
İts
;

595 
DriveInfo
 *
dšfo
;

596 
USBDeviû
 *
dev
;

597 cÚ¡ *
p1
;

598 
fmt
[32];

601 
	`¢´štf
(
id
, (id), "usb%d", 
Ä
++);

602 
İts
 = 
	`qemu_İts_ü—‹
(
	`qemu_fšd_İts
("drive"), 
id
, 0, 
NULL
);

604 
p1
 = 
	`¡rchr
(
f’ame
, ':');

605 ià(
p1
++) {

606 cÚ¡ *
p2
;

608 ià(
	`¡r¡¬t
(
f’ame
, "fÜm©=", &
p2
)) {

609 
Ën
 = 
	`MIN
(
p1
 - 
p2
, (
fmt
));

610 
	`p¡rıy
(
fmt
, 
Ën
, 
p2
);

611 
	`qemu_İt_£t
(
İts
, "fÜm©", 
fmt
);

612 } ià(*
f’ame
 != ':') {

613 
	`´štf
("uÄecognized USB mass-¡ÜagİtiÚ %s\n", 
f’ame
);

614  
NULL
;

616 
f’ame
 = 
p1
;

618 ià(!*
f’ame
) {

619 
	`´štf
("block device specification‚eeded\n");

620  
NULL
;

622 
	`qemu_İt_£t
(
İts
, "fe", 
f’ame
);

623 
	`qemu_İt_£t
(
İts
, "if", "none");

626 
dšfo
 = 
	`drive_š™
(
İts
, 0);

627 ià(!
dšfo
) {

628 
	`qemu_İts_d–
(
İts
);

629  
NULL
;

633 
dev
 = 
	`usb_ü—‹
(
bus
, "usb-storage");

634 ià(!
dev
) {

635  
NULL
;

637 ià(
	`qdev_´İ_£t_drive
(&
dev
->
qdev
, "drive", 
dšfo
->
bdrv
) < 0) {

638 
	`qdev_ä“
(&
dev
->
qdev
);

639  
NULL
;

641 ià(
	`qdev_š™
(&
dev
->
qdev
) < 0)

642  
NULL
;

644  
dev
;

645 
	}
}

647 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_msd
 = {

648 .
Çme
 = "usb-storage",

649 .
	gv”siÚ_id
 = 1,

650 .
	gmšimum_v”siÚ_id
 = 1,

651 .
	gf›lds
 = (
VMS‹F›ld
 []) {

652 
VMSTATE_USB_DEVICE
(
dev
, 
MSDS‹
),

653 
VMSTATE_UINT32
(
mode
, 
MSDS‹
),

654 
VMSTATE_UINT32
(
scsi_Ën
, 
MSDS‹
),

655 
VMSTATE_UINT32
(
scsi_off
, 
MSDS‹
),

656 
VMSTATE_UINT32
(
d©a_Ën
, 
MSDS‹
),

657 
VMSTATE_UINT32
(
csw
.
sig
, 
MSDS‹
),

658 
VMSTATE_UINT32
(
csw
.
g
, 
MSDS‹
),

659 
VMSTATE_UINT32
(
csw
.
»sidue
, 
MSDS‹
),

660 
VMSTATE_UINT8
(
csw
.
¡©us
, 
MSDS‹
),

661 
VMSTATE_END_OF_LIST
()

665 
Prİ”ty
 
	gmsd_´İ”t›s
[] = {

666 
DEFINE_BLOCK_PROPERTIES
(
MSDS‹
, 
cÚf
),

667 
DEFINE_PROP_STRING
("£rŸl", 
MSDS‹
, 
£rŸl
),

668 
DEFINE_PROP_BIT
("»movabË", 
MSDS‹
, 
»movabË
, 0, 
çl£
),

669 
DEFINE_PROP_END_OF_LIST
(),

672 
	$usb_msd_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

674 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

675 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

677 
uc
->
š™
 = 
usb_msd_š™â
;

678 
uc
->
´oduù_desc
 = "QEMU USB MSD";

679 
uc
->
usb_desc
 = &
desc
;

680 
uc
->
ÿnûl_·ck‘
 = 
usb_msd_ÿnûl_io
;

681 
uc
->
hªdË_©ch
 = 
usb_desc_©ch
;

682 
uc
->
hªdË_»£t
 = 
usb_msd_hªdË_»£t
;

683 
uc
->
hªdË_cÚŒŞ
 = 
usb_msd_hªdË_cÚŒŞ
;

684 
uc
->
hªdË_d©a
 = 
usb_msd_hªdË_d©a
;

685 
dc
->
fw_Çme
 = "storage";

686 
dc
->
vmsd
 = &
vm¡©e_usb_msd
;

687 
dc
->
´İs
 = 
msd_´İ”t›s
;

688 
	}
}

690 
Ty³Info
 
	gmsd_šfo
 = {

691 .
Çme
 = "usb-storage",

692 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

693 .
	gš¡ªû_size
 = (
MSDS‹
),

694 .
	gşass_š™
 = 
usb_msd_şass_š™â
,

697 
	$usb_msd_»gi¡”_ty³s
()

699 
	`ty³_»gi¡”_¡©ic
(&
msd_šfo
);

700 
	`usb_Ëgacy_»gi¡”
("usb-¡Üage", "disk", 
usb_msd_š™
);

701 
	}
}

703 
ty³_š™
(
usb_msd_»gi¡”_ty³s
)

	@dev-uas.c

12 
	~"qemu-commÚ.h
"

13 
	~"qemu-İtiÚ.h
"

14 
	~"qemu-cÚfig.h
"

15 
	~"Œaû.h
"

17 
	~"hw/usb.h
"

18 
	~"hw/usb/desc.h
"

19 
	~"hw/scsi.h
"

20 
	~"hw/scsi-defs.h
"

24 
	#UAS_UI_COMMAND
 0x01

	)

25 
	#UAS_UI_SENSE
 0x03

	)

26 
	#UAS_UI_RESPONSE
 0x04

	)

27 
	#UAS_UI_TASK_MGMT
 0x05

	)

28 
	#UAS_UI_READ_READY
 0x06

	)

29 
	#UAS_UI_WRITE_READY
 0x07

	)

31 
	#UAS_RC_TMF_COMPLETE
 0x00

	)

32 
	#UAS_RC_INVALID_INFO_UNIT
 0x02

	)

33 
	#UAS_RC_TMF_NOT_SUPPORTED
 0x04

	)

34 
	#UAS_RC_TMF_FAILED
 0x05

	)

35 
	#UAS_RC_TMF_SUCCEEDED
 0x08

	)

36 
	#UAS_RC_INCORRECT_LUN
 0x09

	)

37 
	#UAS_RC_OVERLAPPED_TAG
 0x0a

	)

39 
	#UAS_TMF_ABORT_TASK
 0x01

	)

40 
	#UAS_TMF_ABORT_TASK_SET
 0x02

	)

41 
	#UAS_TMF_CLEAR_TASK_SET
 0x04

	)

42 
	#UAS_TMF_LOGICAL_UNIT_RESET
 0x08

	)

43 
	#UAS_TMF_I_T_NEXUS_RESET
 0x10

	)

44 
	#UAS_TMF_CLEAR_ACA
 0x40

	)

45 
	#UAS_TMF_QUERY_TASK
 0x80

	)

46 
	#UAS_TMF_QUERY_TASK_SET
 0x81

	)

47 
	#UAS_TMF_QUERY_ASYNC_EVENT
 0x82

	)

49 
	#UAS_PIPE_ID_COMMAND
 0x01

	)

50 
	#UAS_PIPE_ID_STATUS
 0x02

	)

51 
	#UAS_PIPE_ID_DATA_IN
 0x03

	)

52 
	#UAS_PIPE_ID_DATA_OUT
 0x04

	)

55 
ušt8_t
 
	mid
;

56 
ušt8_t
 
	m»£rved
;

57 
ušt16_t
 
	mg
;

58 } 
	tQEMU_PACKED
 
	tuas_ui_h—d”
;

61 
ušt8_t
 
	m´io_sk©Œ
;

62 
ušt8_t
 
	m»£rved_1
;

63 
ušt8_t
 
	madd_cdb_Ëngth
;

64 
ušt8_t
 
	m»£rved_2
;

65 
ušt64_t
 
	mlun
;

66 
ušt8_t
 
	mcdb
[16];

67 
ušt8_t
 
	madd_cdb
[];

68 } 
	tQEMU_PACKED
 
	tuas_ui_commªd
;

71 
ušt16_t
 
	m¡©us_qu®if›r
;

72 
ušt8_t
 
	m¡©us
;

73 
ušt8_t
 
	m»£rved
[7];

74 
ušt16_t
 
	m£n£_Ëngth
;

75 
ušt8_t
 
	m£n£_d©a
[18];

76 } 
	tQEMU_PACKED
 
	tuas_ui_£n£
;

79 
ušt16_t
 
	madd_»¥Ú£_šfo
;

80 
ušt8_t
 
	m»¥Ú£_code
;

81 } 
	tQEMU_PACKED
 
	tuas_ui_»¥Ú£
;

84 
ušt8_t
 
	mfunùiÚ
;

85 
ušt8_t
 
	m»£rved
;

86 
ušt16_t
 
	msk_g
;

87 
ušt64_t
 
	mlun
;

88 } 
	tQEMU_PACKED
 
	tuas_ui_sk_mgmt
;

91 
uas_ui_h—d”
 
	mhdr
;

93 
uas_ui_commªd
 
	mcommªd
;

94 
uas_ui_£n£
 
	m£n£
;

95 
uas_ui_sk_mgmt
 
	msk
;

96 
uas_ui_»¥Ú£
 
	m»¥Ú£
;

98 } 
	tQEMU_PACKED
 
	tuas_ui
;

102 
UASDeviû
 
	tUASDeviû
;

103 
UASReque¡
 
	tUASReque¡
;

104 
UASStus
 
	tUASStus
;

106 
	sUASDeviû
 {

107 
USBDeviû
 
	mdev
;

108 
SCSIBus
 
	mbus
;

109 
UASReque¡
 *
	md©aš
;

110 
UASReque¡
 *
	md©aout
;

111 
USBPack‘
 *
	m¡©us
;

112 
QEMUBH
 *
	m¡©us_bh
;

113 
QTAILQ_HEAD
(, 
UASStus
è
	m»suÉs
;

114 
QTAILQ_HEAD
(, 
UASReque¡
è
	m»que¡s
;

117 
	sUASReque¡
 {

118 
ušt16_t
 
	mg
;

119 
ušt64_t
 
	mlun
;

120 
UASDeviû
 *
	muas
;

121 
SCSIDeviû
 *
	mdev
;

122 
SCSIReque¡
 *
	m»q
;

123 
USBPack‘
 *
	md©a
;

124 
boŞ
 
	md©a_async
;

125 
boŞ
 
	maùive
;

126 
boŞ
 
	mcom¶‘e
;

127 
ušt32_t
 
	mbuf_off
;

128 
ušt32_t
 
	mbuf_size
;

129 
ušt32_t
 
	md©a_off
;

130 
ušt32_t
 
	md©a_size
;

131 
QTAILQ_ENTRY
(
UASReque¡
è
	mÃxt
;

134 
	sUASStus
 {

135 
uas_ui
 
	m¡©us
;

136 
ušt32_t
 
	mËngth
;

137 
QTAILQ_ENTRY
(
UASStus
è
	mÃxt
;

143 
	mSTR_MANUFACTURER
 = 1,

144 
	mSTR_PRODUCT
,

145 
	mSTR_SERIALNUMBER
,

146 
	mSTR_CONFIG_HIGH
,

149 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

150 [
STR_MANUFACTURER
] = "QEMU",

151 [
STR_PRODUCT
] = "USB Attached SCSI HBA",

152 [
STR_SERIALNUMBER
] = "27842",

153 [
STR_CONFIG_HIGH
] = "High speed config (usb 2.0)",

156 cÚ¡ 
USBDescIçû
 
	gdesc_içû_high
 = {

157 .
bIÁ”çûNumb”
 = 0,

158 .
	gbNumEndpošts
 = 4,

159 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_MASS_STORAGE
,

160 .
	gbIÁ”çûSubCÏss
 = 0x06,

161 .
	gbIÁ”çûPrÙocŞ
 = 0x62,

162 .
	g•s
 = (
USBDescEndpošt
[]) {

164 .
bEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
UAS_PIPE_ID_COMMAND
,

165 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

166 .
	gwMaxPack‘Size
 = 512,

167 .
	gexŒa
 = (
ušt8_t
[]) {

170 
UAS_PIPE_ID_COMMAND
,

174 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
UAS_PIPE_ID_STATUS
,

175 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

176 .
	gwMaxPack‘Size
 = 512,

177 .
	gexŒa
 = (
ušt8_t
[]) {

180 
UAS_PIPE_ID_STATUS
,

184 .
	gbEndpoštAdd»ss
 = 
USB_DIR_IN
 | 
UAS_PIPE_ID_DATA_IN
,

185 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

186 .
	gwMaxPack‘Size
 = 512,

187 .
	gexŒa
 = (
ušt8_t
[]) {

190 
UAS_PIPE_ID_DATA_IN
,

194 .
	gbEndpoštAdd»ss
 = 
USB_DIR_OUT
 | 
UAS_PIPE_ID_DATA_OUT
,

195 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

196 .
	gwMaxPack‘Size
 = 512,

197 .
	gexŒa
 = (
ušt8_t
[]) {

200 
UAS_PIPE_ID_DATA_OUT
,

207 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_high
 = {

208 .
bcdUSB
 = 0x0200,

209 .
	gbMaxPack‘Size0
 = 64,

210 .
	gbNumCÚfigu¿tiÚs
 = 1,

211 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

213 .
bNumIÁ”çûs
 = 1,

214 .
	gbCÚfigu¿tiÚV®ue
 = 1,

215 .
	giCÚfigu¿tiÚ
 = 
STR_CONFIG_HIGH
,

216 .
	gbmA‰ribu‹s
 = 0xc0,

217 .
	gnif
 = 1,

218 .
	gifs
 = &
desc_içû_high
,

223 cÚ¡ 
USBDesc
 
	gdesc
 = {

224 .
id
 = {

225 .
idV’dÜ
 = 0x46f4,

226 .
	gidProduù
 = 0x0003,

227 .
	gbcdDeviû
 = 0,

228 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

229 .
	giProduù
 = 
STR_PRODUCT
,

230 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

232 .
	ghigh
 = &
desc_deviû_high
,

233 .
	g¡r
 = 
desc_¡ršgs
,

238 
UASStus
 *
	$usb_uas_®loc_¡©us
(
ušt8_t
 
id
, 
ušt16_t
 
g
)

240 
UASStus
 *
¡
 = 
	`g_Ãw0
(UASStatus, 1);

242 
¡
->
¡©us
.
hdr
.
id
 = id;

243 
¡
->
¡©us
.
hdr
.
g
 = 
	`ıu_to_be16
(tag);

244 
¡
->
Ëngth
 = (
uas_ui_h—d”
);

245  
¡
;

246 
	}
}

248 
	$usb_uas_£nd_¡©us_bh
(*
İaque
)

250 
UASDeviû
 *
uas
 = 
İaque
;

251 
UASStus
 *
¡
 = 
	`QTAILQ_FIRST
(&
uas
->
»suÉs
);

252 
USBPack‘
 *
p
 = 
uas
->
¡©us
;

254 
	`as£¹
(
p
 !ğ
NULL
);

255 
	`as£¹
(
¡
 !ğ
NULL
);

257 
uas
->
¡©us
 = 
NULL
;

258 
	`usb_·ck‘_cİy
(
p
, &
¡
->
¡©us
, st->
Ëngth
);

259 
p
->
»suÉ
 = 
¡
->
Ëngth
;

260 
	`QTAILQ_REMOVE
(&
uas
->
»suÉs
, 
¡
, 
Ãxt
);

261 
	`g_ä“
(
¡
);

263 
	`usb_·ck‘_com¶‘e
(&
uas
->
dev
, 
p
);

264 
	}
}

266 
	$usb_uas_queue_¡©us
(
UASDeviû
 *
uas
, 
UASStus
 *
¡
, 
Ëngth
)

268 
¡
->
Ëngth
 +=†ength;

269 
	`QTAILQ_INSERT_TAIL
(&
uas
->
»suÉs
, 
¡
, 
Ãxt
);

270 ià(
uas
->
¡©us
) {

275 
	`qemu_bh_scheduË
(
uas
->
¡©us_bh
);

277 
USBEndpošt
 *
•
 = 
	`usb_•_g‘
(&
uas
->
dev
, 
USB_TOKEN_IN
,

278 
UAS_PIPE_ID_STATUS
);

279 
	`usb_wakeup
(
•
);

281 
	}
}

283 
	$usb_uas_queue_»¥Ú£
(
UASDeviû
 *
uas
, 
ušt16_t
 
g
,

284 
ušt8_t
 
code
, 
ušt16_t
 
add_šfo
)

286 
UASStus
 *
¡
 = 
	`usb_uas_®loc_¡©us
(
UAS_UI_RESPONSE
, 
g
);

288 
	`Œaû_usb_uas_»¥Ú£
(
uas
->
dev
.
addr
, 
g
, 
code
);

289 
¡
->
¡©us
.
»¥Ú£
.
»¥Ú£_code
 = 
code
;

290 
¡
->
¡©us
.
»¥Ú£
.
add_»¥Ú£_šfo
 = 
	`ıu_to_be16
(
add_šfo
);

291 
	`usb_uas_queue_¡©us
(
uas
, 
¡
, (
uas_ui_»¥Ú£
));

292 
	}
}

294 
	$usb_uas_queue_£n£
(
UASReque¡
 *
»q
, 
ušt8_t
 
¡©us
)

296 
UASStus
 *
¡
 = 
	`usb_uas_®loc_¡©us
(
UAS_UI_SENSE
, 
»q
->
g
);

297 
Ën
, 
¦’
 = 0;

299 
	`Œaû_usb_uas_£n£
(
»q
->
uas
->
dev
.
addr
,„eq->
g
, 
¡©us
);

300 
¡
->
¡©us
.
£n£
.status = status;

301 
¡
->
¡©us
.
£n£
.
¡©us_qu®if›r
 = 
	`ıu_to_be16
(0);

302 ià(
¡©us
 !ğ
GOOD
) {

303 
¦’
 = 
	`scsi_»q_g‘_£n£
(
»q
->»q, 
¡
->
¡©us
.
£n£
.
£n£_d©a
,

304 (
¡
->
¡©us
.
£n£
.
£n£_d©a
));

305 
¡
->
¡©us
.
£n£
.
£n£_Ëngth
 = 
	`ıu_to_be16
(
¦’
);

307 
Ën
 = (
uas_ui_£n£
è- (
¡
->
¡©us
.
£n£
.
£n£_d©a
è+ 
¦’
;

308 
	`usb_uas_queue_¡©us
(
»q
->
uas
, 
¡
, 
Ën
);

309 
	}
}

311 
	$usb_uas_queue_»ad_»ady
(
UASReque¡
 *
»q
)

313 
UASStus
 *
¡
 = 
	`usb_uas_®loc_¡©us
(
UAS_UI_READ_READY
, 
»q
->
g
);

315 
	`Œaû_usb_uas_»ad_»ady
(
»q
->
uas
->
dev
.
addr
,„eq->
g
);

316 
	`usb_uas_queue_¡©us
(
»q
->
uas
, 
¡
, 0);

317 
	}
}

319 
	$usb_uas_queue_wr™e_»ady
(
UASReque¡
 *
»q
)

321 
UASStus
 *
¡
 = 
	`usb_uas_®loc_¡©us
(
UAS_UI_WRITE_READY
, 
»q
->
g
);

323 
	`Œaû_usb_uas_wr™e_»ady
(
»q
->
uas
->
dev
.
addr
,„eq->
g
);

324 
	`usb_uas_queue_¡©us
(
»q
->
uas
, 
¡
, 0);

325 
	}
}

329 
	$usb_uas_g‘_lun
(
ušt64_t
 
lun64
)

331  (
lun64
 >> 48) & 0xff;

332 
	}
}

334 
SCSIDeviû
 *
	$usb_uas_g‘_dev
(
UASDeviû
 *
uas
, 
ušt64_t
 
lun64
)

336 ià((
lun64
 >> 56) != 0x00) {

337  
NULL
;

339  
	`scsi_deviû_fšd
(&
uas
->
bus
, 0, 0, 
	`usb_uas_g‘_lun
(
lun64
));

340 
	}
}

342 
	$usb_uas_com¶‘e_d©a_·ck‘
(
UASReque¡
 *
»q
)

344 
USBPack‘
 *
p
;

346 ià(!
»q
->
d©a_async
) {

349 
p
 = 
»q
->
d©a
;

350 
»q
->
d©a
 = 
NULL
;

351 
»q
->
d©a_async
 = 
çl£
;

352 
	`usb_·ck‘_com¶‘e
(&
»q
->
uas
->
dev
, 
p
);

353 
	}
}

355 
	$usb_uas_cİy_d©a
(
UASReque¡
 *
»q
)

357 
ušt32_t
 
Ëngth
;

359 
Ëngth
 = 
	`MIN
(
»q
->
buf_size
 -„eq->
buf_off
,

360 
»q
->
d©a
->
iov
.
size
 -„eq->d©a->
»suÉ
);

361 
	`Œaû_usb_uas_xãr_d©a
(
»q
->
uas
->
dev
.
addr
,„eq->
g
, 
Ëngth
,

362 
»q
->
d©a
->
»suÉ
,„eq->d©a->
iov
.
size
,

363 
»q
->
buf_off
,„eq->
buf_size
);

364 
	`usb_·ck‘_cİy
(
»q
->
d©a
, 
	`scsi_»q_g‘_buf
Ôeq->»qè+„eq->
buf_off
,

365 
Ëngth
);

366 
»q
->
buf_off
 +ğ
Ëngth
;

367 
»q
->
d©a_off
 +ğ
Ëngth
;

369 ià(
»q
->
d©a
->
»suÉ
 =ğ»q->d©a->
iov
.
size
) {

370 
	`usb_uas_com¶‘e_d©a_·ck‘
(
»q
);

372 ià(
»q
->
buf_size
 &&„eq->
buf_off
 ==„eq->buf_size) {

373 
»q
->
buf_off
 = 0;

374 
»q
->
buf_size
 = 0;

375 
	`scsi_»q_cÚtšue
(
»q
->req);

377 
	}
}

379 
	$usb_uas_¡¬t_Ãxt_Œªsãr
(
UASDeviû
 *
uas
)

381 
UASReque¡
 *
»q
;

383 
	`QTAILQ_FOREACH
(
»q
, &
uas
->
»que¡s
, 
Ãxt
) {

384 ià(
»q
->
aùive
 ||„eq->
com¶‘e
) {

387 ià(
»q
->»q->
cmd
.
mode
 =ğ
SCSI_XFER_FROM_DEV
 && 
uas
->
d©aš
 =ğ
NULL
) {

388 
uas
->
d©aš
 = 
»q
;

389 
	`usb_uas_queue_»ad_»ady
(
»q
);

390 
»q
->
aùive
 = 
Œue
;

393 ià(
»q
->»q->
cmd
.
mode
 =ğ
SCSI_XFER_TO_DEV
 && 
uas
->
d©aout
 =ğ
NULL
) {

394 
uas
->
d©aout
 = 
»q
;

395 
	`usb_uas_queue_wr™e_»ady
(
»q
);

396 
»q
->
aùive
 = 
Œue
;

400 
	}
}

402 
UASReque¡
 *
	$usb_uas_®loc_»que¡
(
UASDeviû
 *
uas
, 
uas_ui
 *
ui
)

404 
UASReque¡
 *
»q
;

406 
»q
 = 
	`g_Ãw0
(
UASReque¡
, 1);

407 
»q
->
uas
 = uas;

408 
»q
->
g
 = 
	`be16_to_ıu
(
ui
->
hdr
.tag);

409 
»q
->
lun
 = 
	`be64_to_ıu
(
ui
->
commªd
.lun);

410 
»q
->
dev
 = 
	`usb_uas_g‘_dev
Ôeq->
uas
,„eq->
lun
);

411  
»q
;

412 
	}
}

414 
	$usb_uas_scsi_ä“_»que¡
(
SCSIBus
 *
bus
, *
´iv
)

416 
UASReque¡
 *
»q
 = 
´iv
;

417 
UASDeviû
 *
uas
 = 
»q
->uas;

419 ià(
»q
 =ğ
uas
->
d©aš
) {

420 
uas
->
d©aš
 = 
NULL
;

422 ià(
»q
 =ğ
uas
->
d©aout
) {

423 
uas
->
d©aout
 = 
NULL
;

425 
	`QTAILQ_REMOVE
(&
uas
->
»que¡s
, 
»q
, 
Ãxt
);

426 
	`g_ä“
(
»q
);

427 
	`usb_uas_¡¬t_Ãxt_Œªsãr
(
uas
);

428 
	}
}

430 
UASReque¡
 *
	$usb_uas_fšd_»que¡
(
UASDeviû
 *
uas
, 
ušt16_t
 
g
)

432 
UASReque¡
 *
»q
;

434 
	`QTAILQ_FOREACH
(
»q
, &
uas
->
»que¡s
, 
Ãxt
) {

435 ià(
»q
->
g
 ==ag) {

436  
»q
;

439  
NULL
;

440 
	}
}

442 
	$usb_uas_scsi_Œªsãr_d©a
(
SCSIReque¡
 *
r
, 
ušt32_t
 
Ën
)

444 
UASReque¡
 *
»q
 = 
r
->
hba_´iv©e
;

446 
	`Œaû_usb_uas_scsi_d©a
(
»q
->
uas
->
dev
.
addr
,„eq->
g
, 
Ën
);

447 
»q
->
buf_off
 = 0;

448 
»q
->
buf_size
 = 
Ën
;

449 ià(
»q
->
d©a
) {

450 
	`usb_uas_cİy_d©a
(
»q
);

452 
	`usb_uas_¡¬t_Ãxt_Œªsãr
(
»q
->
uas
);

454 
	}
}

456 
	$usb_uas_scsi_commªd_com¶‘e
(
SCSIReque¡
 *
r
,

457 
ušt32_t
 
¡©us
, 
size_t
 
»sid
)

459 
UASReque¡
 *
»q
 = 
r
->
hba_´iv©e
;

461 
	`Œaû_usb_uas_scsi_com¶‘e
(
»q
->
uas
->
dev
.
addr
,„eq->
g
, 
¡©us
, 
»sid
);

462 
»q
->
com¶‘e
 = 
Œue
;

463 ià(
»q
->
d©a
) {

464 
	`usb_uas_com¶‘e_d©a_·ck‘
(
»q
);

466 
	`usb_uas_queue_£n£
(
»q
, 
¡©us
);

467 
	`scsi_»q_uÄef
(
»q
->req);

468 
	}
}

470 
	$usb_uas_scsi_»que¡_ÿnûÎed
(
SCSIReque¡
 *
r
)

472 
UASReque¡
 *
»q
 = 
r
->
hba_´iv©e
;

475 
	`scsi_»q_uÄef
(
»q
->req);

476 
	}
}

478 cÚ¡ 
SCSIBusInfo
 
	gusb_uas_scsi_šfo
 = {

479 .
tcq
 = 
Œue
,

480 .
	gmax_rg‘
 = 0,

481 .
	gmax_lun
 = 255,

483 .
	gŒªsãr_d©a
 = 
usb_uas_scsi_Œªsãr_d©a
,

484 .
	gcom¶‘e
 = 
usb_uas_scsi_commªd_com¶‘e
,

485 .
	gÿnûl
 = 
usb_uas_scsi_»que¡_ÿnûÎed
,

486 .
	gä“_»que¡
 = 
usb_uas_scsi_ä“_»que¡
,

491 
	$usb_uas_hªdË_»£t
(
USBDeviû
 *
dev
)

493 
UASDeviû
 *
uas
 = 
	`DO_UPCAST
(UASDeviû, 
dev
, dev);

494 
UASReque¡
 *
»q
, *
Äeq
;

495 
UASStus
 *
¡
, *
n¡
;

497 
	`Œaû_usb_uas_»£t
(
dev
->
addr
);

498 
	`QTAILQ_FOREACH_SAFE
(
»q
, &
uas
->
»que¡s
, 
Ãxt
, 
Äeq
) {

499 
	`scsi_»q_ÿnûl
(
»q
->req);

501 
	`QTAILQ_FOREACH_SAFE
(
¡
, &
uas
->
»suÉs
, 
Ãxt
, 
n¡
) {

502 
	`QTAILQ_REMOVE
(&
uas
->
»suÉs
, 
¡
, 
Ãxt
);

503 
	`g_ä“
(
¡
);

505 
	}
}

507 
	$usb_uas_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

508 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

510 
»t
;

512 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

513 ià(
»t
 >= 0) {

514  
»t
;

516 
	`årštf
(
¡d”r
, "%s: unhªdËd cÚŒŞ„eque¡\n", 
__func__
);

517  
USB_RET_STALL
;

518 
	}
}

520 
	$usb_uas_ÿnûl_io
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

522 
UASDeviû
 *
uas
 = 
	`DO_UPCAST
(UASDeviû, 
dev
, dev);

523 
UASReque¡
 *
»q
, *
Äeq
;

525 ià(
uas
->
¡©us
 =ğ
p
) {

526 
uas
->
¡©us
 = 
NULL
;

527 
	`qemu_bh_ÿnûl
(
uas
->
¡©us_bh
);

530 
	`QTAILQ_FOREACH_SAFE
(
»q
, &
uas
->
»que¡s
, 
Ãxt
, 
Äeq
) {

531 ià(
»q
->
d©a
 =ğ
p
) {

532 
»q
->
d©a
 = 
NULL
;

536 
	`as£¹
(!"canceled usb…acket‚ot found");

537 
	}
}

539 
	$usb_uas_commªd
(
UASDeviû
 *
uas
, 
uas_ui
 *
ui
)

541 
UASReque¡
 *
»q
;

542 
ušt32_t
 
Ën
;

544 
»q
 = 
	`usb_uas_fšd_»que¡
(
uas
, 
	`be16_to_ıu
(
ui
->
hdr
.
g
));

545 ià(
»q
) {

546 
ov”Ïµed_g
;

548 
»q
 = 
	`usb_uas_®loc_»que¡
(
uas
, 
ui
);

549 ià(
»q
->
dev
 =ğ
NULL
) {

550 
bad_rg‘
;

553 
	`Œaû_usb_uas_commªd
(
uas
->
dev
.
addr
, 
»q
->
g
,

554 
	`usb_uas_g‘_lun
(
»q
->
lun
),

555 
»q
->
lun
 >> 32,„eq->lun & 0xffffffff);

556 
	`QTAILQ_INSERT_TAIL
(&
uas
->
»que¡s
, 
»q
, 
Ãxt
);

557 
»q
->»q = 
	`scsi_»q_Ãw
Ôeq->
dev
,„eq->
g
,

558 
	`usb_uas_g‘_lun
(
»q
->
lun
),

559 
ui
->
commªd
.
cdb
, 
»q
);

560 
Ën
 = 
	`scsi_»q_’queue
(
»q
->req);

561 ià(
Ën
) {

562 
»q
->
d©a_size
 = 
Ën
;

563 
	`scsi_»q_cÚtšue
(
»q
->req);

567 
ov”Ïµed_g
:

568 
	`usb_uas_queue_»¥Ú£
(
uas
, 
»q
->
g
, 
UAS_RC_OVERLAPPED_TAG
, 0);

571 
bad_rg‘
:

577 
	`usb_uas_queue_»¥Ú£
(
uas
, 
»q
->
g
, 
UAS_RC_INVALID_INFO_UNIT
, 0);

578 
	`g_ä“
(
»q
);

580 
	}
}

582 
	$usb_uas_sk
(
UASDeviû
 *
uas
, 
uas_ui
 *
ui
)

584 
ušt16_t
 
g
 = 
	`be16_to_ıu
(
ui
->
hdr
.tag);

585 
ušt64_t
 
lun64
 = 
	`be64_to_ıu
(
ui
->
sk
.
lun
);

586 
SCSIDeviû
 *
dev
 = 
	`usb_uas_g‘_dev
(
uas
, 
lun64
);

587 
lun
 = 
	`usb_uas_g‘_lun
(
lun64
);

588 
UASReque¡
 *
»q
;

589 
ušt16_t
 
sk_g
;

591 
»q
 = 
	`usb_uas_fšd_»que¡
(
uas
, 
	`be16_to_ıu
(
ui
->
hdr
.
g
));

592 ià(
»q
) {

593 
ov”Ïµed_g
;

596 
ui
->
sk
.
funùiÚ
) {

597 
UAS_TMF_ABORT_TASK
:

598 
sk_g
 = 
	`be16_to_ıu
(
ui
->
sk
.task_tag);

599 
	`Œaû_usb_uas_tmf_abÜt_sk
(
uas
->
dev
.
addr
, 
g
, 
sk_g
);

600 ià(
dev
 =ğ
NULL
) {

601 
bad_rg‘
;

603 ià(
dev
->
lun
 !=†un) {

604 
šcÜ»ù_lun
;

606 
»q
 = 
	`usb_uas_fšd_»que¡
(
uas
, 
sk_g
);

607 ià(
»q
 &&„eq->
dev
 == dev) {

608 
	`scsi_»q_ÿnûl
(
»q
->req);

610 
	`usb_uas_queue_»¥Ú£
(
uas
, 
g
, 
UAS_RC_TMF_COMPLETE
, 0);

613 
UAS_TMF_LOGICAL_UNIT_RESET
:

614 
	`Œaû_usb_uas_tmf_logiÿl_un™_»£t
(
uas
->
dev
.
addr
, 
g
, 
lun
);

615 ià(
dev
 =ğ
NULL
) {

616 
bad_rg‘
;

618 ià(
dev
->
lun
 !=†un) {

619 
šcÜ»ù_lun
;

621 
	`qdev_»£t_®l
(&
dev
->
qdev
);

622 
	`usb_uas_queue_»¥Ú£
(
uas
, 
g
, 
UAS_RC_TMF_COMPLETE
, 0);

626 
	`Œaû_usb_uas_tmf_unsuµÜ‹d
(
uas
->
dev
.
addr
, 
g
, 
ui
->
sk
.
funùiÚ
);

627 
	`usb_uas_queue_»¥Ú£
(
uas
, 
g
, 
UAS_RC_TMF_NOT_SUPPORTED
, 0);

632 
ov”Ïµed_g
:

633 
	`usb_uas_queue_»¥Ú£
(
uas
, 
»q
->
g
, 
UAS_RC_OVERLAPPED_TAG
, 0);

636 
bad_rg‘
:

638 
	`usb_uas_queue_»¥Ú£
(
uas
, 
g
, 
UAS_RC_INVALID_INFO_UNIT
, 0);

641 
šcÜ»ù_lun
:

642 
	`usb_uas_queue_»¥Ú£
(
uas
, 
g
, 
UAS_RC_INCORRECT_LUN
, 0);

644 
	}
}

646 
	$usb_uas_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

648 
UASDeviû
 *
uas
 = 
	`DO_UPCAST
(UASDeviû, 
dev
, dev);

649 
uas_ui
 
ui
;

650 
UASStus
 *
¡
;

651 
UASReque¡
 *
»q
;

652 
Ëngth
, 
»t
 = 0;

654 
p
->
•
->
Ä
) {

655 
UAS_PIPE_ID_COMMAND
:

656 
Ëngth
 = 
	`MIN
((
ui
), 
p
->
iov
.
size
);

657 
	`usb_·ck‘_cİy
(
p
, &
ui
, 
Ëngth
);

658 
ui
.
hdr
.
id
) {

659 
UAS_UI_COMMAND
:

660 
	`usb_uas_commªd
(
uas
, &
ui
);

661 
»t
 = 
Ëngth
;

663 
UAS_UI_TASK_MGMT
:

664 
	`usb_uas_sk
(
uas
, &
ui
);

665 
»t
 = 
Ëngth
;

668 
	`årštf
(
¡d”r
, "%s: unknown command ui: id 0x%x\n",

669 
__func__
, 
ui
.
hdr
.
id
);

670 
»t
 = 
USB_RET_STALL
;

674 
UAS_PIPE_ID_STATUS
:

675 
¡
 = 
	`QTAILQ_FIRST
(&
uas
->
»suÉs
);

676 ià(
¡
 =ğ
NULL
) {

677 
	`as£¹
(
uas
->
¡©us
 =ğ
NULL
);

678 
uas
->
¡©us
 = 
p
;

679 
»t
 = 
USB_RET_ASYNC
;

682 
	`usb_·ck‘_cİy
(
p
, &
¡
->
¡©us
, st->
Ëngth
);

683 
»t
 = 
¡
->
Ëngth
;

684 
	`QTAILQ_REMOVE
(&
uas
->
»suÉs
, 
¡
, 
Ãxt
);

685 
	`g_ä“
(
¡
);

687 
UAS_PIPE_ID_DATA_IN
:

688 
UAS_PIPE_ID_DATA_OUT
:

689 
»q
 = (
p
->
•
->
Ä
 =ğ
UAS_PIPE_ID_DATA_IN
è? 
uas
->
d©aš
 : uas->
d©aout
;

690 ià(
»q
 =ğ
NULL
) {

691 
	`årštf
(
¡d”r
, "%s:‚Øšæighˆ»que¡\n", 
__func__
);

692 
»t
 = 
USB_RET_STALL
;

695 
	`scsi_»q_»f
(
»q
->req);

696 
»q
->
d©a
 = 
p
;

697 
	`usb_uas_cİy_d©a
(
»q
);

698 ià(
p
->
»suÉ
 =ğp->
iov
.
size
 || 
»q
->
com¶‘e
) {

699 
»q
->
d©a
 = 
NULL
;

700 
»t
 = 
p
->
»suÉ
;

702 
»q
->
d©a_async
 = 
Œue
;

703 
»t
 = 
USB_RET_ASYNC
;

705 
	`scsi_»q_uÄef
(
»q
->req);

706 
	`usb_uas_¡¬t_Ãxt_Œªsãr
(
uas
);

709 
	`årštf
(
¡d”r
, "%s: inv®idƒndpošˆ%d\n", 
__func__
, 
p
->
•
->
Ä
);

710 
»t
 = 
USB_RET_STALL
;

713  
»t
;

714 
	}
}

716 
	$usb_uas_hªdË_de¡roy
(
USBDeviû
 *
dev
)

718 
UASDeviû
 *
uas
 = 
	`DO_UPCAST
(UASDeviû, 
dev
, dev);

720 
	`qemu_bh_d–‘e
(
uas
->
¡©us_bh
);

721 
	}
}

723 
	$usb_uas_š™
(
USBDeviû
 *
dev
)

725 
UASDeviû
 *
uas
 = 
	`DO_UPCAST
(UASDeviû, 
dev
, dev);

727 
	`usb_desc_ü—‹_£rŸl
(
dev
);

728 
	`usb_desc_š™
(
dev
);

730 
	`QTAILQ_INIT
(&
uas
->
»suÉs
);

731 
	`QTAILQ_INIT
(&
uas
->
»que¡s
);

732 
uas
->
¡©us_bh
 = 
	`qemu_bh_Ãw
(
usb_uas_£nd_¡©us_bh
, uas);

734 
	`scsi_bus_Ãw
(&
uas
->
bus
, &uas->
dev
.
qdev
, &
usb_uas_scsi_šfo
);

737 
	}
}

739 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_uas
 = {

740 .
Çme
 = "usb-uas",

741 .
	gunmig¿bË
 = 1,

742 .
	gf›lds
 = (
VMS‹F›ld
[]) {

743 
VMSTATE_USB_DEVICE
(
dev
, 
UASDeviû
),

744 
VMSTATE_END_OF_LIST
()

748 
	$usb_uas_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

750 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

751 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

753 
uc
->
š™
 = 
usb_uas_š™
;

754 
uc
->
´oduù_desc
 = 
desc_¡ršgs
[
STR_PRODUCT
];

755 
uc
->
usb_desc
 = &
desc
;

756 
uc
->
ÿnûl_·ck‘
 = 
usb_uas_ÿnûl_io
;

757 
uc
->
hªdË_©ch
 = 
usb_desc_©ch
;

758 
uc
->
hªdË_»£t
 = 
usb_uas_hªdË_»£t
;

759 
uc
->
hªdË_cÚŒŞ
 = 
usb_uas_hªdË_cÚŒŞ
;

760 
uc
->
hªdË_d©a
 = 
usb_uas_hªdË_d©a
;

761 
uc
->
hªdË_de¡roy
 = 
usb_uas_hªdË_de¡roy
;

762 
dc
->
fw_Çme
 = "storage";

763 
dc
->
vmsd
 = &
vm¡©e_usb_uas
;

764 
	}
}

766 
Ty³Info
 
	guas_šfo
 = {

767 .
Çme
 = "usb-uas",

768 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

769 .
	gš¡ªû_size
 = (
UASDeviû
),

770 .
	gşass_š™
 = 
usb_uas_şass_š™â
,

773 
	$usb_uas_»gi¡”_ty³s
()

775 
	`ty³_»gi¡”_¡©ic
(&
uas_šfo
);

776 
	}
}

778 
ty³_š™
(
usb_uas_»gi¡”_ty³s
)

	@dev-wacom.c

28 
	~"hw/hw.h
"

29 
	~"cÚsŞe.h
"

30 
	~"hw/usb.h
"

31 
	~"hw/usb/desc.h
"

34 
	#WACOM_GET_REPORT
 0x2101

	)

35 
	#WACOM_SET_REPORT
 0x2109

	)

38 
	#HID_GET_REPORT
 0xa101

	)

39 
	#HID_GET_IDLE
 0xa102

	)

40 
	#HID_GET_PROTOCOL
 0xa103

	)

41 
	#HID_SET_IDLE
 0x210a

	)

42 
	#HID_SET_PROTOCOL
 0x210b

	)

44 
	sUSBWacomS‹
 {

45 
USBDeviû
 
	mdev
;

46 
QEMUPutMou£EÁry
 *
	meh_’Œy
;

47 
	mdx
, 
	mdy
, 
	mdz
, 
	mbu‰Ús_¡©e
;

48 
	mx
, 
	my
;

49 
	mmou£_g¿bbed
;

51 
	mWACOM_MODE_HID
 = 1,

52 
	mWACOM_MODE_WACOM
 = 2,

53 } 
	mmode
;

54 
ušt8_t
 
	midË
;

55 
	mchªged
;

56 } 
	tUSBWacomS‹
;

59 
	mSTR_MANUFACTURER
 = 1,

60 
	mSTR_PRODUCT
,

61 
	mSTR_SERIALNUMBER
,

64 cÚ¡ 
USBDescSŒšgs
 
	gdesc_¡ršgs
 = {

65 [
STR_MANUFACTURER
] = "QEMU",

66 [
STR_PRODUCT
] = "Wacom PenPartner",

67 [
STR_SERIALNUMBER
] = "1",

70 cÚ¡ 
USBDescIçû
 
	gdesc_içû_wacom
 = {

71 .
bIÁ”çûNumb”
 = 0,

72 .
	gbNumEndpošts
 = 1,

73 .
	gbIÁ”çûCÏss
 = 
USB_CLASS_HID
,

74 .
	gbIÁ”çûSubCÏss
 = 0x01,

75 .
	gbIÁ”çûPrÙocŞ
 = 0x02,

76 .
	gndesc
 = 1,

77 .
	gdescs
 = (
USBDescOth”
[]) {

80 .
d©a
 = (
ušt8_t
[]) {

91 .
	g•s
 = (
USBDescEndpošt
[]) {

93 .
bEndpoštAdd»ss
 = 
USB_DIR_IN
 | 0x01,

94 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_INT
,

95 .
	gwMaxPack‘Size
 = 8,

96 .
	gbIÁ”v®
 = 0x0a,

101 cÚ¡ 
USBDescDeviû
 
	gdesc_deviû_wacom
 = {

102 .
bcdUSB
 = 0x0110,

103 .
	gbMaxPack‘Size0
 = 8,

104 .
	gbNumCÚfigu¿tiÚs
 = 1,

105 .
	gcÚfs
 = (
USBDescCÚfig
[]) {

107 .
bNumIÁ”çûs
 = 1,

108 .
	gbCÚfigu¿tiÚV®ue
 = 1,

109 .
	gbmA‰ribu‹s
 = 0x80,

110 .
	gbMaxPow”
 = 40,

111 .
	gnif
 = 1,

112 .
	gifs
 = &
desc_içû_wacom
,

117 cÚ¡ 
USBDesc
 
	gdesc_wacom
 = {

118 .
id
 = {

119 .
idV’dÜ
 = 0x056a,

120 .
	gidProduù
 = 0x0000,

121 .
	gbcdDeviû
 = 0x4210,

122 .
	giMªuçùu»r
 = 
STR_MANUFACTURER
,

123 .
	giProduù
 = 
STR_PRODUCT
,

124 .
	giS”ŸlNumb”
 = 
STR_SERIALNUMBER
,

126 .
	gfuÎ
 = &
desc_deviû_wacom
,

127 .
	g¡r
 = 
desc_¡ršgs
,

130 
	$usb_mou£_ev’t
(*
İaque
,

131 
dx1
, 
dy1
, 
dz1
, 
bu‰Ús_¡©e
)

133 
USBWacomS‹
 *
s
 = 
İaque
;

135 
s
->
dx
 +ğ
dx1
;

136 
s
->
dy
 +ğ
dy1
;

137 
s
->
dz
 +ğ
dz1
;

138 
s
->
bu‰Ús_¡©e
 = buttons_state;

139 
s
->
chªged
 = 1;

140 
	}
}

142 
	$usb_wacom_ev’t
(*
İaque
,

143 
x
, 
y
, 
dz
, 
bu‰Ús_¡©e
)

145 
USBWacomS‹
 *
s
 = 
İaque
;

148 
s
->
x
 = (x * 5040 / 0x7FFF);

149 
s
->
y
 = (y * 3780 / 0x7FFF);

150 
s
->
dz
 += dz;

151 
s
->
bu‰Ús_¡©e
 = buttons_state;

152 
s
->
chªged
 = 1;

153 
	}
}

155 
šlše
 
	$št_şamp
(
v®
, 
vmš
, 
vmax
)

157 ià(
v®
 < 
vmš
)

158  
vmš
;

159 ià(
v®
 > 
vmax
)

160  
vmax
;

162  
v®
;

163 
	}
}

165 
	$usb_mou£_pŞl
(
USBWacomS‹
 *
s
, 
ušt8_t
 *
buf
, 
Ën
)

167 
dx
, 
dy
, 
dz
, 
b
, 
l
;

169 ià(!
s
->
mou£_g¿bbed
) {

170 
s
->
eh_’Œy
 = 
	`qemu_add_mou£_ev’t_hªdËr
(
usb_mou£_ev’t
, s, 0,

172 
	`qemu_aùiv©e_mou£_ev’t_hªdËr
(
s
->
eh_’Œy
);

173 
s
->
mou£_g¿bbed
 = 1;

176 
dx
 = 
	`št_şamp
(
s
->dx, -128, 127);

177 
dy
 = 
	`št_şamp
(
s
->dy, -128, 127);

178 
dz
 = 
	`št_şamp
(
s
->dz, -128, 127);

180 
s
->
dx
 -= dx;

181 
s
->
dy
 -= dy;

182 
s
->
dz
 -= dz;

184 
b
 = 0;

185 ià(
s
->
bu‰Ús_¡©e
 & 
MOUSE_EVENT_LBUTTON
)

186 
b
 |= 0x01;

187 ià(
s
->
bu‰Ús_¡©e
 & 
MOUSE_EVENT_RBUTTON
)

188 
b
 |= 0x02;

189 ià(
s
->
bu‰Ús_¡©e
 & 
MOUSE_EVENT_MBUTTON
)

190 
b
 |= 0x04;

192 
buf
[0] = 
b
;

193 
buf
[1] = 
dx
;

194 
buf
[2] = 
dy
;

195 
l
 = 3;

196 ià(
Ën
 >= 4) {

197 
buf
[3] = 
dz
;

198 
l
 = 4;

200  
l
;

201 
	}
}

203 
	$usb_wacom_pŞl
(
USBWacomS‹
 *
s
, 
ušt8_t
 *
buf
, 
Ën
)

205 
b
;

207 ià(!
s
->
mou£_g¿bbed
) {

208 
s
->
eh_’Œy
 = 
	`qemu_add_mou£_ev’t_hªdËr
(
usb_wacom_ev’t
, s, 1,

210 
	`qemu_aùiv©e_mou£_ev’t_hªdËr
(
s
->
eh_’Œy
);

211 
s
->
mou£_g¿bbed
 = 1;

214 
b
 = 0;

215 ià(
s
->
bu‰Ús_¡©e
 & 
MOUSE_EVENT_LBUTTON
)

216 
b
 |= 0x01;

217 ià(
s
->
bu‰Ús_¡©e
 & 
MOUSE_EVENT_RBUTTON
)

218 
b
 |= 0x40;

219 ià(
s
->
bu‰Ús_¡©e
 & 
MOUSE_EVENT_MBUTTON
)

220 
b
 |= 0x20;

222 ià(
Ën
 < 7)

225 
buf
[0] = 
s
->
mode
;

226 
buf
[5] = 0x00 | (
b
 & 0xf0);

227 
buf
[1] = 
s
->
x
 & 0xff;

228 
buf
[2] = 
s
->
x
 >> 8;

229 
buf
[3] = 
s
->
y
 & 0xff;

230 
buf
[4] = 
s
->
y
 >> 8;

231 ià(
b
 & 0x3f) {

232 
buf
[6] = 0;

234 
buf
[6] = () -127;

238 
	}
}

240 
	$usb_wacom_hªdË_»£t
(
USBDeviû
 *
dev
)

242 
USBWacomS‹
 *
s
 = (USBWacomS‹ *è
dev
;

244 
s
->
dx
 = 0;

245 
s
->
dy
 = 0;

246 
s
->
dz
 = 0;

247 
s
->
x
 = 0;

248 
s
->
y
 = 0;

249 
s
->
bu‰Ús_¡©e
 = 0;

250 
s
->
mode
 = 
WACOM_MODE_HID
;

251 
	}
}

253 
	$usb_wacom_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

254 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

256 
USBWacomS‹
 *
s
 = (USBWacomS‹ *è
dev
;

257 
»t
;

259 
»t
 = 
	`usb_desc_hªdË_cÚŒŞ
(
dev
, 
p
, 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
d©a
);

260 ià(
»t
 >= 0) {

261  
»t
;

264 
»t
 = 0;

265 
»que¡
) {

266 
WACOM_SET_REPORT
:

267 ià(
s
->
mou£_g¿bbed
) {

268 
	`qemu_»move_mou£_ev’t_hªdËr
(
s
->
eh_’Œy
);

269 
s
->
mou£_g¿bbed
 = 0;

271 
s
->
mode
 = 
d©a
[0];

272 
»t
 = 0;

274 
WACOM_GET_REPORT
:

275 
d©a
[0] = 0;

276 
d©a
[1] = 
s
->
mode
;

277 
»t
 = 2;

280 
HID_GET_REPORT
:

281 ià(
s
->
mode
 =ğ
WACOM_MODE_HID
)

282 
»t
 = 
	`usb_mou£_pŞl
(
s
, 
d©a
, 
Ëngth
);

283 ià(
s
->
mode
 =ğ
WACOM_MODE_WACOM
)

284 
»t
 = 
	`usb_wacom_pŞl
(
s
, 
d©a
, 
Ëngth
);

286 
HID_GET_IDLE
:

287 
»t
 = 1;

288 
d©a
[0] = 
s
->
idË
;

290 
HID_SET_IDLE
:

291 
s
->
idË
 = (
ušt8_t
è(
v®ue
 >> 8);

292 
»t
 = 0;

295 
»t
 = 
USB_RET_STALL
;

298  
»t
;

299 
	}
}

301 
	$usb_wacom_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

303 
USBWacomS‹
 *
s
 = (USBWacomS‹ *è
dev
;

304 
ušt8_t
 
buf
[
p
->
iov
.
size
];

305 
»t
 = 0;

307 
p
->
pid
) {

308 
USB_TOKEN_IN
:

309 ià(
p
->
•
->
Ä
 == 1) {

310 ià(!(
s
->
chªged
 || s->
idË
))

311  
USB_RET_NAK
;

312 
s
->
chªged
 = 0;

313 ià(
s
->
mode
 =ğ
WACOM_MODE_HID
)

314 
»t
 = 
	`usb_mou£_pŞl
(
s
, 
buf
, 
p
->
iov
.
size
);

315 ià(
s
->
mode
 =ğ
WACOM_MODE_WACOM
)

316 
»t
 = 
	`usb_wacom_pŞl
(
s
, 
buf
, 
p
->
iov
.
size
);

317 
	`usb_·ck‘_cİy
(
p
, 
buf
, 
»t
);

321 
USB_TOKEN_OUT
:

323 
»t
 = 
USB_RET_STALL
;

326  
»t
;

327 
	}
}

329 
	$usb_wacom_hªdË_de¡roy
(
USBDeviû
 *
dev
)

331 
USBWacomS‹
 *
s
 = (USBWacomS‹ *è
dev
;

333 ià(
s
->
mou£_g¿bbed
) {

334 
	`qemu_»move_mou£_ev’t_hªdËr
(
s
->
eh_’Œy
);

335 
s
->
mou£_g¿bbed
 = 0;

337 
	}
}

339 
	$usb_wacom_š™â
(
USBDeviû
 *
dev
)

341 
USBWacomS‹
 *
s
 = 
	`DO_UPCAST
(USBWacomS‹, 
dev
, dev);

342 
	`usb_desc_ü—‹_£rŸl
(
dev
);

343 
	`usb_desc_š™
(
dev
);

344 
s
->
chªged
 = 1;

346 
	}
}

348 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_wacom
 = {

349 .
Çme
 = "usb-wacom",

350 .
	gunmig¿bË
 = 1,

353 
	$usb_wacom_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

355 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

356 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

358 
uc
->
´oduù_desc
 = "QEMU PenPartner Tablet";

359 
uc
->
usb_desc
 = &
desc_wacom
;

360 
uc
->
š™
 = 
usb_wacom_š™â
;

361 
uc
->
hªdË_»£t
 = 
usb_wacom_hªdË_»£t
;

362 
uc
->
hªdË_cÚŒŞ
 = 
usb_wacom_hªdË_cÚŒŞ
;

363 
uc
->
hªdË_d©a
 = 
usb_wacom_hªdË_d©a
;

364 
uc
->
hªdË_de¡roy
 = 
usb_wacom_hªdË_de¡roy
;

365 
dc
->
desc
 = "QEMU PenPartner Tablet";

366 
dc
->
vmsd
 = &
vm¡©e_usb_wacom
;

367 
	}
}

369 
Ty³Info
 
	gwacom_šfo
 = {

370 .
Çme
 = "usb-wacom-tablet",

371 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

372 .
	gš¡ªû_size
 = (
USBWacomS‹
),

373 .
	gşass_š™
 = 
usb_wacom_şass_š™
,

376 
	$usb_wacom_»gi¡”_ty³s
()

378 
	`ty³_»gi¡”_¡©ic
(&
wacom_šfo
);

379 
	`usb_Ëgacy_»gi¡”
("usb-wacom-bËt", "wacom-bËt", 
NULL
);

380 
	}
}

382 
ty³_š™
(
usb_wacom_»gi¡”_ty³s
)

	@hcd-ehci.c

25 
	~"hw/hw.h
"

26 
	~"qemu-tim”.h
"

27 
	~"hw/usb.h
"

28 
	~"hw/pci.h
"

29 
	~"mÚ™Ü.h
"

30 
	~"Œaû.h
"

31 
	~"dma.h
"

33 
	#EHCI_DEBUG
 0

	)

35 #ià
EHCI_DEBUG


36 
	#DPRINTF
 
´štf


	)

38 
	#DPRINTF
(...)

	)

42 
	#USB_RET_PROCERR
 (-99)

	)

44 
	#MMIO_SIZE
 0x1000

	)

47 
	#CAPREGBASE
 0x0000

	)

48 
	#CAPLENGTH
 
CAPREGBASE
 + 0x0000

49 
	#HCIVERSION
 
CAPREGBASE
 + 0x0002

50 
	#HCSPARAMS
 
CAPREGBASE
 + 0x0004

51 
	#HCCPARAMS
 
CAPREGBASE
 + 0x0008

52 
	#EECP
 
HCCPARAMS
 + 1

	)

53 
	#HCSPPORTROUTE1
 
CAPREGBASE
 + 0x000c

	)

54 
	#HCSPPORTROUTE2
 
CAPREGBASE
 + 0x0010

	)

56 
	#OPREGBASE
 0x0020

57 

	)

58 
	#USBCMD
 
OPREGBASE
 + 0x0000

	)

59 
	#USBCMD_RUNSTOP
 (1 << 0)

60 
	#USBCMD_HCRESET
 (1 << 1)

61 
	#USBCMD_FLS
 (3 << 2)

62 
	#USBCMD_FLS_SH
 2

63 
	#USBCMD_PSE
 (1 << 4)

64 
	#USBCMD_ASE
 (1 << 5)

65 
	#USBCMD_IAAD
 (1 << 6)

66 
	#USBCMD_LHCR
 (1 << 7)

67 
	#USBCMD_ASPMC
 (3 << 8)

68 
	#USBCMD_ASPME
 (1 << 11)

69 
	#USBCMD_ITC
 (0x7f << 16)

70 
	#USBCMD_ITC_SH
 16

71 

	)

72 
	#USBSTS
 
OPREGBASE
 + 0x0004

	)

73 
	#USBSTS_RO_MASK
 0x0000003f

	)

74 
	#USBSTS_INT
 (1 << 0)

75 
	#USBSTS_ERRINT
 (1 << 1)

76 
	#USBSTS_PCD
 (1 << 2)

77 
	#USBSTS_FLR
 (1 << 3)

78 
	#USBSTS_HSE
 (1 << 4)

79 
	#USBSTS_IAA
 (1 << 5)

80 
	#USBSTS_HALT
 (1 << 12)

81 
	#USBSTS_REC
 (1 << 13)

82 
	#USBSTS_PSS
 (1 << 14)

83 
	#USBSTS_ASS
 (1 << 15)

84 

	)

89 
	#USBINTR
 
OPREGBASE
 + 0x0008

	)

90 
	#USBINTR_MASK
 0x0000003f

	)

92 
	#FRINDEX
 
OPREGBASE
 + 0x000c

	)

93 
	#CTRLDSSEGMENT
 
OPREGBASE
 + 0x0010

	)

94 
	#PERIODICLISTBASE
 
OPREGBASE
 + 0x0014

	)

95 
	#ASYNCLISTADDR
 
OPREGBASE
 + 0x0018

	)

96 
	#ASYNCLISTADDR_MASK
 0xfffffã0

	)

98 
	#CONFIGFLAG
 
OPREGBASE
 + 0x0040

	)

100 
	#PORTSC
 (
OPREGBASE
 + 0x0044)

	)

101 
	#PORTSC_BEGIN
 
PORTSC


	)

102 
	#PORTSC_END
 (
PORTSC
 + 4 * 
NB_PORTS
)

	)

107 
	#PORTSC_RO_MASK
 0x007001c0

	)

108 
	#PORTSC_RWC_MASK
 0x0000002a

	)

109 
	#PORTSC_WKOC_E
 (1 << 22)

110 
	#PORTSC_WKDS_E
 (1 << 21)

111 
	#PORTSC_WKCN_E
 (1 << 20)

112 
	#PORTSC_PTC
 (15 << 16)

113 
	#PORTSC_PTC_SH
 16

114 
	#PORTSC_PIC
 (3 << 14)

115 
	#PORTSC_PIC_SH
 14

116 
	#PORTSC_POWNER
 (1 << 13)

117 
	#PORTSC_PPOWER
 (1 << 12)

118 
	#PORTSC_LINESTAT
 (3 << 10)

119 
	#PORTSC_LINESTAT_SH
 10

120 
	#PORTSC_PRESET
 (1 << 8)

121 
	#PORTSC_SUSPEND
 (1 << 7)

122 
	#PORTSC_FPRES
 (1 << 6)

123 
	#PORTSC_OCC
 (1 << 5)

124 
	#PORTSC_OCA
 (1 << 4)

125 
	#PORTSC_PEDC
 (1 << 3)

126 
	#PORTSC_PED
 (1 << 2)

127 
	#PORTSC_CSC
 (1 << 1)

128 
	#PORTSC_CONNECT
 (1 << 0)

129 

	)

130 
	#FRAME_TIMER_FREQ
 1000

	)

131 
	#FRAME_TIMER_NS
 (1000000000 / 
FRAME_TIMER_FREQ
)

	)

133 
	#NB_MAXINTRATE
 8

134 
	#NB_PORTS
 6

135 
	#BUFF_SIZE
 5*4096

136 
	#MAX_QH
 100

137 

	)

141 
	mEST_INACTIVE
 = 1000,

142 
	mEST_ACTIVE
,

143 
	mEST_EXECUTING
,

144 
	mEST_SLEEPING
,

147 
	mEST_WAITLISTHEAD
,

148 
	mEST_FETCHENTRY
,

149 
	mEST_FETCHQH
,

150 
	mEST_FETCHITD
,

151 
	mEST_FETCHSITD
,

152 
	mEST_ADVANCEQUEUE
,

153 
	mEST_FETCHQTD
,

154 
	mEST_EXECUTE
,

155 
	mEST_WRITEBACK
,

156 
	mEST_HORIZONTALQH


157 } 
	tEHCI_STATES
;

160 
	#NLPTR_GET
(
x
è((xè& 0xfffffã0)

	)

161 
	#NLPTR_TYPE_GET
(
x
è(((xè>> 1è& 3)

	)

162 
	#NLPTR_TBIT
(
x
) ((x) & 1)

163 

	)

165 
	#NLPTR_TYPE_ITD
 0

166 
	#NLPTR_TYPE_QH
 1

167 
	#NLPTR_TYPE_STITD
 2

168 
	#NLPTR_TYPE_FSTN
 3

169 

	)

173 
	sEHCI™d
 {

174 
ušt32_t
 
	mÃxt
;

176 
ušt32_t
 
	mŒª§ù
[8];

177 
	#ITD_XACT_ACTIVE
 (1 << 31)

	)

178 
	#ITD_XACT_DBERROR
 (1 << 30)

	)

179 
	#ITD_XACT_BABBLE
 (1 << 29)

	)

180 
	#ITD_XACT_XACTERR
 (1 << 28)

	)

181 
	#ITD_XACT_LENGTH_MASK
 0x0fff0000

	)

182 
	#ITD_XACT_LENGTH_SH
 16

	)

183 
	#ITD_XACT_IOC
 (1 << 15)

	)

184 
	#ITD_XACT_PGSEL_MASK
 0x00007000

	)

185 
	#ITD_XACT_PGSEL_SH
 12

	)

186 
	#ITD_XACT_OFFSET_MASK
 0x00000fff

	)

188 
ušt32_t
 
	mbuåŒ
[7];

189 
	#ITD_BUFPTR_MASK
 0xfffff000

	)

190 
	#ITD_BUFPTR_SH
 12

	)

191 
	#ITD_BUFPTR_EP_MASK
 0x00000f00

	)

192 
	#ITD_BUFPTR_EP_SH
 8

	)

193 
	#ITD_BUFPTR_DEVADDR_MASK
 0x0000007f

	)

194 
	#ITD_BUFPTR_DEVADDR_SH
 0

	)

195 
	#ITD_BUFPTR_DIRECTION
 (1 << 11)

	)

196 
	#ITD_BUFPTR_MAXPKT_MASK
 0x000007ff

	)

197 
	#ITD_BUFPTR_MAXPKT_SH
 0

	)

198 
	#ITD_BUFPTR_MULT_MASK
 0x00000003

	)

199 
	#ITD_BUFPTR_MULT_SH
 0

	)

200 } 
	tEHCI™d
;

204 
	sEHCIs™d
 {

205 
ušt32_t
 
	mÃxt
;

206 
ušt32_t
 
	m•ch¬
;

207 
	#SITD_EPCHAR_IO
 (1 << 31)

	)

208 
	#SITD_EPCHAR_PORTNUM_MASK
 0x7f000000

	)

209 
	#SITD_EPCHAR_PORTNUM_SH
 24

	)

210 
	#SITD_EPCHAR_HUBADD_MASK
 0x007f0000

	)

211 
	#SITD_EPCHAR_HUBADDR_SH
 16

	)

212 
	#SITD_EPCHAR_EPNUM_MASK
 0x00000f00

	)

213 
	#SITD_EPCHAR_EPNUM_SH
 8

	)

214 
	#SITD_EPCHAR_DEVADDR_MASK
 0x0000007f

	)

216 
ušt32_t
 
	muäame
;

217 
	#SITD_UFRAME_CMASK_MASK
 0x0000ff00

	)

218 
	#SITD_UFRAME_CMASK_SH
 8

	)

219 
	#SITD_UFRAME_SMASK_MASK
 0x000000ff

	)

221 
ušt32_t
 
	m»suÉs
;

222 
	#SITD_RESULTS_IOC
 (1 << 31)

	)

223 
	#SITD_RESULTS_PGSEL
 (1 << 30)

	)

224 
	#SITD_RESULTS_TBYTES_MASK
 0x03ff0000

	)

225 
	#SITD_RESULTS_TYBYTES_SH
 16

	)

226 
	#SITD_RESULTS_CPROGMASK_MASK
 0x0000ff00

	)

227 
	#SITD_RESULTS_CPROGMASK_SH
 8

	)

228 
	#SITD_RESULTS_ACTIVE
 (1 << 7)

	)

229 
	#SITD_RESULTS_ERR
 (1 << 6)

	)

230 
	#SITD_RESULTS_DBERR
 (1 << 5)

	)

231 
	#SITD_RESULTS_BABBLE
 (1 << 4)

	)

232 
	#SITD_RESULTS_XACTERR
 (1 << 3)

	)

233 
	#SITD_RESULTS_MISSEDUF
 (1 << 2)

	)

234 
	#SITD_RESULTS_SPLITXSTATE
 (1 << 1)

	)

236 
ušt32_t
 
	mbuåŒ
[2];

237 
	#SITD_BUFPTR_MASK
 0xfffff000

	)

238 
	#SITD_BUFPTR_CURROFF_MASK
 0x00000fff

	)

239 
	#SITD_BUFPTR_TPOS_MASK
 0x00000018

	)

240 
	#SITD_BUFPTR_TPOS_SH
 3

	)

241 
	#SITD_BUFPTR_TCNT_MASK
 0x00000007

	)

243 
ušt32_t
 
	mback±r
;

244 } 
	tEHCIs™d
;

248 
	sEHCIqtd
 {

249 
ušt32_t
 
	mÃxt
;

250 
ušt32_t
 
	m®Šext
;

251 
ušt32_t
 
	mtok’
;

252 
	#QTD_TOKEN_DTOGGLE
 (1 << 31)

	)

253 
	#QTD_TOKEN_TBYTES_MASK
 0x7fff0000

	)

254 
	#QTD_TOKEN_TBYTES_SH
 16

	)

255 
	#QTD_TOKEN_IOC
 (1 << 15)

	)

256 
	#QTD_TOKEN_CPAGE_MASK
 0x00007000

	)

257 
	#QTD_TOKEN_CPAGE_SH
 12

	)

258 
	#QTD_TOKEN_CERR_MASK
 0x00000c00

	)

259 
	#QTD_TOKEN_CERR_SH
 10

	)

260 
	#QTD_TOKEN_PID_MASK
 0x00000300

	)

261 
	#QTD_TOKEN_PID_SH
 8

	)

262 
	#QTD_TOKEN_ACTIVE
 (1 << 7)

	)

263 
	#QTD_TOKEN_HALT
 (1 << 6)

	)

264 
	#QTD_TOKEN_DBERR
 (1 << 5)

	)

265 
	#QTD_TOKEN_BABBLE
 (1 << 4)

	)

266 
	#QTD_TOKEN_XACTERR
 (1 << 3)

	)

267 
	#QTD_TOKEN_MISSEDUF
 (1 << 2)

	)

268 
	#QTD_TOKEN_SPLITXSTATE
 (1 << 1)

	)

269 
	#QTD_TOKEN_PING
 (1 << 0)

	)

271 
ušt32_t
 
	mbuåŒ
[5];

272 
	#QTD_BUFPTR_MASK
 0xfffff000

	)

273 
	#QTD_BUFPTR_SH
 12

	)

274 } 
	tEHCIqtd
;

278 
	sEHCIqh
 {

279 
ušt32_t
 
	mÃxt
;

282 
ušt32_t
 
	m•ch¬
;

283 
	#QH_EPCHAR_RL_MASK
 0xf0000000

	)

284 
	#QH_EPCHAR_RL_SH
 28

	)

285 
	#QH_EPCHAR_C
 (1 << 27)

	)

286 
	#QH_EPCHAR_MPLEN_MASK
 0x07FF0000

	)

287 
	#QH_EPCHAR_MPLEN_SH
 16

	)

288 
	#QH_EPCHAR_H
 (1 << 15)

	)

289 
	#QH_EPCHAR_DTC
 (1 << 14)

	)

290 
	#QH_EPCHAR_EPS_MASK
 0x00003000

	)

291 
	#QH_EPCHAR_EPS_SH
 12

	)

292 
	#EHCI_QH_EPS_FULL
 0

	)

293 
	#EHCI_QH_EPS_LOW
 1

	)

294 
	#EHCI_QH_EPS_HIGH
 2

	)

295 
	#EHCI_QH_EPS_RESERVED
 3

	)

297 
	#QH_EPCHAR_EP_MASK
 0x00000f00

	)

298 
	#QH_EPCHAR_EP_SH
 8

	)

299 
	#QH_EPCHAR_I
 (1 << 7)

	)

300 
	#QH_EPCHAR_DEVADDR_MASK
 0x0000007f

	)

301 
	#QH_EPCHAR_DEVADDR_SH
 0

	)

304 
ušt32_t
 
	m•ÿp
;

305 
	#QH_EPCAP_MULT_MASK
 0xc0000000

	)

306 
	#QH_EPCAP_MULT_SH
 30

	)

307 
	#QH_EPCAP_PORTNUM_MASK
 0x3f800000

	)

308 
	#QH_EPCAP_PORTNUM_SH
 23

	)

309 
	#QH_EPCAP_HUBADDR_MASK
 0x007f0000

	)

310 
	#QH_EPCAP_HUBADDR_SH
 16

	)

311 
	#QH_EPCAP_CMASK_MASK
 0x0000ff00

	)

312 
	#QH_EPCAP_CMASK_SH
 8

	)

313 
	#QH_EPCAP_SMASK_MASK
 0x000000ff

	)

314 
	#QH_EPCAP_SMASK_SH
 0

	)

316 
ušt32_t
 
	mcu¼’t_qtd
;

317 
ušt32_t
 
	mÃxt_qtd
;

318 
ušt32_t
 
	m®Šext_qtd
;

319 
	#QH_ALTNEXT_NAKCNT_MASK
 0x0000001e

	)

320 
	#QH_ALTNEXT_NAKCNT_SH
 1

	)

322 
ušt32_t
 
	mtok’
;

323 
ušt32_t
 
	mbuåŒ
[5];

324 
	#BUFPTR_CPROGMASK_MASK
 0x000000ff

	)

325 
	#BUFPTR_FRAMETAG_MASK
 0x0000001f

	)

326 
	#BUFPTR_SBYTES_MASK
 0x00000ã0

	)

327 
	#BUFPTR_SBYTES_SH
 5

	)

328 } 
	tEHCIqh
;

332 
	sEHCIf¡n
 {

333 
ušt32_t
 
	mÃxt
;

334 
ušt32_t
 
	mback±r
;

335 } 
	tEHCIf¡n
;

337 
EHCIPack‘
 
	tEHCIPack‘
;

338 
EHCIQueue
 
	tEHCIQueue
;

339 
EHCIS‹
 
	tEHCIS‹
;

341 
	easync_¡©e
 {

342 
	mEHCI_ASYNC_NONE
 = 0,

343 
	mEHCI_ASYNC_INFLIGHT
,

344 
	mEHCI_ASYNC_FINISHED
,

347 
	sEHCIPack‘
 {

348 
EHCIQueue
 *
	mqueue
;

349 
QTAILQ_ENTRY
(
EHCIPack‘
è
	mÃxt
;

351 
EHCIqtd
 
	mqtd
;

352 
ušt32_t
 
	mqtdaddr
;

354 
USBPack‘
 
	m·ck‘
;

355 
QEMUSGLi¡
 
	msgl
;

356 
	mpid
;

357 
ušt32_t
 
	mtby‹s
;

358 
async_¡©e
 
	masync
;

359 
	musb_¡©us
;

362 
	sEHCIQueue
 {

363 
EHCIS‹
 *
	mehci
;

364 
QTAILQ_ENTRY
(
EHCIQueue
è
	mÃxt
;

365 
ušt32_t
 
	m£’
;

366 
ušt64_t
 
	mts
;

367 
	masync
;

368 
	m»v®id©e
;

373 
EHCIqh
 
	mqh
;

374 
ušt32_t
 
	mqhaddr
;

375 
ušt32_t
 
	mqtdaddr
;

376 
USBDeviû
 *
	mdev
;

377 
QTAILQ_HEAD
(, 
EHCIPack‘
è
	m·ck‘s
;

380 
	$QTAILQ_HEAD
(
	tEHCIQueueH—d
, 
	tEHCIQueue
) EHCIQueueHead;

382 
	sEHCIS‹
 {

383 
PCIDeviû
 
dev
;

384 
USBBus
 
bus
;

385 
qemu_œq
 
œq
;

386 
MemÜyRegiÚ
 
mem
;

387 
com·niÚ_couÁ
;

390 
ušt32_t
 
maxäames
;

397 
ušt8_t
 
mmio
[
MMIO_SIZE
];

399 
ušt8_t
 
ÿp
[
OPREGBASE
];

400 
ušt32_t
 
usbcmd
;

401 
ušt32_t
 
usb¡s
;

402 
ušt32_t
 
usbšŒ
;

403 
ušt32_t
 
äšdex
;

404 
ušt32_t
 
ù¾ds£gm’t
;

405 
ušt32_t
 
³riodişi¡ba£
;

406 
ušt32_t
 
asynşi¡addr
;

407 
ušt32_t
 
nÙu£d
[9];

408 
ušt32_t
 
cÚfigæag
;

409 
ušt32_t
 
pÜtsc
[
NB_PORTS
];

416 
QEMUTim”
 *
äame_tim”
;

417 
QEMUBH
 *
async_bh
;

418 
ušt32_t
 
a¡©e
;

419 
ušt32_t
 
p¡©e
;

420 
USBPÜt
 
pÜts
[
NB_PORTS
];

421 
USBPÜt
 *
com·niÚ_pÜts
[
NB_PORTS
];

422 
ušt32_t
 
usb¡s_³ndšg
;

423 
ušt32_t
 
usb¡s_äšdex
;

424 
EHCIQueueH—d
 
aqueues
;

425 
EHCIQueueH—d
 
pqueues
;

428 
ušt32_t
 
a_ãtch_addr
;

429 
ušt32_t
 
p_ãtch_addr
;

431 
USBPack‘
 
ack‘
;

432 
QEMUSGLi¡
 
isgl
;

434 
ušt64_t
 
Ï¡_run_ns
;

435 
ušt32_t
 
async_¡•down
;

438 
	#SET_LAST_RUN_CLOCK
(
s
) \

439 (
s
)->
Ï¡_run_ns
 = 
	`qemu_g‘_şock_ns
(
vm_şock
);

	)

442 
	#g‘_f›ld
(
d©a
, 
f›ld
) \

443 (((
d©a
è& 
f›ld
##
_MASK
è>> f›ld##
_SH
)

	)

445 
	#£t_f›ld
(
d©a
, 
Ãwv®
, 
f›ld
) do { \

446 
ušt32_t
 
v®
 = *
d©a
; \

447 
v®
 &ğ~ 
f›ld
##
_MASK
; \

448 
v®
 |ğ((
Ãwv®
è<< 
f›ld
##
_SH
è& f›ld##
_MASK
; \

449 *
d©a
 = 
v®
; \

450 
	}
} 0)

	)

452 cÚ¡ *
	gehci_¡©e_Çmes
[] = {

453 [
EST_INACTIVE
] = "INACTIVE",

454 [
EST_ACTIVE
] = "ACTIVE",

455 [
EST_EXECUTING
] = "EXECUTING",

456 [
EST_SLEEPING
] = "SLEEPING",

457 [
EST_WAITLISTHEAD
] = "WAITLISTHEAD",

458 [
EST_FETCHENTRY
] = "FETCH ENTRY",

459 [
EST_FETCHQH
] = "FETCH QH",

460 [
EST_FETCHITD
] = "FETCH ITD",

461 [
EST_ADVANCEQUEUE
] = "ADVANCEQUEUE",

462 [
EST_FETCHQTD
] = "FETCH QTD",

463 [
EST_EXECUTE
] = "EXECUTE",

464 [
EST_WRITEBACK
] = "WRITEBACK",

465 [
EST_HORIZONTALQH
] = "HORIZONTALQH",

468 cÚ¡ *
	gehci_mmio_Çmes
[] = {

469 [
CAPLENGTH
] = "CAPLENGTH",

470 [
HCIVERSION
] = "HCIVERSION",

471 [
HCSPARAMS
] = "HCSPARAMS",

472 [
HCCPARAMS
] = "HCCPARAMS",

473 [
USBCMD
] = "USBCMD",

474 [
USBSTS
] = "USBSTS",

475 [
USBINTR
] = "USBINTR",

476 [
FRINDEX
] = "FRINDEX",

477 [
PERIODICLISTBASE
] = "P-LIST BASE",

478 [
ASYNCLISTADDR
] = "A-LIST ADDR",

479 [
PORTSC_BEGIN
] = "PORTSC #0",

480 [
PORTSC_BEGIN
 + 4] = "PORTSC #1",

481 [
PORTSC_BEGIN
 + 8] = "PORTSC #2",

482 [
PORTSC_BEGIN
 + 12] = "PORTSC #3",

483 [
PORTSC_BEGIN
 + 16] = "PORTSC #4",

484 [
PORTSC_BEGIN
 + 20] = "PORTSC #5",

485 [
CONFIGFLAG
] = "CONFIGFLAG",

488 cÚ¡ *
	$Ä2¡r
(cÚ¡ **
n
, 
size_t
 
Ën
, 
ušt32_t
 
Ä
)

490 ià(
Ä
 < 
Ën
 && 
n
[Ä] !ğ
NULL
) {

491  
n
[
Ä
];

495 
	}
}

497 cÚ¡ *
	$¡©e2¡r
(
ušt32_t
 
¡©e
)

499  
	`Ä2¡r
(
ehci_¡©e_Çmes
, 
	`ARRAY_SIZE
Óhci_¡©e_Çmes), 
¡©e
);

500 
	}
}

502 cÚ¡ *
	$addr2¡r
(
rg‘_phys_addr_t
 
addr
)

504  
	`Ä2¡r
(
ehci_mmio_Çmes
, 
	`ARRAY_SIZE
Óhci_mmio_Çmes), 
addr
);

505 
	}
}

507 
	$ehci_Œaû_usb¡s
(
ušt32_t
 
mask
, 
¡©e
)

510 ià(
mask
 & 
USBSTS_INT
) {

511 
	`Œaû_usb_ehci_usb¡s
("INT", 
¡©e
);

513 ià(
mask
 & 
USBSTS_ERRINT
) {

514 
	`Œaû_usb_ehci_usb¡s
("ERRINT", 
¡©e
);

516 ià(
mask
 & 
USBSTS_PCD
) {

517 
	`Œaû_usb_ehci_usb¡s
("PCD", 
¡©e
);

519 ià(
mask
 & 
USBSTS_FLR
) {

520 
	`Œaû_usb_ehci_usb¡s
("FLR", 
¡©e
);

522 ià(
mask
 & 
USBSTS_HSE
) {

523 
	`Œaû_usb_ehci_usb¡s
("HSE", 
¡©e
);

525 ià(
mask
 & 
USBSTS_IAA
) {

526 
	`Œaû_usb_ehci_usb¡s
("IAA", 
¡©e
);

530 ià(
mask
 & 
USBSTS_HALT
) {

531 
	`Œaû_usb_ehci_usb¡s
("HALT", 
¡©e
);

533 ià(
mask
 & 
USBSTS_REC
) {

534 
	`Œaû_usb_ehci_usb¡s
("REC", 
¡©e
);

536 ià(
mask
 & 
USBSTS_PSS
) {

537 
	`Œaû_usb_ehci_usb¡s
("PSS", 
¡©e
);

539 ià(
mask
 & 
USBSTS_ASS
) {

540 
	`Œaû_usb_ehci_usb¡s
("ASS", 
¡©e
);

542 
	}
}

544 
šlše
 
	$ehci_£t_usb¡s
(
EHCIS‹
 *
s
, 
mask
)

546 ià((
s
->
usb¡s
 & 
mask
) == mask) {

549 
	`ehci_Œaû_usb¡s
(
mask
, 1);

550 
s
->
usb¡s
 |ğ
mask
;

551 
	}
}

553 
šlše
 
	$ehci_ş—r_usb¡s
(
EHCIS‹
 *
s
, 
mask
)

555 ià((
s
->
usb¡s
 & 
mask
) == 0) {

558 
	`ehci_Œaû_usb¡s
(
mask
, 0);

559 
s
->
usb¡s
 &ğ~
mask
;

560 
	}
}

563 
šlše
 
	$ehci_upd©e_œq
(
EHCIS‹
 *
s
)

565 
Ëv–
 = 0;

567 ià((
s
->
usb¡s
 & 
USBINTR_MASK
è& s->
usbšŒ
) {

568 
Ëv–
 = 1;

571 
	`Œaû_usb_ehci_œq
(
Ëv–
, 
s
->
äšdex
, s->
usb¡s
, s->
usbšŒ
);

572 
	`qemu_£t_œq
(
s
->
œq
, 
Ëv–
);

573 
	}
}

576 
šlše
 
	$ehci_¿i£_œq
(
EHCIS‹
 *
s
, 
šŒ
)

578 ià(
šŒ
 & (
USBSTS_PCD
 | 
USBSTS_FLR
 | 
USBSTS_HSE
)) {

579 
s
->
usb¡s
 |ğ
šŒ
;

580 
	`ehci_upd©e_œq
(
s
);

582 
s
->
usb¡s_³ndšg
 |ğ
šŒ
;

584 
	}
}

590 
šlše
 
	$ehci_comm™_œq
(
EHCIS‹
 *
s
)

592 
ušt32_t
 
™c
;

594 ià(!
s
->
usb¡s_³ndšg
) {

597 ià(
s
->
usb¡s_äšdex
 > s->
äšdex
) {

601 
™c
 = (
s
->
usbcmd
 >> 16) & 0xff;

602 
s
->
usb¡s
 |ğs->
usb¡s_³ndšg
;

603 
s
->
usb¡s_³ndšg
 = 0;

604 
s
->
usb¡s_äšdex
 = s->
äšdex
 + 
™c
;

605 
	`ehci_upd©e_œq
(
s
);

606 
	}
}

608 
	$ehci_upd©e_h®t
(
EHCIS‹
 *
s
)

610 ià(
s
->
usbcmd
 & 
USBCMD_RUNSTOP
) {

611 
	`ehci_ş—r_usb¡s
(
s
, 
USBSTS_HALT
);

613 ià(
s
->
a¡©e
 =ğ
EST_INACTIVE
 && s->
p¡©e
 == EST_INACTIVE) {

614 
	`ehci_£t_usb¡s
(
s
, 
USBSTS_HALT
);

617 
	}
}

619 
	$ehci_£t_¡©e
(
EHCIS‹
 *
s
, 
async
, 
¡©e
)

621 ià(
async
) {

622 
	`Œaû_usb_ehci_¡©e
("async", 
	`¡©e2¡r
(
¡©e
));

623 
s
->
a¡©e
 = 
¡©e
;

624 ià(
s
->
a¡©e
 =ğ
EST_INACTIVE
) {

625 
	`ehci_ş—r_usb¡s
(
s
, 
USBSTS_ASS
);

626 
	`ehci_upd©e_h®t
(
s
);

628 
	`ehci_£t_usb¡s
(
s
, 
USBSTS_ASS
);

631 
	`Œaû_usb_ehci_¡©e
("³riodic", 
	`¡©e2¡r
(
¡©e
));

632 
s
->
p¡©e
 = 
¡©e
;

633 ià(
s
->
p¡©e
 =ğ
EST_INACTIVE
) {

634 
	`ehci_ş—r_usb¡s
(
s
, 
USBSTS_PSS
);

635 
	`ehci_upd©e_h®t
(
s
);

637 
	`ehci_£t_usb¡s
(
s
, 
USBSTS_PSS
);

640 
	}
}

642 
	$ehci_g‘_¡©e
(
EHCIS‹
 *
s
, 
async
)

644  
async
 ? 
s
->
a¡©e
 : s->
p¡©e
;

645 
	}
}

647 
	$ehci_£t_ãtch_addr
(
EHCIS‹
 *
s
, 
async
, 
ušt32_t
 
addr
)

649 ià(
async
) {

650 
s
->
a_ãtch_addr
 = 
addr
;

652 
s
->
p_ãtch_addr
 = 
addr
;

654 
	}
}

656 
	$ehci_g‘_ãtch_addr
(
EHCIS‹
 *
s
, 
async
)

658  
async
 ? 
s
->
a_ãtch_addr
 : s->
p_ãtch_addr
;

659 
	}
}

661 
	$ehci_Œaû_qh
(
EHCIQueue
 *
q
, 
rg‘_phys_addr_t
 
addr
, 
EHCIqh
 *
qh
)

664 
	`Œaû_usb_ehci_qh_±rs
(
q
, 
addr
, 
qh
->
Ãxt
,

665 
qh
->
cu¼’t_qtd
, qh->
Ãxt_qtd
, qh->
®Šext_qtd
);

666 
	`Œaû_usb_ehci_qh_f›lds
(
addr
,

667 
	`g‘_f›ld
(
qh
->
•ch¬
, 
QH_EPCHAR_RL
),

668 
	`g‘_f›ld
(
qh
->
•ch¬
, 
QH_EPCHAR_MPLEN
),

669 
	`g‘_f›ld
(
qh
->
•ch¬
, 
QH_EPCHAR_EPS
),

670 
	`g‘_f›ld
(
qh
->
•ch¬
, 
QH_EPCHAR_EP
),

671 
	`g‘_f›ld
(
qh
->
•ch¬
, 
QH_EPCHAR_DEVADDR
));

672 
	`Œaû_usb_ehci_qh_b™s
(
addr
,

673 (
boŞ
)(
qh
->
•ch¬
 & 
QH_EPCHAR_C
),

674 (
boŞ
)(
qh
->
•ch¬
 & 
QH_EPCHAR_H
),

675 (
boŞ
)(
qh
->
•ch¬
 & 
QH_EPCHAR_DTC
),

676 (
boŞ
)(
qh
->
•ch¬
 & 
QH_EPCHAR_I
));

677 
	}
}

679 
	$ehci_Œaû_qtd
(
EHCIQueue
 *
q
, 
rg‘_phys_addr_t
 
addr
, 
EHCIqtd
 *
qtd
)

682 
	`Œaû_usb_ehci_qtd_±rs
(
q
, 
addr
, 
qtd
->
Ãxt
, qtd->
®Šext
);

683 
	`Œaû_usb_ehci_qtd_f›lds
(
addr
,

684 
	`g‘_f›ld
(
qtd
->
tok’
, 
QTD_TOKEN_TBYTES
),

685 
	`g‘_f›ld
(
qtd
->
tok’
, 
QTD_TOKEN_CPAGE
),

686 
	`g‘_f›ld
(
qtd
->
tok’
, 
QTD_TOKEN_CERR
),

687 
	`g‘_f›ld
(
qtd
->
tok’
, 
QTD_TOKEN_PID
));

688 
	`Œaû_usb_ehci_qtd_b™s
(
addr
,

689 (
boŞ
)(
qtd
->
tok’
 & 
QTD_TOKEN_IOC
),

690 (
boŞ
)(
qtd
->
tok’
 & 
QTD_TOKEN_ACTIVE
),

691 (
boŞ
)(
qtd
->
tok’
 & 
QTD_TOKEN_HALT
),

692 (
boŞ
)(
qtd
->
tok’
 & 
QTD_TOKEN_BABBLE
),

693 (
boŞ
)(
qtd
->
tok’
 & 
QTD_TOKEN_XACTERR
));

694 
	}
}

696 
	$ehci_Œaû_™d
(
EHCIS‹
 *
s
, 
rg‘_phys_addr_t
 
addr
, 
EHCI™d
 *
™d
)

698 
	`Œaû_usb_ehci_™d
(
addr
, 
™d
->
Ãxt
,

699 
	`g‘_f›ld
(
™d
->
buåŒ
[1], 
ITD_BUFPTR_MAXPKT
),

700 
	`g‘_f›ld
(
™d
->
buåŒ
[2], 
ITD_BUFPTR_MULT
),

701 
	`g‘_f›ld
(
™d
->
buåŒ
[0], 
ITD_BUFPTR_EP
),

702 
	`g‘_f›ld
(
™d
->
buåŒ
[0], 
ITD_BUFPTR_DEVADDR
));

703 
	}
}

705 
	$ehci_Œaû_s™d
(
EHCIS‹
 *
s
, 
rg‘_phys_addr_t
 
addr
,

706 
EHCIs™d
 *
s™d
)

708 
	`Œaû_usb_ehci_s™d
(
addr
, 
s™d
->
Ãxt
,

709 (
boŞ
)(
s™d
->
»suÉs
 & 
SITD_RESULTS_ACTIVE
));

710 
	}
}

712 
šlše
 
boŞ
 
	$ehci_’abËd
(
EHCIS‹
 *
s
)

714  
s
->
usbcmd
 & 
USBCMD_RUNSTOP
;

715 
	}
}

717 
šlše
 
boŞ
 
	$ehci_async_’abËd
(
EHCIS‹
 *
s
)

719  
	`ehci_’abËd
(
s
è&& (s->
usbcmd
 & 
USBCMD_ASE
);

720 
	}
}

722 
šlše
 
boŞ
 
	$ehci_³riodic_’abËd
(
EHCIS‹
 *
s
)

724  
	`ehci_’abËd
(
s
è&& (s->
usbcmd
 & 
USBCMD_PSE
);

725 
	}
}

729 
EHCIPack‘
 *
	$ehci_®loc_·ck‘
(
EHCIQueue
 *
q
)

731 
EHCIPack‘
 *
p
;

733 
p
 = 
	`g_Ãw0
(
EHCIPack‘
, 1);

734 
p
->
queue
 = 
q
;

735 
	`usb_·ck‘_š™
(&
p
->
·ck‘
);

736 
	`QTAILQ_INSERT_TAIL
(&
q
->
·ck‘s
, 
p
, 
Ãxt
);

737 
	`Œaû_usb_ehci_·ck‘_aùiÚ
(
p
->
queue
,…, "alloc");

738  
p
;

739 
	}
}

741 
	$ehci_ä“_·ck‘
(
EHCIPack‘
 *
p
)

743 
	`Œaû_usb_ehci_·ck‘_aùiÚ
(
p
->
queue
,…, "free");

744 ià(
p
->
async
 =ğ
EHCI_ASYNC_INFLIGHT
) {

745 
	`usb_ÿnûl_·ck‘
(&
p
->
·ck‘
);

747 
	`QTAILQ_REMOVE
(&
p
->
queue
->
·ck‘s
,…, 
Ãxt
);

748 
	`usb_·ck‘_ş—nup
(&
p
->
·ck‘
);

749 
	`g_ä“
(
p
);

750 
	}
}

754 
EHCIQueue
 *
	$ehci_®loc_queue
(
EHCIS‹
 *
ehci
, 
ušt32_t
 
addr
, 
async
)

756 
EHCIQueueH—d
 *
h—d
 = 
async
 ? &
ehci
->
aqueues
 : &ehci->
pqueues
;

757 
EHCIQueue
 *
q
;

759 
q
 = 
	`g_m®loc0
((*q));

760 
q
->
ehci
 =ƒhci;

761 
q
->
qhaddr
 = 
addr
;

762 
q
->
async
 =‡sync;

763 
	`QTAILQ_INIT
(&
q
->
·ck‘s
);

764 
	`QTAILQ_INSERT_HEAD
(
h—d
, 
q
, 
Ãxt
);

765 
	`Œaû_usb_ehci_queue_aùiÚ
(
q
, "alloc");

766  
q
;

767 
	}
}

769 
	$ehci_ÿnûl_queue
(
EHCIQueue
 *
q
)

771 
EHCIPack‘
 *
p
;

773 
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

774 ià(
p
 =ğ
NULL
) {

778 
	`Œaû_usb_ehci_queue_aùiÚ
(
q
, "cancel");

780 
	`ehci_ä“_·ck‘
(
p
);

781 } (
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
)è!ğ
NULL
);

782 
	}
}

784 
	$ehci_ä“_queue
(
EHCIQueue
 *
q
)

786 
EHCIQueueH—d
 *
h—d
 = 
q
->
async
 ? &q->
ehci
->
aqueues
 : &q->ehci->
pqueues
;

788 
	`Œaû_usb_ehci_queue_aùiÚ
(
q
, "free");

789 
	`ehci_ÿnûl_queue
(
q
);

790 
	`QTAILQ_REMOVE
(
h—d
, 
q
, 
Ãxt
);

791 
	`g_ä“
(
q
);

792 
	}
}

794 
EHCIQueue
 *
	$ehci_fšd_queue_by_qh
(
EHCIS‹
 *
ehci
, 
ušt32_t
 
addr
,

795 
async
)

797 
EHCIQueueH—d
 *
h—d
 = 
async
 ? &
ehci
->
aqueues
 : &ehci->
pqueues
;

798 
EHCIQueue
 *
q
;

800 
	`QTAILQ_FOREACH
(
q
, 
h—d
, 
Ãxt
) {

801 ià(
addr
 =ğ
q
->
qhaddr
) {

802  
q
;

805  
NULL
;

806 
	}
}

808 
	$ehci_queues_g_unu£d_async
(
EHCIS‹
 *
ehci
)

810 
EHCIQueue
 *
q
;

812 
	`QTAILQ_FOREACH
(
q
, &
ehci
->
aqueues
, 
Ãxt
) {

813 ià(!
q
->
£’
) {

814 
q
->
»v®id©e
 = 1;

817 
	}
}

819 
	$ehci_queues_r_unu£d
(
EHCIS‹
 *
ehci
, 
async
)

821 
EHCIQueueH—d
 *
h—d
 = 
async
 ? &
ehci
->
aqueues
 : &ehci->
pqueues
;

822 
ušt64_t
 
maxage
 = 
FRAME_TIMER_NS
 * 
ehci
->
maxäames
 * 4;

823 
EHCIQueue
 *
q
, *
tmp
;

825 
	`QTAILQ_FOREACH_SAFE
(
q
, 
h—d
, 
Ãxt
, 
tmp
) {

826 ià(
q
->
£’
) {

827 
q
->
£’
 = 0;

828 
q
->
ts
 = 
ehci
->
Ï¡_run_ns
;

831 ià(
ehci
->
Ï¡_run_ns
 < 
q
->
ts
 + 
maxage
) {

834 
	`ehci_ä“_queue
(
q
);

836 
	}
}

838 
	$ehci_queues_r_deviû
(
EHCIS‹
 *
ehci
, 
USBDeviû
 *
dev
, 
async
)

840 
EHCIQueueH—d
 *
h—d
 = 
async
 ? &
ehci
->
aqueues
 : &ehci->
pqueues
;

841 
EHCIQueue
 *
q
, *
tmp
;

843 
	`QTAILQ_FOREACH_SAFE
(
q
, 
h—d
, 
Ãxt
, 
tmp
) {

844 ià(
q
->
dev
 != dev) {

847 
	`ehci_ä“_queue
(
q
);

849 
	}
}

851 
	$ehci_queues_r_®l
(
EHCIS‹
 *
ehci
, 
async
)

853 
EHCIQueueH—d
 *
h—d
 = 
async
 ? &
ehci
->
aqueues
 : &ehci->
pqueues
;

854 
EHCIQueue
 *
q
, *
tmp
;

856 
	`QTAILQ_FOREACH_SAFE
(
q
, 
h—d
, 
Ãxt
, 
tmp
) {

857 
	`ehci_ä“_queue
(
q
);

859 
	}
}

863 
	$ehci_©ch
(
USBPÜt
 *
pÜt
)

865 
EHCIS‹
 *
s
 = 
pÜt
->
İaque
;

866 
ušt32_t
 *
pÜtsc
 = &
s
->pÜtsc[
pÜt
->
šdex
];

867 cÚ¡ *
owÃr
 = (*
pÜtsc
 & 
PORTSC_POWNER
) ? "comp" : "ehci";

869 
	`Œaû_usb_ehci_pÜt_©ch
(
pÜt
->
šdex
, 
owÃr
,…Üt->
dev
->
´oduù_desc
);

871 ià(*
pÜtsc
 & 
PORTSC_POWNER
) {

872 
USBPÜt
 *
com·niÚ
 = 
s
->
com·niÚ_pÜts
[
pÜt
->
šdex
];

873 
com·niÚ
->
dev
 = 
pÜt
->dev;

874 
com·niÚ
->
İs
->
	`©ch
(companion);

878 *
pÜtsc
 |ğ
PORTSC_CONNECT
;

879 *
pÜtsc
 |ğ
PORTSC_CSC
;

881 
	`ehci_¿i£_œq
(
s
, 
USBSTS_PCD
);

882 
	`ehci_comm™_œq
(
s
);

883 
	}
}

885 
	$ehci_d‘ach
(
USBPÜt
 *
pÜt
)

887 
EHCIS‹
 *
s
 = 
pÜt
->
İaque
;

888 
ušt32_t
 *
pÜtsc
 = &
s
->pÜtsc[
pÜt
->
šdex
];

889 cÚ¡ *
owÃr
 = (*
pÜtsc
 & 
PORTSC_POWNER
) ? "comp" : "ehci";

891 
	`Œaû_usb_ehci_pÜt_d‘ach
(
pÜt
->
šdex
, 
owÃr
);

893 ià(*
pÜtsc
 & 
PORTSC_POWNER
) {

894 
USBPÜt
 *
com·niÚ
 = 
s
->
com·niÚ_pÜts
[
pÜt
->
šdex
];

895 
com·niÚ
->
İs
->
	`d‘ach
(companion);

896 
com·niÚ
->
dev
 = 
NULL
;

901 *
pÜtsc
 &ğ~
PORTSC_POWNER
;

905 
	`ehci_queues_r_deviû
(
s
, 
pÜt
->
dev
, 0);

906 
	`ehci_queues_r_deviû
(
s
, 
pÜt
->
dev
, 1);

908 *
pÜtsc
 &ğ~(
PORTSC_CONNECT
|
PORTSC_PED
);

909 *
pÜtsc
 |ğ
PORTSC_CSC
;

911 
	`ehci_¿i£_œq
(
s
, 
USBSTS_PCD
);

912 
	`ehci_comm™_œq
(
s
);

913 
	}
}

915 
	$ehci_chd_d‘ach
(
USBPÜt
 *
pÜt
, 
USBDeviû
 *
chd
)

917 
EHCIS‹
 *
s
 = 
pÜt
->
İaque
;

918 
ušt32_t
 
pÜtsc
 = 
s
->pÜtsc[
pÜt
->
šdex
];

920 ià(
pÜtsc
 & 
PORTSC_POWNER
) {

921 
USBPÜt
 *
com·niÚ
 = 
s
->
com·niÚ_pÜts
[
pÜt
->
šdex
];

922 
com·niÚ
->
İs
->
	`chd_d‘ach
(com·niÚ, 
chd
);

926 
	`ehci_queues_r_deviû
(
s
, 
chd
, 0);

927 
	`ehci_queues_r_deviû
(
s
, 
chd
, 1);

928 
	}
}

930 
	$ehci_wakeup
(
USBPÜt
 *
pÜt
)

932 
EHCIS‹
 *
s
 = 
pÜt
->
İaque
;

933 
ušt32_t
 
pÜtsc
 = 
s
->pÜtsc[
pÜt
->
šdex
];

935 ià(
pÜtsc
 & 
PORTSC_POWNER
) {

936 
USBPÜt
 *
com·niÚ
 = 
s
->
com·niÚ_pÜts
[
pÜt
->
šdex
];

937 ià(
com·niÚ
->
İs
->
wakeup
) {

938 
com·niÚ
->
İs
->
	`wakeup
(companion);

943 
	`qemu_bh_scheduË
(
s
->
async_bh
);

944 
	}
}

946 
	$ehci_»gi¡”_com·niÚ
(
USBBus
 *
bus
, 
USBPÜt
 *
pÜts
[],

947 
ušt32_t
 
pÜtcouÁ
, ušt32_ˆ
fœ¡pÜt
)

949 
EHCIS‹
 *
s
 = 
	`cÚš”_of
(
bus
, EHCIState, bus);

950 
ušt32_t
 
i
;

952 ià(
fœ¡pÜt
 + 
pÜtcouÁ
 > 
NB_PORTS
) {

953 
	`q”rÜ_»pÜt
(
QERR_INVALID_PARAMETER_VALUE
, "firstport",

955 
	`”rÜ_´štf_uÆess_qmp
(

957 "i outsidoàthv®id„ªgoà0 - %u\n", 
fœ¡pÜt
, firstport,

958 
fœ¡pÜt
 + 
pÜtcouÁ
 - 1, 
NB_PORTS
 - 1);

962 
i
 = 0; i < 
pÜtcouÁ
; i++) {

963 ià(
s
->
com·niÚ_pÜts
[
fœ¡pÜt
 + 
i
]) {

964 
	`q”rÜ_»pÜt
(
QERR_INVALID_PARAMETER_VALUE
, "masterbus",

966 
	`”rÜ_´štf_uÆess_qmp
(

968 
fœ¡pÜt
 + 
i
, 
bus
->
qbus
.
Çme
);

973 
i
 = 0; i < 
pÜtcouÁ
; i++) {

974 
s
->
com·niÚ_pÜts
[
fœ¡pÜt
 + 
i
] = 
pÜts
[i];

975 
s
->
pÜts
[
fœ¡pÜt
 + 
i
].
¥“dmask
 |=

976 
USB_SPEED_MASK_LOW
 | 
USB_SPEED_MASK_FULL
;

978 
s
->
pÜtsc
[
fœ¡pÜt
 + 
i
] = 
PORTSC_POWNER
;

981 
s
->
com·niÚ_couÁ
++;

982 
s
->
mmio
[0x05] = (s->
com·niÚ_couÁ
 << 4è| 
pÜtcouÁ
;

985 
	}
}

987 
USBDeviû
 *
	$ehci_fšd_deviû
(
EHCIS‹
 *
ehci
, 
ušt8_t
 
addr
)

989 
USBDeviû
 *
dev
;

990 
USBPÜt
 *
pÜt
;

991 
i
;

993 
i
 = 0; i < 
NB_PORTS
; i++) {

994 
pÜt
 = &
ehci
->
pÜts
[
i
];

995 ià(!(
ehci
->
pÜtsc
[
i
] & 
PORTSC_PED
)) {

996 
	`DPRINTF
("PÜˆ%d‚ÙƒÇbËd\n", 
i
);

999 
dev
 = 
	`usb_fšd_deviû
(
pÜt
, 
addr
);

1000 ià(
dev
 !ğ
NULL
) {

1001  
dev
;

1004  
NULL
;

1005 
	}
}

1008 
	$ehci_»£t
(*
İaque
)

1010 
EHCIS‹
 *
s
 = 
İaque
;

1011 
i
;

1012 
USBDeviû
 *
devs
[
NB_PORTS
];

1014 
	`Œaû_usb_ehci_»£t
();

1020 
i
 = 0; i < 
NB_PORTS
; i++) {

1021 
devs
[
i
] = 
s
->
pÜts
[i].
dev
;

1022 ià(
devs
[
i
] && devs[i]->
©ched
) {

1023 
	`usb_d‘ach
(&
s
->
pÜts
[
i
]);

1027 
	`mem£t
(&
s
->
mmio
[
OPREGBASE
], 0x00, 
MMIO_SIZE
 - OPREGBASE);

1029 
s
->
usbcmd
 = 
NB_MAXINTRATE
 << 
USBCMD_ITC_SH
;

1030 
s
->
usb¡s
 = 
USBSTS_HALT
;

1031 
s
->
usb¡s_³ndšg
 = 0;

1032 
s
->
usb¡s_äšdex
 = 0;

1034 
s
->
a¡©e
 = 
EST_INACTIVE
;

1035 
s
->
p¡©e
 = 
EST_INACTIVE
;

1037 
i
 = 0; i < 
NB_PORTS
; i++) {

1038 ià(
s
->
com·niÚ_pÜts
[
i
]) {

1039 
s
->
pÜtsc
[
i
] = 
PORTSC_POWNER
 | 
PORTSC_PPOWER
;

1041 
s
->
pÜtsc
[
i
] = 
PORTSC_PPOWER
;

1043 ià(
devs
[
i
] && devs[i]->
©ched
) {

1044 
	`usb_©ch
(&
s
->
pÜts
[
i
]);

1045 
	`usb_deviû_»£t
(
devs
[
i
]);

1048 
	`ehci_queues_r_®l
(
s
, 0);

1049 
	`ehci_queues_r_®l
(
s
, 1);

1050 
	`qemu_d–_tim”
(
s
->
äame_tim”
);

1051 
	`qemu_bh_ÿnûl
(
s
->
async_bh
);

1052 
	}
}

1054 
ušt32_t
 
	$ehci_mem_»adb
(*
±r
, 
rg‘_phys_addr_t
 
addr
)

1056 
EHCIS‹
 *
s
 = 
±r
;

1057 
ušt32_t
 
v®
;

1059 
v®
 = 
s
->
mmio
[
addr
];

1061  
v®
;

1062 
	}
}

1064 
ušt32_t
 
	$ehci_mem_»adw
(*
±r
, 
rg‘_phys_addr_t
 
addr
)

1066 
EHCIS‹
 *
s
 = 
±r
;

1067 
ušt32_t
 
v®
;

1069 
v®
 = 
s
->
mmio
[
addr
] | (s->mmio[addr+1] << 8);

1071  
v®
;

1072 
	}
}

1074 
ušt32_t
 
	$ehci_mem_»adl
(*
±r
, 
rg‘_phys_addr_t
 
addr
)

1076 
EHCIS‹
 *
s
 = 
±r
;

1077 
ušt32_t
 
v®
;

1079 
v®
 = 
s
->
mmio
[
addr
] | (s->mmio[addr+1] << 8) |

1080 (
s
->
mmio
[
addr
+2] << 16) | (s->mmio[addr+3] << 24);

1082 
	`Œaû_usb_ehci_mmio_»adl
(
addr
, 
	`addr2¡r
×ddr), 
v®
);

1083  
v®
;

1084 
	}
}

1086 
	$ehci_mem_wr™eb
(*
±r
, 
rg‘_phys_addr_t
 
addr
, 
ušt32_t
 
v®
)

1088 
	`årštf
(
¡d”r
, "EHCI doesn't handle byte writeso MMIO\n");

1089 
	`ex™
(1);

1090 
	}
}

1092 
	$ehci_mem_wr™ew
(*
±r
, 
rg‘_phys_addr_t
 
addr
, 
ušt32_t
 
v®
)

1094 
	`årštf
(
¡d”r
, "EHCI doesn't handle 16-bit writeso MMIO\n");

1095 
	`ex™
(1);

1096 
	}
}

1098 
	$hªdË_pÜt_owÃr_wr™e
(
EHCIS‹
 *
s
, 
pÜt
, 
ušt32_t
 
owÃr
)

1100 
USBDeviû
 *
dev
 = 
s
->
pÜts
[
pÜt
].dev;

1101 
ušt32_t
 *
pÜtsc
 = &
s
->pÜtsc[
pÜt
];

1102 
ušt32_t
 
Üig
;

1104 ià(
s
->
com·niÚ_pÜts
[
pÜt
] =ğ
NULL
)

1107 
owÃr
 = owÃ¸& 
PORTSC_POWNER
;

1108 
Üig
 = *
pÜtsc
 & 
PORTSC_POWNER
;

1110 ià(!(
owÃr
 ^ 
Üig
)) {

1114 ià(
dev
 && dev->
©ched
) {

1115 
	`usb_d‘ach
(&
s
->
pÜts
[
pÜt
]);

1118 *
pÜtsc
 &ğ~
PORTSC_POWNER
;

1119 *
pÜtsc
 |ğ
owÃr
;

1121 ià(
dev
 && dev->
©ched
) {

1122 
	`usb_©ch
(&
s
->
pÜts
[
pÜt
]);

1124 
	}
}

1126 
	$hªdË_pÜt_¡©us_wr™e
(
EHCIS‹
 *
s
, 
pÜt
, 
ušt32_t
 
v®
)

1128 
ušt32_t
 *
pÜtsc
 = &
s
->pÜtsc[
pÜt
];

1129 
USBDeviû
 *
dev
 = 
s
->
pÜts
[
pÜt
].dev;

1132 *
pÜtsc
 &ğ~(
v®
 & 
PORTSC_RWC_MASK
);

1134 *
pÜtsc
 &ğ
v®
 | ~
PORTSC_PED
;

1136 
	`hªdË_pÜt_owÃr_wr™e
(
s
, 
pÜt
, 
v®
);

1138 
v®
 &ğ
PORTSC_RO_MASK
;

1140 ià((
v®
 & 
PORTSC_PRESET
è&& !(*
pÜtsc
 & PORTSC_PRESET)) {

1141 
	`Œaû_usb_ehci_pÜt_»£t
(
pÜt
, 1);

1144 ià(!(
v®
 & 
PORTSC_PRESET
è&&(*
pÜtsc
 & PORTSC_PRESET)) {

1145 
	`Œaû_usb_ehci_pÜt_»£t
(
pÜt
, 0);

1146 ià(
dev
 && dev->
©ched
) {

1147 
	`usb_pÜt_»£t
(&
s
->
pÜts
[
pÜt
]);

1148 *
pÜtsc
 &ğ~
PORTSC_CSC
;

1155 ià(
dev
 && dev->
©ched
 && (dev->
¥“dmask
 & 
USB_SPEED_MASK_HIGH
)) {

1156 
v®
 |ğ
PORTSC_PED
;

1160 *
pÜtsc
 &ğ~
PORTSC_RO_MASK
;

1161 *
pÜtsc
 |ğ
v®
;

1162 
	}
}

1164 
	$ehci_mem_wr™–
(*
±r
, 
rg‘_phys_addr_t
 
addr
, 
ušt32_t
 
v®
)

1166 
EHCIS‹
 *
s
 = 
±r
;

1167 
ušt32_t
 *
mmio
 = (ušt32_ˆ*)(&
s
->mmio[
addr
]);

1168 
ušt32_t
 
Şd
 = *
mmio
;

1169 
i
;

1171 
	`Œaû_usb_ehci_mmio_wr™–
(
addr
, 
	`addr2¡r
×ddr), 
v®
);

1174 ià(
addr
 & 3) {

1175 
	`årštf
(
¡d”r
, "usb-ehci: Mis-aligned writeo‡ddr 0x"

1176 
TARGET_FMT_¶x
 "\n", 
addr
);

1180 ià(
addr
 >ğ
PORTSC
 &&‡dd¸< PORTSC + 4 * 
NB_PORTS
) {

1181 
	`hªdË_pÜt_¡©us_wr™e
(
s
, (
addr
-
PORTSC
)/4, 
v®
);

1182 
	`Œaû_usb_ehci_mmio_chªge
(
addr
, 
	`addr2¡r
×ddr), *
mmio
, 
Şd
);

1186 ià(
addr
 < 
OPREGBASE
) {

1187 
	`årštf
(
¡d”r
, "usb-ehci: write‡ttempto„ead-only„egister"

1188 
TARGET_FMT_¶x
 "\n", 
addr
);

1194 
addr
) {

1195 
USBCMD
:

1196 ià(
v®
 & 
USBCMD_HCRESET
) {

1197 
	`ehci_»£t
(
s
);

1198 
v®
 = 
s
->
usbcmd
;

1203 ià((
v®
 & 
USBCMD_FLS
è&& !(
s
->
usbcmd
 & USBCMD_FLS)) {

1204 
	`årštf
(
¡d”r
, "attempto set frame†ist size -- value %d\n",

1205 
v®
 & 
USBCMD_FLS
);

1206 
v®
 &ğ~
USBCMD_FLS
;

1209 ià(
v®
 & 
USBCMD_IAAD
) {

1214 
s
->
async_¡•down
 = 0;

1215 
	`qemu_bh_scheduË
(
s
->
async_bh
);

1218 ià(((
USBCMD_RUNSTOP
 | 
USBCMD_PSE
 | 
USBCMD_ASE
è& 
v®
) !=

1219 ((
USBCMD_RUNSTOP
 | 
USBCMD_PSE
 | 
USBCMD_ASE
è& 
s
->
usbcmd
)) {

1220 ià(
s
->
p¡©e
 =ğ
EST_INACTIVE
) {

1221 
	`SET_LAST_RUN_CLOCK
(
s
);

1223 
s
->
usbcmd
 = 
v®
;

1224 
	`ehci_upd©e_h®t
(
s
);

1225 
s
->
async_¡•down
 = 0;

1226 
	`qemu_mod_tim”
(
s
->
äame_tim”
, 
	`qemu_g‘_şock_ns
(
vm_şock
));

1230 
USBSTS
:

1231 
v®
 &ğ
USBSTS_RO_MASK
;

1232 
	`ehci_ş—r_usb¡s
(
s
, 
v®
);

1233 
v®
 = 
s
->
usb¡s
;

1234 
	`ehci_upd©e_œq
(
s
);

1237 
USBINTR
:

1238 
v®
 &ğ
USBINTR_MASK
;

1241 
FRINDEX
:

1242 
v®
 &= 0x00003ff8;

1245 
CONFIGFLAG
:

1246 
v®
 &= 0x1;

1247 ià(
v®
) {

1248 
i
 = 0; i < 
NB_PORTS
; i++)

1249 
	`hªdË_pÜt_owÃr_wr™e
(
s
, 
i
, 0);

1253 
PERIODICLISTBASE
:

1254 ià(
	`ehci_³riodic_’abËd
(
s
)) {

1255 
	`årštf
(
¡d”r
,

1261 
ASYNCLISTADDR
:

1262 ià(
	`ehci_async_’abËd
(
s
)) {

1263 
	`årštf
(
¡d”r
,

1270 *
mmio
 = 
v®
;

1271 
	`Œaû_usb_ehci_mmio_chªge
(
addr
, 
	`addr2¡r
×ddr), *
mmio
, 
Şd
);

1272 
	}
}

1278 
šlše
 
	$g‘_dwÜds
(
EHCIS‹
 *
ehci
, 
ušt32_t
 
addr
,

1279 
ušt32_t
 *
buf
, 
num
)

1281 
i
;

1283 
i
 = 0; i < 
num
; i++, 
buf
++, 
addr
 += (*buf)) {

1284 
	`pci_dma_»ad
(&
ehci
->
dev
, 
addr
, 
buf
, (*buf));

1285 *
buf
 = 
	`Ë32_to_ıu
(*buf);

1289 
	}
}

1292 
šlše
 
	$put_dwÜds
(
EHCIS‹
 *
ehci
, 
ušt32_t
 
addr
,

1293 
ušt32_t
 *
buf
, 
num
)

1295 
i
;

1297 
i
 = 0; i < 
num
; i++, 
buf
++, 
addr
 += (*buf)) {

1298 
ušt32_t
 
tmp
 = 
	`ıu_to_Ë32
(*
buf
);

1299 
	`pci_dma_wr™e
(&
ehci
->
dev
, 
addr
, &
tmp
, (tmp));

1303 
	}
}

1313 
	$ehci_æush_qh
(
EHCIQueue
 *
q
)

1315 
ušt32_t
 *
qh
 = (ušt32_ˆ*è&
q
->qh;

1316 
ušt32_t
 
dwÜds
 = (
EHCIqh
) >> 2;

1317 
ušt32_t
 
addr
 = 
	`NLPTR_GET
(
q
->
qhaddr
);

1319 
	`put_dwÜds
(
q
->
ehci
, 
addr
 + 3 * (
ušt32_t
), 
qh
 + 3, 
dwÜds
 - 3);

1320 
	}
}

1324 
	$ehci_qh_do_ov”Ïy
(
EHCIQueue
 *
q
)

1326 
EHCIPack‘
 *
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

1327 
i
;

1328 
dtoggË
;

1329 
pšg
;

1330 
•s
;

1331 
»lßd
;

1333 
	`as£¹
(
p
 !ğ
NULL
);

1334 
	`as£¹
(
p
->
qtdaddr
 =ğ
q
->qtdaddr);

1338 
dtoggË
 = 
q
->
qh
.
tok’
 & 
QTD_TOKEN_DTOGGLE
;

1339 
pšg
 = 
q
->
qh
.
tok’
 & 
QTD_TOKEN_PING
;

1341 
q
->
qh
.
cu¼’t_qtd
 = 
p
->
qtdaddr
;

1342 
q
->
qh
.
Ãxt_qtd
 = 
p
->
qtd
.
Ãxt
;

1343 
q
->
qh
.
®Šext_qtd
 = 
p
->
qtd
.
®Šext
;

1344 
q
->
qh
.
tok’
 = 
p
->
qtd
.token;

1347 
•s
 = 
	`g‘_f›ld
(
q
->
qh
.
•ch¬
, 
QH_EPCHAR_EPS
);

1348 ià(
•s
 =ğ
EHCI_QH_EPS_HIGH
) {

1349 
q
->
qh
.
tok’
 &ğ~
QTD_TOKEN_PING
;

1350 
q
->
qh
.
tok’
 |ğ
pšg
;

1353 
»lßd
 = 
	`g‘_f›ld
(
q
->
qh
.
•ch¬
, 
QH_EPCHAR_RL
);

1354 
	`£t_f›ld
(&
q
->
qh
.
®Šext_qtd
, 
»lßd
, 
QH_ALTNEXT_NAKCNT
);

1356 
i
 = 0; i < 5; i++) {

1357 
q
->
qh
.
buåŒ
[
i
] = 
p
->
qtd
.bufptr[i];

1360 ià(!(
q
->
qh
.
•ch¬
 & 
QH_EPCHAR_DTC
)) {

1362 
q
->
qh
.
tok’
 &ğ~
QTD_TOKEN_DTOGGLE
;

1363 
q
->
qh
.
tok’
 |ğ
dtoggË
;

1366 
q
->
qh
.
buåŒ
[1] &ğ~
BUFPTR_CPROGMASK_MASK
;

1367 
q
->
qh
.
buåŒ
[2] &ğ~
BUFPTR_FRAMETAG_MASK
;

1369 
	`ehci_æush_qh
(
q
);

1372 
	}
}

1374 
	$ehci_š™_Œªsãr
(
EHCIPack‘
 *
p
)

1376 
ušt32_t
 
ıage
, 
off£t
, 
by‹s
, 
¶’
;

1377 
dma_addr_t
 
·ge
;

1379 
ıage
 = 
	`g‘_f›ld
(
p
->
qtd
.
tok’
, 
QTD_TOKEN_CPAGE
);

1380 
by‹s
 = 
	`g‘_f›ld
(
p
->
qtd
.
tok’
, 
QTD_TOKEN_TBYTES
);

1381 
off£t
 = 
p
->
qtd
.
buåŒ
[0] & ~
QTD_BUFPTR_MASK
;

1382 
	`pci_dma_sgli¡_š™
(&
p
->
sgl
, &p->
queue
->
ehci
->
dev
, 5);

1384 
by‹s
 > 0) {

1385 ià(
ıage
 > 4) {

1386 
	`årštf
(
¡d”r
, "ıagouˆoà¿ng(%d)\n", 
ıage
);

1387  
USB_RET_PROCERR
;

1390 
·ge
 = 
p
->
qtd
.
buåŒ
[
ıage
] & 
QTD_BUFPTR_MASK
;

1391 
·ge
 +ğ
off£t
;

1392 
¶’
 = 
by‹s
;

1393 ià(
¶’
 > 4096 - 
off£t
) {

1394 
¶’
 = 4096 - 
off£t
;

1395 
off£t
 = 0;

1396 
ıage
++;

1399 
	`qemu_sgli¡_add
(&
p
->
sgl
, 
·ge
, 
¶’
);

1400 
by‹s
 -ğ
¶’
;

1403 
	}
}

1405 
	$ehci_fšish_Œªsãr
(
EHCIQueue
 *
q
, 
¡©us
)

1407 
ušt32_t
 
ıage
, 
off£t
;

1409 ià(
¡©us
 > 0) {

1411 
ıage
 = 
	`g‘_f›ld
(
q
->
qh
.
tok’
, 
QTD_TOKEN_CPAGE
);

1412 
off£t
 = 
q
->
qh
.
buåŒ
[0] & ~
QTD_BUFPTR_MASK
;

1414 
off£t
 +ğ
¡©us
;

1415 
ıage
 +ğ
off£t
 >> 
QTD_BUFPTR_SH
;

1416 
off£t
 &ğ~
QTD_BUFPTR_MASK
;

1418 
	`£t_f›ld
(&
q
->
qh
.
tok’
, 
ıage
, 
QTD_TOKEN_CPAGE
);

1419 
q
->
qh
.
buåŒ
[0] &ğ
QTD_BUFPTR_MASK
;

1420 
q
->
qh
.
buåŒ
[0] |ğ
off£t
;

1422 
	}
}

1424 
	$ehci_async_com¶‘e_·ck‘
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
·ck‘
)

1426 
EHCIPack‘
 *
p
;

1427 
EHCIS‹
 *
s
 = 
pÜt
->
İaque
;

1428 
ušt32_t
 
pÜtsc
 = 
s
->pÜtsc[
pÜt
->
šdex
];

1430 ià(
pÜtsc
 & 
PORTSC_POWNER
) {

1431 
USBPÜt
 *
com·niÚ
 = 
s
->
com·niÚ_pÜts
[
pÜt
->
šdex
];

1432 
com·niÚ
->
İs
->
	`com¶‘e
(com·niÚ, 
·ck‘
);

1436 
p
 = 
	`cÚš”_of
(
·ck‘
, 
EHCIPack‘
,…acket);

1437 
	`Œaû_usb_ehci_·ck‘_aùiÚ
(
p
->
queue
,…, "wakeup");

1438 
	`as£¹
(
p
->
async
 =ğ
EHCI_ASYNC_INFLIGHT
);

1439 
p
->
async
 = 
EHCI_ASYNC_FINISHED
;

1440 
p
->
usb_¡©us
 = 
·ck‘
->
»suÉ
;

1442 ià(
p
->
queue
->
async
) {

1443 
	`qemu_bh_scheduË
(
p
->
queue
->
ehci
->
async_bh
);

1445 
	}
}

1447 
	$ehci_execu‹_com¶‘e
(
EHCIQueue
 *
q
)

1449 
EHCIPack‘
 *
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

1451 
	`as£¹
(
p
 !ğ
NULL
);

1452 
	`as£¹
(
p
->
qtdaddr
 =ğ
q
->qtdaddr);

1453 
	`as£¹
(
p
->
async
 !ğ
EHCI_ASYNC_INFLIGHT
);

1454 
p
->
async
 = 
EHCI_ASYNC_NONE
;

1456 
	`DPRINTF
("execute_complete: qhaddr 0x%x,‚ext %x, qtdaddr 0x%x, status %d\n",

1457 
q
->
qhaddr
, q->
qh
.
Ãxt
, q->
qtdaddr
, q->
usb_¡©us
);

1459 ià(
p
->
usb_¡©us
 < 0) {

1460 
p
->
usb_¡©us
) {

1461 
USB_RET_IOERROR
:

1462 
USB_RET_NODEV
:

1463 
q
->
qh
.
tok’
 |ğ(
QTD_TOKEN_HALT
 | 
QTD_TOKEN_XACTERR
);

1464 
	`£t_f›ld
(&
q
->
qh
.
tok’
, 0, 
QTD_TOKEN_CERR
);

1465 
	`ehci_¿i£_œq
(
q
->
ehci
, 
USBSTS_ERRINT
);

1467 
USB_RET_STALL
:

1468 
q
->
qh
.
tok’
 |ğ
QTD_TOKEN_HALT
;

1469 
	`ehci_¿i£_œq
(
q
->
ehci
, 
USBSTS_ERRINT
);

1471 
USB_RET_NAK
:

1472 
	`£t_f›ld
(&
q
->
qh
.
®Šext_qtd
, 0, 
QH_ALTNEXT_NAKCNT
);

1474 
USB_RET_BABBLE
:

1475 
q
->
qh
.
tok’
 |ğ(
QTD_TOKEN_HALT
 | 
QTD_TOKEN_BABBLE
);

1476 
	`ehci_¿i£_œq
(
q
->
ehci
, 
USBSTS_ERRINT
);

1480 
	`årštf
(
¡d”r
, "USB inv®id„e¥Ú£ %d\n", 
p
->
usb_¡©us
);

1481 
	`as£¹
(0);

1484 } ià((
p
->
usb_¡©us
 >…->
tby‹s
è&& (p->
pid
 =ğ
USB_TOKEN_IN
)) {

1485 
p
->
usb_¡©us
 = 
USB_RET_BABBLE
;

1486 
q
->
qh
.
tok’
 |ğ(
QTD_TOKEN_HALT
 | 
QTD_TOKEN_BABBLE
);

1487 
	`ehci_¿i£_œq
(
q
->
ehci
, 
USBSTS_ERRINT
);

1491 ià(
p
->
tby‹s
 &&…->
pid
 =ğ
USB_TOKEN_IN
) {

1492 
p
->
tby‹s
 -ğp->
usb_¡©us
;

1494 
p
->
tby‹s
 = 0;

1497 
	`DPRINTF
("upd©šgby‹ tØ%d\n", 
p
->
tby‹s
);

1498 
	`£t_f›ld
(&
q
->
qh
.
tok’
, 
p
->
tby‹s
, 
QTD_TOKEN_TBYTES
);

1500 
	`ehci_fšish_Œªsãr
(
q
, 
p
->
usb_¡©us
);

1501 
	`usb_·ck‘_unm­
(&
p
->
·ck‘
, &p->
sgl
);

1502 
	`qemu_sgli¡_de¡roy
(&
p
->
sgl
);

1504 
q
->
qh
.
tok’
 ^ğ
QTD_TOKEN_DTOGGLE
;

1505 
q
->
qh
.
tok’
 &ğ~
QTD_TOKEN_ACTIVE
;

1507 ià(
q
->
qh
.
tok’
 & 
QTD_TOKEN_IOC
) {

1508 
	`ehci_¿i£_œq
(
q
->
ehci
, 
USBSTS_INT
);

1510 
	}
}

1514 
	$ehci_execu‹
(
EHCIPack‘
 *
p
, cÚ¡ *
aùiÚ
)

1516 
USBEndpošt
 *
•
;

1517 
»t
;

1518 
’dp
;

1520 ià(!(
p
->
qtd
.
tok’
 & 
QTD_TOKEN_ACTIVE
)) {

1521 
	`årštf
(
¡d”r
, "Attemptingoƒxecute inactive qtd\n");

1522  
USB_RET_PROCERR
;

1525 
p
->
tby‹s
 = (p->
qtd
.
tok’
 & 
QTD_TOKEN_TBYTES_MASK
è>> 
QTD_TOKEN_TBYTES_SH
;

1526 ià(
p
->
tby‹s
 > 
BUFF_SIZE
) {

1527 
	`årštf
(
¡d”r
, "Request for more byteshan‡llowed\n");

1528  
USB_RET_PROCERR
;

1531 
p
->
pid
 = (p->
qtd
.
tok’
 & 
QTD_TOKEN_PID_MASK
è>> 
QTD_TOKEN_PID_SH
;

1532 
p
->
pid
) {

1534 
p
->
pid
 = 
USB_TOKEN_OUT
;

1537 
p
->
pid
 = 
USB_TOKEN_IN
;

1540 
p
->
pid
 = 
USB_TOKEN_SETUP
;

1543 
	`årštf
(
¡d”r
, "badoken\n");

1547 ià(
	`ehci_š™_Œªsãr
(
p
) != 0) {

1548  
USB_RET_PROCERR
;

1551 
’dp
 = 
	`g‘_f›ld
(
p
->
queue
->
qh
.
•ch¬
, 
QH_EPCHAR_EP
);

1552 
•
 = 
	`usb_•_g‘
(
p
->
queue
->
dev
,…->
pid
, 
’dp
);

1554 
	`usb_·ck‘_£tup
(&
p
->
·ck‘
,…->
pid
, 
•
,…->
qtdaddr
);

1555 
	`usb_·ck‘_m­
(&
p
->
·ck‘
, &p->
sgl
);

1557 
	`Œaû_usb_ehci_·ck‘_aùiÚ
(
p
->
queue
,…, 
aùiÚ
);

1558 
»t
 = 
	`usb_hªdË_·ck‘
(
p
->
queue
->
dev
, &p->
·ck‘
);

1559 
	`DPRINTF
("submit: qh %x‚ext %x qtd %x…id %x†en %zd "

1561 
q
->
qhaddr
, q->
qh
.
Ãxt
, q->
qtdaddr
, q->
pid
,

1562 
q
->
·ck‘
.
iov
.
size
, q->
tby‹s
, 
’dp
, 
»t
);

1564 ià(
»t
 > 
BUFF_SIZE
) {

1565 
	`årštf
(
¡d”r
, "ret from usb_handle_packet > BUFF_SIZE\n");

1566  
USB_RET_PROCERR
;

1569  
»t
;

1570 
	}
}

1575 
	$ehci_´oûss_™d
(
EHCIS‹
 *
ehci
,

1576 
EHCI™d
 *
™d
,

1577 
ušt32_t
 
addr
)

1579 
USBDeviû
 *
dev
;

1580 
USBEndpošt
 *
•
;

1581 
»t
;

1582 
ušt32_t
 
i
, 
Ën
, 
pid
, 
dœ
, 
devaddr
, 
’dp
;

1583 
ušt32_t
 
pg
, 
off
, 
±r1
, 
±r2
, 
max
, 
muÉ
;

1585 
dœ
 =(
™d
->
buåŒ
[1] & 
ITD_BUFPTR_DIRECTION
);

1586 
devaddr
 = 
	`g‘_f›ld
(
™d
->
buåŒ
[0], 
ITD_BUFPTR_DEVADDR
);

1587 
’dp
 = 
	`g‘_f›ld
(
™d
->
buåŒ
[0], 
ITD_BUFPTR_EP
);

1588 
max
 = 
	`g‘_f›ld
(
™d
->
buåŒ
[1], 
ITD_BUFPTR_MAXPKT
);

1589 
muÉ
 = 
	`g‘_f›ld
(
™d
->
buåŒ
[2], 
ITD_BUFPTR_MULT
);

1591 
i
 = 0; i < 8; i++) {

1592 ià(
™d
->
Œª§ù
[
i
] & 
ITD_XACT_ACTIVE
) {

1593 
pg
 = 
	`g‘_f›ld
(
™d
->
Œª§ù
[
i
], 
ITD_XACT_PGSEL
);

1594 
off
 = 
™d
->
Œª§ù
[
i
] & 
ITD_XACT_OFFSET_MASK
;

1595 
±r1
 = (
™d
->
buåŒ
[
pg
] & 
ITD_BUFPTR_MASK
);

1596 
±r2
 = (
™d
->
buåŒ
[
pg
+1] & 
ITD_BUFPTR_MASK
);

1597 
Ën
 = 
	`g‘_f›ld
(
™d
->
Œª§ù
[
i
], 
ITD_XACT_LENGTH
);

1599 ià(
Ën
 > 
max
 * 
muÉ
) {

1600 
Ën
 = 
max
 * 
muÉ
;

1603 ià(
Ën
 > 
BUFF_SIZE
) {

1604  
USB_RET_PROCERR
;

1607 
	`pci_dma_sgli¡_š™
(&
ehci
->
isgl
, &ehci->
dev
, 2);

1608 ià(
off
 + 
Ën
 > 4096) {

1610 
ušt32_t
 
Ën2
 = 
off
 + 
Ën
 - 4096;

1611 
ušt32_t
 
Ën1
 = 
Ën
 - 
Ën2
;

1612 
	`qemu_sgli¡_add
(&
ehci
->
isgl
, 
±r1
 + 
off
, 
Ën1
);

1613 
	`qemu_sgli¡_add
(&
ehci
->
isgl
, 
±r2
, 
Ën2
);

1615 
	`qemu_sgli¡_add
(&
ehci
->
isgl
, 
±r1
 + 
off
, 
Ën
);

1618 
pid
 = 
dœ
 ? 
USB_TOKEN_IN
 : 
USB_TOKEN_OUT
;

1620 
dev
 = 
	`ehci_fšd_deviû
(
ehci
, 
devaddr
);

1621 
•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
’dp
);

1622 ià(
•
 &&ƒp->
ty³
 =ğ
USB_ENDPOINT_XFER_ISOC
) {

1623 
	`usb_·ck‘_£tup
(&
ehci
->
ack‘
, 
pid
, 
•
, 
addr
);

1624 
	`usb_·ck‘_m­
(&
ehci
->
ack‘
, &ehci->
isgl
);

1625 
»t
 = 
	`usb_hªdË_·ck‘
(
dev
, &
ehci
->
ack‘
);

1626 
	`as£¹
(
»t
 !ğ
USB_RET_ASYNC
);

1627 
	`usb_·ck‘_unm­
(&
ehci
->
ack‘
, &ehci->
isgl
);

1629 
	`DPRINTF
("ISOCH:‡ttempto‡ddess‚on-isoƒndpoint\n");

1630 
»t
 = 
USB_RET_NAK
;

1632 
	`qemu_sgli¡_de¡roy
(&
ehci
->
isgl
);

1634 ià(
»t
 < 0) {

1635 
»t
) {

1637 
	`årštf
(
¡d”r
, "UÃx³ùed isØusb„esuÉ: %d\n", 
»t
);

1639 
USB_RET_IOERROR
:

1640 
USB_RET_NODEV
:

1642 ià(
dœ
) {

1643 
™d
->
Œª§ù
[
i
] |ğ
ITD_XACT_XACTERR
;

1644 
	`ehci_¿i£_œq
(
ehci
, 
USBSTS_ERRINT
);

1647 
USB_RET_BABBLE
:

1648 
™d
->
Œª§ù
[
i
] |ğ
ITD_XACT_BABBLE
;

1649 
	`ehci_¿i£_œq
(
ehci
, 
USBSTS_ERRINT
);

1651 
USB_RET_NAK
:

1653 
»t
 = 0;

1657 ià(
»t
 >= 0) {

1658 ià(!
dœ
) {

1660 
	`£t_f›ld
(&
™d
->
Œª§ù
[
i
], 
Ën
 - 
»t
, 
ITD_XACT_LENGTH
);

1663 
	`£t_f›ld
(&
™d
->
Œª§ù
[
i
], 
»t
, 
ITD_XACT_LENGTH
);

1666 ià(
™d
->
Œª§ù
[
i
] & 
ITD_XACT_IOC
) {

1667 
	`ehci_¿i£_œq
(
ehci
, 
USBSTS_INT
);

1669 
™d
->
Œª§ù
[
i
] &ğ~
ITD_XACT_ACTIVE
;

1673 
	}
}

1679 
	$ehci_¡©e_wa™li¡h—d
(
EHCIS‹
 *
ehci
, 
async
)

1681 
EHCIqh
 
qh
;

1682 
i
 = 0;

1683 
agaš
 = 0;

1684 
ušt32_t
 
’Œy
 = 
ehci
->
asynşi¡addr
;

1687 ià(
async
) {

1688 
	`ehci_£t_usb¡s
(
ehci
, 
USBSTS_REC
);

1691 
	`ehci_queues_r_unu£d
(
ehci
, 
async
);

1694 
i
 = 0; i < 
MAX_QH
; i++) {

1695 
	`g‘_dwÜds
(
ehci
, 
	`NLPTR_GET
(
’Œy
), (
ušt32_t
 *è&
qh
,

1696 (
EHCIqh
) >> 2);

1697 
	`ehci_Œaû_qh
(
NULL
, 
	`NLPTR_GET
(
’Œy
), &
qh
);

1699 ià(
qh
.
•ch¬
 & 
QH_EPCHAR_H
) {

1700 ià(
async
) {

1701 
’Œy
 |ğ(
NLPTR_TYPE_QH
 << 1);

1704 
	`ehci_£t_ãtch_addr
(
ehci
, 
async
, 
’Œy
);

1705 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHENTRY
);

1706 
agaš
 = 1;

1707 
out
;

1710 
’Œy
 = 
qh
.
Ãxt
;

1711 ià(
’Œy
 =ğ
ehci
->
asynşi¡addr
) {

1718 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_ACTIVE
);

1720 
out
:

1721  
agaš
;

1722 
	}
}

1728 
	$ehci_¡©e_ãtch’Œy
(
EHCIS‹
 *
ehci
, 
async
)

1730 
agaš
 = 0;

1731 
ušt32_t
 
’Œy
 = 
	`ehci_g‘_ãtch_addr
(
ehci
, 
async
);

1733 ià(
	`NLPTR_TBIT
(
’Œy
)) {

1734 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_ACTIVE
);

1735 
out
;

1739 ià(
async
 && (
	`NLPTR_TYPE_GET
(
’Œy
è!ğ
NLPTR_TYPE_QH
)) {

1740 
	`årštf
(
¡d”r
, "non queue head„equest in‡sync schedule\n");

1744 
	`NLPTR_TYPE_GET
(
’Œy
)) {

1745 
NLPTR_TYPE_QH
:

1746 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHQH
);

1747 
agaš
 = 1;

1750 
NLPTR_TYPE_ITD
:

1751 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHITD
);

1752 
agaš
 = 1;

1755 
NLPTR_TYPE_STITD
:

1756 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHSITD
);

1757 
agaš
 = 1;

1762 
	`årštf
(
¡d”r
, "FETCHENTRY:ƒntry‡t %X is ofype %d "

1763 "which i nÙ suµÜ‹d y‘\n", 
’Œy
, 
	`NLPTR_TYPE_GET
(entry));

1767 
out
:

1768  
agaš
;

1769 
	}
}

1771 
EHCIQueue
 *
	$ehci_¡©e_ãtchqh
(
EHCIS‹
 *
ehci
, 
async
)

1773 
EHCIPack‘
 *
p
;

1774 
ušt32_t
 
’Œy
, 
devaddr
;

1775 
EHCIQueue
 *
q
;

1776 
EHCIqh
 
qh
;

1778 
’Œy
 = 
	`ehci_g‘_ãtch_addr
(
ehci
, 
async
);

1779 
q
 = 
	`ehci_fšd_queue_by_qh
(
ehci
, 
’Œy
, 
async
);

1780 ià(
NULL
 =ğ
q
) {

1781 
q
 = 
	`ehci_®loc_queue
(
ehci
, 
’Œy
, 
async
);

1783 
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

1785 
q
->
£’
++;

1786 ià(
q
->
£’
 > 1) {

1788 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_ACTIVE
);

1789 
q
 = 
NULL
;

1790 
out
;

1793 
	`g‘_dwÜds
(
ehci
, 
	`NLPTR_GET
(
q
->
qhaddr
),

1794 (
ušt32_t
 *è&
qh
, (
EHCIqh
) >> 2);

1795 ià(
q
->
»v®id©e
 && (q->
qh
.
•ch¬
 != qh.epchar ||

1796 
q
->
qh
.
•ÿp
 != qh.epcap ||

1797 
q
->
qh
.
cu¼’t_qtd
 != qh.current_qtd)) {

1798 
	`ehci_ä“_queue
(
q
);

1799 
q
 = 
	`ehci_®loc_queue
(
ehci
, 
’Œy
, 
async
);

1800 
q
->
£’
++;

1801 
p
 = 
NULL
;

1803 
q
->
qh
 = qh;

1804 
q
->
»v®id©e
 = 0;

1805 
	`ehci_Œaû_qh
(
q
, 
	`NLPTR_GET
(q->
qhaddr
), &q->
qh
);

1807 
devaddr
 = 
	`g‘_f›ld
(
q
->
qh
.
•ch¬
, 
QH_EPCHAR_DEVADDR
);

1808 ià(
q
->
dev
 !ğ
NULL
 && q->dev->
addr
 !ğ
devaddr
) {

1809 ià(!
	`QTAILQ_EMPTY
(&
q
->
·ck‘s
)) {

1811 
	`ehci_ÿnûl_queue
(
q
);

1813 
q
->
dev
 = 
NULL
;

1815 ià(
q
->
dev
 =ğ
NULL
) {

1816 
q
->
dev
 = 
	`ehci_fšd_deviû
(q->
ehci
, 
devaddr
);

1819 ià(
p
 &&…->
async
 =ğ
EHCI_ASYNC_FINISHED
) {

1821 
	`Œaû_usb_ehci_·ck‘_aùiÚ
(
p
->
queue
,…, "complete");

1822 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_EXECUTING
);

1823 
out
;

1826 ià(
async
 && (
q
->
qh
.
•ch¬
 & 
QH_EPCHAR_H
)) {

1829 ià(
ehci
->
usb¡s
 & 
USBSTS_REC
) {

1830 
	`ehci_ş—r_usb¡s
(
ehci
, 
USBSTS_REC
);

1832 
	`DPRINTF
("FETCHQH: QH 0x%08x. H-bit set,„eclamation status„eset"

1833 " - dÚ´oûssšg\n", 
q
->
qhaddr
);

1834 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_ACTIVE
);

1835 
q
 = 
NULL
;

1836 
out
;

1840 #ià
EHCI_DEBUG


1841 ià(
q
->
qhaddr
 !ğq->
qh
.
Ãxt
) {

1842 
	`DPRINTF
("FETCHQH: QH 0x%08x (h %x halt %x‡ctive %x)‚ext 0x%08x\n",

1843 
q
->
qhaddr
,

1844 
q
->
qh
.
•ch¬
 & 
QH_EPCHAR_H
,

1845 
q
->
qh
.
tok’
 & 
QTD_TOKEN_HALT
,

1846 
q
->
qh
.
tok’
 & 
QTD_TOKEN_ACTIVE
,

1847 
q
->
qh
.
Ãxt
);

1851 ià(
q
->
qh
.
tok’
 & 
QTD_TOKEN_HALT
) {

1852 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_HORIZONTALQH
);

1854 } ià((
q
->
qh
.
tok’
 & 
QTD_TOKEN_ACTIVE
) &&

1855 (
	`NLPTR_TBIT
(
q
->
qh
.
cu¼’t_qtd
) == 0)) {

1856 
q
->
qtdaddr
 = q->
qh
.
cu¼’t_qtd
;

1857 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHQTD
);

1861 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_ADVANCEQUEUE
);

1864 
out
:

1865  
q
;

1866 
	}
}

1868 
	$ehci_¡©e_ãtch™d
(
EHCIS‹
 *
ehci
, 
async
)

1870 
ušt32_t
 
’Œy
;

1871 
EHCI™d
 
™d
;

1873 
	`as£¹
(!
async
);

1874 
’Œy
 = 
	`ehci_g‘_ãtch_addr
(
ehci
, 
async
);

1876 
	`g‘_dwÜds
(
ehci
, 
	`NLPTR_GET
(
’Œy
), (
ušt32_t
 *è&
™d
,

1877 (
EHCI™d
) >> 2);

1878 
	`ehci_Œaû_™d
(
ehci
, 
’Œy
, &
™d
);

1880 ià(
	`ehci_´oûss_™d
(
ehci
, &
™d
, 
’Œy
) != 0) {

1884 
	`put_dwÜds
(
ehci
, 
	`NLPTR_GET
(
’Œy
), (
ušt32_t
 *è&
™d
,

1885 (
EHCI™d
) >> 2);

1886 
	`ehci_£t_ãtch_addr
(
ehci
, 
async
, 
™d
.
Ãxt
);

1887 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHENTRY
);

1890 
	}
}

1892 
	$ehci_¡©e_ãtchs™d
(
EHCIS‹
 *
ehci
, 
async
)

1894 
ušt32_t
 
’Œy
;

1895 
EHCIs™d
 
s™d
;

1897 
	`as£¹
(!
async
);

1898 
’Œy
 = 
	`ehci_g‘_ãtch_addr
(
ehci
, 
async
);

1900 
	`g‘_dwÜds
(
ehci
, 
	`NLPTR_GET
(
’Œy
), (
ušt32_t
 *)&
s™d
,

1901 (
EHCIs™d
) >> 2);

1902 
	`ehci_Œaû_s™d
(
ehci
, 
’Œy
, &
s™d
);

1904 ià(!(
s™d
.
»suÉs
 & 
SITD_RESULTS_ACTIVE
)) {

1908 
	`årštf
(
¡d”r
, "WARNING: Skipping‡ctive siTD\n");

1911 
	`ehci_£t_ãtch_addr
(
ehci
, 
async
, 
s™d
.
Ãxt
);

1912 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHENTRY
);

1914 
	}
}

1917 
	$ehci_¡©e_advqueue
(
EHCIQueue
 *
q
)

1924 ià(
I
-
b™
 
£t
) {

1925 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_HORIZONTALQH
);

1926 
out
;

1933 ià(((
q
->
qh
.
tok’
 & 
QTD_TOKEN_TBYTES_MASK
) != 0) &&

1934 (
	`NLPTR_TBIT
(
q
->
qh
.
®Šext_qtd
) == 0)) {

1935 
q
->
qtdaddr
 = q->
qh
.
®Šext_qtd
;

1936 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_FETCHQTD
);

1941 } ià(
	`NLPTR_TBIT
(
q
->
qh
.
Ãxt_qtd
) == 0) {

1942 
q
->
qtdaddr
 = q->
qh
.
Ãxt_qtd
;

1943 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_FETCHQTD
);

1949 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_HORIZONTALQH
);

1953 
	}
}

1956 
	$ehci_¡©e_ãtchqtd
(
EHCIQueue
 *
q
)

1958 
EHCIqtd
 
qtd
;

1959 
EHCIPack‘
 *
p
;

1960 
agaš
 = 0;

1962 
	`g‘_dwÜds
(
q
->
ehci
, 
	`NLPTR_GET
(q->
qtdaddr
), (
ušt32_t
 *è&
qtd
,

1963 (
EHCIqtd
) >> 2);

1964 
	`ehci_Œaû_qtd
(
q
, 
	`NLPTR_GET
(q->
qtdaddr
), &
qtd
);

1966 
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

1967 ià(
p
 !ğ
NULL
) {

1968 ià(
p
->
qtdaddr
 !ğ
q
->qtdaddr ||

1969 (!
	`NLPTR_TBIT
(
p
->
qtd
.
Ãxt
) && (p->qtd.next != qtd.next)) ||

1970 (!
	`NLPTR_TBIT
(
p
->
qtd
.
®Šext
) && (p->qtd.altnext != qtd.altnext)) ||

1971 
p
->
qtd
.
buåŒ
[0] != qtd.bufptr[0]) {

1973 
	`ehci_ÿnûl_queue
(
q
);

1974 
p
 = 
NULL
;

1976 
p
->
qtd
 = qtd;

1977 
	`ehci_qh_do_ov”Ïy
(
q
);

1981 ià(!(
qtd
.
tok’
 & 
QTD_TOKEN_ACTIVE
)) {

1982 ià(
p
 !ğ
NULL
) {

1984 
	`ehci_ÿnûl_queue
(
q
);

1985 
p
 = 
NULL
;

1987 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_HORIZONTALQH
);

1988 
agaš
 = 1;

1989 } ià(
p
 !ğ
NULL
) {

1990 
p
->
async
) {

1991 
EHCI_ASYNC_NONE
:

1993 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_EXECUTE
);

1995 
EHCI_ASYNC_INFLIGHT
:

1997 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_HORIZONTALQH
);

1999 
EHCI_ASYNC_FINISHED
:

2001 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_EXECUTING
);

2004 
agaš
 = 1;

2006 
p
 = 
	`ehci_®loc_·ck‘
(
q
);

2007 
p
->
qtdaddr
 = 
q
->qtdaddr;

2008 
p
->
qtd
 = qtd;

2009 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_EXECUTE
);

2010 
agaš
 = 1;

2013  
agaš
;

2014 
	}
}

2016 
	$ehci_¡©e_hÜizqh
(
EHCIQueue
 *
q
)

2018 
agaš
 = 0;

2020 ià(
	`ehci_g‘_ãtch_addr
(
q
->
ehci
, q->
async
è!ğq->
qh
.
Ãxt
) {

2021 
	`ehci_£t_ãtch_addr
(
q
->
ehci
, q->
async
, q->
qh
.
Ãxt
);

2022 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_FETCHENTRY
);

2023 
agaš
 = 1;

2025 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_ACTIVE
);

2028  
agaš
;

2029 
	}
}

2031 
	$ehci_fl_queue
(
EHCIPack‘
 *
p
)

2033 
EHCIQueue
 *
q
 = 
p
->
queue
;

2034 
EHCIqtd
 
qtd
 = 
p
->qtd;

2035 
ušt32_t
 
qtdaddr
;

2038 ià(
	`NLPTR_TBIT
(
qtd
.
®Šext
) == 0) {

2041 ià(
	`NLPTR_TBIT
(
qtd
.
Ãxt
) != 0) {

2044 
qtdaddr
 = 
qtd
.
Ãxt
;

2045 
	`g‘_dwÜds
(
q
->
ehci
, 
	`NLPTR_GET
(
qtdaddr
),

2046 (
ušt32_t
 *è&
qtd
, (
EHCIqtd
) >> 2);

2047 
	`ehci_Œaû_qtd
(
q
, 
	`NLPTR_GET
(
qtdaddr
), &
qtd
);

2048 ià(!(
qtd
.
tok’
 & 
QTD_TOKEN_ACTIVE
)) {

2051 
p
 = 
	`ehci_®loc_·ck‘
(
q
);

2052 
p
->
qtdaddr
 = qtdaddr;

2053 
p
->
qtd
 = qtd;

2054 
p
->
usb_¡©us
 = 
	`ehci_execu‹
(p, "queue");

2055 
	`as£¹
(
p
->
usb_¡©us
 =ğ
USB_RET_ASYNC
);

2056 
p
->
async
 = 
EHCI_ASYNC_INFLIGHT
;

2058 
	}
}

2060 
	$ehci_¡©e_execu‹
(
EHCIQueue
 *
q
)

2062 
EHCIPack‘
 *
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

2063 
agaš
 = 0;

2065 
	`as£¹
(
p
 !ğ
NULL
);

2066 
	`as£¹
(
p
->
qtdaddr
 =ğ
q
->qtdaddr);

2068 ià(
	`ehci_qh_do_ov”Ïy
(
q
) != 0) {

2076 ià(!
q
->
async
) {

2077 
Œª§ùCŒ
 = 
	`g‘_f›ld
(
q
->
qh
.
•ÿp
, 
QH_EPCAP_MULT
);

2078 ià(!
Œª§ùCŒ
) {

2079 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_HORIZONTALQH
);

2080 
agaš
 = 1;

2081 
out
;

2085 ià(
q
->
async
) {

2086 
	`ehci_£t_usb¡s
(
q
->
ehci
, 
USBSTS_REC
);

2089 
p
->
usb_¡©us
 = 
	`ehci_execu‹
(p, "process");

2090 ià(
p
->
usb_¡©us
 =ğ
USB_RET_PROCERR
) {

2091 
agaš
 = -1;

2092 
out
;

2094 ià(
p
->
usb_¡©us
 =ğ
USB_RET_ASYNC
) {

2095 
	`ehci_æush_qh
(
q
);

2096 
	`Œaû_usb_ehci_·ck‘_aùiÚ
(
p
->
queue
,…, "async");

2097 
p
->
async
 = 
EHCI_ASYNC_INFLIGHT
;

2098 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_HORIZONTALQH
);

2099 
agaš
 = 1;

2100 
	`ehci_fl_queue
(
p
);

2101 
out
;

2104 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_EXECUTING
);

2105 
agaš
 = 1;

2107 
out
:

2108  
agaš
;

2109 
	}
}

2111 
	$ehci_¡©e_executšg
(
EHCIQueue
 *
q
)

2113 
EHCIPack‘
 *
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

2115 
	`as£¹
(
p
 !ğ
NULL
);

2116 
	`as£¹
(
p
->
qtdaddr
 =ğ
q
->qtdaddr);

2118 
	`ehci_execu‹_com¶‘e
(
q
);

2121 ià(!
q
->
async
) {

2122 
Œª§ùCŒ
 = 
	`g‘_f›ld
(
q
->
qh
.
•ÿp
, 
QH_EPCAP_MULT
);

2123 
Œª§ùCŒ
--;

2124 
	`£t_f›ld
(&
q
->
qh
.
•ÿp
, 
Œª§ùCŒ
, 
QH_EPCAP_MULT
);

2130 ià(
p
->
usb_¡©us
 =ğ
USB_RET_NAK
) {

2131 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_HORIZONTALQH
);

2133 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_WRITEBACK
);

2136 
	`ehci_æush_qh
(
q
);

2138 
	}
}

2141 
	$ehci_¡©e_wr™eback
(
EHCIQueue
 *
q
)

2143 
EHCIPack‘
 *
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
);

2144 
ušt32_t
 *
qtd
, 
addr
;

2145 
agaš
 = 0;

2148 
	`as£¹
(
p
 !ğ
NULL
);

2149 
	`as£¹
(
p
->
qtdaddr
 =ğ
q
->qtdaddr);

2151 
	`ehci_Œaû_qtd
(
q
, 
	`NLPTR_GET
(
p
->
qtdaddr
), (
EHCIqtd
 *è&q->
qh
.
Ãxt_qtd
);

2152 
qtd
 = (
ušt32_t
 *è&
q
->
qh
.
Ãxt_qtd
;

2153 
addr
 = 
	`NLPTR_GET
(
p
->
qtdaddr
);

2154 
	`put_dwÜds
(
q
->
ehci
, 
addr
 + 2 * (
ušt32_t
), 
qtd
 + 2, 2);

2155 
	`ehci_ä“_·ck‘
(
p
);

2165 ià(
q
->
qh
.
tok’
 & 
QTD_TOKEN_HALT
) {

2176 (
p
 = 
	`QTAILQ_FIRST
(&
q
->
·ck‘s
)è!ğ
NULL
) {

2177 
	`ehci_ä“_·ck‘
(
p
);

2179 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_HORIZONTALQH
);

2180 
agaš
 = 1;

2182 
	`ehci_£t_¡©e
(
q
->
ehci
, q->
async
, 
EST_ADVANCEQUEUE
);

2183 
agaš
 = 1;

2185  
agaš
;

2186 
	}
}

2192 
	$ehci_advªû_¡©e
(
EHCIS‹
 *
ehci
, 
async
)

2194 
EHCIQueue
 *
q
 = 
NULL
;

2195 
agaš
;

2198 
	`ehci_g‘_¡©e
(
ehci
, 
async
)) {

2199 
EST_WAITLISTHEAD
:

2200 
agaš
 = 
	`ehci_¡©e_wa™li¡h—d
(
ehci
, 
async
);

2203 
EST_FETCHENTRY
:

2204 
agaš
 = 
	`ehci_¡©e_ãtch’Œy
(
ehci
, 
async
);

2207 
EST_FETCHQH
:

2208 
q
 = 
	`ehci_¡©e_ãtchqh
(
ehci
, 
async
);

2209 ià(
q
 !ğ
NULL
) {

2210 
	`as£¹
(
q
->
async
 ==‡sync);

2211 
agaš
 = 1;

2213 
agaš
 = 0;

2217 
EST_FETCHITD
:

2218 
agaš
 = 
	`ehci_¡©e_ãtch™d
(
ehci
, 
async
);

2221 
EST_FETCHSITD
:

2222 
agaš
 = 
	`ehci_¡©e_ãtchs™d
(
ehci
, 
async
);

2225 
EST_ADVANCEQUEUE
:

2226 
agaš
 = 
	`ehci_¡©e_advqueue
(
q
);

2229 
EST_FETCHQTD
:

2230 
agaš
 = 
	`ehci_¡©e_ãtchqtd
(
q
);

2233 
EST_HORIZONTALQH
:

2234 
agaš
 = 
	`ehci_¡©e_hÜizqh
(
q
);

2237 
EST_EXECUTE
:

2238 
agaš
 = 
	`ehci_¡©e_execu‹
(
q
);

2239 ià(
async
) {

2240 
ehci
->
async_¡•down
 = 0;

2244 
EST_EXECUTING
:

2245 
	`as£¹
(
q
 !ğ
NULL
);

2246 ià(
async
) {

2247 
ehci
->
async_¡•down
 = 0;

2249 
agaš
 = 
	`ehci_¡©e_executšg
(
q
);

2252 
EST_WRITEBACK
:

2253 
	`as£¹
(
q
 !ğ
NULL
);

2254 
agaš
 = 
	`ehci_¡©e_wr™eback
(
q
);

2258 
	`årštf
(
¡d”r
, "Bad state!\n");

2259 
agaš
 = -1;

2260 
	`as£¹
(0);

2264 ià(
agaš
 < 0) {

2265 
	`årštf
(
¡d”r
, "processingƒrror -„esettingƒhci HC\n");

2266 
	`ehci_»£t
(
ehci
);

2267 
agaš
 = 0;

2270 
agaš
);

2271 
	}
}

2273 
	$ehci_advªû_async_¡©e
(
EHCIS‹
 *
ehci
)

2275 cÚ¡ 
async
 = 1;

2277 
	`ehci_g‘_¡©e
(
ehci
, 
async
)) {

2278 
EST_INACTIVE
:

2279 ià(!
	`ehci_async_’abËd
(
ehci
)) {

2282 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_ACTIVE
);

2285 
EST_ACTIVE
:

2286 ià(!
	`ehci_async_’abËd
(
ehci
)) {

2287 
	`ehci_queues_r_®l
(
ehci
, 
async
);

2288 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_INACTIVE
);

2294 ià(
ehci
->
usb¡s
 & 
USBSTS_IAA
) {

2295 
	`DPRINTF
("IAA status bit still set.\n");

2300 ià(
ehci
->
asynşi¡addr
 == 0) {

2304 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_WAITLISTHEAD
);

2305 
	`ehci_advªû_¡©e
(
ehci
, 
async
);

2311 ià(
ehci
->
usbcmd
 & 
USBCMD_IAAD
) {

2313 
	`ehci_queues_g_unu£d_async
(
ehci
);

2314 
	`DPRINTF
("ASYNC: doorbell„equest‡cknowledged\n");

2315 
ehci
->
usbcmd
 &ğ~
USBCMD_IAAD
;

2316 
	`ehci_¿i£_œq
(
ehci
, 
USBSTS_IAA
);

2322 
	`årštf
(
¡d”r
, "ehci: Bad‡synchronous state %d. "

2323 "Re£‰šgØaùive\n", 
ehci
->
a¡©e
);

2324 
	`as£¹
(0);

2326 
	}
}

2328 
	$ehci_advªû_³riodic_¡©e
(
EHCIS‹
 *
ehci
)

2330 
ušt32_t
 
’Œy
;

2331 
ušt32_t
 
li¡
;

2332 cÚ¡ 
async
 = 0;

2336 
	`ehci_g‘_¡©e
(
ehci
, 
async
)) {

2337 
EST_INACTIVE
:

2338 ià(!(
ehci
->
äšdex
 & 7è&& 
	`ehci_³riodic_’abËd
(ehci)) {

2339 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_ACTIVE
);

2344 
EST_ACTIVE
:

2345 ià(!(
ehci
->
äšdex
 & 7è&& !
	`ehci_³riodic_’abËd
(ehci)) {

2346 
	`ehci_queues_r_®l
(
ehci
, 
async
);

2347 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_INACTIVE
);

2351 
li¡
 = 
ehci
->
³riodişi¡ba£
 & 0xfffff000;

2353 ià(
li¡
 == 0) {

2356 
li¡
 |ğ((
ehci
->
äšdex
 & 0x1ff8) >> 1);

2358 
	`pci_dma_»ad
(&
ehci
->
dev
, 
li¡
, &
’Œy
, ƒntry);

2359 
’Œy
 = 
	`Ë32_to_ıu
(entry);

2361 
	`DPRINTF
("PERIODIC state‡dv fr=%d. [%08X] -> %08X\n",

2362 
ehci
->
äšdex
 / 8, 
li¡
, 
’Œy
);

2363 
	`ehci_£t_ãtch_addr
(
ehci
, 
async
,
’Œy
);

2364 
	`ehci_£t_¡©e
(
ehci
, 
async
, 
EST_FETCHENTRY
);

2365 
	`ehci_advªû_¡©e
(
ehci
, 
async
);

2366 
	`ehci_queues_r_unu£d
(
ehci
, 
async
);

2371 
	`årštf
(
¡d”r
, "ehci: Bad…eriodic state %d. "

2372 "Re£‰šgØaùive\n", 
ehci
->
p¡©e
);

2373 
	`as£¹
(0);

2375 
	}
}

2377 
	$ehci_upd©e_äšdex
(
EHCIS‹
 *
ehci
, 
äames
)

2379 
i
;

2381 ià(!
	`ehci_’abËd
(
ehci
)) {

2385 
i
 = 0; i < 
äames
; i++) {

2386 
ehci
->
äšdex
 += 8;

2388 ià(
ehci
->
äšdex
 == 0x00002000) {

2389 
	`ehci_¿i£_œq
(
ehci
, 
USBSTS_FLR
);

2392 ià(
ehci
->
äšdex
 == 0x00004000) {

2393 
	`ehci_¿i£_œq
(
ehci
, 
USBSTS_FLR
);

2394 
ehci
->
äšdex
 = 0;

2395 ià(
ehci
->
usb¡s_äšdex
 > 0x00004000) {

2396 
ehci
->
usb¡s_äšdex
 -= 0x00004000;

2398 
ehci
->
usb¡s_äšdex
 = 0;

2402 
	}
}

2404 
	$ehci_äame_tim”
(*
İaque
)

2406 
EHCIS‹
 *
ehci
 = 
İaque
;

2407 
Ãed_tim”
 = 0;

2408 
št64_t
 
expœe_time
, 
t_now
;

2409 
ušt64_t
 
ns_–­£d
;

2410 
äames
, 
sk³d_äames
;

2411 
i
;

2413 
t_now
 = 
	`qemu_g‘_şock_ns
(
vm_şock
);

2414 
ns_–­£d
 = 
t_now
 - 
ehci
->
Ï¡_run_ns
;

2415 
äames
 = 
ns_–­£d
 / 
FRAME_TIMER_NS
;

2417 ià(
	`ehci_³riodic_’abËd
(
ehci
è||ƒhci->
p¡©e
 !ğ
EST_INACTIVE
) {

2418 
Ãed_tim”
++;

2419 
ehci
->
async_¡•down
 = 0;

2421 ià(
äames
 > 
ehci
->
maxäames
) {

2422 
sk³d_äames
 = 
äames
 - 
ehci
->
maxäames
;

2423 
	`ehci_upd©e_äšdex
(
ehci
, 
sk³d_äames
);

2424 
ehci
->
Ï¡_run_ns
 +ğ
FRAME_TIMER_NS
 * 
sk³d_äames
;

2425 
äames
 -ğ
sk³d_äames
;

2426 
	`DPRINTF
("WARNING - EHCI sk³d %d f¿mes\n", 
sk³d_äames
);

2429 
i
 = 0; i < 
äames
; i++) {

2430 
	`ehci_upd©e_äšdex
(
ehci
, 1);

2431 
	`ehci_advªû_³riodic_¡©e
(
ehci
);

2432 
ehci
->
Ï¡_run_ns
 +ğ
FRAME_TIMER_NS
;

2435 ià(
ehci
->
async_¡•down
 <ƒhci->
maxäames
 / 2) {

2436 
ehci
->
async_¡•down
++;

2438 
	`ehci_upd©e_äšdex
(
ehci
, 
äames
);

2439 
ehci
->
Ï¡_run_ns
 +ğ
FRAME_TIMER_NS
 * 
äames
;

2445 ià(
	`ehci_async_’abËd
(
ehci
è||ƒhci->
a¡©e
 !ğ
EST_INACTIVE
) {

2446 
Ãed_tim”
++;

2447 
	`ehci_advªû_async_¡©e
(
ehci
);

2450 
	`ehci_comm™_œq
(
ehci
);

2451 ià(
ehci
->
usb¡s_³ndšg
) {

2452 
Ãed_tim”
++;

2453 
ehci
->
async_¡•down
 = 0;

2456 ià(
Ãed_tim”
) {

2457 
expœe_time
 = 
t_now
 + (
	`g‘_ticks_³r_£c
()

2458 * (
ehci
->
async_¡•down
+1è/ 
FRAME_TIMER_FREQ
);

2459 
	`qemu_mod_tim”
(
ehci
->
äame_tim”
, 
expœe_time
);

2461 
	}
}

2463 
	$ehci_async_bh
(*
İaque
)

2465 
EHCIS‹
 *
ehci
 = 
İaque
;

2466 
	`ehci_advªû_async_¡©e
(
ehci
);

2467 
	}
}

2469 cÚ¡ 
MemÜyRegiÚOps
 
	gehci_mem_İs
 = {

2470 .
Şd_mmio
 = {

2471 .
»ad
 = { 
ehci_mem_»adb
, 
ehci_mem_»adw
, 
ehci_mem_»adl
 },

2472 .
	gwr™e
 = { 
ehci_mem_wr™eb
, 
ehci_mem_wr™ew
, 
ehci_mem_wr™–
 },

2474 .
	g’dŸÂess
 = 
DEVICE_LITTLE_ENDIAN
,

2477 
usb_ehci_š™â
(
PCIDeviû
 *
dev
);

2479 
USBPÜtOps
 
	gehci_pÜt_İs
 = {

2480 .
©ch
 = 
ehci_©ch
,

2481 .
	gd‘ach
 = 
ehci_d‘ach
,

2482 .
	gchd_d‘ach
 = 
ehci_chd_d‘ach
,

2483 .
	gwakeup
 = 
ehci_wakeup
,

2484 .
	gcom¶‘e
 = 
ehci_async_com¶‘e_·ck‘
,

2487 
USBBusOps
 
	gehci_bus_İs
 = {

2488 .
»gi¡”_com·niÚ
 = 
ehci_»gi¡”_com·niÚ
,

2491 
	$usb_ehci_po¡_lßd
(*
İaque
, 
v”siÚ_id
)

2493 
EHCIS‹
 *
s
 = 
İaque
;

2494 
i
;

2496 
i
 = 0; i < 
NB_PORTS
; i++) {

2497 
USBPÜt
 *
com·niÚ
 = 
s
->
com·niÚ_pÜts
[
i
];

2498 ià(
com·niÚ
 =ğ
NULL
) {

2501 ià(
s
->
pÜtsc
[
i
] & 
PORTSC_POWNER
) {

2502 
com·niÚ
->
dev
 = 
s
->
pÜts
[
i
].dev;

2504 
com·niÚ
->
dev
 = 
NULL
;

2509 
	}
}

2511 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_ehci
 = {

2512 .
Çme
 = "ehci",

2513 .
	gv”siÚ_id
 = 2,

2514 .
	gmšimum_v”siÚ_id
 = 1,

2515 .
	gpo¡_lßd
 = 
usb_ehci_po¡_lßd
,

2516 .
	gf›lds
 = (
VMS‹F›ld
[]) {

2517 
VMSTATE_PCI_DEVICE
(
dev
, 
EHCIS‹
),

2519 
VMSTATE_UINT32
(
usbcmd
, 
EHCIS‹
),

2520 
VMSTATE_UINT32
(
usb¡s
, 
EHCIS‹
),

2521 
VMSTATE_UINT32_V
(
usb¡s_³ndšg
, 
EHCIS‹
, 2),

2522 
VMSTATE_UINT32_V
(
usb¡s_äšdex
, 
EHCIS‹
, 2),

2523 
VMSTATE_UINT32
(
usbšŒ
, 
EHCIS‹
),

2524 
VMSTATE_UINT32
(
äšdex
, 
EHCIS‹
),

2525 
VMSTATE_UINT32
(
ù¾ds£gm’t
, 
EHCIS‹
),

2526 
VMSTATE_UINT32
(
³riodişi¡ba£
, 
EHCIS‹
),

2527 
VMSTATE_UINT32
(
asynşi¡addr
, 
EHCIS‹
),

2528 
VMSTATE_UINT32
(
cÚfigæag
, 
EHCIS‹
),

2529 
VMSTATE_UINT32
(
pÜtsc
[0], 
EHCIS‹
),

2530 
VMSTATE_UINT32
(
pÜtsc
[1], 
EHCIS‹
),

2531 
VMSTATE_UINT32
(
pÜtsc
[2], 
EHCIS‹
),

2532 
VMSTATE_UINT32
(
pÜtsc
[3], 
EHCIS‹
),

2533 
VMSTATE_UINT32
(
pÜtsc
[4], 
EHCIS‹
),

2534 
VMSTATE_UINT32
(
pÜtsc
[5], 
EHCIS‹
),

2536 
VMSTATE_TIMER
(
äame_tim”
, 
EHCIS‹
),

2537 
VMSTATE_UINT64
(
Ï¡_run_ns
, 
EHCIS‹
),

2538 
VMSTATE_UINT32
(
async_¡•down
, 
EHCIS‹
),

2540 
VMSTATE_UINT32
(
a¡©e
, 
EHCIS‹
),

2541 
VMSTATE_UINT32
(
p¡©e
, 
EHCIS‹
),

2542 
VMSTATE_UINT32
(
a_ãtch_addr
, 
EHCIS‹
),

2543 
VMSTATE_UINT32
(
p_ãtch_addr
, 
EHCIS‹
),

2544 
VMSTATE_END_OF_LIST
()

2548 
Prİ”ty
 
	gehci_´İ”t›s
[] = {

2549 
DEFINE_PROP_UINT32
("maxäames", 
EHCIS‹
, 
maxäames
, 128),

2550 
DEFINE_PROP_END_OF_LIST
(),

2553 
	$ehci_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

2555 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

2556 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

2558 
k
->
š™
 = 
usb_ehci_š™â
;

2559 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_INTEL
;

2560 
k
->
deviû_id
 = 
PCI_DEVICE_ID_INTEL_82801D
;

2561 
k
->
»visiÚ
 = 0x10;

2562 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

2563 
dc
->
vmsd
 = &
vm¡©e_ehci
;

2564 
dc
->
´İs
 = 
ehci_´İ”t›s
;

2565 
	}
}

2567 
Ty³Info
 
	gehci_šfo
 = {

2568 .
Çme
 = "usb-ehci",

2569 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

2570 .
	gš¡ªû_size
 = (
EHCIS‹
),

2571 .
	gşass_š™
 = 
ehci_şass_š™
,

2574 
	$ich9_ehci_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

2576 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

2577 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

2579 
k
->
š™
 = 
usb_ehci_š™â
;

2580 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_INTEL
;

2581 
k
->
deviû_id
 = 
PCI_DEVICE_ID_INTEL_82801I_EHCI1
;

2582 
k
->
»visiÚ
 = 0x03;

2583 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

2584 
dc
->
vmsd
 = &
vm¡©e_ehci
;

2585 
dc
->
´İs
 = 
ehci_´İ”t›s
;

2586 
	}
}

2588 
Ty³Info
 
	gich9_ehci_šfo
 = {

2589 .
Çme
 = "ich9-usb-ehci1",

2590 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

2591 .
	gš¡ªû_size
 = (
EHCIS‹
),

2592 .
	gşass_š™
 = 
ich9_ehci_şass_š™
,

2595 
	$usb_ehci_š™â
(
PCIDeviû
 *
dev
)

2597 
EHCIS‹
 *
s
 = 
	`DO_UPCAST
(EHCIS‹, 
dev
, dev);

2598 
ušt8_t
 *
pci_cÚf
 = 
s
->
dev
.
cÚfig
;

2599 
i
;

2601 
	`pci_£t_by‹
(&
pci_cÚf
[
PCI_CLASS_PROG
], 0x20);

2604 
	`pci_£t_by‹
(&
pci_cÚf
[
PCI_CAPABILITY_LIST
], 0x00);

2607 
	`pci_£t_by‹
(&
pci_cÚf
[
PCI_INTERRUPT_PIN
], 4);

2608 
	`pci_£t_by‹
(&
pci_cÚf
[
PCI_MIN_GNT
], 0);

2609 
	`pci_£t_by‹
(&
pci_cÚf
[
PCI_MAX_LAT
], 0);

2613 
	`pci_£t_by‹
(&
pci_cÚf
[
USB_SBRN
], 
USB_RELEASE_2
);

2614 
	`pci_£t_by‹
(&
pci_cÚf
[0x61], 0x20);

2615 
	`pci_£t_wÜd
(&
pci_cÚf
[0x62], 0x00);

2617 
pci_cÚf
[0x64] = 0x00;

2618 
pci_cÚf
[0x65] = 0x00;

2619 
pci_cÚf
[0x66] = 0x00;

2620 
pci_cÚf
[0x67] = 0x00;

2621 
pci_cÚf
[0x68] = 0x01;

2622 
pci_cÚf
[0x69] = 0x00;

2623 
pci_cÚf
[0x6a] = 0x00;

2624 
pci_cÚf
[0x6b] = 0x00;

2625 
pci_cÚf
[0x6c] = 0x00;

2626 
pci_cÚf
[0x6d] = 0x00;

2627 
pci_cÚf
[0x6e] = 0x00;

2628 
pci_cÚf
[0x6f] = 0xc0;

2631 
s
->
mmio
[0x00] = (
ušt8_t
è
OPREGBASE
;

2632 
s
->
mmio
[0x01] = 0x00;

2633 
s
->
mmio
[0x02] = 0x00;

2634 
s
->
mmio
[0x03] = 0x01;

2635 
s
->
mmio
[0x04] = 
NB_PORTS
;

2636 
s
->
mmio
[0x05] = 0x00;

2637 
s
->
mmio
[0x06] = 0x00;

2638 
s
->
mmio
[0x07] = 0x00;

2639 
s
->
mmio
[0x08] = 0x80;

2640 
s
->
mmio
[0x09] = 0x68;

2641 
s
->
mmio
[0x0a] = 0x00;

2642 
s
->
mmio
[0x0b] = 0x00;

2644 
s
->
œq
 = s->
dev
.irq[3];

2646 
	`usb_bus_Ãw
(&
s
->
bus
, &
ehci_bus_İs
, &s->
dev
.
qdev
);

2647 
i
 = 0; i < 
NB_PORTS
; i++) {

2648 
	`usb_»gi¡”_pÜt
(&
s
->
bus
, &s->
pÜts
[
i
], s, i, &
ehci_pÜt_İs
,

2649 
USB_SPEED_MASK_HIGH
);

2650 
s
->
pÜts
[
i
].
dev
 = 0;

2653 
s
->
äame_tim”
 = 
	`qemu_Ãw_tim”_ns
(
vm_şock
, 
ehci_äame_tim”
, s);

2654 
s
->
async_bh
 = 
	`qemu_bh_Ãw
(
ehci_async_bh
, s);

2655 
	`QTAILQ_INIT
(&
s
->
aqueues
);

2656 
	`QTAILQ_INIT
(&
s
->
pqueues
);

2657 
	`usb_·ck‘_š™
(&
s
->
ack‘
);

2659 
	`qemu_»gi¡”_»£t
(
ehci_»£t
, 
s
);

2661 
	`memÜy_»giÚ_š™_io
(&
s
->
mem
, &
ehci_mem_İs
, s, "ehci", 
MMIO_SIZE
);

2662 
	`pci_»gi¡”_b¬
(&
s
->
dev
, 0, 
PCI_BASE_ADDRESS_SPACE_MEMORY
, &s->
mem
);

2665 
	}
}

2667 
	$ehci_»gi¡”_ty³s
()

2669 
	`ty³_»gi¡”_¡©ic
(&
ehci_šfo
);

2670 
	`ty³_»gi¡”_¡©ic
(&
ich9_ehci_šfo
);

2671 
	}
}

2673 
ty³_š™
(
ehci_»gi¡”_ty³s
)

	@hcd-musb.c

23 
	~"qemu-commÚ.h
"

24 
	~"qemu-tim”.h
"

25 
	~"hw/usb.h
"

26 
	~"hw/œq.h
"

27 
	~"hw/hw.h
"

30 
	#MUSB_HDRC_FADDR
 0x00

	)

31 
	#MUSB_HDRC_POWER
 0x01

	)

33 
	#MUSB_HDRC_INTRTX
 0x02

	)

34 
	#MUSB_HDRC_INTRRX
 0x04

	)

35 
	#MUSB_HDRC_INTRTXE
 0x06

	)

36 
	#MUSB_HDRC_INTRRXE
 0x08

	)

37 
	#MUSB_HDRC_INTRUSB
 0x0¨

	)

38 
	#MUSB_HDRC_INTRUSBE
 0x0b

	)

39 
	#MUSB_HDRC_FRAME
 0x0ø

	)

40 
	#MUSB_HDRC_INDEX
 0x0

	)

41 
	#MUSB_HDRC_TESTMODE
 0x0à

	)

44 
	#MUSB_HDRC_EP_IDX
 0x10

	)

47 
	#MUSB_HDRC_FIFO
 0x20

	)

50 
	#MUSB_HDRC_DEVCTL
 0x60

	)

53 
	#MUSB_HDRC_TXFIFOSZ
 0x62

	)

54 
	#MUSB_HDRC_RXFIFOSZ
 0x63

	)

55 
	#MUSB_HDRC_TXFIFOADDR
 0x64

	)

56 
	#MUSB_HDRC_RXFIFOADDR
 0x66

	)

59 
	#MUSB_HDRC_VCTRL
 0x68

	)

60 
	#MUSB_HDRC_HWVERS
 0x6ø

	)

64 
	#MUSB_HDRC_ULPI_VBUSCTL
 0x70

	)

65 
	#MUSB_HDRC_ULPI_REGDATA
 0x74

	)

66 
	#MUSB_HDRC_ULPI_REGADDR
 0x75

	)

67 
	#MUSB_HDRC_ULPI_REGCTL
 0x76

	)

70 
	#MUSB_HDRC_ENDCOUNT
 0x78

	)

71 
	#MUSB_HDRC_DMARAMCFG
 0x79

	)

72 
	#MUSB_HDRC_PHYWAIT
 0x7¨

	)

73 
	#MUSB_HDRC_PHYVPLEN
 0x7b

	)

74 
	#MUSB_HDRC_HS_EOF1
 0x7ø

	)

75 
	#MUSB_HDRC_FS_EOF1
 0x7d

	)

76 
	#MUSB_HDRC_LS_EOF1
 0x7

	)

79 
	#MUSB_HDRC_BUSCTL
 0x80

	)

82 
	#MUSB_HDRC_EP
 0x100

	)

85 
	#MUSB_HDRC_TXMAXP
 0x00

	)

86 
	#MUSB_HDRC_TXCSR
 0x02

	)

87 
	#MUSB_HDRC_CSR0
 
MUSB_HDRC_TXCSR


	)

88 
	#MUSB_HDRC_RXMAXP
 0x04

	)

89 
	#MUSB_HDRC_RXCSR
 0x06

	)

90 
	#MUSB_HDRC_RXCOUNT
 0x08

	)

91 
	#MUSB_HDRC_COUNT0
 
MUSB_HDRC_RXCOUNT


	)

92 
	#MUSB_HDRC_TXTYPE
 0x0¨

	)

93 
	#MUSB_HDRC_TYPE0
 
MUSB_HDRC_TXTYPE


	)

94 
	#MUSB_HDRC_TXINTERVAL
 0x0b

	)

95 
	#MUSB_HDRC_NAKLIMIT0
 
MUSB_HDRC_TXINTERVAL


	)

96 
	#MUSB_HDRC_RXTYPE
 0x0ø

	)

97 
	#MUSB_HDRC_RXINTERVAL
 0x0d

	)

98 
	#MUSB_HDRC_FIFOSIZE
 0x0à

	)

99 
	#MUSB_HDRC_CONFIGDATA
 
MGC_O_HDRC_FIFOSIZE


	)

102 
	#MUSB_HDRC_TXFUNCADDR
 0x00

	)

103 
	#MUSB_HDRC_TXHUBADDR
 0x02

	)

104 
	#MUSB_HDRC_TXHUBPORT
 0x03

	)

106 
	#MUSB_HDRC_RXFUNCADDR
 0x04

	)

107 
	#MUSB_HDRC_RXHUBADDR
 0x06

	)

108 
	#MUSB_HDRC_RXHUBPORT
 0x07

	)

115 
	#MGC_M_POWER_ISOUPDATE
 0x80

	)

116 
	#MGC_M_POWER_SOFTCONN
 0x40

	)

117 
	#MGC_M_POWER_HSENAB
 0x20

	)

118 
	#MGC_M_POWER_HSMODE
 0x10

	)

119 
	#MGC_M_POWER_RESET
 0x08

	)

120 
	#MGC_M_POWER_RESUME
 0x04

	)

121 
	#MGC_M_POWER_SUSPENDM
 0x02

	)

122 
	#MGC_M_POWER_ENSUSPEND
 0x01

	)

125 
	#MGC_M_INTR_SUSPEND
 0x01

	)

126 
	#MGC_M_INTR_RESUME
 0x02

	)

127 
	#MGC_M_INTR_RESET
 0x04

	)

128 
	#MGC_M_INTR_BABBLE
 0x04

	)

129 
	#MGC_M_INTR_SOF
 0x08

	)

130 
	#MGC_M_INTR_CONNECT
 0x10

	)

131 
	#MGC_M_INTR_DISCONNECT
 0x20

	)

132 
	#MGC_M_INTR_SESSREQ
 0x40

	)

133 
	#MGC_M_INTR_VBUSERROR
 0x80

	)

134 
	#MGC_M_INTR_EP0
 0x01

	)

137 
	#MGC_M_DEVCTL_BDEVICE
 0x80

	)

138 
	#MGC_M_DEVCTL_FSDEV
 0x40

	)

139 
	#MGC_M_DEVCTL_LSDEV
 0x20

	)

140 
	#MGC_M_DEVCTL_VBUS
 0x18

	)

141 
	#MGC_S_DEVCTL_VBUS
 3

	)

142 
	#MGC_M_DEVCTL_HM
 0x04

	)

143 
	#MGC_M_DEVCTL_HR
 0x02

	)

144 
	#MGC_M_DEVCTL_SESSION
 0x01

	)

147 
	#MGC_M_TEST_FORCE_HOST
 0x80

	)

148 
	#MGC_M_TEST_FIFO_ACCESS
 0x40

	)

149 
	#MGC_M_TEST_FORCE_FS
 0x20

	)

150 
	#MGC_M_TEST_FORCE_HS
 0x10

	)

151 
	#MGC_M_TEST_PACKET
 0x08

	)

152 
	#MGC_M_TEST_K
 0x04

	)

153 
	#MGC_M_TEST_J
 0x02

	)

154 
	#MGC_M_TEST_SE0_NAK
 0x01

	)

157 
	#MGC_M_CSR0_FLUSHFIFO
 0x0100

	)

158 
	#MGC_M_CSR0_TXPKTRDY
 0x0002

	)

159 
	#MGC_M_CSR0_RXPKTRDY
 0x0001

	)

162 
	#MGC_M_CSR0_P_SVDSETUPEND
 0x0080

	)

163 
	#MGC_M_CSR0_P_SVDRXPKTRDY
 0x0040

	)

164 
	#MGC_M_CSR0_P_SENDSTALL
 0x0020

	)

165 
	#MGC_M_CSR0_P_SETUPEND
 0x0010

	)

166 
	#MGC_M_CSR0_P_DATAEND
 0x0008

	)

167 
	#MGC_M_CSR0_P_SENTSTALL
 0x0004

	)

170 
	#MGC_M_CSR0_H_NO_PING
 0x0800

	)

171 
	#MGC_M_CSR0_H_WR_DATATOGGLE
 0x0400

	)

172 
	#MGC_M_CSR0_H_DATATOGGLE
 0x0200

	)

173 
	#MGC_M_CSR0_H_NAKTIMEOUT
 0x0080

	)

174 
	#MGC_M_CSR0_H_STATUSPKT
 0x0040

	)

175 
	#MGC_M_CSR0_H_REQPKT
 0x0020

	)

176 
	#MGC_M_CSR0_H_ERROR
 0x0010

	)

177 
	#MGC_M_CSR0_H_SETUPPKT
 0x0008

	)

178 
	#MGC_M_CSR0_H_RXSTALL
 0x0004

	)

181 
	#MGC_M_CONFIGDATA_MPRXE
 0x80

	)

182 
	#MGC_M_CONFIGDATA_MPTXE
 0x40

	)

183 
	#MGC_M_CONFIGDATA_BIGENDIAN
 0x20

	)

184 
	#MGC_M_CONFIGDATA_HBRXE
 0x10

	)

185 
	#MGC_M_CONFIGDATA_HBTXE
 0x08

	)

186 
	#MGC_M_CONFIGDATA_DYNFIFO
 0x04

	)

187 
	#MGC_M_CONFIGDATA_SOFTCONE
 0x02

	)

188 
	#MGC_M_CONFIGDATA_UTMIDW
 0x01

	)

191 
	#MGC_M_TXCSR_AUTOSET
 0x8000

	)

192 
	#MGC_M_TXCSR_ISO
 0x4000

	)

193 
	#MGC_M_TXCSR_MODE
 0x2000

	)

194 
	#MGC_M_TXCSR_DMAENAB
 0x1000

	)

195 
	#MGC_M_TXCSR_FRCDATATOG
 0x0800

	)

196 
	#MGC_M_TXCSR_DMAMODE
 0x0400

	)

197 
	#MGC_M_TXCSR_CLRDATATOG
 0x0040

	)

198 
	#MGC_M_TXCSR_FLUSHFIFO
 0x0008

	)

199 
	#MGC_M_TXCSR_FIFONOTEMPTY
 0x0002

	)

200 
	#MGC_M_TXCSR_TXPKTRDY
 0x0001

	)

203 
	#MGC_M_TXCSR_P_INCOMPTX
 0x0080

	)

204 
	#MGC_M_TXCSR_P_SENTSTALL
 0x0020

	)

205 
	#MGC_M_TXCSR_P_SENDSTALL
 0x0010

	)

206 
	#MGC_M_TXCSR_P_UNDERRUN
 0x0004

	)

209 
	#MGC_M_TXCSR_H_WR_DATATOGGLE
 0x0200

	)

210 
	#MGC_M_TXCSR_H_DATATOGGLE
 0x0100

	)

211 
	#MGC_M_TXCSR_H_NAKTIMEOUT
 0x0080

	)

212 
	#MGC_M_TXCSR_H_RXSTALL
 0x0020

	)

213 
	#MGC_M_TXCSR_H_ERROR
 0x0004

	)

216 
	#MGC_M_RXCSR_AUTOCLEAR
 0x8000

	)

217 
	#MGC_M_RXCSR_DMAENAB
 0x2000

	)

218 
	#MGC_M_RXCSR_DISNYET
 0x1000

	)

219 
	#MGC_M_RXCSR_DMAMODE
 0x0800

	)

220 
	#MGC_M_RXCSR_INCOMPRX
 0x0100

	)

221 
	#MGC_M_RXCSR_CLRDATATOG
 0x0080

	)

222 
	#MGC_M_RXCSR_FLUSHFIFO
 0x0010

	)

223 
	#MGC_M_RXCSR_DATAERROR
 0x0008

	)

224 
	#MGC_M_RXCSR_FIFOFULL
 0x0002

	)

225 
	#MGC_M_RXCSR_RXPKTRDY
 0x0001

	)

228 
	#MGC_M_RXCSR_P_ISO
 0x4000

	)

229 
	#MGC_M_RXCSR_P_SENTSTALL
 0x0040

	)

230 
	#MGC_M_RXCSR_P_SENDSTALL
 0x0020

	)

231 
	#MGC_M_RXCSR_P_OVERRUN
 0x0004

	)

234 
	#MGC_M_RXCSR_H_AUTOREQ
 0x4000

	)

235 
	#MGC_M_RXCSR_H_WR_DATATOGGLE
 0x0400

	)

236 
	#MGC_M_RXCSR_H_DATATOGGLE
 0x0200

	)

237 
	#MGC_M_RXCSR_H_RXSTALL
 0x0040

	)

238 
	#MGC_M_RXCSR_H_REQPKT
 0x0020

	)

239 
	#MGC_M_RXCSR_H_ERROR
 0x0004

	)

242 
	#MGC_M_HUBADDR_MULTI_TT
 0x80

	)

245 
	#MGC_M_ULPI_VBCTL_USEEXTVBUSIND
 0x02

	)

246 
	#MGC_M_ULPI_VBCTL_USEEXTVBUS
 0x01

	)

247 
	#MGC_M_ULPI_REGCTL_INT_ENABLE
 0x08

	)

248 
	#MGC_M_ULPI_REGCTL_READNOTWRITE
 0x04

	)

249 
	#MGC_M_ULPI_REGCTL_COMPLETE
 0x02

	)

250 
	#MGC_M_ULPI_REGCTL_REG
 0x01

	)

254 #ifdeà
MUSB_DEBUG


255 
	#TRACE
(
fmt
,...è
	`årštf
(
¡d”r
, "%s@%d: " fmˆ"\n", 
__FUNCTION__
, \

256 
__LINE__
, ##
__VA_ARGS__
)

	)

258 
	#TRACE
(...)

	)

262 
musb_©ch
(
USBPÜt
 *
pÜt
);

263 
musb_d‘ach
(
USBPÜt
 *
pÜt
);

264 
musb_chd_d‘ach
(
USBPÜt
 *
pÜt
, 
USBDeviû
 *
chd
);

265 
musb_scheduË_cb
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
p
);

266 
musb_async_ÿnûl_deviû
(
MUSBS‹
 *
s
, 
USBDeviû
 *
dev
);

268 
USBPÜtOps
 
	gmusb_pÜt_İs
 = {

269 .
©ch
 = 
musb_©ch
,

270 .
	gd‘ach
 = 
musb_d‘ach
,

271 .
	gchd_d‘ach
 = 
musb_chd_d‘ach
,

272 .
	gcom¶‘e
 = 
musb_scheduË_cb
,

275 
USBBusOps
 
	gmusb_bus_İs
 = {

278 
MUSBPack‘
 
	tMUSBPack‘
;

279 
MUSBEndPošt
 
	tMUSBEndPošt
;

281 
	sMUSBPack‘
 {

282 
USBPack‘
 
	mp
;

283 
MUSBEndPošt
 *
	m•
;

284 
	mdœ
;

287 
	sMUSBEndPošt
 {

288 
ušt16_t
 
	mçddr
[2];

289 
ušt8_t
 
	mhaddr
[2];

290 
ušt8_t
 
	mhpÜt
[2];

291 
ušt16_t
 
	mc¤
[2];

292 
ušt16_t
 
	mmaxp
[2];

293 
ušt16_t
 
	mrxcouÁ
;

294 
ušt8_t
 
	mty³
[2];

295 
ušt8_t
 
	mš‹rv®
[2];

296 
ušt8_t
 
	mcÚfig
;

297 
ušt8_t
 
	mfifosize
;

298 
	mtimeout
[2];

300 
ušt8_t
 *
	mbuf
[2];

301 
	mfifŞ’
[2];

302 
	mfifo¡¬t
[2];

303 
	mfifßddr
[2];

304 
MUSBPack‘
 
	m·ckey
[2];

305 
	m¡©us
[2];

306 
	mext_size
[2];

309 
	m•num
;

310 
	mš‹¼u±
[2];

311 
MUSBS‹
 *
	mmusb
;

312 
USBC®lback
 *
	md–ayed_cb
[2];

313 
QEMUTim”
 *
	mštv_tim”
[2];

316 
	sMUSBS‹
 {

317 
qemu_œq
 
	mœqs
[
musb_œq_max
];

318 
USBBus
 
	mbus
;

319 
USBPÜt
 
	mpÜt
;

321 
	midx
;

322 
ušt8_t
 
	mdevùl
;

323 
ušt8_t
 
	mpow”
;

324 
ušt8_t
 
	mçddr
;

326 
ušt8_t
 
	mšŒ
;

327 
ušt8_t
 
	mmask
;

328 
ušt16_t
 
	mtx_šŒ
;

329 
ušt16_t
 
	mtx_mask
;

330 
ušt16_t
 
	mrx_šŒ
;

331 
ušt16_t
 
	mrx_mask
;

333 
	m£tup_Ën
;

334 
	m£ssiÚ
;

336 
ušt8_t
 
	mbuf
[0x8000];

340 
MUSBEndPošt
 
	m•
[16];

343 
	$musb_»£t
(
MUSBS‹
 *
s
)

345 
i
;

347 
s
->
çddr
 = 0x00;

348 
s
->
devùl
 = 0;

349 
s
->
pow”
 = 
MGC_M_POWER_HSENAB
;

350 
s
->
tx_šŒ
 = 0x0000;

351 
s
->
rx_šŒ
 = 0x0000;

352 
s
->
tx_mask
 = 0xffff;

353 
s
->
rx_mask
 = 0xffff;

354 
s
->
šŒ
 = 0x00;

355 
s
->
mask
 = 0x06;

356 
s
->
idx
 = 0;

358 
s
->
£tup_Ën
 = 0;

359 
s
->
£ssiÚ
 = 0;

360 
	`mem£t
(
s
->
buf
, 0, (s->buf));

363 
s
->
•
[0].
cÚfig
 = 
MGC_M_CONFIGDATA_SOFTCONE
 | 
MGC_M_CONFIGDATA_DYNFIFO
;

364 
i
 = 0; i < 16; i ++) {

365 
s
->
•
[
i
].
fifosize
 = 64;

366 
s
->
•
[
i
].
maxp
[0] = 0x40;

367 
s
->
•
[
i
].
maxp
[1] = 0x40;

368 
s
->
•
[
i
].
musb
 = s;

369 
s
->
•
[
i
].
•num
 = i;

370 
	`usb_·ck‘_š™
(&
s
->
•
[
i
].
·ckey
[0].
p
);

371 
	`usb_·ck‘_š™
(&
s
->
•
[
i
].
·ckey
[1].
p
);

373 
	}
}

375 
MUSBS‹
 *
	$musb_š™
(
DeviûS‹
 *
·»Á_deviû
, 
gpio_ba£
)

377 
MUSBS‹
 *
s
 = 
	`g_m®loc0
((*s));

378 
i
;

380 
i
 = 0; i < 
musb_œq_max
; i++) {

381 
s
->
œqs
[
i
] = 
	`qdev_g‘_gpio_š
(
·»Á_deviû
, 
gpio_ba£
 + i);

384 
	`musb_»£t
(
s
);

386 
	`usb_bus_Ãw
(&
s
->
bus
, &
musb_bus_İs
, 
·»Á_deviû
);

387 
	`usb_»gi¡”_pÜt
(&
s
->
bus
, &s->
pÜt
, s, 0, &
musb_pÜt_İs
,

388 
USB_SPEED_MASK_LOW
 | 
USB_SPEED_MASK_FULL
);

390  
s
;

391 
	}
}

393 
	$musb_vbus_£t
(
MUSBS‹
 *
s
, 
Ëv–
)

395 ià(
Ëv–
)

396 
s
->
devùl
 |ğ3 << 
MGC_S_DEVCTL_VBUS
;

398 
s
->
devùl
 &ğ~
MGC_M_DEVCTL_VBUS
;

400 
	`qemu_£t_œq
(
s
->
œqs
[
musb_£t_vbus
], 
Ëv–
);

401 
	}
}

403 
	$musb_šŒ_£t
(
MUSBS‹
 *
s
, 
lše
, 
Ëv–
)

405 ià(!
Ëv–
) {

406 
s
->
šŒ
 &ğ~(1 << 
lše
);

407 
	`qemu_œq_low”
(
s
->
œqs
[
lše
]);

408 } ià(
s
->
mask
 & (1 << 
lše
)) {

409 
s
->
šŒ
 |ğ1 << 
lše
;

410 
	`qemu_œq_¿i£
(
s
->
œqs
[
lše
]);

412 
	}
}

414 
	$musb_tx_šŒ_£t
(
MUSBS‹
 *
s
, 
lše
, 
Ëv–
)

416 ià(!
Ëv–
) {

417 
s
->
tx_šŒ
 &ğ~(1 << 
lše
);

418 ià(!
s
->
tx_šŒ
)

419 
	`qemu_œq_low”
(
s
->
œqs
[
musb_œq_tx
]);

420 } ià(
s
->
tx_mask
 & (1 << 
lše
)) {

421 
s
->
tx_šŒ
 |ğ1 << 
lše
;

422 
	`qemu_œq_¿i£
(
s
->
œqs
[
musb_œq_tx
]);

424 
	}
}

426 
	$musb_rx_šŒ_£t
(
MUSBS‹
 *
s
, 
lše
, 
Ëv–
)

428 ià(
lše
) {

429 ià(!
Ëv–
) {

430 
s
->
rx_šŒ
 &ğ~(1 << 
lše
);

431 ià(!
s
->
rx_šŒ
)

432 
	`qemu_œq_low”
(
s
->
œqs
[
musb_œq_rx
]);

433 } ià(
s
->
rx_mask
 & (1 << 
lše
)) {

434 
s
->
rx_šŒ
 |ğ1 << 
lše
;

435 
	`qemu_œq_¿i£
(
s
->
œqs
[
musb_œq_rx
]);

438 
	`musb_tx_šŒ_£t
(
s
, 
lše
, 
Ëv–
);

439 
	}
}

441 
ušt32_t
 
	$musb_cÜe_šŒ_g‘
(
MUSBS‹
 *
s
)

443  (
s
->
rx_šŒ
 << 15è| s->
tx_šŒ
;

444 
	}
}

446 
	$musb_cÜe_šŒ_ş—r
(
MUSBS‹
 *
s
, 
ušt32_t
 
mask
)

448 ià(
s
->
rx_šŒ
) {

449 
s
->
rx_šŒ
 &ğ
mask
 >> 15;

450 ià(!
s
->
rx_šŒ
)

451 
	`qemu_œq_low”
(
s
->
œqs
[
musb_œq_rx
]);

454 ià(
s
->
tx_šŒ
) {

455 
s
->
tx_šŒ
 &ğ
mask
 & 0xffff;

456 ià(!
s
->
tx_šŒ
)

457 
	`qemu_œq_low”
(
s
->
œqs
[
musb_œq_tx
]);

459 
	}
}

461 
	$musb_£t_size
(
MUSBS‹
 *
s
, 
•num
, 
size
, 
is_tx
)

463 
s
->
•
[
•num
].
ext_size
[!
is_tx
] = 
size
;

464 
s
->
•
[
•num
].
fifo¡¬t
[0] = 0;

465 
s
->
•
[
•num
].
fifo¡¬t
[1] = 0;

466 
s
->
•
[
•num
].
fifŞ’
[0] = 0;

467 
s
->
•
[
•num
].
fifŞ’
[1] = 0;

468 
	}
}

470 
	$musb_£ssiÚ_upd©e
(
MUSBS‹
 *
s
, 
´ev_dev
, 
´ev_£ss
)

472 
d‘eù_´ev
 = 
´ev_dev
 && 
´ev_£ss
;

473 
d‘eù
 = !!
s
->
pÜt
.
dev
 && s->
£ssiÚ
;

475 ià(
d‘eù
 && !
d‘eù_´ev
) {

479 
	`musb_šŒ_£t
(
s
, 
musb_œq_cÚÃù
, 1);

481 ià(
s
->
pÜt
.
dev
->
¥“d
 =ğ
USB_SPEED_LOW
) {

482 
s
->
devùl
 &ğ~
MGC_M_DEVCTL_FSDEV
;

483 
s
->
devùl
 |ğ
MGC_M_DEVCTL_LSDEV
;

485 
s
->
devùl
 |ğ
MGC_M_DEVCTL_FSDEV
;

486 
s
->
devùl
 &ğ~
MGC_M_DEVCTL_LSDEV
;

490 
s
->
devùl
 &ğ~
MGC_M_DEVCTL_BDEVICE
;

493 
s
->
devùl
 |ğ
MGC_M_DEVCTL_HM
;

495 
	`musb_vbus_£t
(
s
, 1);

497 } ià(!
d‘eù
 && 
d‘eù_´ev
) {

499 
	`musb_vbus_£t
(
s
, 0);

502 
	}
}

505 
	$musb_©ch
(
USBPÜt
 *
pÜt
)

507 
MUSBS‹
 *
s
 = (MUSBS‹ *è
pÜt
->
İaque
;

509 
	`musb_šŒ_£t
(
s
, 
musb_œq_vbus_»que¡
, 1);

510 
	`musb_£ssiÚ_upd©e
(
s
, 0, s->
£ssiÚ
);

511 
	}
}

513 
	$musb_d‘ach
(
USBPÜt
 *
pÜt
)

515 
MUSBS‹
 *
s
 = (MUSBS‹ *è
pÜt
->
İaque
;

517 
	`musb_async_ÿnûl_deviû
(
s
, 
pÜt
->
dev
);

519 
	`musb_šŒ_£t
(
s
, 
musb_œq_discÚÃù
, 1);

520 
	`musb_£ssiÚ_upd©e
(
s
, 1, s->
£ssiÚ
);

521 
	}
}

523 
	$musb_chd_d‘ach
(
USBPÜt
 *
pÜt
, 
USBDeviû
 *
chd
)

525 
MUSBS‹
 *
s
 = (MUSBS‹ *è
pÜt
->
İaque
;

527 
	`musb_async_ÿnûl_deviû
(
s
, 
chd
);

528 
	}
}

530 
	$musb_cb_tick0
(*
İaque
)

532 
MUSBEndPošt
 *
•
 = (MUSBEndPošˆ*è
İaque
;

534 
•
->
d–ayed_cb
[0](&•->
·ckey
[0].
p
, 
İaque
);

535 
	}
}

537 
	$musb_cb_tick1
(*
İaque
)

539 
MUSBEndPošt
 *
•
 = (MUSBEndPošˆ*è
İaque
;

541 
•
->
d–ayed_cb
[1](&•->
·ckey
[1].
p
, 
İaque
);

542 
	}
}

544 
	#musb_cb_tick
 (
dœ
 ? 
musb_cb_tick1
 : 
musb_cb_tick0
)

	)

546 
	$musb_scheduË_cb
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
·ckey
)

548 
MUSBPack‘
 *
p
 = 
	`cÚš”_of
(
·ckey
, MUSBPacket,…);

549 
MUSBEndPošt
 *
•
 = 
p
->ep;

550 
dœ
 = 
p
->dir;

551 
timeout
 = 0;

553 ià(
•
->
¡©us
[
dœ
] =ğ
USB_RET_NAK
)

554 
timeout
 = 
•
->timeout[
dœ
];

555 ià(
•
->
š‹¼u±
[
dœ
])

556 
timeout
 = 8;

558  
	`musb_cb_tick
(
•
);

560 ià(!
•
->
štv_tim”
[
dœ
])

561 
•
->
štv_tim”
[
dœ
] = 
	`qemu_Ãw_tim”_ns
(
vm_şock
, 
musb_cb_tick
,ƒp);

563 
	`qemu_mod_tim”
(
•
->
štv_tim”
[
dœ
], 
	`qemu_g‘_şock_ns
(
vm_şock
) +

564 
	`muldiv64
(
timeout
, 
	`g‘_ticks_³r_£c
(), 8000));

565 
	}
}

567 
	$musb_timeout
(
‰y³
, 
¥“d
, 
v®
)

570  
v®
 << 3;

573 
‰y³
) {

574 
USB_ENDPOINT_XFER_CONTROL
:

575 ià(
v®
 < 2)

577 ià(
¥“d
 =ğ
USB_SPEED_HIGH
)

578  1 << (
v®
 - 1);

580  8 << (
v®
 - 1);

582 
USB_ENDPOINT_XFER_INT
:

583 ià(
¥“d
 =ğ
USB_SPEED_HIGH
)

584 ià(
v®
 < 2)

587  1 << (
v®
 - 1);

589  
v®
 << 3;

591 
USB_ENDPOINT_XFER_BULK
:

592 
USB_ENDPOINT_XFER_ISOC
:

593 ià(
v®
 < 2)

595 ià(
¥“d
 =ğ
USB_SPEED_HIGH
)

596  1 << (
v®
 - 1);

598  8 << (
v®
 - 1);

602 
	`hw_”rÜ
("bad interval\n");

603 
	}
}

605 
	$musb_·ck‘
(
MUSBS‹
 *
s
, 
MUSBEndPošt
 *
•
,

606 
•num
, 
pid
, 
Ën
, 
USBC®lback
 
cb
, 
dœ
)

608 
USBDeviû
 *
dev
;

609 
USBEndpošt
 *
u•
;

610 
»t
;

611 
idx
 = 
•num
 && 
dœ
;

612 
‰y³
;

619 
‰y³
 = 
•num
 ? (
•
->
ty³
[
idx
] >> 4) & 3 : 0;

621 
•
->
timeout
[
dœ
] = 
	`musb_timeout
(
‰y³
,

622 
•
->
ty³
[
idx
] >> 6,ƒp->
š‹rv®
[idx]);

623 
•
->
š‹¼u±
[
dœ
] = 
‰y³
 =ğ
USB_ENDPOINT_XFER_INT
;

624 
•
->
d–ayed_cb
[
dœ
] = 
cb
;

627 
dev
 = 
	`usb_fšd_deviû
(&
s
->
pÜt
, 
•
->
çddr
[
idx
]);

628 
u•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
•
->
ty³
[
idx
] & 0xf);

629 
	`usb_·ck‘_£tup
(&
•
->
·ckey
[
dœ
].
p
, 
pid
, 
u•
,

630 (
dev
->
addr
 << 16è| (
u•
->
Ä
 << 8è| 
pid
);

631 
	`usb_·ck‘_addbuf
(&
•
->
·ckey
[
dœ
].
p
,ƒp->
buf
[
idx
], 
Ën
);

632 
•
->
·ckey
[
dœ
].ep =ƒp;

633 
•
->
·ckey
[
dœ
].dir = dir;

635 
»t
 = 
	`usb_hªdË_·ck‘
(
dev
, &
•
->
·ckey
[
dœ
].
p
);

637 ià(
»t
 =ğ
USB_RET_ASYNC
) {

638 
•
->
¡©us
[
dœ
] = 
Ën
;

642 
•
->
¡©us
[
dœ
] = 
»t
;

643 
	`musb_scheduË_cb
(&
s
->
pÜt
, &
•
->
·ckey
[
dœ
].
p
);

644 
	}
}

646 
	$musb_tx_·ck‘_com¶‘e
(
USBPack‘
 *
·ckey
, *
İaque
)

650 
MUSBEndPošt
 *
•
 = (MUSBEndPošˆ*è
İaque
;

651 
•num
 = 
•
->epnum;

652 
MUSBS‹
 *
s
 = 
•
->
musb
;

654 
•
->
fifo¡¬t
[0] = 0;

655 
•
->
fifŞ’
[0] = 0;

656 #ifdeà
CLEAR_NAK


657 ià(
•
->
¡©us
[0] !ğ
USB_RET_NAK
) {

659 ià(
•num
)

660 
•
->
c¤
[0] &ğ~(
MGC_M_TXCSR_FIFONOTEMPTY
 | 
MGC_M_TXCSR_TXPKTRDY
);

662 
•
->
c¤
[0] &ğ~
MGC_M_CSR0_TXPKTRDY
;

663 #ifdeà
CLEAR_NAK


668 ià(
•num
)

669 
•
->
c¤
[0] &ğ~(
MGC_M_TXCSR_H_ERROR
 | 
MGC_M_TXCSR_H_RXSTALL
 |

670 
MGC_M_TXCSR_H_NAKTIMEOUT
);

672 
•
->
c¤
[0] &ğ~(
MGC_M_CSR0_H_ERROR
 | 
MGC_M_CSR0_H_RXSTALL
 |

673 
MGC_M_CSR0_H_NAKTIMEOUT
 | 
MGC_M_CSR0_H_NO_PING
);

675 ià(
•
->
¡©us
[0] =ğ
USB_RET_STALL
) {

677 
•
->
¡©us
[0] = 0;

679 ià(
•num
)

680 
•
->
c¤
[0] |ğ
MGC_M_TXCSR_H_RXSTALL
;

682 
•
->
c¤
[0] |ğ
MGC_M_CSR0_H_RXSTALL
;

685 ià(
•
->
¡©us
[0] =ğ
USB_RET_NAK
) {

686 
•
->
¡©us
[0] = 0;

690 ià(
•
->
š‹¼u±
[0]) {

694 ià(
•num
)

695 
•
->
c¤
[0] |ğ
MGC_M_TXCSR_H_NAKTIMEOUT
;

697 
•
->
c¤
[0] |ğ
MGC_M_CSR0_H_NAKTIMEOUT
;

700 ià(
•
->
¡©us
[0] < 0) {

701 ià(
•
->
¡©us
[0] =ğ
USB_RET_BABBLE
)

702 
	`musb_šŒ_£t
(
s
, 
musb_œq_r¡_babbË
, 1);

706 ià(
•num
)

707 
•
->
c¤
[0] |ğ
MGC_M_TXCSR_H_ERROR
;

709 
•
->
c¤
[0] |ğ
MGC_M_CSR0_H_ERROR
;

711 
	`musb_tx_šŒ_£t
(
s
, 
•num
, 1);

716 #ifdeà
SETUPLEN_HACK


717 ià(!
•num
 && 
•
->
·ckey
[0].
pid
 =ğ
USB_TOKEN_SETUP
)

718 
s
->
£tup_Ën
 = 
•
->
·ckey
[0].
d©a
[6];

723 
	`musb_tx_šŒ_£t
(
s
, 
•num
, 1);

724 
	}
}

726 
	$musb_rx_·ck‘_com¶‘e
(
USBPack‘
 *
·ckey
, *
İaque
)

730 
MUSBEndPošt
 *
•
 = (MUSBEndPošˆ*è
İaque
;

731 
•num
 = 
•
->epnum;

732 
MUSBS‹
 *
s
 = 
•
->
musb
;

734 
•
->
fifo¡¬t
[1] = 0;

735 
•
->
fifŞ’
[1] = 0;

737 #ifdeà
CLEAR_NAK


738 ià(
•
->
¡©us
[1] !ğ
USB_RET_NAK
) {

740 
•
->
c¤
[1] &ğ~
MGC_M_RXCSR_H_REQPKT
;

741 ià(!
•num
)

742 
•
->
c¤
[0] &ğ~
MGC_M_CSR0_H_REQPKT
;

743 #ifdeà
CLEAR_NAK


748 
•
->
c¤
[1] &ğ~(
MGC_M_RXCSR_H_ERROR
 | 
MGC_M_RXCSR_H_RXSTALL
 |

749 
MGC_M_RXCSR_DATAERROR
);

750 ià(!
•num
)

751 
•
->
c¤
[0] &ğ~(
MGC_M_CSR0_H_ERROR
 | 
MGC_M_CSR0_H_RXSTALL
 |

752 
MGC_M_CSR0_H_NAKTIMEOUT
 | 
MGC_M_CSR0_H_NO_PING
);

754 ià(
•
->
¡©us
[1] =ğ
USB_RET_STALL
) {

755 
•
->
¡©us
[1] = 0;

756 
·ckey
->
»suÉ
 = 0;

758 
•
->
c¤
[1] |ğ
MGC_M_RXCSR_H_RXSTALL
;

759 ià(!
•num
)

760 
•
->
c¤
[0] |ğ
MGC_M_CSR0_H_RXSTALL
;

763 ià(
•
->
¡©us
[1] =ğ
USB_RET_NAK
) {

764 
•
->
¡©us
[1] = 0;

768 ià(
•
->
š‹¼u±
[1])

769  
	`musb_·ck‘
(
s
, 
•
, 
•num
, 
USB_TOKEN_IN
,

770 
·ckey
->
iov
.
size
, 
musb_rx_·ck‘_com¶‘e
, 1);

772 
•
->
c¤
[1] |ğ
MGC_M_RXCSR_DATAERROR
;

773 ià(!
•num
)

774 
•
->
c¤
[0] |ğ
MGC_M_CSR0_H_NAKTIMEOUT
;

777 ià(
•
->
¡©us
[1] < 0) {

778 ià(
•
->
¡©us
[1] =ğ
USB_RET_BABBLE
) {

779 
	`musb_šŒ_£t
(
s
, 
musb_œq_r¡_babbË
, 1);

785 
•
->
c¤
[1] |ğ
MGC_M_RXCSR_H_ERROR
;

786 ià(!
•num
)

787 
•
->
c¤
[0] |ğ
MGC_M_CSR0_H_ERROR
;

789 
	`musb_rx_šŒ_£t
(
s
, 
•num
, 1);

795 
·ckey
->
»suÉ
 = 
•
->
¡©us
[1];

797 ià(!(
•
->
c¤
[1] & (
MGC_M_RXCSR_H_RXSTALL
 | 
MGC_M_RXCSR_DATAERROR
))) {

798 
•
->
c¤
[1] |ğ
MGC_M_RXCSR_FIFOFULL
 | 
MGC_M_RXCSR_RXPKTRDY
;

799 ià(!
•num
)

800 
•
->
c¤
[0] |ğ
MGC_M_CSR0_RXPKTRDY
;

802 
•
->
rxcouÁ
 = 
·ckey
->
»suÉ
;

807 
	`musb_rx_šŒ_£t
(
s
, 
•num
, 1);

808 
	}
}

810 
	$musb_async_ÿnûl_deviû
(
MUSBS‹
 *
s
, 
USBDeviû
 *
dev
)

812 
•
, 
dœ
;

814 
•
 = 0;ƒp < 16;ƒp++) {

815 
dœ
 = 0; dir < 2; dir++) {

816 ià(!
	`usb_·ck‘_is_šæight
(&
s
->
•
[•].
·ckey
[
dœ
].
p
) ||

817 
s
->
•
[•].
·ckey
[
dœ
].
p
.•->
dev
 != dev) {

820 
	`usb_ÿnûl_·ck‘
(&
s
->
•
[•].
·ckey
[
dœ
].
p
);

824 
	}
}

826 
	$musb_tx_rdy
(
MUSBS‹
 *
s
, 
•num
)

828 
MUSBEndPošt
 *
•
 = 
s
->• + 
•num
;

829 
pid
;

830 
tÙ®
, 
v®id
 = 0;

831 
	`TRACE
("¡¬ˆ%d,†’ %d", 
•
->
fifo¡¬t
[0],ƒp->
fifŞ’
[0] );

832 
•
->
fifo¡¬t
[0] +ğ•->
fifŞ’
[0];

833 
•
->
fifŞ’
[0] = 0;

837 
tÙ®
 = 
•
->
maxp
[0] & 0x3ff;

839 ià(
•
->
ext_size
[0]) {

840 
tÙ®
 = 
•
->
ext_size
[0];

841 
•
->
ext_size
[0] = 0;

842 
v®id
 = 1;

846 ià(
•num
 && (
•
->
fifo¡¬t
[0]è< 
tÙ®
)

849 ià(!
v®id
)

850 
tÙ®
 = 
•
->
fifo¡¬t
[0];

852 
pid
 = 
USB_TOKEN_OUT
;

853 ià(!
•num
 && (
•
->
c¤
[0] & 
MGC_M_CSR0_H_SETUPPKT
)) {

854 
pid
 = 
USB_TOKEN_SETUP
;

855 ià(
tÙ®
 != 8) {

856 
	`TRACE
("Ëg® SETUPPKT†’gth oà%˜by‹s", 
tÙ®
);

862  
	`musb_·ck‘
(
s
, 
•
, 
•num
, 
pid
,

863 
tÙ®
, 
musb_tx_·ck‘_com¶‘e
, 0);

864 
	}
}

866 
	$musb_rx_»q
(
MUSBS‹
 *
s
, 
•num
)

868 
MUSBEndPošt
 *
•
 = 
s
->• + 
•num
;

869 
tÙ®
;

873 ià(
•
->
·ckey
[1].
p
.
pid
 =ğ
USB_TOKEN_IN
 &&ƒp->
¡©us
[1] >= 0 &&

874 (
•
->
fifo¡¬t
[1]è+ƒp->
rxcouÁ
 <

875 
•
->
·ckey
[1].
p
.
iov
.
size
) {

876 
	`TRACE
("0x%08x, %d", 
•
->
fifo¡¬t
[1],ƒp->
rxcouÁ
 );

877 
•
->
fifo¡¬t
[1] +ğ•->
rxcouÁ
;

878 
•
->
fifŞ’
[1] = 0;

880 
•
->
rxcouÁ
 = 
	`MIN
Óp->
·ckey
[0].
p
.
iov
.
size
 - (•->
fifo¡¬t
[1]),

881 
•
->
maxp
[1]);

883 
•
->
c¤
[1] &ğ~
MGC_M_RXCSR_H_REQPKT
;

884 ià(!
•num
)

885 
•
->
c¤
[0] &ğ~
MGC_M_CSR0_H_REQPKT
;

888 
•
->
c¤
[1] &ğ~(
MGC_M_RXCSR_H_ERROR
 | 
MGC_M_RXCSR_H_RXSTALL
 |

889 
MGC_M_RXCSR_DATAERROR
);

890 ià(!
•num
)

891 
•
->
c¤
[0] &ğ~(
MGC_M_CSR0_H_ERROR
 | 
MGC_M_CSR0_H_RXSTALL
 |

892 
MGC_M_CSR0_H_NAKTIMEOUT
 | 
MGC_M_CSR0_H_NO_PING
);

894 
•
->
c¤
[1] |ğ
MGC_M_RXCSR_FIFOFULL
 | 
MGC_M_RXCSR_RXPKTRDY
;

895 ià(!
•num
)

896 
•
->
c¤
[0] |ğ
MGC_M_CSR0_RXPKTRDY
;

897 
	`musb_rx_šŒ_£t
(
s
, 
•num
, 1);

913 
tÙ®
 = 
	`MIN
(
•
->
maxp
[1] & 0x3ff, (
s
->
buf
));

915 #ifdeà
SETUPLEN_HACK


917 ià(!
•num
) {

918 ià(
•
->
·ckey
[0].
p
.
devaddr
 == 2) {

919 
tÙ®
 = 
	`MIN
(
s
->
£tup_Ën
, 8);

921 
tÙ®
 = 
	`MIN
(
s
->
£tup_Ën
, 64);

923 
s
->
£tup_Ën
 -ğ
tÙ®
;

927  
	`musb_·ck‘
(
s
, 
•
, 
•num
, 
USB_TOKEN_IN
,

928 
tÙ®
, 
musb_rx_·ck‘_com¶‘e
, 1);

929 
	}
}

931 
ušt8_t
 
	$musb_»ad_fifo
(
MUSBEndPošt
 *
•
)

933 
ušt8_t
 
v®ue
;

934 ià(
•
->
fifŞ’
[1] >= 64) {

936 
	`TRACE
("EP%d FIFO i nowƒm±y, stİ„—dšg", 
•
->
•num
);

942 
•
->
c¤
[1] &ğ~
MGC_M_RXCSR_FIFOFULL
;

943 
v®ue
=
•
->
buf
[1][•->
fifo¡¬t
[1] +ƒp->
fifŞ’
[1] ++];

944 
	`TRACE
("EP%d 0x%02x, %d", 
•
->
•num
, 
v®ue
,ƒp->
fifŞ’
[1] );

945  
v®ue
;

946 
	}
}

948 
	$musb_wr™e_fifo
(
MUSBEndPošt
 *
•
, 
ušt8_t
 
v®ue
)

950 
	`TRACE
("EP%d = %02x", 
•
->
•num
, 
v®ue
);

951 ià(
•
->
fifŞ’
[0] >= 64) {

953 
	`TRACE
("EP%d FIFOƒxûeded 64 by‹s, stİ f“dšg d©a", 
•
->
•num
);

957 
•
->
buf
[0][•->
fifo¡¬t
[0] +ƒp->
fifŞ’
[0] ++] = 
v®ue
;

958 
•
->
c¤
[0] |ğ
MGC_M_TXCSR_FIFONOTEMPTY
;

959 
	}
}

961 
	$musb_•_äame_ÿnûl
(
MUSBEndPošt
 *
•
, 
dœ
)

963 ià(
•
->
štv_tim”
[
dœ
])

964 
	`qemu_d–_tim”
(
•
->
štv_tim”
[
dœ
]);

965 
	}
}

968 
ušt8_t
 
	$musb_busùl_»adb
(*
İaque
, 
•
, 
addr
)

970 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

972 
addr
) {

974 
MUSB_HDRC_TXHUBADDR
:

975  
s
->
•
[•].
haddr
[0];

976 
MUSB_HDRC_TXHUBPORT
:

977  
s
->
•
[•].
hpÜt
[0];

978 
MUSB_HDRC_RXHUBADDR
:

979  
s
->
•
[•].
haddr
[1];

980 
MUSB_HDRC_RXHUBPORT
:

981  
s
->
•
[•].
hpÜt
[1];

984 
	`TRACE
("unknowÀ»gi¡” 0x%02x", 
addr
);

987 
	}
}

989 
	$musb_busùl_wr™eb
(*
İaque
, 
•
, 
addr
, 
ušt8_t
 
v®ue
)

991 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

993 
addr
) {

994 
MUSB_HDRC_TXFUNCADDR
:

995 
s
->
•
[•].
çddr
[0] = 
v®ue
;

997 
MUSB_HDRC_RXFUNCADDR
:

998 
s
->
•
[•].
çddr
[1] = 
v®ue
;

1000 
MUSB_HDRC_TXHUBADDR
:

1001 
s
->
•
[•].
haddr
[0] = 
v®ue
;

1003 
MUSB_HDRC_TXHUBPORT
:

1004 
s
->
•
[•].
hpÜt
[0] = 
v®ue
;

1006 
MUSB_HDRC_RXHUBADDR
:

1007 
s
->
•
[•].
haddr
[1] = 
v®ue
;

1009 
MUSB_HDRC_RXHUBPORT
:

1010 
s
->
•
[•].
hpÜt
[1] = 
v®ue
;

1014 
	`TRACE
("unknowÀ»gi¡” 0x%02x", 
addr
);

1017 
	}
}

1019 
ušt16_t
 
	$musb_busùl_»adh
(*
İaque
, 
•
, 
addr
)

1021 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1023 
addr
) {

1024 
MUSB_HDRC_TXFUNCADDR
:

1025  
s
->
•
[•].
çddr
[0];

1026 
MUSB_HDRC_RXFUNCADDR
:

1027  
s
->
•
[•].
çddr
[1];

1030  
	`musb_busùl_»adb
(
s
, 
•
, 
addr
) |

1031 (
	`musb_busùl_»adb
(
s
, 
•
, 
addr
 | 1) << 8);

1033 
	}
}

1035 
	$musb_busùl_wr™eh
(*
İaque
, 
•
, 
addr
, 
ušt16_t
 
v®ue
)

1037 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1039 
addr
) {

1040 
MUSB_HDRC_TXFUNCADDR
:

1041 
s
->
•
[•].
çddr
[0] = 
v®ue
;

1043 
MUSB_HDRC_RXFUNCADDR
:

1044 
s
->
•
[•].
çddr
[1] = 
v®ue
;

1048 
	`musb_busùl_wr™eb
(
s
, 
•
, 
addr
, 
v®ue
 & 0xff);

1049 
	`musb_busùl_wr™eb
(
s
, 
•
, 
addr
 | 1, 
v®ue
 >> 8);

1051 
	}
}

1054 
ušt8_t
 
	$musb_•_»adb
(*
İaque
, 
•
, 
addr
)

1056 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1058 
addr
) {

1059 
MUSB_HDRC_TXTYPE
:

1060  
s
->
•
[•].
ty³
[0];

1061 
MUSB_HDRC_TXINTERVAL
:

1062  
s
->
•
[•].
š‹rv®
[0];

1063 
MUSB_HDRC_RXTYPE
:

1064  
s
->
•
[•].
ty³
[1];

1065 
MUSB_HDRC_RXINTERVAL
:

1066  
s
->
•
[•].
š‹rv®
[1];

1067 (
MUSB_HDRC_FIFOSIZE
 & ~1):

1069 
MUSB_HDRC_FIFOSIZE
:

1070  
•
 ? 
s
->•[•].
fifosize
 : s->•[•].
cÚfig
;

1071 
MUSB_HDRC_RXCOUNT
:

1072  
s
->
•
[•].
rxcouÁ
;

1075 
	`TRACE
("unknowÀ»gi¡” 0x%02x", 
addr
);

1078 
	}
}

1080 
	$musb_•_wr™eb
(*
İaque
, 
•
, 
addr
, 
ušt8_t
 
v®ue
)

1082 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1084 
addr
) {

1085 
MUSB_HDRC_TXTYPE
:

1086 
s
->
•
[•].
ty³
[0] = 
v®ue
;

1088 
MUSB_HDRC_TXINTERVAL
:

1089 
s
->
•
[•].
š‹rv®
[0] = 
v®ue
;

1090 
	`musb_•_äame_ÿnûl
(&
s
->
•
[ep], 0);

1092 
MUSB_HDRC_RXTYPE
:

1093 
s
->
•
[•].
ty³
[1] = 
v®ue
;

1095 
MUSB_HDRC_RXINTERVAL
:

1096 
s
->
•
[•].
š‹rv®
[1] = 
v®ue
;

1097 
	`musb_•_äame_ÿnûl
(&
s
->
•
[ep], 1);

1099 (
MUSB_HDRC_FIFOSIZE
 & ~1):

1101 
MUSB_HDRC_FIFOSIZE
:

1102 
	`TRACE
("somebody mes£ w™h fifosizÒow %˜by‹s)", 
v®ue
);

1103 
s
->
•
[•].
fifosize
 = 
v®ue
;

1106 
	`TRACE
("unknowÀ»gi¡” 0x%02x", 
addr
);

1109 
	}
}

1111 
ušt16_t
 
	$musb_•_»adh
(*
İaque
, 
•
, 
addr
)

1113 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1114 
ušt16_t
 
»t
;

1116 
addr
) {

1117 
MUSB_HDRC_TXMAXP
:

1118  
s
->
•
[•].
maxp
[0];

1119 
MUSB_HDRC_TXCSR
:

1120  
s
->
•
[•].
c¤
[0];

1121 
MUSB_HDRC_RXMAXP
:

1122  
s
->
•
[•].
maxp
[1];

1123 
MUSB_HDRC_RXCSR
:

1124 
»t
 = 
s
->
•
[•].
c¤
[1];

1128 ià(
s
->
•
[•].
c¤
[1] & 
MGC_M_RXCSR_AUTOCLEAR
)

1129 
s
->
•
[•].
c¤
[1] &ğ~
MGC_M_RXCSR_RXPKTRDY
;

1131  
»t
;

1132 
MUSB_HDRC_RXCOUNT
:

1133  
s
->
•
[•].
rxcouÁ
;

1136  
	`musb_•_»adb
(
s
, 
•
, 
addr
) |

1137 (
	`musb_•_»adb
(
s
, 
•
, 
addr
 | 1) << 8);

1139 
	}
}

1141 
	$musb_•_wr™eh
(*
İaque
, 
•
, 
addr
, 
ušt16_t
 
v®ue
)

1143 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1145 
addr
) {

1146 
MUSB_HDRC_TXMAXP
:

1147 
s
->
•
[•].
maxp
[0] = 
v®ue
;

1149 
MUSB_HDRC_TXCSR
:

1150 ià(
•
) {

1151 
s
->
•
[•].
c¤
[0] &ğ
v®ue
 & 0xa6;

1152 
s
->
•
[•].
c¤
[0] |ğ
v®ue
 & 0xff59;

1154 
s
->
•
[•].
c¤
[0] &ğ
v®ue
 & 0x85;

1155 
s
->
•
[•].
c¤
[0] |ğ
v®ue
 & 0xf7a;

1158 
	`musb_•_äame_ÿnûl
(&
s
->
•
[ep], 0);

1160 ià((
•
 && (
v®ue
 & 
MGC_M_TXCSR_FLUSHFIFO
)) ||

1161 (!
•
 && (
v®ue
 & 
MGC_M_CSR0_FLUSHFIFO
))) {

1162 
s
->
•
[•].
fifŞ’
[0] = 0;

1163 
s
->
•
[•].
fifo¡¬t
[0] = 0;

1164 ià(
•
)

1165 
s
->
•
[•].
c¤
[0] &=

1166 ~(
MGC_M_TXCSR_FIFONOTEMPTY
 | 
MGC_M_TXCSR_TXPKTRDY
);

1168 
s
->
•
[•].
c¤
[0] &=

1169 ~(
MGC_M_CSR0_TXPKTRDY
 | 
MGC_M_CSR0_RXPKTRDY
);

1172 (
•
 &&

1173 #ifdeà
CLEAR_NAK


1174 (
v®ue
 & 
MGC_M_TXCSR_TXPKTRDY
) &&

1175 !(
v®ue
 & 
MGC_M_TXCSR_H_NAKTIMEOUT
)) ||

1177 (
v®ue
 & 
MGC_M_TXCSR_TXPKTRDY
)) ||

1179 (!
•
 &&

1180 #ifdeà
CLEAR_NAK


1181 (
v®ue
 & 
MGC_M_CSR0_TXPKTRDY
) &&

1182 !(
v®ue
 & 
MGC_M_CSR0_H_NAKTIMEOUT
)))

1184 (
v®ue
 & 
MGC_M_CSR0_TXPKTRDY
)))

1186 
	`musb_tx_rdy
(
s
, 
•
);

1187 ià(!
•
 &&

1188 (
v®ue
 & 
MGC_M_CSR0_H_REQPKT
) &&

1189 #ifdeà
CLEAR_NAK


1190 !(
v®ue
 & (
MGC_M_CSR0_H_NAKTIMEOUT
 |

1191 
MGC_M_CSR0_RXPKTRDY
)))

1193 !(
v®ue
 & 
MGC_M_CSR0_RXPKTRDY
))

1195 
	`musb_rx_»q
(
s
, 
•
);

1198 
MUSB_HDRC_RXMAXP
:

1199 
s
->
•
[•].
maxp
[1] = 
v®ue
;

1201 
MUSB_HDRC_RXCSR
:

1204 (
v®ue
 & 
MGC_M_RXCSR_H_AUTOREQ
) &&

1205 !(
v®ue
 & 
MGC_M_RXCSR_RXPKTRDY
) &&

1206 (
s
->
•
[•].
c¤
[1] & 
MGC_M_RXCSR_RXPKTRDY
))

1207 
v®ue
 |ğ
MGC_M_RXCSR_H_REQPKT
;

1209 
s
->
•
[•].
c¤
[1] &ğ0x102 | (
v®ue
 & 0x4d);

1210 
s
->
•
[•].
c¤
[1] |ğ
v®ue
 & 0xfeb0;

1212 
	`musb_•_äame_ÿnûl
(&
s
->
•
[ep], 1);

1214 ià(
v®ue
 & 
MGC_M_RXCSR_FLUSHFIFO
) {

1215 
s
->
•
[•].
fifŞ’
[1] = 0;

1216 
s
->
•
[•].
fifo¡¬t
[1] = 0;

1217 
s
->
•
[•].
c¤
[1] &ğ~(
MGC_M_RXCSR_FIFOFULL
 | 
MGC_M_RXCSR_RXPKTRDY
);

1221 #ifdeà
CLEAR_NAK


1222 ià((
v®ue
 & 
MGC_M_RXCSR_H_REQPKT
è&& !(v®u& 
MGC_M_RXCSR_DATAERROR
))

1224 ià(
v®ue
 & 
MGC_M_RXCSR_H_REQPKT
)

1226 
	`musb_rx_»q
(
s
, 
•
);

1228 
MUSB_HDRC_RXCOUNT
:

1229 
s
->
•
[•].
rxcouÁ
 = 
v®ue
;

1233 
	`musb_•_wr™eb
(
s
, 
•
, 
addr
, 
v®ue
 & 0xff);

1234 
	`musb_•_wr™eb
(
s
, 
•
, 
addr
 | 1, 
v®ue
 >> 8);

1236 
	}
}

1239 
ušt32_t
 
	$musb_»adb
(*
İaque
, 
rg‘_phys_addr_t
 
addr
)

1241 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1242 
•
, 
i
;

1243 
ušt8_t
 
»t
;

1245 
addr
) {

1246 
MUSB_HDRC_FADDR
:

1247  
s
->
çddr
;

1248 
MUSB_HDRC_POWER
:

1249  
s
->
pow”
;

1250 
MUSB_HDRC_INTRUSB
:

1251 
»t
 = 
s
->
šŒ
;

1252 
i
 = 0; i < (
»t
) * 8; i ++)

1253 ià(
»t
 & (1 << 
i
))

1254 
	`musb_šŒ_£t
(
s
, 
i
, 0);

1255  
»t
;

1256 
MUSB_HDRC_INTRUSBE
:

1257  
s
->
mask
;

1258 
MUSB_HDRC_INDEX
:

1259  
s
->
idx
;

1260 
MUSB_HDRC_TESTMODE
:

1263 
MUSB_HDRC_EP_IDX
 ... (MUSB_HDRC_EP_IDX + 0xf):

1264  
	`musb_•_»adb
(
s
, s->
idx
, 
addr
 & 0xf);

1266 
MUSB_HDRC_DEVCTL
:

1267  
s
->
devùl
;

1269 
MUSB_HDRC_TXFIFOSZ
:

1270 
MUSB_HDRC_RXFIFOSZ
:

1271 
MUSB_HDRC_VCTRL
:

1275 
MUSB_HDRC_HWVERS
:

1278 (
MUSB_HDRC_VCTRL
 | 1):

1279 (
MUSB_HDRC_HWVERS
 | 1):

1280 (
MUSB_HDRC_DEVCTL
 | 1):

1283 
MUSB_HDRC_BUSCTL
 ... (MUSB_HDRC_BUSCTL + 0x7f):

1284 
•
 = (
addr
 >> 3) & 0xf;

1285  
	`musb_busùl_»adb
(
s
, 
•
, 
addr
 & 0x7);

1287 
MUSB_HDRC_EP
 ... (MUSB_HDRC_EP + 0xff):

1288 
•
 = (
addr
 >> 4) & 0xf;

1289  
	`musb_•_»adb
(
s
, 
•
, 
addr
 & 0xf);

1291 
MUSB_HDRC_FIFO
 ... (MUSB_HDRC_FIFO + 0x3f):

1292 
•
 = ((
addr
 - 
MUSB_HDRC_FIFO
) >> 2) & 0xf;

1293  
	`musb_»ad_fifo
(
s
->
•
 +ƒp);

1296 
	`TRACE
("unknowÀ»gi¡” 0x%02x", (è
addr
);

1299 
	}
}

1301 
	$musb_wr™eb
(*
İaque
, 
rg‘_phys_addr_t
 
addr
, 
ušt32_t
 
v®ue
)

1303 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1304 
•
;

1306 
addr
) {

1307 
MUSB_HDRC_FADDR
:

1308 
s
->
çddr
 = 
v®ue
 & 0x7f;

1310 
MUSB_HDRC_POWER
:

1311 
s
->
pow”
 = (
v®ue
 & 0xef) | (s->power & 0x10);

1313 ià((
v®ue
 & 
MGC_M_POWER_RESET
è&& 
s
->
pÜt
.
dev
) {

1314 
	`usb_deviû_»£t
(
s
->
pÜt
.
dev
);

1316 ià((
v®ue
 & 
MGC_M_POWER_HSENAB
) &&

1317 
s
->
pÜt
.
dev
->
¥“d
 =ğ
USB_SPEED_HIGH
)

1318 
s
->
pow”
 |ğ
MGC_M_POWER_HSMODE
;

1321 ià(
v®ue
 & 
MGC_M_POWER_SUSPENDM
) {

1326 ià(
v®ue
 & 
MGC_M_POWER_RESUME
) {

1331 
MUSB_HDRC_INTRUSB
:

1333 
MUSB_HDRC_INTRUSBE
:

1334 
s
->
mask
 = 
v®ue
 & 0xff;

1336 
MUSB_HDRC_INDEX
:

1337 
s
->
idx
 = 
v®ue
 & 0xf;

1339 
MUSB_HDRC_TESTMODE
:

1342 
MUSB_HDRC_EP_IDX
 ... (MUSB_HDRC_EP_IDX + 0xf):

1343 
	`musb_•_wr™eb
(
s
, s->
idx
, 
addr
 & 0xf, 
v®ue
);

1346 
MUSB_HDRC_DEVCTL
:

1347 
s
->
£ssiÚ
 = !!(
v®ue
 & 
MGC_M_DEVCTL_SESSION
);

1348 
	`musb_£ssiÚ_upd©e
(
s
,

1349 !!
s
->
pÜt
.
dev
,

1350 !!(
s
->
devùl
 & 
MGC_M_DEVCTL_SESSION
));

1353 
s
->
devùl
 &ğ~
MGC_M_DEVCTL_SESSION
;

1354 
s
->
devùl
 |ğ
v®ue
 & 
MGC_M_DEVCTL_SESSION
;

1357 
MUSB_HDRC_TXFIFOSZ
:

1358 
MUSB_HDRC_RXFIFOSZ
:

1359 
MUSB_HDRC_VCTRL
:

1363 (
MUSB_HDRC_VCTRL
 | 1):

1364 (
MUSB_HDRC_DEVCTL
 | 1):

1367 
MUSB_HDRC_BUSCTL
 ... (MUSB_HDRC_BUSCTL + 0x7f):

1368 
•
 = (
addr
 >> 3) & 0xf;

1369 
	`musb_busùl_wr™eb
(
s
, 
•
, 
addr
 & 0x7, 
v®ue
);

1372 
MUSB_HDRC_EP
 ... (MUSB_HDRC_EP + 0xff):

1373 
•
 = (
addr
 >> 4) & 0xf;

1374 
	`musb_•_wr™eb
(
s
, 
•
, 
addr
 & 0xf, 
v®ue
);

1377 
MUSB_HDRC_FIFO
 ... (MUSB_HDRC_FIFO + 0x3f):

1378 
•
 = ((
addr
 - 
MUSB_HDRC_FIFO
) >> 2) & 0xf;

1379 
	`musb_wr™e_fifo
(
s
->
•
 +ƒp, 
v®ue
 & 0xff);

1383 
	`TRACE
("unknowÀ»gi¡” 0x%02x", (è
addr
);

1386 
	}
}

1388 
ušt32_t
 
	$musb_»adh
(*
İaque
, 
rg‘_phys_addr_t
 
addr
)

1390 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1391 
•
, 
i
;

1392 
ušt16_t
 
»t
;

1394 
addr
) {

1395 
MUSB_HDRC_INTRTX
:

1396 
»t
 = 
s
->
tx_šŒ
;

1398 
i
 = 0; i < (
»t
) * 8; i ++)

1399 ià(
»t
 & (1 << 
i
))

1400 
	`musb_tx_šŒ_£t
(
s
, 
i
, 0);

1401  
»t
;

1402 
MUSB_HDRC_INTRRX
:

1403 
»t
 = 
s
->
rx_šŒ
;

1405 
i
 = 0; i < (
»t
) * 8; i ++)

1406 ià(
»t
 & (1 << 
i
))

1407 
	`musb_rx_šŒ_£t
(
s
, 
i
, 0);

1408  
»t
;

1409 
MUSB_HDRC_INTRTXE
:

1410  
s
->
tx_mask
;

1411 
MUSB_HDRC_INTRRXE
:

1412  
s
->
rx_mask
;

1414 
MUSB_HDRC_FRAME
:

1417 
MUSB_HDRC_TXFIFOADDR
:

1418  
s
->
•
[s->
idx
].
fifßddr
[0];

1419 
MUSB_HDRC_RXFIFOADDR
:

1420  
s
->
•
[s->
idx
].
fifßddr
[1];

1422 
MUSB_HDRC_EP_IDX
 ... (MUSB_HDRC_EP_IDX + 0xf):

1423  
	`musb_•_»adh
(
s
, s->
idx
, 
addr
 & 0xf);

1425 
MUSB_HDRC_BUSCTL
 ... (MUSB_HDRC_BUSCTL + 0x7f):

1426 
•
 = (
addr
 >> 3) & 0xf;

1427  
	`musb_busùl_»adh
(
s
, 
•
, 
addr
 & 0x7);

1429 
MUSB_HDRC_EP
 ... (MUSB_HDRC_EP + 0xff):

1430 
•
 = (
addr
 >> 4) & 0xf;

1431  
	`musb_•_»adh
(
s
, 
•
, 
addr
 & 0xf);

1433 
MUSB_HDRC_FIFO
 ... (MUSB_HDRC_FIFO + 0x3f):

1434 
•
 = ((
addr
 - 
MUSB_HDRC_FIFO
) >> 2) & 0xf;

1435  (
	`musb_»ad_fifo
(
s
->
•
 +ƒp) | musb_read_fifo(s->ep +ƒp) << 8);

1438  
	`musb_»adb
(
s
, 
addr
) | (musb_readb(s,‡ddr | 1) << 8);

1440 
	}
}

1442 
	$musb_wr™eh
(*
İaque
, 
rg‘_phys_addr_t
 
addr
, 
ušt32_t
 
v®ue
)

1444 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1445 
•
;

1447 
addr
) {

1448 
MUSB_HDRC_INTRTXE
:

1449 
s
->
tx_mask
 = 
v®ue
;

1454 
MUSB_HDRC_INTRRXE
:

1455 
s
->
rx_mask
 = 
v®ue
;

1458 
MUSB_HDRC_FRAME
:

1461 
MUSB_HDRC_TXFIFOADDR
:

1462 
s
->
•
[s->
idx
].
fifßddr
[0] = 
v®ue
;

1463 
s
->
•
[s->
idx
].
buf
[0] =

1464 
s
->
buf
 + ((
v®ue
 << 3) & 0x7ff );

1466 
MUSB_HDRC_RXFIFOADDR
:

1467 
s
->
•
[s->
idx
].
fifßddr
[1] = 
v®ue
;

1468 
s
->
•
[s->
idx
].
buf
[1] =

1469 
s
->
buf
 + ((
v®ue
 << 3) & 0x7ff);

1472 
MUSB_HDRC_EP_IDX
 ... (MUSB_HDRC_EP_IDX + 0xf):

1473 
	`musb_•_wr™eh
(
s
, s->
idx
, 
addr
 & 0xf, 
v®ue
);

1476 
MUSB_HDRC_BUSCTL
 ... (MUSB_HDRC_BUSCTL + 0x7f):

1477 
•
 = (
addr
 >> 3) & 0xf;

1478 
	`musb_busùl_wr™eh
(
s
, 
•
, 
addr
 & 0x7, 
v®ue
);

1481 
MUSB_HDRC_EP
 ... (MUSB_HDRC_EP + 0xff):

1482 
•
 = (
addr
 >> 4) & 0xf;

1483 
	`musb_•_wr™eh
(
s
, 
•
, 
addr
 & 0xf, 
v®ue
);

1486 
MUSB_HDRC_FIFO
 ... (MUSB_HDRC_FIFO + 0x3f):

1487 
•
 = ((
addr
 - 
MUSB_HDRC_FIFO
) >> 2) & 0xf;

1488 
	`musb_wr™e_fifo
(
s
->
•
 +ƒp, 
v®ue
 & 0xff);

1489 
	`musb_wr™e_fifo
(
s
->
•
 +ƒp, (
v®ue
 >> 8) & 0xff);

1493 
	`musb_wr™eb
(
s
, 
addr
, 
v®ue
 & 0xff);

1494 
	`musb_wr™eb
(
s
, 
addr
 | 1, 
v®ue
 >> 8);

1496 
	}
}

1498 
ušt32_t
 
	$musb_»adw
(*
İaque
, 
rg‘_phys_addr_t
 
addr
)

1500 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1501 
•
;

1503 
addr
) {

1504 
MUSB_HDRC_FIFO
 ... (MUSB_HDRC_FIFO + 0x3f):

1505 
•
 = ((
addr
 - 
MUSB_HDRC_FIFO
) >> 2) & 0xf;

1506  ( 
	`musb_»ad_fifo
(
s
->
•
 +ƒp) |

1507 
	`musb_»ad_fifo
(
s
->
•
 +ƒp) << 8 |

1508 
	`musb_»ad_fifo
(
s
->
•
 +ƒp) << 16 |

1509 
	`musb_»ad_fifo
(
s
->
•
 +ƒp) << 24 );

1511 
	`TRACE
("unknowÀ»gi¡” 0x%02x", (è
addr
);

1514 
	}
}

1516 
	$musb_wr™ew
(*
İaque
, 
rg‘_phys_addr_t
 
addr
, 
ušt32_t
 
v®ue
)

1518 
MUSBS‹
 *
s
 = (MUSBS‹ *è
İaque
;

1519 
•
;

1521 
addr
) {

1522 
MUSB_HDRC_FIFO
 ... (MUSB_HDRC_FIFO + 0x3f):

1523 
•
 = ((
addr
 - 
MUSB_HDRC_FIFO
) >> 2) & 0xf;

1524 
	`musb_wr™e_fifo
(
s
->
•
 +ƒp, 
v®ue
 & 0xff);

1525 
	`musb_wr™e_fifo
(
s
->
•
 +ƒp, (
v®ue
 >> 8 ) & 0xff);

1526 
	`musb_wr™e_fifo
(
s
->
•
 +ƒp, (
v®ue
 >> 16) & 0xff);

1527 
	`musb_wr™e_fifo
(
s
->
•
 +ƒp, (
v®ue
 >> 24) & 0xff);

1530 
	`TRACE
("unknowÀ»gi¡” 0x%02x", (è
addr
);

1533 
	}
}

1535 
CPUR—dMemÜyFunc
 * cÚ¡ 
	gmusb_»ad
[] = {

1536 
musb_»adb
,

1537 
musb_»adh
,

1538 
musb_»adw
,

1541 
CPUWr™eMemÜyFunc
 * cÚ¡ 
	gmusb_wr™e
[] = {

1542 
musb_wr™eb
,

1543 
musb_wr™eh
,

1544 
musb_wr™ew
,

	@hcd-ohci.c

29 
	~"hw/hw.h
"

30 
	~"qemu-tim”.h
"

31 
	~"hw/usb.h
"

32 
	~"hw/pci.h
"

33 
	~"hw/sysbus.h
"

34 
	~"hw/qdev-dma.h
"

43 #ifdeà
DEBUG_OHCI


44 
	#DPRINTF
 
´štf


	)

46 
	#DPRINTF
(...)

	)

51 
	#OHCI_MAX_PORTS
 15

	)

53 
št64_t
 
	gusb_äame_time
;

54 
št64_t
 
	gusb_b™_time
;

56 
	sOHCIPÜt
 {

57 
USBPÜt
 
	mpÜt
;

58 
ušt32_t
 
	mù¾
;

59 } 
	tOHCIPÜt
;

62 
USBBus
 
	mbus
;

63 
qemu_œq
 
	mœq
;

64 
MemÜyRegiÚ
 
	mmem
;

65 
DMACÚ‹xt
 *
	mdma
;

66 
	mnum_pÜts
;

67 cÚ¡ *
	mÇme
;

69 
QEMUTim”
 *
	meof_tim”
;

70 
št64_t
 
	msof_time
;

74 
ušt32_t
 
	mùl
, 
	m¡©us
;

75 
ušt32_t
 
	mšŒ_¡©us
;

76 
ušt32_t
 
	mšŒ
;

79 
ušt32_t
 
	mhcÿ
;

80 
ušt32_t
 
	mù¾_h—d
, 
	mù¾_cur
;

81 
ušt32_t
 
	mbulk_h—d
, 
	mbulk_cur
;

82 
ušt32_t
 
	m³r_cur
;

83 
ušt32_t
 
	mdÚe
;

84 
	mdÚe_couÁ
;

87 
ušt32_t
 
	mfsmps
:15;

88 
ušt32_t
 
	mf™
:1;

89 
ušt32_t
 
	mfi
:14;

90 
ušt32_t
 
	mät
:1;

91 
ušt16_t
 
	mäame_numb”
;

92 
ušt16_t
 
	m·ddšg
;

93 
ušt32_t
 
	mp¡¬t
;

94 
ušt32_t
 
	ml¡
;

97 
ušt32_t
 
	mrhdesc_a
, 
	mrhdesc_b
;

98 
ušt32_t
 
	mrh¡©us
;

99 
OHCIPÜt
 
	mrhpÜt
[
OHCI_MAX_PORTS
];

102 
ušt32_t
 
	mh¡©us
;

103 
ušt32_t
 
	mhmask
;

104 
ušt32_t
 
	mh»£t
;

105 
ušt32_t
 
	mh‹¡
;

108 
dma_addr_t
 
	mloÿlmem_ba£
;

111 
ušt32_t
 
	mŞd_ùl
;

112 
USBPack‘
 
	musb_·ck‘
;

113 
ušt8_t
 
	musb_buf
[8192];

114 
ušt32_t
 
	masync_td
;

115 
	masync_com¶‘e
;

117 } 
	tOHCIS‹
;

120 
	sohci_hcÿ
 {

121 
ušt32_t
 
	mšŒ
[32];

122 
ušt16_t
 
	mäame
, 
	m·d
;

123 
ušt32_t
 
	mdÚe
;

125 
	#HCCA_WRITEBACK_OFFSET
 
	`off£tof
(
ohci_hcÿ
, 
äame
)

	)

126 
	#HCCA_WRITEBACK_SIZE
 8

	)

128 
	#ED_WBACK_OFFSET
 
	`off£tof
(
ohci_ed
, 
h—d
)

	)

129 
	#ED_WBACK_SIZE
 4

	)

131 
ohci_bus_¡İ
(
OHCIS‹
 *
ohci
);

132 
ohci_async_ÿnûl_deviû
(
OHCIS‹
 *
ohci
, 
USBDeviû
 *
dev
);

135 
	#OHCI_ED_FA_SHIFT
 0

	)

136 
	#OHCI_ED_FA_MASK
 (0x7f<<
OHCI_ED_FA_SHIFT
)

	)

137 
	#OHCI_ED_EN_SHIFT
 7

	)

138 
	#OHCI_ED_EN_MASK
 (0xf<<
OHCI_ED_EN_SHIFT
)

	)

139 
	#OHCI_ED_D_SHIFT
 11

	)

140 
	#OHCI_ED_D_MASK
 (3<<
OHCI_ED_D_SHIFT
)

	)

141 
	#OHCI_ED_S
 (1<<13)

	)

142 
	#OHCI_ED_K
 (1<<14)

	)

143 
	#OHCI_ED_F
 (1<<15)

	)

144 
	#OHCI_ED_MPS_SHIFT
 16

	)

145 
	#OHCI_ED_MPS_MASK
 (0x7ff<<
OHCI_ED_MPS_SHIFT
)

	)

148 
	#OHCI_ED_H
 1

	)

149 
	#OHCI_ED_C
 2

	)

152 
	#OHCI_TD_R
 (1<<18)

	)

153 
	#OHCI_TD_DP_SHIFT
 19

	)

154 
	#OHCI_TD_DP_MASK
 (3<<
OHCI_TD_DP_SHIFT
)

	)

155 
	#OHCI_TD_DI_SHIFT
 21

	)

156 
	#OHCI_TD_DI_MASK
 (7<<
OHCI_TD_DI_SHIFT
)

	)

157 
	#OHCI_TD_T0
 (1<<24)

	)

158 
	#OHCI_TD_T1
 (1<<25)

	)

159 
	#OHCI_TD_EC_SHIFT
 26

	)

160 
	#OHCI_TD_EC_MASK
 (3<<
OHCI_TD_EC_SHIFT
)

	)

161 
	#OHCI_TD_CC_SHIFT
 28

	)

162 
	#OHCI_TD_CC_MASK
 (0xf<<
OHCI_TD_CC_SHIFT
)

	)

166 
	#OHCI_TD_SF_SHIFT
 0

	)

167 
	#OHCI_TD_SF_MASK
 (0xffff<<
OHCI_TD_SF_SHIFT
)

	)

168 
	#OHCI_TD_FC_SHIFT
 24

	)

169 
	#OHCI_TD_FC_MASK
 (7<<
OHCI_TD_FC_SHIFT
)

	)

172 
	#OHCI_TD_PSW_CC_SHIFT
 12

	)

173 
	#OHCI_TD_PSW_CC_MASK
 (0xf<<
OHCI_TD_PSW_CC_SHIFT
)

	)

174 
	#OHCI_TD_PSW_SIZE_SHIFT
 0

	)

175 
	#OHCI_TD_PSW_SIZE_MASK
 (0xfff<<
OHCI_TD_PSW_SIZE_SHIFT
)

	)

177 
	#OHCI_PAGE_MASK
 0xfffff000

	)

178 
	#OHCI_OFFSET_MASK
 0xfff

	)

180 
	#OHCI_DPTR_MASK
 0xfffffff0

	)

182 
	#OHCI_BM
(
v®
, 
f›ld
) \

183 (((
v®
è& 
OHCI_
##
f›ld
##
_MASK
è>> OHCI_##f›ld##
_SHIFT
)

	)

185 
	#OHCI_SET_BM
(
v®
, 
f›ld
, 
Ãwv®
) do { \

186 
v®
 &ğ~
OHCI_
##
f›ld
##
_MASK
; \

187 
v®
 |ğ((
Ãwv®
è<< 
OHCI_
##
f›ld
##
_SHIFT
è& OHCI_##f›ld##
_MASK
; \

188 } 0)

	)

191 
	sohci_ed
 {

192 
ušt32_t
 
	mæags
;

193 
ušt32_t
 
	m
;

194 
ušt32_t
 
	mh—d
;

195 
ušt32_t
 
	mÃxt
;

199 
	sohci_td
 {

200 
ušt32_t
 
	mæags
;

201 
ušt32_t
 
	mcbp
;

202 
ušt32_t
 
	mÃxt
;

203 
ušt32_t
 
	mbe
;

207 
	sohci_iso_td
 {

208 
ušt32_t
 
	mæags
;

209 
ušt32_t
 
	mbp
;

210 
ušt32_t
 
	mÃxt
;

211 
ušt32_t
 
	mbe
;

212 
ušt16_t
 
	moff£t
[8];

215 
	#USB_HZ
 12000000

	)

218 
	#OHCI_CTL_CBSR
 ((1<<0)|(1<<1))

	)

219 
	#OHCI_CTL_PLE
 (1<<2)

	)

220 
	#OHCI_CTL_IE
 (1<<3)

	)

221 
	#OHCI_CTL_CLE
 (1<<4)

	)

222 
	#OHCI_CTL_BLE
 (1<<5)

	)

223 
	#OHCI_CTL_HCFS
 ((1<<6)|(1<<7))

	)

224 
	#OHCI_USB_RESET
 0x00

	)

225 
	#OHCI_USB_RESUME
 0x40

	)

226 
	#OHCI_USB_OPERATIONAL
 0x80

	)

227 
	#OHCI_USB_SUSPEND
 0xc0

	)

228 
	#OHCI_CTL_IR
 (1<<8)

	)

229 
	#OHCI_CTL_RWC
 (1<<9)

	)

230 
	#OHCI_CTL_RWE
 (1<<10)

	)

232 
	#OHCI_STATUS_HCR
 (1<<0)

	)

233 
	#OHCI_STATUS_CLF
 (1<<1)

	)

234 
	#OHCI_STATUS_BLF
 (1<<2)

	)

235 
	#OHCI_STATUS_OCR
 (1<<3)

	)

236 
	#OHCI_STATUS_SOC
 ((1<<6)|(1<<7))

	)

238 
	#OHCI_INTR_SO
 (1<<0è

	)

239 
	#OHCI_INTR_WD
 (1<<1è

	)

240 
	#OHCI_INTR_SF
 (1<<2è

	)

241 
	#OHCI_INTR_RD
 (1<<3è

	)

242 
	#OHCI_INTR_UE
 (1<<4è

	)

243 
	#OHCI_INTR_FNO
 (1<<5è

	)

244 
	#OHCI_INTR_RHSC
 (1<<6è

	)

245 
	#OHCI_INTR_OC
 (1<<30è

	)

246 
	#OHCI_INTR_MIE
 (1<<31è

	)

248 
	#OHCI_HCCA_SIZE
 0x100

	)

249 
	#OHCI_HCCA_MASK
 0xffffff00

	)

251 
	#OHCI_EDPTR_MASK
 0xfffffff0

	)

253 
	#OHCI_FMI_FI
 0x00003fff

	)

254 
	#OHCI_FMI_FSMPS
 0xffff0000

	)

255 
	#OHCI_FMI_FIT
 0x80000000

	)

257 
	#OHCI_FR_RT
 (1<<31)

	)

259 
	#OHCI_LS_THRESH
 0x628

	)

261 
	#OHCI_RHA_RW_MASK
 0x00000000

	)

262 
	#OHCI_RHA_PSM
 (1<<8)

	)

263 
	#OHCI_RHA_NPS
 (1<<9)

	)

264 
	#OHCI_RHA_DT
 (1<<10)

	)

265 
	#OHCI_RHA_OCPM
 (1<<11)

	)

266 
	#OHCI_RHA_NOCP
 (1<<12)

	)

267 
	#OHCI_RHA_POTPGT_MASK
 0xff000000

	)

269 
	#OHCI_RHS_LPS
 (1<<0)

	)

270 
	#OHCI_RHS_OCI
 (1<<1)

	)

271 
	#OHCI_RHS_DRWE
 (1<<15)

	)

272 
	#OHCI_RHS_LPSC
 (1<<16)

	)

273 
	#OHCI_RHS_OCIC
 (1<<17)

	)

274 
	#OHCI_RHS_CRWE
 (1<<31)

	)

276 
	#OHCI_PORT_CCS
 (1<<0)

	)

277 
	#OHCI_PORT_PES
 (1<<1)

	)

278 
	#OHCI_PORT_PSS
 (1<<2)

	)

279 
	#OHCI_PORT_POCI
 (1<<3)

	)

280 
	#OHCI_PORT_PRS
 (1<<4)

	)

281 
	#OHCI_PORT_PPS
 (1<<8)

	)

282 
	#OHCI_PORT_LSDA
 (1<<9)

	)

283 
	#OHCI_PORT_CSC
 (1<<16)

	)

284 
	#OHCI_PORT_PESC
 (1<<17)

	)

285 
	#OHCI_PORT_PSSC
 (1<<18)

	)

286 
	#OHCI_PORT_OCIC
 (1<<19)

	)

287 
	#OHCI_PORT_PRSC
 (1<<20)

	)

288 
	#OHCI_PORT_WTC
 (
OHCI_PORT_CSC
|
OHCI_PORT_PESC
|
OHCI_PORT_PSSC
 \

289 |
OHCI_PORT_OCIC
|
OHCI_PORT_PRSC
)

	)

291 
	#OHCI_TD_DIR_SETUP
 0x0

	)

292 
	#OHCI_TD_DIR_OUT
 0x1

	)

293 
	#OHCI_TD_DIR_IN
 0x2

	)

294 
	#OHCI_TD_DIR_RESERVED
 0x3

	)

296 
	#OHCI_CC_NOERROR
 0x0

	)

297 
	#OHCI_CC_CRC
 0x1

	)

298 
	#OHCI_CC_BITSTUFFING
 0x2

	)

299 
	#OHCI_CC_DATATOGGLEMISMATCH
 0x3

	)

300 
	#OHCI_CC_STALL
 0x4

	)

301 
	#OHCI_CC_DEVICENOTRESPONDING
 0x5

	)

302 
	#OHCI_CC_PIDCHECKFAILURE
 0x6

	)

303 
	#OHCI_CC_UNDEXPETEDPID
 0x7

	)

304 
	#OHCI_CC_DATAOVERRUN
 0x8

	)

305 
	#OHCI_CC_DATAUNDERRUN
 0x9

	)

306 
	#OHCI_CC_BUFFEROVERRUN
 0xc

	)

307 
	#OHCI_CC_BUFFERUNDERRUN
 0xd

	)

309 
	#OHCI_HRESET_FSBIR
 (1 << 0)

	)

312 
šlše
 
	$ohci_šŒ_upd©e
(
OHCIS‹
 *
ohci
)

314 
Ëv–
 = 0;

316 ià((
ohci
->
šŒ
 & 
OHCI_INTR_MIE
) &&

317 (
ohci
->
šŒ_¡©us
 & ohci->
šŒ
))

318 
Ëv–
 = 1;

320 
	`qemu_£t_œq
(
ohci
->
œq
, 
Ëv–
);

321 
	}
}

324 
šlše
 
	$ohci_£t_š‹¼u±
(
OHCIS‹
 *
ohci
, 
ušt32_t
 
šŒ
)

326 
ohci
->
šŒ_¡©us
 |ğ
šŒ
;

327 
	`ohci_šŒ_upd©e
(
ohci
);

328 
	}
}

331 
	$ohci_©ch
(
USBPÜt
 *
pÜt1
)

333 
OHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

334 
OHCIPÜt
 *
pÜt
 = &
s
->
rhpÜt
[
pÜt1
->
šdex
];

335 
ušt32_t
 
Şd_¡©e
 = 
pÜt
->
ù¾
;

338 
pÜt
->
ù¾
 |ğ
OHCI_PORT_CCS
 | 
OHCI_PORT_CSC
;

341 ià(
pÜt
->pÜt.
dev
->
¥“d
 =ğ
USB_SPEED_LOW
) {

342 
pÜt
->
ù¾
 |ğ
OHCI_PORT_LSDA
;

344 
pÜt
->
ù¾
 &ğ~
OHCI_PORT_LSDA
;

348 ià((
s
->
ùl
 & 
OHCI_CTL_HCFS
è=ğ
OHCI_USB_SUSPEND
) {

349 
	`ohci_£t_š‹¼u±
(
s
, 
OHCI_INTR_RD
);

352 
	`DPRINTF
("usb-ohci: A‰ached…Üˆ%d\n", 
pÜt1
->
šdex
);

354 ià(
Şd_¡©e
 !ğ
pÜt
->
ù¾
) {

355 
	`ohci_£t_š‹¼u±
(
s
, 
OHCI_INTR_RHSC
);

357 
	}
}

359 
	$ohci_d‘ach
(
USBPÜt
 *
pÜt1
)

361 
OHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

362 
OHCIPÜt
 *
pÜt
 = &
s
->
rhpÜt
[
pÜt1
->
šdex
];

363 
ušt32_t
 
Şd_¡©e
 = 
pÜt
->
ù¾
;

365 
	`ohci_async_ÿnûl_deviû
(
s
, 
pÜt1
->
dev
);

368 ià(
pÜt
->
ù¾
 & 
OHCI_PORT_CCS
) {

369 
pÜt
->
ù¾
 &ğ~
OHCI_PORT_CCS
;

370 
pÜt
->
ù¾
 |ğ
OHCI_PORT_CSC
;

373 ià(
pÜt
->
ù¾
 & 
OHCI_PORT_PES
) {

374 
pÜt
->
ù¾
 &ğ~
OHCI_PORT_PES
;

375 
pÜt
->
ù¾
 |ğ
OHCI_PORT_PESC
;

377 
	`DPRINTF
("usb-ohci: D‘ached…Üˆ%d\n", 
pÜt1
->
šdex
);

379 ià(
Şd_¡©e
 !ğ
pÜt
->
ù¾
) {

380 
	`ohci_£t_š‹¼u±
(
s
, 
OHCI_INTR_RHSC
);

382 
	}
}

384 
	$ohci_wakeup
(
USBPÜt
 *
pÜt1
)

386 
OHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

387 
OHCIPÜt
 *
pÜt
 = &
s
->
rhpÜt
[
pÜt1
->
šdex
];

388 
ušt32_t
 
šŒ
 = 0;

389 ià(
pÜt
->
ù¾
 & 
OHCI_PORT_PSS
) {

390 
	`DPRINTF
("usb-ohci:…Üˆ%d: wakeup\n", 
pÜt1
->
šdex
);

391 
pÜt
->
ù¾
 |ğ
OHCI_PORT_PSSC
;

392 
pÜt
->
ù¾
 &ğ~
OHCI_PORT_PSS
;

393 
šŒ
 = 
OHCI_INTR_RHSC
;

396 ià((
s
->
ùl
 & 
OHCI_CTL_HCFS
è=ğ
OHCI_USB_SUSPEND
) {

397 
	`DPRINTF
("usb-ohci:„emote-wakeup: SUSPEND->RESUME\n");

399 
s
->
ùl
 &ğ~
OHCI_CTL_HCFS
;

400 
s
->
ùl
 |ğ
OHCI_USB_RESUME
;

404 
šŒ
 = 
OHCI_INTR_RD
;

406 
	`ohci_£t_š‹¼u±
(
s
, 
šŒ
);

407 
	}
}

409 
	$ohci_chd_d‘ach
(
USBPÜt
 *
pÜt1
, 
USBDeviû
 *
chd
)

411 
OHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

413 
	`ohci_async_ÿnûl_deviû
(
s
, 
chd
);

414 
	}
}

416 
USBDeviû
 *
	$ohci_fšd_deviû
(
OHCIS‹
 *
ohci
, 
ušt8_t
 
addr
)

418 
USBDeviû
 *
dev
;

419 
i
;

421 
i
 = 0; i < 
ohci
->
num_pÜts
; i++) {

422 ià((
ohci
->
rhpÜt
[
i
].
ù¾
 & 
OHCI_PORT_PES
) == 0) {

425 
dev
 = 
	`usb_fšd_deviû
(&
ohci
->
rhpÜt
[
i
].
pÜt
, 
addr
);

426 ià(
dev
 !ğ
NULL
) {

427  
dev
;

430  
NULL
;

431 
	}
}

434 
	$ohci_»£t
(*
İaque
)

436 
OHCIS‹
 *
ohci
 = 
İaque
;

437 
OHCIPÜt
 *
pÜt
;

438 
i
;

440 
	`ohci_bus_¡İ
(
ohci
);

441 
ohci
->
ùl
 = 0;

442 
ohci
->
Şd_ùl
 = 0;

443 
ohci
->
¡©us
 = 0;

444 
ohci
->
šŒ_¡©us
 = 0;

445 
ohci
->
šŒ
 = 
OHCI_INTR_MIE
;

447 
ohci
->
hcÿ
 = 0;

448 
ohci
->
ù¾_h—d
 = ohci->
ù¾_cur
 = 0;

449 
ohci
->
bulk_h—d
 = ohci->
bulk_cur
 = 0;

450 
ohci
->
³r_cur
 = 0;

451 
ohci
->
dÚe
 = 0;

452 
ohci
->
dÚe_couÁ
 = 7;

457 
ohci
->
fsmps
 = 0x2778;

458 
ohci
->
fi
 = 0x2edf;

459 
ohci
->
f™
 = 0;

460 
ohci
->
ät
 = 0;

461 
ohci
->
äame_numb”
 = 0;

462 
ohci
->
p¡¬t
 = 0;

463 
ohci
->
l¡
 = 
OHCI_LS_THRESH
;

465 
ohci
->
rhdesc_a
 = 
OHCI_RHA_NPS
 | ohci->
num_pÜts
;

466 
ohci
->
rhdesc_b
 = 0x0;

467 
ohci
->
rh¡©us
 = 0;

469 
i
 = 0; i < 
ohci
->
num_pÜts
; i++)

471 
pÜt
 = &
ohci
->
rhpÜt
[
i
];

472 
pÜt
->
ù¾
 = 0;

473 ià(
pÜt
->pÜt.
dev
 &&…Üt->pÜt.dev->
©ched
) {

474 
	`usb_pÜt_»£t
(&
pÜt
->port);

477 ià(
ohci
->
async_td
) {

478 
	`usb_ÿnûl_·ck‘
(&
ohci
->
usb_·ck‘
);

479 
ohci
->
async_td
 = 0;

481 
	`DPRINTF
("usb-ohci: Re£ˆ%s\n", 
ohci
->
Çme
);

482 
	}
}

485 
šlše
 
	$g‘_dwÜds
(
OHCIS‹
 *
ohci
,

486 
dma_addr_t
 
addr
, 
ušt32_t
 *
buf
, 
num
)

488 
i
;

490 
addr
 +ğ
ohci
->
loÿlmem_ba£
;

492 
i
 = 0; i < 
num
; i++, 
buf
++, 
addr
 += (*buf)) {

493 
	`dma_memÜy_»ad
(
ohci
->
dma
, 
addr
, 
buf
, (*buf));

494 *
buf
 = 
	`Ë32_to_ıu
(*buf);

498 
	}
}

501 
šlše
 
	$put_dwÜds
(
OHCIS‹
 *
ohci
,

502 
dma_addr_t
 
addr
, 
ušt32_t
 *
buf
, 
num
)

504 
i
;

506 
addr
 +ğ
ohci
->
loÿlmem_ba£
;

508 
i
 = 0; i < 
num
; i++, 
buf
++, 
addr
 += (*buf)) {

509 
ušt32_t
 
tmp
 = 
	`ıu_to_Ë32
(*
buf
);

510 
	`dma_memÜy_wr™e
(
ohci
->
dma
, 
addr
, &
tmp
, (tmp));

514 
	}
}

517 
šlše
 
	$g‘_wÜds
(
OHCIS‹
 *
ohci
,

518 
dma_addr_t
 
addr
, 
ušt16_t
 *
buf
, 
num
)

520 
i
;

522 
addr
 +ğ
ohci
->
loÿlmem_ba£
;

524 
i
 = 0; i < 
num
; i++, 
buf
++, 
addr
 += (*buf)) {

525 
	`dma_memÜy_»ad
(
ohci
->
dma
, 
addr
, 
buf
, (*buf));

526 *
buf
 = 
	`Ë16_to_ıu
(*buf);

530 
	}
}

533 
šlše
 
	$put_wÜds
(
OHCIS‹
 *
ohci
,

534 
dma_addr_t
 
addr
, 
ušt16_t
 *
buf
, 
num
)

536 
i
;

538 
addr
 +ğ
ohci
->
loÿlmem_ba£
;

540 
i
 = 0; i < 
num
; i++, 
buf
++, 
addr
 += (*buf)) {

541 
ušt16_t
 
tmp
 = 
	`ıu_to_Ë16
(*
buf
);

542 
	`dma_memÜy_wr™e
(
ohci
->
dma
, 
addr
, &
tmp
, (tmp));

546 
	}
}

548 
šlše
 
	$ohci_»ad_ed
(
OHCIS‹
 *
ohci
,

549 
dma_addr_t
 
addr
, 
ohci_ed
 *
ed
)

551  
	`g‘_dwÜds
(
ohci
, 
addr
, (
ušt32_t
 *)
ed
, (*ed) >> 2);

552 
	}
}

554 
šlše
 
	$ohci_»ad_td
(
OHCIS‹
 *
ohci
,

555 
dma_addr_t
 
addr
, 
ohci_td
 *
td
)

557  
	`g‘_dwÜds
(
ohci
, 
addr
, (
ušt32_t
 *)
td
, (*td) >> 2);

558 
	}
}

560 
šlše
 
	$ohci_»ad_iso_td
(
OHCIS‹
 *
ohci
,

561 
dma_addr_t
 
addr
, 
ohci_iso_td
 *
td
)

563  (
	`g‘_dwÜds
(
ohci
, 
addr
, (
ušt32_t
 *)
td
, 4) &&

564 
	`g‘_wÜds
(
ohci
, 
addr
 + 16, 
td
->
off£t
, 8));

565 
	}
}

567 
šlše
 
	$ohci_»ad_hcÿ
(
OHCIS‹
 *
ohci
,

568 
dma_addr_t
 
addr
, 
ohci_hcÿ
 *
hcÿ
)

570 
	`dma_memÜy_»ad
(
ohci
->
dma
, 
addr
 + ohci->
loÿlmem_ba£
, 
hcÿ
, (*hcca));

572 
	}
}

574 
šlše
 
	$ohci_put_ed
(
OHCIS‹
 *
ohci
,

575 
dma_addr_t
 
addr
, 
ohci_ed
 *
ed
)

581  
	`put_dwÜds
(
ohci
, 
addr
 + 
ED_WBACK_OFFSET
,

582 (
ušt32_t
 *)((*)
ed
 + 
ED_WBACK_OFFSET
),

583 
ED_WBACK_SIZE
 >> 2);

584 
	}
}

586 
šlše
 
	$ohci_put_td
(
OHCIS‹
 *
ohci
,

587 
dma_addr_t
 
addr
, 
ohci_td
 *
td
)

589  
	`put_dwÜds
(
ohci
, 
addr
, (
ušt32_t
 *)
td
, (*td) >> 2);

590 
	}
}

592 
šlše
 
	$ohci_put_iso_td
(
OHCIS‹
 *
ohci
,

593 
dma_addr_t
 
addr
, 
ohci_iso_td
 *
td
)

595  (
	`put_dwÜds
(
ohci
, 
addr
, (
ušt32_t
 *)
td
, 4) &&

596 
	`put_wÜds
(
ohci
, 
addr
 + 16, 
td
->
off£t
, 8));

597 
	}
}

599 
šlše
 
	$ohci_put_hcÿ
(
OHCIS‹
 *
ohci
,

600 
dma_addr_t
 
addr
, 
ohci_hcÿ
 *
hcÿ
)

602 
	`dma_memÜy_wr™e
(
ohci
->
dma
,

603 
addr
 + 
ohci
->
loÿlmem_ba£
 + 
HCCA_WRITEBACK_OFFSET
,

604 (*)
hcÿ
 + 
HCCA_WRITEBACK_OFFSET
,

605 
HCCA_WRITEBACK_SIZE
);

607 
	}
}

610 
	$ohci_cİy_td
(
OHCIS‹
 *
ohci
, 
ohci_td
 *
td
,

611 
ušt8_t
 *
buf
, 
Ën
, 
DMADœeùiÚ
 
dœ
)

613 
dma_addr_t
 
±r
, 
n
;

615 
±r
 = 
td
->
cbp
;

616 
n
 = 0x1000 - (
±r
 & 0xfff);

617 ià(
n
 > 
Ën
)

618 
n
 = 
Ën
;

619 
	`dma_memÜy_rw
(
ohci
->
dma
, 
±r
 + ohci->
loÿlmem_ba£
, 
buf
, 
n
, 
dœ
);

620 ià(
n
 =ğ
Ën
)

622 
±r
 = 
td
->
be
 & ~0xfffu;

623 
buf
 +ğ
n
;

624 
	`dma_memÜy_rw
(
ohci
->
dma
, 
±r
 + ohci->
loÿlmem_ba£
, 
buf
, 
Ën
 - 
n
, 
dœ
);

625 
	}
}

628 
	$ohci_cİy_iso_td
(
OHCIS‹
 *
ohci
,

629 
ušt32_t
 
¡¬t_addr
, ušt32_ˆ
’d_addr
,

630 
ušt8_t
 *
buf
, 
Ën
, 
DMADœeùiÚ
 
dœ
)

632 
dma_addr_t
 
±r
, 
n
;

634 
±r
 = 
¡¬t_addr
;

635 
n
 = 0x1000 - (
±r
 & 0xfff);

636 ià(
n
 > 
Ën
)

637 
n
 = 
Ën
;

638 
	`dma_memÜy_rw
(
ohci
->
dma
, 
±r
 + ohci->
loÿlmem_ba£
, 
buf
, 
n
, 
dœ
);

639 ià(
n
 =ğ
Ën
)

641 
±r
 = 
’d_addr
 & ~0xfffu;

642 
buf
 +ğ
n
;

643 
	`dma_memÜy_rw
(
ohci
->
dma
, 
±r
 + ohci->
loÿlmem_ba£
, 
buf
, 
Ën
 - 
n
, 
dœ
);

644 
	}
}

646 
ohci_´oûss_li¡s
(
OHCIS‹
 *
ohci
, 
com¶‘iÚ
);

648 
	$ohci_async_com¶‘e_·ck‘
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
·ck‘
)

650 
OHCIS‹
 *
ohci
 = 
	`cÚš”_of
(
·ck‘
, OHCIS‹, 
usb_·ck‘
);

651 #ifdeà
DEBUG_PACKET


652 
	`DPRINTF
("Async…acket complete\n");

654 
ohci
->
async_com¶‘e
 = 1;

655 
	`ohci_´oûss_li¡s
(
ohci
, 1);

656 
	}
}

658 
	#USUB
(
a
, 
b
è((
št16_t
)((
ušt16_t
)×è- (ušt16_t)(b)))

	)

660 
	$ohci_£rviû_iso_td
(
OHCIS‹
 *
ohci
, 
ohci_ed
 *
ed
,

661 
com¶‘iÚ
)

663 
dœ
;

664 
size_t
 
Ën
 = 0;

665 #ifdeà
DEBUG_ISOCH


666 cÚ¡ *
¡r
 = 
NULL
;

668 
pid
;

669 
»t
;

670 
i
;

671 
USBDeviû
 *
dev
;

672 
USBEndpošt
 *
•
;

673 
ohci_iso_td
 
iso_td
;

674 
ušt32_t
 
addr
;

675 
ušt16_t
 
¡¬tšg_äame
;

676 
št16_t
 
»Ïtive_äame_numb”
;

677 
äame_couÁ
;

678 
ušt32_t
 
¡¬t_off£t
, 
Ãxt_off£t
, 
’d_off£t
 = 0;

679 
ušt32_t
 
¡¬t_addr
, 
’d_addr
;

681 
addr
 = 
ed
->
h—d
 & 
OHCI_DPTR_MASK
;

683 ià(!
	`ohci_»ad_iso_td
(
ohci
, 
addr
, &
iso_td
)) {

684 
	`´štf
("usb-ohci: ISO_TD„—dƒ¼Ü‡ˆ%x\n", 
addr
);

688 
¡¬tšg_äame
 = 
	`OHCI_BM
(
iso_td
.
æags
, 
TD_SF
);

689 
äame_couÁ
 = 
	`OHCI_BM
(
iso_td
.
æags
, 
TD_FC
);

690 
»Ïtive_äame_numb”
 = 
	`USUB
(
ohci
->
äame_numb”
, 
¡¬tšg_äame
);

692 #ifdeà
DEBUG_ISOCH


693 
	`´štf
("--- ISO_TD ED head 0x%.8xailp 0x%.8x\n"

700 
ed
->
h—d
 & 
OHCI_DPTR_MASK
,ƒd->

 & OHCI_DPTR_MASK,

701 
iso_td
.
æags
, iso_td.
bp
, iso_td.
Ãxt
, iso_td.
be
,

702 
iso_td
.
off£t
[0], iso_td.offset[1], iso_td.offset[2], iso_td.offset[3],

703 
iso_td
.
off£t
[4], iso_td.offset[5], iso_td.offset[6], iso_td.offset[7],

704 
ohci
->
äame_numb”
, 
¡¬tšg_äame
,

705 
äame_couÁ
, 
»Ïtive_äame_numb”
,

706 
	`OHCI_BM
(
iso_td
.
æags
, 
TD_DI
), OHCI_BM(iso_td.æags, 
TD_CC
));

709 ià(
»Ïtive_äame_numb”
 < 0) {

710 
	`DPRINTF
("usb-ohci: ISO_TD R=%d < 0\n", 
»Ïtive_äame_numb”
);

712 } ià(
»Ïtive_äame_numb”
 > 
äame_couÁ
) {

715 
	`DPRINTF
("usb-ohci: ISO_TD R=%d > FC=%d\n", 
»Ïtive_äame_numb”
,

716 
äame_couÁ
);

717 
	`OHCI_SET_BM
(
iso_td
.
æags
, 
TD_CC
, 
OHCI_CC_DATAOVERRUN
);

718 
ed
->
h—d
 &ğ~
OHCI_DPTR_MASK
;

719 
ed
->
h—d
 |ğ(
iso_td
.
Ãxt
 & 
OHCI_DPTR_MASK
);

720 
iso_td
.
Ãxt
 = 
ohci
->
dÚe
;

721 
ohci
->
dÚe
 = 
addr
;

722 
i
 = 
	`OHCI_BM
(
iso_td
.
æags
, 
TD_DI
);

723 ià(
i
 < 
ohci
->
dÚe_couÁ
)

724 
ohci
->
dÚe_couÁ
 = 
i
;

725 
	`ohci_put_iso_td
(
ohci
, 
addr
, &
iso_td
);

729 
dœ
 = 
	`OHCI_BM
(
ed
->
æags
, 
ED_D
);

730 
dœ
) {

731 
OHCI_TD_DIR_IN
:

732 #ifdeà
DEBUG_ISOCH


733 
¡r
 = "in";

735 
pid
 = 
USB_TOKEN_IN
;

737 
OHCI_TD_DIR_OUT
:

738 #ifdeà
DEBUG_ISOCH


739 
¡r
 = "out";

741 
pid
 = 
USB_TOKEN_OUT
;

743 
OHCI_TD_DIR_SETUP
:

744 #ifdeà
DEBUG_ISOCH


745 
¡r
 = "setup";

747 
pid
 = 
USB_TOKEN_SETUP
;

750 
	`´štf
("usb-ohci: Bad dœeùiÚ %d\n", 
dœ
);

754 ià(!
iso_td
.
bp
 || !iso_td.
be
) {

755 
	`´štf
("usb-ohci: ISO_TD b°0x%.8x b0x%.8x\n", 
iso_td
.
bp
, iso_td.
be
);

759 
¡¬t_off£t
 = 
iso_td
.
off£t
[
»Ïtive_äame_numb”
];

760 
Ãxt_off£t
 = 
iso_td
.
off£t
[
»Ïtive_äame_numb”
 + 1];

762 ià(!(
	`OHCI_BM
(
¡¬t_off£t
, 
TD_PSW_CC
) & 0xe) ||

763 ((
»Ïtive_äame_numb”
 < 
äame_couÁ
) &&

764 !(
	`OHCI_BM
(
Ãxt_off£t
, 
TD_PSW_CC
) & 0xe))) {

765 
	`´štf
("usb-ohci: ISO_TD cc !=‚ot‡ccessed 0x%.8x 0x%.8x\n",

766 
¡¬t_off£t
, 
Ãxt_off£t
);

770 ià((
»Ïtive_äame_numb”
 < 
äame_couÁ
è&& (
¡¬t_off£t
 > 
Ãxt_off£t
)) {

771 
	`´štf
("usb-ohci: ISO_TD start_offset=0x%.8x >‚ext_offset=0x%.8x\n",

772 
¡¬t_off£t
, 
Ãxt_off£t
);

776 ià((
¡¬t_off£t
 & 0x1000) == 0) {

777 
¡¬t_addr
 = (
iso_td
.
bp
 & 
OHCI_PAGE_MASK
) |

778 (
¡¬t_off£t
 & 
OHCI_OFFSET_MASK
);

780 
¡¬t_addr
 = (
iso_td
.
be
 & 
OHCI_PAGE_MASK
) |

781 (
¡¬t_off£t
 & 
OHCI_OFFSET_MASK
);

784 ià(
»Ïtive_äame_numb”
 < 
äame_couÁ
) {

785 
’d_off£t
 = 
Ãxt_off£t
 - 1;

786 ià((
’d_off£t
 & 0x1000) == 0) {

787 
’d_addr
 = (
iso_td
.
bp
 & 
OHCI_PAGE_MASK
) |

788 (
’d_off£t
 & 
OHCI_OFFSET_MASK
);

790 
’d_addr
 = (
iso_td
.
be
 & 
OHCI_PAGE_MASK
) |

791 (
’d_off£t
 & 
OHCI_OFFSET_MASK
);

795 
’d_addr
 = 
iso_td
.
be
;

798 ià((
¡¬t_addr
 & 
OHCI_PAGE_MASK
è!ğ(
’d_addr
 & OHCI_PAGE_MASK)) {

799 
Ën
 = (
’d_addr
 & 
OHCI_OFFSET_MASK
) + 0x1001

800 - (
¡¬t_addr
 & 
OHCI_OFFSET_MASK
);

802 
Ën
 = 
’d_addr
 - 
¡¬t_addr
 + 1;

805 ià(
Ën
 && 
dœ
 !ğ
OHCI_TD_DIR_IN
) {

806 
	`ohci_cİy_iso_td
(
ohci
, 
¡¬t_addr
, 
’d_addr
, ohci->
usb_buf
, 
Ën
,

807 
DMA_DIRECTION_TO_DEVICE
);

810 ià(
com¶‘iÚ
) {

811 
»t
 = 
ohci
->
usb_·ck‘
.
»suÉ
;

813 
dev
 = 
	`ohci_fšd_deviû
(
ohci
, 
	`OHCI_BM
(
ed
->
æags
, 
ED_FA
));

814 
•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
	`OHCI_BM
(
ed
->
æags
, 
ED_EN
));

815 
	`usb_·ck‘_£tup
(&
ohci
->
usb_·ck‘
, 
pid
, 
•
, 
addr
);

816 
	`usb_·ck‘_addbuf
(&
ohci
->
usb_·ck‘
, ohci->
usb_buf
, 
Ën
);

817 
»t
 = 
	`usb_hªdË_·ck‘
(
dev
, &
ohci
->
usb_·ck‘
);

818 ià(
»t
 =ğ
USB_RET_ASYNC
) {

823 #ifdeà
DEBUG_ISOCH


824 
	`´štf
("so 0x%.8xƒo 0x%.8x\nsa 0x%.8xƒa 0x%.8x\ndir %s†en %zu„et %d\n",

825 
¡¬t_off£t
, 
’d_off£t
, 
¡¬t_addr
, 
’d_addr
, 
¡r
, 
Ën
, 
»t
);

829 ià(
dœ
 =ğ
OHCI_TD_DIR_IN
 && 
»t
 >ğ0 &&„‘ <ğ
Ën
) {

831 
	`ohci_cİy_iso_td
(
ohci
, 
¡¬t_addr
, 
’d_addr
, ohci->
usb_buf
, 
»t
,

832 
DMA_DIRECTION_FROM_DEVICE
);

833 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_CC
,

834 
OHCI_CC_NOERROR
);

835 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_SIZE
, 
»t
);

836 } ià(
dœ
 =ğ
OHCI_TD_DIR_OUT
 && 
»t
 =ğ
Ën
) {

838 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_CC
,

839 
OHCI_CC_NOERROR
);

840 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_SIZE
, 0);

842 ià(
»t
 > (
ssize_t
è
Ën
) {

843 
	`´štf
("usb-ohci: D©aOv”ruÀ%d > %zu\n", 
»t
, 
Ën
);

844 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_CC
,

845 
OHCI_CC_DATAOVERRUN
);

846 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_SIZE
,

847 
Ën
);

848 } ià(
»t
 >= 0) {

849 
	`´štf
("usb-ohci: D©aUnd”ruÀ%d\n", 
»t
);

850 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_CC
,

851 
OHCI_CC_DATAUNDERRUN
);

853 
»t
) {

854 
USB_RET_IOERROR
:

855 
USB_RET_NODEV
:

856 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_CC
,

857 
OHCI_CC_DEVICENOTRESPONDING
);

858 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_SIZE
,

861 
USB_RET_NAK
:

862 
USB_RET_STALL
:

863 
	`´štf
("usb-ohci: gÙ NAK/STALL %d\n", 
»t
);

864 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_CC
,

865 
OHCI_CC_STALL
);

866 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_SIZE
,

870 
	`´štf
("usb-ohci: Bad deviû„e¥Ú£ %d\n", 
»t
);

871 
	`OHCI_SET_BM
(
iso_td
.
off£t
[
»Ïtive_äame_numb”
], 
TD_PSW_CC
,

872 
OHCI_CC_UNDEXPETEDPID
);

878 ià(
»Ïtive_äame_numb”
 =ğ
äame_couÁ
) {

880 
	`OHCI_SET_BM
(
iso_td
.
æags
, 
TD_CC
, 
OHCI_CC_NOERROR
);

881 
ed
->
h—d
 &ğ~
OHCI_DPTR_MASK
;

882 
ed
->
h—d
 |ğ(
iso_td
.
Ãxt
 & 
OHCI_DPTR_MASK
);

883 
iso_td
.
Ãxt
 = 
ohci
->
dÚe
;

884 
ohci
->
dÚe
 = 
addr
;

885 
i
 = 
	`OHCI_BM
(
iso_td
.
æags
, 
TD_DI
);

886 ià(
i
 < 
ohci
->
dÚe_couÁ
)

887 
ohci
->
dÚe_couÁ
 = 
i
;

889 
	`ohci_put_iso_td
(
ohci
, 
addr
, &
iso_td
);

891 
	}
}

896 
	$ohci_£rviû_td
(
OHCIS‹
 *
ohci
, 
ohci_ed
 *
ed
)

898 
dœ
;

899 
size_t
 
Ën
 = 0, 
pk’
 = 0;

900 #ifdeà
DEBUG_PACKET


901 cÚ¡ *
¡r
 = 
NULL
;

903 
pid
;

904 
»t
;

905 
i
;

906 
USBDeviû
 *
dev
;

907 
USBEndpošt
 *
•
;

908 
ohci_td
 
td
;

909 
ušt32_t
 
addr
;

910 
æag_r
;

911 
com¶‘iÚ
;

913 
addr
 = 
ed
->
h—d
 & 
OHCI_DPTR_MASK
;

915 
com¶‘iÚ
 = (
addr
 =ğ
ohci
->
async_td
);

916 ià(
com¶‘iÚ
 && !
ohci
->
async_com¶‘e
) {

917 #ifdeà
DEBUG_PACKET


918 
	`DPRINTF
("Skipping‡sync TD\n");

922 ià(!
	`ohci_»ad_td
(
ohci
, 
addr
, &
td
)) {

923 
	`årštf
(
¡d”r
, "usb-ohci: TD„—dƒ¼Ü‡ˆ%x\n", 
addr
);

927 
dœ
 = 
	`OHCI_BM
(
ed
->
æags
, 
ED_D
);

928 
dœ
) {

929 
OHCI_TD_DIR_OUT
:

930 
OHCI_TD_DIR_IN
:

934 
dœ
 = 
	`OHCI_BM
(
td
.
æags
, 
TD_DP
);

938 
dœ
) {

939 
OHCI_TD_DIR_IN
:

940 #ifdeà
DEBUG_PACKET


941 
¡r
 = "in";

943 
pid
 = 
USB_TOKEN_IN
;

945 
OHCI_TD_DIR_OUT
:

946 #ifdeà
DEBUG_PACKET


947 
¡r
 = "out";

949 
pid
 = 
USB_TOKEN_OUT
;

951 
OHCI_TD_DIR_SETUP
:

952 #ifdeà
DEBUG_PACKET


953 
¡r
 = "setup";

955 
pid
 = 
USB_TOKEN_SETUP
;

958 
	`årštf
(
¡d”r
, "usb-ohci: Bad direction\n");

961 ià(
td
.
cbp
 &&d.
be
) {

962 ià((
td
.
cbp
 & 0xfffff000è!ğÑd.
be
 & 0xfffff000)) {

963 
Ën
 = (
td
.
be
 & 0xfffè+ 0x1001 - (td.
cbp
 & 0xfff);

965 
Ën
 = (
td
.
be
 -d.
cbp
) + 1;

968 
pk’
 = 
Ën
;

969 ià(
Ën
 && 
dœ
 !ğ
OHCI_TD_DIR_IN
) {

971 
pk’
 = (
ed
->
æags
 & 
OHCI_ED_MPS_MASK
è>> 
OHCI_ED_MPS_SHIFT
;

972 ià(
pk’
 > 
Ën
) {

973 
pk’
 = 
Ën
;

975 ià(!
com¶‘iÚ
) {

976 
	`ohci_cİy_td
(
ohci
, &
td
, ohci->
usb_buf
, 
pk’
,

977 
DMA_DIRECTION_TO_DEVICE
);

982 
æag_r
 = (
td
.
æags
 & 
OHCI_TD_R
) != 0;

983 #ifdeà
DEBUG_PACKET


984 
	`DPRINTF
(" TD @ 0x%.8x %" 
PRId64
 " of %" PRId64

986 
addr
, (
št64_t
)
pk’
, (št64_t)
Ën
, 
¡r
, 
æag_r
, 
td
.
cbp
,d.
be
);

988 ià(
pk’
 > 0 && 
dœ
 !ğ
OHCI_TD_DIR_IN
) {

989 
	`DPRINTF
(" data:");

990 
i
 = 0; i < 
pk’
; i++) {

991 
	`´štf
(" %.2x", 
ohci
->
usb_buf
[
i
]);

993 
	`DPRINTF
("\n");

996 ià(
com¶‘iÚ
) {

997 
»t
 = 
ohci
->
usb_·ck‘
.
»suÉ
;

998 
ohci
->
async_td
 = 0;

999 
ohci
->
async_com¶‘e
 = 0;

1001 ià(
ohci
->
async_td
) {

1007 #ifdeà
DEBUG_PACKET


1008 
	`DPRINTF
("Too many…ending…ackets\n");

1012 
dev
 = 
	`ohci_fšd_deviû
(
ohci
, 
	`OHCI_BM
(
ed
->
æags
, 
ED_FA
));

1013 
•
 = 
	`usb_•_g‘
(
dev
, 
pid
, 
	`OHCI_BM
(
ed
->
æags
, 
ED_EN
));

1014 
	`usb_·ck‘_£tup
(&
ohci
->
usb_·ck‘
, 
pid
, 
•
, 
addr
);

1015 
	`usb_·ck‘_addbuf
(&
ohci
->
usb_·ck‘
, ohci->
usb_buf
, 
pk’
);

1016 
»t
 = 
	`usb_hªdË_·ck‘
(
dev
, &
ohci
->
usb_·ck‘
);

1017 #ifdeà
DEBUG_PACKET


1018 
	`DPRINTF
("»t=%d\n", 
»t
);

1020 ià(
»t
 =ğ
USB_RET_ASYNC
) {

1021 
ohci
->
async_td
 = 
addr
;

1025 ià(
»t
 >= 0) {

1026 ià(
dœ
 =ğ
OHCI_TD_DIR_IN
) {

1027 
	`ohci_cİy_td
(
ohci
, &
td
, ohci->
usb_buf
, 
»t
,

1028 
DMA_DIRECTION_FROM_DEVICE
);

1029 #ifdeà
DEBUG_PACKET


1030 
	`DPRINTF
(" data:");

1031 
i
 = 0; i < 
»t
; i++)

1032 
	`´štf
(" %.2x", 
ohci
->
usb_buf
[
i
]);

1033 
	`DPRINTF
("\n");

1036 
»t
 = 
pk’
;

1041 ià(
»t
 =ğ
pk’
 || (
dœ
 =ğ
OHCI_TD_DIR_IN
 &&„‘ >ğ0 && 
æag_r
)) {

1043 ià(
»t
 =ğ
Ën
) {

1044 
td
.
cbp
 = 0;

1046 ià((
td
.
cbp
 & 0xfffè+ 
»t
 > 0xfff) {

1047 
td
.
cbp
 = (td.
be
 & ~0xfffè+ (Ñd.cb°+ 
»t
) & 0xfff);

1049 
td
.
cbp
 +ğ
»t
;

1052 
td
.
æags
 |ğ
OHCI_TD_T1
;

1053 
td
.
æags
 ^ğ
OHCI_TD_T0
;

1054 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_CC
, 
OHCI_CC_NOERROR
);

1055 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_EC
, 0);

1057 ià((
dœ
 !ğ
OHCI_TD_DIR_IN
è&& (
»t
 !ğ
Ën
)) {

1059 
ex™_no_»tœe
;

1063 
ed
->
h—d
 &ğ~
OHCI_ED_C
;

1064 ià(
td
.
æags
 & 
OHCI_TD_T0
)

1065 
ed
->
h—d
 |ğ
OHCI_ED_C
;

1067 ià(
»t
 >= 0) {

1068 
	`DPRINTF
("usb-ohci: Underrun\n");

1069 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_CC
, 
OHCI_CC_DATAUNDERRUN
);

1071 
»t
) {

1072 
USB_RET_IOERROR
:

1073 
USB_RET_NODEV
:

1074 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_CC
, 
OHCI_CC_DEVICENOTRESPONDING
);

1075 
USB_RET_NAK
:

1076 
	`DPRINTF
("usb-ohci: got NAK\n");

1078 
USB_RET_STALL
:

1079 
	`DPRINTF
("usb-ohci: got STALL\n");

1080 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_CC
, 
OHCI_CC_STALL
);

1082 
USB_RET_BABBLE
:

1083 
	`DPRINTF
("usb-ohci: got BABBLE\n");

1084 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_CC
, 
OHCI_CC_DATAOVERRUN
);

1087 
	`årštf
(
¡d”r
, "usb-ohci: Bad deviû„e¥Ú£ %d\n", 
»t
);

1088 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_CC
, 
OHCI_CC_UNDEXPETEDPID
);

1089 
	`OHCI_SET_BM
(
td
.
æags
, 
TD_EC
, 3);

1093 
ed
->
h—d
 |ğ
OHCI_ED_H
;

1097 
ed
->
h—d
 &ğ~
OHCI_DPTR_MASK
;

1098 
ed
->
h—d
 |ğ
td
.
Ãxt
 & 
OHCI_DPTR_MASK
;

1099 
td
.
Ãxt
 = 
ohci
->
dÚe
;

1100 
ohci
->
dÚe
 = 
addr
;

1101 
i
 = 
	`OHCI_BM
(
td
.
æags
, 
TD_DI
);

1102 ià(
i
 < 
ohci
->
dÚe_couÁ
)

1103 
ohci
->
dÚe_couÁ
 = 
i
;

1104 
ex™_no_»tœe
:

1105 
	`ohci_put_td
(
ohci
, 
addr
, &
td
);

1106  
	`OHCI_BM
(
td
.
æags
, 
TD_CC
è!ğ
OHCI_CC_NOERROR
;

1107 
	}
}

1110 
	$ohci_£rviû_ed_li¡
(
OHCIS‹
 *
ohci
, 
ušt32_t
 
h—d
, 
com¶‘iÚ
)

1112 
ohci_ed
 
ed
;

1113 
ušt32_t
 
Ãxt_ed
;

1114 
ušt32_t
 
cur
;

1115 
aùive
;

1117 
aùive
 = 0;

1119 ià(
h—d
 == 0)

1122 
cur
 = 
h—d
; cur; cu¸ğ
Ãxt_ed
) {

1123 ià(!
	`ohci_»ad_ed
(
ohci
, 
cur
, &
ed
)) {

1124 
	`årštf
(
¡d”r
, "usb-ohci: ED„—dƒ¼Ü‡ˆ%x\n", 
cur
);

1128 
Ãxt_ed
 = 
ed
.
Ãxt
 & 
OHCI_DPTR_MASK
;

1130 ià((
ed
.
h—d
 & 
OHCI_ED_H
è|| (ed.
æags
 & 
OHCI_ED_K
)) {

1131 
ušt32_t
 
addr
;

1133 
addr
 = 
ed
.
h—d
 & 
OHCI_DPTR_MASK
;

1134 ià(
ohci
->
async_td
 && 
addr
 == ohci->async_td) {

1135 
	`usb_ÿnûl_·ck‘
(&
ohci
->
usb_·ck‘
);

1136 
ohci
->
async_td
 = 0;

1141 (
ed
.
h—d
 & 
OHCI_DPTR_MASK
è!ğed.

) {

1142 #ifdeà
DEBUG_PACKET


1143 
	`DPRINTF
("ED @ 0x%.8x fa=%uƒn=%u d=%u s=%u k=%u f=%u mps=%u "

1144 "h=%u c=%u\À h—d=0x%.8xap=0x%.8x‚ext=0x%.8x\n", 
cur
,

1145 
	`OHCI_BM
(
ed
.
æags
, 
ED_FA
), OHCI_BMÓd.æags, 
ED_EN
),

1146 
	`OHCI_BM
(
ed
.
æags
, 
ED_D
), (ed.æag & 
OHCI_ED_S
)!= 0,

1147 (
ed
.
æags
 & 
OHCI_ED_K
è!ğ0, (ed.æag & 
OHCI_ED_F
) != 0,

1148 
	`OHCI_BM
(
ed
.
æags
, 
ED_MPS
), (ed.
h—d
 & 
OHCI_ED_H
) != 0,

1149 (
ed
.
h—d
 & 
OHCI_ED_C
è!ğ0,ƒd.h—d & 
OHCI_DPTR_MASK
,

1150 
ed
.

 & 
OHCI_DPTR_MASK
,ƒd.
Ãxt
 & OHCI_DPTR_MASK);

1152 
aùive
 = 1;

1154 ià((
ed
.
æags
 & 
OHCI_ED_F
) == 0) {

1155 ià(
	`ohci_£rviû_td
(
ohci
, &
ed
))

1159 ià(
	`ohci_£rviû_iso_td
(
ohci
, &
ed
, 
com¶‘iÚ
))

1164 
	`ohci_put_ed
(
ohci
, 
cur
, &
ed
);

1167  
aùive
;

1168 
	}
}

1171 
	$ohci_sof
(
OHCIS‹
 *
ohci
)

1173 
ohci
->
sof_time
 = 
	`qemu_g‘_şock_ns
(
vm_şock
);

1174 
	`qemu_mod_tim”
(
ohci
->
eof_tim”
, ohci->
sof_time
 + 
usb_äame_time
);

1175 
	`ohci_£t_š‹¼u±
(
ohci
, 
OHCI_INTR_SF
);

1176 
	}
}

1179 
	$ohci_´oûss_li¡s
(
OHCIS‹
 *
ohci
, 
com¶‘iÚ
)

1181 ià((
ohci
->
ùl
 & 
OHCI_CTL_CLE
è&& (ohci->
¡©us
 & 
OHCI_STATUS_CLF
)) {

1182 ià(
ohci
->
ù¾_cur
 && ohci->ù¾_cu¸!ğohci->
ù¾_h—d
) {

1183 
	`DPRINTF
("usb-ohci: head %x, cur %x\n",

1184 
ohci
->
ù¾_h—d
, ohci->
ù¾_cur
);

1186 ià(!
	`ohci_£rviû_ed_li¡
(
ohci
, ohci->
ù¾_h—d
, 
com¶‘iÚ
)) {

1187 
ohci
->
ù¾_cur
 = 0;

1188 
ohci
->
¡©us
 &ğ~
OHCI_STATUS_CLF
;

1192 ià((
ohci
->
ùl
 & 
OHCI_CTL_BLE
è&& (ohci->
¡©us
 & 
OHCI_STATUS_BLF
)) {

1193 ià(!
	`ohci_£rviû_ed_li¡
(
ohci
, ohci->
bulk_h—d
, 
com¶‘iÚ
)) {

1194 
ohci
->
bulk_cur
 = 0;

1195 
ohci
->
¡©us
 &ğ~
OHCI_STATUS_BLF
;

1198 
	}
}

1201 
	$ohci_äame_bound¬y
(*
İaque
)

1203 
OHCIS‹
 *
ohci
 = 
İaque
;

1204 
ohci_hcÿ
 
hcÿ
;

1206 
	`ohci_»ad_hcÿ
(
ohci
, ohci->
hcÿ
, &hcca);

1209 ià(
ohci
->
ùl
 & 
OHCI_CTL_PLE
) {

1210 
n
;

1212 
n
 = 
ohci
->
äame_numb”
 & 0x1f;

1213 
	`ohci_£rviû_ed_li¡
(
ohci
, 
	`Ë32_to_ıu
(
hcÿ
.
šŒ
[
n
]), 0);

1217 ià(
ohci
->
async_td
 &&

1218 
ohci
->
Şd_ùl
 & (~ohci->
ùl
è& (
OHCI_CTL_BLE
 | 
OHCI_CTL_CLE
)) {

1219 
	`usb_ÿnûl_·ck‘
(&
ohci
->
usb_·ck‘
);

1220 
ohci
->
async_td
 = 0;

1222 
ohci
->
Şd_ùl
 = ohci->
ùl
;

1223 
	`ohci_´oûss_li¡s
(
ohci
, 0);

1226 
ohci
->
ät
 = ohci->
f™
;

1229 
ohci
->
äame_numb”
 = (ohci->frame_number + 1) & 0xffff;

1230 
hcÿ
.
äame
 = 
	`ıu_to_Ë16
(
ohci
->
äame_numb”
);

1232 ià(
ohci
->
dÚe_couÁ
 =ğ0 && !(ohci->
šŒ_¡©us
 & 
OHCI_INTR_WD
)) {

1233 ià(!
ohci
->
dÚe
)

1234 
	`abÜt
();

1235 ià(
ohci
->
šŒ
 & ohci->
šŒ_¡©us
)

1236 
ohci
->
dÚe
 |= 1;

1237 
hcÿ
.
dÚe
 = 
	`ıu_to_Ë32
(
ohci
->done);

1238 
ohci
->
dÚe
 = 0;

1239 
ohci
->
dÚe_couÁ
 = 7;

1240 
	`ohci_£t_š‹¼u±
(
ohci
, 
OHCI_INTR_WD
);

1243 ià(
ohci
->
dÚe_couÁ
 != 7 && ohci->done_count != 0)

1244 
ohci
->
dÚe_couÁ
--;

1247 
	`ohci_sof
(
ohci
);

1250 
	`ohci_put_hcÿ
(
ohci
, ohci->
hcÿ
, &hcca);

1251 
	}
}

1256 
	$ohci_bus_¡¬t
(
OHCIS‹
 *
ohci
)

1258 
ohci
->
eof_tim”
 = 
	`qemu_Ãw_tim”_ns
(
vm_şock
,

1259 
ohci_äame_bound¬y
,

1260 
ohci
);

1262 ià(
ohci
->
eof_tim”
 =ğ
NULL
) {

1263 
	`årštf
(
¡d”r
, "usb-ohci: %s: qemu_Ãw_tim”_n çed\n", 
ohci
->
Çme
);

1268 
	`DPRINTF
("usb-ohci: %s: USB O³¿tiÚ®\n", 
ohci
->
Çme
);

1270 
	`ohci_sof
(
ohci
);

1273 
	}
}

1276 
	$ohci_bus_¡İ
(
OHCIS‹
 *
ohci
)

1278 ià(
ohci
->
eof_tim”
)

1279 
	`qemu_d–_tim”
(
ohci
->
eof_tim”
);

1280 
ohci
->
eof_tim”
 = 
NULL
;

1281 
	}
}

1287 
	$ohci_pÜt_£t_if_cÚÃùed
(
OHCIS‹
 *
ohci
, 
i
, 
ušt32_t
 
v®
)

1289 
»t
 = 1;

1292 ià(
v®
 == 0)

1298 ià(!(
ohci
->
rhpÜt
[
i
].
ù¾
 & 
OHCI_PORT_CCS
)) {

1299 
ohci
->
rhpÜt
[
i
].
ù¾
 |ğ
OHCI_PORT_CSC
;

1300 ià(
ohci
->
rh¡©us
 & 
OHCI_RHS_DRWE
) {

1306 ià(
ohci
->
rhpÜt
[
i
].
ù¾
 & 
v®
)

1307 
»t
 = 0;

1310 
ohci
->
rhpÜt
[
i
].
ù¾
 |ğ
v®
;

1312  
»t
;

1313 
	}
}

1316 
	$ohci_£t_äame_š‹rv®
(
OHCIS‹
 *
ohci
, 
ušt16_t
 
v®
)

1318 
v®
 &ğ
OHCI_FMI_FI
;

1320 ià(
v®
 !ğ
ohci
->
fi
) {

1321 
	`DPRINTF
("usb-ohci: %s: FrameInterval = 0x%x (%u)\n",

1322 
ohci
->
Çme
, ohci->
fi
, ohci->fi);

1325 
ohci
->
fi
 = 
v®
;

1326 
	}
}

1328 
	$ohci_pÜt_pow”
(
OHCIS‹
 *
ohci
, 
i
, 
p
)

1330 ià(
p
) {

1331 
ohci
->
rhpÜt
[
i
].
ù¾
 |ğ
OHCI_PORT_PPS
;

1333 
ohci
->
rhpÜt
[
i
].
ù¾
 &ğ~(
OHCI_PORT_PPS
|

1334 
OHCI_PORT_CCS
|

1335 
OHCI_PORT_PSS
|

1336 
OHCI_PORT_PRS
);

1338 
	}
}

1341 
	$ohci_£t_ùl
(
OHCIS‹
 *
ohci
, 
ušt32_t
 
v®
)

1343 
ušt32_t
 
Şd_¡©e
;

1344 
ušt32_t
 
Ãw_¡©e
;

1346 
Şd_¡©e
 = 
ohci
->
ùl
 & 
OHCI_CTL_HCFS
;

1347 
ohci
->
ùl
 = 
v®
;

1348 
Ãw_¡©e
 = 
ohci
->
ùl
 & 
OHCI_CTL_HCFS
;

1351 ià(
Şd_¡©e
 =ğ
Ãw_¡©e
)

1354 
Ãw_¡©e
) {

1355 
OHCI_USB_OPERATIONAL
:

1356 
	`ohci_bus_¡¬t
(
ohci
);

1358 
OHCI_USB_SUSPEND
:

1359 
	`ohci_bus_¡İ
(
ohci
);

1360 
	`DPRINTF
("usb-ohci: %s: USB Su¥’ded\n", 
ohci
->
Çme
);

1362 
OHCI_USB_RESUME
:

1363 
	`DPRINTF
("usb-ohci: %s: USB Resume\n", 
ohci
->
Çme
);

1365 
OHCI_USB_RESET
:

1366 
	`ohci_»£t
(
ohci
);

1367 
	`DPRINTF
("usb-ohci: %s: USB Re£t\n", 
ohci
->
Çme
);

1370 
	}
}

1372 
ušt32_t
 
	$ohci_g‘_äame_»maššg
(
OHCIS‹
 *
ohci
)

1374 
ušt16_t
 
ä
;

1375 
št64_t
 
tks
;

1377 ià((
ohci
->
ùl
 & 
OHCI_CTL_HCFS
è!ğ
OHCI_USB_OPERATIONAL
)

1378  (
ohci
->
ät
 << 31);

1383 
tks
 = 
	`qemu_g‘_şock_ns
(
vm_şock
è- 
ohci
->
sof_time
;

1386 ià(
tks
 >ğ
usb_äame_time
)

1387  (
ohci
->
ät
 << 31);

1389 
tks
 = 
	`muldiv64
(1,ks, 
usb_b™_time
);

1390 
ä
 = (
ušt16_t
)(
ohci
->
fi
 - 
tks
);

1392  (
ohci
->
ät
 << 31è| 
ä
;

1393 
	}
}

1397 
	$ohci_£t_hub_¡©us
(
OHCIS‹
 *
ohci
, 
ušt32_t
 
v®
)

1399 
ušt32_t
 
Şd_¡©e
;

1401 
Şd_¡©e
 = 
ohci
->
rh¡©us
;

1404 ià(
v®
 & 
OHCI_RHS_OCIC
)

1405 
ohci
->
rh¡©us
 &ğ~
OHCI_RHS_OCIC
;

1407 ià(
v®
 & 
OHCI_RHS_LPS
) {

1408 
i
;

1410 
i
 = 0; i < 
ohci
->
num_pÜts
; i++)

1411 
	`ohci_pÜt_pow”
(
ohci
, 
i
, 0);

1412 
	`DPRINTF
("usb-ohci:…owered down‡ll…orts\n");

1415 ià(
v®
 & 
OHCI_RHS_LPSC
) {

1416 
i
;

1418 
i
 = 0; i < 
ohci
->
num_pÜts
; i++)

1419 
	`ohci_pÜt_pow”
(
ohci
, 
i
, 1);

1420 
	`DPRINTF
("usb-ohci:…owered up‡ll…orts\n");

1423 ià(
v®
 & 
OHCI_RHS_DRWE
)

1424 
ohci
->
rh¡©us
 |ğ
OHCI_RHS_DRWE
;

1426 ià(
v®
 & 
OHCI_RHS_CRWE
)

1427 
ohci
->
rh¡©us
 &ğ~
OHCI_RHS_DRWE
;

1429 ià(
Şd_¡©e
 !ğ
ohci
->
rh¡©us
)

1430 
	`ohci_£t_š‹¼u±
(
ohci
, 
OHCI_INTR_RHSC
);

1431 
	}
}

1434 
	$ohci_pÜt_£t_¡©us
(
OHCIS‹
 *
ohci
, 
pÜŠum
, 
ušt32_t
 
v®
)

1436 
ušt32_t
 
Şd_¡©e
;

1437 
OHCIPÜt
 *
pÜt
;

1439 
pÜt
 = &
ohci
->
rhpÜt
[
pÜŠum
];

1440 
Şd_¡©e
 = 
pÜt
->
ù¾
;

1443 ià(
v®
 & 
OHCI_PORT_WTC
)

1444 
pÜt
->
ù¾
 &ğ~(
v®
 & 
OHCI_PORT_WTC
);

1446 ià(
v®
 & 
OHCI_PORT_CCS
)

1447 
pÜt
->
ù¾
 &ğ~
OHCI_PORT_PES
;

1449 
	`ohci_pÜt_£t_if_cÚÃùed
(
ohci
, 
pÜŠum
, 
v®
 & 
OHCI_PORT_PES
);

1451 ià(
	`ohci_pÜt_£t_if_cÚÃùed
(
ohci
, 
pÜŠum
, 
v®
 & 
OHCI_PORT_PSS
)) {

1452 
	`DPRINTF
("usb-ohci:…Üˆ%d: SUSPEND\n", 
pÜŠum
);

1455 ià(
	`ohci_pÜt_£t_if_cÚÃùed
(
ohci
, 
pÜŠum
, 
v®
 & 
OHCI_PORT_PRS
)) {

1456 
	`DPRINTF
("usb-ohci:…Üˆ%d: RESET\n", 
pÜŠum
);

1457 
	`usb_deviû_»£t
(
pÜt
->pÜt.
dev
);

1458 
pÜt
->
ù¾
 &ğ~
OHCI_PORT_PRS
;

1460 
pÜt
->
ù¾
 |ğ
OHCI_PORT_PES
 | 
OHCI_PORT_PRSC
;

1466 ià(
v®
 & 
OHCI_PORT_LSDA
)

1467 
	`ohci_pÜt_pow”
(
ohci
, 
pÜŠum
, 0);

1468 ià(
v®
 & 
OHCI_PORT_PPS
)

1469 
	`ohci_pÜt_pow”
(
ohci
, 
pÜŠum
, 1);

1471 ià(
Şd_¡©e
 !ğ
pÜt
->
ù¾
)

1472 
	`ohci_£t_š‹¼u±
(
ohci
, 
OHCI_INTR_RHSC
);

1475 
	}
}

1477 
ušt64_t
 
	$ohci_mem_»ad
(*
İaque
,

1478 
rg‘_phys_addr_t
 
addr
,

1479 
size
)

1481 
OHCIS‹
 *
ohci
 = 
İaque
;

1482 
ušt32_t
 
»tv®
;

1485 ià(
addr
 & 3) {

1486 
	`årštf
(
¡d”r
, "usb-ohci: Mis-aligned„ead\n");

1488 } ià(
addr
 >ğ0x54 &&‡dd¸< 0x54 + 
ohci
->
num_pÜts
 * 4) {

1490 
»tv®
 = 
ohci
->
rhpÜt
[(
addr
 - 0x54è>> 2].
ù¾
 | 
OHCI_PORT_PPS
;

1492 
addr
 >> 2) {

1494 
»tv®
 = 0x10;

1498 
»tv®
 = 
ohci
->
ùl
;

1502 
»tv®
 = 
ohci
->
¡©us
;

1506 
»tv®
 = 
ohci
->
šŒ_¡©us
;

1511 
»tv®
 = 
ohci
->
šŒ
;

1515 
»tv®
 = 
ohci
->
hcÿ
;

1519 
»tv®
 = 
ohci
->
³r_cur
;

1523 
»tv®
 = 
ohci
->
ù¾_h—d
;

1527 
»tv®
 = 
ohci
->
ù¾_cur
;

1531 
»tv®
 = 
ohci
->
bulk_h—d
;

1535 
»tv®
 = 
ohci
->
bulk_cur
;

1539 
»tv®
 = 
ohci
->
dÚe
;

1543 
»tv®
 = (
ohci
->
f™
 << 31è| (ohci->
fsmps
 << 16è| (ohci->
fi
);

1547 
»tv®
 = 
	`ohci_g‘_äame_»maššg
(
ohci
);

1551 
»tv®
 = 
ohci
->
äame_numb”
;

1555 
»tv®
 = 
ohci
->
p¡¬t
;

1559 
»tv®
 = 
ohci
->
l¡
;

1563 
»tv®
 = 
ohci
->
rhdesc_a
;

1567 
»tv®
 = 
ohci
->
rhdesc_b
;

1571 
»tv®
 = 
ohci
->
rh¡©us
;

1576 
»tv®
 = 
ohci
->
h¡©us
 & ohci->
hmask
;

1580 
»tv®
 = 
ohci
->
h»£t
;

1584 
»tv®
 = 
ohci
->
hmask
;

1588 
»tv®
 = 
ohci
->
h‹¡
;

1592 
	`årštf
(
¡d”r
, "ohci_»ad: Bad off£ˆ%x\n", ()
addr
);

1593 
»tv®
 = 0xffffffff;

1597  
»tv®
;

1598 
	}
}

1600 
	$ohci_mem_wr™e
(*
İaque
,

1601 
rg‘_phys_addr_t
 
addr
,

1602 
ušt64_t
 
v®
,

1603 
size
)

1605 
OHCIS‹
 *
ohci
 = 
İaque
;

1608 ià(
addr
 & 3) {

1609 
	`årštf
(
¡d”r
, "usb-ohci: Mis-aligned write\n");

1613 ià(
addr
 >ğ0x54 &&‡dd¸< 0x54 + 
ohci
->
num_pÜts
 * 4) {

1615 
	`ohci_pÜt_£t_¡©us
(
ohci
, (
addr
 - 0x54è>> 2, 
v®
);

1619 
addr
 >> 2) {

1621 
	`ohci_£t_ùl
(
ohci
, 
v®
);

1626 
v®
 = (v® & ~
OHCI_STATUS_SOC
);

1629 
ohci
->
¡©us
 |ğ
v®
;

1631 ià(
ohci
->
¡©us
 & 
OHCI_STATUS_HCR
)

1632 
	`ohci_»£t
(
ohci
);

1636 
ohci
->
šŒ_¡©us
 &ğ~
v®
;

1637 
	`ohci_šŒ_upd©e
(
ohci
);

1641 
ohci
->
šŒ
 |ğ
v®
;

1642 
	`ohci_šŒ_upd©e
(
ohci
);

1646 
ohci
->
šŒ
 &ğ~
v®
;

1647 
	`ohci_šŒ_upd©e
(
ohci
);

1651 
ohci
->
hcÿ
 = 
v®
 & 
OHCI_HCCA_MASK
;

1659 
ohci
->
ù¾_h—d
 = 
v®
 & 
OHCI_EDPTR_MASK
;

1663 
ohci
->
ù¾_cur
 = 
v®
 & 
OHCI_EDPTR_MASK
;

1667 
ohci
->
bulk_h—d
 = 
v®
 & 
OHCI_EDPTR_MASK
;

1671 
ohci
->
bulk_cur
 = 
v®
 & 
OHCI_EDPTR_MASK
;

1675 
ohci
->
fsmps
 = (
v®
 & 
OHCI_FMI_FSMPS
) >> 16;

1676 
ohci
->
f™
 = (
v®
 & 
OHCI_FMI_FIT
) >> 31;

1677 
	`ohci_£t_äame_š‹rv®
(
ohci
, 
v®
);

1684 
ohci
->
p¡¬t
 = 
v®
 & 0xffff;

1688 
ohci
->
l¡
 = 
v®
 & 0xffff;

1692 
ohci
->
rhdesc_a
 &ğ~
OHCI_RHA_RW_MASK
;

1693 
ohci
->
rhdesc_a
 |ğ
v®
 & 
OHCI_RHA_RW_MASK
;

1700 
	`ohci_£t_hub_¡©us
(
ohci
, 
v®
);

1705 
ohci
->
h¡©us
 &ğ~(
v®
 & ohci->
hmask
);

1708 
ohci
->
h»£t
 = 
v®
 & ~
OHCI_HRESET_FSBIR
;

1709 ià(
v®
 & 
OHCI_HRESET_FSBIR
)

1710 
	`ohci_»£t
(
ohci
);

1714 
ohci
->
hmask
 = 
v®
;

1718 
ohci
->
h‹¡
 = 
v®
;

1722 
	`årštf
(
¡d”r
, "ohci_wr™e: Bad off£ˆ%x\n", ()
addr
);

1725 
	}
}

1727 
	$ohci_async_ÿnûl_deviû
(
OHCIS‹
 *
ohci
, 
USBDeviû
 *
dev
)

1729 ià(
ohci
->
async_td
 &&

1730 
	`usb_·ck‘_is_šæight
(&
ohci
->
usb_·ck‘
) &&

1731 
ohci
->
usb_·ck‘
.
•
->
dev
 == dev) {

1732 
	`usb_ÿnûl_·ck‘
(&
ohci
->
usb_·ck‘
);

1733 
ohci
->
async_td
 = 0;

1735 
	}
}

1737 cÚ¡ 
MemÜyRegiÚOps
 
	gohci_mem_İs
 = {

1738 .
»ad
 = 
ohci_mem_»ad
,

1739 .
	gwr™e
 = 
ohci_mem_wr™e
,

1740 .
	g’dŸÂess
 = 
DEVICE_LITTLE_ENDIAN
,

1743 
USBPÜtOps
 
	gohci_pÜt_İs
 = {

1744 .
©ch
 = 
ohci_©ch
,

1745 .
	gd‘ach
 = 
ohci_d‘ach
,

1746 .
	gchd_d‘ach
 = 
ohci_chd_d‘ach
,

1747 .
	gwakeup
 = 
ohci_wakeup
,

1748 .
	gcom¶‘e
 = 
ohci_async_com¶‘e_·ck‘
,

1751 
USBBusOps
 
	gohci_bus_İs
 = {

1754 
	$usb_ohci_š™
(
OHCIS‹
 *
ohci
, 
DeviûS‹
 *
dev
,

1755 
num_pÜts
, 
dma_addr_t
 
loÿlmem_ba£
,

1756 *
ma¡”bus
, 
ušt32_t
 
fœ¡pÜt
,

1757 
DMACÚ‹xt
 *
dma
)

1759 
i
;

1761 
ohci
->
dma
 = dma;

1763 ià(
usb_äame_time
 == 0) {

1764 #ifdeà
OHCI_TIME_WARP


1765 
usb_äame_time
 = 
	`g‘_ticks_³r_£c
();

1766 
usb_b™_time
 = 
	`muldiv64
(1, 
	`g‘_ticks_³r_£c
(), 
USB_HZ
/1000);

1768 
usb_äame_time
 = 
	`muldiv64
(1, 
	`g‘_ticks_³r_£c
(), 1000);

1769 ià(
	`g‘_ticks_³r_£c
(è>ğ
USB_HZ
) {

1770 
usb_b™_time
 = 
	`muldiv64
(1, 
	`g‘_ticks_³r_£c
(), 
USB_HZ
);

1772 
usb_b™_time
 = 1;

1775 
	`DPRINTF
("usb-ohci: usb_b™_time=%" 
PRId64
 " usb_frame_time=%" PRId64 "\n",

1776 
usb_äame_time
, 
usb_b™_time
);

1779 
ohci
->
num_pÜts
 =‚um_ports;

1780 ià(
ma¡”bus
) {

1781 
USBPÜt
 *
pÜts
[
OHCI_MAX_PORTS
];

1782 
i
 = 0; i < 
num_pÜts
; i++) {

1783 
pÜts
[
i
] = &
ohci
->
rhpÜt
[i].
pÜt
;

1785 ià(
	`usb_»gi¡”_com·niÚ
(
ma¡”bus
, 
pÜts
, 
num_pÜts
,

1786 
fœ¡pÜt
, 
ohci
, &
ohci_pÜt_İs
,

1787 
USB_SPEED_MASK_LOW
 | 
USB_SPEED_MASK_FULL
) != 0) {

1791 
	`usb_bus_Ãw
(&
ohci
->
bus
, &
ohci_bus_İs
, 
dev
);

1792 
i
 = 0; i < 
num_pÜts
; i++) {

1793 
	`usb_»gi¡”_pÜt
(&
ohci
->
bus
, &ohci->
rhpÜt
[
i
].
pÜt
,

1794 
ohci
, 
i
, &
ohci_pÜt_İs
,

1795 
USB_SPEED_MASK_LOW
 | 
USB_SPEED_MASK_FULL
);

1799 
	`memÜy_»giÚ_š™_io
(&
ohci
->
mem
, &
ohci_mem_İs
, ohci, "ohci", 256);

1800 
ohci
->
loÿlmem_ba£
 =†ocalmem_base;

1802 
ohci
->
Çme
 = 
	`objeù_g‘_ty³Çme
(
	`OBJECT
(
dev
));

1803 
	`usb_·ck‘_š™
(&
ohci
->
usb_·ck‘
);

1805 
ohci
->
async_td
 = 0;

1806 
	`qemu_»gi¡”_»£t
(
ohci_»£t
, 
ohci
);

1809 
	}
}

1812 
PCIDeviû
 
	mpci_dev
;

1813 
OHCIS‹
 
	m¡©e
;

1814 *
	mma¡”bus
;

1815 
ušt32_t
 
	mnum_pÜts
;

1816 
ušt32_t
 
	mfœ¡pÜt
;

1817 } 
	tOHCIPCIS‹
;

1819 
	$usb_ohci_š™â_pci
(
PCIDeviû
 *
dev
)

1821 
OHCIPCIS‹
 *
ohci
 = 
	`DO_UPCAST
(OHCIPCIS‹, 
pci_dev
, 
dev
);

1823 
ohci
->
pci_dev
.
cÚfig
[
PCI_CLASS_PROG
] = 0x10;

1824 
ohci
->
pci_dev
.
cÚfig
[
PCI_INTERRUPT_PIN
] = 0x01;

1826 ià(
	`usb_ohci_š™
(&
ohci
->
¡©e
, &
dev
->
qdev
, ohci->
num_pÜts
, 0,

1827 
ohci
->
ma¡”bus
, ohci->
fœ¡pÜt
,

1828 
	`pci_dma_cÚ‹xt
(
dev
)) != 0) {

1831 
ohci
->
¡©e
.
œq
 = ohci->
pci_dev
.irq[0];

1834 
	`pci_»gi¡”_b¬
(&
ohci
->
pci_dev
, 0, 0, &ohci->
¡©e
.
mem
);

1836 
	}
}

1839 
SysBusDeviû
 
	mbusdev
;

1840 
OHCIS‹
 
	mohci
;

1841 
ušt32_t
 
	mnum_pÜts
;

1842 
dma_addr_t
 
	mdma_off£t
;

1843 } 
	tOHCISysBusS‹
;

1845 
	$ohci_š™_pxa
(
SysBusDeviû
 *
dev
)

1847 
OHCISysBusS‹
 *
s
 = 
	`FROM_SYSBUS
(OHCISysBusS‹, 
dev
);

1850 
	`usb_ohci_š™
(&
s
->
ohci
, &
dev
->
qdev
, s->
num_pÜts
, s->
dma_off£t
, 
NULL
, 0,

1851 
NULL
);

1852 
	`sysbus_š™_œq
(
dev
, &
s
->
ohci
.
œq
);

1853 
	`sysbus_š™_mmio
(
dev
, &
s
->
ohci
.
mem
);

1856 
	}
}

1858 
Prİ”ty
 
	gohci_pci_´İ”t›s
[] = {

1859 
DEFINE_PROP_STRING
("ma¡”bus", 
OHCIPCIS‹
, 
ma¡”bus
),

1860 
DEFINE_PROP_UINT32
("num-pÜts", 
OHCIPCIS‹
, 
num_pÜts
, 3),

1861 
DEFINE_PROP_UINT32
("fœ¡pÜt", 
OHCIPCIS‹
, 
fœ¡pÜt
, 0),

1862 
DEFINE_PROP_END_OF_LIST
(),

1865 
	$ohci_pci_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1867 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1868 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

1870 
k
->
š™
 = 
usb_ohci_š™â_pci
;

1871 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_APPLE
;

1872 
k
->
deviû_id
 = 
PCI_DEVICE_ID_APPLE_IPID_USB
;

1873 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

1874 
dc
->
desc
 = "Apple USB Controller";

1875 
dc
->
´İs
 = 
ohci_pci_´İ”t›s
;

1876 
	}
}

1878 
Ty³Info
 
	gohci_pci_šfo
 = {

1879 .
Çme
 = "pci-ohci",

1880 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

1881 .
	gš¡ªû_size
 = (
OHCIPCIS‹
),

1882 .
	gşass_š™
 = 
ohci_pci_şass_š™
,

1885 
Prİ”ty
 
	gohci_sysbus_´İ”t›s
[] = {

1886 
DEFINE_PROP_UINT32
("num-pÜts", 
OHCISysBusS‹
, 
num_pÜts
, 3),

1887 
DEFINE_PROP_DMAADDR
("dma-off£t", 
OHCISysBusS‹
, 
dma_off£t
, 3),

1888 
DEFINE_PROP_END_OF_LIST
(),

1891 
	$ohci_sysbus_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1893 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1894 
SysBusDeviûCÏss
 *
sbc
 = 
	`SYS_BUS_DEVICE_CLASS
(
kÏss
);

1896 
sbc
->
š™
 = 
ohci_š™_pxa
;

1897 
dc
->
desc
 = "OHCI USB Controller";

1898 
dc
->
´İs
 = 
ohci_sysbus_´İ”t›s
;

1899 
	}
}

1901 
Ty³Info
 
	gohci_sysbus_šfo
 = {

1902 .
Çme
 = "sysbus-ohci",

1903 .
	g·»Á
 = 
TYPE_SYS_BUS_DEVICE
,

1904 .
	gš¡ªû_size
 = (
OHCISysBusS‹
),

1905 .
	gşass_š™
 = 
ohci_sysbus_şass_š™
,

1908 
	$ohci_»gi¡”_ty³s
()

1910 
	`ty³_»gi¡”_¡©ic
(&
ohci_pci_šfo
);

1911 
	`ty³_»gi¡”_¡©ic
(&
ohci_sysbus_šfo
);

1912 
	}
}

1914 
ty³_š™
(
ohci_»gi¡”_ty³s
)

	@hcd-uhci.c

28 
	~"hw/hw.h
"

29 
	~"hw/usb.h
"

30 
	~"hw/pci.h
"

31 
	~"qemu-tim”.h
"

32 
	~"iov.h
"

33 
	~"dma.h
"

34 
	~"Œaû.h
"

39 
	#UHCI_CMD_FGR
 (1 << 4)

	)

40 
	#UHCI_CMD_EGSM
 (1 << 3)

	)

41 
	#UHCI_CMD_GRESET
 (1 << 2)

	)

42 
	#UHCI_CMD_HCRESET
 (1 << 1)

	)

43 
	#UHCI_CMD_RS
 (1 << 0)

	)

45 
	#UHCI_STS_HCHALTED
 (1 << 5)

	)

46 
	#UHCI_STS_HCPERR
 (1 << 4)

	)

47 
	#UHCI_STS_HSERR
 (1 << 3)

	)

48 
	#UHCI_STS_RD
 (1 << 2)

	)

49 
	#UHCI_STS_USBERR
 (1 << 1)

	)

50 
	#UHCI_STS_USBINT
 (1 << 0)

	)

52 
	#TD_CTRL_SPD
 (1 << 29)

	)

53 
	#TD_CTRL_ERROR_SHIFT
 27

	)

54 
	#TD_CTRL_IOS
 (1 << 25)

	)

55 
	#TD_CTRL_IOC
 (1 << 24)

	)

56 
	#TD_CTRL_ACTIVE
 (1 << 23)

	)

57 
	#TD_CTRL_STALL
 (1 << 22)

	)

58 
	#TD_CTRL_BABBLE
 (1 << 20)

	)

59 
	#TD_CTRL_NAK
 (1 << 19)

	)

60 
	#TD_CTRL_TIMEOUT
 (1 << 18)

	)

62 
	#UHCI_PORT_SUSPEND
 (1 << 12)

	)

63 
	#UHCI_PORT_RESET
 (1 << 9)

	)

64 
	#UHCI_PORT_LSDA
 (1 << 8)

	)

65 
	#UHCI_PORT_RD
 (1 << 6)

	)

66 
	#UHCI_PORT_ENC
 (1 << 3)

	)

67 
	#UHCI_PORT_EN
 (1 << 2)

	)

68 
	#UHCI_PORT_CSC
 (1 << 1)

	)

69 
	#UHCI_PORT_CCS
 (1 << 0)

	)

71 
	#UHCI_PORT_READ_ONLY
 (0x1bb)

	)

72 
	#UHCI_PORT_WRITE_CLEAR
 (
UHCI_PORT_CSC
 | 
UHCI_PORT_ENC
)

	)

74 
	#FRAME_TIMER_FREQ
 1000

	)

76 
	#FRAME_MAX_LOOPS
 256

	)

78 
	#NB_PORTS
 2

	)

81 
	mTD_RESULT_STOP_FRAME
 = 10,

82 
	mTD_RESULT_COMPLETE
,

83 
	mTD_RESULT_NEXT_QH
,

84 
	mTD_RESULT_ASYNC_START
,

85 
	mTD_RESULT_ASYNC_CONT
,

88 
UHCIS‹
 
	tUHCIS‹
;

89 
UHCIAsync
 
	tUHCIAsync
;

90 
UHCIQueue
 
	tUHCIQueue
;

98 
	sUHCIAsync
 {

99 
USBPack‘
 
	m·ck‘
;

100 
QEMUSGLi¡
 
	msgl
;

101 
UHCIQueue
 *
	mqueue
;

102 
QTAILQ_ENTRY
(
UHCIAsync
è
	mÃxt
;

103 
ušt32_t
 
	mtd
;

104 
ušt8_t
 
	misoc
;

105 
ušt8_t
 
	mdÚe
;

108 
	sUHCIQueue
 {

109 
ušt32_t
 
	mtok’
;

110 
UHCIS‹
 *
	muhci
;

111 
QTAILQ_ENTRY
(
UHCIQueue
è
	mÃxt
;

112 
QTAILQ_HEAD
(, 
UHCIAsync
è
	masyncs
;

113 
št8_t
 
	mv®id
;

116 
	sUHCIPÜt
 {

117 
USBPÜt
 
	mpÜt
;

118 
ušt16_t
 
	mù¾
;

119 } 
	tUHCIPÜt
;

121 
	sUHCIS‹
 {

122 
PCIDeviû
 
	mdev
;

123 
MemÜyRegiÚ
 
	mio_b¬
;

124 
USBBus
 
	mbus
;

125 
ušt16_t
 
	mcmd
;

126 
ušt16_t
 
	m¡©us
;

127 
ušt16_t
 
	mšŒ
;

128 
ušt16_t
 
	mänum
;

129 
ušt32_t
 
	mæ_ba£_addr
;

130 
ušt8_t
 
	msof_timšg
;

131 
ušt8_t
 
	m¡©us2
;

132 
št64_t
 
	mexpœe_time
;

133 
QEMUTim”
 *
	mäame_tim”
;

134 
QEMUBH
 *
	mbh
;

135 
ušt32_t
 
	mäame_by‹s
;

136 
ušt32_t
 
	mäame_bªdwidth
;

137 
UHCIPÜt
 
	mpÜts
[
NB_PORTS
];

140 
ušt32_t
 
	m³ndšg_št_mask
;

141 
	mœq_pš
;

144 
QTAILQ_HEAD
(, 
UHCIQueue
è
	mqueues
;

145 
ušt8_t
 
	mnum_pÜts_vm¡©e
;

148 *
	mma¡”bus
;

149 
ušt32_t
 
	mfœ¡pÜt
;

152 
	sUHCI_TD
 {

153 
ušt32_t
 
	mlšk
;

154 
ušt32_t
 
	mù¾
;

155 
ušt32_t
 
	mtok’
;

156 
ušt32_t
 
	mbufãr
;

157 } 
	tUHCI_TD
;

159 
	sUHCI_QH
 {

160 
ušt32_t
 
	mlšk
;

161 
ušt32_t
 
	m–_lšk
;

162 } 
	tUHCI_QH
;

164 
šlše
 
št32_t
 
	$uhci_queue_tok’
(
UHCI_TD
 *
td
)

167  
td
->
tok’
 & 0x7ffff;

168 
	}
}

170 
UHCIQueue
 *
	$uhci_queue_g‘
(
UHCIS‹
 *
s
, 
UHCI_TD
 *
td
)

172 
ušt32_t
 
tok’
 = 
	`uhci_queue_tok’
(
td
);

173 
UHCIQueue
 *
queue
;

175 
	`QTAILQ_FOREACH
(
queue
, &
s
->
queues
, 
Ãxt
) {

176 ià(
queue
->
tok’
 ==oken) {

177  
queue
;

181 
queue
 = 
	`g_Ãw0
(
UHCIQueue
, 1);

182 
queue
->
uhci
 = 
s
;

183 
queue
->
tok’
 =oken;

184 
	`QTAILQ_INIT
(&
queue
->
asyncs
);

185 
	`QTAILQ_INSERT_HEAD
(&
s
->
queues
, 
queue
, 
Ãxt
);

186 
	`Œaû_usb_uhci_queue_add
(
queue
->
tok’
);

187  
queue
;

188 
	}
}

190 
	$uhci_queue_ä“
(
UHCIQueue
 *
queue
)

192 
UHCIS‹
 *
s
 = 
queue
->
uhci
;

194 
	`Œaû_usb_uhci_queue_d–
(
queue
->
tok’
);

195 
	`QTAILQ_REMOVE
(&
s
->
queues
, 
queue
, 
Ãxt
);

196 
	`g_ä“
(
queue
);

197 
	}
}

199 
UHCIAsync
 *
	$uhci_async_®loc
(
UHCIQueue
 *
queue
, 
ušt32_t
 
addr
)

201 
UHCIAsync
 *
async
 = 
	`g_Ãw0
(UHCIAsync, 1);

203 
async
->
queue
 = queue;

204 
async
->
td
 = 
addr
;

205 
	`usb_·ck‘_š™
(&
async
->
·ck‘
);

206 
	`pci_dma_sgli¡_š™
(&
async
->
sgl
, &
queue
->
uhci
->
dev
, 1);

207 
	`Œaû_usb_uhci_·ck‘_add
(
async
->
queue
->
tok’
,‡sync->
td
);

209  
async
;

210 
	}
}

212 
	$uhci_async_ä“
(
UHCIAsync
 *
async
)

214 
	`Œaû_usb_uhci_·ck‘_d–
(
async
->
queue
->
tok’
,‡sync->
td
);

215 
	`usb_·ck‘_ş—nup
(&
async
->
·ck‘
);

216 
	`qemu_sgli¡_de¡roy
(&
async
->
sgl
);

217 
	`g_ä“
(
async
);

218 
	}
}

220 
	$uhci_async_lšk
(
UHCIAsync
 *
async
)

222 
UHCIQueue
 *
queue
 = 
async
->queue;

223 
	`QTAILQ_INSERT_TAIL
(&
queue
->
asyncs
, 
async
, 
Ãxt
);

224 
	`Œaû_usb_uhci_·ck‘_lšk_async
(
async
->
queue
->
tok’
,‡sync->
td
);

225 
	}
}

227 
	$uhci_async_uÆšk
(
UHCIAsync
 *
async
)

229 
UHCIQueue
 *
queue
 = 
async
->queue;

230 
	`QTAILQ_REMOVE
(&
queue
->
asyncs
, 
async
, 
Ãxt
);

231 
	`Œaû_usb_uhci_·ck‘_uÆšk_async
(
async
->
queue
->
tok’
,‡sync->
td
);

232 
	}
}

234 
	$uhci_async_ÿnûl
(
UHCIAsync
 *
async
)

236 
	`Œaû_usb_uhci_·ck‘_ÿnûl
(
async
->
queue
->
tok’
,‡sync->
td
,‡sync->
dÚe
);

237 ià(!
async
->
dÚe
)

238 
	`usb_ÿnûl_·ck‘
(&
async
->
·ck‘
);

239 
	`uhci_async_ä“
(
async
);

240 
	}
}

246 
	$uhci_async_v®id©e_begš
(
UHCIS‹
 *
s
)

248 
UHCIQueue
 *
queue
;

250 
	`QTAILQ_FOREACH
(
queue
, &
s
->
queues
, 
Ãxt
) {

251 
queue
->
v®id
--;

253 
	}
}

258 
	$uhci_async_v®id©e_’d
(
UHCIS‹
 *
s
)

260 
UHCIQueue
 *
queue
, *
n
;

261 
UHCIAsync
 *
async
;

263 
	`QTAILQ_FOREACH_SAFE
(
queue
, &
s
->
queues
, 
Ãxt
, 
n
) {

264 ià(
queue
->
v®id
 > 0) {

267 !
	`QTAILQ_EMPTY
(&
queue
->
asyncs
)) {

268 
async
 = 
	`QTAILQ_FIRST
(&
queue
->
asyncs
);

269 
	`uhci_async_uÆšk
(
async
);

270 
	`uhci_async_ÿnûl
(
async
);

272 
	`uhci_queue_ä“
(
queue
);

274 
	}
}

276 
	$uhci_async_ÿnûl_deviû
(
UHCIS‹
 *
s
, 
USBDeviû
 *
dev
)

278 
UHCIQueue
 *
queue
;

279 
UHCIAsync
 *
cu¼
, *
n
;

281 
	`QTAILQ_FOREACH
(
queue
, &
s
->
queues
, 
Ãxt
) {

282 
	`QTAILQ_FOREACH_SAFE
(
cu¼
, &
queue
->
asyncs
, 
Ãxt
, 
n
) {

283 ià(!
	`usb_·ck‘_is_šæight
(&
cu¼
->
·ck‘
) ||

284 
cu¼
->
·ck‘
.
•
->
dev
 != dev) {

287 
	`uhci_async_uÆšk
(
cu¼
);

288 
	`uhci_async_ÿnûl
(
cu¼
);

291 
	}
}

293 
	$uhci_async_ÿnûl_®l
(
UHCIS‹
 *
s
)

295 
UHCIQueue
 *
queue
, *
nq
;

296 
UHCIAsync
 *
cu¼
, *
n
;

298 
	`QTAILQ_FOREACH_SAFE
(
queue
, &
s
->
queues
, 
Ãxt
, 
nq
) {

299 
	`QTAILQ_FOREACH_SAFE
(
cu¼
, &
queue
->
asyncs
, 
Ãxt
, 
n
) {

300 
	`uhci_async_uÆšk
(
cu¼
);

301 
	`uhci_async_ÿnûl
(
cu¼
);

303 
	`uhci_queue_ä“
(
queue
);

305 
	}
}

307 
UHCIAsync
 *
	$uhci_async_fšd_td
(
UHCIS‹
 *
s
, 
ušt32_t
 
addr
, 
UHCI_TD
 *
td
)

309 
ušt32_t
 
tok’
 = 
	`uhci_queue_tok’
(
td
);

310 
UHCIQueue
 *
queue
;

311 
UHCIAsync
 *
async
;

313 
	`QTAILQ_FOREACH
(
queue
, &
s
->
queues
, 
Ãxt
) {

314 ià(
queue
->
tok’
 ==oken) {

318 ià(
queue
 =ğ
NULL
) {

319  
NULL
;

322 
	`QTAILQ_FOREACH
(
async
, &
queue
->
asyncs
, 
Ãxt
) {

323 ià(
async
->
td
 =ğ
addr
) {

324  
async
;

328  
NULL
;

329 
	}
}

331 
	$uhci_upd©e_œq
(
UHCIS‹
 *
s
)

333 
Ëv–
;

334 ià(((
s
->
¡©us2
 & 1è&& (s->
šŒ
 & (1 << 2))) ||

335 ((
s
->
¡©us2
 & 2è&& (s->
šŒ
 & (1 << 3))) ||

336 ((
s
->
¡©us
 & 
UHCI_STS_USBERR
è&& (s->
šŒ
 & (1 << 0))) ||

337 ((
s
->
¡©us
 & 
UHCI_STS_RD
è&& (s->
šŒ
 & (1 << 1))) ||

338 (
s
->
¡©us
 & 
UHCI_STS_HSERR
) ||

339 (
s
->
¡©us
 & 
UHCI_STS_HCPERR
)) {

340 
Ëv–
 = 1;

342 
Ëv–
 = 0;

344 
	`qemu_£t_œq
(
s
->
dev
.
œq
[s->
œq_pš
], 
Ëv–
);

345 
	}
}

347 
	$uhci_»£t
(*
İaque
)

349 
UHCIS‹
 *
s
 = 
İaque
;

350 
ušt8_t
 *
pci_cÚf
;

351 
i
;

352 
UHCIPÜt
 *
pÜt
;

354 
	`Œaû_usb_uhci_»£t
();

356 
pci_cÚf
 = 
s
->
dev
.
cÚfig
;

358 
pci_cÚf
[0x6a] = 0x01;

359 
pci_cÚf
[0x6b] = 0x00;

360 
s
->
cmd
 = 0;

361 
s
->
¡©us
 = 0;

362 
s
->
¡©us2
 = 0;

363 
s
->
šŒ
 = 0;

364 
s
->
æ_ba£_addr
 = 0;

365 
s
->
sof_timšg
 = 64;

367 
i
 = 0; i < 
NB_PORTS
; i++) {

368 
pÜt
 = &
s
->
pÜts
[
i
];

369 
pÜt
->
ù¾
 = 0x0080;

370 ià(
pÜt
->pÜt.
dev
 &&…Üt->pÜt.dev->
©ched
) {

371 
	`usb_pÜt_»£t
(&
pÜt
->port);

375 
	`uhci_async_ÿnûl_®l
(
s
);

376 
	`qemu_bh_ÿnûl
(
s
->
bh
);

377 
	`uhci_upd©e_œq
(
s
);

378 
	}
}

380 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_uhci_pÜt
 = {

381 .
Çme
 = "uhci…ort",

382 .
	gv”siÚ_id
 = 1,

383 .
	gmšimum_v”siÚ_id
 = 1,

384 .
	gmšimum_v”siÚ_id_Şd
 = 1,

385 .
	gf›lds
 = (
VMS‹F›ld
 []) {

386 
VMSTATE_UINT16
(
ù¾
, 
UHCIPÜt
),

387 
VMSTATE_END_OF_LIST
()

391 
	$uhci_po¡_lßd
(*
İaque
, 
v”siÚ_id
)

393 
UHCIS‹
 *
s
 = 
İaque
;

395 ià(
v”siÚ_id
 < 2) {

396 
s
->
expœe_time
 = 
	`qemu_g‘_şock_ns
(
vm_şock
) +

397 (
	`g‘_ticks_³r_£c
(è/ 
FRAME_TIMER_FREQ
);

400 
	}
}

402 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_uhci
 = {

403 .
Çme
 = "uhci",

404 .
	gv”siÚ_id
 = 2,

405 .
	gmšimum_v”siÚ_id
 = 1,

406 .
	gmšimum_v”siÚ_id_Şd
 = 1,

407 .
	gpo¡_lßd
 = 
uhci_po¡_lßd
,

408 .
	gf›lds
 = (
VMS‹F›ld
 []) {

409 
VMSTATE_PCI_DEVICE
(
dev
, 
UHCIS‹
),

410 
VMSTATE_UINT8_EQUAL
(
num_pÜts_vm¡©e
, 
UHCIS‹
),

411 
VMSTATE_STRUCT_ARRAY
(
pÜts
, 
UHCIS‹
, 
NB_PORTS
, 1,

412 
vm¡©e_uhci_pÜt
, 
UHCIPÜt
),

413 
VMSTATE_UINT16
(
cmd
, 
UHCIS‹
),

414 
VMSTATE_UINT16
(
¡©us
, 
UHCIS‹
),

415 
VMSTATE_UINT16
(
šŒ
, 
UHCIS‹
),

416 
VMSTATE_UINT16
(
änum
, 
UHCIS‹
),

417 
VMSTATE_UINT32
(
æ_ba£_addr
, 
UHCIS‹
),

418 
VMSTATE_UINT8
(
sof_timšg
, 
UHCIS‹
),

419 
VMSTATE_UINT8
(
¡©us2
, 
UHCIS‹
),

420 
VMSTATE_TIMER
(
äame_tim”
, 
UHCIS‹
),

421 
VMSTATE_INT64_V
(
expœe_time
, 
UHCIS‹
, 2),

422 
VMSTATE_END_OF_LIST
()

426 
	$uhci_iİÜt_wr™eb
(*
İaque
, 
ušt32_t
 
addr
, ušt32_ˆ
v®
)

428 
UHCIS‹
 *
s
 = 
İaque
;

430 
addr
 &= 0x1f;

431 
addr
) {

433 
s
->
sof_timšg
 = 
v®
;

436 
	}
}

438 
ušt32_t
 
	$uhci_iİÜt_»adb
(*
İaque
, 
ušt32_t
 
addr
)

440 
UHCIS‹
 *
s
 = 
İaque
;

441 
ušt32_t
 
v®
;

443 
addr
 &= 0x1f;

444 
addr
) {

446 
v®
 = 
s
->
sof_timšg
;

449 
v®
 = 0xff;

452  
v®
;

453 
	}
}

455 
	$uhci_iİÜt_wr™ew
(*
İaque
, 
ušt32_t
 
addr
, ušt32_ˆ
v®
)

457 
UHCIS‹
 *
s
 = 
İaque
;

459 
addr
 &= 0x1f;

460 
	`Œaû_usb_uhci_mmio_wr™ew
(
addr
, 
v®
);

462 
addr
) {

464 ià((
v®
 & 
UHCI_CMD_RS
è&& !(
s
->
cmd
 & UHCI_CMD_RS)) {

466 
	`Œaû_usb_uhci_scheduË_¡¬t
();

467 
s
->
expœe_time
 = 
	`qemu_g‘_şock_ns
(
vm_şock
) +

468 (
	`g‘_ticks_³r_£c
(è/ 
FRAME_TIMER_FREQ
);

469 
	`qemu_mod_tim”
(
s
->
äame_tim”
, 
	`qemu_g‘_şock_ns
(
vm_şock
));

470 
s
->
¡©us
 &ğ~
UHCI_STS_HCHALTED
;

471 } ià(!(
v®
 & 
UHCI_CMD_RS
)) {

472 
s
->
¡©us
 |ğ
UHCI_STS_HCHALTED
;

474 ià(
v®
 & 
UHCI_CMD_GRESET
) {

475 
UHCIPÜt
 *
pÜt
;

476 
i
;

479 
i
 = 0; i < 
NB_PORTS
; i++) {

480 
pÜt
 = &
s
->
pÜts
[
i
];

481 
	`usb_deviû_»£t
(
pÜt
->pÜt.
dev
);

483 
	`uhci_»£t
(
s
);

486 ià(
v®
 & 
UHCI_CMD_HCRESET
) {

487 
	`uhci_»£t
(
s
);

490 
s
->
cmd
 = 
v®
;

493 
s
->
¡©us
 &ğ~
v®
;

496 ià(
v®
 & 
UHCI_STS_USBINT
)

497 
s
->
¡©us2
 = 0;

498 
	`uhci_upd©e_œq
(
s
);

501 
s
->
šŒ
 = 
v®
;

502 
	`uhci_upd©e_œq
(
s
);

505 ià(
s
->
¡©us
 & 
UHCI_STS_HCHALTED
)

506 
s
->
änum
 = 
v®
 & 0x7ff;

510 
UHCIPÜt
 *
pÜt
;

511 
USBDeviû
 *
dev
;

512 
n
;

514 
n
 = (
addr
 >> 1) & 7;

515 ià(
n
 >ğ
NB_PORTS
)

517 
pÜt
 = &
s
->
pÜts
[
n
];

518 
dev
 = 
pÜt
->port.dev;

519 ià(
dev
 && dev->
©ched
) {

521 iàĞ(
v®
 & 
UHCI_PORT_RESET
) &&

522 !(
pÜt
->
ù¾
 & 
UHCI_PORT_RESET
) ) {

523 
	`usb_deviû_»£t
(
dev
);

526 
pÜt
->
ù¾
 &ğ
UHCI_PORT_READ_ONLY
;

527 
pÜt
->
ù¾
 |ğ(
v®
 & ~
UHCI_PORT_READ_ONLY
);

529 
pÜt
->
ù¾
 &ğ~(
v®
 & 
UHCI_PORT_WRITE_CLEAR
);

533 
	}
}

535 
ušt32_t
 
	$uhci_iİÜt_»adw
(*
İaque
, 
ušt32_t
 
addr
)

537 
UHCIS‹
 *
s
 = 
İaque
;

538 
ušt32_t
 
v®
;

540 
addr
 &= 0x1f;

541 
addr
) {

543 
v®
 = 
s
->
cmd
;

546 
v®
 = 
s
->
¡©us
;

549 
v®
 = 
s
->
šŒ
;

552 
v®
 = 
s
->
änum
;

556 
UHCIPÜt
 *
pÜt
;

557 
n
;

558 
n
 = (
addr
 >> 1) & 7;

559 ià(
n
 >ğ
NB_PORTS
)

560 
»ad_deçuÉ
;

561 
pÜt
 = &
s
->
pÜts
[
n
];

562 
v®
 = 
pÜt
->
ù¾
;

566 
»ad_deçuÉ
:

567 
v®
 = 0xff7f;

571 
	`Œaû_usb_uhci_mmio_»adw
(
addr
, 
v®
);

573  
v®
;

574 
	}
}

576 
	$uhci_iİÜt_wr™–
(*
İaque
, 
ušt32_t
 
addr
, ušt32_ˆ
v®
)

578 
UHCIS‹
 *
s
 = 
İaque
;

580 
addr
 &= 0x1f;

581 
	`Œaû_usb_uhci_mmio_wr™–
(
addr
, 
v®
);

583 
addr
) {

585 
s
->
æ_ba£_addr
 = 
v®
 & ~0xfff;

588 
	}
}

590 
ušt32_t
 
	$uhci_iİÜt_»adl
(*
İaque
, 
ušt32_t
 
addr
)

592 
UHCIS‹
 *
s
 = 
İaque
;

593 
ušt32_t
 
v®
;

595 
addr
 &= 0x1f;

596 
addr
) {

598 
v®
 = 
s
->
æ_ba£_addr
;

601 
v®
 = 0xffffffff;

604 
	`Œaû_usb_uhci_mmio_»adl
(
addr
, 
v®
);

605  
v®
;

606 
	}
}

609 
	$uhci_»sume
 (*
İaque
)

611 
UHCIS‹
 *
s
 = (UHCIS‹ *)
İaque
;

613 ià(!
s
)

616 ià(
s
->
cmd
 & 
UHCI_CMD_EGSM
) {

617 
s
->
cmd
 |ğ
UHCI_CMD_FGR
;

618 
s
->
¡©us
 |ğ
UHCI_STS_RD
;

619 
	`uhci_upd©e_œq
(
s
);

621 
	}
}

623 
	$uhci_©ch
(
USBPÜt
 *
pÜt1
)

625 
UHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

626 
UHCIPÜt
 *
pÜt
 = &
s
->
pÜts
[
pÜt1
->
šdex
];

629 
pÜt
->
ù¾
 |ğ
UHCI_PORT_CCS
 | 
UHCI_PORT_CSC
;

632 ià(
pÜt
->pÜt.
dev
->
¥“d
 =ğ
USB_SPEED_LOW
) {

633 
pÜt
->
ù¾
 |ğ
UHCI_PORT_LSDA
;

635 
pÜt
->
ù¾
 &ğ~
UHCI_PORT_LSDA
;

638 
	`uhci_»sume
(
s
);

639 
	}
}

641 
	$uhci_d‘ach
(
USBPÜt
 *
pÜt1
)

643 
UHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

644 
UHCIPÜt
 *
pÜt
 = &
s
->
pÜts
[
pÜt1
->
šdex
];

646 
	`uhci_async_ÿnûl_deviû
(
s
, 
pÜt1
->
dev
);

649 ià(
pÜt
->
ù¾
 & 
UHCI_PORT_CCS
) {

650 
pÜt
->
ù¾
 &ğ~
UHCI_PORT_CCS
;

651 
pÜt
->
ù¾
 |ğ
UHCI_PORT_CSC
;

654 ià(
pÜt
->
ù¾
 & 
UHCI_PORT_EN
) {

655 
pÜt
->
ù¾
 &ğ~
UHCI_PORT_EN
;

656 
pÜt
->
ù¾
 |ğ
UHCI_PORT_ENC
;

659 
	`uhci_»sume
(
s
);

660 
	}
}

662 
	$uhci_chd_d‘ach
(
USBPÜt
 *
pÜt1
, 
USBDeviû
 *
chd
)

664 
UHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

666 
	`uhci_async_ÿnûl_deviû
(
s
, 
chd
);

667 
	}
}

669 
	$uhci_wakeup
(
USBPÜt
 *
pÜt1
)

671 
UHCIS‹
 *
s
 = 
pÜt1
->
İaque
;

672 
UHCIPÜt
 *
pÜt
 = &
s
->
pÜts
[
pÜt1
->
šdex
];

674 ià(
pÜt
->
ù¾
 & 
UHCI_PORT_SUSPEND
 && !ÕÜt->ù¾ & 
UHCI_PORT_RD
)) {

675 
pÜt
->
ù¾
 |ğ
UHCI_PORT_RD
;

676 
	`uhci_»sume
(
s
);

678 
	}
}

680 
USBDeviû
 *
	$uhci_fšd_deviû
(
UHCIS‹
 *
s
, 
ušt8_t
 
addr
)

682 
USBDeviû
 *
dev
;

683 
i
;

685 
i
 = 0; i < 
NB_PORTS
; i++) {

686 
UHCIPÜt
 *
pÜt
 = &
s
->
pÜts
[
i
];

687 ià(!(
pÜt
->
ù¾
 & 
UHCI_PORT_EN
)) {

690 
dev
 = 
	`usb_fšd_deviû
(&
pÜt
->pÜt, 
addr
);

691 ià(
dev
 !ğ
NULL
) {

692  
dev
;

695  
NULL
;

696 
	}
}

698 
uhci_async_com¶‘e
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
·ck‘
);

699 
uhci_´oûss_äame
(
UHCIS‹
 *
s
);

705 
	$uhci_com¶‘e_td
(
UHCIS‹
 *
s
, 
UHCI_TD
 *
td
, 
UHCIAsync
 *
async
, 
ušt32_t
 *
št_mask
)

707 
Ën
 = 0, 
max_Ën
, 
”r
, 
»t
;

708 
ušt8_t
 
pid
;

710 
max_Ën
 = ((
td
->
tok’
 >> 21) + 1) & 0x7ff;

711 
pid
 = 
td
->
tok’
 & 0xff;

713 
»t
 = 
async
->
·ck‘
.
»suÉ
;

715 ià(
td
->
ù¾
 & 
TD_CTRL_IOS
)

716 
td
->
ù¾
 &ğ~
TD_CTRL_ACTIVE
;

718 ià(
»t
 < 0)

719 
out
;

721 
Ën
 = 
async
->
·ck‘
.
»suÉ
;

722 
td
->
ù¾
 = (td->ù¾ & ~0x7ffè| ((
Ën
 - 1) & 0x7ff);

727 
td
->
ù¾
 &ğ~(
TD_CTRL_ACTIVE
 | 
TD_CTRL_NAK
);

728 ià(
td
->
ù¾
 & 
TD_CTRL_IOC
)

729 *
št_mask
 |= 0x01;

731 ià(
pid
 =ğ
USB_TOKEN_IN
) {

732 ià(
Ën
 > 
max_Ën
) {

733 
»t
 = 
USB_RET_BABBLE
;

734 
out
;

737 ià((
td
->
ù¾
 & 
TD_CTRL_SPD
è&& 
Ën
 < 
max_Ën
) {

738 *
št_mask
 |= 0x02;

740 
	`Œaû_usb_uhci_·ck‘_com¶‘e_shÜtxãr
(
async
->
queue
->
tok’
,

741 
async
->
td
);

742  
TD_RESULT_NEXT_QH
;

747 
	`Œaû_usb_uhci_·ck‘_com¶‘e_sucûss
(
async
->
queue
->
tok’
,‡sync->
td
);

748  
TD_RESULT_COMPLETE
;

750 
out
:

761 !
	`QTAILQ_EMPTY
(&
async
->
queue
->
asyncs
)) {

762 
UHCIAsync
 *
as
 = 
	`QTAILQ_FIRST
(&
async
->
queue
->
asyncs
);

763 
	`uhci_async_uÆšk
(
as
);

764 
	`uhci_async_ÿnûl
(
as
);

767 
»t
) {

768 
USB_RET_STALL
:

769 
td
->
ù¾
 |ğ
TD_CTRL_STALL
;

770 
td
->
ù¾
 &ğ~
TD_CTRL_ACTIVE
;

771 
s
->
¡©us
 |ğ
UHCI_STS_USBERR
;

772 ià(
td
->
ù¾
 & 
TD_CTRL_IOC
) {

773 *
št_mask
 |= 0x01;

775 
	`uhci_upd©e_œq
(
s
);

776 
	`Œaû_usb_uhci_·ck‘_com¶‘e_¡®l
(
async
->
queue
->
tok’
,‡sync->
td
);

777  
TD_RESULT_NEXT_QH
;

779 
USB_RET_BABBLE
:

780 
td
->
ù¾
 |ğ
TD_CTRL_BABBLE
 | 
TD_CTRL_STALL
;

781 
td
->
ù¾
 &ğ~
TD_CTRL_ACTIVE
;

782 
s
->
¡©us
 |ğ
UHCI_STS_USBERR
;

783 ià(
td
->
ù¾
 & 
TD_CTRL_IOC
) {

784 *
št_mask
 |= 0x01;

786 
	`uhci_upd©e_œq
(
s
);

788 
	`Œaû_usb_uhci_·ck‘_com¶‘e_babbË
(
async
->
queue
->
tok’
,‡sync->
td
);

789  
TD_RESULT_STOP_FRAME
;

791 
USB_RET_NAK
:

792 
td
->
ù¾
 |ğ
TD_CTRL_NAK
;

793 ià(
pid
 =ğ
USB_TOKEN_SETUP
)

795  
TD_RESULT_NEXT_QH
;

797 
USB_RET_IOERROR
:

798 
USB_RET_NODEV
:

805 
td
->
ù¾
 |ğ
TD_CTRL_TIMEOUT
;

806 
”r
 = (
td
->
ù¾
 >> 
TD_CTRL_ERROR_SHIFT
) & 3;

807 ià(
”r
 != 0) {

808 
”r
--;

809 ià(
”r
 == 0) {

810 
td
->
ù¾
 &ğ~
TD_CTRL_ACTIVE
;

811 
s
->
¡©us
 |ğ
UHCI_STS_USBERR
;

812 ià(
td
->
ù¾
 & 
TD_CTRL_IOC
)

813 *
št_mask
 |= 0x01;

814 
	`uhci_upd©e_œq
(
s
);

815 
	`Œaû_usb_uhci_·ck‘_com¶‘e_”rÜ
(
async
->
queue
->
tok’
,

816 
async
->
td
);

819 
td
->
ù¾
 = (td->ù¾ & ~(3 << 
TD_CTRL_ERROR_SHIFT
)) |

820 (
”r
 << 
TD_CTRL_ERROR_SHIFT
);

821  
TD_RESULT_NEXT_QH
;

822 
	}
}

824 
	$uhci_hªdË_td
(
UHCIS‹
 *
s
, 
ušt32_t
 
addr
, 
UHCI_TD
 *
td
,

825 
ušt32_t
 *
št_mask
, 
boŞ
 
queušg
)

827 
UHCIAsync
 *
async
;

828 
Ën
 = 0, 
max_Ën
;

829 
ušt8_t
 
pid
;

830 
USBDeviû
 *
dev
;

831 
USBEndpošt
 *
•
;

834 ià(!(
td
->
ù¾
 & 
TD_CTRL_ACTIVE
))

835  
TD_RESULT_NEXT_QH
;

837 
async
 = 
	`uhci_async_fšd_td
(
s
, 
addr
, 
td
);

838 ià(
async
) {

840 
async
->
queue
->
v®id
 = 32;

842 ià(!
async
->
dÚe
)

843  
TD_RESULT_ASYNC_CONT
;

844 ià(
queušg
) {

848  
TD_RESULT_ASYNC_CONT
;

851 
	`uhci_async_uÆšk
(
async
);

852 
dÚe
;

856 
async
 = 
	`uhci_async_®loc
(
	`uhci_queue_g‘
(
s
, 
td
), 
addr
);

861 
async
->
queue
->
v®id
 = 32;

862 
async
->
isoc
 = 
td
->
ù¾
 & 
TD_CTRL_IOS
;

864 
max_Ën
 = ((
td
->
tok’
 >> 21) + 1) & 0x7ff;

865 
pid
 = 
td
->
tok’
 & 0xff;

867 
dev
 = 
	`uhci_fšd_deviû
(
s
, (
td
->
tok’
 >> 8) & 0x7f);

868 
•
 = 
	`usb_•_g‘
(
dev
, 
pid
, (
td
->
tok’
 >> 15) & 0xf);

869 
	`usb_·ck‘_£tup
(&
async
->
·ck‘
, 
pid
, 
•
, 
addr
);

870 
	`qemu_sgli¡_add
(&
async
->
sgl
, 
td
->
bufãr
, 
max_Ën
);

871 
	`usb_·ck‘_m­
(&
async
->
·ck‘
, &async->
sgl
);

873 
pid
) {

874 
USB_TOKEN_OUT
:

875 
USB_TOKEN_SETUP
:

876 
Ën
 = 
	`usb_hªdË_·ck‘
(
dev
, &
async
->
·ck‘
);

877 ià(
Ën
 >= 0)

878 
Ën
 = 
max_Ën
;

881 
USB_TOKEN_IN
:

882 
Ën
 = 
	`usb_hªdË_·ck‘
(
dev
, &
async
->
·ck‘
);

887 
	`uhci_async_ä“
(
async
);

888 
s
->
¡©us
 |ğ
UHCI_STS_HCPERR
;

889 
	`uhci_upd©e_œq
(
s
);

890  
TD_RESULT_STOP_FRAME
;

893 ià(
Ën
 =ğ
USB_RET_ASYNC
) {

894 
	`uhci_async_lšk
(
async
);

895  
TD_RESULT_ASYNC_START
;

898 
async
->
·ck‘
.
»suÉ
 = 
Ën
;

900 
dÚe
:

901 
Ën
 = 
	`uhci_com¶‘e_td
(
s
, 
td
, 
async
, 
št_mask
);

902 
	`usb_·ck‘_unm­
(&
async
->
·ck‘
, &async->
sgl
);

903 
	`uhci_async_ä“
(
async
);

904  
Ën
;

905 
	}
}

907 
	$uhci_async_com¶‘e
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
·ck‘
)

909 
UHCIAsync
 *
async
 = 
	`cÚš”_of
(
·ck‘
, UHCIAsync,…acket);

910 
UHCIS‹
 *
s
 = 
async
->
queue
->
uhci
;

912 ià(
async
->
isoc
) {

913 
UHCI_TD
 
td
;

914 
ušt32_t
 
lšk
 = 
async
->
td
;

915 
ušt32_t
 
št_mask
 = 0, 
v®
;

917 
	`pci_dma_»ad
(&
s
->
dev
, 
lšk
 & ~0xf, &
td
, (td));

918 
	`Ë32_to_ıus
(&
td
.
lšk
);

919 
	`Ë32_to_ıus
(&
td
.
ù¾
);

920 
	`Ë32_to_ıus
(&
td
.
tok’
);

921 
	`Ë32_to_ıus
(&
td
.
bufãr
);

923 
	`uhci_async_uÆšk
(
async
);

924 
	`uhci_com¶‘e_td
(
s
, &
td
, 
async
, &
št_mask
);

925 
s
->
³ndšg_št_mask
 |ğ
št_mask
;

928 
v®
 = 
	`ıu_to_Ë32
(
td
.
ù¾
);

929 
	`pci_dma_wr™e
(&
s
->
dev
, (
lšk
 & ~0xfè+ 4, &
v®
, (val));

930 
	`uhci_async_ä“
(
async
);

932 
async
->
dÚe
 = 1;

933 ià(
s
->
äame_by‹s
 < s->
äame_bªdwidth
) {

934 
	`qemu_bh_scheduË
(
s
->
bh
);

937 
	}
}

939 
	$is_v®id
(
ušt32_t
 
lšk
)

941  (
lšk
 & 1) == 0;

942 
	}
}

944 
	$is_qh
(
ušt32_t
 
lšk
)

946  (
lšk
 & 2) != 0;

947 
	}
}

949 
	$d•th_fœ¡
(
ušt32_t
 
lšk
)

951  (
lšk
 & 4) != 0;

952 
	}
}

955 
	#UHCI_MAX_QUEUES
 128

	)

957 
ušt32_t
 
	maddr
[
UHCI_MAX_QUEUES
];

958 
	mcouÁ
;

959 } 
	tQhDb
;

961 
	$qhdb_»£t
(
QhDb
 *
db
)

963 
db
->
couÁ
 = 0;

964 
	}
}

967 
	$qhdb_š£¹
(
QhDb
 *
db
, 
ušt32_t
 
addr
)

969 
i
;

970 
i
 = 0; i < 
db
->
couÁ
; i++)

971 ià(
db
->
addr
[
i
] ==‡ddr)

974 ià(
db
->
couÁ
 >ğ
UHCI_MAX_QUEUES
)

977 
db
->
addr
[db->
couÁ
++] =‡ddr;

979 
	}
}

981 
	$uhci_fl_queue
(
UHCIS‹
 *
s
, 
UHCI_TD
 *
td
)

983 
ušt32_t
 
št_mask
 = 0;

984 
ušt32_t
 
¶šk
 = 
td
->
lšk
;

985 
ušt32_t
 
tok’
 = 
	`uhci_queue_tok’
(
td
);

986 
UHCI_TD
 
±d
;

987 
»t
;

989 
	`is_v®id
(
¶šk
)) {

990 
	`pci_dma_»ad
(&
s
->
dev
, 
¶šk
 & ~0xf, &
±d
, (ptd));

991 
	`Ë32_to_ıus
(&
±d
.
lšk
);

992 
	`Ë32_to_ıus
(&
±d
.
ù¾
);

993 
	`Ë32_to_ıus
(&
±d
.
tok’
);

994 
	`Ë32_to_ıus
(&
±d
.
bufãr
);

995 ià(!(
±d
.
ù¾
 & 
TD_CTRL_ACTIVE
)) {

998 ià(
	`uhci_queue_tok’
(&
±d
è!ğ
tok’
) {

1001 
	`Œaû_usb_uhci_td_queue
(
¶šk
 & ~0xf, 
±d
.
ù¾
,…td.
tok’
);

1002 
»t
 = 
	`uhci_hªdË_td
(
s
, 
¶šk
, &
±d
, &
št_mask
, 
Œue
);

1003 ià(
»t
 =ğ
TD_RESULT_ASYNC_CONT
) {

1006 
	`as£¹
(
»t
 =ğ
TD_RESULT_ASYNC_START
);

1007 
	`as£¹
(
št_mask
 == 0);

1008 
¶šk
 = 
±d
.
lšk
;

1010 
	}
}

1012 
	$uhci_´oûss_äame
(
UHCIS‹
 *
s
)

1014 
ušt32_t
 
äame_addr
, 
lšk
, 
Şd_td_ù¾
, 
v®
, 
št_mask
;

1015 
ušt32_t
 
cu¼_qh
, 
td_couÁ
 = 0;

1016 
út
, 
»t
;

1017 
UHCI_TD
 
td
;

1018 
UHCI_QH
 
qh
;

1019 
QhDb
 
qhdb
;

1021 
äame_addr
 = 
s
->
æ_ba£_addr
 + ((s->
änum
 & 0x3ff) << 2);

1023 
	`pci_dma_»ad
(&
s
->
dev
, 
äame_addr
, &
lšk
, 4);

1024 
	`Ë32_to_ıus
(&
lšk
);

1026 
št_mask
 = 0;

1027 
cu¼_qh
 = 0;

1029 
	`qhdb_»£t
(&
qhdb
);

1031 
út
 = 
FRAME_MAX_LOOPS
; 
	`is_v®id
(
lšk
) && cnt; cnt--) {

1032 ià(
s
->
äame_by‹s
 >ğs->
äame_bªdwidth
) {

1035 
	`Œaû_usb_uhci_äame_¡İ_bªdwidth
();

1038 ià(
	`is_qh
(
lšk
)) {

1040 
	`Œaû_usb_uhci_qh_lßd
(
lšk
 & ~0xf);

1042 ià(
	`qhdb_š£¹
(&
qhdb
, 
lšk
)) {

1050 ià(
td_couÁ
 == 0) {

1051 
	`Œaû_usb_uhci_äame_loİ_¡İ_idË
();

1054 
	`Œaû_usb_uhci_äame_loİ_cÚtšue
();

1055 
td_couÁ
 = 0;

1056 
	`qhdb_»£t
(&
qhdb
);

1057 
	`qhdb_š£¹
(&
qhdb
, 
lšk
);

1061 
	`pci_dma_»ad
(&
s
->
dev
, 
lšk
 & ~0xf, &
qh
, (qh));

1062 
	`Ë32_to_ıus
(&
qh
.
lšk
);

1063 
	`Ë32_to_ıus
(&
qh
.
–_lšk
);

1065 ià(!
	`is_v®id
(
qh
.
–_lšk
)) {

1067 
cu¼_qh
 = 0;

1068 
lšk
 = 
qh
.link;

1071 
cu¼_qh
 = 
lšk
;

1072 
lšk
 = 
qh
.
–_lšk
;

1078 
	`pci_dma_»ad
(&
s
->
dev
, 
lšk
 & ~0xf, &
td
, (td));

1079 
	`Ë32_to_ıus
(&
td
.
lšk
);

1080 
	`Ë32_to_ıus
(&
td
.
ù¾
);

1081 
	`Ë32_to_ıus
(&
td
.
tok’
);

1082 
	`Ë32_to_ıus
(&
td
.
bufãr
);

1083 
	`Œaû_usb_uhci_td_lßd
(
cu¼_qh
 & ~0xf, 
lšk
 & ~0xf, 
td
.
ù¾
,d.
tok’
);

1085 
Şd_td_ù¾
 = 
td
.
ù¾
;

1086 
»t
 = 
	`uhci_hªdË_td
(
s
, 
lšk
, &
td
, &
št_mask
, 
çl£
);

1087 ià(
Şd_td_ù¾
 !ğ
td
.
ù¾
) {

1089 
v®
 = 
	`ıu_to_Ë32
(
td
.
ù¾
);

1090 
	`pci_dma_wr™e
(&
s
->
dev
, (
lšk
 & ~0xfè+ 4, &
v®
, (val));

1093 
»t
) {

1094 
TD_RESULT_STOP_FRAME
:

1095 
out
;

1097 
TD_RESULT_NEXT_QH
:

1098 
TD_RESULT_ASYNC_CONT
:

1099 
	`Œaû_usb_uhci_td_Ãxtqh
(
cu¼_qh
 & ~0xf, 
lšk
 & ~0xf);

1100 
lšk
 = 
cu¼_qh
 ? 
qh
.lšk : 
td
.link;

1103 
TD_RESULT_ASYNC_START
:

1104 
	`Œaû_usb_uhci_td_async
(
cu¼_qh
 & ~0xf, 
lšk
 & ~0xf);

1105 ià(
	`is_v®id
(
td
.
lšk
)) {

1106 
	`uhci_fl_queue
(
s
, &
td
);

1108 
lšk
 = 
cu¼_qh
 ? 
qh
.lšk : 
td
.link;

1111 
TD_RESULT_COMPLETE
:

1112 
	`Œaû_usb_uhci_td_com¶‘e
(
cu¼_qh
 & ~0xf, 
lšk
 & ~0xf);

1113 
lšk
 = 
td
.link;

1114 
td_couÁ
++;

1115 
s
->
äame_by‹s
 +ğ(
td
.
ù¾
 & 0x7ff) + 1;

1117 ià(
cu¼_qh
) {

1119 
qh
.
–_lšk
 = 
lšk
;

1120 
v®
 = 
	`ıu_to_Ë32
(
qh
.
–_lšk
);

1121 
	`pci_dma_wr™e
(&
s
->
dev
, (
cu¼_qh
 & ~0xfè+ 4, &
v®
, (val));

1123 ià(!
	`d•th_fœ¡
(
lšk
)) {

1125 
cu¼_qh
 = 0;

1126 
lšk
 = 
qh
.link;

1132 
	`as£¹
(!"unknown„eturn code");

1138 
out
:

1139 
s
->
³ndšg_št_mask
 |ğ
št_mask
;

1140 
	}
}

1142 
	$uhci_bh
(*
İaque
)

1144 
UHCIS‹
 *
s
 = 
İaque
;

1145 
	`uhci_´oûss_äame
(
s
);

1146 
	}
}

1148 
	$uhci_äame_tim”
(*
İaque
)

1150 
UHCIS‹
 *
s
 = 
İaque
;

1153 
s
->
expœe_time
 +ğ(
	`g‘_ticks_³r_£c
(è/ 
FRAME_TIMER_FREQ
);

1154 
s
->
äame_by‹s
 = 0;

1155 
	`qemu_bh_ÿnûl
(
s
->
bh
);

1157 ià(!(
s
->
cmd
 & 
UHCI_CMD_RS
)) {

1159 
	`Œaû_usb_uhci_scheduË_¡İ
();

1160 
	`qemu_d–_tim”
(
s
->
äame_tim”
);

1161 
	`uhci_async_ÿnûl_®l
(
s
);

1163 
s
->
¡©us
 |ğ
UHCI_STS_HCHALTED
;

1168 ià(
s
->
³ndšg_št_mask
) {

1169 
s
->
¡©us2
 |ğs->
³ndšg_št_mask
;

1170 
s
->
¡©us
 |ğ
UHCI_STS_USBINT
;

1171 
	`uhci_upd©e_œq
(
s
);

1173 
s
->
³ndšg_št_mask
 = 0;

1176 
s
->
änum
 = (s->frnum + 1) & 0x7ff;

1178 
	`Œaû_usb_uhci_äame_¡¬t
(
s
->
änum
);

1180 
	`uhci_async_v®id©e_begš
(
s
);

1182 
	`uhci_´oûss_äame
(
s
);

1184 
	`uhci_async_v®id©e_’d
(
s
);

1186 
	`qemu_mod_tim”
(
s
->
äame_tim”
, s->
expœe_time
);

1187 
	}
}

1189 cÚ¡ 
MemÜyRegiÚPÜtio
 
	guhci_pÜtio
[] = {

1190 { 0, 32, 2, .
wr™e
 = 
uhci_iİÜt_wr™ew
, },

1191 { 0, 32, 2, .
	g»ad
 = 
uhci_iİÜt_»adw
, },

1192 { 0, 32, 4, .
	gwr™e
 = 
uhci_iİÜt_wr™–
, },

1193 { 0, 32, 4, .
	g»ad
 = 
uhci_iİÜt_»adl
, },

1194 { 0, 32, 1, .
	gwr™e
 = 
uhci_iİÜt_wr™eb
, },

1195 { 0, 32, 1, .
	g»ad
 = 
uhci_iİÜt_»adb
, },

1196 
PORTIO_END_OF_LIST
()

1199 cÚ¡ 
MemÜyRegiÚOps
 
	guhci_iİÜt_İs
 = {

1200 .
Şd_pÜtio
 = 
uhci_pÜtio
,

1203 
USBPÜtOps
 
	guhci_pÜt_İs
 = {

1204 .
©ch
 = 
uhci_©ch
,

1205 .
	gd‘ach
 = 
uhci_d‘ach
,

1206 .
	gchd_d‘ach
 = 
uhci_chd_d‘ach
,

1207 .
	gwakeup
 = 
uhci_wakeup
,

1208 .
	gcom¶‘e
 = 
uhci_async_com¶‘e
,

1211 
USBBusOps
 
	guhci_bus_İs
 = {

1214 
	$usb_uhci_commÚ_š™â
(
PCIDeviû
 *
dev
)

1216 
PCIDeviûCÏss
 *
pc
 = 
	`PCI_DEVICE_GET_CLASS
(
dev
);

1217 
UHCIS‹
 *
s
 = 
	`DO_UPCAST
(UHCIS‹, 
dev
, dev);

1218 
ušt8_t
 *
pci_cÚf
 = 
s
->
dev
.
cÚfig
;

1219 
i
;

1221 
pci_cÚf
[
PCI_CLASS_PROG
] = 0x00;

1223 
pci_cÚf
[
USB_SBRN
] = 
USB_RELEASE_1
;

1225 
pc
->
deviû_id
) {

1226 
PCI_DEVICE_ID_INTEL_82801I_UHCI1
:

1227 
s
->
œq_pš
 = 0;

1229 
PCI_DEVICE_ID_INTEL_82801I_UHCI2
:

1230 
s
->
œq_pš
 = 1;

1232 
PCI_DEVICE_ID_INTEL_82801I_UHCI3
:

1233 
s
->
œq_pš
 = 2;

1236 
s
->
œq_pš
 = 3;

1239 
	`pci_cÚfig_£t_š‹¼u±_pš
(
pci_cÚf
, 
s
->
œq_pš
 + 1);

1241 ià(
s
->
ma¡”bus
) {

1242 
USBPÜt
 *
pÜts
[
NB_PORTS
];

1243 
i
 = 0; i < 
NB_PORTS
; i++) {

1244 
pÜts
[
i
] = &
s
->pÜts[i].
pÜt
;

1246 ià(
	`usb_»gi¡”_com·niÚ
(
s
->
ma¡”bus
, 
pÜts
, 
NB_PORTS
,

1247 
s
->
fœ¡pÜt
, s, &
uhci_pÜt_İs
,

1248 
USB_SPEED_MASK_LOW
 | 
USB_SPEED_MASK_FULL
) != 0) {

1252 
	`usb_bus_Ãw
(&
s
->
bus
, &
uhci_bus_İs
, &s->
dev
.
qdev
);

1253 
i
 = 0; i < 
NB_PORTS
; i++) {

1254 
	`usb_»gi¡”_pÜt
(&
s
->
bus
, &s->
pÜts
[
i
].
pÜt
, s, i, &
uhci_pÜt_İs
,

1255 
USB_SPEED_MASK_LOW
 | 
USB_SPEED_MASK_FULL
);

1258 
s
->
bh
 = 
	`qemu_bh_Ãw
(
uhci_bh
, s);

1259 
s
->
äame_tim”
 = 
	`qemu_Ãw_tim”_ns
(
vm_şock
, 
uhci_äame_tim”
, s);

1260 
s
->
num_pÜts_vm¡©e
 = 
NB_PORTS
;

1261 
	`QTAILQ_INIT
(&
s
->
queues
);

1263 
	`qemu_»gi¡”_»£t
(
uhci_»£t
, 
s
);

1265 
	`memÜy_»giÚ_š™_io
(&
s
->
io_b¬
, &
uhci_iİÜt_İs
, s, "uhci", 0x20);

1268 
	`pci_»gi¡”_b¬
(&
s
->
dev
, 4, 
PCI_BASE_ADDRESS_SPACE_IO
, &s->
io_b¬
);

1271 
	}
}

1273 
	$usb_uhci_vt82c686b_š™â
(
PCIDeviû
 *
dev
)

1275 
UHCIS‹
 *
s
 = 
	`DO_UPCAST
(UHCIS‹, 
dev
, dev);

1276 
ušt8_t
 *
pci_cÚf
 = 
s
->
dev
.
cÚfig
;

1279 
	`pci_£t_lÚg
(
pci_cÚf
 + 0x40,0x00001000);

1281 
	`pci_£t_lÚg
(
pci_cÚf
 + 0x80,0x00020001);

1283 
	`pci_£t_lÚg
(
pci_cÚf
 + 0xc0,0x00002000);

1285  
	`usb_uhci_commÚ_š™â
(
dev
);

1286 
	}
}

1288 
	$usb_uhci_ex™
(
PCIDeviû
 *
dev
)

1290 
UHCIS‹
 *
s
 = 
	`DO_UPCAST
(UHCIS‹, 
dev
, dev);

1292 
	`memÜy_»giÚ_de¡roy
(&
s
->
io_b¬
);

1293 
	}
}

1295 
Prİ”ty
 
	guhci_´İ”t›s
[] = {

1296 
DEFINE_PROP_STRING
("ma¡”bus", 
UHCIS‹
, 
ma¡”bus
),

1297 
DEFINE_PROP_UINT32
("fœ¡pÜt", 
UHCIS‹
, 
fœ¡pÜt
, 0),

1298 
DEFINE_PROP_UINT32
("bªdwidth", 
UHCIS‹
, 
äame_bªdwidth
, 1280),

1299 
DEFINE_PROP_END_OF_LIST
(),

1302 
	$piix3_uhci_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1304 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1305 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

1307 
k
->
š™
 = 
usb_uhci_commÚ_š™â
;

1308 
k
->
ex™
 = 
usb_uhci_ex™
;

1309 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_INTEL
;

1310 
k
->
deviû_id
 = 
PCI_DEVICE_ID_INTEL_82371SB_2
;

1311 
k
->
»visiÚ
 = 0x01;

1312 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

1313 
dc
->
vmsd
 = &
vm¡©e_uhci
;

1314 
dc
->
´İs
 = 
uhci_´İ”t›s
;

1315 
	}
}

1317 
Ty³Info
 
	gpiix3_uhci_šfo
 = {

1318 .
Çme
 = "piix3-usb-uhci",

1319 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

1320 .
	gš¡ªû_size
 = (
UHCIS‹
),

1321 .
	gşass_š™
 = 
piix3_uhci_şass_š™
,

1324 
	$piix4_uhci_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1326 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1327 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

1329 
k
->
š™
 = 
usb_uhci_commÚ_š™â
;

1330 
k
->
ex™
 = 
usb_uhci_ex™
;

1331 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_INTEL
;

1332 
k
->
deviû_id
 = 
PCI_DEVICE_ID_INTEL_82371AB_2
;

1333 
k
->
»visiÚ
 = 0x01;

1334 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

1335 
dc
->
vmsd
 = &
vm¡©e_uhci
;

1336 
dc
->
´İs
 = 
uhci_´İ”t›s
;

1337 
	}
}

1339 
Ty³Info
 
	gpiix4_uhci_šfo
 = {

1340 .
Çme
 = "piix4-usb-uhci",

1341 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

1342 .
	gš¡ªû_size
 = (
UHCIS‹
),

1343 .
	gşass_š™
 = 
piix4_uhci_şass_š™
,

1346 
	$vt82c686b_uhci_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1348 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1349 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

1351 
k
->
š™
 = 
usb_uhci_vt82c686b_š™â
;

1352 
k
->
ex™
 = 
usb_uhci_ex™
;

1353 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_VIA
;

1354 
k
->
deviû_id
 = 
PCI_DEVICE_ID_VIA_UHCI
;

1355 
k
->
»visiÚ
 = 0x01;

1356 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

1357 
dc
->
vmsd
 = &
vm¡©e_uhci
;

1358 
dc
->
´İs
 = 
uhci_´İ”t›s
;

1359 
	}
}

1361 
Ty³Info
 
	gvt82c686b_uhci_šfo
 = {

1362 .
Çme
 = "vt82c686b-usb-uhci",

1363 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

1364 .
	gš¡ªû_size
 = (
UHCIS‹
),

1365 .
	gşass_š™
 = 
vt82c686b_uhci_şass_š™
,

1368 
	$ich9_uhci1_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1370 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1371 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

1373 
k
->
š™
 = 
usb_uhci_commÚ_š™â
;

1374 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_INTEL
;

1375 
k
->
deviû_id
 = 
PCI_DEVICE_ID_INTEL_82801I_UHCI1
;

1376 
k
->
»visiÚ
 = 0x03;

1377 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

1378 
dc
->
vmsd
 = &
vm¡©e_uhci
;

1379 
dc
->
´İs
 = 
uhci_´İ”t›s
;

1380 
	}
}

1382 
Ty³Info
 
	gich9_uhci1_šfo
 = {

1383 .
Çme
 = "ich9-usb-uhci1",

1384 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

1385 .
	gš¡ªû_size
 = (
UHCIS‹
),

1386 .
	gşass_š™
 = 
ich9_uhci1_şass_š™
,

1389 
	$ich9_uhci2_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1391 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1392 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

1394 
k
->
š™
 = 
usb_uhci_commÚ_š™â
;

1395 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_INTEL
;

1396 
k
->
deviû_id
 = 
PCI_DEVICE_ID_INTEL_82801I_UHCI2
;

1397 
k
->
»visiÚ
 = 0x03;

1398 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

1399 
dc
->
vmsd
 = &
vm¡©e_uhci
;

1400 
dc
->
´İs
 = 
uhci_´İ”t›s
;

1401 
	}
}

1403 
Ty³Info
 
	gich9_uhci2_šfo
 = {

1404 .
Çme
 = "ich9-usb-uhci2",

1405 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

1406 .
	gš¡ªû_size
 = (
UHCIS‹
),

1407 .
	gşass_š™
 = 
ich9_uhci2_şass_š™
,

1410 
	$ich9_uhci3_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1412 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1413 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

1415 
k
->
š™
 = 
usb_uhci_commÚ_š™â
;

1416 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_INTEL
;

1417 
k
->
deviû_id
 = 
PCI_DEVICE_ID_INTEL_82801I_UHCI3
;

1418 
k
->
»visiÚ
 = 0x03;

1419 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

1420 
dc
->
vmsd
 = &
vm¡©e_uhci
;

1421 
dc
->
´İs
 = 
uhci_´İ”t›s
;

1422 
	}
}

1424 
Ty³Info
 
	gich9_uhci3_šfo
 = {

1425 .
Çme
 = "ich9-usb-uhci3",

1426 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

1427 .
	gš¡ªû_size
 = (
UHCIS‹
),

1428 .
	gşass_š™
 = 
ich9_uhci3_şass_š™
,

1431 
	$uhci_»gi¡”_ty³s
()

1433 
	`ty³_»gi¡”_¡©ic
(&
piix3_uhci_šfo
);

1434 
	`ty³_»gi¡”_¡©ic
(&
piix4_uhci_šfo
);

1435 
	`ty³_»gi¡”_¡©ic
(&
vt82c686b_uhci_šfo
);

1436 
	`ty³_»gi¡”_¡©ic
(&
ich9_uhci1_šfo
);

1437 
	`ty³_»gi¡”_¡©ic
(&
ich9_uhci2_šfo
);

1438 
	`ty³_»gi¡”_¡©ic
(&
ich9_uhci3_šfo
);

1439 
	}
}

1441 
ty³_š™
(
uhci_»gi¡”_ty³s
)

	@hcd-xhci.c

21 
	~"hw/hw.h
"

22 
	~"qemu-tim”.h
"

23 
	~"hw/usb.h
"

24 
	~"hw/pci.h
"

25 
	~"hw/msi.h
"

26 
	~"Œaû.h
"

31 #ifdeà
DEBUG_XHCI


32 
	#DPRINTF
(...è
	`årštf
(
¡d”r
, 
__VA_ARGS__
)

	)

34 
	#DPRINTF
(...èdØ{} 0)

	)

36 
	#FIXME
(èdØ{ 
	`årštf
(
¡d”r
, "FIXME %s:%d\n", \

37 
__func__
, 
__LINE__
); 
	`abÜt
(); } 0)

	)

39 
	#MAXSLOTS
 8

	)

40 
	#MAXINTRS
 1

	)

42 
	#USB2_PORTS
 4

	)

43 
	#USB3_PORTS
 4

	)

45 
	#MAXPORTS
 (
USB2_PORTS
+
USB3_PORTS
)

	)

47 
	#TD_QUEUE
 24

	)

48 
	#BG_XFERS
 8

	)

49 
	#BG_PKTS
 8

	)

52 
	#EV_QUEUE
 (((3*
TD_QUEUE
)+16)*
MAXSLOTS
)

	)

55 
	#ER_FULL_HACK


	)

57 
	#LEN_CAP
 0x40

	)

58 
	#OFF_OPER
 
LEN_CAP


	)

59 
	#LEN_OPER
 (0x400 + 0x10 * 
MAXPORTS
)

	)

60 
	#OFF_RUNTIME
 ((
OFF_OPER
 + 
LEN_OPER
 + 0x20è& ~0x1f)

	)

61 
	#LEN_RUNTIME
 (0x20 + 
MAXINTRS
 * 0x20)

	)

62 
	#OFF_DOORBELL
 (
OFF_RUNTIME
 + 
LEN_RUNTIME
)

	)

63 
	#LEN_DOORBELL
 ((
MAXSLOTS
 + 1è* 0x20)

	)

66 
	#LEN_REGS
 0x2000

	)

68 #ià(
OFF_DOORBELL
 + 
LEN_DOORBELL
è> 
LEN_REGS


69 #”rÜ 
Inü—£
 
LEN_REGS


72 #ià
MAXINTRS
 > 1

73 #”rÜ 
TODO
: 
Úly
 
Úe
 
š‹¼u±”
 
suµÜ‹d


77 
	#USBCMD_RS
 (1<<0)

	)

78 
	#USBCMD_HCRST
 (1<<1)

	)

79 
	#USBCMD_INTE
 (1<<2)

	)

80 
	#USBCMD_HSEE
 (1<<3)

	)

81 
	#USBCMD_LHCRST
 (1<<7)

	)

82 
	#USBCMD_CSS
 (1<<8)

	)

83 
	#USBCMD_CRS
 (1<<9)

	)

84 
	#USBCMD_EWE
 (1<<10)

	)

85 
	#USBCMD_EU3S
 (1<<11)

	)

87 
	#USBSTS_HCH
 (1<<0)

	)

88 
	#USBSTS_HSE
 (1<<2)

	)

89 
	#USBSTS_EINT
 (1<<3)

	)

90 
	#USBSTS_PCD
 (1<<4)

	)

91 
	#USBSTS_SSS
 (1<<8)

	)

92 
	#USBSTS_RSS
 (1<<9)

	)

93 
	#USBSTS_SRE
 (1<<10)

	)

94 
	#USBSTS_CNR
 (1<<11)

	)

95 
	#USBSTS_HCE
 (1<<12)

	)

98 
	#PORTSC_CCS
 (1<<0)

	)

99 
	#PORTSC_PED
 (1<<1)

	)

100 
	#PORTSC_OCA
 (1<<3)

	)

101 
	#PORTSC_PR
 (1<<4)

	)

102 
	#PORTSC_PLS_SHIFT
 5

	)

103 
	#PORTSC_PLS_MASK
 0xf

	)

104 
	#PORTSC_PP
 (1<<9)

	)

105 
	#PORTSC_SPEED_SHIFT
 10

	)

106 
	#PORTSC_SPEED_MASK
 0xf

	)

107 
	#PORTSC_SPEED_FULL
 (1<<10)

	)

108 
	#PORTSC_SPEED_LOW
 (2<<10)

	)

109 
	#PORTSC_SPEED_HIGH
 (3<<10)

	)

110 
	#PORTSC_SPEED_SUPER
 (4<<10)

	)

111 
	#PORTSC_PIC_SHIFT
 14

	)

112 
	#PORTSC_PIC_MASK
 0x3

	)

113 
	#PORTSC_LWS
 (1<<16)

	)

114 
	#PORTSC_CSC
 (1<<17)

	)

115 
	#PORTSC_PEC
 (1<<18)

	)

116 
	#PORTSC_WRC
 (1<<19)

	)

117 
	#PORTSC_OCC
 (1<<20)

	)

118 
	#PORTSC_PRC
 (1<<21)

	)

119 
	#PORTSC_PLC
 (1<<22)

	)

120 
	#PORTSC_CEC
 (1<<23)

	)

121 
	#PORTSC_CAS
 (1<<24)

	)

122 
	#PORTSC_WCE
 (1<<25)

	)

123 
	#PORTSC_WDE
 (1<<26)

	)

124 
	#PORTSC_WOE
 (1<<27)

	)

125 
	#PORTSC_DR
 (1<<30)

	)

126 
	#PORTSC_WPR
 (1<<31)

	)

128 
	#CRCR_RCS
 (1<<0)

	)

129 
	#CRCR_CS
 (1<<1)

	)

130 
	#CRCR_CA
 (1<<2)

	)

131 
	#CRCR_CRR
 (1<<3)

	)

133 
	#IMAN_IP
 (1<<0)

	)

134 
	#IMAN_IE
 (1<<1)

	)

136 
	#ERDP_EHB
 (1<<3)

	)

138 
	#TRB_SIZE
 16

	)

139 
	sXHCITRB
 {

140 
ušt64_t
 
	m·¿m‘”
;

141 
ušt32_t
 
	m¡©us
;

142 
ušt32_t
 
	mcÚŒŞ
;

143 
dma_addr_t
 
	maddr
;

144 
boŞ
 
	mccs
;

145 } 
	tXHCITRB
;

148 
	eTRBTy³
 {

149 
	mTRB_RESERVED
 = 0,

150 
	mTR_NORMAL
,

151 
	mTR_SETUP
,

152 
	mTR_DATA
,

153 
	mTR_STATUS
,

154 
	mTR_ISOCH
,

155 
	mTR_LINK
,

156 
	mTR_EVDATA
,

157 
	mTR_NOOP
,

158 
	mCR_ENABLE_SLOT
,

159 
	mCR_DISABLE_SLOT
,

160 
	mCR_ADDRESS_DEVICE
,

161 
	mCR_CONFIGURE_ENDPOINT
,

162 
	mCR_EVALUATE_CONTEXT
,

163 
	mCR_RESET_ENDPOINT
,

164 
	mCR_STOP_ENDPOINT
,

165 
	mCR_SET_TR_DEQUEUE
,

166 
	mCR_RESET_DEVICE
,

167 
	mCR_FORCE_EVENT
,

168 
	mCR_NEGOTIATE_BW
,

169 
	mCR_SET_LATENCY_TOLERANCE
,

170 
	mCR_GET_PORT_BANDWIDTH
,

171 
	mCR_FORCE_HEADER
,

172 
	mCR_NOOP
,

173 
	mER_TRANSFER
 = 32,

174 
	mER_COMMAND_COMPLETE
,

175 
	mER_PORT_STATUS_CHANGE
,

176 
	mER_BANDWIDTH_REQUEST
,

177 
	mER_DOORBELL
,

178 
	mER_HOST_CONTROLLER
,

179 
	mER_DEVICE_NOTIFICATION
,

180 
	mER_MFINDEX_WRAP
,

182 
	mCR_VENDOR_VIA_CHALLENGE_RESPONSE
 = 48,

183 
	mCR_VENDOR_NEC_FIRMWARE_REVISION
 = 49,

184 
	mCR_VENDOR_NEC_CHALLENGE_RESPONSE
 = 50,

185 } 
	tTRBTy³
;

187 
	#CR_LINK
 
TR_LINK


	)

189 
	eTRBCCode
 {

190 
	mCC_INVALID
 = 0,

191 
	mCC_SUCCESS
,

192 
	mCC_DATA_BUFFER_ERROR
,

193 
	mCC_BABBLE_DETECTED
,

194 
	mCC_USB_TRANSACTION_ERROR
,

195 
	mCC_TRB_ERROR
,

196 
	mCC_STALL_ERROR
,

197 
	mCC_RESOURCE_ERROR
,

198 
	mCC_BANDWIDTH_ERROR
,

199 
	mCC_NO_SLOTS_ERROR
,

200 
	mCC_INVALID_STREAM_TYPE_ERROR
,

201 
	mCC_SLOT_NOT_ENABLED_ERROR
,

202 
	mCC_EP_NOT_ENABLED_ERROR
,

203 
	mCC_SHORT_PACKET
,

204 
	mCC_RING_UNDERRUN
,

205 
	mCC_RING_OVERRUN
,

206 
	mCC_VF_ER_FULL
,

207 
	mCC_PARAMETER_ERROR
,

208 
	mCC_BANDWIDTH_OVERRUN
,

209 
	mCC_CONTEXT_STATE_ERROR
,

210 
	mCC_NO_PING_RESPONSE_ERROR
,

211 
	mCC_EVENT_RING_FULL_ERROR
,

212 
	mCC_INCOMPATIBLE_DEVICE_ERROR
,

213 
	mCC_MISSED_SERVICE_ERROR
,

214 
	mCC_COMMAND_RING_STOPPED
,

215 
	mCC_COMMAND_ABORTED
,

216 
	mCC_STOPPED
,

217 
	mCC_STOPPED_LENGTH_INVALID
,

218 
	mCC_MAX_EXIT_LATENCY_TOO_LARGE_ERROR
 = 29,

219 
	mCC_ISOCH_BUFFER_OVERRUN
 = 31,

220 
	mCC_EVENT_LOST_ERROR
,

221 
	mCC_UNDEFINED_ERROR
,

222 
	mCC_INVALID_STREAM_ID_ERROR
,

223 
	mCC_SECONDARY_BANDWIDTH_ERROR
,

224 
	mCC_SPLIT_TRANSACTION_ERROR


225 } 
	tTRBCCode
;

227 
	#TRB_C
 (1<<0)

	)

228 
	#TRB_TYPE_SHIFT
 10

	)

229 
	#TRB_TYPE_MASK
 0x3f

	)

230 
	#TRB_TYPE
(
t
è((Ñ).
cÚŒŞ
 >> 
TRB_TYPE_SHIFT
è& 
TRB_TYPE_MASK
)

	)

232 
	#TRB_EV_ED
 (1<<2)

	)

234 
	#TRB_TR_ENT
 (1<<1)

	)

235 
	#TRB_TR_ISP
 (1<<2)

	)

236 
	#TRB_TR_NS
 (1<<3)

	)

237 
	#TRB_TR_CH
 (1<<4)

	)

238 
	#TRB_TR_IOC
 (1<<5)

	)

239 
	#TRB_TR_IDT
 (1<<6)

	)

240 
	#TRB_TR_TBC_SHIFT
 7

	)

241 
	#TRB_TR_TBC_MASK
 0x3

	)

242 
	#TRB_TR_BEI
 (1<<9)

	)

243 
	#TRB_TR_TLBPC_SHIFT
 16

	)

244 
	#TRB_TR_TLBPC_MASK
 0xf

	)

245 
	#TRB_TR_FRAMEID_SHIFT
 20

	)

246 
	#TRB_TR_FRAMEID_MASK
 0x7ff

	)

247 
	#TRB_TR_SIA
 (1<<31)

	)

249 
	#TRB_TR_DIR
 (1<<16)

	)

251 
	#TRB_CR_SLOTID_SHIFT
 24

	)

252 
	#TRB_CR_SLOTID_MASK
 0xff

	)

253 
	#TRB_CR_EPID_SHIFT
 16

	)

254 
	#TRB_CR_EPID_MASK
 0x1f

	)

256 
	#TRB_CR_BSR
 (1<<9)

	)

257 
	#TRB_CR_DC
 (1<<9)

	)

259 
	#TRB_LK_TC
 (1<<1)

	)

261 
	#EP_TYPE_MASK
 0x7

	)

262 
	#EP_TYPE_SHIFT
 3

	)

264 
	#EP_STATE_MASK
 0x7

	)

265 
	#EP_DISABLED
 (0<<0)

	)

266 
	#EP_RUNNING
 (1<<0)

	)

267 
	#EP_HALTED
 (2<<0)

	)

268 
	#EP_STOPPED
 (3<<0)

	)

269 
	#EP_ERROR
 (4<<0)

	)

271 
	#SLOT_STATE_MASK
 0x1f

	)

272 
	#SLOT_STATE_SHIFT
 27

	)

273 
	#SLOT_STATE
(
s
è(((s)>>
SLOT_STATE_SHIFT
)&
SLOT_STATE_MASK
)

	)

274 
	#SLOT_ENABLED
 0

	)

275 
	#SLOT_DEFAULT
 1

	)

276 
	#SLOT_ADDRESSED
 2

	)

277 
	#SLOT_CONFIGURED
 3

	)

279 
	#SLOT_CONTEXT_ENTRIES_MASK
 0x1f

	)

280 
	#SLOT_CONTEXT_ENTRIES_SHIFT
 27

	)

282 
	eEPTy³
 {

283 
	mET_INVALID
 = 0,

284 
	mET_ISO_OUT
,

285 
	mET_BULK_OUT
,

286 
	mET_INTR_OUT
,

287 
	mET_CONTROL
,

288 
	mET_ISO_IN
,

289 
	mET_BULK_IN
,

290 
	mET_INTR_IN
,

291 } 
	tEPTy³
;

293 
	sXHCIRšg
 {

294 
dma_addr_t
 
	mba£
;

295 
dma_addr_t
 
	mdequeue
;

296 
boŞ
 
	mccs
;

297 } 
	tXHCIRšg
;

299 
	sXHCIPÜt
 {

300 
USBPÜt
 
	mpÜt
;

301 
ušt32_t
 
	mpÜtsc
;

302 } 
	tXHCIPÜt
;

304 
	gXHCIS‹
;

305 
XHCIS‹
 
	tXHCIS‹
;

307 
	sXHCIT¿nsãr
 {

308 
XHCIS‹
 *
	mxhci
;

309 
USBPack‘
 
	m·ck‘
;

310 
boŞ
 
	mruÂšg_async
;

311 
boŞ
 
	mruÂšg_»Œy
;

312 
boŞ
 
	mÿnûÎed
;

313 
boŞ
 
	mcom¶‘e
;

314 
boŞ
 
	mbackgrounded
;

315 
	miso_pkts
;

316 
	m¦Ùid
;

317 
	m•id
;

318 
boŞ
 
	mš_xãr
;

319 
boŞ
 
	miso_xãr
;

320 
boŞ
 
	mbg_xãr
;

322 
	mŒb_couÁ
;

323 
	mŒb_®loûd
;

324 
XHCITRB
 *
	mŒbs
;

326 
	md©a_Ëngth
;

327 
	md©a_®loûd
;

328 
ušt8_t
 *
	md©a
;

330 
TRBCCode
 
	m¡©us
;

332 
	mpkts
;

333 
	mpktsize
;

334 
	mcur_pkt
;

335 } 
	tXHCIT¿nsãr
;

337 
	sXHCIEPCÚ‹xt
 {

338 
XHCIRšg
 
	mršg
;

339 
	mÃxt_xãr
;

340 
	mcomp_xãr
;

341 
XHCIT¿nsãr
 
	mŒªsãrs
[
TD_QUEUE
];

342 
XHCIT¿nsãr
 *
	m»Œy
;

343 
boŞ
 
	mbg_ruÂšg
;

344 
boŞ
 
	mbg_upd©šg
;

345 
	mÃxt_bg
;

346 
XHCIT¿nsãr
 
	mbg_Œªsãrs
[
BG_XFERS
];

347 
EPTy³
 
	mty³
;

348 
dma_addr_t
 
	mpùx
;

349 
	mmax_psize
;

350 
boŞ
 
	mhas_bg
;

351 
ušt32_t
 
	m¡©e
;

352 } 
	tXHCIEPCÚ‹xt
;

354 
	sXHCISlÙ
 {

355 
boŞ
 
	m’abËd
;

356 
dma_addr_t
 
	mùx
;

357 
	mpÜt
;

358 
	mdevaddr
;

359 
XHCIEPCÚ‹xt
 * 
	m•s
[31];

360 } 
	tXHCISlÙ
;

362 
	sXHCIEv’t
 {

363 
TRBTy³
 
	mty³
;

364 
TRBCCode
 
	mccode
;

365 
ušt64_t
 
	m±r
;

366 
ušt32_t
 
	mËngth
;

367 
ušt32_t
 
	mæags
;

368 
ušt8_t
 
	m¦Ùid
;

369 
ušt8_t
 
	m•id
;

370 } 
	tXHCIEv’t
;

372 
	sXHCIS‹
 {

373 
PCIDeviû
 
	mpci_dev
;

374 
USBBus
 
	mbus
;

375 
qemu_œq
 
	mœq
;

376 
MemÜyRegiÚ
 
	mmem
;

377 cÚ¡ *
	mÇme
;

378 
ušt32_t
 
	mmsi
;

379 
	mdevaddr
;

382 
ušt32_t
 
	musbcmd
;

383 
ušt32_t
 
	musb¡s
;

384 
ušt32_t
 
	mdnù¾
;

385 
ušt32_t
 
	müü_low
;

386 
ušt32_t
 
	müü_high
;

387 
ušt32_t
 
	mdcb¯p_low
;

388 
ušt32_t
 
	mdcb¯p_high
;

389 
ušt32_t
 
	mcÚfig
;

391 
XHCIPÜt
 
	mpÜts
[
MAXPORTS
];

392 
XHCISlÙ
 
	m¦Ùs
[
MAXSLOTS
];

395 
ušt32_t
 
	mmfšdex
;

397 
ušt32_t
 
	mimª
;

398 
ušt32_t
 
	mimod
;

399 
ušt32_t
 
	m”¡sz
;

400 
ušt32_t
 
	m”¡ba_low
;

401 
ušt32_t
 
	m”¡ba_high
;

402 
ušt32_t
 
	m”dp_low
;

403 
ušt32_t
 
	m”dp_high
;

405 
dma_addr_t
 
	m”_¡¬t
;

406 
ušt32_t
 
	m”_size
;

407 
boŞ
 
	m”_pcs
;

408 
	m”_•_idx
;

409 
boŞ
 
	m”_fuÎ
;

411 
XHCIEv’t
 
	mev_bufãr
[
EV_QUEUE
];

412 
	mev_bufãr_put
;

413 
	mev_bufãr_g‘
;

415 
XHCIRšg
 
	mcmd_ršg
;

418 
	sXHCIEvRšgSeg
 {

419 
ušt32_t
 
	maddr_low
;

420 
ušt32_t
 
	maddr_high
;

421 
ušt32_t
 
	msize
;

422 
ušt32_t
 
	mrsvd
;

423 } 
	tXHCIEvRšgSeg
;

425 cÚ¡ *
	gTRBTy³_Çmes
[] = {

426 [
TRB_RESERVED
] = "TRB_RESERVED",

427 [
TR_NORMAL
] = "TR_NORMAL",

428 [
TR_SETUP
] = "TR_SETUP",

429 [
TR_DATA
] = "TR_DATA",

430 [
TR_STATUS
] = "TR_STATUS",

431 [
TR_ISOCH
] = "TR_ISOCH",

432 [
TR_LINK
] = "TR_LINK",

433 [
TR_EVDATA
] = "TR_EVDATA",

434 [
TR_NOOP
] = "TR_NOOP",

435 [
CR_ENABLE_SLOT
] = "CR_ENABLE_SLOT",

436 [
CR_DISABLE_SLOT
] = "CR_DISABLE_SLOT",

437 [
CR_ADDRESS_DEVICE
] = "CR_ADDRESS_DEVICE",

438 [
CR_CONFIGURE_ENDPOINT
] = "CR_CONFIGURE_ENDPOINT",

439 [
CR_EVALUATE_CONTEXT
] = "CR_EVALUATE_CONTEXT",

440 [
CR_RESET_ENDPOINT
] = "CR_RESET_ENDPOINT",

441 [
CR_STOP_ENDPOINT
] = "CR_STOP_ENDPOINT",

442 [
CR_SET_TR_DEQUEUE
] = "CR_SET_TR_DEQUEUE",

443 [
CR_RESET_DEVICE
] = "CR_RESET_DEVICE",

444 [
CR_FORCE_EVENT
] = "CR_FORCE_EVENT",

445 [
CR_NEGOTIATE_BW
] = "CR_NEGOTIATE_BW",

446 [
CR_SET_LATENCY_TOLERANCE
] = "CR_SET_LATENCY_TOLERANCE",

447 [
CR_GET_PORT_BANDWIDTH
] = "CR_GET_PORT_BANDWIDTH",

448 [
CR_FORCE_HEADER
] = "CR_FORCE_HEADER",

449 [
CR_NOOP
] = "CR_NOOP",

450 [
ER_TRANSFER
] = "ER_TRANSFER",

451 [
ER_COMMAND_COMPLETE
] = "ER_COMMAND_COMPLETE",

452 [
ER_PORT_STATUS_CHANGE
] = "ER_PORT_STATUS_CHANGE",

453 [
ER_BANDWIDTH_REQUEST
] = "ER_BANDWIDTH_REQUEST",

454 [
ER_DOORBELL
] = "ER_DOORBELL",

455 [
ER_HOST_CONTROLLER
] = "ER_HOST_CONTROLLER",

456 [
ER_DEVICE_NOTIFICATION
] = "ER_DEVICE_NOTIFICATION",

457 [
ER_MFINDEX_WRAP
] = "ER_MFINDEX_WRAP",

458 [
CR_VENDOR_VIA_CHALLENGE_RESPONSE
] = "CR_VENDOR_VIA_CHALLENGE_RESPONSE",

459 [
CR_VENDOR_NEC_FIRMWARE_REVISION
] = "CR_VENDOR_NEC_FIRMWARE_REVISION",

460 [
CR_VENDOR_NEC_CHALLENGE_RESPONSE
] = "CR_VENDOR_NEC_CHALLENGE_RESPONSE",

463 cÚ¡ *
	$lookup_Çme
(
ušt32_t
 
šdex
, cÚ¡ **
li¡
, ušt32_ˆ
Î’
)

465 ià(
šdex
 >ğ
Î’
 || 
li¡
[šdex] =ğ
NULL
) {

468  
li¡
[
šdex
];

469 
	}
}

471 cÚ¡ *
	$Œb_Çme
(
XHCITRB
 *
Œb
)

473  
	`lookup_Çme
(
	`TRB_TYPE
(*
Œb
), 
TRBTy³_Çmes
,

474 
	`ARRAY_SIZE
(
TRBTy³_Çmes
));

475 
	}
}

477 
xhci_kick_•
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

478 
•id
);

480 
šlše
 
dma_addr_t
 
	$xhci_addr64
(
ušt32_t
 
low
, ušt32_ˆ
high
)

482 ià((
dma_addr_t
) == 4) {

483  
low
;

485  
low
 | (((
dma_addr_t
)
high
 << 16) << 16);

487 
	}
}

489 
šlše
 
dma_addr_t
 
	$xhci_mask64
(
ušt64_t
 
addr
)

491 ià((
dma_addr_t
) == 4) {

492  
addr
 & 0xffffffff;

494  
addr
;

496 
	}
}

498 
	$xhci_œq_upd©e
(
XHCIS‹
 *
xhci
)

500 
Ëv–
 = 0;

502 ià(
xhci
->
imª
 & 
IMAN_IP
 && xhci->imª & 
IMAN_IE
 &&

503 
xhci
->
usbcmd
 & 
USBCMD_INTE
) {

504 
Ëv–
 = 1;

507 ià(
xhci
->
msi
 && 
	`msi_’abËd
(&xhci->
pci_dev
)) {

508 ià(
Ëv–
) {

509 
	`Œaû_usb_xhci_œq_msi
(0);

510 
	`msi_nÙify
(&
xhci
->
pci_dev
, 0);

513 
	`Œaû_usb_xhci_œq_štx
(
Ëv–
);

514 
	`qemu_£t_œq
(
xhci
->
œq
, 
Ëv–
);

516 
	}
}

518 
šlše
 
	$xhci_ruÂšg
(
XHCIS‹
 *
xhci
)

520  !(
xhci
->
usb¡s
 & 
USBSTS_HCH
è&& !xhci->
”_fuÎ
;

521 
	}
}

523 
	$xhci_d›
(
XHCIS‹
 *
xhci
)

525 
xhci
->
usb¡s
 |ğ
USBSTS_HCE
;

526 
	`årštf
(
¡d”r
, "xhci:‡sserted controllerƒrror\n");

527 
	}
}

529 
	$xhci_wr™e_ev’t
(
XHCIS‹
 *
xhci
, 
XHCIEv’t
 *
ev’t
)

531 
XHCITRB
 
ev_Œb
;

532 
dma_addr_t
 
addr
;

534 
ev_Œb
.
·¿m‘”
 = 
	`ıu_to_Ë64
(
ev’t
->
±r
);

535 
ev_Œb
.
¡©us
 = 
	`ıu_to_Ë32
(
ev’t
->
Ëngth
 | (ev’t->
ccode
 << 24));

536 
ev_Œb
.
cÚŒŞ
 = (
ev’t
->
¦Ùid
 << 24è| (ev’t->
•id
 << 16) |

537 
ev’t
->
æags
 | (ev’t->
ty³
 << 
TRB_TYPE_SHIFT
);

538 ià(
xhci
->
”_pcs
) {

539 
ev_Œb
.
cÚŒŞ
 |ğ
TRB_C
;

541 
ev_Œb
.
cÚŒŞ
 = 
	`ıu_to_Ë32
(ev_trb.control);

543 
	`Œaû_usb_xhci_queue_ev’t
(
xhci
->
”_•_idx
, 
	`Œb_Çme
(&
ev_Œb
),

544 
ev_Œb
.
·¿m‘”
,ƒv_Œb.
¡©us
,ƒv_Œb.
cÚŒŞ
);

546 
addr
 = 
xhci
->
”_¡¬t
 + 
TRB_SIZE
*xhci->
”_•_idx
;

547 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
addr
, &
ev_Œb
, 
TRB_SIZE
);

549 
xhci
->
”_•_idx
++;

550 ià(
xhci
->
”_•_idx
 >ğxhci->
”_size
) {

551 
xhci
->
”_•_idx
 = 0;

552 
xhci
->
”_pcs
 = !xhci->er_pcs;

554 
	}
}

556 
	$xhci_ev’ts_upd©e
(
XHCIS‹
 *
xhci
)

558 
dma_addr_t
 
”dp
;

559 
dp_idx
;

560 
boŞ
 
do_œq
 = 0;

562 ià(
xhci
->
usb¡s
 & 
USBSTS_HCH
) {

566 
”dp
 = 
	`xhci_addr64
(
xhci
->
”dp_low
, xhci->
”dp_high
);

567 ià(
”dp
 < 
xhci
->
”_¡¬t
 ||

568 
”dp
 >ğ(
xhci
->
”_¡¬t
 + 
TRB_SIZE
*xhci->
”_size
)) {

569 
	`årštf
(
¡d”r
, "xhci: ERDP ouˆoàbounds: "
DMA_ADDR_FMT
"\n", 
”dp
);

570 
	`årštf
(
¡d”r
, "xhci: ER‡ˆ"
DMA_ADDR_FMT
"†en %d\n",

571 
xhci
->
”_¡¬t
, xhci->
”_size
);

572 
	`xhci_d›
(
xhci
);

575 
dp_idx
 = (
”dp
 - 
xhci
->
”_¡¬t
è/ 
TRB_SIZE
;

576 
	`as£¹
(
dp_idx
 < 
xhci
->
”_size
);

581 ià(
xhci
->
”_fuÎ
) {

582 
”_ä“
 = 
dp_idx
 - 
xhci
->
”_•_idx
;

583 ià(
”_ä“
 <= 0) {

584 
”_ä“
 +ğ
xhci
->
”_size
;

586 ià(
”_ä“
 < (
xhci
->
”_size
/2)) {

587 
	`DPRINTF
("xhci_events_update():ƒvent„ing still "

593 
xhci
->
ev_bufãr_put
 !ğxhci->
ev_bufãr_g‘
) {

594 
	`as£¹
(
xhci
->
”_fuÎ
);

595 ià(((
xhci
->
”_•_idx
+1è% xhci->
”_size
è=ğ
dp_idx
) {

596 
	`DPRINTF
("xhci_events_update():ƒvent„ing full‡gain\n");

597 #iâdeà
ER_FULL_HACK


598 
XHCIEv’t
 
fuÎ
 = {
ER_HOST_CONTROLLER
, 
CC_EVENT_RING_FULL_ERROR
};

599 
	`xhci_wr™e_ev’t
(
xhci
, &
fuÎ
);

601 
do_œq
 = 1;

604 
XHCIEv’t
 *
ev’t
 = &
xhci
->
ev_bufãr
[xhci->
ev_bufãr_g‘
];

605 
	`xhci_wr™e_ev’t
(
xhci
, 
ev’t
);

606 
xhci
->
ev_bufãr_g‘
++;

607 
do_œq
 = 1;

608 ià(
xhci
->
ev_bufãr_g‘
 =ğ
EV_QUEUE
) {

609 
xhci
->
ev_bufãr_g‘
 = 0;

613 ià(
do_œq
) {

614 
xhci
->
”dp_low
 |ğ
ERDP_EHB
;

615 
xhci
->
imª
 |ğ
IMAN_IP
;

616 
xhci
->
usb¡s
 |ğ
USBSTS_EINT
;

617 
	`xhci_œq_upd©e
(
xhci
);

620 ià(
xhci
->
”_fuÎ
 && xhci->
ev_bufãr_put
 =ğxhci->
ev_bufãr_g‘
) {

621 
	`DPRINTF
("xhci_events_update():ƒvent„ing‚o†onger full\n");

622 
xhci
->
”_fuÎ
 = 0;

625 
	}
}

627 
	$xhci_ev’t
(
XHCIS‹
 *
xhci
, 
XHCIEv’t
 *
ev’t
)

629 
dma_addr_t
 
”dp
;

630 
dp_idx
;

632 ià(
xhci
->
”_fuÎ
) {

633 
	`DPRINTF
("xhci_event(): ER full, queueing\n");

634 ià(((
xhci
->
ev_bufãr_put
+1è% 
EV_QUEUE
è=ğxhci->
ev_bufãr_g‘
) {

635 
	`årštf
(
¡d”r
, "xhci:ƒvent queue full, droppingƒvent!\n");

638 
xhci
->
ev_bufãr
[xhci->
ev_bufãr_put
++] = *
ev’t
;

639 ià(
xhci
->
ev_bufãr_put
 =ğ
EV_QUEUE
) {

640 
xhci
->
ev_bufãr_put
 = 0;

645 
”dp
 = 
	`xhci_addr64
(
xhci
->
”dp_low
, xhci->
”dp_high
);

646 ià(
”dp
 < 
xhci
->
”_¡¬t
 ||

647 
”dp
 >ğ(
xhci
->
”_¡¬t
 + 
TRB_SIZE
*xhci->
”_size
)) {

648 
	`årštf
(
¡d”r
, "xhci: ERDP ouˆoàbounds: "
DMA_ADDR_FMT
"\n", 
”dp
);

649 
	`årštf
(
¡d”r
, "xhci: ER‡ˆ"
DMA_ADDR_FMT
"†en %d\n",

650 
xhci
->
”_¡¬t
, xhci->
”_size
);

651 
	`xhci_d›
(
xhci
);

655 
dp_idx
 = (
”dp
 - 
xhci
->
”_¡¬t
è/ 
TRB_SIZE
;

656 
	`as£¹
(
dp_idx
 < 
xhci
->
”_size
);

658 ià((
xhci
->
”_•_idx
+1è% xhci->
”_size
 =ğ
dp_idx
) {

659 
	`DPRINTF
("xhci_event(): ER full, queueing\n");

660 #iâdeà
ER_FULL_HACK


661 
XHCIEv’t
 
fuÎ
 = {
ER_HOST_CONTROLLER
, 
CC_EVENT_RING_FULL_ERROR
};

662 
	`xhci_wr™e_ev’t
(
xhci
, &
fuÎ
);

664 
xhci
->
”_fuÎ
 = 1;

665 ià(((
xhci
->
ev_bufãr_put
+1è% 
EV_QUEUE
è=ğxhci->
ev_bufãr_g‘
) {

666 
	`årštf
(
¡d”r
, "xhci:ƒvent queue full, droppingƒvent!\n");

669 
xhci
->
ev_bufãr
[xhci->
ev_bufãr_put
++] = *
ev’t
;

670 ià(
xhci
->
ev_bufãr_put
 =ğ
EV_QUEUE
) {

671 
xhci
->
ev_bufãr_put
 = 0;

674 
	`xhci_wr™e_ev’t
(
xhci
, 
ev’t
);

677 
xhci
->
”dp_low
 |ğ
ERDP_EHB
;

678 
xhci
->
imª
 |ğ
IMAN_IP
;

679 
xhci
->
usb¡s
 |ğ
USBSTS_EINT
;

681 
	`xhci_œq_upd©e
(
xhci
);

682 
	}
}

684 
	$xhci_ršg_š™
(
XHCIS‹
 *
xhci
, 
XHCIRšg
 *
ršg
,

685 
dma_addr_t
 
ba£
)

687 
ršg
->
ba£
 = base;

688 
ršg
->
dequeue
 = 
ba£
;

689 
ršg
->
ccs
 = 1;

690 
	}
}

692 
TRBTy³
 
	$xhci_ršg_ãtch
(
XHCIS‹
 *
xhci
, 
XHCIRšg
 *
ršg
, 
XHCITRB
 *
Œb
,

693 
dma_addr_t
 *
addr
)

696 
TRBTy³
 
ty³
;

697 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
ršg
->
dequeue
, 
Œb
, 
TRB_SIZE
);

698 
Œb
->
addr
 = 
ršg
->
dequeue
;

699 
Œb
->
ccs
 = 
ršg
->ccs;

700 
	`Ë64_to_ıus
(&
Œb
->
·¿m‘”
);

701 
	`Ë32_to_ıus
(&
Œb
->
¡©us
);

702 
	`Ë32_to_ıus
(&
Œb
->
cÚŒŞ
);

704 
	`Œaû_usb_xhci_ãtch_Œb
(
ršg
->
dequeue
, 
	`Œb_Çme
(
Œb
),

705 
Œb
->
·¿m‘”
,rb->
¡©us
,rb->
cÚŒŞ
);

707 ià((
Œb
->
cÚŒŞ
 & 
TRB_C
è!ğ
ršg
->
ccs
) {

711 
ty³
 = 
	`TRB_TYPE
(*
Œb
);

713 ià(
ty³
 !ğ
TR_LINK
) {

714 ià(
addr
) {

715 *
addr
 = 
ršg
->
dequeue
;

717 
ršg
->
dequeue
 +ğ
TRB_SIZE
;

718  
ty³
;

720 
ršg
->
dequeue
 = 
	`xhci_mask64
(
Œb
->
·¿m‘”
);

721 ià(
Œb
->
cÚŒŞ
 & 
TRB_LK_TC
) {

722 
ršg
->
ccs
 = !ring->ccs;

726 
	}
}

728 
	$xhci_ršg_chaš_Ëngth
(
XHCIS‹
 *
xhci
, cÚ¡ 
XHCIRšg
 *
ršg
)

730 
XHCITRB
 
Œb
;

731 
Ëngth
 = 0;

732 
dma_addr_t
 
dequeue
 = 
ršg
->dequeue;

733 
boŞ
 
ccs
 = 
ršg
->ccs;

735 
boŞ
 
cÚŒŞ_td_£t
 = 0;

738 
TRBTy³
 
ty³
;

739 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
dequeue
, &
Œb
, 
TRB_SIZE
);

740 
	`Ë64_to_ıus
(&
Œb
.
·¿m‘”
);

741 
	`Ë32_to_ıus
(&
Œb
.
¡©us
);

742 
	`Ë32_to_ıus
(&
Œb
.
cÚŒŞ
);

744 ià((
Œb
.
cÚŒŞ
 & 
TRB_C
è!ğ
ccs
) {

745  -
Ëngth
;

748 
ty³
 = 
	`TRB_TYPE
(
Œb
);

750 ià(
ty³
 =ğ
TR_LINK
) {

751 
dequeue
 = 
	`xhci_mask64
(
Œb
.
·¿m‘”
);

752 ià(
Œb
.
cÚŒŞ
 & 
TRB_LK_TC
) {

753 
ccs
 = !ccs;

758 
Ëngth
 += 1;

759 
dequeue
 +ğ
TRB_SIZE
;

761 ià(
ty³
 =ğ
TR_SETUP
) {

762 
cÚŒŞ_td_£t
 = 1;

763 } ià(
ty³
 =ğ
TR_STATUS
) {

764 
cÚŒŞ_td_£t
 = 0;

767 ià(!
cÚŒŞ_td_£t
 && !(
Œb
.
cÚŒŞ
 & 
TRB_TR_CH
)) {

768  
Ëngth
;

771 
	}
}

773 
	$xhci_”_»£t
(
XHCIS‹
 *
xhci
)

775 
XHCIEvRšgSeg
 
£g
;

778 ià(
xhci
->
”¡sz
 != 1) {

779 
	`årštf
(
¡d”r
, "xhci: inv®id v®ufÜ ERSTSZ: %d\n", 
xhci
->
”¡sz
);

780 
	`xhci_d›
(
xhci
);

783 
dma_addr_t
 
”¡ba
 = 
	`xhci_addr64
(
xhci
->
”¡ba_low
, xhci->
”¡ba_high
);

784 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
”¡ba
, &
£g
, (seg));

785 
	`Ë32_to_ıus
(&
£g
.
addr_low
);

786 
	`Ë32_to_ıus
(&
£g
.
addr_high
);

787 
	`Ë32_to_ıus
(&
£g
.
size
);

788 ià(
£g
.
size
 < 16 || seg.size > 4096) {

789 
	`årštf
(
¡d”r
, "xhci: inv®id v®ufÜ segm’ˆsize: %d\n", 
£g
.
size
);

790 
	`xhci_d›
(
xhci
);

793 
xhci
->
”_¡¬t
 = 
	`xhci_addr64
(
£g
.
addr_low
, seg.
addr_high
);

794 
xhci
->
”_size
 = 
£g
.
size
;

796 
xhci
->
”_•_idx
 = 0;

797 
xhci
->
”_pcs
 = 1;

798 
xhci
->
”_fuÎ
 = 0;

800 
	`DPRINTF
("xhci:ƒv’ˆršg:" 
DMA_ADDR_FMT
 " [%d]\n",

801 
xhci
->
”_¡¬t
, xhci->
”_size
);

802 
	}
}

804 
	$xhci_run
(
XHCIS‹
 *
xhci
)

806 
	`Œaû_usb_xhci_run
();

807 
xhci
->
usb¡s
 &ğ~
USBSTS_HCH
;

808 
	}
}

810 
	$xhci_¡İ
(
XHCIS‹
 *
xhci
)

812 
	`Œaû_usb_xhci_¡İ
();

813 
xhci
->
usb¡s
 |ğ
USBSTS_HCH
;

814 
xhci
->
üü_low
 &ğ~
CRCR_CRR
;

815 
	}
}

817 
	$xhci_£t_•_¡©e
(
XHCIS‹
 *
xhci
, 
XHCIEPCÚ‹xt
 *
•ùx
,

818 
ušt32_t
 
¡©e
)

820 
ušt32_t
 
ùx
[5];

821 ià(
•ùx
->
¡©e
 == state) {

825 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
•ùx
->
pùx
, 
ùx
, (ctx));

826 
ùx
[0] &ğ~
EP_STATE_MASK
;

827 
ùx
[0] |ğ
¡©e
;

828 
ùx
[2] = 
•ùx
->
ršg
.
dequeue
 |ƒpùx->ršg.
ccs
;

829 
ùx
[3] = (
•ùx
->
ršg
.
dequeue
 >> 16) >> 16;

830 
	`DPRINTF
("xhci: s‘ƒpùx: " 
DMA_ADDR_FMT
 " state=%d dequeue=%08x%08x\n",

831 
•ùx
->
pùx
, 
¡©e
, 
ùx
[3], ctx[2]);

832 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
•ùx
->
pùx
, 
ùx
, (ctx));

833 
•ùx
->
¡©e
 = state;

834 
	}
}

836 
TRBCCode
 
	$xhci_’abË_•
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

837 
•id
, 
dma_addr_t
 
pùx
,

838 
ušt32_t
 *
ùx
)

840 
XHCISlÙ
 *
¦Ù
;

841 
XHCIEPCÚ‹xt
 *
•ùx
;

842 
dma_addr_t
 
dequeue
;

843 
i
;

845 
	`Œaû_usb_xhci_•_’abË
(
¦Ùid
, 
•id
);

846 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

847 
	`as£¹
(
•id
 >= 1 &&ƒpid <= 31);

849 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

850 ià(
¦Ù
->
•s
[
•id
-1]) {

851 
	`årštf
(
¡d”r
, "xhci: slÙ %dƒ°%d‡Ì—dyƒÇbËd!\n", 
¦Ùid
, 
•id
);

852  
CC_TRB_ERROR
;

855 
•ùx
 = 
	`g_m®loc
((
XHCIEPCÚ‹xt
));

856 
	`mem£t
(
•ùx
, 0, (
XHCIEPCÚ‹xt
));

858 
¦Ù
->
•s
[
•id
-1] = 
•ùx
;

860 
dequeue
 = 
	`xhci_addr64
(
ùx
[2] & ~0xf, ctx[3]);

861 
	`xhci_ršg_š™
(
xhci
, &
•ùx
->
ršg
, 
dequeue
);

862 
•ùx
->
ršg
.
ccs
 = 
ùx
[2] & 1;

864 
•ùx
->
ty³
 = (
ùx
[1] >> 
EP_TYPE_SHIFT
è& 
EP_TYPE_MASK
;

865 
	`DPRINTF
("xhci:ƒndpošˆ%d.%dy³ i %d\n", 
•id
/2,ƒpid%2, 
•ùx
->
ty³
);

866 
•ùx
->
pùx
 =…ctx;

867 
•ùx
->
max_psize
 = 
ùx
[1]>>16;

868 
•ùx
->
max_psize
 *ğ1+((
ùx
[1]>>8)&0xff);

869 
•ùx
->
has_bg
 = 
çl£
;

870 ià(
•ùx
->
ty³
 =ğ
ET_ISO_IN
) {

871 
•ùx
->
has_bg
 = 
Œue
;

873 
	`DPRINTF
("xhci:ƒndpoint %d.%d maxransaction (burst) size is %d\n",

874 
•id
/2,ƒpid%2, 
•ùx
->
max_psize
);

875 
i
 = 0; i < 
	`ARRAY_SIZE
(
•ùx
->
Œªsãrs
); i++) {

876 
	`usb_·ck‘_š™
(&
•ùx
->
Œªsãrs
[
i
].
·ck‘
);

879 
•ùx
->
¡©e
 = 
EP_RUNNING
;

880 
ùx
[0] &ğ~
EP_STATE_MASK
;

881 
ùx
[0] |ğ
EP_RUNNING
;

883  
CC_SUCCESS
;

884 
	}
}

886 
	$xhci_•_nuke_xãrs
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

887 
•id
)

889 
XHCISlÙ
 *
¦Ù
;

890 
XHCIEPCÚ‹xt
 *
•ùx
;

891 
i
, 
xãri
, 
kËd
 = 0;

892 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

893 
	`as£¹
(
•id
 >= 1 &&ƒpid <= 31);

895 
	`DPRINTF
("xhci_•_nuke_xãrs(%d, %d)\n", 
¦Ùid
, 
•id
);

897 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

899 ià(!
¦Ù
->
•s
[
•id
-1]) {

903 
•ùx
 = 
¦Ù
->
•s
[
•id
-1];

905 
xãri
 = 
•ùx
->
Ãxt_xãr
;

906 
i
 = 0; i < 
TD_QUEUE
; i++) {

907 
XHCIT¿nsãr
 *
t
 = &
•ùx
->
Œªsãrs
[
xãri
];

908 ià(
t
->
ruÂšg_async
) {

909 
	`usb_ÿnûl_·ck‘
(&
t
->
·ck‘
);

910 
t
->
ruÂšg_async
 = 0;

911 
t
->
ÿnûÎed
 = 1;

912 
	`DPRINTF
("xhci: cªûÎšg¿nsã¸%d, wa™šg fÜ iˆtØcom¶‘e...\n", 
i
);

913 
kËd
++;

915 ià(
t
->
ruÂšg_»Œy
) {

916 
t
->
ruÂšg_»Œy
 = 0;

917 
•ùx
->
»Œy
 = 
NULL
;

919 ià(
t
->
backgrounded
) {

920 
t
->
backgrounded
 = 0;

922 ià(
t
->
Œbs
) {

923 
	`g_ä“
(
t
->
Œbs
);

925 ià(
t
->
d©a
) {

926 
	`g_ä“
(
t
->
d©a
);

929 
t
->
Œbs
 = 
NULL
;

930 
t
->
d©a
 = 
NULL
;

931 
t
->
Œb_couÁ
 =->
Œb_®loûd
 = 0;

932 
t
->
d©a_Ëngth
 =->
d©a_®loûd
 = 0;

933 
xãri
 = (xãr˜+ 1è% 
TD_QUEUE
;

935 ià(
•ùx
->
has_bg
) {

936 
xãri
 = 
•ùx
->
Ãxt_bg
;

937 
i
 = 0; i < 
BG_XFERS
; i++) {

938 
XHCIT¿nsãr
 *
t
 = &
•ùx
->
bg_Œªsãrs
[
xãri
];

939 ià(
t
->
ruÂšg_async
) {

940 
	`usb_ÿnûl_·ck‘
(&
t
->
·ck‘
);

941 
t
->
ruÂšg_async
 = 0;

942 
t
->
ÿnûÎed
 = 1;

943 
	`DPRINTF
("xhci: cªûÎšg bg¿nsã¸%d, wa™šg fÜ iˆtØcom¶‘e...\n", 
i
);

944 
kËd
++;

946 ià(
t
->
d©a
) {

947 
	`g_ä“
(
t
->
d©a
);

950 
t
->
d©a
 = 
NULL
;

951 
xãri
 = (xãr˜+ 1è% 
BG_XFERS
;

954  
kËd
;

955 
	}
}

957 
TRBCCode
 
	$xhci_di§bË_•
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

958 
•id
)

960 
XHCISlÙ
 *
¦Ù
;

961 
XHCIEPCÚ‹xt
 *
•ùx
;

963 
	`Œaû_usb_xhci_•_di§bË
(
¦Ùid
, 
•id
);

964 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

965 
	`as£¹
(
•id
 >= 1 &&ƒpid <= 31);

967 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

969 ià(!
¦Ù
->
•s
[
•id
-1]) {

970 
	`DPRINTF
("xhci: slÙ %dƒ°%d‡Ì—dy di§bËd\n", 
¦Ùid
, 
•id
);

971  
CC_SUCCESS
;

974 
	`xhci_•_nuke_xãrs
(
xhci
, 
¦Ùid
, 
•id
);

976 
•ùx
 = 
¦Ù
->
•s
[
•id
-1];

978 
	`xhci_£t_•_¡©e
(
xhci
, 
•ùx
, 
EP_DISABLED
);

980 
	`g_ä“
(
•ùx
);

981 
¦Ù
->
•s
[
•id
-1] = 
NULL
;

983  
CC_SUCCESS
;

984 
	}
}

986 
TRBCCode
 
	$xhci_¡İ_•
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

987 
•id
)

989 
XHCISlÙ
 *
¦Ù
;

990 
XHCIEPCÚ‹xt
 *
•ùx
;

992 
	`Œaû_usb_xhci_•_¡İ
(
¦Ùid
, 
•id
);

993 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

995 ià(
•id
 < 1 ||ƒpid > 31) {

996 
	`årštf
(
¡d”r
, "xhci: badƒ°%d\n", 
•id
);

997  
CC_TRB_ERROR
;

1000 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

1002 ià(!
¦Ù
->
•s
[
•id
-1]) {

1003 
	`DPRINTF
("xhci: slÙ %dƒ°%d‚ÙƒÇbËd\n", 
¦Ùid
, 
•id
);

1004  
CC_EP_NOT_ENABLED_ERROR
;

1007 ià(
	`xhci_•_nuke_xãrs
(
xhci
, 
¦Ùid
, 
•id
) > 0) {

1008 
	`årštf
(
¡d”r
, "xhci: FIXME:ƒndpoint stopped w/ xfers„unning, "

1012 
•ùx
 = 
¦Ù
->
•s
[
•id
-1];

1014 
	`xhci_£t_•_¡©e
(
xhci
, 
•ùx
, 
EP_STOPPED
);

1016  
CC_SUCCESS
;

1017 
	}
}

1019 
TRBCCode
 
	$xhci_»£t_•
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

1020 
•id
)

1022 
XHCISlÙ
 *
¦Ù
;

1023 
XHCIEPCÚ‹xt
 *
•ùx
;

1024 
USBDeviû
 *
dev
;

1026 
	`Œaû_usb_xhci_•_»£t
(
¦Ùid
, 
•id
);

1027 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1029 ià(
•id
 < 1 ||ƒpid > 31) {

1030 
	`årštf
(
¡d”r
, "xhci: badƒ°%d\n", 
•id
);

1031  
CC_TRB_ERROR
;

1034 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

1036 ià(!
¦Ù
->
•s
[
•id
-1]) {

1037 
	`DPRINTF
("xhci: slÙ %dƒ°%d‚ÙƒÇbËd\n", 
¦Ùid
, 
•id
);

1038  
CC_EP_NOT_ENABLED_ERROR
;

1041 
•ùx
 = 
¦Ù
->
•s
[
•id
-1];

1043 ià(
•ùx
->
¡©e
 !ğ
EP_HALTED
) {

1044 
	`årštf
(
¡d”r
, "xhci:„eset EP while EP %d‚ot halted (%d)\n",

1045 
•id
, 
•ùx
->
¡©e
);

1046  
CC_CONTEXT_STATE_ERROR
;

1049 ià(
	`xhci_•_nuke_xãrs
(
xhci
, 
¦Ùid
, 
•id
) > 0) {

1050 
	`årštf
(
¡d”r
, "xhci: FIXME:ƒndpoint„eset w/ xfers„unning, "

1054 
ušt8_t
 
•
 = 
•id
>>1;

1056 ià(
•id
 & 1) {

1057 
•
 |= 0x80;

1060 
dev
 = 
xhci
->
pÜts
[xhci->
¦Ùs
[
¦Ùid
-1].
pÜt
-1].port.dev;

1061 ià(!
dev
) {

1062  
CC_USB_TRANSACTION_ERROR
;

1065 
	`xhci_£t_•_¡©e
(
xhci
, 
•ùx
, 
EP_STOPPED
);

1067  
CC_SUCCESS
;

1068 
	}
}

1070 
TRBCCode
 
	$xhci_£t_•_dequeue
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

1071 
•id
, 
ušt64_t
 
pdequeue
)

1073 
XHCISlÙ
 *
¦Ù
;

1074 
XHCIEPCÚ‹xt
 *
•ùx
;

1075 
dma_addr_t
 
dequeue
;

1077 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1079 ià(
•id
 < 1 ||ƒpid > 31) {

1080 
	`årštf
(
¡d”r
, "xhci: badƒ°%d\n", 
•id
);

1081  
CC_TRB_ERROR
;

1084 
	`DPRINTF
("xhci_£t_•_dequeue(%d, %d, %016"
PRIx64
")\n", 
¦Ùid
, 
•id
, 
pdequeue
);

1085 
dequeue
 = 
	`xhci_mask64
(
pdequeue
);

1087 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

1089 ià(!
¦Ù
->
•s
[
•id
-1]) {

1090 
	`DPRINTF
("xhci: slÙ %dƒ°%d‚ÙƒÇbËd\n", 
¦Ùid
, 
•id
);

1091  
CC_EP_NOT_ENABLED_ERROR
;

1094 
•ùx
 = 
¦Ù
->
•s
[
•id
-1];

1097 ià(
•ùx
->
¡©e
 !ğ
EP_STOPPED
) {

1098 
	`årštf
(
¡d”r
, "xhci: s‘ EP dequeupoš‹¸whEP %d‚Ù stİ³d\n", 
•id
);

1099  
CC_CONTEXT_STATE_ERROR
;

1102 
	`xhci_ršg_š™
(
xhci
, &
•ùx
->
ršg
, 
dequeue
 & ~0xF);

1103 
•ùx
->
ršg
.
ccs
 = 
dequeue
 & 1;

1105 
	`xhci_£t_•_¡©e
(
xhci
, 
•ùx
, 
EP_STOPPED
);

1107  
CC_SUCCESS
;

1108 
	}
}

1110 
	$xhci_xãr_d©a
(
XHCIT¿nsãr
 *
xãr
, 
ušt8_t
 *
d©a
,

1111 
Ëngth
, 
boŞ
 
š_xãr
, boŞ 
out_xãr
,

1112 
boŞ
 
»pÜt
)

1114 
i
;

1115 
ušt32_t
 
eda
 = 0;

1116 
Œªsã¼ed
 = 0;

1117 
Ëá
 = 
Ëngth
;

1118 
boŞ
 
»pÜ‹d
 = 0;

1119 
boŞ
 
shÜkt
 = 0;

1120 
XHCIEv’t
 
ev’t
 = {
ER_TRANSFER
, 
CC_SUCCESS
};

1121 
XHCIS‹
 *
xhci
 = 
xãr
->xhci;

1123 
	`DPRINTF
("xhci_xfer_data(len=%d, in_xfer=%d, out_xfer=%d,„eport=%d)\n",

1124 
Ëngth
, 
š_xãr
, 
out_xãr
, 
»pÜt
);

1126 
	`as£¹
(!(
š_xãr
 && 
out_xãr
));

1128 
i
 = 0; i < 
xãr
->
Œb_couÁ
; i++) {

1129 
XHCITRB
 *
Œb
 = &
xãr
->
Œbs
[
i
];

1130 
dma_addr_t
 
addr
;

1131 
chunk
 = 0;

1133 
	`TRB_TYPE
(*
Œb
)) {

1134 
TR_DATA
:

1135 ià((!(
Œb
->
cÚŒŞ
 & 
TRB_TR_DIR
)è!ğ(!
š_xãr
)) {

1136 
	`årštf
(
¡d”r
, "xhci: data direction mismatch for TR_DATA\n");

1137 
	`xhci_d›
(
xhci
);

1138  
Œªsã¼ed
;

1141 
TR_NORMAL
:

1142 
TR_ISOCH
:

1143 
addr
 = 
	`xhci_mask64
(
Œb
->
·¿m‘”
);

1144 
chunk
 = 
Œb
->
¡©us
 & 0x1ffff;

1145 ià(
chunk
 > 
Ëá
) {

1146 
chunk
 = 
Ëá
;

1147 
shÜkt
 = 1;

1149 ià(
š_xãr
 || 
out_xãr
) {

1150 ià(
Œb
->
cÚŒŞ
 & 
TRB_TR_IDT
) {

1151 
ušt64_t
 
id©a
;

1152 ià(
chunk
 > 8 || 
š_xãr
) {

1153 
	`årštf
(
¡d”r
, "xhci: invalid immediate data TRB\n");

1154 
	`xhci_d›
(
xhci
);

1155  
Œªsã¼ed
;

1157 
id©a
 = 
	`Ë64_to_ıu
(
Œb
->
·¿m‘”
);

1158 
	`memıy
(
d©a
, &
id©a
, 
chunk
);

1160 
	`DPRINTF
("xhci_xfer_data:„/w(%d) %d bytes‡t "

1161 
DMA_ADDR_FMT
 "\n", 
š_xãr
, 
chunk
, 
addr
);

1162 ià(
š_xãr
) {

1163 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
addr
, 
d©a
, 
chunk
);

1165 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
addr
, 
d©a
, 
chunk
);

1167 #ifdeà
DEBUG_DATA


1168 
couÁ
 = 
chunk
;

1169 
i
;

1170 ià(
couÁ
 > 16) {

1171 
couÁ
 = 16;

1173 
	`DPRINTF
(" ::");

1174 
i
 = 0; i < 
couÁ
; i++) {

1175 
	`DPRINTF
(" %02x", 
d©a
[
i
]);

1177 
	`DPRINTF
("\n");

1181 
Ëá
 -ğ
chunk
;

1182 
d©a
 +ğ
chunk
;

1183 
eda
 +ğ
chunk
;

1184 
Œªsã¼ed
 +ğ
chunk
;

1186 
TR_STATUS
:

1187 
»pÜ‹d
 = 0;

1188 
shÜkt
 = 0;

1192 ià(
»pÜt
 && !
»pÜ‹d
 && (
Œb
->
cÚŒŞ
 & 
TRB_TR_IOC
 ||

1193 (
shÜkt
 && (
Œb
->
cÚŒŞ
 & 
TRB_TR_ISP
)))) {

1194 
ev’t
.
¦Ùid
 = 
xãr
->slotid;

1195 
ev’t
.
•id
 = 
xãr
->epid;

1196 
ev’t
.
Ëngth
 = (
Œb
->
¡©us
 & 0x1ffffè- 
chunk
;

1197 
ev’t
.
æags
 = 0;

1198 
ev’t
.
±r
 = 
Œb
->
addr
;

1199 ià(
xãr
->
¡©us
 =ğ
CC_SUCCESS
) {

1200 
ev’t
.
ccode
 = 
shÜkt
 ? 
CC_SHORT_PACKET
 : 
CC_SUCCESS
;

1202 
ev’t
.
ccode
 = 
xãr
->
¡©us
;

1204 ià(
	`TRB_TYPE
(*
Œb
è=ğ
TR_EVDATA
) {

1205 
ev’t
.
±r
 = 
Œb
->
·¿m‘”
;

1206 
ev’t
.
æags
 |ğ
TRB_EV_ED
;

1207 
ev’t
.
Ëngth
 = 
eda
 & 0xffffff;

1208 
	`DPRINTF
("xhci_xãr_d©a: EDTLA=%d\n", 
ev’t
.
Ëngth
);

1209 
eda
 = 0;

1211 
	`xhci_ev’t
(
xhci
, &
ev’t
);

1212 
»pÜ‹d
 = 1;

1215  
Œªsã¼ed
;

1216 
	}
}

1218 
	$xhci_¡®l_•
(
XHCIT¿nsãr
 *
xãr
)

1220 
XHCIS‹
 *
xhci
 = 
xãr
->xhci;

1221 
XHCISlÙ
 *
¦Ù
 = &
xhci
->
¦Ùs
[
xãr
->
¦Ùid
-1];

1222 
XHCIEPCÚ‹xt
 *
•ùx
 = 
¦Ù
->
•s
[
xãr
->
•id
-1];

1224 
•ùx
->
ršg
.
dequeue
 = 
xãr
->
Œbs
[0].
addr
;

1225 
•ùx
->
ršg
.
ccs
 = 
xãr
->
Œbs
[0].ccs;

1226 
	`xhci_£t_•_¡©e
(
xhci
, 
•ùx
, 
EP_HALTED
);

1227 
	`DPRINTF
("xhci: sÎed slÙ %dƒ°%d\n", 
xãr
->
¦Ùid
, xãr->
•id
);

1228 
	`DPRINTF
("xhci: wÈcÚtšu© "
DMA_ADDR_FMT
"\n", 
•ùx
->
ršg
.
dequeue
);

1229 
	}
}

1231 
xhci_subm™
(
XHCIS‹
 *
xhci
, 
XHCIT¿nsãr
 *
xãr
,

1232 
XHCIEPCÚ‹xt
 *
•ùx
);

1234 
	$xhci_bg_upd©e
(
XHCIS‹
 *
xhci
, 
XHCIEPCÚ‹xt
 *
•ùx
)

1236 ià(
•ùx
->
bg_upd©šg
) {

1239 
	`DPRINTF
("xhci_bg_upd©e(%p, %p)\n", 
xhci
, 
•ùx
);

1240 
	`as£¹
(
•ùx
->
has_bg
);

1241 
	`DPRINTF
("xhci: fg=%d bg=%d\n", 
•ùx
->
comp_xãr
,ƒpùx->
Ãxt_bg
);

1242 
•ùx
->
bg_upd©šg
 = 1;

1243 
•ùx
->
Œªsãrs
[•ùx->
comp_xãr
].
backgrounded
 &&

1244 
•ùx
->
bg_Œªsãrs
[•ùx->
Ãxt_bg
].
com¶‘e
) {

1245 
XHCIT¿nsãr
 *
fg
 = &
•ùx
->
Œªsãrs
[•ùx->
comp_xãr
];

1246 
XHCIT¿nsãr
 *
bg
 = &
•ùx
->
bg_Œªsãrs
[•ùx->
Ãxt_bg
];

1248 
	`DPRINTF
("xhci: completing fg %d from bg %d.%d (stat: %d)\n",

1249 
•ùx
->
comp_xãr
,ƒpùx->
Ãxt_bg
, 
bg
->
cur_pkt
,

1250 
bg
->
usbxãr
->
iso_·ck‘_desc
[bg->
cur_pkt
].
¡©us


1253 
	`as£¹
(
•ùx
->
ty³
 =ğ
ET_ISO_IN
);

1254 
	`as£¹
(
bg
->
iso_xãr
);

1255 
	`as£¹
(
bg
->
š_xãr
);

1256 
ušt8_t
 *
p
 = 
bg
->
d©a
 + bg->
cur_pkt
 * bg->
pktsize
;

1258 
Ën
 = 
bg
->
usbxãr
->
iso_·ck‘_desc
[bg->
cur_pkt
].
aùu®_Ëngth
;

1259 
fg
->
¡©us
 = 
	`libusb_to_ccode
(
bg
->
usbxãr
->
iso_·ck‘_desc
[bg->
cur_pkt
].status);

1261 
Ën
 = 0;

1262 
	`FIXME
();

1264 
fg
->
com¶‘e
 = 1;

1265 
fg
->
backgrounded
 = 0;

1267 ià(
fg
->
¡©us
 =ğ
CC_STALL_ERROR
) {

1268 
	`xhci_¡®l_•
(
fg
);

1271 
	`xhci_xãr_d©a
(
fg
, 
p
, 
Ën
, 1, 0, 1);

1273 
•ùx
->
comp_xãr
++;

1274 ià(
•ùx
->
comp_xãr
 =ğ
TD_QUEUE
) {

1275 
•ùx
->
comp_xãr
 = 0;

1277 
	`DPRINTF
("Ãxˆfg xãr: %d\n", 
•ùx
->
comp_xãr
);

1278 
bg
->
cur_pkt
++;

1279 ià(
bg
->
cur_pkt
 =ğbg->
pkts
) {

1280 
bg
->
com¶‘e
 = 0;

1281 ià(
	`xhci_subm™
(
xhci
, 
bg
, 
•ùx
) < 0) {

1282 
	`årštf
(
¡d”r
, "xhci: bg„esubmit failed\n");

1284 
•ùx
->
Ãxt_bg
++;

1285 ià(
•ùx
->
Ãxt_bg
 =ğ
BG_XFERS
) {

1286 
•ùx
->
Ãxt_bg
 = 0;

1288 
	`DPRINTF
("Ãxˆbg xãr: %d\n", 
•ùx
->
Ãxt_bg
);

1290 
	`xhci_kick_•
(
xhci
, 
fg
->
¦Ùid
, fg->
•id
);

1293 
•ùx
->
bg_upd©šg
 = 0;

1294 
	}
}

1297 
	$xhci_xãr_cb
(
libusb_Œªsãr
 *
Œªsãr
)

1299 
XHCIS‹
 *
xhci
;

1300 
XHCIT¿nsãr
 *
xãr
;

1302 
xãr
 = (
XHCIT¿nsãr
 *)
Œªsãr
->
u£r_d©a
;

1303 
xhci
 = 
xãr
->xhci;

1305 
	`DPRINTF
("xhci_xãr_cb(¦Ù=%d,ƒp=%d, stus=%d)\n", 
xãr
->
¦Ùid
,

1306 
xãr
->
•id
, 
Œªsãr
->
¡©us
);

1308 
	`as£¹
(
xãr
->
¦Ùid
 >ğ1 && xãr->¦Ùid <ğ
MAXSLOTS
);

1309 
	`as£¹
(
xãr
->
•id
 >= 1 && xfer->epid <= 31);

1311 ià(
xãr
->
ÿnûÎed
) {

1312 
	`DPRINTF
("xhci:ransfer cancelled,‚ot„eporting‡nything\n");

1313 
xãr
->
ruÂšg
 = 0;

1317 
XHCIEPCÚ‹xt
 *
•ùx
;

1318 
XHCISlÙ
 *
¦Ù
;

1319 
¦Ù
 = &
xhci
->
¦Ùs
[
xãr
->
¦Ùid
-1];

1320 
	`as£¹
(
¦Ù
->
•s
[
xãr
->
•id
-1]);

1321 
•ùx
 = 
¦Ù
->
•s
[
xãr
->
•id
-1];

1323 ià(
xãr
->
bg_xãr
) {

1324 
	`DPRINTF
("xhci: backgroundransfer, updating\n");

1325 
xãr
->
com¶‘e
 = 1;

1326 
xãr
->
ruÂšg
 = 0;

1327 
	`xhci_bg_upd©e
(
xhci
, 
•ùx
);

1331 ià(
xãr
->
iso_xãr
) {

1332 
Œªsãr
->
¡©us
 =¿nsãr->
iso_·ck‘_desc
[0].status;

1333 
Œªsãr
->
aùu®_Ëngth
 =¿nsãr->
iso_·ck‘_desc
[0].actual_length;

1336 
xãr
->
¡©us
 = 
	`libusb_to_ccode
(
Œªsãr
->status);

1338 
xãr
->
com¶‘e
 = 1;

1339 
xãr
->
ruÂšg
 = 0;

1341 ià(
Œªsãr
->
¡©us
 =ğ
LIBUSB_TRANSFER_STALL
)

1342 
	`xhci_¡®l_•
(
xhci
, 
•ùx
, 
xãr
);

1344 
	`DPRINTF
("xhci:¿nsã¸aùu®†’gth = %d\n", 
Œªsãr
->
aùu®_Ëngth
);

1346 ià(
xãr
->
š_xãr
) {

1347 ià(
xãr
->
•id
 == 1) {

1348 
	`xhci_xãr_d©a
(
xhci
, 
xãr
, xãr->
d©a
 + 8,

1349 
Œªsãr
->
aùu®_Ëngth
, 1, 0, 1);

1351 
	`xhci_xãr_d©a
(
xhci
, 
xãr
, xãr->
d©a
,

1352 
Œªsãr
->
aùu®_Ëngth
, 1, 0, 1);

1355 
	`xhci_xãr_d©a
(
xhci
, 
xãr
, 
NULL
, 
Œªsãr
->
aùu®_Ëngth
, 0, 0, 1);

1358 
	`xhci_kick_•
(
xhci
, 
xãr
->
¦Ùid
, xãr->
•id
);

1359 
	}
}

1361 
	$xhci_hË_cÚŒŞ
(
XHCIS‹
 *
xhci
, 
XHCIT¿nsãr
 *
xãr
,

1362 
ušt8_t
 
bmReque¡Ty³
, ušt8_ˆ
bReque¡
,

1363 
ušt16_t
 
wV®ue
, ušt16_ˆ
wIndex
, ušt16_ˆ
wL’gth
)

1365 
ušt16_t
 
ty³_»q
 = (
bmReque¡Ty³
 << 8è| 
bReque¡
;

1367 
ty³_»q
) {

1368 0x0000 | 
USB_REQ_SET_CONFIGURATION
:

1369 
	`DPRINTF
("xhci: HLE switch configuration\n");

1370  
	`xhci_sw™ch_cÚfig
(
xhci
, 
xãr
->
¦Ùid
, 
wV®ue
) == 0;

1371 0x0100 | 
USB_REQ_SET_INTERFACE
:

1372 
	`DPRINTF
("xhci: HLE set interface‡ltsetting\n");

1373  
	`xhci_£t_içû_®t
(
xhci
, 
xãr
->
¦Ùid
, 
wIndex
, 
wV®ue
) == 0;

1374 0x0200 | 
USB_REQ_CLEAR_FEATURE
:

1375 ià(
wV®ue
 == 0) {

1376 
	`DPRINTF
("xhci: HLE clear halt\n");

1377  
	`xhci_ş—r_h®t
(
xhci
, 
xãr
->
¦Ùid
, 
wIndex
);

1379 0x0000 | 
USB_REQ_SET_ADDRESS
:

1380 
	`årštf
(
¡d”r
, "xhci: warn: illegal SET_ADDRESS„equest\n");

1385 
	}
}

1388 
	$xhci_£tup_·ck‘
(
XHCIT¿nsãr
 *
xãr
, 
USBDeviû
 *
dev
)

1390 
USBEndpošt
 *
•
;

1391 
dœ
;

1393 
dœ
 = 
xãr
->
š_xãr
 ? 
USB_TOKEN_IN
 : 
USB_TOKEN_OUT
;

1394 
•
 = 
	`usb_•_g‘
(
dev
, 
dœ
, 
xãr
->
•id
 >> 1);

1395 
	`usb_·ck‘_£tup
(&
xãr
->
·ck‘
, 
dœ
, 
•
, xãr->
Œbs
[0].
addr
);

1396 
	`usb_·ck‘_addbuf
(&
xãr
->
·ck‘
, xãr->
d©a
, xãr->
d©a_Ëngth
);

1397 
	`DPRINTF
("xhci: setup…acket…id 0x%x‡ddr %dƒp %d\n",

1398 
xãr
->
·ck‘
.
pid
, 
dev
->
addr
, 
•
->
Ä
);

1400 
	}
}

1402 
	$xhci_com¶‘e_·ck‘
(
XHCIT¿nsãr
 *
xãr
, 
»t
)

1404 ià(
»t
 =ğ
USB_RET_ASYNC
) {

1405 
	`Œaû_usb_xhci_xãr_async
(
xãr
);

1406 
xãr
->
ruÂšg_async
 = 1;

1407 
xãr
->
ruÂšg_»Œy
 = 0;

1408 
xãr
->
com¶‘e
 = 0;

1409 
xãr
->
ÿnûÎed
 = 0;

1411 } ià(
»t
 =ğ
USB_RET_NAK
) {

1412 
	`Œaû_usb_xhci_xãr_Çk
(
xãr
);

1413 
xãr
->
ruÂšg_async
 = 0;

1414 
xãr
->
ruÂšg_»Œy
 = 1;

1415 
xãr
->
com¶‘e
 = 0;

1416 
xãr
->
ÿnûÎed
 = 0;

1419 
xãr
->
ruÂšg_async
 = 0;

1420 
xãr
->
ruÂšg_»Œy
 = 0;

1421 
xãr
->
com¶‘e
 = 1;

1424 ià(
»t
 >= 0) {

1425 
xãr
->
¡©us
 = 
CC_SUCCESS
;

1426 
	`xhci_xãr_d©a
(
xãr
, xãr->
d©a
, 
»t
, xãr->
š_xãr
, 0, 1);

1427 
	`Œaû_usb_xhci_xãr_sucûss
(
xãr
, 
»t
);

1432 
	`Œaû_usb_xhci_xãr_”rÜ
(
xãr
, 
»t
);

1433 
»t
) {

1434 
USB_RET_NODEV
:

1435 
xãr
->
¡©us
 = 
CC_USB_TRANSACTION_ERROR
;

1436 
	`xhci_xãr_d©a
(
xãr
, xãr->
d©a
, 0, xãr->
š_xãr
, 0, 1);

1437 
	`xhci_¡®l_•
(
xãr
);

1439 
USB_RET_STALL
:

1440 
xãr
->
¡©us
 = 
CC_STALL_ERROR
;

1441 
	`xhci_xãr_d©a
(
xãr
, xãr->
d©a
, 0, xãr->
š_xãr
, 0, 1);

1442 
	`xhci_¡®l_•
(
xãr
);

1445 
	`årštf
(
¡d”r
, "%s: FIXME:„‘ = %d\n", 
__FUNCTION__
, 
»t
);

1446 
	`FIXME
();

1449 
	}
}

1451 
USBDeviû
 *
	$xhci_fšd_deviû
(
XHCIPÜt
 *
pÜt
, 
ušt8_t
 
addr
)

1453 ià(!(
pÜt
->
pÜtsc
 & 
PORTSC_PED
)) {

1454  
NULL
;

1456  
	`usb_fšd_deviû
(&
pÜt
->pÜt, 
addr
);

1457 
	}
}

1459 
	$xhci_fœe_ùl_Œªsãr
(
XHCIS‹
 *
xhci
, 
XHCIT¿nsãr
 *
xãr
)

1461 
XHCITRB
 *
Œb_£tup
, *
Œb_¡©us
;

1462 
ušt8_t
 
bmReque¡Ty³
;

1463 
ušt16_t
 
wL’gth
;

1464 
XHCIPÜt
 *
pÜt
;

1465 
USBDeviû
 *
dev
;

1466 
»t
;

1468 
Œb_£tup
 = &
xãr
->
Œbs
[0];

1469 
Œb_¡©us
 = &
xãr
->
Œbs
[xãr->
Œb_couÁ
-1];

1471 
	`Œaû_usb_xhci_xãr_¡¬t
(
xãr
, xãr->
¦Ùid
, xãr->
•id
,

1472 
Œb_£tup
->
·¿m‘”
 >> 48);

1475 ià(
	`TRB_TYPE
(*
Œb_¡©us
è=ğ
TR_EVDATA
 && 
xãr
->
Œb_couÁ
 > 2) {

1476 
Œb_¡©us
--;

1480 ià(
	`TRB_TYPE
(*
Œb_£tup
è!ğ
TR_SETUP
) {

1481 
	`årštf
(
¡d”r
, "xhci:ƒp0 first TD‚ot SETUP: %d\n",

1482 
	`TRB_TYPE
(*
Œb_£tup
));

1485 ià(
	`TRB_TYPE
(*
Œb_¡©us
è!ğ
TR_STATUS
) {

1486 
	`årštf
(
¡d”r
, "xhci:ƒp0†ast TD‚ot STATUS: %d\n",

1487 
	`TRB_TYPE
(*
Œb_¡©us
));

1490 ià(!(
Œb_£tup
->
cÚŒŞ
 & 
TRB_TR_IDT
)) {

1491 
	`årštf
(
¡d”r
, "xhci: Setup TRB doesn't have IDT set\n");

1494 ià((
Œb_£tup
->
¡©us
 & 0x1ffff) != 8) {

1495 
	`årštf
(
¡d”r
, "xhci: Setup TRB has bad†ength (%d)\n",

1496 (
Œb_£tup
->
¡©us
 & 0x1ffff));

1500 
bmReque¡Ty³
 = 
Œb_£tup
->
·¿m‘”
;

1501 
wL’gth
 = 
Œb_£tup
->
·¿m‘”
 >> 48;

1503 ià(
xãr
->
d©a
 && xãr->
d©a_®loûd
 < 
wL’gth
) {

1504 
xãr
->
d©a_®loûd
 = 0;

1505 
	`g_ä“
(
xãr
->
d©a
);

1506 
xãr
->
d©a
 = 
NULL
;

1508 ià(!
xãr
->
d©a
) {

1509 
	`DPRINTF
("xhci:‡Îoø%d by‹ d©a\n", 
wL’gth
);

1510 
xãr
->
d©a
 = 
	`g_m®loc
(
wL’gth
+1);

1511 
xãr
->
d©a_®loûd
 = 
wL’gth
;

1513 
xãr
->
d©a_Ëngth
 = 
wL’gth
;

1515 
pÜt
 = &
xhci
->
pÜts
[xhci->
¦Ùs
[
xãr
->
¦Ùid
-1].port-1];

1516 
dev
 = 
	`xhci_fšd_deviû
(
pÜt
, 
xhci
->
¦Ùs
[
xãr
->
¦Ùid
-1].
devaddr
);

1517 ià(!
dev
) {

1518 
	`årštf
(
¡d”r
, "xhci: slÙ %d…Üˆ%d ha nØdeviû\n", 
xãr
->
¦Ùid
,

1519 
xhci
->
¦Ùs
[
xãr
->
¦Ùid
-1].
pÜt
);

1523 
xãr
->
š_xãr
 = 
bmReque¡Ty³
 & 
USB_DIR_IN
;

1524 
xãr
->
iso_xãr
 = 
çl£
;

1526 
	`xhci_£tup_·ck‘
(
xãr
, 
dev
);

1527 
xãr
->
·ck‘
.
·¿m‘”
 = 
Œb_£tup
->parameter;

1528 ià(!
xãr
->
š_xãr
) {

1529 
	`xhci_xãr_d©a
(
xãr
, xãr->
d©a
, 
wL’gth
, 0, 1, 0);

1532 
»t
 = 
	`usb_hªdË_·ck‘
(
dev
, &
xãr
->
·ck‘
);

1534 
	`xhci_com¶‘e_·ck‘
(
xãr
, 
»t
);

1535 ià(!
xãr
->
ruÂšg_async
 && !xãr->
ruÂšg_»Œy
) {

1536 
	`xhci_kick_•
(
xhci
, 
xãr
->
¦Ùid
, xãr->
•id
);

1539 
	}
}

1541 
	$xhci_subm™
(
XHCIS‹
 *
xhci
, 
XHCIT¿nsãr
 *
xãr
, 
XHCIEPCÚ‹xt
 *
•ùx
)

1543 
XHCIPÜt
 *
pÜt
;

1544 
USBDeviû
 *
dev
;

1545 
»t
;

1547 
	`DPRINTF
("xhci_subm™(¦Ùid=%d,•id=%d)\n", 
xãr
->
¦Ùid
, xãr->
•id
);

1549 
xãr
->
š_xãr
 = 
•ùx
->
ty³
>>2;

1551 ià(
xãr
->
d©a
 && xãr->
d©a_®loûd
 < xãr->
d©a_Ëngth
) {

1552 
xãr
->
d©a_®loûd
 = 0;

1553 
	`g_ä“
(
xãr
->
d©a
);

1554 
xãr
->
d©a
 = 
NULL
;

1556 ià(!
xãr
->
d©a
 && xãr->
d©a_Ëngth
) {

1557 
	`DPRINTF
("xhci:‡Îoø%d by‹ d©a\n", 
xãr
->
d©a_Ëngth
);

1558 
xãr
->
d©a
 = 
	`g_m®loc
(xãr->
d©a_Ëngth
);

1559 
xãr
->
d©a_®loûd
 = xãr->
d©a_Ëngth
;

1561 ià(
•ùx
->
ty³
 =ğ
ET_ISO_IN
 ||ƒpùx->ty³ =ğ
ET_ISO_OUT
) {

1562 ià(!
xãr
->
bg_xãr
) {

1563 
xãr
->
pkts
 = 1;

1566 
xãr
->
pkts
 = 0;

1569 
pÜt
 = &
xhci
->
pÜts
[xhci->
¦Ùs
[
xãr
->
¦Ùid
-1].port-1];

1570 
dev
 = 
	`xhci_fšd_deviû
(
pÜt
, 
xhci
->
¦Ùs
[
xãr
->
¦Ùid
-1].
devaddr
);

1571 ià(!
dev
) {

1572 
	`årštf
(
¡d”r
, "xhci: slÙ %d…Üˆ%d ha nØdeviû\n", 
xãr
->
¦Ùid
,

1573 
xhci
->
¦Ùs
[
xãr
->
¦Ùid
-1].
pÜt
);

1577 
	`xhci_£tup_·ck‘
(
xãr
, 
dev
);

1579 
•ùx
->
ty³
) {

1580 
ET_INTR_OUT
:

1581 
ET_INTR_IN
:

1582 
ET_BULK_OUT
:

1583 
ET_BULK_IN
:

1585 
ET_ISO_OUT
:

1586 
ET_ISO_IN
:

1587 
	`FIXME
();

1590 
	`årštf
(
¡d”r
, "xhci: unknown or unhandled EP "

1592 
•ùx
->
ty³
, 
xãr
->
š_xãr
, xãr->
•id
);

1596 ià(!
xãr
->
š_xãr
) {

1597 
	`xhci_xãr_d©a
(
xãr
, xãr->
d©a
, xãr->
d©a_Ëngth
, 0, 1, 0);

1599 
»t
 = 
	`usb_hªdË_·ck‘
(
dev
, &
xãr
->
·ck‘
);

1601 
	`xhci_com¶‘e_·ck‘
(
xãr
, 
»t
);

1602 ià(!
xãr
->
ruÂšg_async
 && !xãr->
ruÂšg_»Œy
) {

1603 
	`xhci_kick_•
(
xhci
, 
xãr
->
¦Ùid
, xãr->
•id
);

1606 
	}
}

1608 
	$xhci_fœe_Œªsãr
(
XHCIS‹
 *
xhci
, 
XHCIT¿nsãr
 *
xãr
, 
XHCIEPCÚ‹xt
 *
•ùx
)

1610 
i
;

1611 
Ëngth
 = 0;

1612 
XHCITRB
 *
Œb
;

1614 
i
 = 0; i < 
xãr
->
Œb_couÁ
; i++) {

1615 
Œb
 = &
xãr
->
Œbs
[
i
];

1616 ià(
	`TRB_TYPE
(*
Œb
è=ğ
TR_NORMAL
 || TRB_TYPE(*Œbè=ğ
TR_ISOCH
) {

1617 
Ëngth
 +ğ
Œb
->
¡©us
 & 0x1ffff;

1621 
	`Œaû_usb_xhci_xãr_¡¬t
(
xãr
, xãr->
¦Ùid
, xãr->
•id
, 
Ëngth
);

1623 ià(!
•ùx
->
has_bg
) {

1624 
xãr
->
d©a_Ëngth
 = 
Ëngth
;

1625 
xãr
->
backgrounded
 = 0;

1626  
	`xhci_subm™
(
xhci
, 
xãr
, 
•ùx
);

1628 ià(!
•ùx
->
bg_ruÂšg
) {

1629 
i
 = 0; i < 
BG_XFERS
; i++) {

1630 
XHCIT¿nsãr
 *
t
 = &
•ùx
->
bg_Œªsãrs
[
i
];

1631 
t
->
xhci
 = xhci;

1632 
t
->
•id
 = 
xãr
->epid;

1633 
t
->
¦Ùid
 = 
xãr
->slotid;

1634 
t
->
pkts
 = 
BG_PKTS
;

1635 
t
->
pktsize
 = 
•ùx
->
max_psize
;

1636 
t
->
d©a_Ëngth
 =->
pkts
 *->
pktsize
;

1637 
t
->
bg_xãr
 = 1;

1638 ià(
	`xhci_subm™
(
xhci
, 
t
, 
•ùx
) < 0) {

1639 
	`årštf
(
¡d”r
, "xhci: bg submit failed\n");

1643 
•ùx
->
bg_ruÂšg
 = 1;

1645 
xãr
->
backgrounded
 = 1;

1646 
	`xhci_bg_upd©e
(
xhci
, 
•ùx
);

1649 
	}
}

1651 
	$xhci_kick_•
(
XHCIS‹
 *
xhci
, 
¦Ùid
, 
•id
)

1653 
XHCIEPCÚ‹xt
 *
•ùx
;

1654 
Ëngth
;

1655 
i
;

1657 
	`Œaû_usb_xhci_•_kick
(
¦Ùid
, 
•id
);

1658 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1659 
	`as£¹
(
•id
 >= 1 &&ƒpid <= 31);

1661 ià(!
xhci
->
¦Ùs
[
¦Ùid
-1].
’abËd
) {

1662 
	`årštf
(
¡d”r
, "xhci: xhci_kick_• fÜ di§bËd slÙ %d\n", 
¦Ùid
);

1665 
•ùx
 = 
xhci
->
¦Ùs
[
¦Ùid
-1].
•s
[
•id
-1];

1666 ià(!
•ùx
) {

1667 
	`årštf
(
¡d”r
, "xhci: xhci_kick_ep for disabledƒndpoint %d,%d\n",

1668 
•id
, 
¦Ùid
);

1672 ià(
•ùx
->
»Œy
) {

1674 
XHCIT¿nsãr
 *
xãr
 = 
•ùx
->
»Œy
;

1675 
»suÉ
;

1677 
	`Œaû_usb_xhci_xãr_»Œy
(
xãr
);

1678 
	`as£¹
(
xãr
->
ruÂšg_»Œy
);

1679 
	`xhci_£tup_·ck‘
(
xãr
, xãr->
·ck‘
.
•
->
dev
);

1680 
»suÉ
 = 
	`usb_hªdË_·ck‘
(
xãr
->
·ck‘
.
•
->
dev
, &xfer->packet);

1681 ià(
»suÉ
 =ğ
USB_RET_NAK
) {

1684 
	`xhci_com¶‘e_·ck‘
(
xãr
, 
»suÉ
);

1685 
	`as£¹
(!
xãr
->
ruÂšg_»Œy
);

1686 
•ùx
->
»Œy
 = 
NULL
;

1689 ià(
•ùx
->
¡©e
 =ğ
EP_HALTED
) {

1690 
	`DPRINTF
("xhci:ƒp halted,‚ot„unning schedule\n");

1694 
	`xhci_£t_•_¡©e
(
xhci
, 
•ùx
, 
EP_RUNNING
);

1697 
XHCIT¿nsãr
 *
xãr
 = &
•ùx
->
Œªsãrs
[•ùx->
Ãxt_xãr
];

1698 ià(
xãr
->
ruÂšg_async
 || xãr->
ruÂšg_»Œy
 || xãr->
backgrounded
) {

1701 
Ëngth
 = 
	`xhci_ršg_chaš_Ëngth
(
xhci
, &
•ùx
->
ršg
);

1702 ià(
Ëngth
 < 0) {

1704 } ià(
Ëngth
 == 0) {

1707 ià(
xãr
->
Œbs
 && xãr->
Œb_®loûd
 < 
Ëngth
) {

1708 
xãr
->
Œb_couÁ
 = 0;

1709 
xãr
->
Œb_®loûd
 = 0;

1710 
	`g_ä“
(
xãr
->
Œbs
);

1711 
xãr
->
Œbs
 = 
NULL
;

1713 ià(!
xãr
->
Œbs
) {

1714 
xãr
->
Œbs
 = 
	`g_m®loc
((
XHCITRB
è* 
Ëngth
);

1715 
xãr
->
Œb_®loûd
 = 
Ëngth
;

1717 
xãr
->
Œb_couÁ
 = 
Ëngth
;

1719 
i
 = 0; i < 
Ëngth
; i++) {

1720 
	`as£¹
(
	`xhci_ršg_ãtch
(
xhci
, &
•ùx
->
ršg
, &
xãr
->
Œbs
[
i
], 
NULL
));

1722 
xãr
->
xhci
 = xhci;

1723 
xãr
->
•id
 =ƒpid;

1724 
xãr
->
¦Ùid
 = slotid;

1726 ià(
•id
 == 1) {

1727 ià(
	`xhci_fœe_ùl_Œªsãr
(
xhci
, 
xãr
) >= 0) {

1728 
•ùx
->
Ãxt_xãr
 = (•ùx->Ãxt_xã¸+ 1è% 
TD_QUEUE
;

1730 
	`årštf
(
¡d”r
, "xhci:ƒrror firing CTLransfer\n");

1733 ià(
	`xhci_fœe_Œªsãr
(
xhci
, 
xãr
, 
•ùx
) >= 0) {

1734 
•ùx
->
Ãxt_xãr
 = (•ùx->Ãxt_xã¸+ 1è% 
TD_QUEUE
;

1736 
	`årštf
(
¡d”r
, "xhci:ƒrror firing dataransfer\n");

1740 ià(
•ùx
->
¡©e
 =ğ
EP_HALTED
) {

1743 ià(
xãr
->
ruÂšg_»Œy
) {

1744 
	`DPRINTF
("xhci: xfer‚acked, stopping schedule\n");

1745 
•ùx
->
»Œy
 = 
xãr
;

1749 
	}
}

1751 
TRBCCode
 
	$xhci_’abË_¦Ù
(
XHCIS‹
 *
xhci
, 
¦Ùid
)

1753 
	`Œaû_usb_xhci_¦Ù_’abË
(
¦Ùid
);

1754 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1755 
xhci
->
¦Ùs
[
¦Ùid
-1].
’abËd
 = 1;

1756 
xhci
->
¦Ùs
[
¦Ùid
-1].
pÜt
 = 0;

1757 
	`mem£t
(
xhci
->
¦Ùs
[
¦Ùid
-1].
•s
, 0, (
XHCIEPCÚ‹xt
*)*31);

1759  
CC_SUCCESS
;

1760 
	}
}

1762 
TRBCCode
 
	$xhci_di§bË_¦Ù
(
XHCIS‹
 *
xhci
, 
¦Ùid
)

1764 
i
;

1766 
	`Œaû_usb_xhci_¦Ù_di§bË
(
¦Ùid
);

1767 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1769 
i
 = 1; i <= 31; i++) {

1770 ià(
xhci
->
¦Ùs
[
¦Ùid
-1].
•s
[
i
-1]) {

1771 
	`xhci_di§bË_•
(
xhci
, 
¦Ùid
, 
i
);

1775 
xhci
->
¦Ùs
[
¦Ùid
-1].
’abËd
 = 0;

1776  
CC_SUCCESS
;

1777 
	}
}

1779 
TRBCCode
 
	$xhci_add»ss_¦Ù
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

1780 
ušt64_t
 
piùx
, 
boŞ
 
b¤
)

1782 
XHCISlÙ
 *
¦Ù
;

1783 
USBDeviû
 *
dev
;

1784 
dma_addr_t
 
iùx
, 
oùx
, 
dcb¯p
;

1785 
ušt64_t
 
poùx
;

1786 
ušt32_t
 
iùl_ùx
[2];

1787 
ušt32_t
 
¦Ù_ùx
[4];

1788 
ušt32_t
 
•0_ùx
[5];

1789 
pÜt
;

1790 
i
;

1791 
TRBCCode
 
»s
;

1793 
	`Œaû_usb_xhci_¦Ù_add»ss
(
¦Ùid
);

1794 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1796 
dcb¯p
 = 
	`xhci_addr64
(
xhci
->
dcb¯p_low
, xhci->
dcb¯p_high
);

1797 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
dcb¯p
 + 8*
¦Ùid
, &
poùx
, (poctx));

1798 
iùx
 = 
	`xhci_mask64
(
piùx
);

1799 
oùx
 = 
	`xhci_mask64
(
	`Ë64_to_ıu
(
poùx
));

1801 
	`DPRINTF
("xhci: iÅuˆcÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
iùx
);

1802 
	`DPRINTF
("xhci: ouuˆcÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
oùx
);

1804 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
, 
iùl_ùx
, (ictl_ctx));

1806 ià(
iùl_ùx
[0] != 0x0 || ictl_ctx[1] != 0x3) {

1807 
	`årštf
(
¡d”r
, "xhci: invalid input context control %08x %08x\n",

1808 
iùl_ùx
[0], ictl_ctx[1]);

1809  
CC_TRB_ERROR
;

1812 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
+32, 
¦Ù_ùx
, (slot_ctx));

1813 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
+64, 
•0_ùx
, (ep0_ctx));

1815 
	`DPRINTF
("xhci: input slot context: %08x %08x %08x %08x\n",

1816 
¦Ù_ùx
[0], slot_ctx[1], slot_ctx[2], slot_ctx[3]);

1818 
	`DPRINTF
("xhci: inputƒp0 context: %08x %08x %08x %08x %08x\n",

1819 
•0_ùx
[0],ƒp0_ctx[1],ƒp0_ctx[2],ƒp0_ctx[3],ƒp0_ctx[4]);

1821 
pÜt
 = (
¦Ù_ùx
[1]>>16) & 0xFF;

1822 
dev
 = 
xhci
->
pÜts
[
pÜt
-1].port.dev;

1824 ià(
pÜt
 < 1 ||…Üˆ> 
MAXPORTS
) {

1825 
	`årštf
(
¡d”r
, "xhci: bad…Üˆ%d\n", 
pÜt
);

1826  
CC_TRB_ERROR
;

1827 } ià(!
dev
) {

1828 
	`årštf
(
¡d”r
, "xhci:…Üˆ%d‚Ù cÚÃùed\n", 
pÜt
);

1829  
CC_USB_TRANSACTION_ERROR
;

1832 
i
 = 0; i < 
MAXSLOTS
; i++) {

1833 ià(
xhci
->
¦Ùs
[
i
].
pÜt
 ==…ort) {

1834 
	`årštf
(
¡d”r
, "xhci:…ort %d‡lready‡ssignedo slot %d\n",

1835 
pÜt
, 
i
+1);

1836  
CC_TRB_ERROR
;

1840 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

1841 
¦Ù
->
pÜt
 =…ort;

1842 
¦Ù
->
ùx
 = 
oùx
;

1844 ià(
b¤
) {

1845 
¦Ù_ùx
[3] = 
SLOT_DEFAULT
 << 
SLOT_STATE_SHIFT
;

1847 
¦Ù
->
devaddr
 = 
xhci
->devaddr++;

1848 
¦Ù_ùx
[3] = (
SLOT_ADDRESSED
 << 
SLOT_STATE_SHIFT
è| 
¦Ù
->
devaddr
;

1849 
	`DPRINTF
("xhci: deviû‡dd»s i %d\n", 
¦Ù
->
devaddr
);

1850 
	`usb_deviû_hªdË_cÚŒŞ
(
dev
, 
NULL
,

1851 
DeviûOutReque¡
 | 
USB_REQ_SET_ADDRESS
,

1852 
¦Ù
->
devaddr
, 0, 0, 
NULL
);

1855 
»s
 = 
	`xhci_’abË_•
(
xhci
, 
¦Ùid
, 1, 
oùx
+32, 
•0_ùx
);

1857 
	`DPRINTF
("xhci: output slot context: %08x %08x %08x %08x\n",

1858 
¦Ù_ùx
[0], slot_ctx[1], slot_ctx[2], slot_ctx[3]);

1859 
	`DPRINTF
("xhci: outputƒp0 context: %08x %08x %08x %08x %08x\n",

1860 
•0_ùx
[0],ƒp0_ctx[1],ƒp0_ctx[2],ƒp0_ctx[3],ƒp0_ctx[4]);

1862 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

1863 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
+32, 
•0_ùx
, (ep0_ctx));

1865  
»s
;

1866 
	}
}

1869 
TRBCCode
 
	$xhci_cÚfigu»_¦Ù
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

1870 
ušt64_t
 
piùx
, 
boŞ
 
dc
)

1872 
dma_addr_t
 
iùx
, 
oùx
;

1873 
ušt32_t
 
iùl_ùx
[2];

1874 
ušt32_t
 
¦Ù_ùx
[4];

1875 
ušt32_t
 
i¦Ù_ùx
[4];

1876 
ušt32_t
 
•_ùx
[5];

1877 
i
;

1878 
TRBCCode
 
»s
;

1880 
	`Œaû_usb_xhci_¦Ù_cÚfigu»
(
¦Ùid
);

1881 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1883 
iùx
 = 
	`xhci_mask64
(
piùx
);

1884 
oùx
 = 
xhci
->
¦Ùs
[
¦Ùid
-1].
ùx
;

1886 
	`DPRINTF
("xhci: iÅuˆcÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
iùx
);

1887 
	`DPRINTF
("xhci: ouuˆcÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
oùx
);

1889 ià(
dc
) {

1890 
i
 = 2; i <= 31; i++) {

1891 ià(
xhci
->
¦Ùs
[
¦Ùid
-1].
•s
[
i
-1]) {

1892 
	`xhci_di§bË_•
(
xhci
, 
¦Ùid
, 
i
);

1896 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

1897 
¦Ù_ùx
[3] &ğ~(
SLOT_STATE_MASK
 << 
SLOT_STATE_SHIFT
);

1898 
¦Ù_ùx
[3] |ğ
SLOT_ADDRESSED
 << 
SLOT_STATE_SHIFT
;

1899 
	`DPRINTF
("xhci: output slot context: %08x %08x %08x %08x\n",

1900 
¦Ù_ùx
[0], slot_ctx[1], slot_ctx[2], slot_ctx[3]);

1901 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

1903  
CC_SUCCESS
;

1906 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
, 
iùl_ùx
, (ictl_ctx));

1908 ià((
iùl_ùx
[0] & 0x3) != 0x0 || (ictl_ctx[1] & 0x3) != 0x1) {

1909 
	`årštf
(
¡d”r
, "xhci: invalid input context control %08x %08x\n",

1910 
iùl_ùx
[0], ictl_ctx[1]);

1911  
CC_TRB_ERROR
;

1914 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
+32, 
i¦Ù_ùx
, (islot_ctx));

1915 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

1917 ià(
	`SLOT_STATE
(
¦Ù_ùx
[3]è< 
SLOT_ADDRESSED
) {

1918 
	`årštf
(
¡d”r
, "xhci: inv®id slÙ s‹ %08x\n", 
¦Ù_ùx
[3]);

1919  
CC_CONTEXT_STATE_ERROR
;

1922 
i
 = 2; i <= 31; i++) {

1923 ià(
iùl_ùx
[0] & (1<<
i
)) {

1924 
	`xhci_di§bË_•
(
xhci
, 
¦Ùid
, 
i
);

1926 ià(
iùl_ùx
[1] & (1<<
i
)) {

1927 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
+32+(32*
i
), 
•_ùx
,

1928 (
•_ùx
));

1929 
	`DPRINTF
("xhci: inputƒp%d.%d context: %08x %08x %08x %08x %08x\n",

1930 
i
/2, i%2, 
•_ùx
[0],ƒp_ctx[1],ƒp_ctx[2],

1931 
•_ùx
[3],ƒp_ctx[4]);

1932 
	`xhci_di§bË_•
(
xhci
, 
¦Ùid
, 
i
);

1933 
»s
 = 
	`xhci_’abË_•
(
xhci
, 
¦Ùid
, 
i
, 
oùx
+(32*i), 
•_ùx
);

1934 ià(
»s
 !ğ
CC_SUCCESS
) {

1935  
»s
;

1937 
	`DPRINTF
("xhci: outputƒp%d.%d context: %08x %08x %08x %08x %08x\n",

1938 
i
/2, i%2, 
•_ùx
[0],ƒp_ctx[1],ƒp_ctx[2],

1939 
•_ùx
[3],ƒp_ctx[4]);

1940 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
+(32*
i
), 
•_ùx
, (ep_ctx));

1944 
¦Ù_ùx
[3] &ğ~(
SLOT_STATE_MASK
 << 
SLOT_STATE_SHIFT
);

1945 
¦Ù_ùx
[3] |ğ
SLOT_CONFIGURED
 << 
SLOT_STATE_SHIFT
;

1946 
¦Ù_ùx
[0] &ğ~(
SLOT_CONTEXT_ENTRIES_MASK
 << 
SLOT_CONTEXT_ENTRIES_SHIFT
);

1947 
¦Ù_ùx
[0] |ğ
i¦Ù_ùx
[0] & (
SLOT_CONTEXT_ENTRIES_MASK
 <<

1948 
SLOT_CONTEXT_ENTRIES_SHIFT
);

1949 
	`DPRINTF
("xhci: output slot context: %08x %08x %08x %08x\n",

1950 
¦Ù_ùx
[0], slot_ctx[1], slot_ctx[2], slot_ctx[3]);

1952 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

1954  
CC_SUCCESS
;

1955 
	}
}

1958 
TRBCCode
 
	$xhci_ev®u©e_¦Ù
(
XHCIS‹
 *
xhci
, 
¦Ùid
,

1959 
ušt64_t
 
piùx
)

1961 
dma_addr_t
 
iùx
, 
oùx
;

1962 
ušt32_t
 
iùl_ùx
[2];

1963 
ušt32_t
 
›p0_ùx
[5];

1964 
ušt32_t
 
•0_ùx
[5];

1965 
ušt32_t
 
i¦Ù_ùx
[4];

1966 
ušt32_t
 
¦Ù_ùx
[4];

1968 
	`Œaû_usb_xhci_¦Ù_ev®u©e
(
¦Ùid
);

1969 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

1971 
iùx
 = 
	`xhci_mask64
(
piùx
);

1972 
oùx
 = 
xhci
->
¦Ùs
[
¦Ùid
-1].
ùx
;

1974 
	`DPRINTF
("xhci: iÅuˆcÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
iùx
);

1975 
	`DPRINTF
("xhci: ouuˆcÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
oùx
);

1977 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
, 
iùl_ùx
, (ictl_ctx));

1979 ià(
iùl_ùx
[0] != 0x0 || ictl_ctx[1] & ~0x3) {

1980 
	`årštf
(
¡d”r
, "xhci: invalid input context control %08x %08x\n",

1981 
iùl_ùx
[0], ictl_ctx[1]);

1982  
CC_TRB_ERROR
;

1985 ià(
iùl_ùx
[1] & 0x1) {

1986 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
+32, 
i¦Ù_ùx
, (islot_ctx));

1988 
	`DPRINTF
("xhci: input slot context: %08x %08x %08x %08x\n",

1989 
i¦Ù_ùx
[0], islot_ctx[1], islot_ctx[2], islot_ctx[3]);

1991 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

1993 
¦Ù_ùx
[1] &= ~0xFFFF;

1994 
¦Ù_ùx
[1] |ğ
i¦Ù_ùx
[1] & 0xFFFF;

1995 
¦Ù_ùx
[2] &= ~0xFF00000;

1996 
¦Ù_ùx
[2] |ğ
i¦Ù_ùx
[2] & 0xFF000000;

1998 
	`DPRINTF
("xhci: output slot context: %08x %08x %08x %08x\n",

1999 
¦Ù_ùx
[0], slot_ctx[1], slot_ctx[2], slot_ctx[3]);

2001 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

2004 ià(
iùl_ùx
[1] & 0x2) {

2005 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
iùx
+64, 
›p0_ùx
, (iep0_ctx));

2007 
	`DPRINTF
("xhci: inputƒp0 context: %08x %08x %08x %08x %08x\n",

2008 
›p0_ùx
[0], iep0_ctx[1], iep0_ctx[2],

2009 
›p0_ùx
[3], iep0_ctx[4]);

2011 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
oùx
+32, 
•0_ùx
, (ep0_ctx));

2013 
•0_ùx
[1] &= ~0xFFFF0000;

2014 
•0_ùx
[1] |ğ
›p0_ùx
[1] & 0xFFFF0000;

2016 
	`DPRINTF
("xhci: outputƒp0 context: %08x %08x %08x %08x %08x\n",

2017 
•0_ùx
[0],ƒp0_ctx[1],ƒp0_ctx[2],ƒp0_ctx[3],ƒp0_ctx[4]);

2019 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
+32, 
•0_ùx
, (ep0_ctx));

2022  
CC_SUCCESS
;

2023 
	}
}

2025 
TRBCCode
 
	$xhci_»£t_¦Ù
(
XHCIS‹
 *
xhci
, 
¦Ùid
)

2027 
ušt32_t
 
¦Ù_ùx
[4];

2028 
dma_addr_t
 
oùx
;

2029 
i
;

2031 
	`Œaû_usb_xhci_¦Ù_»£t
(
¦Ùid
);

2032 
	`as£¹
(
¦Ùid
 >ğ1 && slÙid <ğ
MAXSLOTS
);

2034 
oùx
 = 
xhci
->
¦Ùs
[
¦Ùid
-1].
ùx
;

2036 
	`DPRINTF
("xhci: ouuˆcÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
oùx
);

2038 
i
 = 2; i <= 31; i++) {

2039 ià(
xhci
->
¦Ùs
[
¦Ùid
-1].
•s
[
i
-1]) {

2040 
	`xhci_di§bË_•
(
xhci
, 
¦Ùid
, 
i
);

2044 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

2045 
¦Ù_ùx
[3] &ğ~(
SLOT_STATE_MASK
 << 
SLOT_STATE_SHIFT
);

2046 
¦Ù_ùx
[3] |ğ
SLOT_DEFAULT
 << 
SLOT_STATE_SHIFT
;

2047 
	`DPRINTF
("xhci: output slot context: %08x %08x %08x %08x\n",

2048 
¦Ù_ùx
[0], slot_ctx[1], slot_ctx[2], slot_ctx[3]);

2049 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
oùx
, 
¦Ù_ùx
, (slot_ctx));

2051  
CC_SUCCESS
;

2052 
	}
}

2054 
	$xhci_g‘_¦Ù
(
XHCIS‹
 *
xhci
, 
XHCIEv’t
 *
ev’t
, 
XHCITRB
 *
Œb
)

2056 
¦Ùid
;

2057 
¦Ùid
 = (
Œb
->
cÚŒŞ
 >> 
TRB_CR_SLOTID_SHIFT
è& 
TRB_CR_SLOTID_MASK
;

2058 ià(
¦Ùid
 < 1 || slÙid > 
MAXSLOTS
) {

2059 
	`årštf
(
¡d”r
, "xhci: bad slÙ id %d\n", 
¦Ùid
);

2060 
ev’t
->
ccode
 = 
CC_TRB_ERROR
;

2062 } ià(!
xhci
->
¦Ùs
[
¦Ùid
-1].
’abËd
) {

2063 
	`årštf
(
¡d”r
, "xhci: slÙ id %d‚ÙƒÇbËd\n", 
¦Ùid
);

2064 
ev’t
->
ccode
 = 
CC_SLOT_NOT_ENABLED_ERROR
;

2067  
¦Ùid
;

2068 
	}
}

2070 
TRBCCode
 
	$xhci_g‘_pÜt_bªdwidth
(
XHCIS‹
 *
xhci
, 
ušt64_t
 
pùx
)

2072 
dma_addr_t
 
ùx
;

2073 
ušt8_t
 
bw_ùx
[
MAXPORTS
+1];

2075 
	`DPRINTF
("xhci_get_port_bandwidth()\n");

2077 
ùx
 = 
	`xhci_mask64
(
pùx
);

2079 
	`DPRINTF
("xhci: bªdwidth cÚ‹xˆ© "
DMA_ADDR_FMT
"\n", 
ùx
);

2082 
bw_ùx
[0] = 0;

2083 
	`mem£t
(&
bw_ùx
[1], 80, 
MAXPORTS
);

2084 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
ùx
, 
bw_ùx
, (bw_ctx));

2086  
CC_SUCCESS
;

2087 
	}
}

2089 
ušt32_t
 
	$rÙl
(
ušt32_t
 
v
, 
couÁ
)

2091 
couÁ
 &= 31;

2092  (
v
 << 
couÁ
) | (v >> (32 - count));

2093 
	}
}

2096 
ušt32_t
 
	$xhci_Ãc_ch®Ënge
(
ušt32_t
 
hi
, ušt32_ˆ
lo
)

2098 
ušt32_t
 
v®
;

2099 
v®
 = 
	`rÙl
(
lo
 - 0x49434878, 32 - ((
hi
>>8) & 0x1F));

2100 
v®
 +ğ
	`rÙl
(
lo
 + 0x49434878, 
hi
 & 0x1F);

2101 
v®
 -ğ
	`rÙl
(
hi
 ^ 0x49434878, (
lo
 >> 16) & 0x1F);

2102  ~
v®
;

2103 
	}
}

2105 
	$xhci_vŸ_ch®Ënge
(
XHCIS‹
 *
xhci
, 
ušt64_t
 
addr
)

2107 
ušt32_t
 
buf
[8];

2108 
ušt32_t
 
obuf
[8];

2109 
dma_addr_t
 
·ddr
 = 
	`xhci_mask64
(
addr
);

2111 
	`pci_dma_»ad
(&
xhci
->
pci_dev
, 
·ddr
, &
buf
, 32);

2113 
	`memıy
(
obuf
, 
buf
, (obuf));

2115 ià((
buf
[0] & 0xff) == 2) {

2116 
obuf
[0] = 0x49932000 + 0x54dc200 * 
buf
[2] + 0x7429b578 * buf[3];

2117 
obuf
[0] |ğ(
buf
[2] * buf[3]) & 0xff;

2118 
obuf
[1] = 0x0132bb37 + 0xe89 * 
buf
[2] + 0xf09 * buf[3];

2119 
obuf
[2] = 0x0066c2e9 + 0x2091 * 
buf
[2] + 0x19bd * buf[3];

2120 
obuf
[3] = 0xd5281342 + 0x2cc9691 * 
buf
[2] + 0x2367662 * buf[3];

2121 
obuf
[4] = 0x0123c75ø+ 0x1595 * 
buf
[2] + 0x19ec * buf[3];

2122 
obuf
[5] = 0x00f695d+ 0x26fd * 
buf
[2] + 0x3e9 * buf[3];

2123 
obuf
[6] = obuf[2] ^ obuf[3] ^ 0x29472956;

2124 
obuf
[7] = obuf[2] ^ obuf[3] ^ 0x65866593;

2127 
	`pci_dma_wr™e
(&
xhci
->
pci_dev
, 
·ddr
, &
obuf
, 32);

2128 
	}
}

2130 
	$xhci_´oûss_commªds
(
XHCIS‹
 *
xhci
)

2132 
XHCITRB
 
Œb
;

2133 
TRBTy³
 
ty³
;

2134 
XHCIEv’t
 
ev’t
 = {
ER_COMMAND_COMPLETE
, 
CC_SUCCESS
};

2135 
dma_addr_t
 
addr
;

2136 
i
, 
¦Ùid
 = 0;

2138 
	`DPRINTF
("xhci_process_commands()\n");

2139 ià(!
	`xhci_ruÂšg
(
xhci
)) {

2140 
	`DPRINTF
("xhci_process_commands() called while xHC stopped or…aused\n");

2144 
xhci
->
üü_low
 |ğ
CRCR_CRR
;

2146 (
ty³
 = 
	`xhci_ršg_ãtch
(
xhci
, &xhci->
cmd_ršg
, &
Œb
, &
addr
))) {

2147 
ev’t
.
±r
 = 
addr
;

2148 
ty³
) {

2149 
CR_ENABLE_SLOT
:

2150 
i
 = 0; i < 
MAXSLOTS
; i++) {

2151 ià(!
xhci
->
¦Ùs
[
i
].
’abËd
) {

2155 ià(
i
 >ğ
MAXSLOTS
) {

2156 
	`årštf
(
¡d”r
, "xhci:‚o device slots‡vailable\n");

2157 
ev’t
.
ccode
 = 
CC_NO_SLOTS_ERROR
;

2159 
¦Ùid
 = 
i
+1;

2160 
ev’t
.
ccode
 = 
	`xhci_’abË_¦Ù
(
xhci
, 
¦Ùid
);

2163 
CR_DISABLE_SLOT
:

2164 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2165 ià(
¦Ùid
) {

2166 
ev’t
.
ccode
 = 
	`xhci_di§bË_¦Ù
(
xhci
, 
¦Ùid
);

2169 
CR_ADDRESS_DEVICE
:

2170 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2171 ià(
¦Ùid
) {

2172 
ev’t
.
ccode
 = 
	`xhci_add»ss_¦Ù
(
xhci
, 
¦Ùid
, 
Œb
.
·¿m‘”
,

2173 
Œb
.
cÚŒŞ
 & 
TRB_CR_BSR
);

2176 
CR_CONFIGURE_ENDPOINT
:

2177 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2178 ià(
¦Ùid
) {

2179 
ev’t
.
ccode
 = 
	`xhci_cÚfigu»_¦Ù
(
xhci
, 
¦Ùid
, 
Œb
.
·¿m‘”
,

2180 
Œb
.
cÚŒŞ
 & 
TRB_CR_DC
);

2183 
CR_EVALUATE_CONTEXT
:

2184 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2185 ià(
¦Ùid
) {

2186 
ev’t
.
ccode
 = 
	`xhci_ev®u©e_¦Ù
(
xhci
, 
¦Ùid
, 
Œb
.
·¿m‘”
);

2189 
CR_STOP_ENDPOINT
:

2190 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2191 ià(
¦Ùid
) {

2192 
•id
 = (
Œb
.
cÚŒŞ
 >> 
TRB_CR_EPID_SHIFT
)

2193 & 
TRB_CR_EPID_MASK
;

2194 
ev’t
.
ccode
 = 
	`xhci_¡İ_•
(
xhci
, 
¦Ùid
, 
•id
);

2197 
CR_RESET_ENDPOINT
:

2198 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2199 ià(
¦Ùid
) {

2200 
•id
 = (
Œb
.
cÚŒŞ
 >> 
TRB_CR_EPID_SHIFT
)

2201 & 
TRB_CR_EPID_MASK
;

2202 
ev’t
.
ccode
 = 
	`xhci_»£t_•
(
xhci
, 
¦Ùid
, 
•id
);

2205 
CR_SET_TR_DEQUEUE
:

2206 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2207 ià(
¦Ùid
) {

2208 
•id
 = (
Œb
.
cÚŒŞ
 >> 
TRB_CR_EPID_SHIFT
)

2209 & 
TRB_CR_EPID_MASK
;

2210 
ev’t
.
ccode
 = 
	`xhci_£t_•_dequeue
(
xhci
, 
¦Ùid
, 
•id
,

2211 
Œb
.
·¿m‘”
);

2214 
CR_RESET_DEVICE
:

2215 
¦Ùid
 = 
	`xhci_g‘_¦Ù
(
xhci
, &
ev’t
, &
Œb
);

2216 ià(
¦Ùid
) {

2217 
ev’t
.
ccode
 = 
	`xhci_»£t_¦Ù
(
xhci
, 
¦Ùid
);

2220 
CR_GET_PORT_BANDWIDTH
:

2221 
ev’t
.
ccode
 = 
	`xhci_g‘_pÜt_bªdwidth
(
xhci
, 
Œb
.
·¿m‘”
);

2223 
CR_VENDOR_VIA_CHALLENGE_RESPONSE
:

2224 
	`xhci_vŸ_ch®Ënge
(
xhci
, 
Œb
.
·¿m‘”
);

2226 
CR_VENDOR_NEC_FIRMWARE_REVISION
:

2227 
ev’t
.
ty³
 = 48;

2228 
ev’t
.
Ëngth
 = 0x3025;

2230 
CR_VENDOR_NEC_CHALLENGE_RESPONSE
:

2232 
ušt32_t
 
chi
 = 
Œb
.
·¿m‘”
 >> 32;

2233 
ušt32_t
 
şo
 = 
Œb
.
·¿m‘”
;

2234 
ušt32_t
 
v®
 = 
	`xhci_Ãc_ch®Ënge
(
chi
, 
şo
);

2235 
ev’t
.
Ëngth
 = 
v®
 & 0xFFFF;

2236 
ev’t
.
•id
 = 
v®
 >> 16;

2237 
¦Ùid
 = 
v®
 >> 24;

2238 
ev’t
.
ty³
 = 48;

2242 
	`årštf
(
¡d”r
, "xhci: unim¶em’‹d commªd %d\n", 
ty³
);

2243 
ev’t
.
ccode
 = 
CC_TRB_ERROR
;

2246 
ev’t
.
¦Ùid
 = slotid;

2247 
	`xhci_ev’t
(
xhci
, &
ev’t
);

2249 
	}
}

2251 
	$xhci_upd©e_pÜt
(
XHCIS‹
 *
xhci
, 
XHCIPÜt
 *
pÜt
, 
is_d‘ach
)

2253 
Ä
 = 
pÜt
->pÜt.
šdex
 + 1;

2255 
pÜt
->
pÜtsc
 = 
PORTSC_PP
;

2256 ià(
pÜt
->pÜt.
dev
 &&…Üt->pÜt.dev->
©ched
 && !
is_d‘ach
) {

2257 
pÜt
->
pÜtsc
 |ğ
PORTSC_CCS
;

2258 
pÜt
->pÜt.
dev
->
¥“d
) {

2259 
USB_SPEED_LOW
:

2260 
pÜt
->
pÜtsc
 |ğ
PORTSC_SPEED_LOW
;

2262 
USB_SPEED_FULL
:

2263 
pÜt
->
pÜtsc
 |ğ
PORTSC_SPEED_FULL
;

2265 
USB_SPEED_HIGH
:

2266 
pÜt
->
pÜtsc
 |ğ
PORTSC_SPEED_HIGH
;

2271 ià(
	`xhci_ruÂšg
(
xhci
)) {

2272 
pÜt
->
pÜtsc
 |ğ
PORTSC_CSC
;

2273 
XHCIEv’t
 
ev
 = { 
ER_PORT_STATUS_CHANGE
, 
CC_SUCCESS
, 
Ä
 << 24};

2274 
	`xhci_ev’t
(
xhci
, &
ev
);

2275 
	`DPRINTF
("xhci:…Üˆchªgev’ˆfÜ…Üˆ%d\n", 
Ä
);

2277 
	}
}

2279 
	$xhci_»£t
(
DeviûS‹
 *
dev
)

2281 
XHCIS‹
 *
xhci
 = 
	`DO_UPCAST
(XHCIS‹, 
pci_dev
.
qdev
, 
dev
);

2282 
i
;

2284 
	`Œaû_usb_xhci_»£t
();

2285 ià(!(
xhci
->
usb¡s
 & 
USBSTS_HCH
)) {

2286 
	`årštf
(
¡d”r
, "xhci:„eset while„unning!\n");

2289 
xhci
->
usbcmd
 = 0;

2290 
xhci
->
usb¡s
 = 
USBSTS_HCH
;

2291 
xhci
->
dnù¾
 = 0;

2292 
xhci
->
üü_low
 = 0;

2293 
xhci
->
üü_high
 = 0;

2294 
xhci
->
dcb¯p_low
 = 0;

2295 
xhci
->
dcb¯p_high
 = 0;

2296 
xhci
->
cÚfig
 = 0;

2297 
xhci
->
devaddr
 = 2;

2299 
i
 = 0; i < 
MAXSLOTS
; i++) {

2300 
	`xhci_di§bË_¦Ù
(
xhci
, 
i
+1);

2303 
i
 = 0; i < 
MAXPORTS
; i++) {

2304 
	`xhci_upd©e_pÜt
(
xhci
, xhci->
pÜts
 + 
i
, 0);

2307 
xhci
->
mfšdex
 = 0;

2308 
xhci
->
imª
 = 0;

2309 
xhci
->
imod
 = 0;

2310 
xhci
->
”¡sz
 = 0;

2311 
xhci
->
”¡ba_low
 = 0;

2312 
xhci
->
”¡ba_high
 = 0;

2313 
xhci
->
”dp_low
 = 0;

2314 
xhci
->
”dp_high
 = 0;

2316 
xhci
->
”_•_idx
 = 0;

2317 
xhci
->
”_pcs
 = 1;

2318 
xhci
->
”_fuÎ
 = 0;

2319 
xhci
->
ev_bufãr_put
 = 0;

2320 
xhci
->
ev_bufãr_g‘
 = 0;

2321 
	}
}

2323 
ušt32_t
 
	$xhci_ÿp_»ad
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
)

2325 
ušt32_t
 
»t
;

2327 
»g
) {

2329 
»t
 = 0x01000000 | 
LEN_CAP
;

2332 
»t
 = (
MAXPORTS
<<24è| (
MAXINTRS
<<8è| 
MAXSLOTS
;

2335 
»t
 = 0x0000000f;

2338 
»t
 = 0x00000000;

2341 ià((
dma_addr_t
) == 4) {

2342 
»t
 = 0x00081000;

2344 
»t
 = 0x00081001;

2348 
»t
 = 
OFF_DOORBELL
;

2351 
»t
 = 
OFF_RUNTIME
;

2356 
»t
 = 0x02000402;

2359 
»t
 = 0x20425455;

2362 
»t
 = 0x00000001 | (
USB2_PORTS
<<8);

2365 
»t
 = 0x00000000;

2368 
»t
 = 0x03000002;

2371 
»t
 = 0x20425455;

2374 
»t
 = 0x00000000 | (
USB2_PORTS
+1è| (
USB3_PORTS
<<8);

2377 
»t
 = 0x00000000;

2380 
	`årštf
(
¡d”r
, "xhci_ÿp_»ad:„eg %d unim¶em’‹d\n", 
»g
);

2381 
»t
 = 0;

2384 
	`Œaû_usb_xhci_ÿp_»ad
(
»g
, 
»t
);

2385  
»t
;

2386 
	}
}

2388 
ušt32_t
 
	$xhci_pÜt_»ad
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
)

2390 
ušt32_t
 
pÜt
 = 
»g
 >> 4;

2391 
ušt32_t
 
»t
;

2393 ià(
pÜt
 >ğ
MAXPORTS
) {

2394 
	`årštf
(
¡d”r
, "xhci_pÜt_»ad:…Üˆ%d ouˆoàbounds\n", 
pÜt
);

2395 
»t
 = 0;

2396 
out
;

2399 
»g
 & 0xf) {

2401 
»t
 = 
xhci
->
pÜts
[
pÜt
].
pÜtsc
;

2405 
»t
 = 0;

2409 
	`årštf
(
¡d”r
, "xhci_port_read (port %d):„eg 0x%x unimplemented\n",

2410 
pÜt
, 
»g
);

2411 
»t
 = 0;

2414 
out
:

2415 
	`Œaû_usb_xhci_pÜt_»ad
(
pÜt
, 
»g
 & 0x0f, 
»t
);

2416  
»t
;

2417 
	}
}

2419 
	$xhci_pÜt_wr™e
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
, ušt32_ˆ
v®
)

2421 
ušt32_t
 
pÜt
 = 
»g
 >> 4;

2422 
ušt32_t
 
pÜtsc
;

2424 
	`Œaû_usb_xhci_pÜt_wr™e
(
pÜt
, 
»g
 & 0x0f, 
v®
);

2426 ià(
pÜt
 >ğ
MAXPORTS
) {

2427 
	`årštf
(
¡d”r
, "xhci_pÜt_»ad:…Üˆ%d ouˆoàbounds\n", 
pÜt
);

2431 
»g
 & 0xf) {

2433 
pÜtsc
 = 
xhci
->
pÜts
[
pÜt
].portsc;

2435 
pÜtsc
 &ğ~(
v®
 & (
PORTSC_CSC
|
PORTSC_PEC
|
PORTSC_WRC
|
PORTSC_OCC
|

2436 
PORTSC_PRC
|
PORTSC_PLC
|
PORTSC_CEC
));

2437 ià(
v®
 & 
PORTSC_LWS
) {

2439 
pÜtsc
 &ğ~(
PORTSC_PLS_MASK
 << 
PORTSC_PLS_SHIFT
);

2440 
pÜtsc
 |ğ
v®
 & (
PORTSC_PLS_MASK
 << 
PORTSC_PLS_SHIFT
);

2443 
pÜtsc
 &ğ~(
PORTSC_PP
|
PORTSC_WCE
|
PORTSC_WDE
|
PORTSC_WOE
);

2444 
pÜtsc
 |ğ(
v®
 & (
PORTSC_PP
|
PORTSC_WCE
|
PORTSC_WDE
|
PORTSC_WOE
));

2446 ià(
v®
 & 
PORTSC_PR
) {

2447 
	`DPRINTF
("xhci:…Üˆ%d„e£t\n", 
pÜt
);

2448 
	`usb_deviû_»£t
(
xhci
->
pÜts
[
pÜt
].pÜt.
dev
);

2449 
pÜtsc
 |ğ
PORTSC_PRC
 | 
PORTSC_PED
;

2451 
xhci
->
pÜts
[
pÜt
].
pÜtsc
 =…ortsc;

2456 
	`årštf
(
¡d”r
, "xhci_port_write (port %d):„eg 0x%x unimplemented\n",

2457 
pÜt
, 
»g
);

2459 
	}
}

2461 
ušt32_t
 
	$xhci_İ”_»ad
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
)

2463 
ušt32_t
 
»t
;

2465 ià(
»g
 >= 0x400) {

2466  
	`xhci_pÜt_»ad
(
xhci
, 
»g
 - 0x400);

2469 
»g
) {

2471 
»t
 = 
xhci
->
usbcmd
;

2474 
»t
 = 
xhci
->
usb¡s
;

2477 
»t
 = 1;

2480 
»t
 = 
xhci
->
dnù¾
;

2483 
»t
 = 
xhci
->
üü_low
 & ~0xe;

2486 
»t
 = 
xhci
->
üü_high
;

2489 
»t
 = 
xhci
->
dcb¯p_low
;

2492 
»t
 = 
xhci
->
dcb¯p_high
;

2495 
»t
 = 
xhci
->
cÚfig
;

2498 
	`årštf
(
¡d”r
, "xhci_İ”_»ad:„eg 0x%x unim¶em’‹d\n", 
»g
);

2499 
»t
 = 0;

2502 
	`Œaû_usb_xhci_İ”_»ad
(
»g
, 
»t
);

2503  
»t
;

2504 
	}
}

2506 
	$xhci_İ”_wr™e
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
, ušt32_ˆ
v®
)

2508 ià(
»g
 >= 0x400) {

2509 
	`xhci_pÜt_wr™e
(
xhci
, 
»g
 - 0x400, 
v®
);

2513 
	`Œaû_usb_xhci_İ”_wr™e
(
»g
, 
v®
);

2515 
»g
) {

2517 ià((
v®
 & 
USBCMD_RS
è&& !(
xhci
->
usbcmd
 & USBCMD_RS)) {

2518 
	`xhci_run
(
xhci
);

2519 } ià(!(
v®
 & 
USBCMD_RS
è&& (
xhci
->
usbcmd
 & USBCMD_RS)) {

2520 
	`xhci_¡İ
(
xhci
);

2522 
xhci
->
usbcmd
 = 
v®
 & 0xc0f;

2523 ià(
v®
 & 
USBCMD_HCRST
) {

2524 
	`xhci_»£t
(&
xhci
->
pci_dev
.
qdev
);

2526 
	`xhci_œq_upd©e
(
xhci
);

2531 
xhci
->
usb¡s
 &ğ~(
v®
 & (
USBSTS_HSE
|
USBSTS_EINT
|
USBSTS_PCD
|
USBSTS_SRE
));

2532 
	`xhci_œq_upd©e
(
xhci
);

2536 
xhci
->
dnù¾
 = 
v®
 & 0xffff;

2539 
xhci
->
üü_low
 = (
v®
 & 0xffffffcfè| (xhci->üü_low & 
CRCR_CRR
);

2542 
xhci
->
üü_high
 = 
v®
;

2543 ià(
xhci
->
üü_low
 & (
CRCR_CA
|
CRCR_CS
è&& (xhci->üü_low & 
CRCR_CRR
)) {

2544 
XHCIEv’t
 
ev’t
 = {
ER_COMMAND_COMPLETE
, 
CC_COMMAND_RING_STOPPED
};

2545 
xhci
->
üü_low
 &ğ~
CRCR_CRR
;

2546 
	`xhci_ev’t
(
xhci
, &
ev’t
);

2547 
	`DPRINTF
("xhci: commªd„šg stİ³d (CRCR=%08x)\n", 
xhci
->
üü_low
);

2549 
dma_addr_t
 
ba£
 = 
	`xhci_addr64
(
xhci
->
üü_low
 & ~0x3f, 
v®
);

2550 
	`xhci_ršg_š™
(
xhci
, &xhci->
cmd_ršg
, 
ba£
);

2552 
xhci
->
üü_low
 &ğ~(
CRCR_CA
 | 
CRCR_CS
);

2555 
xhci
->
dcb¯p_low
 = 
v®
 & 0xffffffc0;

2558 
xhci
->
dcb¯p_high
 = 
v®
;

2561 
xhci
->
cÚfig
 = 
v®
 & 0xff;

2564 
	`årštf
(
¡d”r
, "xhci_İ”_wr™e:„eg 0x%x unim¶em’‹d\n", 
»g
);

2566 
	}
}

2568 
ušt32_t
 
	$xhci_ruÁime_»ad
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
)

2570 
ušt32_t
 
»t
;

2572 
»g
) {

2574 
	`årštf
(
¡d”r
, "xhci_runtime_read: MFINDEX‚ot yet implemented\n");

2575 
»t
 = 
xhci
->
mfšdex
;

2578 
»t
 = 
xhci
->
imª
;

2581 
»t
 = 
xhci
->
imod
;

2584 
»t
 = 
xhci
->
”¡sz
;

2587 
»t
 = 
xhci
->
”¡ba_low
;

2590 
»t
 = 
xhci
->
”¡ba_high
;

2593 
»t
 = 
xhci
->
”dp_low
;

2596 
»t
 = 
xhci
->
”dp_high
;

2599 
	`årštf
(
¡d”r
, "xhci_ruÁime_»ad:„eg 0x%x unim¶em’‹d\n", 
»g
);

2600 
»t
 = 0;

2603 
	`Œaû_usb_xhci_ruÁime_»ad
(
»g
, 
»t
);

2604  
»t
;

2605 
	}
}

2607 
	$xhci_ruÁime_wr™e
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
, ušt32_ˆ
v®
)

2609 
	`Œaû_usb_xhci_ruÁime_»ad
(
»g
, 
v®
);

2611 
»g
) {

2613 ià(
v®
 & 
IMAN_IP
) {

2614 
xhci
->
imª
 &ğ~
IMAN_IP
;

2616 
xhci
->
imª
 &ğ~
IMAN_IE
;

2617 
xhci
->
imª
 |ğ
v®
 & 
IMAN_IE
;

2618 
	`xhci_œq_upd©e
(
xhci
);

2621 
xhci
->
imod
 = 
v®
;

2624 
xhci
->
”¡sz
 = 
v®
 & 0xffff;

2629 
xhci
->
”¡ba_low
 = 
v®
 & 0xfffffff0;

2632 
xhci
->
”¡ba_high
 = 
v®
;

2633 
	`xhci_”_»£t
(
xhci
);

2636 ià(
v®
 & 
ERDP_EHB
) {

2637 
xhci
->
”dp_low
 &ğ~
ERDP_EHB
;

2639 
xhci
->
”dp_low
 = (
v®
 & ~
ERDP_EHB
) | (xhci->erdp_low & ERDP_EHB);

2642 
xhci
->
”dp_high
 = 
v®
;

2643 
	`xhci_ev’ts_upd©e
(
xhci
);

2646 
	`årštf
(
¡d”r
, "xhci_İ”_wr™e:„eg 0x%x unim¶em’‹d\n", 
»g
);

2648 
	}
}

2650 
ušt32_t
 
	$xhci_doÜb–l_»ad
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
)

2653 
	`Œaû_usb_xhci_doÜb–l_»ad
(
»g
, 0);

2655 
	}
}

2657 
	$xhci_doÜb–l_wr™e
(
XHCIS‹
 *
xhci
, 
ušt32_t
 
»g
, ušt32_ˆ
v®
)

2659 
	`Œaû_usb_xhci_doÜb–l_wr™e
(
»g
, 
v®
);

2661 ià(!
	`xhci_ruÂšg
(
xhci
)) {

2662 
	`årštf
(
¡d”r
, "xhci: wrote doorbell while xHC stopped or…aused\n");

2666 
»g
 >>= 2;

2668 ià(
»g
 == 0) {

2669 ià(
v®
 == 0) {

2670 
	`xhci_´oûss_commªds
(
xhci
);

2672 
	`årštf
(
¡d”r
, "xhci: bad doÜb–È0 wr™e: 0x%x\n", 
v®
);

2675 ià(
»g
 > 
MAXSLOTS
) {

2676 
	`årštf
(
¡d”r
, "xhci: bad doÜb–È%d\n", 
»g
);

2677 } ià(
v®
 > 31) {

2678 
	`årštf
(
¡d”r
, "xhci: bad doÜb–È%d wr™e: 0x%x\n", 
»g
, 
v®
);

2680 
	`xhci_kick_•
(
xhci
, 
»g
, 
v®
);

2683 
	}
}

2685 
ušt64_t
 
	$xhci_mem_»ad
(*
±r
, 
rg‘_phys_addr_t
 
addr
,

2686 
size
)

2688 
XHCIS‹
 *
xhci
 = 
±r
;

2691 ià(
addr
 & 3) {

2692 
	`årštf
(
¡d”r
, "xhci_mem_read: Mis-aligned„ead\n");

2696 ià(
addr
 < 
LEN_CAP
) {

2697  
	`xhci_ÿp_»ad
(
xhci
, 
addr
);

2698 } ià(
addr
 >ğ
OFF_OPER
 &&‡dd¸< (OFF_OPER + 
LEN_OPER
)) {

2699  
	`xhci_İ”_»ad
(
xhci
, 
addr
 - 
OFF_OPER
);

2700 } ià(
addr
 >ğ
OFF_RUNTIME
 &&‡dd¸< (OFF_RUNTIME + 
LEN_RUNTIME
)) {

2701  
	`xhci_ruÁime_»ad
(
xhci
, 
addr
 - 
OFF_RUNTIME
);

2702 } ià(
addr
 >ğ
OFF_DOORBELL
 &&‡dd¸< (OFF_DOORBELL + 
LEN_DOORBELL
)) {

2703  
	`xhci_doÜb–l_»ad
(
xhci
, 
addr
 - 
OFF_DOORBELL
);

2705 
	`årštf
(
¡d”r
, "xhci_mem_»ad: Bad off£ˆ%x\n", ()
addr
);

2708 
	}
}

2710 
	$xhci_mem_wr™e
(*
±r
, 
rg‘_phys_addr_t
 
addr
,

2711 
ušt64_t
 
v®
, 
size
)

2713 
XHCIS‹
 *
xhci
 = 
±r
;

2716 ià(
addr
 & 3) {

2717 
	`årštf
(
¡d”r
, "xhci_mem_write: Mis-aligned write\n");

2721 ià(
addr
 >ğ
OFF_OPER
 &&‡dd¸< (OFF_OPER + 
LEN_OPER
)) {

2722 
	`xhci_İ”_wr™e
(
xhci
, 
addr
 - 
OFF_OPER
, 
v®
);

2723 } ià(
addr
 >ğ
OFF_RUNTIME
 &&‡dd¸< (OFF_RUNTIME + 
LEN_RUNTIME
)) {

2724 
	`xhci_ruÁime_wr™e
(
xhci
, 
addr
 - 
OFF_RUNTIME
, 
v®
);

2725 } ià(
addr
 >ğ
OFF_DOORBELL
 &&‡dd¸< (OFF_DOORBELL + 
LEN_DOORBELL
)) {

2726 
	`xhci_doÜb–l_wr™e
(
xhci
, 
addr
 - 
OFF_DOORBELL
, 
v®
);

2728 
	`årštf
(
¡d”r
, "xhci_mem_wr™e: Bad off£ˆ%x\n", ()
addr
);

2730 
	}
}

2732 cÚ¡ 
MemÜyRegiÚOps
 
	gxhci_mem_İs
 = {

2733 .
»ad
 = 
xhci_mem_»ad
,

2734 .
	gwr™e
 = 
xhci_mem_wr™e
,

2735 .
	gv®id
.
	gmš_acûss_size
 = 4,

2736 .
	gv®id
.
	gmax_acûss_size
 = 4,

2737 .
	g’dŸÂess
 = 
DEVICE_LITTLE_ENDIAN
,

2740 
	$xhci_©ch
(
USBPÜt
 *
usbpÜt
)

2742 
XHCIS‹
 *
xhci
 = 
usbpÜt
->
İaque
;

2743 
XHCIPÜt
 *
pÜt
 = &
xhci
->
pÜts
[
usbpÜt
->
šdex
];

2745 
	`xhci_upd©e_pÜt
(
xhci
, 
pÜt
, 0);

2746 
	}
}

2748 
	$xhci_d‘ach
(
USBPÜt
 *
usbpÜt
)

2750 
XHCIS‹
 *
xhci
 = 
usbpÜt
->
İaque
;

2751 
XHCIPÜt
 *
pÜt
 = &
xhci
->
pÜts
[
usbpÜt
->
šdex
];

2753 
	`xhci_upd©e_pÜt
(
xhci
, 
pÜt
, 1);

2754 
	}
}

2756 
	$xhci_wakeup
(
USBPÜt
 *
usbpÜt
)

2758 
XHCIS‹
 *
xhci
 = 
usbpÜt
->
İaque
;

2759 
XHCIPÜt
 *
pÜt
 = &
xhci
->
pÜts
[
usbpÜt
->
šdex
];

2760 
Ä
 = 
pÜt
->pÜt.
šdex
 + 1;

2761 
XHCIEv’t
 
ev
 = { 
ER_PORT_STATUS_CHANGE
, 
CC_SUCCESS
, 
Ä
 << 24};

2762 
ušt32_t
 
¶s
;

2764 
¶s
 = (
pÜt
->
pÜtsc
 >> 
PORTSC_PLS_SHIFT
è& 
PORTSC_PLS_MASK
;

2765 ià(
¶s
 != 3) {

2768 
pÜt
->
pÜtsc
 |ğ0xà<< 
PORTSC_PLS_SHIFT
;

2769 ià(
pÜt
->
pÜtsc
 & 
PORTSC_PLC
) {

2772 
pÜt
->
pÜtsc
 |ğ
PORTSC_PLC
;

2773 
	`xhci_ev’t
(
xhci
, &
ev
);

2774 
	}
}

2776 
	$xhci_com¶‘e
(
USBPÜt
 *
pÜt
, 
USBPack‘
 *
·ck‘
)

2778 
XHCIT¿nsãr
 *
xãr
 = 
	`cÚš”_of
(
·ck‘
, XHCITransfer,…acket);

2780 
	`xhci_com¶‘e_·ck‘
(
xãr
, 
·ck‘
->
»suÉ
);

2781 
	`xhci_kick_•
(
xãr
->
xhci
, xãr->
¦Ùid
, xãr->
•id
);

2782 
	}
}

2784 
	$xhci_chd_d‘ach
(
USBPÜt
 *
pÜt
, 
USBDeviû
 *
chd
)

2786 
	`FIXME
();

2787 
	}
}

2789 
USBPÜtOps
 
	gxhci_pÜt_İs
 = {

2790 .
©ch
 = 
xhci_©ch
,

2791 .
	gd‘ach
 = 
xhci_d‘ach
,

2792 .
	gwakeup
 = 
xhci_wakeup
,

2793 .
	gcom¶‘e
 = 
xhci_com¶‘e
,

2794 .
	gchd_d‘ach
 = 
xhci_chd_d‘ach
,

2797 
	$xhci_fšd_¦Ùid
(
XHCIS‹
 *
xhci
, 
USBDeviû
 *
dev
)

2799 
XHCISlÙ
 *
¦Ù
;

2800 
¦Ùid
;

2802 
¦Ùid
 = 1; slÙid <ğ
MAXSLOTS
; slotid++) {

2803 
¦Ù
 = &
xhci
->
¦Ùs
[
¦Ùid
-1];

2804 ià(
¦Ù
->
devaddr
 =ğ
dev
->
addr
) {

2805  
¦Ùid
;

2809 
	}
}

2811 
	$xhci_fšd_•id
(
USBEndpošt
 *
•
)

2813 ià(
•
->
Ä
 == 0) {

2816 ià(
•
->
pid
 =ğ
USB_TOKEN_IN
) {

2817  
•
->
Ä
 * 2 + 1;

2819  
•
->
Ä
 * 2;

2821 
	}
}

2823 
	$xhci_wakeup_’dpošt
(
USBBus
 *
bus
, 
USBEndpošt
 *
•
)

2825 
XHCIS‹
 *
xhci
 = 
	`cÚš”_of
(
bus
, XHCIState, bus);

2826 
¦Ùid
;

2828 
	`DPRINTF
("%s\n", 
__func__
);

2829 
¦Ùid
 = 
	`xhci_fšd_¦Ùid
(
xhci
, 
•
->
dev
);

2830 ià(
¦Ùid
 =ğ0 || !
xhci
->
¦Ùs
[¦Ùid-1].
’abËd
) {

2831 
	`DPRINTF
("%s: oİs,‚Ø¦Ù fÜ dev %d\n", 
__func__
, 
•
->
dev
->
addr
);

2834 
	`xhci_kick_•
(
xhci
, 
¦Ùid
, 
	`xhci_fšd_•id
(
•
));

2835 
	}
}

2837 
USBBusOps
 
	gxhci_bus_İs
 = {

2838 .
wakeup_’dpošt
 = 
xhci_wakeup_’dpošt
,

2841 
	$usb_xhci_š™
(
XHCIS‹
 *
xhci
, 
DeviûS‹
 *
dev
)

2843 
i
;

2845 
xhci
->
usb¡s
 = 
USBSTS_HCH
;

2847 
	`usb_bus_Ãw
(&
xhci
->
bus
, &
xhci_bus_İs
, &xhci->
pci_dev
.
qdev
);

2849 
i
 = 0; i < 
MAXPORTS
; i++) {

2850 
	`mem£t
(&
xhci
->
pÜts
[
i
], 0, (xhci->ports[i]));

2851 
	`usb_»gi¡”_pÜt
(&
xhci
->
bus
, &xhci->
pÜts
[
i
].
pÜt
, xhci, i,

2852 &
xhci_pÜt_İs
,

2853 
USB_SPEED_MASK_LOW
 |

2854 
USB_SPEED_MASK_FULL
 |

2855 
USB_SPEED_MASK_HIGH
);

2857 
i
 = 0; i < 
MAXSLOTS
; i++) {

2858 
xhci
->
¦Ùs
[
i
].
’abËd
 = 0;

2860 
	}
}

2862 
	$usb_xhci_š™â
(
PCIDeviû
 *
dev
)

2864 
»t
;

2866 
XHCIS‹
 *
xhci
 = 
	`DO_UPCAST
(XHCIS‹, 
pci_dev
, 
dev
);

2868 
xhci
->
pci_dev
.
cÚfig
[
PCI_CLASS_PROG
] = 0x30;

2869 
xhci
->
pci_dev
.
cÚfig
[
PCI_INTERRUPT_PIN
] = 0x01;

2870 
xhci
->
pci_dev
.
cÚfig
[
PCI_CACHE_LINE_SIZE
] = 0x10;

2871 
xhci
->
pci_dev
.
cÚfig
[0x60] = 0x30;

2873 
	`usb_xhci_š™
(
xhci
, &
dev
->
qdev
);

2875 
xhci
->
œq
 = xhci->
pci_dev
.irq[0];

2877 
	`memÜy_»giÚ_š™_io
(&
xhci
->
mem
, &
xhci_mem_İs
, xhci,

2878 "xhci", 
LEN_REGS
);

2879 
	`pci_»gi¡”_b¬
(&
xhci
->
pci_dev
, 0,

2880 
PCI_BASE_ADDRESS_SPACE_MEMORY
|
PCI_BASE_ADDRESS_MEM_TYPE_64
,

2881 &
xhci
->
mem
);

2883 
»t
 = 
	`pc›_ÿp_š™
(&
xhci
->
pci_dev
, 0xa0, 
PCI_EXP_TYPE_ENDPOINT
, 0);

2884 
	`as£¹
(
»t
 >= 0);

2886 ià(
xhci
->
msi
) {

2887 
»t
 = 
	`msi_š™
(&
xhci
->
pci_dev
, 0x70, 1, 
Œue
, 
çl£
);

2888 
	`as£¹
(
»t
 >= 0);

2892 
	}
}

2894 
	$xhci_wr™e_cÚfig
(
PCIDeviû
 *
dev
, 
ušt32_t
 
addr
, ušt32_ˆ
v®
,

2895 
Ën
)

2897 
XHCIS‹
 *
xhci
 = 
	`DO_UPCAST
(XHCIS‹, 
pci_dev
, 
dev
);

2899 
	`pci_deçuÉ_wr™e_cÚfig
(
dev
, 
addr
, 
v®
, 
Ën
);

2900 ià(
xhci
->
msi
) {

2901 
	`msi_wr™e_cÚfig
(
dev
, 
addr
, 
v®
, 
Ën
);

2903 
	}
}

2905 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_xhci
 = {

2906 .
Çme
 = "xhci",

2907 .
	gunmig¿bË
 = 1,

2910 
Prİ”ty
 
	gxhci_´İ”t›s
[] = {

2911 
DEFINE_PROP_UINT32
("msi", 
XHCIS‹
, 
msi
, 0),

2912 
DEFINE_PROP_END_OF_LIST
(),

2915 
	$xhci_şass_š™
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

2917 
PCIDeviûCÏss
 *
k
 = 
	`PCI_DEVICE_CLASS
(
kÏss
);

2918 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

2920 
dc
->
vmsd
 = &
vm¡©e_xhci
;

2921 
dc
->
´İs
 = 
xhci_´İ”t›s
;

2922 
dc
->
»£t
 = 
xhci_»£t
;

2923 
k
->
š™
 = 
usb_xhci_š™â
;

2924 
k
->
v’dÜ_id
 = 
PCI_VENDOR_ID_NEC
;

2925 
k
->
deviû_id
 = 
PCI_DEVICE_ID_NEC_UPD720200
;

2926 
k
->
şass_id
 = 
PCI_CLASS_SERIAL_USB
;

2927 
k
->
»visiÚ
 = 0x03;

2928 
k
->
is_ex´ess
 = 1;

2929 
k
->
cÚfig_wr™e
 = 
xhci_wr™e_cÚfig
;

2930 
	}
}

2932 
Ty³Info
 
	gxhci_šfo
 = {

2933 .
Çme
 = "nec-usb-xhci",

2934 .
	g·»Á
 = 
TYPE_PCI_DEVICE
,

2935 .
	gš¡ªû_size
 = (
XHCIS‹
),

2936 .
	gşass_š™
 = 
xhci_şass_š™
,

2939 
	$xhci_»gi¡”_ty³s
()

2941 
	`ty³_»gi¡”_¡©ic
(&
xhci_šfo
);

2942 
	}
}

2944 
ty³_š™
(
xhci_»gi¡”_ty³s
)

	@host-bsd.c

27 
	~"qemu-commÚ.h
"

28 
	~"mÚ™Ü.h
"

29 
	~"hw/usb.h
"

32 #undeà
USB_SPEED_HIGH


33 #undeà
USB_SPEED_FULL


34 #undeà
USB_SPEED_LOW


36 
	~<sys/ioùl.h
>

37 #iâdeà
__D¿gÚFly__


38 
	~<dev/usb/usb.h
>

40 
	~<bus/usb/usb.h
>

48 
	#UGEN_DEBUG_LEVEL
 0

	)

51 
	tUSBSÿnFunc
(*
	tİaque
, 
	tbus_num
, 
	taddr
, 
	tşass_id
,

52 
	tv’dÜ_id
, 
	t´oduù_id
,

53 cÚ¡ *
	t´oduù_Çme
, 
	t¥“d
);

54 
usb_ho¡_fšd_deviû
(*
pbus_num
, *
·ddr
,

55 cÚ¡ *
devÇme
);

57 
	sUSBHo¡Deviû
 {

58 
USBDeviû
 
	mdev
;

59 
	m•_fd
[
USB_MAX_ENDPOINTS
];

60 
	mdevfd
;

61 
	mdev·th
[32];

62 } 
	tUSBHo¡Deviû
;

65 
	$’su»_•_İ’
(
USBHo¡Deviû
 *
dev
, 
•
, 
mode
)

67 
buf
[32];

68 
fd
;

71 
•
 = 
	`UE_GET_ADDR
(ep);

73 ià(
dev
->
•_fd
[
•
] < 0) {

74 #ià
	`defšed
(
__F»eBSD__
è|| defšed(
__D¿gÚFly__
)

75 
	`¢´štf
(
buf
, (bufè- 1, "%s.%d", 
dev
->
dev·th
, 
•
);

77 
	`¢´štf
(
buf
, (bufè- 1, "%s.%02d", 
dev
->
dev·th
, 
•
);

82 
fd
 = 
	`İ’
(
buf
, 
O_RDWR
);

83 ià(
fd
 < 0 && 
”ºo
 =ğ
ENXIO
)

84 
fd
 = 
	`İ’
(
buf
, 
mode
);

85 ià(
fd
 < 0) {

86 #ifdeà
DEBUG


87 
	`´štf
("ensure_ep_open: failedo open deviceƒndpoint %s: %s\n",

88 
buf
, 
	`¡»¼Ü
(
”ºo
));

91 
dev
->
•_fd
[
•
] = 
fd
;

94  
dev
->
•_fd
[
•
];

95 
	}
}

97 
	$’su»_•s_şo£d
(
USBHo¡Deviû
 *
dev
)

99 
•num
 = 1;

101 ià(!
dev
)

104 
•num
 < 
USB_MAX_ENDPOINTS
) {

105 ià(
dev
->
•_fd
[
•num
] >= 0) {

106 
	`şo£
(
dev
->
•_fd
[
•num
]);

107 
dev
->
•_fd
[
•num
] = -1;

109 
•num
++;

111 
	}
}

113 
	$usb_ho¡_hªdË_»£t
(
USBDeviû
 *
dev
)

116 
USBHo¡Deviû
 *
s
 = (USBHo¡Deviû *)
dev
;

118 
	}
}

124 
	$usb_ho¡_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
,

125 
USBPack‘
 *
p
,

126 
»que¡
,

127 
v®ue
,

128 
šdex
,

129 
Ëngth
,

130 
ušt8_t
 *
d©a
)

132 
USBHo¡Deviû
 *
s
 = (USBHo¡Deviû *)
dev
;

133 
usb_ùl_»que¡
 
»q
;

134 
usb_®t_š‹rçû
 
aiçû
;

135 
»t
, 
timeout
 = 50;

137 ià((
»que¡
 >> 8è=ğ
UT_WRITE_DEVICE
 &&

138 (
»que¡
 & 0xffè=ğ
UR_SET_ADDRESS
) {

141 
dev
->
addr
 = 
v®ue
;

143 } ià((
»que¡
 >> 8è=ğ
UT_WRITE_DEVICE
 &&

144 (
»que¡
 & 0xffè=ğ
UR_SET_CONFIG
) {

146 
	`’su»_•s_şo£d
(
s
);

148 
»t
 = 
	`ioùl
(
s
->
devfd
, 
USB_SET_CONFIG
, &
v®ue
);

149 ià(
»t
 < 0) {

150 #ifdeà
DEBUG


151 
	`´štf
("handle_control: failedo set configuration - %s\n",

152 
	`¡»¼Ü
(
”ºo
));

154  
USB_RET_STALL
;

158 } ià((
»que¡
 >> 8è=ğ
UT_WRITE_INTERFACE
 &&

159 (
»que¡
 & 0xffè=ğ
UR_SET_INTERFACE
) {

161 
aiçû
.
uai_š‹rçû_šdex
 = 
šdex
;

162 
aiçû
.
uai_®t_no
 = 
v®ue
;

164 
	`’su»_•s_şo£d
(
s
);

165 
»t
 = 
	`ioùl
(
s
->
devfd
, 
USB_SET_ALTINTERFACE
, &
aiçû
);

166 ià(
»t
 < 0) {

167 #ifdeà
DEBUG


168 
	`´štf
("handle_control: failedo set‡lternate interface - %s\n",

169 
	`¡»¼Ü
(
”ºo
));

171  
USB_RET_STALL
;

176 
»q
.
uü_»que¡
.
bmReque¡Ty³
 = 
»que¡
 >> 8;

177 
»q
.
uü_»que¡
.
bReque¡
 = 
»que¡
 & 0xff;

178 
	`USETW
(
»q
.
uü_»que¡
.
wV®ue
, 
v®ue
);

179 
	`USETW
(
»q
.
uü_»que¡
.
wIndex
, 
šdex
);

180 
	`USETW
(
»q
.
uü_»que¡
.
wL’gth
, 
Ëngth
);

181 
»q
.
uü_d©a
 = 
d©a
;

182 
»q
.
uü_æags
 = 
USBD_SHORT_XFER_OK
;

184 
»t
 = 
	`ioùl
(
s
->
devfd
, 
USB_SET_TIMEOUT
, &
timeout
);

185 #ià
	`defšed
(
__N‘BSD__
è|| defšed(
__O³nBSD__
)

186 ià(
»t
 < 0 && 
”ºo
 !ğ
EINVAL
) {

188 ià(
»t
 < 0) {

190 #ifdeà
DEBUG


191 
	`´štf
("handle_control: settingimeout failed - %s\n",

192 
	`¡»¼Ü
(
”ºo
));

196 
»t
 = 
	`ioùl
(
s
->
devfd
, 
USB_DO_REQUEST
, &
»q
);

199 ià(
»t
 < 0) {

200 #ifdeà
DEBUG


201 
	`´štf
("handle_control:ƒrror‡fter„equest - %s\n",

202 
	`¡»¼Ü
(
”ºo
));

204  
USB_RET_NAK
;

206  
»q
.
uü_aùËn
;

209 
	}
}

211 
	$usb_ho¡_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

213 
USBHo¡Deviû
 *
s
 = (USBHo¡Deviû *)
dev
;

214 
»t
, 
fd
, 
mode
;

215 
Úe
 = 1, 
shÜack‘
 = 0, 
timeout
 = 50;

216 
sig£t_t
 
Ãw_mask
, 
Şd_mask
;

217 
ušt8_t
 
dev•
 = 
p
->
•
->
Ä
;

220 
	`sigem±y£t
(&
Ãw_mask
);

221 
	`sigadd£t
(&
Ãw_mask
, 
SIGALRM
);

222 
	`sig´ocmask
(
SIG_BLOCK
, &
Ãw_mask
, &
Şd_mask
);

224 ià(
p
->
pid
 =ğ
USB_TOKEN_IN
) {

225 
dev•
 |= 0x80;

226 
mode
 = 
O_RDONLY
;

227 
shÜack‘
 = 1;

229 
mode
 = 
O_WRONLY
;

232 
fd
 = 
	`’su»_•_İ’
(
s
, 
dev•
, 
mode
);

233 ià(
fd
 < 0) {

234 
	`sig´ocmask
(
SIG_SETMASK
, &
Şd_mask
, 
NULL
);

235  
USB_RET_NODEV
;

238 ià(
	`ioùl
(
fd
, 
USB_SET_TIMEOUT
, &
timeout
) < 0) {

239 #ifdeà
DEBUG


240 
	`´štf
("handle_data: failedo setimeout - %s\n",

241 
	`¡»¼Ü
(
”ºo
));

245 ià(
shÜack‘
) {

246 ià(
	`ioùl
(
fd
, 
USB_SET_SHORT_XFER
, &
Úe
) < 0) {

247 #ifdeà
DEBUG


248 
	`´štf
("handle_data: failedo set short xfer mode - %s\n",

249 
	`¡»¼Ü
(
”ºo
));

251 
	`sig´ocmask
(
SIG_SETMASK
, &
Şd_mask
, 
NULL
);

255 ià(
p
->
pid
 =ğ
USB_TOKEN_IN
)

256 
»t
 = 
	`»adv
(
fd
, 
p
->
iov
.iov,…->iov.
niov
);

258 
»t
 = 
	`wr™ev
(
fd
, 
p
->
iov
.iov,…->iov.
niov
);

260 
	`sig´ocmask
(
SIG_SETMASK
, &
Şd_mask
, 
NULL
);

262 ià(
»t
 < 0) {

263 #ifdeà
DEBUG


264 
	`´štf
("handle_data:ƒrror‡fter %s data - %s\n",

265 
pid
 =ğ
USB_TOKEN_IN
 ? "»adšg" : "wr™šg", 
	`¡»¼Ü
(
”ºo
));

267 
”ºo
) {

268 
ETIMEDOUT
:

269 
EINTR
:

270  
USB_RET_NAK
;

272  
USB_RET_STALL
;

275  
»t
;

277 
	}
}

279 
	$usb_ho¡_hªdË_de¡roy
(
USBDeviû
 *
İaque
)

281 
USBHo¡Deviû
 *
s
 = (USBHo¡Deviû *)
İaque
;

282 
i
;

284 
i
 = 0; i < 
USB_MAX_ENDPOINTS
; i++)

285 ià(
s
->
•_fd
[
i
] >= 0)

286 
	`şo£
(
s
->
•_fd
[
i
]);

288 ià(
s
->
devfd
 < 0)

291 
	`şo£
(
s
->
devfd
);

293 
	`g_ä“
(
s
);

294 
	}
}

296 
	$usb_ho¡_š™â
(
USBDeviû
 *
dev
)

299 
	}
}

301 
USBDeviû
 *
	$usb_ho¡_deviû_İ’
(
USBBus
 *
gue¡_bus
, cÚ¡ *
devÇme
)

303 
usb_deviû_šfo
 
bus_šfo
, 
dev_šfo
;

304 
USBDeviû
 *
d
 = 
NULL
, *
»t
 = NULL;

305 
USBHo¡Deviû
 *
dev
;

306 
ùÍ©h
[
PATH_MAX
 + 1];

307 
bu¥©h
[
PATH_MAX
 + 1];

308 
bfd
, 
dfd
, 
bus
, 
add»ss
, 
i
;

309 
ug’debug
 = 
UGEN_DEBUG_LEVEL
;

311 ià(
	`usb_ho¡_fšd_deviû
(&
bus
, &
add»ss
, 
devÇme
) < 0) {

312 
ç
;

315 
	`¢´štf
(
bu¥©h
, 
PATH_MAX
, "/dev/usb%d", 
bus
);

317 
bfd
 = 
	`İ’
(
bu¥©h
, 
O_RDWR
);

318 ià(
bfd
 < 0) {

319 #ifdeà
DEBUG


320 
	`´štf
("usb_host_device_open: failedo open usb bus - %s\n",

321 
	`¡»¼Ü
(
”ºo
));

323 
ç
;

326 
bus_šfo
.
udi_addr
 = 
add»ss
;

327 ià(
	`ioùl
(
bfd
, 
USB_DEVICEINFO
, &
bus_šfo
) < 0) {

328 #ifdeà
DEBUG


329 
	`´štf
("usb_host_device_open: failedo grab bus information - %s\n",

330 
	`¡»¼Ü
(
”ºo
));

332 
ç_bfd
;

335 #ià
	`defšed
(
__F»eBSD__
è|| defšed(
__F»eBSD_k”Ãl__
è|| defšed(
__D¿gÚFly__
)

336 
	`¢´štf
(
ùÍ©h
, 
PATH_MAX
, "/dev/%s", 
bus_šfo
.
udi_devÇmes
[0]);

338 
	`¢´štf
(
ùÍ©h
, 
PATH_MAX
, "/dev/%s.00", 
bus_šfo
.
udi_devÇmes
[0]);

341 
dfd
 = 
	`İ’
(
ùÍ©h
, 
O_RDWR
);

342 ià(
dfd
 < 0) {

343 
dfd
 = 
	`İ’
(
ùÍ©h
, 
O_RDONLY
);

344 ià(
dfd
 < 0) {

345 #ifdeà
DEBUG


346 
	`´štf
("usb_host_device_open: failedo open usb device %s - %s\n",

347 
ùÍ©h
, 
	`¡»¼Ü
(
”ºo
));

350 
ç_dfd
;

353 ià(
	`ioùl
(
dfd
, 
USB_GET_DEVICEINFO
, &
dev_šfo
) < 0) {

354 #ifdeà
DEBUG


355 
	`´štf
("usb_host_device_open: failedo grab device info - %s\n",

356 
	`¡»¼Ü
(
”ºo
));

358 
ç_dfd
;

361 
d
 = 
	`usb_ü—‹
(
gue¡_bus
, "usb-host");

362 
dev
 = 
	`DO_UPCAST
(
USBHo¡Deviû
, dev, 
d
);

364 ià(
dev_šfo
.
udi_¥“d
 == 1) {

365 
dev
->dev.
¥“d
 = 
USB_SPEED_LOW
 - 1;

366 
dev
->dev.
¥“dmask
 = 
USB_SPEED_MASK_LOW
;

368 
dev
->dev.
¥“d
 = 
USB_SPEED_FULL
 - 1;

369 
dev
->dev.
¥“dmask
 = 
USB_SPEED_MASK_FULL
;

372 ià(
	`¡ºcmp
(
dev_šfo
.
udi_´oduù
, "product", 7) != 0) {

373 
	`p¡rıy
(
dev
->dev.
´oduù_desc
, (dev->dev.product_desc),

374 
dev_šfo
.
udi_´oduù
);

376 
	`¢´štf
(
dev
->dev.
´oduù_desc
, (dev->dev.product_desc),

377 "ho¡:%s", 
devÇme
);

380 
	`p¡rıy
(
dev
->
dev·th
, (dev->devpath), "/dev/");

381 
	`p¡rÿt
(
dev
->
dev·th
, (dev->dev·th), 
dev_šfo
.
udi_devÇmes
[0]);

384 
i
 = 0; i < 
USB_MAX_ENDPOINTS
; i++) {

385 
dev
->
•_fd
[
i
] = -1;

388 
	`ioùl
(
dfd
, 
USB_SETDEBUG
, &
ug’debug
);

390 
»t
 = (
USBDeviû
 *)
dev
;

392 
ç_dfd
:

393 
	`şo£
(
dfd
);

394 
ç_bfd
:

395 
	`şo£
(
bfd
);

396 
ç
:

397  
»t
;

398 
	}
}

400 
	$usb_ho¡_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

402 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

404 
uc
->
´oduù_desc
 = "USB Host Device";

405 
uc
->
š™
 = 
usb_ho¡_š™â
;

406 
uc
->
hªdË_»£t
 = 
usb_ho¡_hªdË_»£t
;

407 
uc
->
hªdË_cÚŒŞ
 = 
usb_ho¡_hªdË_cÚŒŞ
;

408 
uc
->
hªdË_d©a
 = 
usb_ho¡_hªdË_d©a
;

409 
uc
->
hªdË_de¡roy
 = 
usb_ho¡_hªdË_de¡roy
;

410 
	}
}

412 
Ty³Info
 
	gusb_ho¡_dev_šfo
 = {

413 .
Çme
 = "usb-host",

414 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

415 .
	gš¡ªû_size
 = (
USBHo¡Deviû
),

416 .
	gşass_š™
 = 
usb_ho¡_şass_š™â
,

419 
	$usb_ho¡_»gi¡”_ty³s
()

421 
	`ty³_»gi¡”_¡©ic
(&
usb_ho¡_dev_šfo
);

422 
	}
}

424 
	$ty³_š™
(
usb_ho¡_»gi¡”_ty³s
)

426 
	$usb_ho¡_sÿn
(*
İaque
, 
USBSÿnFunc
 *
func
)

428 
usb_deviû_šfo
 
bus_šfo
;

429 
usb_deviû_šfo
 
dev_šfo
;

430 
ušt16_t
 
v’dÜ_id
, 
´oduù_id
, 
şass_id
, 
¥“d
;

431 
bfd
, 
dfd
, 
bus
, 
add»ss
;

432 
busbuf
[20], 
devbuf
[20], 
´oduù_Çme
[256];

433 
»t
 = 0;

435 
bus
 = 0; bus < 10; bus++) {

437 
	`¢´štf
(
busbuf
, (busbufè- 1, "/dev/usb%d", 
bus
);

438 
bfd
 = 
	`İ’
(
busbuf
, 
O_RDWR
);

439 ià(
bfd
 < 0)

442 
add»ss
 = 1;‡ddress < 127;‡ddress++) {

444 
bus_šfo
.
udi_addr
 = 
add»ss
;

445 ià(
	`ioùl
(
bfd
, 
USB_DEVICEINFO
, &
bus_šfo
) < 0)

449 ià(
	`¡ºcmp
(
bus_šfo
.
udi_devÇmes
[0], "ugen", 4) != 0)

452 #ià
	`defšed
(
__F»eBSD__
è|| defšed(
__F»eBSD_k”Ãl__
è|| defšed(
__D¿gÚFly__
)

453 
	`¢´štf
(
devbuf
, (devbufè- 1, "/dev/%s", 
bus_šfo
.
udi_devÇmes
[0]);

455 
	`¢´štf
(
devbuf
, (devbufè- 1, "/dev/%s.00", 
bus_šfo
.
udi_devÇmes
[0]);

458 
dfd
 = 
	`İ’
(
devbuf
, 
O_RDONLY
);

459 ià(
dfd
 < 0) {

460 #ifdeà
DEBUG


461 
	`´štf
("usb_ho¡_sÿn: couldn'ˆİ’ deviû % - %s\n", 
devbuf
,

462 
	`¡»¼Ü
(
”ºo
));

467 ià(
	`ioùl
(
dfd
, 
USB_GET_DEVICEINFO
, &
dev_šfo
) < 0)

468 
	`´štf
("usb_host_scan: couldn't get device information for %s - %s\n",

469 
devbuf
, 
	`¡»¼Ü
(
”ºo
));

473 
v’dÜ_id
 = 
dev_šfo
.
udi_v’dÜNo
;

474 
´oduù_id
 = 
dev_šfo
.
udi_´oduùNo
;

475 
şass_id
 = 
dev_šfo
.
udi_şass
;

476 
¥“d
 = 
dev_šfo
.
udi_¥“d
;

478 ià(
	`¡ºcmp
(
dev_šfo
.
udi_´oduù
, "product", 7) != 0)

479 
	`p¡rıy
(
´oduù_Çme
, (product_name),

480 
dev_šfo
.
udi_´oduù
);

482 
´oduù_Çme
[0] = '\0';

484 
»t
 = 
	`func
(
İaque
, 
bus
, 
add»ss
, 
şass_id
, 
v’dÜ_id
,

485 
´oduù_id
, 
´oduù_Çme
, 
¥“d
);

487 
	`şo£
(
dfd
);

489 ià(
»t
)

490 
the_’d
;

493 
	`şo£
(
bfd
);

496 
the_’d
:

497  
»t
;

498 
	}
}

500 
	sFšdDeviûS‹
 {

501 
	mv’dÜ_id
;

502 
	m´oduù_id
;

503 
	mbus_num
;

504 
	maddr
;

505 } 
	tFšdDeviûS‹
;

507 
	$usb_ho¡_fšd_deviû_sÿn
(*
İaque
, 
bus_num
, 
addr
,

508 
şass_id
,

509 
v’dÜ_id
, 
´oduù_id
,

510 cÚ¡ *
´oduù_Çme
, 
¥“d
)

512 
FšdDeviûS‹
 *
s
 = 
İaque
;

513 ià(
v’dÜ_id
 =ğ
s
->vendor_id &&

514 
´oduù_id
 =ğ
s
->product_id) {

515 
s
->
bus_num
 = bus_num;

516 
s
->
addr
 =‡ddr;

521 
	}
}

527 
	$usb_ho¡_fšd_deviû
(*
pbus_num
, *
·ddr
,

528 cÚ¡ *
devÇme
)

530 cÚ¡ *
p
;

531 
»t
;

532 
FšdDeviûS‹
 
fs
;

534 
p
 = 
	`¡rchr
(
devÇme
, '.');

535 ià(
p
) {

536 *
pbus_num
 = 
	`¡¹oul
(
devÇme
, 
NULL
, 0);

537 *
·ddr
 = 
	`¡¹oul
(
p
 + 1, 
NULL
, 0);

540 
p
 = 
	`¡rchr
(
devÇme
, ':');

541 ià(
p
) {

542 
fs
.
v’dÜ_id
 = 
	`¡¹oul
(
devÇme
, 
NULL
, 16);

543 
fs
.
´oduù_id
 = 
	`¡¹oul
(
p
 + 1, 
NULL
, 16);

544 
»t
 = 
	`usb_ho¡_sÿn
(&
fs
, 
usb_ho¡_fšd_deviû_sÿn
);

545 ià(
»t
) {

546 *
pbus_num
 = 
fs
.
bus_num
;

547 *
·ddr
 = 
fs
.
addr
;

552 
	}
}

557 
	susb_şass_šfo
 {

558 
	mşass
;

559 cÚ¡ *
	mşass_Çme
;

562 cÚ¡ 
usb_şass_šfo
 
	gusb_şass_šfo
[] = {

563 { 
USB_CLASS_AUDIO
, "Audio"},

564 { 
USB_CLASS_COMM
, "Communication"},

565 { 
USB_CLASS_HID
, "HID"},

566 { 
USB_CLASS_HUB
, "Hub" },

567 { 
USB_CLASS_PHYSICAL
, "Physical" },

568 { 
USB_CLASS_PRINTER
, "Printer" },

569 { 
USB_CLASS_MASS_STORAGE
, "Storage" },

570 { 
USB_CLASS_CDC_DATA
, "Data" },

571 { 
USB_CLASS_APP_SPEC
, "Application Specific" },

572 { 
USB_CLASS_VENDOR_SPEC
, "Vendor Specific" },

573 { 
USB_CLASS_STILL_IMAGE
, "Still Image" },

574 { 
USB_CLASS_CSCID
, "Smart Card" },

575 { 
USB_CLASS_CONTENT_SEC
, "Content Security" },

576 { -1, 
NULL
 }

579 cÚ¡ *
	$usb_şass_¡r
(
ušt8_t
 
şass
)

581 cÚ¡ 
usb_şass_šfo
 *
p
;

582 
p
 = 
usb_şass_šfo
;…->
şass
 != -1;…++) {

583 ià(
p
->
şass
 == class)

586  
p
->
şass_Çme
;

587 
	}
}

589 
	$usb_šfo_deviû
(
MÚ™Ü
 *
mÚ
, 
bus_num
, 
addr
, 
şass_id
,

590 
v’dÜ_id
, 
´oduù_id
,

591 cÚ¡ *
´oduù_Çme
,

592 
¥“d
)

594 cÚ¡ *
şass_¡r
, *
¥“d_¡r
;

596 
¥“d
) {

597 
USB_SPEED_LOW
:

598 
¥“d_¡r
 = "1.5";

600 
USB_SPEED_FULL
:

601 
¥“d_¡r
 = "12";

603 
USB_SPEED_HIGH
:

604 
¥“d_¡r
 = "480";

607 
¥“d_¡r
 = "?";

611 
	`mÚ™Ü_´štf
(
mÚ
, " Device %d.%d, speed %s Mb/s\n",

612 
bus_num
, 
addr
, 
¥“d_¡r
);

613 
şass_¡r
 = 
	`usb_şass_¡r
(
şass_id
);

614 ià(
şass_¡r
)

615 
	`mÚ™Ü_´štf
(
mÚ
, " %s:", 
şass_¡r
);

617 
	`mÚ™Ü_´štf
(
mÚ
, " CÏs %02x:", 
şass_id
);

618 
	`mÚ™Ü_´štf
(
mÚ
, " USB deviû %04x:%04x", 
v’dÜ_id
, 
´oduù_id
);

619 ià(
´oduù_Çme
[0] != '\0')

620 
	`mÚ™Ü_´štf
(
mÚ
, ", %s", 
´oduù_Çme
);

621 
	`mÚ™Ü_´štf
(
mÚ
, "\n");

622 
	}
}

624 
	$usb_ho¡_šfo_deviû
(*
İaque
,

625 
bus_num
, 
addr
,

626 
şass_id
,

627 
v’dÜ_id
, 
´oduù_id
,

628 cÚ¡ *
´oduù_Çme
,

629 
¥“d
)

631 
MÚ™Ü
 *
mÚ
 = 
İaque
;

633 
	`usb_šfo_deviû
(
mÚ
, 
bus_num
, 
addr
, 
şass_id
, 
v’dÜ_id
, 
´oduù_id
,

634 
´oduù_Çme
, 
¥“d
);

636 
	}
}

638 
	$usb_ho¡_šfo
(
MÚ™Ü
 *
mÚ
)

640 
	`usb_ho¡_sÿn
(
mÚ
, 
usb_ho¡_šfo_deviû
);

641 
	}
}

644 
	$usb_ho¡_deviû_şo£
(cÚ¡ *
devÇme
)

647 
	}
}

	@host-linux.c

33 
	~"qemu-commÚ.h
"

34 
	~"qemu-tim”.h
"

35 
	~"mÚ™Ü.h
"

36 
	~"sy£mu.h
"

37 
	~"Œaû.h
"

39 
	~<dœ’t.h
>

40 
	~<sys/ioùl.h
>

42 
	~<lšux/usbdeviû_fs.h
>

43 
	~<lšux/v”siÚ.h
>

44 
	~"hw/usb.h
"

45 
	~"hw/usb/desc.h
"

48 
	susb_ù¾Œªsãr
 {

49 
ušt8_t
 
	mbReque¡Ty³
;

50 
ušt8_t
 
	mbReque¡
;

51 
ušt16_t
 
	mwV®ue
;

52 
ušt16_t
 
	mwIndex
;

53 
ušt16_t
 
	mwL’gth
;

54 
ušt32_t
 
	mtimeout
;

55 *
	md©a
;

58 
	tUSBSÿnFunc
(*
	tİaque
, 
	tbus_num
, 
	taddr
, cÚ¡ *
	tpÜt
,

59 
	tşass_id
, 
	tv’dÜ_id
, 
	t´oduù_id
,

60 cÚ¡ *
	t´oduù_Çme
, 
	t¥“d
);

64 #ifdeà
DEBUG


65 
	#DPRINTF
 
´štf


	)

67 
	#DPRINTF
(...)

	)

70 
	#PRODUCT_NAME_SZ
 32

	)

71 
	#MAX_PORTLEN
 16

	)

74 
	#ISO_FRAME_DESC_PER_URB
 32

	)

77 
	#MAX_USBFS_BUFFER_SIZE
 16384

	)

79 
AsyncURB
 
	tAsyncURB
;

81 
	s’dp_d©a
 {

82 
ušt8_t
 
	mh®‹d
;

83 
ušt8_t
 
	miso_¡¬‹d
;

84 
AsyncURB
 *
	miso_urb
;

85 
	miso_urb_idx
;

86 
	miso_bufãr_u£d
;

87 
	mšæight
;

90 
	sUSBAutoF‹r
 {

91 
ušt32_t
 
	mbus_num
;

92 
ušt32_t
 
	maddr
;

93 *
	mpÜt
;

94 
ušt32_t
 
	mv’dÜ_id
;

95 
ušt32_t
 
	m´oduù_id
;

98 
	eUSBHo¡DeviûO±iÚs
 {

99 
	mUSB_HOST_OPT_PIPELINE
,

102 
	sUSBHo¡Deviû
 {

103 
USBDeviû
 
	mdev
;

104 
	mfd
;

105 
	mhub_fd
;

106 
	mhub_pÜt
;

108 
ušt8_t
 
	mdesü
[8192];

109 
	mdesü_Ën
;

110 
	mşosšg
;

111 
ušt32_t
 
	miso_urb_couÁ
;

112 
ušt32_t
 
	mİtiÚs
;

113 
NÙif›r
 
	mex™
;

114 
QEMUBH
 *
	mbh
;

116 
’dp_d©a
 
	m•_š
[
USB_MAX_ENDPOINTS
];

117 
’dp_d©a
 
	m•_out
[
USB_MAX_ENDPOINTS
];

118 
QLIST_HEAD
(, 
AsyncURB
è
	maurbs
;

121 
	mbus_num
;

122 
	maddr
;

123 
	mpÜt
[
MAX_PORTLEN
];

124 
USBAutoF‹r
 
	mm©ch
;

125 
št32_t
 
	mboÙšdex
;

126 
	m£’
, 
	m”rcouÁ
;

128 
QTAILQ_ENTRY
(
USBHo¡Deviû
è
	mÃxt
;

129 } 
	tUSBHo¡Deviû
;

131 
	$QTAILQ_HEAD
(, 
USBHo¡Deviû
è
ho¡devs
 = 
	`QTAILQ_HEAD_INITIALIZER
(hostdevs);

133 
	`usb_ho¡_şo£
(
USBHo¡Deviû
 *
dev
);

134 
	`·r£_f‹r
(cÚ¡ *
¥ec
, 
USBAutoF‹r
 *
f
);

135 
	`usb_ho¡_auto_check
(*
unu£d
);

136 
	`usb_ho¡_»ad_fe
(*
lše
, 
size_t
 
lše_size
,

137 cÚ¡ *
deviû_fe
, cÚ¡ *
deviû_Çme
);

138 
	`usb_lšux_upd©e_’dp_bË
(
USBHo¡Deviû
 *
s
);

140 
	$usb_ho¡_usbfs_ty³
(
USBHo¡Deviû
 *
s
, 
USBPack‘
 *
p
)

142 cÚ¡ 
usbfs
[] = {

143 [
USB_ENDPOINT_XFER_CONTROL
] = 
USBDEVFS_URB_TYPE_CONTROL
,

144 [
USB_ENDPOINT_XFER_ISOC
] = 
USBDEVFS_URB_TYPE_ISO
,

145 [
USB_ENDPOINT_XFER_BULK
] = 
USBDEVFS_URB_TYPE_BULK
,

146 [
USB_ENDPOINT_XFER_INT
] = 
USBDEVFS_URB_TYPE_INTERRUPT
,

148 
ušt8_t
 
ty³
 = 
p
->
•
->type;

149 
	`as£¹
(
ty³
 < 
	`ARRAY_SIZE
(
usbfs
));

150  
usbfs
[
ty³
];

151 
	}
}

153 
	$usb_ho¡_do_»£t
(
USBHo¡Deviû
 *
dev
)

155 
timev®
 
s
, 
e
;

156 
ušt32_t
 
u£cs
;

157 
»t
;

159 
	`g‘timeofday
(&
s
, 
NULL
);

160 
»t
 = 
	`ioùl
(
dev
->
fd
, 
USBDEVFS_RESET
);

161 
	`g‘timeofday
(&
e
, 
NULL
);

162 
u£cs
 = (
e
.
tv_£c
 - 
s
.tv_sec) * 1000000;

163 
u£cs
 +ğ
e
.
tv_u£c
 - 
s
.tv_usec;

164 ià(
u£cs
 > 1000000) {

166 
	`årštf
(
¡d”r
, "husb: device %d:%d„esetook %d.%06d seconds\n",

167 
dev
->
bus_num
, dev->
addr
, 
u£cs
 / 1000000, usecs % 1000000);

169  
»t
;

170 
	}
}

172 
’dp_d©a
 *
	$g‘_’dp
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

174 
’dp_d©a
 *
•s
 = 
pid
 =ğ
USB_TOKEN_IN
 ? 
s
->
•_š
 : s->
•_out
;

175 
	`as£¹
(
pid
 =ğ
USB_TOKEN_IN
 ||…id =ğ
USB_TOKEN_OUT
);

176 
	`as£¹
(
•
 > 0 &&ƒ°<ğ
USB_MAX_ENDPOINTS
);

177  
•s
 + 
•
 - 1;

178 
	}
}

180 
	$is_isoc
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

182  
	`usb_•_g‘_ty³
(&
s
->
dev
, 
pid
, 
•
è=ğ
USB_ENDPOINT_XFER_ISOC
;

183 
	}
}

185 
	$is_v®id
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

187  
	`usb_•_g‘_ty³
(&
s
->
dev
, 
pid
, 
•
è!ğ
USB_ENDPOINT_XFER_INVALID
;

188 
	}
}

190 
	$is_h®‹d
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

192  
	`g‘_’dp
(
s
, 
pid
, 
•
)->
h®‹d
;

193 
	}
}

195 
	$ş—r_h®t
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

197 
	`Œaû_usb_ho¡_•_ş—r_h®t
(
s
->
bus_num
, s->
addr
, 
•
);

198 
	`g‘_’dp
(
s
, 
pid
, 
•
)->
h®‹d
 = 0;

199 
	}
}

201 
	$£t_h®t
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

203 ià(
•
 != 0) {

204 
	`Œaû_usb_ho¡_•_£t_h®t
(
s
->
bus_num
, s->
addr
, 
•
);

205 
	`g‘_’dp
(
s
, 
pid
, 
•
)->
h®‹d
 = 1;

207 
	}
}

209 
	$is_iso_¡¬‹d
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

211  
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_¡¬‹d
;

212 
	}
}

214 
	$ş—r_iso_¡¬‹d
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

216 
	`Œaû_usb_ho¡_iso_¡İ
(
s
->
bus_num
, s->
addr
, 
•
);

217 
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_¡¬‹d
 = 0;

218 
	}
}

220 
	$£t_iso_¡¬‹d
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

222 
’dp_d©a
 *
e
 = 
	`g‘_’dp
(
s
, 
pid
, 
•
);

224 
	`Œaû_usb_ho¡_iso_¡¬t
(
s
->
bus_num
, s->
addr
, 
•
);

225 ià(!
e
->
iso_¡¬‹d
) {

226 
e
->
iso_¡¬‹d
 = 1;

227 
e
->
šæight
 = 0;

229 
	}
}

231 
	$chªge_iso_šæight
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
, 
v®ue
)

233 
’dp_d©a
 *
e
 = 
	`g‘_’dp
(
s
, 
pid
, 
•
);

235 
e
->
šæight
 +ğ
v®ue
;

236  
e
->
šæight
;

237 
	}
}

239 
	$£t_iso_urb
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
, 
AsyncURB
 *
iso_urb
)

241 
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_urb
 = iso_urb;

242 
	}
}

244 
AsyncURB
 *
	$g‘_iso_urb
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

246  
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_urb
;

247 
	}
}

249 
	$£t_iso_urb_idx
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
, 
i
)

251 
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_urb_idx
 = 
i
;

252 
	}
}

254 
	$g‘_iso_urb_idx
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

256  
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_urb_idx
;

257 
	}
}

259 
	$£t_iso_bufãr_u£d
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
, 
i
)

261 
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_bufãr_u£d
 = 
i
;

262 
	}
}

264 
	$g‘_iso_bufãr_u£d
(
USBHo¡Deviû
 *
s
, 
pid
, 
•
)

266  
	`g‘_’dp
(
s
, 
pid
, 
•
)->
iso_bufãr_u£d
;

267 
	}
}

274 
	sAsyncURB


276 
usbdevfs_urb
 
	murb
;

277 
usbdevfs_iso_·ck‘_desc
 
	misoıd
[
ISO_FRAME_DESC_PER_URB
];

278 
USBHo¡Deviû
 *
	mhdev
;

279 
QLIST_ENTRY
(
AsyncURB
è
	mÃxt
;

282 
USBPack‘
 *
	m·ck‘
;

283 
	mmÜe
;

286 
	miso_äame_idx
;

289 
AsyncURB
 *
	$async_®loc
(
USBHo¡Deviû
 *
s
)

291 
AsyncURB
 *
aurb
 = 
	`g_m®loc0
((AsyncURB));

292 
aurb
->
hdev
 = 
s
;

293 
	`QLIST_INSERT_HEAD
(&
s
->
aurbs
, 
aurb
, 
Ãxt
);

294  
aurb
;

295 
	}
}

297 
	$async_ä“
(
AsyncURB
 *
aurb
)

299 
	`QLIST_REMOVE
(
aurb
, 
Ãxt
);

300 
	`g_ä“
(
aurb
);

301 
	}
}

303 
	$do_discÚÃù
(
USBHo¡Deviû
 *
s
)

305 
	`usb_ho¡_şo£
(
s
);

306 
	`usb_ho¡_auto_check
(
NULL
);

307 
	}
}

309 
	$async_com¶‘e
(*
İaque
)

311 
USBHo¡Deviû
 *
s
 = 
İaque
;

312 
AsyncURB
 *
aurb
;

313 
urbs
 = 0;

316 
USBPack‘
 *
p
;

318 
r
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_REAPURBNDELAY
, &
aurb
);

319 ià(
r
 < 0) {

320 ià(
”ºo
 =ğ
EAGAIN
) {

321 ià(
urbs
 > 2) {

323 
	`Œaû_usb_ho¡_iso_mªy_urbs
(
s
->
bus_num
, s->
addr
, 
urbs
);

327 ià(
”ºo
 =ğ
ENODEV
) {

328 ià(!
s
->
şosšg
) {

329 
	`Œaû_usb_ho¡_discÚÃù
(
s
->
bus_num
, s->
addr
);

330 
	`do_discÚÃù
(
s
);

335 
	`³¼Ü
("USBDEVFS_REAPURBNDELAY");

339 
	`DPRINTF
("husb:‡sync completed.‡urb %p status %d‡len %d\n",

340 
aurb
,‡urb->
urb
.
¡©us
,‡urb->urb.
aùu®_Ëngth
);

344 ià(
aurb
->
iso_äame_idx
 == -1) {

345 
šæight
;

346 
pid
 = (
aurb
->
urb
.
’dpošt
 & 
USB_DIR_IN
) ?

347 
USB_TOKEN_IN
 : 
USB_TOKEN_OUT
;

348 
•
 = 
aurb
->
urb
.
’dpošt
 & 0xf;

349 ià(
aurb
->
urb
.
¡©us
 =ğ-
EPIPE
) {

350 
	`£t_h®t
(
s
, 
pid
, 
•
);

352 
aurb
->
iso_äame_idx
 = 0;

353 
urbs
++;

354 
šæight
 = 
	`chªge_iso_šæight
(
s
, 
pid
, 
•
, -1);

355 ià(
šæight
 =ğ0 && 
	`is_iso_¡¬‹d
(
s
, 
pid
, 
•
)) {

357 
	`Œaû_usb_ho¡_iso_out_of_bufs
(
s
->
bus_num
, s->
addr
, 
•
);

362 
p
 = 
aurb
->
·ck‘
;

363 
	`Œaû_usb_ho¡_urb_com¶‘e
(
s
->
bus_num
, s->
addr
, 
aurb
,‡urb->
urb
.
¡©us
,

364 
aurb
->
urb
.
aùu®_Ëngth
,‡urb->
mÜe
);

366 ià(
p
) {

367 
aurb
->
urb
.
¡©us
) {

369 
p
->
»suÉ
 +ğ
aurb
->
urb
.
aùu®_Ëngth
;

372 -
EPIPE
:

373 
	`£t_h®t
(
s
, 
p
->
pid
,…->
•
->
Ä
);

374 
p
->
»suÉ
 = 
USB_RET_STALL
;

377 -
EOVERFLOW
:

378 
p
->
»suÉ
 = 
USB_RET_BABBLE
;

382 
p
->
»suÉ
 = 
USB_RET_IOERROR
;

386 ià(
aurb
->
urb
.
ty³
 =ğ
USBDEVFS_URB_TYPE_CONTROL
) {

387 
	`Œaû_usb_ho¡_»q_com¶‘e
(
s
->
bus_num
, s->
addr
, 
p
,…->
»suÉ
);

388 
	`usb_g’”ic_async_ù¾_com¶‘e
(&
s
->
dev
, 
p
);

389 } ià(!
aurb
->
mÜe
) {

390 
	`Œaû_usb_ho¡_»q_com¶‘e
(
s
->
bus_num
, s->
addr
, 
p
,…->
»suÉ
);

391 
	`usb_·ck‘_com¶‘e
(&
s
->
dev
, 
p
);

395 
	`async_ä“
(
aurb
);

397 
	}
}

399 
	$usb_ho¡_async_ÿnûl
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

401 
USBHo¡Deviû
 *
s
 = 
	`DO_UPCAST
(USBHo¡Deviû, 
dev
, dev);

402 
AsyncURB
 *
aurb
;

404 
	`Œaû_usb_ho¡_»q_ÿnûËd
(
s
->
bus_num
, s->
addr
, 
p
);

406 
	`QLIST_FOREACH
(
aurb
, &
s
->
aurbs
, 
Ãxt
) {

407 ià(
p
 !ğ
aurb
->
·ck‘
) {

411 
	`Œaû_usb_ho¡_urb_ÿnûËd
(
s
->
bus_num
, s->
addr
, 
aurb
);

414 
aurb
->
·ck‘
 = 
NULL
;

416 
r
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_DISCARDURB
, 
aurb
);

417 ià(
r
 < 0) {

418 
	`DPRINTF
("husb:‡sync. disÿrd urb faedƒ¼nØ%d\n", 
”ºo
);

421 
	}
}

423 
	$usb_ho¡_İ’_deviû
(
bus
, 
addr
)

425 cÚ¡ *
usbfs
 = 
NULL
;

426 
f’ame
[32];

427 
¡©
 
¡
;

428 
fd
, 
rc
;

430 
rc
 = 
	`¡©
("/dev/bus/usb", &
¡
);

431 ià(
rc
 =ğ0 && 
	`S_ISDIR
(
¡
.
¡_mode
)) {

433 
usbfs
 = "/dev/bus/usb";

436 
usbfs
 = "/proc/bus/usb";

439 
	`¢´štf
(
f’ame
, (filename), "%s/%03d/%03d",

440 
usbfs
, 
bus
, 
addr
);

441 
fd
 = 
	`İ’
(
f’ame
, 
O_RDWR
 | 
O_NONBLOCK
);

442 ià(
fd
 < 0) {

443 
	`årštf
(
¡d”r
, "husb: o³À%s: %s\n", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

445  
fd
;

446 
	}
}

448 
	$usb_ho¡_şaim_pÜt
(
USBHo¡Deviû
 *
s
)

450 #ifdeà
USBDEVFS_CLAIM_PORT


451 *
h
, 
hub_Çme
[64], 
lše
[1024];

452 
hub_addr
, 
»t
;

454 
	`¢´štf
(
hub_Çme
, (hub_name), "%d-%s",

455 
s
->
m©ch
.
bus_num
, s->m©ch.
pÜt
);

458 
h
 = 
	`¡¼chr
(
hub_Çme
, '.');

459 ià(
h
 !ğ
NULL
) {

460 
s
->
hub_pÜt
 = 
	`©oi
(
h
+1);

461 *
h
 = '\0';

464 
	`¢´štf
(
hub_Çme
, (hub_name), "usb%d",

465 
s
->
m©ch
.
bus_num
);

466 
s
->
hub_pÜt
 = 
	`©oi
(s->
m©ch
.
pÜt
);

469 ià(!
	`usb_ho¡_»ad_fe
(
lše
, (line), "devnum",

470 
hub_Çme
)) {

473 ià(
	`ssÿnf
(
lše
, "%d", &
hub_addr
) != 1) {

477 
s
->
hub_fd
 = 
	`usb_ho¡_İ’_deviû
(s->
m©ch
.
bus_num
, 
hub_addr
);

478 ià(
s
->
hub_fd
 < 0) {

482 
»t
 = 
	`ioùl
(
s
->
hub_fd
, 
USBDEVFS_CLAIM_PORT
, &s->
hub_pÜt
);

483 ià(
»t
 < 0) {

484 
	`şo£
(
s
->
hub_fd
);

485 
s
->
hub_fd
 = -1;

489 
	`Œaû_usb_ho¡_şaim_pÜt
(
s
->
m©ch
.
bus_num
, 
hub_addr
, s->
hub_pÜt
);

494 
	}
}

496 
	$usb_ho¡_»Ëa£_pÜt
(
USBHo¡Deviû
 *
s
)

498 ià(
s
->
hub_fd
 == -1) {

501 #ifdeà
USBDEVFS_RELEASE_PORT


502 
	`ioùl
(
s
->
hub_fd
, 
USBDEVFS_RELEASE_PORT
, &s->
hub_pÜt
);

504 
	`şo£
(
s
->
hub_fd
);

505 
s
->
hub_fd
 = -1;

506 
	}
}

508 
	$usb_ho¡_discÚÃù_içûs
(
USBHo¡Deviû
 *
dev
, 
nb_š‹rçûs
)

511 #ifdeà
USBDEVFS_DISCONNECT


512 
usbdevfs_ioùl
 
ù¾
;

513 
»t
, 
š‹rçû
;

515 
š‹rçû
 = 0; iÁ”çû < 
nb_š‹rçûs
; interface++) {

516 
ù¾
.
ioùl_code
 = 
USBDEVFS_DISCONNECT
;

517 
ù¾
.
iâo
 = 
š‹rçû
;

518 
ù¾
.
d©a
 = 0;

519 
»t
 = 
	`ioùl
(
dev
->
fd
, 
USBDEVFS_IOCTL
, &
ù¾
);

520 ià(
»t
 < 0 && 
”ºo
 !ğ
ENODATA
) {

521 
	`³¼Ü
("USBDEVFS_DISCONNECT");

527 
	}
}

529 
	$usb_lšux_g‘_num_š‹rçûs
(
USBHo¡Deviû
 *
s
)

531 
deviû_Çme
[64], 
lše
[1024];

532 
num_š‹rçûs
 = 0;

534 
	`¥rštf
(
deviû_Çme
, "%d-%s", 
s
->
bus_num
, s->
pÜt
);

535 ià(!
	`usb_ho¡_»ad_fe
(
lše
, (line), "bNumInterfaces",

536 
deviû_Çme
)) {

539 ià(
	`ssÿnf
(
lše
, "%d", &
num_š‹rçûs
) != 1) {

542  
num_š‹rçûs
;

543 
	}
}

545 
	$usb_ho¡_şaim_š‹rçûs
(
USBHo¡Deviû
 *
dev
, 
cÚfigu¿tiÚ
)

547 cÚ¡ *
İ
 = 
NULL
;

548 
dev_desü_Ën
, 
cÚfig_desü_Ën
;

549 
š‹rçû
, 
nb_š‹rçûs
;

550 
»t
, 
i
;

552 
i
 = 0; i < 
USB_MAX_INTERFACES
; i++) {

553 
dev
->dev.
®t£‰šg
[
i
] = 0;

556 ià(
cÚfigu¿tiÚ
 == 0) {

557 
dev
->dev.
nš‹rçûs
 = 0;

558 
dev
->dev.
cÚfigu¿tiÚ
 = 0;

562 
	`DPRINTF
("husb: cÏimšg iÁ”çûs. cÚfig %d\n", 
cÚfigu¿tiÚ
);

564 
i
 = 0;

565 
dev_desü_Ën
 = 
dev
->
desü
[0];

566 ià(
dev_desü_Ën
 > 
dev
->
desü_Ën
) {

567 
	`årštf
(
¡d”r
, "husb: update iface failed. descroo short\n");

571 
i
 +ğ
dev_desü_Ën
;

572 
i
 < 
dev
->
desü_Ën
) {

573 
	`DPRINTF
("husb: i is %d, descr_len is %d, dl %d, dt %d\n",

574 
i
, 
dev
->
desü_Ën
,

575 
dev
->
desü
[
i
], dev->descr[i+1]);

577 ià(
dev
->
desü
[
i
+1] !ğ
USB_DT_CONFIG
) {

578 
i
 +ğ
dev
->
desü
[i];

581 
cÚfig_desü_Ën
 = 
dev
->
desü
[
i
];

583 
	`DPRINTF
("husb: cÚfig #%d‚“d %d\n", 
dev
->
desü
[
i
 + 5], 
cÚfigu¿tiÚ
);

585 ià(
cÚfigu¿tiÚ
 =ğ
dev
->
desü
[
i
 + 5]) {

586 
cÚfigu¿tiÚ
 = 
dev
->
desü
[
i
 + 5];

590 
i
 +ğ
cÚfig_desü_Ën
;

593 ià(
i
 >ğ
dev
->
desü_Ën
) {

594 
	`årštf
(
¡d”r
,

598 
nb_š‹rçûs
 = 
dev
->
desü
[
i
 + 4];

600 ià(
	`usb_ho¡_discÚÃù_içûs
(
dev
, 
nb_š‹rçûs
) < 0) {

601 
ç
;

605 
š‹rçû
 = 0; iÁ”çû < 
nb_š‹rçûs
; interface++) {

606 
İ
 = "USBDEVFS_CLAIMINTERFACE";

607 
»t
 = 
	`ioùl
(
dev
->
fd
, 
USBDEVFS_CLAIMINTERFACE
, &
š‹rçû
);

608 ià(
»t
 < 0) {

609 
ç
;

613 
	`Œaû_usb_ho¡_şaim_š‹rçûs
(
dev
->
bus_num
, dev->
addr
,

614 
nb_š‹rçûs
, 
cÚfigu¿tiÚ
);

616 
dev
->dev.
nš‹rçûs
 = 
nb_š‹rçûs
;

617 
dev
->dev.
cÚfigu¿tiÚ
 = configuration;

620 
ç
:

621 ià(
”ºo
 =ğ
ENODEV
) {

622 
	`do_discÚÃù
(
dev
);

624 
	`³¼Ü
(
İ
);

626 
	}
}

628 
	$usb_ho¡_»Ëa£_š‹rçûs
(
USBHo¡Deviû
 *
s
)

630 
»t
, 
i
;

632 
	`Œaû_usb_ho¡_»Ëa£_š‹rçûs
(
s
->
bus_num
, s->
addr
);

634 
i
 = 0; i < 
s
->
dev
.
nš‹rçûs
; i++) {

635 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_RELEASEINTERFACE
, &
i
);

636 ià(
»t
 < 0) {

637 
	`³¼Ü
("USBDEVFS_RELEASEINTERFACE");

642 
	}
}

644 
	$usb_ho¡_hªdË_»£t
(
USBDeviû
 *
dev
)

646 
USBHo¡Deviû
 *
s
 = 
	`DO_UPCAST
(USBHo¡Deviû, 
dev
, dev);

648 
	`Œaû_usb_ho¡_»£t
(
s
->
bus_num
, s->
addr
);

650 
	`usb_ho¡_do_»£t
(
s
);;

652 
	`usb_ho¡_şaim_š‹rçûs
(
s
, 0);

653 
	`usb_lšux_upd©e_’dp_bË
(
s
);

654 
	}
}

656 
	$usb_ho¡_hªdË_de¡roy
(
USBDeviû
 *
dev
)

658 
USBHo¡Deviû
 *
s
 = (USBHo¡Deviû *)
dev
;

660 
	`usb_ho¡_»Ëa£_pÜt
(
s
);

661 
	`usb_ho¡_şo£
(
s
);

662 
	`QTAILQ_REMOVE
(&
ho¡devs
, 
s
, 
Ãxt
);

663 
	`qemu_»move_ex™_nÙif›r
(&
s
->
ex™
);

664 
	}
}

669 
AsyncURB
 *
	$usb_ho¡_®loc_iso
(
USBHo¡Deviû
 *
s
, 
pid
, 
ušt8_t
 
•
)

671 
AsyncURB
 *
aurb
;

672 
i
, 
j
, 
Ën
 = 
	`usb_•_g‘_max_·ck‘_size
(&
s
->
dev
, 
pid
, 
•
);

674 
aurb
 = 
	`g_m®loc0
(
s
->
iso_urb_couÁ
 * (*aurb));

675 
i
 = 0; i < 
s
->
iso_urb_couÁ
; i++) {

676 
aurb
[
i
].
urb
.
’dpošt
 = 
•
;

677 
aurb
[
i
].
urb
.
bufãr_Ëngth
 = 
ISO_FRAME_DESC_PER_URB
 * 
Ën
;

678 
aurb
[
i
].
urb
.
bufãr
 = 
	`g_m®loc
×urb[i].urb.
bufãr_Ëngth
);

679 
aurb
[
i
].
urb
.
ty³
 = 
USBDEVFS_URB_TYPE_ISO
;

680 
aurb
[
i
].
urb
.
æags
 = 
USBDEVFS_URB_ISO_ASAP
;

681 
aurb
[
i
].
urb
.
numb”_of_·ck‘s
 = 
ISO_FRAME_DESC_PER_URB
;

682 
j
 = 0 ; j < 
ISO_FRAME_DESC_PER_URB
; j++)

683 
aurb
[
i
].
urb
.
iso_äame_desc
[
j
].
Ëngth
 = 
Ën
;

684 ià(
pid
 =ğ
USB_TOKEN_IN
) {

685 
aurb
[
i
].
urb
.
’dpošt
 |= 0x80;

687 
aurb
[
i
].
iso_äame_idx
 = 
ISO_FRAME_DESC_PER_URB
;

690 
	`£t_iso_urb
(
s
, 
pid
, 
•
, 
aurb
);

692  
aurb
;

693 
	}
}

695 
	$usb_ho¡_¡İ_n_ä“_iso
(
USBHo¡Deviû
 *
s
, 
pid
, 
ušt8_t
 
•
)

697 
AsyncURB
 *
aurb
;

698 
i
, 
»t
, 
kËd
 = 0, 
ä“
 = 1;

700 
aurb
 = 
	`g‘_iso_urb
(
s
, 
pid
, 
•
);

701 ià(!
aurb
) {

705 
i
 = 0; i < 
s
->
iso_urb_couÁ
; i++) {

707 ià(
aurb
[
i
].
iso_äame_idx
 == -1) {

708 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_DISCARDURB
, &
aurb
[
i
]);

709 ià(
»t
 < 0) {

710 
	`³¼Ü
("USBDEVFS_DISCARDURB");

711 
ä“
 = 0;

714 
kËd
++;

719 ià(
kËd
) {

720 
	`async_com¶‘e
(
s
);

723 
i
 = 0; i < 
s
->
iso_urb_couÁ
; i++) {

724 
	`g_ä“
(
aurb
[
i
].
urb
.
bufãr
);

727 ià(
ä“
)

728 
	`g_ä“
(
aurb
);

730 
	`´štf
("husb:†eaking iso urbs because of discard failure\n");

731 
	`£t_iso_urb
(
s
, 
pid
, 
•
, 
NULL
);

732 
	`£t_iso_urb_idx
(
s
, 
pid
, 
•
, 0);

733 
	`ş—r_iso_¡¬‹d
(
s
, 
pid
, 
•
);

734 
	}
}

736 
	$urb_¡©us_to_usb_»t
(
¡©us
)

738 
¡©us
) {

739 -
EPIPE
:

740  
USB_RET_STALL
;

741 -
EOVERFLOW
:

742  
USB_RET_BABBLE
;

744  
USB_RET_IOERROR
;

746 
	}
}

748 
	$usb_ho¡_hªdË_iso_d©a
(
USBHo¡Deviû
 *
s
, 
USBPack‘
 *
p
, 
š
)

750 
AsyncURB
 *
aurb
;

751 
i
, 
j
, 
»t
, 
max_·ck‘_size
, 
off£t
, 
Ën
 = 0;

752 
ušt8_t
 *
buf
;

754 
max_·ck‘_size
 = 
p
->
•
->max_packet_size;

755 ià(
max_·ck‘_size
 == 0)

756  
USB_RET_NAK
;

758 
aurb
 = 
	`g‘_iso_urb
(
s
, 
p
->
pid
,…->
•
->
Ä
);

759 ià(!
aurb
) {

760 
aurb
 = 
	`usb_ho¡_®loc_iso
(
s
, 
p
->
pid
,…->
•
->
Ä
);

763 
i
 = 
	`g‘_iso_urb_idx
(
s
, 
p
->
pid
,…->
•
->
Ä
);

764 
j
 = 
aurb
[
i
].
iso_äame_idx
;

765 ià(
j
 >ğ0 && j < 
ISO_FRAME_DESC_PER_URB
) {

766 ià(
š
) {

768 ià(
aurb
[
i
].
urb
.
¡©us
) {

769 
Ën
 = 
	`urb_¡©us_to_usb_»t
(
aurb
[
i
].
urb
.
¡©us
);

771 
aurb
[
i
].
iso_äame_idx
 = 
ISO_FRAME_DESC_PER_URB
 - 1;

773 } ià(
aurb
[
i
].
urb
.
iso_äame_desc
[
j
].
¡©us
) {

774 
Ën
 = 
	`urb_¡©us_to_usb_»t
(

775 
aurb
[
i
].
urb
.
iso_äame_desc
[
j
].
¡©us
);

777 } ià(
aurb
[
i
].
urb
.
iso_äame_desc
[
j
].
aùu®_Ëngth


778 > 
p
->
iov
.
size
) {

779 
	`´štf
("husb:„eceived iso data is†argerhen…acket\n");

780 
Ën
 = 
USB_RET_BABBLE
;

783 
Ën
 = 
aurb
[
i
].
urb
.
iso_äame_desc
[
j
].
aùu®_Ëngth
;

784 
buf
 = 
aurb
[
i
].
urb
.
bufãr
 +

785 
j
 * 
aurb
[
i
].
urb
.
iso_äame_desc
[0].
Ëngth
;

786 
	`usb_·ck‘_cİy
(
p
, 
buf
, 
Ën
);

789 
Ën
 = 
p
->
iov
.
size
;

790 
off£t
 = (
j
 =ğ0è? 0 : 
	`g‘_iso_bufãr_u£d
(
s
, 
p
->
pid
,…->
•
->
Ä
);

793 ià(
Ën
 > 
max_·ck‘_size
) {

794 
	`´štf
("husb: send iso data is†argerhen max…acket size\n");

795  
USB_RET_NAK
;

799 
	`usb_·ck‘_cİy
(
p
, 
aurb
[
i
].
urb
.
bufãr
 + 
off£t
, 
Ën
);

800 
aurb
[
i
].
urb
.
iso_äame_desc
[
j
].
Ëngth
 = 
Ën
;

801 
off£t
 +ğ
Ën
;

802 
	`£t_iso_bufãr_u£d
(
s
, 
p
->
pid
,…->
•
->
Ä
, 
off£t
);

805 ià(!
	`is_iso_¡¬‹d
(
s
, 
p
->
pid
,…->
•
->
Ä
è&& 
i
 =ğ1 && 
j
 == 8) {

806 
	`£t_iso_¡¬‹d
(
s
, 
p
->
pid
,…->
•
->
Ä
);

809 
aurb
[
i
].
iso_äame_idx
++;

810 ià(
aurb
[
i
].
iso_äame_idx
 =ğ
ISO_FRAME_DESC_PER_URB
) {

811 
i
 = (˜+ 1è% 
s
->
iso_urb_couÁ
;

812 
	`£t_iso_urb_idx
(
s
, 
p
->
pid
,…->
•
->
Ä
, 
i
);

815 ià(
š
) {

816 
	`£t_iso_¡¬‹d
(
s
, 
p
->
pid
,…->
•
->
Ä
);

818 
	`DPRINTF
("hubs: iso outƒrror‚o free buffer, dropping…acket\n");

822 ià(
	`is_iso_¡¬‹d
(
s
, 
p
->
pid
,…->
•
->
Ä
)) {

824 
i
 = 0; i < 
s
->
iso_urb_couÁ
; i++) {

825 ià(
aurb
[
i
].
iso_äame_idx
 =ğ
ISO_FRAME_DESC_PER_URB
) {

826 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_SUBMITURB
, &
aurb
[
i
]);

827 ià(
»t
 < 0) {

828 
	`³¼Ü
("USBDEVFS_SUBMITURB");

829 ià(!
š
 || 
Ën
 == 0) {

830 
”ºo
) {

831 
ETIMEDOUT
:

832 
Ën
 = 
USB_RET_NAK
;

834 
EPIPE
:

836 
Ën
 = 
USB_RET_STALL
;

841 
aurb
[
i
].
iso_äame_idx
 = -1;

842 
	`chªge_iso_šæight
(
s
, 
p
->
pid
,…->
•
->
Ä
, 1);

847  
Ën
;

848 
	}
}

850 
	$usb_ho¡_hªdË_d©a
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
)

852 
USBHo¡Deviû
 *
s
 = 
	`DO_UPCAST
(USBHo¡Deviû, 
dev
, dev);

853 
usbdevfs_urb
 *
urb
;

854 
AsyncURB
 *
aurb
;

855 
»t
, 
»m
, 
´em
, 
v
;

856 
ušt8_t
 *
pbuf
;

857 
ušt8_t
 
•
;

859 
	`Œaû_usb_ho¡_»q_d©a
(
s
->
bus_num
, s->
addr
, 
p
,

860 
p
->
pid
 =ğ
USB_TOKEN_IN
,

861 
p
->
•
->
Ä
,…->
iov
.
size
);

863 ià(!
	`is_v®id
(
s
, 
p
->
pid
,…->
•
->
Ä
)) {

864 
	`Œaû_usb_ho¡_»q_com¶‘e
(
s
->
bus_num
, s->
addr
, 
p
, 
USB_RET_NAK
);

865  
USB_RET_NAK
;

868 ià(
p
->
pid
 =ğ
USB_TOKEN_IN
) {

869 
•
 = 
p
->•->
Ä
 | 0x80;

871 
•
 = 
p
->•->
Ä
;

874 ià(
	`is_h®‹d
(
s
, 
p
->
pid
,…->
•
->
Ä
)) {

875 
¬g
 = 
•
;

876 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_CLEAR_HALT
, &
¬g
);

877 ià(
»t
 < 0) {

878 
	`³¼Ü
("USBDEVFS_CLEAR_HALT");

879 
	`Œaû_usb_ho¡_»q_com¶‘e
(
s
->
bus_num
, s->
addr
, 
p
, 
USB_RET_NAK
);

880  
USB_RET_NAK
;

882 
	`ş—r_h®t
(
s
, 
p
->
pid
,…->
•
->
Ä
);

885 ià(
	`is_isoc
(
s
, 
p
->
pid
,…->
•
->
Ä
)) {

886  
	`usb_ho¡_hªdË_iso_d©a
(
s
, 
p
,…->
pid
 =ğ
USB_TOKEN_IN
);

889 
v
 = 0;

890 
´em
 = 0;

891 
pbuf
 = 
NULL
;

892 
»m
 = 
p
->
iov
.
size
;

894 ià(
´em
 =ğ0 && 
»m
 > 0) {

895 
	`as£¹
(
v
 < 
p
->
iov
.
niov
);

896 
´em
 = 
p
->
iov
.iov[
v
].
iov_Ën
;

897 
pbuf
 = 
p
->
iov
.iov[
v
].
iov_ba£
;

898 
	`as£¹
(
´em
 <ğ
»m
);

899 
v
++;

901 
aurb
 = 
	`async_®loc
(
s
);

902 
aurb
->
·ck‘
 = 
p
;

904 
urb
 = &
aurb
->urb;

905 
urb
->
’dpošt
 = 
•
;

906 
urb
->
ty³
 = 
	`usb_ho¡_usbfs_ty³
(
s
, 
p
);

907 
urb
->
u£rcÚ‹xt
 = 
s
;

908 
urb
->
bufãr
 = 
pbuf
;

909 
urb
->
bufãr_Ëngth
 = 
´em
;

911 ià(
urb
->
bufãr_Ëngth
 > 
MAX_USBFS_BUFFER_SIZE
) {

912 
urb
->
bufãr_Ëngth
 = 
MAX_USBFS_BUFFER_SIZE
;

914 
pbuf
 +ğ
urb
->
bufãr_Ëngth
;

915 
´em
 -ğ
urb
->
bufãr_Ëngth
;

916 
»m
 -ğ
urb
->
bufãr_Ëngth
;

917 ià(
»m
) {

918 
aurb
->
mÜe
 = 1;

921 
	`Œaû_usb_ho¡_urb_subm™
(
s
->
bus_num
, s->
addr
, 
aurb
,

922 
urb
->
bufãr_Ëngth
, 
aurb
->
mÜe
);

923 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_SUBMITURB
, 
urb
);

925 
	`DPRINTF
("husb: data submit:ƒp 0x%x,†en %u, more %d,…acket %p,‡urb %p\n",

926 
urb
->
’dpošt
, urb->
bufãr_Ëngth
, 
aurb
->
mÜe
, 
p
,‡urb);

928 ià(
»t
 < 0) {

929 
	`³¼Ü
("USBDEVFS_SUBMITURB");

930 
	`async_ä“
(
aurb
);

932 
”ºo
) {

933 
ETIMEDOUT
:

934 
	`Œaû_usb_ho¡_»q_com¶‘e
(
s
->
bus_num
, s->
addr
, 
p
,

935 
USB_RET_NAK
);

936  
USB_RET_NAK
;

937 
EPIPE
:

939 
	`Œaû_usb_ho¡_»q_com¶‘e
(
s
->
bus_num
, s->
addr
, 
p
,

940 
USB_RET_STALL
);

941  
USB_RET_STALL
;

944 } 
»m
 > 0);

946  
USB_RET_ASYNC
;

947 
	}
}

949 
	$ù¾_”rÜ
()

951 ià(
”ºo
 =ğ
ETIMEDOUT
) {

952  
USB_RET_NAK
;

954  
USB_RET_STALL
;

956 
	}
}

958 
	$usb_ho¡_£t_add»ss
(
USBHo¡Deviû
 *
s
, 
addr
)

960 
	`Œaû_usb_ho¡_£t_add»ss
(
s
->
bus_num
, s->
addr
,‡ddr);

961 
s
->
dev
.
addr
 =‡ddr;

963 
	}
}

965 
	$usb_ho¡_£t_cÚfig
(
USBHo¡Deviû
 *
s
, 
cÚfig
)

967 
»t
, 
fœ¡
 = 1;

969 
	`Œaû_usb_ho¡_£t_cÚfig
(
s
->
bus_num
, s->
addr
, 
cÚfig
);

971 
	`usb_ho¡_»Ëa£_š‹rçûs
(
s
);

973 
agaš
:

974 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_SETCONFIGURATION
, &
cÚfig
);

976 
	`DPRINTF
("husb: cŒÈ£ˆcÚfig %d„‘ %dƒ¼nØ%d\n", 
cÚfig
, 
»t
, 
”ºo
);

978 ià(
»t
 < 0 && 
”ºo
 =ğ
EBUSY
 && 
fœ¡
) {

980 
couÁ
 = 
	`usb_lšux_g‘_num_š‹rçûs
(
s
);

981 ià(
couÁ
 > 0) {

982 
	`DPRINTF
("husb: busy -> discÚÃùšg %d iÁ”çûs\n", 
couÁ
);

983 
	`usb_ho¡_discÚÃù_içûs
(
s
, 
couÁ
);

984 
fœ¡
 = 0;

985 
agaš
;

989 ià(
»t
 < 0) {

990  
	`ù¾_”rÜ
();

992 
	`usb_ho¡_şaim_š‹rçûs
(
s
, 
cÚfig
);

993 
	`usb_lšux_upd©e_’dp_bË
(
s
);

995 
	}
}

997 
	$usb_ho¡_£t_š‹rçû
(
USBHo¡Deviû
 *
s
, 
içû
, 
®t
)

999 
usbdevfs_£tš‹rçû
 
si
;

1000 
i
, 
»t
;

1002 
	`Œaû_usb_ho¡_£t_š‹rçû
(
s
->
bus_num
, s->
addr
, 
içû
, 
®t
);

1004 
i
 = 1; i <ğ
USB_MAX_ENDPOINTS
; i++) {

1005 ià(
	`is_isoc
(
s
, 
USB_TOKEN_IN
, 
i
)) {

1006 
	`usb_ho¡_¡İ_n_ä“_iso
(
s
, 
USB_TOKEN_IN
, 
i
);

1008 ià(
	`is_isoc
(
s
, 
USB_TOKEN_OUT
, 
i
)) {

1009 
	`usb_ho¡_¡İ_n_ä“_iso
(
s
, 
USB_TOKEN_OUT
, 
i
);

1013 ià(
içû
 >ğ
USB_MAX_INTERFACES
) {

1014  
USB_RET_STALL
;

1017 
si
.
š‹rçû
 = 
içû
;

1018 
si
.
®t£‰šg
 = 
®t
;

1019 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_SETINTERFACE
, &
si
);

1021 
	`DPRINTF
("husb: ctrl set iface %d‡ltset %d„et %dƒrrno %d\n",

1022 
içû
, 
®t
, 
»t
, 
”ºo
);

1024 ià(
»t
 < 0) {

1025  
	`ù¾_”rÜ
();

1028 
s
->
dev
.
®t£‰šg
[
içû
] = 
®t
;

1029 
	`usb_lšux_upd©e_’dp_bË
(
s
);

1031 
	}
}

1033 
	$usb_ho¡_hªdË_cÚŒŞ
(
USBDeviû
 *
dev
, 
USBPack‘
 *
p
,

1034 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

1036 
USBHo¡Deviû
 *
s
 = 
	`DO_UPCAST
(USBHo¡Deviû, 
dev
, dev);

1037 
usbdevfs_urb
 *
urb
;

1038 
AsyncURB
 *
aurb
;

1039 
»t
;

1047 
	`Œaû_usb_ho¡_»q_cÚŒŞ
(
s
->
bus_num
, s->
addr
, 
p
, 
»que¡
, 
v®ue
, 
šdex
);

1048 
	`as£¹
(
p
->
»suÉ
 == 0);

1050 
»que¡
) {

1051 
DeviûOutReque¡
 | 
USB_REQ_SET_ADDRESS
:

1052 
»t
 = 
	`usb_ho¡_£t_add»ss
(
s
, 
v®ue
);

1053 
	`Œaû_usb_ho¡_»q_emuÏ‹d
(
s
->
bus_num
, s->
addr
, 
p
, 
»t
);

1054  
»t
;

1056 
DeviûOutReque¡
 | 
USB_REQ_SET_CONFIGURATION
:

1057 
»t
 = 
	`usb_ho¡_£t_cÚfig
(
s
, 
v®ue
 & 0xff);

1058 
	`Œaû_usb_ho¡_»q_emuÏ‹d
(
s
->
bus_num
, s->
addr
, 
p
, 
»t
);

1059  
»t
;

1061 
IÁ”çûOutReque¡
 | 
USB_REQ_SET_INTERFACE
:

1062 
»t
 = 
	`usb_ho¡_£t_š‹rçû
(
s
, 
šdex
, 
v®ue
);

1063 
	`Œaû_usb_ho¡_»q_emuÏ‹d
(
s
->
bus_num
, s->
addr
, 
p
, 
»t
);

1064  
»t
;

1066 
EndpoštOutReque¡
 | 
USB_REQ_CLEAR_FEATURE
:

1067 ià(
v®ue
 == 0) {

1068 
pid
 = (
šdex
 & 
USB_DIR_IN
è? 
USB_TOKEN_IN
 : 
USB_TOKEN_OUT
;

1069 
	`ioùl
(
s
->
fd
, 
USBDEVFS_CLEAR_HALT
, &
šdex
);

1070 
	`ş—r_h®t
(
s
, 
pid
, 
šdex
 & 0x0f);

1071 
	`Œaû_usb_ho¡_»q_emuÏ‹d
(
s
->
bus_num
, s->
addr
, 
p
, 0);

1078 ià(
Ëngth
 > (
dev
->
d©a_buf
)) {

1079 
	`årštf
(
¡d”r
, "husb: ctrl bufferoo small (%d > %zu)\n",

1080 
Ëngth
, (
dev
->
d©a_buf
));

1081  
USB_RET_STALL
;

1084 
aurb
 = 
	`async_®loc
(
s
);

1085 
aurb
->
·ck‘
 = 
p
;

1093 
urb
 = &
aurb
->urb;

1095 
urb
->
ty³
 = 
USBDEVFS_URB_TYPE_CONTROL
;

1096 
urb
->
’dpošt
 = 
p
->
•
->
Ä
;

1098 
urb
->
bufãr
 = &
dev
->
£tup_buf
;

1099 
urb
->
bufãr_Ëngth
 = 
Ëngth
 + 8;

1101 
urb
->
u£rcÚ‹xt
 = 
s
;

1103 
	`Œaû_usb_ho¡_urb_subm™
(
s
->
bus_num
, s->
addr
, 
aurb
,

1104 
urb
->
bufãr_Ëngth
, 
aurb
->
mÜe
);

1105 
»t
 = 
	`ioùl
(
s
->
fd
, 
USBDEVFS_SUBMITURB
, 
urb
);

1107 
	`DPRINTF
("husb: subm™ cŒl.†’ %u‡urb %p\n", 
urb
->
bufãr_Ëngth
, 
aurb
);

1109 ià(
»t
 < 0) {

1110 
	`DPRINTF
("husb: subm™ faed.ƒ¼nØ%d\n", 
”ºo
);

1111 
	`async_ä“
(
aurb
);

1113 
”ºo
) {

1114 
ETIMEDOUT
:

1115  
USB_RET_NAK
;

1116 
EPIPE
:

1118  
USB_RET_STALL
;

1122  
USB_RET_ASYNC
;

1123 
	}
}

1126 
	$usb_lšux_upd©e_’dp_bË
(
USBHo¡Deviû
 *
s
)

1128 cÚ¡ *
Šame
[] = {

1129 [
USB_ENDPOINT_XFER_CONTROL
] = "control",

1130 [
USB_ENDPOINT_XFER_ISOC
] = "isoc",

1131 [
USB_ENDPOINT_XFER_BULK
] = "bulk",

1132 [
USB_ENDPOINT_XFER_INT
] = "int",

1134 
ušt8_t
 
dev•
, 
ty³
;

1135 
ušt16_t
 
mps
, 
v
, 
p
;

1136 
•
, 
pid
;

1137 
i
, 
cÚfigu¿tiÚ
 = -1, 
š‹rçû
 = -1, 
®t£‰šg
 = -1;

1138 
’dp_d©a
 *
•d
;

1139 
USBDesütÜ
 *
d
;

1140 
boŞ
 
aùive
 = 
çl£
;

1142 
	`usb_•_»£t
(&
s
->
dev
);

1144 
i
 = 0;; i +ğ
d
->
bL’gth
) {

1145 ià(
i
+2 >ğ
s
->
desü_Ën
) {

1148 
d
 = (*)(
s
->
desü
 + 
i
);

1149 ià(
d
->
bL’gth
 < 2) {

1150 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1152 
”rÜ
;

1154 ià(
i
 + 
d
->
bL’gth
 > 
s
->
desü_Ën
) {

1155 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1157 
”rÜ
;

1159 
d
->
bDesütÜTy³
) {

1161 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1163 
”rÜ
;

1164 
USB_DT_DEVICE
:

1165 ià(
d
->
bL’gth
 < 0x12) {

1166 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1168 
”rÜ
;

1170 
v
 = (
d
->
u
.
deviû
.
idV’dÜ_hi
 << 8è| d->u.deviû.
idV’dÜ_lo
;

1171 
p
 = (
d
->
u
.
deviû
.
idProduù_hi
 << 8è| d->u.deviû.
idProduù_lo
;

1172 
	`Œaû_usb_ho¡_·r£_deviû
(
s
->
bus_num
, s->
addr
, 
v
, 
p
);

1174 
USB_DT_CONFIG
:

1175 ià(
d
->
bL’gth
 < 0x09) {

1176 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1178 
”rÜ
;

1180 
cÚfigu¿tiÚ
 = 
d
->
u
.
cÚfig
.
bCÚfigu¿tiÚV®ue
;

1181 
aùive
 = (
cÚfigu¿tiÚ
 =ğ
s
->
dev
.configuration);

1182 
	`Œaû_usb_ho¡_·r£_cÚfig
(
s
->
bus_num
, s->
addr
,

1183 
cÚfigu¿tiÚ
, 
aùive
);

1185 
USB_DT_INTERFACE
:

1186 ià(
d
->
bL’gth
 < 0x09) {

1187 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1189 
”rÜ
;

1191 
š‹rçû
 = 
d
->
u
.š‹rçû.
bIÁ”çûNumb”
;

1192 
®t£‰šg
 = 
d
->
u
.
š‹rçû
.
bAÉ”Ç‹S‘tšg
;

1193 
aùive
 = (
cÚfigu¿tiÚ
 =ğ
s
->
dev
.configuration) &&

1194 (
®t£‰šg
 =ğ
s
->
dev
.®t£‰šg[
š‹rçû
]);

1195 
	`Œaû_usb_ho¡_·r£_š‹rçû
(
s
->
bus_num
, s->
addr
,

1196 
š‹rçû
, 
®t£‰šg
, 
aùive
);

1198 
USB_DT_ENDPOINT
:

1199 ià(
d
->
bL’gth
 < 0x07) {

1200 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1202 
”rÜ
;

1204 
dev•
 = 
d
->
u
.
’dpošt
.
bEndpoštAdd»ss
;

1205 
pid
 = (
dev•
 & 
USB_DIR_IN
è? 
USB_TOKEN_IN
 : 
USB_TOKEN_OUT
;

1206 
•
 = 
dev•
 & 0xf;

1207 ià(
•
 == 0) {

1208 
	`Œaû_usb_ho¡_·r£_”rÜ
(
s
->
bus_num
, s->
addr
,

1210 
”rÜ
;

1213 
ty³
 = 
d
->
u
.
’dpošt
.
bmA‰ribu‹s
 & 0x3;

1214 
mps
 = 
d
->
u
.
’dpošt
.
wMaxPack‘Size_lo
 |

1215 (
d
->
u
.
’dpošt
.
wMaxPack‘Size_hi
 << 8);

1216 
	`Œaû_usb_ho¡_·r£_’dpošt
(
s
->
bus_num
, s->
addr
, 
•
,

1217 (
dev•
 & 
USB_DIR_IN
) ? "in" : "out",

1218 
Šame
[
ty³
], 
aùive
);

1220 ià(
aùive
) {

1221 
	`usb_•_£t_max_·ck‘_size
(&
s
->
dev
, 
pid
, 
•
, 
mps
);

1222 
	`as£¹
(
	`usb_•_g‘_ty³
(&
s
->
dev
, 
pid
, 
•
) ==

1223 
USB_ENDPOINT_XFER_INVALID
);

1224 
	`usb_•_£t_ty³
(&
s
->
dev
, 
pid
, 
•
, 
ty³
);

1225 
	`usb_•_£t_iâum
(&
s
->
dev
, 
pid
, 
•
, 
š‹rçû
);

1226 ià((
s
->
İtiÚs
 & (1 << 
USB_HOST_OPT_PIPELINE
)) &&

1227 (
ty³
 =ğ
USB_ENDPOINT_XFER_BULK
)) {

1228 
	`usb_•_£t_p–še
(&
s
->
dev
, 
pid
, 
•
, 
Œue
);

1231 
•d
 = 
	`g‘_’dp
(
s
, 
pid
, 
•
);

1232 
•d
->
h®‹d
 = 0;

1237 
	`Œaû_usb_ho¡_·r£_unknown
(
s
->
bus_num
, s->
addr
,

1238 
d
->
bL’gth
, d->
bDesütÜTy³
);

1244 
”rÜ
:

1245 
	`usb_•_»£t
(&
s
->
dev
);

1247 
	}
}

1257 
	$usb_lšux_fuÎ_¥“d_com·t
(
USBHo¡Deviû
 *
dev
)

1259 
i
, 
·ck‘_size
;

1265 
i
 = 0; (˜+ 5è< 
dev
->
desü_Ën
; i +ğdev->
desü
[i]) {

1266 ià(
dev
->
desü
[
i
 + 1] =ğ
USB_DT_ENDPOINT
) {

1267 
dev
->
desü
[
i
 + 3] & 0x3) {

1275 
·ck‘_size
 = 
dev
->
desü
[
i
 + 4] + (dev->descr[i + 5] << 8);

1276 ià(
·ck‘_size
 > 64)

1283 
	}
}

1285 
	$usb_ho¡_İ’
(
USBHo¡Deviû
 *
dev
, 
bus_num
,

1286 
addr
, cÚ¡ *
pÜt
,

1287 cÚ¡ *
´od_Çme
, 
¥“d
)

1289 
fd
 = -1, 
»t
;

1291 
	`Œaû_usb_ho¡_İ’_¡¬‹d
(
bus_num
, 
addr
);

1293 ià(
dev
->
fd
 != -1) {

1294 
ç
;

1297 
fd
 = 
	`usb_ho¡_İ’_deviû
(
bus_num
, 
addr
);

1298 ià(
fd
 < 0) {

1299 
ç
;

1301 
	`DPRINTF
("husb: o³Ãd %s\n", 
buf
);

1303 
dev
->
bus_num
 = bus_num;

1304 
dev
->
addr
 =‡ddr;

1305 
	`¡rıy
(
dev
->
pÜt
,…ort);

1306 
dev
->
fd
 = fd;

1309 
dev
->
desü_Ën
 = 
	`»ad
(
fd
, dev->
desü
, (dev->descr));

1310 ià(
dev
->
desü_Ën
 <= 0) {

1311 
	`³¼Ü
("husb:„eading device data failed");

1312 
ç
;

1315 #ifdeà
DEBUG


1317 
x
;

1318 
	`´štf
("=== begin dumping device descriptor data ===\n");

1319 
x
 = 0; x < 
dev
->
desü_Ën
; x++) {

1320 
	`´štf
("%02x ", 
dev
->
desü
[
x
]);

1322 
	`´štf
("\n===ƒnd dumping device descriptor data ===\n");

1328 ià(!
	`usb_ho¡_şaim_š‹rçûs
(
dev
, 0)) {

1329 
ç
;

1332 
	`usb_•_š™
(&
dev
->dev);

1333 
»t
 = 
	`usb_lšux_upd©e_’dp_bË
(
dev
);

1334 ià(
»t
) {

1335 
ç
;

1338 ià(
¥“d
 == -1) {

1339 
usbdevfs_cÚÃùšfo
 
ci
;

1341 
»t
 = 
	`ioùl
(
fd
, 
USBDEVFS_CONNECTINFO
, &
ci
);

1342 ià(
»t
 < 0) {

1343 
	`³¼Ü
("usb_host_device_open: USBDEVFS_CONNECTINFO");

1344 
ç
;

1347 ià(
ci
.
¦ow
) {

1348 
¥“d
 = 
USB_SPEED_LOW
;

1350 
¥“d
 = 
USB_SPEED_HIGH
;

1353 
dev
->dev.
¥“d
 = speed;

1354 
dev
->dev.
¥“dmask
 = (1 << 
¥“d
);

1355 ià(
dev
->dev.
¥“d
 =ğ
USB_SPEED_HIGH
 && 
	`usb_lšux_fuÎ_¥“d_com·t
(dev)) {

1356 
dev
->dev.
¥“dmask
 |ğ
USB_SPEED_MASK_FULL
;

1359 
	`Œaû_usb_ho¡_İ’_sucûss
(
bus_num
, 
addr
);

1361 ià(!
´od_Çme
 ||…rod_name[0] == '\0') {

1362 
	`¢´štf
(
dev
->dev.
´oduù_desc
, (dev->dev.product_desc),

1363 "ho¡:%d.%d", 
bus_num
, 
addr
);

1365 
	`p¡rıy
(
dev
->dev.
´oduù_desc
, (dev->dev.product_desc),

1366 
´od_Çme
);

1369 
»t
 = 
	`usb_deviû_©ch
(&
dev
->dev);

1370 ià(
»t
) {

1371 
ç
;

1375 
	`qemu_£t_fd_hªdËr
(
dev
->
fd
, 
NULL
, 
async_com¶‘e
, dev);

1379 
ç
:

1380 
	`Œaû_usb_ho¡_İ’_çu»
(
bus_num
, 
addr
);

1381 ià(
dev
->
fd
 != -1) {

1382 
	`şo£
(
dev
->
fd
);

1383 
dev
->
fd
 = -1;

1386 
	}
}

1388 
	$usb_ho¡_şo£
(
USBHo¡Deviû
 *
dev
)

1390 
i
;

1392 ià(
dev
->
fd
 == -1) {

1396 
	`Œaû_usb_ho¡_şo£
(
dev
->
bus_num
, dev->
addr
);

1398 
	`qemu_£t_fd_hªdËr
(
dev
->
fd
, 
NULL
, NULL, NULL);

1399 
dev
->
şosšg
 = 1;

1400 
i
 = 1; i <ğ
USB_MAX_ENDPOINTS
; i++) {

1401 ià(
	`is_isoc
(
dev
, 
USB_TOKEN_IN
, 
i
)) {

1402 
	`usb_ho¡_¡İ_n_ä“_iso
(
dev
, 
USB_TOKEN_IN
, 
i
);

1404 ià(
	`is_isoc
(
dev
, 
USB_TOKEN_OUT
, 
i
)) {

1405 
	`usb_ho¡_¡İ_n_ä“_iso
(
dev
, 
USB_TOKEN_OUT
, 
i
);

1408 
	`async_com¶‘e
(
dev
);

1409 
dev
->
şosšg
 = 0;

1410 ià(
dev
->dev.
©ched
) {

1411 
	`usb_deviû_d‘ach
(&
dev
->dev);

1413 
	`usb_ho¡_do_»£t
(
dev
);

1414 
	`şo£
(
dev
->
fd
);

1415 
dev
->
fd
 = -1;

1417 
	}
}

1419 
	$usb_ho¡_ex™_nÙif›r
(
NÙif›r
 *
n
, *
d©a
)

1421 
USBHo¡Deviû
 *
s
 = 
	`cÚš”_of
(
n
, USBHo¡Deviû, 
ex™
);

1423 
	`usb_ho¡_»Ëa£_pÜt
(
s
);

1424 ià(
s
->
fd
 != -1) {

1425 
	`usb_ho¡_do_»£t
(
s
);;

1427 
	}
}

1445 
	$usb_ho¡_po¡_lßd_bh
(*
İaque
)

1447 
USBHo¡Deviû
 *
dev
 = 
İaque
;

1449 ià(
dev
->
fd
 != -1) {

1450 
	`usb_ho¡_şo£
(
dev
);

1452 ià(
dev
->dev.
©ched
) {

1453 
	`usb_deviû_d‘ach
(&
dev
->dev);

1455 
	`usb_ho¡_auto_check
(
NULL
);

1456 
	}
}

1458 
	$usb_ho¡_po¡_lßd
(*
İaque
, 
v”siÚ_id
)

1460 
USBHo¡Deviû
 *
dev
 = 
İaque
;

1462 
	`qemu_bh_scheduË
(
dev
->
bh
);

1464 
	}
}

1466 
	$usb_ho¡_š™â
(
USBDeviû
 *
dev
)

1468 
USBHo¡Deviû
 *
s
 = 
	`DO_UPCAST
(USBHo¡Deviû, 
dev
, dev);

1470 
dev
->
auto_©ch
 = 0;

1471 
s
->
fd
 = -1;

1472 
s
->
hub_fd
 = -1;

1474 
	`QTAILQ_INSERT_TAIL
(&
ho¡devs
, 
s
, 
Ãxt
);

1475 
s
->
ex™
.
nÙify
 = 
usb_ho¡_ex™_nÙif›r
;

1476 
	`qemu_add_ex™_nÙif›r
(&
s
->
ex™
);

1477 
s
->
bh
 = 
	`qemu_bh_Ãw
(
usb_ho¡_po¡_lßd_bh
, s);

1478 
	`usb_ho¡_auto_check
(
NULL
);

1480 ià(
s
->
m©ch
.
bus_num
 !ğ0 && s->m©ch.
pÜt
 !ğ
NULL
) {

1481 
	`usb_ho¡_şaim_pÜt
(
s
);

1483 
	`add_boÙ_deviû_·th
(
s
->
boÙšdex
, &
dev
->
qdev
, 
NULL
);

1485 
	}
}

1487 cÚ¡ 
VMS‹DesütiÚ
 
	gvm¡©e_usb_ho¡
 = {

1488 .
Çme
 = "usb-host",

1489 .
	gv”siÚ_id
 = 1,

1490 .
	gmšimum_v”siÚ_id
 = 1,

1491 .
	gpo¡_lßd
 = 
usb_ho¡_po¡_lßd
,

1492 .
	gf›lds
 = (
VMS‹F›ld
[]) {

1493 
VMSTATE_USB_DEVICE
(
dev
, 
USBHo¡Deviû
),

1494 
VMSTATE_END_OF_LIST
()

1498 
Prİ”ty
 
	gusb_ho¡_dev_´İ”t›s
[] = {

1499 
DEFINE_PROP_UINT32
("ho¡bus", 
USBHo¡Deviû
, 
m©ch
.
bus_num
, 0),

1500 
DEFINE_PROP_UINT32
("ho¡addr", 
USBHo¡Deviû
, 
m©ch
.
addr
, 0),

1501 
DEFINE_PROP_STRING
("ho¡pÜt", 
USBHo¡Deviû
, 
m©ch
.
pÜt
),

1502 
DEFINE_PROP_HEX32
("v’dÜid", 
USBHo¡Deviû
, 
m©ch
.
v’dÜ_id
, 0),

1503 
DEFINE_PROP_HEX32
("´oduùid", 
USBHo¡Deviû
, 
m©ch
.
´oduù_id
, 0),

1504 
DEFINE_PROP_UINT32
("isobufs", 
USBHo¡Deviû
, 
iso_urb_couÁ
, 4),

1505 
DEFINE_PROP_INT32
("boÙšdex", 
USBHo¡Deviû
, 
boÙšdex
, -1),

1506 
DEFINE_PROP_BIT
("p–še", 
USBHo¡Deviû
, 
İtiÚs
,

1507 
USB_HOST_OPT_PIPELINE
, 
Œue
),

1508 
DEFINE_PROP_END_OF_LIST
(),

1511 
	$usb_ho¡_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1513 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1514 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

1516 
uc
->
š™
 = 
usb_ho¡_š™â
;

1517 
uc
->
´oduù_desc
 = "USB Host Device";

1518 
uc
->
ÿnûl_·ck‘
 = 
usb_ho¡_async_ÿnûl
;

1519 
uc
->
hªdË_d©a
 = 
usb_ho¡_hªdË_d©a
;

1520 
uc
->
hªdË_cÚŒŞ
 = 
usb_ho¡_hªdË_cÚŒŞ
;

1521 
uc
->
hªdË_»£t
 = 
usb_ho¡_hªdË_»£t
;

1522 
uc
->
hªdË_de¡roy
 = 
usb_ho¡_hªdË_de¡roy
;

1523 
dc
->
vmsd
 = &
vm¡©e_usb_ho¡
;

1524 
dc
->
´İs
 = 
usb_ho¡_dev_´İ”t›s
;

1525 
	}
}

1527 
Ty³Info
 
	gusb_ho¡_dev_šfo
 = {

1528 .
Çme
 = "usb-host",

1529 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

1530 .
	gš¡ªû_size
 = (
USBHo¡Deviû
),

1531 .
	gşass_š™
 = 
usb_ho¡_şass_š™â
,

1534 
	$usb_ho¡_»gi¡”_ty³s
()

1536 
	`ty³_»gi¡”_¡©ic
(&
usb_ho¡_dev_šfo
);

1537 
	`usb_Ëgacy_»gi¡”
("usb-ho¡", "ho¡", 
usb_ho¡_deviû_İ’
);

1538 
	}
}

1540 
	$ty³_š™
(
usb_ho¡_»gi¡”_ty³s
)

1542 
USBDeviû
 *
	$usb_ho¡_deviû_İ’
(
USBBus
 *
bus
, cÚ¡ *
devÇme
)

1544 
USBAutoF‹r
 
f‹r
;

1545 
USBDeviû
 *
dev
;

1546 *
p
;

1548 
dev
 = 
	`usb_ü—‹
(
bus
, "usb-host");

1550 ià(
	`¡r¡r
(
devÇme
, "auto:")) {

1551 ià(
	`·r£_f‹r
(
devÇme
, &
f‹r
) < 0) {

1552 
ç
;

1555 ià((
p
 = 
	`¡rchr
(
devÇme
, '.'))) {

1556 
f‹r
.
bus_num
 = 
	`¡¹oul
(
devÇme
, 
NULL
, 0);

1557 
f‹r
.
addr
 = 
	`¡¹oul
(
p
 + 1, 
NULL
, 0);

1558 
f‹r
.
v’dÜ_id
 = 0;

1559 
f‹r
.
´oduù_id
 = 0;

1560 } ià((
p
 = 
	`¡rchr
(
devÇme
, ':'))) {

1561 
f‹r
.
bus_num
 = 0;

1562 
f‹r
.
addr
 = 0;

1563 
f‹r
.
v’dÜ_id
 = 
	`¡¹oul
(
devÇme
, 
NULL
, 16);

1564 
f‹r
.
´oduù_id
 = 
	`¡¹oul
(
p
 + 1, 
NULL
, 16);

1566 
ç
;

1570 
	`qdev_´İ_£t_ušt32
(&
dev
->
qdev
, "ho¡bus", 
f‹r
.
bus_num
);

1571 
	`qdev_´İ_£t_ušt32
(&
dev
->
qdev
, "ho¡addr", 
f‹r
.
addr
);

1572 
	`qdev_´İ_£t_ušt32
(&
dev
->
qdev
, "v’dÜid", 
f‹r
.
v’dÜ_id
);

1573 
	`qdev_´İ_£t_ušt32
(&
dev
->
qdev
, "´oduùid", 
f‹r
.
´oduù_id
);

1574 
	`qdev_š™_noç
(&
dev
->
qdev
);

1575  
dev
;

1577 
ç
:

1578 
	`qdev_ä“
(&
dev
->
qdev
);

1579  
NULL
;

1580 
	}
}

1582 
	$usb_ho¡_deviû_şo£
(cÚ¡ *
devÇme
)

1585 
´oduù_Çme
[
PRODUCT_NAME_SZ
];

1586 
bus_num
, 
addr
;

1587 
USBHo¡Deviû
 *
s
;

1589 ià(
	`¡r¡r
(
devÇme
, "auto:")) {

1590  
	`usb_ho¡_auto_d–
(
devÇme
);

1592 ià(
	`usb_ho¡_fšd_deviû
(&
bus_num
, &
addr
, 
´oduù_Çme
,

1593 (
´oduù_Çme
), 
devÇme
) < 0) {

1596 
s
 = 
	`ho¡dev_fšd
(
bus_num
, 
addr
);

1597 ià(
s
) {

1598 
	`usb_deviû_d–‘e_addr
(
s
->
bus_num
, s->
dev
.
addr
);

1604 
	}
}

1616 
	$usb_ho¡_»ad_fe
(*
lše
, 
size_t
 
lše_size
,

1617 cÚ¡ *
deviû_fe
, cÚ¡ *
deviû_Çme
)

1619 
FILE
 *
f
;

1620 
»t
 = 0;

1621 
f’ame
[
PATH_MAX
];

1623 
	`¢´štf
(
f’ame
, 
PATH_MAX
, "/sys/bus/usb/deviûs/%s/%s", 
deviû_Çme
,

1624 
deviû_fe
);

1625 
f
 = 
	`fİ’
(
f’ame
, "r");

1626 ià(
f
) {

1627 
»t
 = 
	`fg‘s
(
lše
, 
lše_size
, 
f
è!ğ
NULL
;

1628 
	`fşo£
(
f
);

1631  
»t
;

1632 
	}
}

1641 
	$usb_ho¡_sÿn
(*
İaque
, 
USBSÿnFunc
 *
func
)

1643 
DIR
 *
dœ
 = 
NULL
;

1644 
lše
[1024];

1645 
bus_num
, 
addr
, 
¥“d
, 
şass_id
, 
´oduù_id
, 
v’dÜ_id
;

1646 
»t
 = 0;

1647 
pÜt
[
MAX_PORTLEN
];

1648 
´oduù_Çme
[512];

1649 
dœ’t
 *
de
;

1651 
dœ
 = 
	`İ’dœ
("/sys/bus/usb/devices");

1652 ià(!
dœ
) {

1653 
	`³¼Ü
("husb: opendir /sys/bus/usb/devices");

1654 
	`årštf
(
¡d”r
, "husb:…lease make sure sysfs is mounted‡t /sys\n");

1655 
the_’d
;

1658 (
de
 = 
	`»addœ
(
dœ
))) {

1659 ià(
de
->
d_Çme
[0] !ğ'.' && !
	`¡rchr
(de->d_name, ':')) {

1660 ià(
	`ssÿnf
(
de
->
d_Çme
, "%d-%7[0-9.]", &
bus_num
, 
pÜt
) < 2) {

1664 ià(!
	`usb_ho¡_»ad_fe
(
lše
, Öše), "devnum", 
de
->
d_Çme
)) {

1665 
the_’d
;

1667 ià(
	`ssÿnf
(
lše
, "%d", &
addr
) != 1) {

1668 
the_’d
;

1670 ià(!
	`usb_ho¡_»ad_fe
(
lše
, (line), "bDeviceClass",

1671 
de
->
d_Çme
)) {

1672 
the_’d
;

1674 ià(
	`ssÿnf
(
lše
, "%x", &
şass_id
) != 1) {

1675 
the_’d
;

1678 ià(!
	`usb_ho¡_»ad_fe
(
lše
, (line), "idVendor",

1679 
de
->
d_Çme
)) {

1680 
the_’d
;

1682 ià(
	`ssÿnf
(
lše
, "%x", &
v’dÜ_id
) != 1) {

1683 
the_’d
;

1685 ià(!
	`usb_ho¡_»ad_fe
(
lše
, (line), "idProduct",

1686 
de
->
d_Çme
)) {

1687 
the_’d
;

1689 ià(
	`ssÿnf
(
lše
, "%x", &
´oduù_id
) != 1) {

1690 
the_’d
;

1692 ià(!
	`usb_ho¡_»ad_fe
(
lše
, (line), "product",

1693 
de
->
d_Çme
)) {

1694 *
´oduù_Çme
 = 0;

1696 ià(
	`¡¾’
(
lše
) > 0) {

1697 
lše
[
	`¡¾’
(line) - 1] = '\0';

1699 
	`p¡rıy
(
´oduù_Çme
, Õroduù_Çme), 
lše
);

1702 ià(!
	`usb_ho¡_»ad_fe
(
lše
, Öše), "¥“d", 
de
->
d_Çme
)) {

1703 
the_’d
;

1705 ià(!
	`¡rcmp
(
lše
, "5000\n")) {

1706 
¥“d
 = 
USB_SPEED_SUPER
;

1707 } ià(!
	`¡rcmp
(
lše
, "480\n")) {

1708 
¥“d
 = 
USB_SPEED_HIGH
;

1709 } ià(!
	`¡rcmp
(
lše
, "1.5\n")) {

1710 
¥“d
 = 
USB_SPEED_LOW
;

1712 
¥“d
 = 
USB_SPEED_FULL
;

1715 
»t
 = 
	`func
(
İaque
, 
bus_num
, 
addr
, 
pÜt
, 
şass_id
, 
v’dÜ_id
,

1716 
´oduù_id
, 
´oduù_Çme
, 
¥“d
);

1717 ià(
»t
) {

1718 
the_’d
;

1722 
the_’d
:

1723 ià(
dœ
) {

1724 
	`şo£dœ
(
dœ
);

1726  
»t
;

1727 
	}
}

1729 
QEMUTim”
 *
	gusb_auto_tim”
;

1731 
	$usb_ho¡_auto_sÿn
(*
İaque
, 
bus_num
,

1732 
addr
, cÚ¡ *
pÜt
,

1733 
şass_id
, 
v’dÜ_id
, 
´oduù_id
,

1734 cÚ¡ *
´oduù_Çme
, 
¥“d
)

1736 
USBAutoF‹r
 *
f
;

1737 
USBHo¡Deviû
 *
s
;

1740 ià(
şass_id
 == 9)

1743 
	`QTAILQ_FOREACH
(
s
, &
ho¡devs
, 
Ãxt
) {

1744 
f
 = &
s
->
m©ch
;

1746 ià(
f
->
bus_num
 > 0 && f->bus_num != bus_num) {

1749 ià(
f
->
addr
 > 0 && f->addr !=‡ddr) {

1752 ià(
f
->
pÜt
 !ğ
NULL
 && (pÜˆ=ğNULL || 
	`¡rcmp
(f->port,…ort) != 0)) {

1756 ià(
f
->
v’dÜ_id
 > 0 && f->vendor_id != vendor_id) {

1760 ià(
f
->
´oduù_id
 > 0 && f->product_id !=…roduct_id) {

1764 
s
->
£’
++;

1765 ià(
s
->
”rcouÁ
 >= 3) {

1770 ià(
s
->
fd
 != -1) {

1773 
	`DPRINTF
("husb:‡utØİ’: bus_num %d‡dd¸%d\n", 
bus_num
, 
addr
);

1775 ià(
	`usb_ho¡_İ’
(
s
, 
bus_num
, 
addr
, 
pÜt
, 
´oduù_Çme
, 
¥“d
) < 0) {

1776 
s
->
”rcouÁ
++;

1782 
	}
}

1784 
	$usb_ho¡_auto_check
(*
unu£d
)

1786 
USBHo¡Deviû
 *
s
;

1787 
uncÚÃùed
 = 0;

1789 ià(
	`run¡©e_is_ruÂšg
()) {

1790 
	`usb_ho¡_sÿn
(
NULL
, 
usb_ho¡_auto_sÿn
);

1792 
	`QTAILQ_FOREACH
(
s
, &
ho¡devs
, 
Ãxt
) {

1793 ià(
s
->
fd
 == -1) {

1794 
uncÚÃùed
++;

1796 ià(
s
->
£’
 == 0) {

1797 
s
->
”rcouÁ
 = 0;

1799 
s
->
£’
 = 0;

1802 ià(
uncÚÃùed
 == 0) {

1804 ià(
usb_auto_tim”
) {

1805 
	`qemu_d–_tim”
(
usb_auto_tim”
);

1806 
	`Œaû_usb_ho¡_auto_sÿn_di§bËd
();

1812 ià(!
usb_auto_tim”
) {

1813 
usb_auto_tim”
 = 
	`qemu_Ãw_tim”_ms
(
¹_şock
, 
usb_ho¡_auto_check
, 
NULL
);

1814 ià(!
usb_auto_tim”
) {

1817 
	`Œaû_usb_ho¡_auto_sÿn_’abËd
();

1819 
	`qemu_mod_tim”
(
usb_auto_tim”
, 
	`qemu_g‘_şock_ms
(
¹_şock
) + 2000);

1820 
	}
}

1835 
	$·r£_f‹r
(cÚ¡ *
¥ec
, 
USBAutoF‹r
 *
f
)

1837 ’um { 
BUS
, 
DEV
, 
VID
, 
PID
, 
DONE
 };

1838 cÚ¡ *
p
 = 
¥ec
;

1839 
i
;

1841 
f
->
bus_num
 = 0;

1842 
f
->
addr
 = 0;

1843 
f
->
v’dÜ_id
 = 0;

1844 
f
->
´oduù_id
 = 0;

1846 
i
 = 
BUS
; i < 
DONE
; i++) {

1847 
p
 = 
	`¡½brk
(p, ":.");

1848 ià(!
p
) {

1851 
p
++;

1853 ià(*
p
 == '*') {

1856 
i
) {

1857 
BUS
: 
f
->
bus_num
 = 
	`¡¹Ş
(
p
, 
NULL
, 10); ;

1858 
DEV
: 
f
->
addr
 = 
	`¡¹Ş
(
p
, 
NULL
, 10); ;

1859 
VID
: 
f
->
v’dÜ_id
 = 
	`¡¹Ş
(
p
, 
NULL
, 16); ;

1860 
PID
: 
f
->
´oduù_id
 = 
	`¡¹Ş
(
p
, 
NULL
, 16); ;

1864 ià(
i
 < 
DEV
) {

1865 
	`årštf
(
¡d”r
, "husb: inv®id‡utØf‹¸¥eø%s\n", 
¥ec
);

1870 
	}
}

1875 
	susb_şass_šfo
 {

1876 
	mşass
;

1877 cÚ¡ *
	mşass_Çme
;

1880 cÚ¡ 
usb_şass_šfo
 
	gusb_şass_šfo
[] = {

1881 { 
USB_CLASS_AUDIO
, "Audio"},

1882 { 
USB_CLASS_COMM
, "Communication"},

1883 { 
USB_CLASS_HID
, "HID"},

1884 { 
USB_CLASS_HUB
, "Hub" },

1885 { 
USB_CLASS_PHYSICAL
, "Physical" },

1886 { 
USB_CLASS_PRINTER
, "Printer" },

1887 { 
USB_CLASS_MASS_STORAGE
, "Storage" },

1888 { 
USB_CLASS_CDC_DATA
, "Data" },

1889 { 
USB_CLASS_APP_SPEC
, "Application Specific" },

1890 { 
USB_CLASS_VENDOR_SPEC
, "Vendor Specific" },

1891 { 
USB_CLASS_STILL_IMAGE
, "Still Image" },

1892 { 
USB_CLASS_CSCID
, "Smart Card" },

1893 { 
USB_CLASS_CONTENT_SEC
, "Content Security" },

1894 { -1, 
NULL
 }

1897 cÚ¡ *
	$usb_şass_¡r
(
ušt8_t
 
şass
)

1899 cÚ¡ 
usb_şass_šfo
 *
p
;

1900 
p
 = 
usb_şass_šfo
;…->
şass
 != -1;…++) {

1901 ià(
p
->
şass
 == class) {

1905  
p
->
şass_Çme
;

1906 
	}
}

1908 
	$usb_šfo_deviû
(
MÚ™Ü
 *
mÚ
, 
bus_num
,

1909 
addr
, cÚ¡ *
pÜt
,

1910 
şass_id
, 
v’dÜ_id
, 
´oduù_id
,

1911 cÚ¡ *
´oduù_Çme
,

1912 
¥“d
)

1914 cÚ¡ *
şass_¡r
, *
¥“d_¡r
;

1916 
¥“d
) {

1917 
USB_SPEED_LOW
:

1918 
¥“d_¡r
 = "1.5";

1920 
USB_SPEED_FULL
:

1921 
¥“d_¡r
 = "12";

1923 
USB_SPEED_HIGH
:

1924 
¥“d_¡r
 = "480";

1926 
USB_SPEED_SUPER
:

1927 
¥“d_¡r
 = "5000";

1930 
¥“d_¡r
 = "?";

1934 
	`mÚ™Ü_´štf
(
mÚ
, " Bus %d, Addr %d, Port %s, Speed %s Mb/s\n",

1935 
bus_num
, 
addr
, 
pÜt
, 
¥“d_¡r
);

1936 
şass_¡r
 = 
	`usb_şass_¡r
(
şass_id
);

1937 ià(
şass_¡r
) {

1938 
	`mÚ™Ü_´štf
(
mÚ
, " %s:", 
şass_¡r
);

1940 
	`mÚ™Ü_´štf
(
mÚ
, " CÏs %02x:", 
şass_id
);

1942 
	`mÚ™Ü_´štf
(
mÚ
, " USB deviû %04x:%04x", 
v’dÜ_id
, 
´oduù_id
);

1943 ià(
´oduù_Çme
[0] != '\0') {

1944 
	`mÚ™Ü_´štf
(
mÚ
, ", %s", 
´oduù_Çme
);

1946 
	`mÚ™Ü_´štf
(
mÚ
, "\n");

1947 
	}
}

1949 
	$usb_ho¡_šfo_deviû
(*
İaque
, 
bus_num
, 
addr
,

1950 cÚ¡ *
·th
, 
şass_id
,

1951 
v’dÜ_id
, 
´oduù_id
,

1952 cÚ¡ *
´oduù_Çme
,

1953 
¥“d
)

1955 
MÚ™Ü
 *
mÚ
 = 
İaque
;

1957 
	`usb_šfo_deviû
(
mÚ
, 
bus_num
, 
addr
, 
·th
, 
şass_id
, 
v’dÜ_id
, 
´oduù_id
,

1958 
´oduù_Çme
, 
¥“d
);

1960 
	}
}

1962 
	$dec2¡r
(
v®
, *
¡r
, 
size_t
 
size
)

1964 ià(
v®
 == 0) {

1965 
	`¢´štf
(
¡r
, 
size
, "*");

1967 
	`¢´štf
(
¡r
, 
size
, "%d", 
v®
);

1969 
	}
}

1971 
	$hex2¡r
(
v®
, *
¡r
, 
size_t
 
size
)

1973 ià(
v®
 == 0) {

1974 
	`¢´štf
(
¡r
, 
size
, "*");

1976 
	`¢´štf
(
¡r
, 
size
, "%04x", 
v®
);

1978 
	}
}

1980 
	$usb_ho¡_šfo
(
MÚ™Ü
 *
mÚ
)

1982 
USBAutoF‹r
 *
f
;

1983 
USBHo¡Deviû
 *
s
;

1985 
	`usb_ho¡_sÿn
(
mÚ
, 
usb_ho¡_šfo_deviû
);

1987 ià(
	`QTAILQ_EMPTY
(&
ho¡devs
)) {

1991 
	`mÚ™Ü_´štf
(
mÚ
, " Auto filters:\n");

1992 
	`QTAILQ_FOREACH
(
s
, &
ho¡devs
, 
Ãxt
) {

1993 
bus
[10], 
addr
[10], 
vid
[10], 
pid
[10];

1994 
f
 = &
s
->
m©ch
;

1995 
	`dec2¡r
(
f
->
bus_num
, 
bus
, (bus));

1996 
	`dec2¡r
(
f
->
addr
,‡ddr, (addr));

1997 
	`hex2¡r
(
f
->
v’dÜ_id
, 
vid
, (vid));

1998 
	`hex2¡r
(
f
->
´oduù_id
, 
pid
, (pid));

1999 
	`mÚ™Ü_´štf
(
mÚ
, " Bus %s, Addr %s, Port %s, ID %s:%s\n",

2000 
bus
, 
addr
, 
f
->
pÜt
 ? f->pÜˆ: "*", 
vid
, 
pid
);

2002 
	}
}

	@host-stub.c

33 
	~"qemu-commÚ.h
"

34 
	~"cÚsŞe.h
"

35 
	~"hw/usb.h
"

36 
	~"mÚ™Ü.h
"

38 
	$usb_ho¡_šfo
(
MÚ™Ü
 *
mÚ
)

40 
	`mÚ™Ü_´štf
(
mÚ
, "USB host devices‚ot supported\n");

41 
	}
}

44 
USBDeviû
 *
	$usb_ho¡_deviû_İ’
(
USBBus
 *
bus
, cÚ¡ *
devÇme
)

46  
NULL
;

47 
	}
}

49 
	$usb_ho¡_deviû_şo£
(cÚ¡ *
devÇme
)

52 
	}
}

	@libhw.c

22 
	~"qemu-commÚ.h
"

23 
	~"ıu-commÚ.h
"

24 
	~"hw/usb.h
"

25 
	~"dma.h
"

27 
	$usb_·ck‘_m­
(
USBPack‘
 *
p
, 
QEMUSGLi¡
 *
sgl
)

29 
DMADœeùiÚ
 
dœ
 = (
p
->
pid
 =ğ
USB_TOKEN_IN
) ?

30 
DMA_DIRECTION_FROM_DEVICE
 : 
DMA_DIRECTION_TO_DEVICE
;

31 
dma_addr_t
 
Ën
;

32 *
mem
;

33 
i
;

35 
i
 = 0; i < 
sgl
->
nsg
; i++) {

36 
Ën
 = 
sgl
->
sg
[
i
].len;

37 
mem
 = 
	`dma_memÜy_m­
(
sgl
->
dma
, sgl->
sg
[
i
].
ba£
, &
Ën
, 
dœ
);

38 ià(!
mem
) {

39 
”r
;

41 
	`qemu_iovec_add
(&
p
->
iov
, 
mem
, 
Ën
);

42 ià(
Ën
 !ğ
sgl
->
sg
[
i
].len) {

43 
”r
;

48 
”r
:

49 
	`usb_·ck‘_unm­
(
p
, 
sgl
);

51 
	}
}

53 
	$usb_·ck‘_unm­
(
USBPack‘
 *
p
, 
QEMUSGLi¡
 *
sgl
)

55 
DMADœeùiÚ
 
dœ
 = (
p
->
pid
 =ğ
USB_TOKEN_IN
) ?

56 
DMA_DIRECTION_FROM_DEVICE
 : 
DMA_DIRECTION_TO_DEVICE
;

57 
i
;

59 
i
 = 0; i < 
p
->
iov
.
niov
; i++) {

60 
	`dma_memÜy_unm­
(
sgl
->
dma
, 
p
->
iov
.iov[
i
].
iov_ba£
,

61 
p
->
iov
.iov[
i
].
iov_Ën
, 
dœ
,

62 
p
->
iov
.iov[
i
].
iov_Ën
);

64 
	}
}

	@redirect.c

28 
	~"qemu-commÚ.h
"

29 
	~"qemu-tim”.h
"

30 
	~"mÚ™Ü.h
"

31 
	~"sy£mu.h
"

33 
	~<dœ’t.h
>

34 
	~<sys/ioùl.h
>

35 
	~<sigÇl.h
>

36 
	~<usb»dœ·r£r.h
>

37 
	~<usb»dœf‹r.h
>

39 
	~"hw/usb.h
"

41 
	#MAX_ENDPOINTS
 32

	)

42 
	#NO_INTERFACE_INFO
 255

	)

43 
	#EP2I
(
•_add»ss
è((Óp_add»s & 0x80è>> 3è| (•_add»s & 0x0f))

	)

44 
	#I2EP
(
i
è(((˜& 0x10è<< 3è| (˜& 0x0f))

	)

46 
AsyncURB
 
	tAsyncURB
;

47 
USBRedœDeviû
 
	tUSBRedœDeviû
;

50 
	sbuf_·ck‘
 {

51 
ušt8_t
 *
	md©a
;

52 
	mËn
;

53 
	m¡©us
;

54 
QTAILQ_ENTRY
(
buf_·ck‘
)
	mÃxt
;

57 
	s’dp_d©a
 {

58 
ušt8_t
 
	mty³
;

59 
ušt8_t
 
	mš‹rv®
;

60 
ušt8_t
 
	mš‹rçû
;

61 
ušt8_t
 
	miso_¡¬‹d
;

62 
ušt8_t
 
	miso_”rÜ
;

63 
ušt8_t
 
	mš‹¼u±_¡¬‹d
;

64 
ušt8_t
 
	mš‹¼u±_”rÜ
;

65 
ušt8_t
 
	mbuåq_´efËd
;

66 
ušt8_t
 
	mbuåq_drİpšg_·ck‘s
;

67 
QTAILQ_HEAD
(, 
buf_·ck‘
è
	mbuåq
;

68 
	mbuåq_size
;

69 
	mbuåq_rg‘_size
;

72 
	sUSBRedœDeviû
 {

73 
USBDeviû
 
	mdev
;

75 
Ch¬Driv”S‹
 *
	mcs
;

76 
ušt8_t
 
	mdebug
;

77 *
	mf‹r_¡r
;

78 
št32_t
 
	mboÙšdex
;

80 cÚ¡ 
ušt8_t
 *
	m»ad_buf
;

81 
	m»ad_buf_size
;

83 
QEMUBH
 *
	mİ’_şo£_bh
;

85 
QEMUTim”
 *
	m©ch_tim”
;

86 
št64_t
 
	mÃxt_©ch_time
;

87 
usb»dœ·r£r
 *
	m·r£r
;

88 
’dp_d©a
 
	m’dpošt
[
MAX_ENDPOINTS
];

89 
ušt32_t
 
	m·ck‘_id
;

90 
QTAILQ_HEAD
(, 
AsyncURB
è
	masyncq
;

92 
usb_»dœ_deviû_cÚÃù_h—d”
 
	mdeviû_šfo
;

93 
usb_»dœ_š‹rçû_šfo_h—d”
 
	mš‹rçû_šfo
;

94 
usb»dœf‹r_ruË
 *
	mf‹r_ruËs
;

95 
	mf‹r_ruËs_couÁ
;

98 
	sAsyncURB
 {

99 
USBRedœDeviû
 *
	mdev
;

100 
USBPack‘
 *
	m·ck‘
;

101 
ušt32_t
 
	m·ck‘_id
;

102 
	mg‘
;

104 
usb_»dœ_cÚŒŞ_·ck‘_h—d”
 
	mcÚŒŞ_·ck‘
;

105 
usb_»dœ_bulk_·ck‘_h—d”
 
	mbulk_·ck‘
;

106 
usb_»dœ_š‹¼u±_·ck‘_h—d”
 
	mš‹¼u±_·ck‘
;

108 
QTAILQ_ENTRY
(
AsyncURB
)
	mÃxt
;

111 
usb»dœ_h–lo
(*
´iv
, 
usb_»dœ_h–lo_h—d”
 *
h
);

112 
usb»dœ_deviû_cÚÃù
(*
´iv
,

113 
usb_»dœ_deviû_cÚÃù_h—d”
 *
deviû_cÚÃù
);

114 
usb»dœ_deviû_discÚÃù
(*
´iv
);

115 
usb»dœ_š‹rçû_šfo
(*
´iv
,

116 
usb_»dœ_š‹rçû_šfo_h—d”
 *
š‹rçû_šfo
);

117 
usb»dœ_•_šfo
(*
´iv
,

118 
usb_»dœ_•_šfo_h—d”
 *
•_šfo
);

119 
usb»dœ_cÚfigu¿tiÚ_¡©us
(*
´iv
, 
ušt32_t
 
id
,

120 
usb_»dœ_cÚfigu¿tiÚ_¡©us_h—d”
 *
cÚfigu¿tiÚ_¡©us
);

121 
usb»dœ_®t_£‰šg_¡©us
(*
´iv
, 
ušt32_t
 
id
,

122 
usb_»dœ_®t_£‰šg_¡©us_h—d”
 *
®t_£‰šg_¡©us
);

123 
usb»dœ_iso_¡»am_¡©us
(*
´iv
, 
ušt32_t
 
id
,

124 
usb_»dœ_iso_¡»am_¡©us_h—d”
 *
iso_¡»am_¡©us
);

125 
usb»dœ_š‹¼u±_»ûivšg_¡©us
(*
´iv
, 
ušt32_t
 
id
,

126 
usb_»dœ_š‹¼u±_»ûivšg_¡©us_h—d”


127 *
š‹¼u±_»ûivšg_¡©us
);

128 
usb»dœ_bulk_¡»ams_¡©us
(*
´iv
, 
ušt32_t
 
id
,

129 
usb_»dœ_bulk_¡»ams_¡©us_h—d”
 *
bulk_¡»ams_¡©us
);

130 
usb»dœ_cÚŒŞ_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

131 
usb_»dœ_cÚŒŞ_·ck‘_h—d”
 *
cÚŒŞ_·ck‘
,

132 
ušt8_t
 *
d©a
, 
d©a_Ën
);

133 
usb»dœ_bulk_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

134 
usb_»dœ_bulk_·ck‘_h—d”
 *
bulk_·ck‘
,

135 
ušt8_t
 *
d©a
, 
d©a_Ën
);

136 
usb»dœ_iso_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

137 
usb_»dœ_iso_·ck‘_h—d”
 *
iso_·ck‘
,

138 
ušt8_t
 *
d©a
, 
d©a_Ën
);

139 
usb»dœ_š‹¼u±_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

140 
usb_»dœ_š‹¼u±_·ck‘_h—d”
 *
š‹¼u±_h—d”
,

141 
ušt8_t
 *
d©a
, 
d©a_Ën
);

143 
usb»dœ_hªdË_¡©us
(
USBRedœDeviû
 *
dev
,

144 
¡©us
, 
aùu®_Ën
);

150 
	#ERROR
(...) \

152 ià(
dev
->
debug
 >ğ
usb»dœ·r£r_”rÜ
) { \

153 
	`”rÜ_»pÜt
("usb-»dœƒ¼Ü: " 
__VA_ARGS__
); \

155 } 0)

	)

156 
	#WARNING
(...) \

158 ià(
dev
->
debug
 >ğ
usb»dœ·r£r_w¬nšg
) { \

159 
	`”rÜ_»pÜt
("usb-»dœ w¬nšg: " 
__VA_ARGS__
); \

161 } 0)

	)

162 
	#INFO
(...) \

164 ià(
dev
->
debug
 >ğ
usb»dœ·r£r_šfo
) { \

165 
	`”rÜ_»pÜt
("usb-»dœ: " 
__VA_ARGS__
); \

167 } 0)

	)

168 
	#DPRINTF
(...) \

170 ià(
dev
->
debug
 >ğ
usb»dœ·r£r_debug
) { \

171 
	`”rÜ_»pÜt
("usb-»dœ: " 
__VA_ARGS__
); \

173 } 0)

	)

174 
	#DPRINTF2
(...) \

176 ià(
dev
->
debug
 >ğ
usb»dœ·r£r_debug_d©a
) { \

177 
	`”rÜ_»pÜt
("usb-»dœ: " 
__VA_ARGS__
); \

179 } 0)

	)

181 
	$usb»dœ_log
(*
´iv
, 
Ëv–
, cÚ¡ *
msg
)

183 
USBRedœDeviû
 *
dev
 = 
´iv
;

185 ià(
dev
->
debug
 < 
Ëv–
) {

189 
	`”rÜ_»pÜt
("%s", 
msg
);

190 
	}
}

192 
	$usb»dœ_log_d©a
(
USBRedœDeviû
 *
dev
, cÚ¡ *
desc
,

193 cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

195 
i
, 
j
, 
n
;

197 ià(
dev
->
debug
 < 
usb»dœ·r£r_debug_d©a
) {

201 
i
 = 0; i < 
Ën
; i +ğ
j
) {

202 
buf
[128];

204 
n
 = 
	`¥rštf
(
buf
, "%s", 
desc
);

205 
j
 = 0; j < 8 && 
i
 + j < 
Ën
; j++) {

206 
n
 +ğ
	`¥rštf
(
buf
 +‚, " %02X", 
d©a
[
i
 + 
j
]);

208 
	`”rÜ_»pÜt
("%s", 
buf
);

210 
	}
}

216 
	$usb»dœ_»ad
(*
´iv
, 
ušt8_t
 *
d©a
, 
couÁ
)

218 
USBRedœDeviû
 *
dev
 = 
´iv
;

220 ià(
dev
->
»ad_buf_size
 < 
couÁ
) {

221 
couÁ
 = 
dev
->
»ad_buf_size
;

224 
	`memıy
(
d©a
, 
dev
->
»ad_buf
, 
couÁ
);

226 
dev
->
»ad_buf_size
 -ğ
couÁ
;

227 ià(
dev
->
»ad_buf_size
) {

228 
dev
->
»ad_buf
 +ğ
couÁ
;

230 
dev
->
»ad_buf
 = 
NULL
;

233  
couÁ
;

234 
	}
}

236 
	$usb»dœ_wr™e
(*
´iv
, 
ušt8_t
 *
d©a
, 
couÁ
)

238 
USBRedœDeviû
 *
dev
 = 
´iv
;

240 ià(!
dev
->
cs
->
İ’ed
) {

244  
	`qemu_chr_ã_wr™e
(
dev
->
cs
, 
d©a
, 
couÁ
);

245 
	}
}

251 
AsyncURB
 *
	$async_®loc
(
USBRedœDeviû
 *
dev
, 
USBPack‘
 *
p
)

253 
AsyncURB
 *
aurb
 = (AsyncURB *è
	`g_m®loc0
((AsyncURB));

254 
aurb
->
dev
 = dev;

255 
aurb
->
·ck‘
 = 
p
;

256 
aurb
->
·ck‘_id
 = 
dev
->packet_id;

257 
	`QTAILQ_INSERT_TAIL
(&
dev
->
asyncq
, 
aurb
, 
Ãxt
);

258 
dev
->
·ck‘_id
++;

260  
aurb
;

261 
	}
}

263 
	$async_ä“
(
USBRedœDeviû
 *
dev
, 
AsyncURB
 *
aurb
)

265 
	`QTAILQ_REMOVE
(&
dev
->
asyncq
, 
aurb
, 
Ãxt
);

266 
	`g_ä“
(
aurb
);

267 
	}
}

269 
AsyncURB
 *
	$async_fšd
(
USBRedœDeviû
 *
dev
, 
ušt32_t
 
·ck‘_id
)

271 
AsyncURB
 *
aurb
;

273 
	`QTAILQ_FOREACH
(
aurb
, &
dev
->
asyncq
, 
Ãxt
) {

274 ià(
aurb
->
·ck‘_id
 ==…acket_id) {

275  
aurb
;

278 
	`DPRINTF
("could‚Ù fšd‡synøurb fÜ…ack‘_id %u\n", 
·ck‘_id
);

279  
NULL
;

280 
	}
}

282 
	$usb»dœ_ÿnûl_·ck‘
(
USBDeviû
 *
udev
, 
USBPack‘
 *
p
)

284 
USBRedœDeviû
 *
dev
 = 
	`DO_UPCAST
(USBRedœDeviû, dev, 
udev
);

285 
AsyncURB
 *
aurb
;

287 
	`QTAILQ_FOREACH
(
aurb
, &
dev
->
asyncq
, 
Ãxt
) {

288 ià(
p
 !ğ
aurb
->
·ck‘
) {

292 
	`DPRINTF
("asynøÿnûÈid %u\n", 
aurb
->
·ck‘_id
);

293 
	`usb»dœ·r£r_£nd_ÿnûl_d©a_·ck‘
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
);

294 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

297 
aurb
->
·ck‘
 = 
NULL
;

300 
	}
}

302 
	$buå_®loc
(
USBRedœDeviû
 *
dev
,

303 
ušt8_t
 *
d©a
, 
Ën
, 
¡©us
, ušt8_ˆ
•
)

305 
buf_·ck‘
 *
buå
;

307 ià(!
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_drİpšg_·ck‘s
 &&

308 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_size
 >

309 2 * 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_rg‘_size
) {

310 
	`DPRINTF
("buåq ov”æow, drİpšg…ack‘ • %02X\n", 
•
);

311 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_drİpšg_·ck‘s
 = 1;

315 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_drİpšg_·ck‘s
) {

316 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_size
 >

317 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_rg‘_size
) {

318 
	`ä“
(
d©a
);

321 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_drİpšg_·ck‘s
 = 0;

324 
buå
 = 
	`g_m®loc
((
buf_·ck‘
));

325 
buå
->
d©a
 = data;

326 
buå
->
Ën
 =†en;

327 
buå
->
¡©us
 = status;

328 
	`QTAILQ_INSERT_TAIL
(&
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq
, 
buå
, 
Ãxt
);

329 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_size
++;

330 
	}
}

332 
	$buå_ä“
(
USBRedœDeviû
 *
dev
, 
buf_·ck‘
 *
buå
,

333 
ušt8_t
 
•
)

335 
	`QTAILQ_REMOVE
(&
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq
, 
buå
, 
Ãxt
);

336 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_size
--;

337 
	`ä“
(
buå
->
d©a
);

338 
	`g_ä“
(
buå
);

339 
	}
}

341 
	$usb»dœ_ä“_buåq
(
USBRedœDeviû
 *
dev
, 
ušt8_t
 
•
)

343 
buf_·ck‘
 *
buf
, *
buf_Ãxt
;

345 
	`QTAILQ_FOREACH_SAFE
(
buf
, &
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq
, 
Ãxt
, 
buf_Ãxt
) {

346 
	`buå_ä“
(
dev
, 
buf
, 
•
);

348 
	}
}

354 
	$usb»dœ_hªdË_»£t
(
USBDeviû
 *
udev
)

356 
USBRedœDeviû
 *
dev
 = 
	`DO_UPCAST
(USBRedœDeviû, dev, 
udev
);

358 
	`DPRINTF
("reset device\n");

359 
	`usb»dœ·r£r_£nd_»£t
(
dev
->
·r£r
);

360 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

361 
	}
}

363 
	$usb»dœ_hªdË_iso_d©a
(
USBRedœDeviû
 *
dev
, 
USBPack‘
 *
p
,

364 
ušt8_t
 
•
)

366 
¡©us
, 
Ën
;

367 ià(!
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
 &&

368 !
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_”rÜ
) {

369 
usb_»dœ_¡¬t_iso_¡»am_h—d”
 
¡¬t_iso
 = {

370 .
’dpošt
 = 
•
,

372 
pkts_³r_£c
;

374 ià(
dev
->dev.
¥“d
 =ğ
USB_SPEED_HIGH
) {

375 
pkts_³r_£c
 = 8000 / 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹rv®
;

377 
pkts_³r_£c
 = 1000 / 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹rv®
;

380 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_rg‘_size
 = (
pkts_³r_£c
 * 60) / 1000;

384 
¡¬t_iso
.
pkts_³r_urb
 = 
pkts_³r_£c
 / 100;

385 ià(
¡¬t_iso
.
pkts_³r_urb
 < 1) {

386 
¡¬t_iso
.
pkts_³r_urb
 = 1;

387 } ià(
¡¬t_iso
.
pkts_³r_urb
 > 32) {

388 
¡¬t_iso
.
pkts_³r_urb
 = 32;

391 
¡¬t_iso
.
no_urbs
 = (
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_rg‘_size
 +

392 
¡¬t_iso
.
pkts_³r_urb
 - 1) /

393 
¡¬t_iso
.
pkts_³r_urb
;

396 ià(!(
•
 & 
USB_DIR_IN
)) {

397 
¡¬t_iso
.
no_urbs
 *= 2;

399 ià(
¡¬t_iso
.
no_urbs
 > 16) {

400 
¡¬t_iso
.
no_urbs
 = 16;

404 
	`usb»dœ·r£r_£nd_¡¬t_iso_¡»am
(
dev
->
·r£r
, 0, &
¡¬t_iso
);

405 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

406 
	`DPRINTF
("iso stream started…kts/sec %d…kts/urb %d urbs %dƒp %02X\n",

407 
pkts_³r_£c
, 
¡¬t_iso
.
pkts_³r_urb
, s¹_iso.
no_urbs
, 
•
);

408 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
 = 1;

409 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_´efËd
 = 0;

410 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_drİpšg_·ck‘s
 = 0;

413 ià(
•
 & 
USB_DIR_IN
) {

414 
buf_·ck‘
 *
isİ
;

416 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
 &&

417 !
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_´efËd
) {

418 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_size
 <

419 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_rg‘_size
) {

420  
	`usb»dœ_hªdË_¡©us
(
dev
, 0, 0);

422 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_´efËd
 = 1;

425 
isİ
 = 
	`QTAILQ_FIRST
(&
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq
);

426 ià(
isİ
 =ğ
NULL
) {

427 
	`DPRINTF
("iso-token-inƒp %02X,‚o isop, iso_error: %d\n",

428 
•
, 
dev
->
’dpošt
[
	`EP2I
Óp)].
iso_”rÜ
);

430 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_´efËd
 = 0;

432 
¡©us
 = 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_”rÜ
;

433 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_”rÜ
 = 0;

434  
¡©us
 ? 
USB_RET_IOERROR
 : 0;

436 
	`DPRINTF2
("iso-tok’-šƒ°%02X stu %d†’ %d queue-size: %d\n", 
•
,

437 
isİ
->
¡©us
, isİ->
Ën
, 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_size
);

439 
¡©us
 = 
isİ
->status;

440 ià(
¡©us
 !ğ
usb_»dœ_sucûss
) {

441 
	`buå_ä“
(
dev
, 
isİ
, 
•
);

442  
USB_RET_IOERROR
;

445 
Ën
 = 
isİ
->len;

446 ià(
Ën
 > 
p
->
iov
.
size
) {

447 
	`ERROR
("received iso data is†argerhen…acketƒp %02X (%d > %d)\n",

448 
•
, 
Ën
, ()
p
->
iov
.
size
);

449 
	`buå_ä“
(
dev
, 
isİ
, 
•
);

450  
USB_RET_BABBLE
;

452 
	`usb_·ck‘_cİy
(
p
, 
isİ
->
d©a
, 
Ën
);

453 
	`buå_ä“
(
dev
, 
isİ
, 
•
);

454  
Ën
;

458 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
) {

459 
usb_»dœ_iso_·ck‘_h—d”
 
iso_·ck‘
 = {

460 .
’dpošt
 = 
•
,

461 .
Ëngth
 = 
p
->
iov
.
size


463 
ušt8_t
 
buf
[
p
->
iov
.
size
];

465 
	`usb_·ck‘_cİy
(
p
, 
buf
,…->
iov
.
size
);

466 
	`usb»dœ·r£r_£nd_iso_·ck‘
(
dev
->
·r£r
, 0, &
iso_·ck‘
,

467 
buf
, 
p
->
iov
.
size
);

468 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

470 
¡©us
 = 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_”rÜ
;

471 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_”rÜ
 = 0;

472 
	`DPRINTF2
("iso-tok’-ouˆ• %02X stu %d†’ %zd\n", 
•
, 
¡©us
,

473 
p
->
iov
.
size
);

474  
	`usb»dœ_hªdË_¡©us
(
dev
, 
¡©us
, 
p
->
iov
.
size
);

476 
	}
}

478 
	$usb»dœ_¡İ_iso_¡»am
(
USBRedœDeviû
 *
dev
, 
ušt8_t
 
•
)

480 
usb_»dœ_¡İ_iso_¡»am_h—d”
 
¡İ_iso_¡»am
 = {

481 .
’dpošt
 = 
•


483 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
) {

484 
	`usb»dœ·r£r_£nd_¡İ_iso_¡»am
(
dev
->
·r£r
, 0, &
¡İ_iso_¡»am
);

485 
	`DPRINTF
("isØ¡»am stİ³dƒ°%02X\n", 
•
);

486 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
 = 0;

488 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_”rÜ
 = 0;

489 
	`usb»dœ_ä“_buåq
(
dev
, 
•
);

490 
	}
}

492 
	$usb»dœ_hªdË_bulk_d©a
(
USBRedœDeviû
 *
dev
, 
USBPack‘
 *
p
,

493 
ušt8_t
 
•
)

495 
AsyncURB
 *
aurb
 = 
	`async_®loc
(
dev
, 
p
);

496 
usb_»dœ_bulk_·ck‘_h—d”
 
bulk_·ck‘
;

498 
	`DPRINTF
("bulk-ouˆ• %02X†’ %zd id %u\n", 
•
,

499 
p
->
iov
.
size
, 
aurb
->
·ck‘_id
);

501 
bulk_·ck‘
.
’dpošt
 = 
•
;

502 
bulk_·ck‘
.
Ëngth
 = 
p
->
iov
.
size
;

503 
bulk_·ck‘
.
¡»am_id
 = 0;

504 
aurb
->
bulk_·ck‘
 = bulk_packet;

506 ià(
•
 & 
USB_DIR_IN
) {

507 
	`usb»dœ·r£r_£nd_bulk_·ck‘
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

508 &
bulk_·ck‘
, 
NULL
, 0);

510 
ušt8_t
 
buf
[
p
->
iov
.
size
];

511 
	`usb_·ck‘_cİy
(
p
, 
buf
,…->
iov
.
size
);

512 
	`usb»dœ_log_d©a
(
dev
, "bulk d©¨out:", 
buf
, 
p
->
iov
.
size
);

513 
	`usb»dœ·r£r_£nd_bulk_·ck‘
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

514 &
bulk_·ck‘
, 
buf
, 
p
->
iov
.
size
);

516 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

517  
USB_RET_ASYNC
;

518 
	}
}

520 
	$usb»dœ_hªdË_š‹¼u±_d©a
(
USBRedœDeviû
 *
dev
,

521 
USBPack‘
 *
p
, 
ušt8_t
 
•
)

523 ià(
•
 & 
USB_DIR_IN
) {

525 
buf_·ck‘
 *
š
;

526 
¡©us
, 
Ën
;

528 ià(!
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_¡¬‹d
 &&

529 !
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_”rÜ
) {

530 
usb_»dœ_¡¬t_š‹¼u±_»ûivšg_h—d”
 
¡¬t_št
 = {

531 .
’dpošt
 = 
•
,

534 
	`usb»dœ·r£r_£nd_¡¬t_š‹¼u±_»ûivšg
(
dev
->
·r£r
, 0,

535 &
¡¬t_št
);

536 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

537 
	`DPRINTF
("š‹¼u±„ecv s¹edƒ°%02X\n", 
•
);

538 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_¡¬‹d
 = 1;

541 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_rg‘_size
 = 1000;

542 
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq_drİpšg_·ck‘s
 = 0;

545 
š
 = 
	`QTAILQ_FIRST
(&
dev
->
’dpošt
[
	`EP2I
(
•
)].
buåq
);

546 ià(
š
 =ğ
NULL
) {

547 
	`DPRINTF2
("š‹¼u±-tok’-šƒ°%02X,‚Øš\n", 
•
);

549 
¡©us
 = 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_”rÜ
;

550 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_”rÜ
 = 0;

551 ià(
¡©us
) {

552  
	`usb»dœ_hªdË_¡©us
(
dev
, 
¡©us
, 0);

554  
USB_RET_NAK
;

556 
	`DPRINTF
("š‹¼u±-tok’-šƒ°%02X stu %d†’ %d\n", 
•
,

557 
š
->
¡©us
, iÁp->
Ën
);

559 
¡©us
 = 
š
->status;

560 ià(
¡©us
 !ğ
usb_»dœ_sucûss
) {

561 
	`buå_ä“
(
dev
, 
š
, 
•
);

562  
	`usb»dœ_hªdË_¡©us
(
dev
, 
¡©us
, 0);

565 
Ën
 = 
š
->len;

566 ià(
Ën
 > 
p
->
iov
.
size
) {

567 
	`ERROR
("»ûived iÁ d©¨i Ïrg”h’…ack‘ƒ°%02X\n", 
•
);

568 
	`buå_ä“
(
dev
, 
š
, 
•
);

569  
USB_RET_BABBLE
;

571 
	`usb_·ck‘_cİy
(
p
, 
š
->
d©a
, 
Ën
);

572 
	`buå_ä“
(
dev
, 
š
, 
•
);

573  
Ën
;

576 
AsyncURB
 *
aurb
 = 
	`async_®loc
(
dev
, 
p
);

577 
usb_»dœ_š‹¼u±_·ck‘_h—d”
 
š‹¼u±_·ck‘
;

578 
ušt8_t
 
buf
[
p
->
iov
.
size
];

580 
	`DPRINTF
("š‹¼u±-ouˆ• %02X†’ %zd id %u\n", 
•
, 
p
->
iov
.
size
,

581 
aurb
->
·ck‘_id
);

583 
š‹¼u±_·ck‘
.
’dpošt
 = 
•
;

584 
š‹¼u±_·ck‘
.
Ëngth
 = 
p
->
iov
.
size
;

585 
aurb
->
š‹¼u±_·ck‘
 = interrupt_packet;

587 
	`usb_·ck‘_cİy
(
p
, 
buf
,…->
iov
.
size
);

588 
	`usb»dœ_log_d©a
(
dev
, "š‹¼u± d©¨out:", 
buf
, 
p
->
iov
.
size
);

589 
	`usb»dœ·r£r_£nd_š‹¼u±_·ck‘
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

590 &
š‹¼u±_·ck‘
, 
buf
, 
p
->
iov
.
size
);

591 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

592  
USB_RET_ASYNC
;

594 
	}
}

596 
	$usb»dœ_¡İ_š‹¼u±_»ûivšg
(
USBRedœDeviû
 *
dev
,

597 
ušt8_t
 
•
)

599 
usb_»dœ_¡İ_š‹¼u±_»ûivšg_h—d”
 
¡İ_š‹¼u±_»cv
 = {

600 .
’dpošt
 = 
•


602 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_¡¬‹d
) {

603 
	`usb»dœ·r£r_£nd_¡İ_š‹¼u±_»ûivšg
(
dev
->
·r£r
, 0,

604 &
¡İ_š‹¼u±_»cv
);

605 
	`DPRINTF
("š‹¼u±„ecv stİ³dƒ°%02X\n", 
•
);

606 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_¡¬‹d
 = 0;

608 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_”rÜ
 = 0;

609 
	`usb»dœ_ä“_buåq
(
dev
, 
•
);

610 
	}
}

612 
	$usb»dœ_hªdË_d©a
(
USBDeviû
 *
udev
, 
USBPack‘
 *
p
)

614 
USBRedœDeviû
 *
dev
 = 
	`DO_UPCAST
(USBRedœDeviû, dev, 
udev
);

615 
ušt8_t
 
•
;

617 
•
 = 
p
->•->
Ä
;

618 ià(
p
->
pid
 =ğ
USB_TOKEN_IN
) {

619 
•
 |ğ
USB_DIR_IN
;

622 
dev
->
’dpošt
[
	`EP2I
(
•
)].
ty³
) {

623 
USB_ENDPOINT_XFER_CONTROL
:

624 
	`ERROR
("hªdË_d©¨ÿÎed fÜ cÚŒŞ¿nsã¸Úƒ°%02X\n", 
•
);

625  
USB_RET_NAK
;

626 
USB_ENDPOINT_XFER_ISOC
:

627  
	`usb»dœ_hªdË_iso_d©a
(
dev
, 
p
, 
•
);

628 
USB_ENDPOINT_XFER_BULK
:

629  
	`usb»dœ_hªdË_bulk_d©a
(
dev
, 
p
, 
•
);

630 
USB_ENDPOINT_XFER_INT
:

631  
	`usb»dœ_hªdË_š‹¼u±_d©a
(
dev
, 
p
, 
•
);

633 
	`ERROR
("hªdË_d©¨• %02X ha unknowÀty³ %d\n", 
•
,

634 
dev
->
’dpošt
[
	`EP2I
(
•
)].
ty³
);

635  
USB_RET_NAK
;

637 
	}
}

639 
	$usb»dœ_£t_cÚfig
(
USBRedœDeviû
 *
dev
, 
USBPack‘
 *
p
,

640 
cÚfig
)

642 
usb_»dœ_£t_cÚfigu¿tiÚ_h—d”
 
£t_cÚfig
;

643 
AsyncURB
 *
aurb
 = 
	`async_®loc
(
dev
, 
p
);

644 
i
;

646 
	`DPRINTF
("£ˆcÚfig %d id %u\n", 
cÚfig
, 
aurb
->
·ck‘_id
);

648 
i
 = 0; i < 
MAX_ENDPOINTS
; i++) {

649 
dev
->
’dpošt
[
i
].
ty³
) {

650 
USB_ENDPOINT_XFER_ISOC
:

651 
	`usb»dœ_¡İ_iso_¡»am
(
dev
, 
	`I2EP
(
i
));

653 
USB_ENDPOINT_XFER_INT
:

654 ià(
i
 & 0x10) {

655 
	`usb»dœ_¡İ_š‹¼u±_»ûivšg
(
dev
, 
	`I2EP
(
i
));

659 
	`usb»dœ_ä“_buåq
(
dev
, 
	`I2EP
(
i
));

662 
£t_cÚfig
.
cÚfigu¿tiÚ
 = 
cÚfig
;

663 
	`usb»dœ·r£r_£nd_£t_cÚfigu¿tiÚ
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

664 &
£t_cÚfig
);

665 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

666  
USB_RET_ASYNC
;

667 
	}
}

669 
	$usb»dœ_g‘_cÚfig
(
USBRedœDeviû
 *
dev
, 
USBPack‘
 *
p
)

671 
AsyncURB
 *
aurb
 = 
	`async_®loc
(
dev
, 
p
);

673 
	`DPRINTF
("g‘ cÚfig id %u\n", 
aurb
->
·ck‘_id
);

675 
aurb
->
g‘
 = 1;

676 
	`usb»dœ·r£r_£nd_g‘_cÚfigu¿tiÚ
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
);

677 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

678  
USB_RET_ASYNC
;

679 
	}
}

681 
	$usb»dœ_£t_š‹rçû
(
USBRedœDeviû
 *
dev
, 
USBPack‘
 *
p
,

682 
š‹rçû
, 
®t
)

684 
usb_»dœ_£t_®t_£‰šg_h—d”
 
£t_®t
;

685 
AsyncURB
 *
aurb
 = 
	`async_®loc
(
dev
, 
p
);

686 
i
;

688 
	`DPRINTF
("£ˆš‹rçû %d‡É %d id %u\n", 
š‹rçû
, 
®t
,

689 
aurb
->
·ck‘_id
);

691 
i
 = 0; i < 
MAX_ENDPOINTS
; i++) {

692 ià(
dev
->
’dpošt
[
i
].
š‹rçû
 == interface) {

693 
dev
->
’dpošt
[
i
].
ty³
) {

694 
USB_ENDPOINT_XFER_ISOC
:

695 
	`usb»dœ_¡İ_iso_¡»am
(
dev
, 
	`I2EP
(
i
));

697 
USB_ENDPOINT_XFER_INT
:

698 ià(
i
 & 0x10) {

699 
	`usb»dœ_¡İ_š‹¼u±_»ûivšg
(
dev
, 
	`I2EP
(
i
));

703 
	`usb»dœ_ä“_buåq
(
dev
, 
	`I2EP
(
i
));

707 
£t_®t
.
š‹rçû
 = interface;

708 
£t_®t
.
®t
 =‡lt;

709 
	`usb»dœ·r£r_£nd_£t_®t_£‰šg
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

710 &
£t_®t
);

711 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

712  
USB_RET_ASYNC
;

713 
	}
}

715 
	$usb»dœ_g‘_š‹rçû
(
USBRedœDeviû
 *
dev
, 
USBPack‘
 *
p
,

716 
š‹rçû
)

718 
usb_»dœ_g‘_®t_£‰šg_h—d”
 
g‘_®t
;

719 
AsyncURB
 *
aurb
 = 
	`async_®loc
(
dev
, 
p
);

721 
	`DPRINTF
("g‘ iÁ”çû %d id %u\n", 
š‹rçû
, 
aurb
->
·ck‘_id
);

723 
g‘_®t
.
š‹rçû
 = interface;

724 
aurb
->
g‘
 = 1;

725 
	`usb»dœ·r£r_£nd_g‘_®t_£‰šg
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

726 &
g‘_®t
);

727 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

728  
USB_RET_ASYNC
;

729 
	}
}

731 
	$usb»dœ_hªdË_cÚŒŞ
(
USBDeviû
 *
udev
, 
USBPack‘
 *
p
,

732 
»que¡
, 
v®ue
, 
šdex
, 
Ëngth
, 
ušt8_t
 *
d©a
)

734 
USBRedœDeviû
 *
dev
 = 
	`DO_UPCAST
(USBRedœDeviû, dev, 
udev
);

735 
usb_»dœ_cÚŒŞ_·ck‘_h—d”
 
cÚŒŞ_·ck‘
;

736 
AsyncURB
 *
aurb
;

739 
»que¡
) {

740 
DeviûOutReque¡
 | 
USB_REQ_SET_ADDRESS
:

741 
	`DPRINTF
("£ˆadd»s %d\n", 
v®ue
);

742 
dev
->dev.
addr
 = 
v®ue
;

744 
DeviûOutReque¡
 | 
USB_REQ_SET_CONFIGURATION
:

745  
	`usb»dœ_£t_cÚfig
(
dev
, 
p
, 
v®ue
 & 0xff);

746 
DeviûReque¡
 | 
USB_REQ_GET_CONFIGURATION
:

747  
	`usb»dœ_g‘_cÚfig
(
dev
, 
p
);

748 
IÁ”çûOutReque¡
 | 
USB_REQ_SET_INTERFACE
:

749  
	`usb»dœ_£t_š‹rçû
(
dev
, 
p
, 
šdex
, 
v®ue
);

750 
IÁ”çûReque¡
 | 
USB_REQ_GET_INTERFACE
:

751  
	`usb»dœ_g‘_š‹rçû
(
dev
, 
p
, 
šdex
);

755 
aurb
 = 
	`async_®loc
(
dev
, 
p
);

758 
	`DPRINTF
("ctrl-outype 0x%x„eq 0x%x val 0x%x index %d†en %d id %u\n",

759 
»que¡
 >> 8,„eque¡ & 0xff, 
v®ue
, 
šdex
, 
Ëngth
,

760 
aurb
->
·ck‘_id
);

762 
cÚŒŞ_·ck‘
.
»que¡
 =„equest & 0xFF;

763 
cÚŒŞ_·ck‘
.
»que¡ty³
 = 
»que¡
 >> 8;

764 
cÚŒŞ_·ck‘
.
’dpošt
 = cÚŒŞ_·ck‘.
»que¡ty³
 & 
USB_DIR_IN
;

765 
cÚŒŞ_·ck‘
.
v®ue
 = value;

766 
cÚŒŞ_·ck‘
.
šdex
 = index;

767 
cÚŒŞ_·ck‘
.
Ëngth
 =†ength;

768 
aurb
->
cÚŒŞ_·ck‘
 = control_packet;

770 ià(
cÚŒŞ_·ck‘
.
»que¡ty³
 & 
USB_DIR_IN
) {

771 
	`usb»dœ·r£r_£nd_cÚŒŞ_·ck‘
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

772 &
cÚŒŞ_·ck‘
, 
NULL
, 0);

774 
	`usb»dœ_log_d©a
(
dev
, "ù¾ d©¨out:", 
d©a
, 
Ëngth
);

775 
	`usb»dœ·r£r_£nd_cÚŒŞ_·ck‘
(
dev
->
·r£r
, 
aurb
->
·ck‘_id
,

776 &
cÚŒŞ_·ck‘
, 
d©a
, 
Ëngth
);

778 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

779  
USB_RET_ASYNC
;

780 
	}
}

791 
	$usb»dœ_İ’_şo£_bh
(*
İaque
)

793 
USBRedœDeviû
 *
dev
 = 
İaque
;

794 
ušt32_t
 
ÿps
[
USB_REDIR_CAPS_SIZE
] = { 0, };

795 
v”siÚ
[32];

797 
	`¡rıy
(
v”siÚ
, "qemu usb-redir guest ");

798 
	`p¡rÿt
(
v”siÚ
, (v”siÚ), 
	`qemu_g‘_v”siÚ
());

800 
	`usb»dœ_deviû_discÚÃù
(
dev
);

802 ià(
dev
->
·r£r
) {

803 
	`usb»dœ·r£r_de¡roy
(
dev
->
·r£r
);

804 
dev
->
·r£r
 = 
NULL
;

807 ià(
dev
->
cs
->
İ’ed
) {

808 
dev
->
·r£r
 = 
	`qemu_oom_check
(
	`usb»dœ·r£r_ü—‹
());

809 
dev
->
·r£r
->
´iv
 = dev;

810 
dev
->
·r£r
->
log_func
 = 
usb»dœ_log
;

811 
dev
->
·r£r
->
»ad_func
 = 
usb»dœ_»ad
;

812 
dev
->
·r£r
->
wr™e_func
 = 
usb»dœ_wr™e
;

813 
dev
->
·r£r
->
h–lo_func
 = 
usb»dœ_h–lo
;

814 
dev
->
·r£r
->
deviû_cÚÃù_func
 = 
usb»dœ_deviû_cÚÃù
;

815 
dev
->
·r£r
->
deviû_discÚÃù_func
 = 
usb»dœ_deviû_discÚÃù
;

816 
dev
->
·r£r
->
š‹rçû_šfo_func
 = 
usb»dœ_š‹rçû_šfo
;

817 
dev
->
·r£r
->
•_šfo_func
 = 
usb»dœ_•_šfo
;

818 
dev
->
·r£r
->
cÚfigu¿tiÚ_¡©us_func
 = 
usb»dœ_cÚfigu¿tiÚ_¡©us
;

819 
dev
->
·r£r
->
®t_£‰šg_¡©us_func
 = 
usb»dœ_®t_£‰šg_¡©us
;

820 
dev
->
·r£r
->
iso_¡»am_¡©us_func
 = 
usb»dœ_iso_¡»am_¡©us
;

821 
dev
->
·r£r
->
š‹¼u±_»ûivšg_¡©us_func
 =

822 
usb»dœ_š‹¼u±_»ûivšg_¡©us
;

823 
dev
->
·r£r
->
bulk_¡»ams_¡©us_func
 = 
usb»dœ_bulk_¡»ams_¡©us
;

824 
dev
->
·r£r
->
cÚŒŞ_·ck‘_func
 = 
usb»dœ_cÚŒŞ_·ck‘
;

825 
dev
->
·r£r
->
bulk_·ck‘_func
 = 
usb»dœ_bulk_·ck‘
;

826 
dev
->
·r£r
->
iso_·ck‘_func
 = 
usb»dœ_iso_·ck‘
;

827 
dev
->
·r£r
->
š‹¼u±_·ck‘_func
 = 
usb»dœ_š‹¼u±_·ck‘
;

828 
dev
->
»ad_buf
 = 
NULL
;

829 
dev
->
»ad_buf_size
 = 0;

831 
	`usb»dœ·r£r_ÿps_£t_ÿp
(
ÿps
, 
usb_»dœ_ÿp_cÚÃù_deviû_v”siÚ
);

832 
	`usb»dœ·r£r_ÿps_£t_ÿp
(
ÿps
, 
usb_»dœ_ÿp_f‹r
);

833 
	`usb»dœ·r£r_š™
(
dev
->
·r£r
, 
v”siÚ
, 
ÿps
, 
USB_REDIR_CAPS_SIZE
, 0);

834 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

836 
	}
}

838 
	$usb»dœ_do_©ch
(*
İaque
)

840 
USBRedœDeviû
 *
dev
 = 
İaque
;

842 ià(
	`usb_deviû_©ch
(&
dev
->dev) != 0) {

843 
	`usb»dœ_deviû_discÚÃù
(
dev
);

844 ià(
	`usb»dœ·r£r_³”_has_ÿp
(
dev
->
·r£r
, 
usb_»dœ_ÿp_f‹r
)) {

845 
	`usb»dœ·r£r_£nd_f‹r_»jeù
(
dev
->
·r£r
);

846 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

849 
	}
}

855 
	$usb»dœ_ch¬dev_ÿn_»ad
(*
İaque
)

857 
USBRedœDeviû
 *
dev
 = 
İaque
;

859 ià(
dev
->
·r£r
) {

866 
	}
}

868 
	$usb»dœ_ch¬dev_»ad
(*
İaque
, cÚ¡ 
ušt8_t
 *
buf
, 
size
)

870 
USBRedœDeviû
 *
dev
 = 
İaque
;

873 
	`as£¹
(
dev
->
»ad_buf
 =ğ
NULL
);

875 
dev
->
»ad_buf
 = 
buf
;

876 
dev
->
»ad_buf_size
 = 
size
;

878 
	`usb»dœ·r£r_do_»ad
(
dev
->
·r£r
);

880 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

881 
	}
}

883 
	$usb»dœ_ch¬dev_ev’t
(*
İaque
, 
ev’t
)

885 
USBRedœDeviû
 *
dev
 = 
İaque
;

887 
ev’t
) {

888 
CHR_EVENT_OPENED
:

889 
CHR_EVENT_CLOSED
:

890 
	`qemu_bh_scheduË
(
dev
->
İ’_şo£_bh
);

893 
	}
}

899 
	$usb»dœ_š™â
(
USBDeviû
 *
udev
)

901 
USBRedœDeviû
 *
dev
 = 
	`DO_UPCAST
(USBRedœDeviû, dev, 
udev
);

902 
i
;

904 ià(
dev
->
cs
 =ğ
NULL
) {

905 
	`q”rÜ_»pÜt
(
QERR_MISSING_PARAMETER
, "chardev");

909 ià(
dev
->
f‹r_¡r
) {

910 
i
 = 
	`usb»dœf‹r_¡ršg_to_ruËs
(
dev
->
f‹r_¡r
, ":", "|",

911 &
dev
->
f‹r_ruËs
,

912 &
dev
->
f‹r_ruËs_couÁ
);

913 ià(
i
) {

914 
	`q”rÜ_»pÜt
(
QERR_INVALID_PARAMETER_VALUE
, "filter",

920 
dev
->
İ’_şo£_bh
 = 
	`qemu_bh_Ãw
(
usb»dœ_İ’_şo£_bh
, dev);

921 
dev
->
©ch_tim”
 = 
	`qemu_Ãw_tim”_ms
(
vm_şock
, 
usb»dœ_do_©ch
, dev);

923 
	`QTAILQ_INIT
(&
dev
->
asyncq
);

924 
i
 = 0; i < 
MAX_ENDPOINTS
; i++) {

925 
	`QTAILQ_INIT
(&
dev
->
’dpošt
[
i
].
buåq
);

929 
udev
->
auto_©ch
 = 0;

932 
	`qemu_chr_ã_İ’
(
dev
->
cs
);

933 
	`qemu_chr_add_hªdËrs
(
dev
->
cs
, 
usb»dœ_ch¬dev_ÿn_»ad
,

934 
usb»dœ_ch¬dev_»ad
, 
usb»dœ_ch¬dev_ev’t
, 
dev
);

936 
	`add_boÙ_deviû_·th
(
dev
->
boÙšdex
, &
udev
->
qdev
, 
NULL
);

938 
	}
}

940 
	$usb»dœ_ş—nup_deviû_queues
(
USBRedœDeviû
 *
dev
)

942 
AsyncURB
 *
aurb
, *
Ãxt_aurb
;

943 
i
;

945 
	`QTAILQ_FOREACH_SAFE
(
aurb
, &
dev
->
asyncq
, 
Ãxt
, 
Ãxt_aurb
) {

946 
	`async_ä“
(
dev
, 
aurb
);

948 
i
 = 0; i < 
MAX_ENDPOINTS
; i++) {

949 
	`usb»dœ_ä“_buåq
(
dev
, 
	`I2EP
(
i
));

951 
	}
}

953 
	$usb»dœ_hªdË_de¡roy
(
USBDeviû
 *
udev
)

955 
USBRedœDeviû
 *
dev
 = 
	`DO_UPCAST
(USBRedœDeviû, dev, 
udev
);

957 
	`qemu_chr_ã_şo£
(
dev
->
cs
);

958 
	`qemu_chr_d–‘e
(
dev
->
cs
);

960 
	`qemu_bh_d–‘e
(
dev
->
İ’_şo£_bh
);

962 
	`qemu_d–_tim”
(
dev
->
©ch_tim”
);

963 
	`qemu_ä“_tim”
(
dev
->
©ch_tim”
);

965 
	`usb»dœ_ş—nup_deviû_queues
(
dev
);

967 ià(
dev
->
·r£r
) {

968 
	`usb»dœ·r£r_de¡roy
(
dev
->
·r£r
);

971 
	`ä“
(
dev
->
f‹r_ruËs
);

972 
	}
}

974 
	$usb»dœ_check_f‹r
(
USBRedœDeviû
 *
dev
)

976 ià(
dev
->
š‹rçû_šfo
.
š‹rçû_couÁ
 =ğ
NO_INTERFACE_INFO
) {

977 
	`ERROR
("No interface info for device\n");

978 
”rÜ
;

981 ià(
dev
->
f‹r_ruËs
) {

982 ià(!
	`usb»dœ·r£r_³”_has_ÿp
(
dev
->
·r£r
,

983 
usb_»dœ_ÿp_cÚÃù_deviû_v”siÚ
)) {

984 
	`ERROR
("Device filter specified‡nd…eer does‚ot havehe "

986 
”rÜ
;

989 ià(
	`usb»dœf‹r_check
(

990 
dev
->
f‹r_ruËs
,

991 
dev
->
f‹r_ruËs_couÁ
,

992 
dev
->
deviû_šfo
.
deviû_şass
,

993 
dev
->
deviû_šfo
.
deviû_subşass
,

994 
dev
->
deviû_šfo
.
deviû_´ÙocŞ
,

995 
dev
->
š‹rçû_šfo
.
š‹rçû_şass
,

996 
dev
->
š‹rçû_šfo
.
š‹rçû_subşass
,

997 
dev
->
š‹rçû_šfo
.
š‹rçû_´ÙocŞ
,

998 
dev
->
š‹rçû_šfo
.
š‹rçû_couÁ
,

999 
dev
->
deviû_šfo
.
v’dÜ_id
,

1000 
dev
->
deviû_šfo
.
´oduù_id
,

1001 
dev
->
deviû_šfo
.
deviû_v”siÚ_bcd
,

1003 
”rÜ
;

1009 
”rÜ
:

1010 
	`usb»dœ_deviû_discÚÃù
(
dev
);

1011 ià(
	`usb»dœ·r£r_³”_has_ÿp
(
dev
->
·r£r
, 
usb_»dœ_ÿp_f‹r
)) {

1012 
	`usb»dœ·r£r_£nd_f‹r_»jeù
(
dev
->
·r£r
);

1013 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

1016 
	}
}

1022 
	$usb»dœ_hªdË_¡©us
(
USBRedœDeviû
 *
dev
,

1023 
¡©us
, 
aùu®_Ën
)

1025 
¡©us
) {

1026 
usb_»dœ_sucûss
:

1027  
aùu®_Ën
;

1028 
usb_»dœ_¡®l
:

1029  
USB_RET_STALL
;

1030 
usb_»dœ_ÿnûÎed
:

1031 
	`WARNING
("returning cancelled…acketo HC?\n");

1032  
USB_RET_NAK
;

1033 
usb_»dœ_šv®
:

1034 
	`WARNING
("got invalid…aramƒrror from usb-host?\n");

1035  
USB_RET_NAK
;

1036 
usb_»dœ_babbË
:

1037  
USB_RET_BABBLE
;

1038 
usb_»dœ_iÛ¼Ü
:

1039 
usb_»dœ_timeout
:

1041  
USB_RET_IOERROR
;

1043 
	}
}

1045 
	$usb»dœ_h–lo
(*
´iv
, 
usb_»dœ_h–lo_h—d”
 *
h
)

1047 
USBRedœDeviû
 *
dev
 = 
´iv
;

1050 ià(
	`usb»dœ·r£r_³”_has_ÿp
(
dev
->
·r£r
, 
usb_»dœ_ÿp_f‹r
) &&

1051 
dev
->
f‹r_ruËs
) {

1052 
	`usb»dœ·r£r_£nd_f‹r_f‹r
(
dev
->
·r£r
, dev->
f‹r_ruËs
,

1053 
dev
->
f‹r_ruËs_couÁ
);

1054 
	`usb»dœ·r£r_do_wr™e
(
dev
->
·r£r
);

1056 
	}
}

1058 
	$usb»dœ_deviû_cÚÃù
(*
´iv
,

1059 
usb_»dœ_deviû_cÚÃù_h—d”
 *
deviû_cÚÃù
)

1061 
USBRedœDeviû
 *
dev
 = 
´iv
;

1062 cÚ¡ *
¥“d
;

1064 ià(
	`qemu_tim”_³ndšg
(
dev
->
©ch_tim”
è|| dev->dev.
©ched
) {

1065 
	`ERROR
("Received device connect while‡lready connected\n");

1069 
deviû_cÚÃù
->
¥“d
) {

1070 
usb_»dœ_¥“d_low
:

1071 
¥“d
 = "low speed";

1072 
dev
->dev.
¥“d
 = 
USB_SPEED_LOW
;

1074 
usb_»dœ_¥“d_fuÎ
:

1075 
¥“d
 = "full speed";

1076 
dev
->dev.
¥“d
 = 
USB_SPEED_FULL
;

1078 
usb_»dœ_¥“d_high
:

1079 
¥“d
 = "high speed";

1080 
dev
->dev.
¥“d
 = 
USB_SPEED_HIGH
;

1082 
usb_»dœ_¥“d_su³r
:

1083 
¥“d
 = "super speed";

1084 
dev
->dev.
¥“d
 = 
USB_SPEED_SUPER
;

1087 
¥“d
 = "unknown speed";

1088 
dev
->dev.
¥“d
 = 
USB_SPEED_FULL
;

1091 ià(
	`usb»dœ·r£r_³”_has_ÿp
(
dev
->
·r£r
,

1092 
usb_»dœ_ÿp_cÚÃù_deviû_v”siÚ
)) {

1093 
	`INFO
("attaching %s device %04x:%04x version %d.%d class %02x\n",

1094 
¥“d
, 
deviû_cÚÃù
->
v’dÜ_id
, deviû_cÚÃù->
´oduù_id
,

1095 ((
deviû_cÚÃù
->
deviû_v”siÚ_bcd
 & 0xf000) >> 12) * 10 +

1096 ((
deviû_cÚÃù
->
deviû_v”siÚ_bcd
 & 0x0f00) >> 8),

1097 ((
deviû_cÚÃù
->
deviû_v”siÚ_bcd
 & 0x00f0) >> 4) * 10 +

1098 ((
deviû_cÚÃù
->
deviû_v”siÚ_bcd
 & 0x000f) >> 0),

1099 
deviû_cÚÃù
->
deviû_şass
);

1101 
	`INFO
("©chšg % deviû %04x:%04x cÏs %02x\n", 
¥“d
,

1102 
deviû_cÚÃù
->
v’dÜ_id
, deviû_cÚÃù->
´oduù_id
,

1103 
deviû_cÚÃù
->
deviû_şass
);

1106 
dev
->dev.
¥“dmask
 = (1 << dev->dev.
¥“d
);

1107 
dev
->
deviû_šfo
 = *
deviû_cÚÃù
;

1109 ià(
	`usb»dœ_check_f‹r
(
dev
)) {

1110 
	`WARNING
("Device %04x:%04x„ejected by device filter,‚ot‡ttaching\n",

1111 
deviû_cÚÃù
->
v’dÜ_id
, deviû_cÚÃù->
´oduù_id
);

1115 
	`qemu_mod_tim”
(
dev
->
©ch_tim”
, dev->
Ãxt_©ch_time
);

1116 
	}
}

1118 
	$usb»dœ_deviû_discÚÃù
(*
´iv
)

1120 
USBRedœDeviû
 *
dev
 = 
´iv
;

1121 
i
;

1124 
	`qemu_d–_tim”
(
dev
->
©ch_tim”
);

1126 ià(
dev
->dev.
©ched
) {

1127 
	`usb_deviû_d‘ach
(&
dev
->dev);

1132 
dev
->
Ãxt_©ch_time
 = 
	`qemu_g‘_şock_ms
(
vm_şock
) + 200;

1136 
	`usb»dœ_ş—nup_deviû_queues
(
dev
);

1137 
	`mem£t
(
dev
->
’dpošt
, 0, (dev->endpoint));

1138 
i
 = 0; i < 
MAX_ENDPOINTS
; i++) {

1139 
	`QTAILQ_INIT
(&
dev
->
’dpošt
[
i
].
buåq
);

1141 
	`usb_•_š™
(&
dev
->dev);

1142 
dev
->
š‹rçû_šfo
.
š‹rçû_couÁ
 = 
NO_INTERFACE_INFO
;

1143 
dev
->dev.
addr
 = 0;

1144 
dev
->dev.
¥“d
 = 0;

1145 
	}
}

1147 
	$usb»dœ_š‹rçû_šfo
(*
´iv
,

1148 
usb_»dœ_š‹rçû_šfo_h—d”
 *
š‹rçû_šfo
)

1150 
USBRedœDeviû
 *
dev
 = 
´iv
;

1152 
dev
->
š‹rçû_šfo
 = *interface_info;

1158 ià(
	`qemu_tim”_³ndšg
(
dev
->
©ch_tim”
è|| dev->dev.
©ched
) {

1159 ià(
	`usb»dœ_check_f‹r
(
dev
)) {

1160 
	`ERROR
("Device‚o†onger matches filter‡fter interface info "

1164 
	}
}

1166 
	$usb»dœ_•_šfo
(*
´iv
,

1167 
usb_»dœ_•_šfo_h—d”
 *
•_šfo
)

1169 
USBRedœDeviû
 *
dev
 = 
´iv
;

1170 
USBEndpošt
 *
usb_•
;

1171 
i
;

1173 
i
 = 0; i < 
MAX_ENDPOINTS
; i++) {

1174 
dev
->
’dpošt
[
i
].
ty³
 = 
•_šfo
->type[i];

1175 
dev
->
’dpošt
[
i
].
š‹rv®
 = 
•_šfo
->interval[i];

1176 
dev
->
’dpošt
[
i
].
š‹rçû
 = 
•_šfo
->interface[i];

1177 
dev
->
’dpošt
[
i
].
ty³
) {

1178 
usb_»dœ_ty³_šv®id
:

1180 
usb_»dœ_ty³_iso
:

1181 
usb_»dœ_ty³_š‹¼u±
:

1182 ià(
dev
->
’dpošt
[
i
].
š‹rv®
 == 0) {

1183 
	`ERROR
("Received 0 interval for isoc or irqƒndpoint\n");

1184 
	`usb»dœ_deviû_discÚÃù
(
dev
);

1187 
usb_»dœ_ty³_cÚŒŞ
:

1188 
usb_»dœ_ty³_bulk
:

1189 
	`DPRINTF
("•: %02Xy³: %d iÁ”çû: %d\n", 
	`I2EP
(
i
),

1190 
dev
->
’dpošt
[
i
].
ty³
, dev->’dpošt[i].
š‹rçû
);

1193 
	`ERROR
("Received invalidƒndpointype\n");

1194 
	`usb»dœ_deviû_discÚÃù
(
dev
);

1197 
usb_•
 = 
	`usb_•_g‘
(&
dev
->dev,

1198 (
i
 & 0x10è? 
USB_TOKEN_IN
 : 
USB_TOKEN_OUT
,

1199 
i
 & 0x0f);

1200 
usb_•
->
ty³
 = 
dev
->
’dpošt
[
i
].type;

1201 
usb_•
->
iâum
 = 
dev
->
’dpošt
[
i
].
š‹rçû
;

1203 
	}
}

1205 
	$usb»dœ_cÚfigu¿tiÚ_¡©us
(*
´iv
, 
ušt32_t
 
id
,

1206 
usb_»dœ_cÚfigu¿tiÚ_¡©us_h—d”
 *
cÚfig_¡©us
)

1208 
USBRedœDeviû
 *
dev
 = 
´iv
;

1209 
AsyncURB
 *
aurb
;

1210 
Ën
 = 0;

1212 
	`DPRINTF
("£ˆcÚfig stu %d cÚfig %d id %u\n", 
cÚfig_¡©us
->
¡©us
,

1213 
cÚfig_¡©us
->
cÚfigu¿tiÚ
, 
id
);

1215 
aurb
 = 
	`async_fšd
(
dev
, 
id
);

1216 ià(!
aurb
) {

1219 ià(
aurb
->
·ck‘
) {

1220 ià(
aurb
->
g‘
) {

1221 
dev
->dev.
d©a_buf
[0] = 
cÚfig_¡©us
->
cÚfigu¿tiÚ
;

1222 
Ën
 = 1;

1224 
aurb
->
·ck‘
->
»suÉ
 =

1225 
	`usb»dœ_hªdË_¡©us
(
dev
, 
cÚfig_¡©us
->
¡©us
, 
Ën
);

1226 
	`usb_g’”ic_async_ù¾_com¶‘e
(&
dev
->dev, 
aurb
->
·ck‘
);

1228 
	`async_ä“
(
dev
, 
aurb
);

1229 
	}
}

1231 
	$usb»dœ_®t_£‰šg_¡©us
(*
´iv
, 
ušt32_t
 
id
,

1232 
usb_»dœ_®t_£‰šg_¡©us_h—d”
 *
®t_£‰šg_¡©us
)

1234 
USBRedœDeviû
 *
dev
 = 
´iv
;

1235 
AsyncURB
 *
aurb
;

1236 
Ën
 = 0;

1238 
	`DPRINTF
("alt status %d intf %d‡lt %d id: %u\n",

1239 
®t_£‰šg_¡©us
->
¡©us
,

1240 
®t_£‰šg_¡©us
->
š‹rçû
,

1241 
®t_£‰šg_¡©us
->
®t
, 
id
);

1243 
aurb
 = 
	`async_fšd
(
dev
, 
id
);

1244 ià(!
aurb
) {

1247 ià(
aurb
->
·ck‘
) {

1248 ià(
aurb
->
g‘
) {

1249 
dev
->dev.
d©a_buf
[0] = 
®t_£‰šg_¡©us
->
®t
;

1250 
Ën
 = 1;

1252 
aurb
->
·ck‘
->
»suÉ
 =

1253 
	`usb»dœ_hªdË_¡©us
(
dev
, 
®t_£‰šg_¡©us
->
¡©us
, 
Ën
);

1254 
	`usb_g’”ic_async_ù¾_com¶‘e
(&
dev
->dev, 
aurb
->
·ck‘
);

1256 
	`async_ä“
(
dev
, 
aurb
);

1257 
	}
}

1259 
	$usb»dœ_iso_¡»am_¡©us
(*
´iv
, 
ušt32_t
 
id
,

1260 
usb_»dœ_iso_¡»am_¡©us_h—d”
 *
iso_¡»am_¡©us
)

1262 
USBRedœDeviû
 *
dev
 = 
´iv
;

1263 
ušt8_t
 
•
 = 
iso_¡»am_¡©us
->
’dpošt
;

1265 
	`DPRINTF
("isØ¡©u %dƒ°%02X id %u\n", 
iso_¡»am_¡©us
->
¡©us
,

1266 
•
, 
id
);

1268 ià(!
dev
->dev.
©ched
 || !dev->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
) {

1272 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_”rÜ
 = 
iso_¡»am_¡©us
->
¡©us
;

1273 ià(
iso_¡»am_¡©us
->
¡©us
 =ğ
usb_»dœ_¡®l
) {

1274 
	`DPRINTF
("isØ¡»am stİ³d by…“¸• %02X\n", 
•
);

1275 
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
 = 0;

1277 
	}
}

1279 
	$usb»dœ_š‹¼u±_»ûivšg_¡©us
(*
´iv
, 
ušt32_t
 
id
,

1280 
usb_»dœ_š‹¼u±_»ûivšg_¡©us_h—d”


1281 *
š‹¼u±_»ûivšg_¡©us
)

1283 
USBRedœDeviû
 *
dev
 = 
´iv
;

1284 
ušt8_t
 
•
 = 
š‹¼u±_»ûivšg_¡©us
->
’dpošt
;

1286 
	`DPRINTF
("interrupt„ecv status %dƒp %02X id %u\n",

1287 
š‹¼u±_»ûivšg_¡©us
->
¡©us
, 
•
, 
id
);

1289 ià(!
dev
->dev.
©ched
 || !dev->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_¡¬‹d
) {

1293 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_”rÜ
 =

1294 
š‹¼u±_»ûivšg_¡©us
->
¡©us
;

1295 ià(
š‹¼u±_»ûivšg_¡©us
->
¡©us
 =ğ
usb_»dœ_¡®l
) {

1296 
	`DPRINTF
("š‹¼u±„eûivšg stİ³d by…“¸• %02X\n", 
•
);

1297 
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_¡¬‹d
 = 0;

1299 
	}
}

1301 
	$usb»dœ_bulk_¡»ams_¡©us
(*
´iv
, 
ušt32_t
 
id
,

1302 
usb_»dœ_bulk_¡»ams_¡©us_h—d”
 *
bulk_¡»ams_¡©us
)

1304 
	}
}

1306 
	$usb»dœ_cÚŒŞ_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

1307 
usb_»dœ_cÚŒŞ_·ck‘_h—d”
 *
cÚŒŞ_·ck‘
,

1308 
ušt8_t
 *
d©a
, 
d©a_Ën
)

1310 
USBRedœDeviû
 *
dev
 = 
´iv
;

1311 
Ën
 = 
cÚŒŞ_·ck‘
->
Ëngth
;

1312 
AsyncURB
 *
aurb
;

1314 
	`DPRINTF
("ù¾-š stu %d†’ %d id %u\n", 
cÚŒŞ_·ck‘
->
¡©us
,

1315 
Ën
, 
id
);

1317 
aurb
 = 
	`async_fšd
(
dev
, 
id
);

1318 ià(!
aurb
) {

1319 
	`ä“
(
d©a
);

1323 
aurb
->
cÚŒŞ_·ck‘
.
¡©us
 = control_packet->status;

1324 
aurb
->
cÚŒŞ_·ck‘
.
Ëngth
 = control_packet->length;

1325 ià(
	`memcmp
(&
aurb
->
cÚŒŞ_·ck‘
, control_packet,

1326 (*
cÚŒŞ_·ck‘
))) {

1327 
	`ERROR
("return control…acket mismatch,…lease„eporthis!\n");

1328 
Ën
 = 
USB_RET_NAK
;

1331 ià(
aurb
->
·ck‘
) {

1332 
Ën
 = 
	`usb»dœ_hªdË_¡©us
(
dev
, 
cÚŒŞ_·ck‘
->
¡©us
,†en);

1333 ià(
Ën
 > 0) {

1334 
	`usb»dœ_log_d©a
(
dev
, "ù¾ d©¨š:", 
d©a
, 
d©a_Ën
);

1335 ià(
d©a_Ën
 <ğ(
dev
->dev.
d©a_buf
)) {

1336 
	`memıy
(
dev
->dev.
d©a_buf
, 
d©a
, 
d©a_Ën
);

1338 
	`ERROR
("ctrl bufferoo small (%d > %zu)\n",

1339 
d©a_Ën
, (
dev
->dev.
d©a_buf
));

1340 
Ën
 = 
USB_RET_STALL
;

1343 
aurb
->
·ck‘
->
»suÉ
 = 
Ën
;

1344 
	`usb_g’”ic_async_ù¾_com¶‘e
(&
dev
->dev, 
aurb
->
·ck‘
);

1346 
	`async_ä“
(
dev
, 
aurb
);

1347 
	`ä“
(
d©a
);

1348 
	}
}

1350 
	$usb»dœ_bulk_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

1351 
usb_»dœ_bulk_·ck‘_h—d”
 *
bulk_·ck‘
,

1352 
ušt8_t
 *
d©a
, 
d©a_Ën
)

1354 
USBRedœDeviû
 *
dev
 = 
´iv
;

1355 
ušt8_t
 
•
 = 
bulk_·ck‘
->
’dpošt
;

1356 
Ën
 = 
bulk_·ck‘
->
Ëngth
;

1357 
AsyncURB
 *
aurb
;

1359 
	`DPRINTF
("bulk-š stu %dƒ°%02X†’ %d id %u\n", 
bulk_·ck‘
->
¡©us
,

1360 
•
, 
Ën
, 
id
);

1362 
aurb
 = 
	`async_fšd
(
dev
, 
id
);

1363 ià(!
aurb
) {

1364 
	`ä“
(
d©a
);

1368 ià(
aurb
->
bulk_·ck‘
.
’dpošt
 != bulk_packet->endpoint ||

1369 
aurb
->
bulk_·ck‘
.
¡»am_id
 != bulk_packet->stream_id) {

1370 
	`ERROR
("return bulk…acket mismatch,…lease„eporthis!\n");

1371 
Ën
 = 
USB_RET_NAK
;

1374 ià(
aurb
->
·ck‘
) {

1375 
Ën
 = 
	`usb»dœ_hªdË_¡©us
(
dev
, 
bulk_·ck‘
->
¡©us
,†en);

1376 ià(
Ën
 > 0) {

1377 
	`usb»dœ_log_d©a
(
dev
, "bulk d©¨š:", 
d©a
, 
d©a_Ën
);

1378 ià(
d©a_Ën
 <ğ
aurb
->
·ck‘
->
iov
.
size
) {

1379 
	`usb_·ck‘_cİy
(
aurb
->
·ck‘
, 
d©a
, 
d©a_Ën
);

1381 
	`ERROR
("bulk bufã¸toØsm®È(%d > %zd)\n", 
d©a_Ën
,

1382 
aurb
->
·ck‘
->
iov
.
size
);

1383 
Ën
 = 
USB_RET_STALL
;

1386 
aurb
->
·ck‘
->
»suÉ
 = 
Ën
;

1387 
	`usb_·ck‘_com¶‘e
(&
dev
->dev, 
aurb
->
·ck‘
);

1389 
	`async_ä“
(
dev
, 
aurb
);

1390 
	`ä“
(
d©a
);

1391 
	}
}

1393 
	$usb»dœ_iso_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

1394 
usb_»dœ_iso_·ck‘_h—d”
 *
iso_·ck‘
,

1395 
ušt8_t
 *
d©a
, 
d©a_Ën
)

1397 
USBRedœDeviû
 *
dev
 = 
´iv
;

1398 
ušt8_t
 
•
 = 
iso_·ck‘
->
’dpošt
;

1400 
	`DPRINTF2
("iso-š stu %dƒ°%02X†’ %d id %u\n", 
iso_·ck‘
->
¡©us
, 
•
,

1401 
d©a_Ën
, 
id
);

1403 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
ty³
 !ğ
USB_ENDPOINT_XFER_ISOC
) {

1404 
	`ERROR
("»ûived isØ·ck‘ fÜ‚Ú isØ’dpošˆ%02X\n", 
•
);

1405 
	`ä“
(
d©a
);

1409 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
iso_¡¬‹d
 == 0) {

1410 
	`DPRINTF
("»ûived isØ·ck‘ fÜ‚Ú s¹ed sŒ—mƒ°%02X\n", 
•
);

1411 
	`ä“
(
d©a
);

1416 
	`buå_®loc
(
dev
, 
d©a
, 
d©a_Ën
, 
iso_·ck‘
->
¡©us
, 
•
);

1417 
	}
}

1419 
	$usb»dœ_š‹¼u±_·ck‘
(*
´iv
, 
ušt32_t
 
id
,

1420 
usb_»dœ_š‹¼u±_·ck‘_h—d”
 *
š‹¼u±_·ck‘
,

1421 
ušt8_t
 *
d©a
, 
d©a_Ën
)

1423 
USBRedœDeviû
 *
dev
 = 
´iv
;

1424 
ušt8_t
 
•
 = 
š‹¼u±_·ck‘
->
’dpošt
;

1426 
	`DPRINTF
("interrupt-in status %dƒp %02X†en %d id %u\n",

1427 
š‹¼u±_·ck‘
->
¡©us
, 
•
, 
d©a_Ën
, 
id
);

1429 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
ty³
 !ğ
USB_ENDPOINT_XFER_INT
) {

1430 
	`ERROR
("»ûived iÁ…ack‘ fÜ‚Ú iÁ”ru±ƒndpošˆ%02X\n", 
•
);

1431 
	`ä“
(
d©a
);

1435 ià(
•
 & 
USB_DIR_IN
) {

1436 ià(
dev
->
’dpošt
[
	`EP2I
(
•
)].
š‹¼u±_¡¬‹d
 == 0) {

1437 
	`DPRINTF
("»ûived iÁ…ack‘ whnÙ s¹edƒ°%02X\n", 
•
);

1438 
	`ä“
(
d©a
);

1443 
	`buå_®loc
(
dev
, 
d©a
, 
d©a_Ën
, 
š‹¼u±_·ck‘
->
¡©us
, 
•
);

1445 
Ën
 = 
š‹¼u±_·ck‘
->
Ëngth
;

1447 
AsyncURB
 *
aurb
 = 
	`async_fšd
(
dev
, 
id
);

1448 ià(!
aurb
) {

1452 ià(
aurb
->
š‹¼u±_·ck‘
.
’dpošt
 != interrupt_packet->endpoint) {

1453 
	`ERROR
("return int…acket mismatch,…lease„eporthis!\n");

1454 
Ën
 = 
USB_RET_NAK
;

1457 ià(
aurb
->
·ck‘
) {

1458 
aurb
->
·ck‘
->
»suÉ
 = 
	`usb»dœ_hªdË_¡©us
(
dev
,

1459 
š‹¼u±_·ck‘
->
¡©us
, 
Ën
);

1460 
	`usb_·ck‘_com¶‘e
(&
dev
->dev, 
aurb
->
·ck‘
);

1462 
	`async_ä“
(
dev
, 
aurb
);

1464 
	}
}

1466 
Prİ”ty
 
	gusb»dœ_´İ”t›s
[] = {

1467 
DEFINE_PROP_CHR
("ch¬dev", 
USBRedœDeviû
, 
cs
),

1468 
DEFINE_PROP_UINT8
("debug", 
USBRedœDeviû
, 
debug
, 0),

1469 
DEFINE_PROP_STRING
("f‹r", 
USBRedœDeviû
, 
f‹r_¡r
),

1470 
DEFINE_PROP_INT32
("boÙšdex", 
USBRedœDeviû
, 
boÙšdex
, -1),

1471 
DEFINE_PROP_END_OF_LIST
(),

1474 
	$usb»dœ_şass_š™â
(
ObjeùCÏss
 *
kÏss
, *
d©a
)

1476 
USBDeviûCÏss
 *
uc
 = 
	`USB_DEVICE_CLASS
(
kÏss
);

1477 
DeviûCÏss
 *
dc
 = 
	`DEVICE_CLASS
(
kÏss
);

1479 
uc
->
š™
 = 
usb»dœ_š™â
;

1480 
uc
->
´oduù_desc
 = "USB Redirection Device";

1481 
uc
->
hªdË_de¡roy
 = 
usb»dœ_hªdË_de¡roy
;

1482 
uc
->
ÿnûl_·ck‘
 = 
usb»dœ_ÿnûl_·ck‘
;

1483 
uc
->
hªdË_»£t
 = 
usb»dœ_hªdË_»£t
;

1484 
uc
->
hªdË_d©a
 = 
usb»dœ_hªdË_d©a
;

1485 
uc
->
hªdË_cÚŒŞ
 = 
usb»dœ_hªdË_cÚŒŞ
;

1486 
dc
->
´İs
 = 
usb»dœ_´İ”t›s
;

1487 
	}
}

1489 
Ty³Info
 
	gusb»dœ_dev_šfo
 = {

1490 .
Çme
 = "usb-redir",

1491 .
	g·»Á
 = 
TYPE_USB_DEVICE
,

1492 .
	gš¡ªû_size
 = (
USBRedœDeviû
),

1493 .
	gşass_š™
 = 
usb»dœ_şass_š™â
,

1496 
	$usb»dœ_»gi¡”_ty³s
()

1498 
	`ty³_»gi¡”_¡©ic
(&
usb»dœ_dev_šfo
);

1499 
	}
}

1501 
ty³_š™
(
usb»dœ_»gi¡”_ty³s
)

	@/usr/include/audio/audio.h

33 #iâdeà
_NCD_AUDIO_H_


34 
	#_NCD_AUDIO_H_


	)

36 
	~<audio/Amd.h
>

46 
INT32
 
	tAuIÁ32
;

47 
CARD32
 
	tAuUšt32
;

48 
INT16
 
	tAuIÁ16
;

49 
CARD16
 
	tAuUšt16
;

50 
INT8
 
	tAuIÁ8
;

51 
CARD8
 
	tAuUšt8
;

53 
AuUšt32
 
	tAuID
;

54 
AuID
 
	tAuDeviûID
;

55 
AuID
 
	tAuBuck‘ID
;

56 
AuID
 
	tAuRadioID
;

57 
AuID
 
	tAuFlowID
;

59 
AuUšt32
 
	tAuTime
;

60 
AuUšt32
 
	tAuMask
;

61 
	tAuBoŞ
;

62 
	tAuStus
;

63 
AuIÁ32
 
	tAuFixedPošt
;

65 
	#AU_FIXED_POINT_SHIFT
 (16)

	)

66 
	#AU_FIXED_POINT_SCALE
 (1L << 16)

	)

67 
	#AU_FIXED_POINT_MASK
 (0xffff)

	)

103 
	#AuFixedPoštFromSum
(
a
,
b
) \

104 ((
AuIÁ32
è(((AuIÁ32è(
a
è<< 
AU_FIXED_POINT_SHIFT
è+ ((AuIÁ32è(
b
))))

	)

106 
	#AuFixedPoštFromF¿ùiÚ
(
Ân
,
ddd
) \

107 ((((
AuIÁ32
è(
Ân
)è* 
AU_FIXED_POINT_SCALE
è/ ((AuIÁ32è(
ddd
)))

	)

109 
	#AuFixedPoštRoundDown
(
å
) \

110 ((
å
è>> 
AU_FIXED_POINT_SHIFT
)

	)

111 
	#AuFixedPoštRoundUp
(
å
) \

112 (
	`AuFixedPoštRoundDown
((
å
è+ (
AU_FIXED_POINT_SCALE
 - 1L)))

	)

114 
	#AuFixedPoštIÁeg¿lAdd’d
(
å
) \

115 (
	`AuFixedPoštRoundDown
 (
å
))

	)

116 
	#AuFixedPoštF¿ùiÚ®Add’d
(
å
) \

117 ((
å
è& 
AU_FIXED_POINT_MASK
)

	)

120 
	#AuNÚe
 (0è

	)

121 
	#AuF®£
 (0)

	)

122 
	#AuTrue
 (1)

	)

133 
	#AuPrÙocŞMajÜV”siÚ
 2

	)

134 
	#AuPrÙocŞMšÜV”siÚ
 2

	)

140 
	#AuN‘wÜkIÁ”Ãt
 0

	)

141 
	#AuN‘wÜkDECÃt
 1

	)

142 
	#AuN‘wÜkChaos
 2

	)

143 
	#AuN‘wÜkN‘Çme
 254

	)

144 
	#AuN‘wÜkLoÿl
 256

	)

145 
	#AuN‘wÜkWd
 65535

	)

151 
	#AuAcûssNoChªge
 0

	)

152 
	#AuAcûssEÇbËCÚŒŞs
 1

	)

153 
	#AuAcûssDi§bËCÚŒŞs
 2

	)

155 
	#AuAcûssAddU£r
 0

	)

156 
	#AuAcûssRemoveU£r
 1

	)

162 
	#AuClo£DownDe¡roy
 0

	)

163 
	#AuClo£DownR‘ašP”mª’t
 1

	)

164 
	#AuClo£DownR‘ašTempÜ¬y
 2

	)

172 
	#AuAcûssImpÜtMask
 (1L << 0)

	)

173 
	#AuAcûssExpÜtMask
 (1L << 1)

	)

174 
	#AuAcûssDe¡royMask
 (1L << 2)

	)

175 
	#AuAcûssLi¡Mask
 (1L << 3)

	)

176 
	#AuAcûssAÎMasks
 ((1L << 4è- 1)

	)

182 
	#AuSŒšgL©š1
 (1L)

	)

183 
	#AuSŒšgCompoundText
 (2Lè

	)

189 
	#AuEv’tTy³EËm’tNÙify
 2

	)

190 
	#AuEv’tTy³G¿bNÙify
 3

	)

191 
	#AuEv’tTy³MÚ™ÜNÙify
 4

	)

192 
	#AuEv’tTy³Buck‘NÙify
 5

	)

193 
	#AuEv’tTy³DeviûNÙify
 6

	)

195 
	#AuFœ¡Ev’tTy³
 
AuEv’tTy³EËm’tNÙify


	)

196 
	#AuLa¡Ev’tTy³
 
AuEv’tTy³MÚ™ÜNÙify


	)

203 
	#AuSucûss
 0

	)

204 
	#AuBadReque¡
 1

	)

205 
	#AuBadV®ue
 2

	)

206 
	#AuBadDeviû
 3

	)

207 
	#AuBadBuck‘
 4

	)

208 
	#AuBadFlow
 5

	)

209 
	#AuBadEËm’t
 6

	)

211 
	#AuBadM©ch
 8

	)

213 
	#AuBadAcûss
 10

	)

214 
	#AuBadAÎoc
 11

	)

215 
	#AuBadCÚÃùiÚ
 13

	)

216 
	#AuBadIDChoiû
 14

	)

217 
	#AuBadName
 15

	)

218 
	#AuBadL’gth
 16

	)

219 
	#AuBadIm¶em’tiÚ
 17

	)

221 
	#AuLa¡E¼Ü
 
AuBadIm¶em’tiÚ


	)

222 
	#AuFœ¡Ex‹nsiÚE¼Ü
 128

	)

223 
	#AuLa¡Ex‹nsiÚE¼Ü
 255

	)

238 
	#AuFÜm©ULAW8
 1

	)

239 
	#AuFÜm©Lš—rUnsigÃd8
 2

	)

240 
	#AuFÜm©Lš—rSigÃd8
 3

	)

241 
	#AuFÜm©Lš—rSigÃd16MSB
 4

	)

242 
	#AuFÜm©Lš—rUnsigÃd16MSB
 5

	)

243 
	#AuFÜm©Lš—rSigÃd16LSB
 6

	)

244 
	#AuFÜm©Lš—rUnsigÃd16LSB
 7

	)

246 
	#AuSizeofFÜm©
(
fff
) \

247 (((
fff
è< 
AuFÜm©ULAW8
 || (fffè> 
AuFÜm©Lš—rUnsigÃd16LSB
) ? 0 : \

248 (((
fff
è< 
AuFÜm©Lš—rSigÃd16MSB
è? 1 : 2))

	)

251 
	#AuUÆim™edSam¶es
 0

	)

263 
	#AuCompCommÚIDMask
 (1L << 0)

	)

264 
	#AuCompCommÚKšdMask
 (1L << 1)

	)

265 
	#AuCompCommÚU£Mask
 (1L << 2)

	)

266 
	#AuCompCommÚFÜm©Mask
 (1L << 3)

	)

267 
	#AuCompCommÚNumT¿cksMask
 (1L << 4)

	)

268 
	#AuCompCommÚAcûssMask
 (1L << 5)

	)

269 
	#AuCompCommÚDesütiÚMask
 (1L << 6)

	)

270 
	#AuCompCommÚMasks
 ((1L << 7è- 1)

	)

271 
	#AuCompCommÚAÎMasks
 
AuCompCommÚMasks


	)

273 
	#AuCompDeviûMšSam¶eR©eMask
 (1L << 16)

	)

274 
	#AuCompDeviûMaxSam¶eR©eMask
 (1L << 17)

	)

275 
	#AuCompDeviûLoÿtiÚMask
 (1L << 18)

	)

276 
	#AuCompDeviûGašMask
 (1L << 19)

	)

277 
	#AuCompDeviûLšeModeMask
 (1L << 20)

	)

278 
	#AuCompDeviûIÅutModeMask
 
AuCompDeviûLšeModeMask


	)

279 
	#AuCompDeviûOuutModeMask
 
AuCompDeviûLšeModeMask


	)

280 
	#AuCompDeviûChd»nMask
 (1L << 21)

	)

281 
	#AuCompDeviûMasks
 (((1L << 22è- 1è& ~0xffff)

	)

282 
	#AuCompDeviûAÎMasks
 (
AuCompDeviûMasks
 | \

283 
AuCompCommÚAÎMasks
)

	)

285 
	#AuCompBuck‘Sam¶eR©eMask
 (1L << 16)

	)

286 
	#AuCompBuck‘NumSam¶esMask
 (1L << 17)

	)

287 
	#AuCompBuck‘Masks
 (((1L << 18è- 1è& ~0xffff)

	)

288 
	#AuCompBuck‘AÎMasks
 (
AuCompBuck‘Masks
 | \

289 
AuCompCommÚAÎMasks
)

	)

291 
	#AuCompRadioStiÚMask
 (1L << 16)

	)

292 
	#AuCompRadioMasks
 ((1L << 17è- 1)

	)

293 
	#AuCompRadioAÎMasks
 (
AuCompRadioMasks
 | \

294 
AuCompCommÚAÎMasks
)

	)

300 
	#AuCompÚ’tKšdOth”
 0

	)

301 
	#AuCompÚ’tKšdPhysiÿlIÅut
 1

	)

302 
	#AuCompÚ’tKšdPhysiÿlOuut
 2

	)

303 
	#AuCompÚ’tKšdBuck‘
 3

	)

304 
	#AuCompÚ’tKšdRadio
 4

	)

305 
	#AuCompÚ’tKšdPhysiÿlF“dback
 5

	)

316 
	#AuCompÚ’tU£ImpÜtMask
 (1L << 0)

	)

317 
	#AuCompÚ’tU£ExpÜtMask
 (1L << 1)

	)

318 
	#AuCompÚ’tU£ExşusiveMask
 (1L << 2)

	)

319 
	#AuCompÚ’tU£AÎMasks
 ((1L << 3è- 1)

	)

326 
	#AuDeviûLoÿtiÚLeáMask
 (1L << 0)

	)

327 
	#AuDeviûLoÿtiÚC’‹rMask
 (1L << 1)

	)

328 
	#AuDeviûLoÿtiÚRightMask
 (1L << 2)

	)

329 
	#AuDeviûLoÿtiÚTİMask
 (1L << 3)

	)

330 
	#AuDeviûLoÿtiÚMiddËMask
 (1L << 4)

	)

331 
	#AuDeviûLoÿtiÚBÙtomMask
 (1L << 5)

	)

332 
	#AuDeviûLoÿtiÚBackMask
 (1L << 6)

	)

333 
	#AuDeviûLoÿtiÚFrÚtMask
 (1L << 7)

	)

334 
	#AuDeviûLoÿtiÚIÁ”ÇlMask
 (1L << 8)

	)

335 
	#AuDeviûLoÿtiÚEx‹º®Mask
 (1L << 9)

	)

336 
	#AuDeviûLoÿtiÚAÎMasks
 ((1L << 10è- 1)

	)

346 
	#AuDeviûIÅutModeNÚe
 (0L)

	)

347 
	#AuDeviûIÅutModeLšeIn
 (1L)

	)

348 
	#AuDeviûIÅutModeMiüİhÚe
 (2L)

	)

351 
	#AuDeviûLšeModeNÚe
 
AuDeviûIÅutModeNÚe


	)

352 
	#AuDeviûLšeModeLow
 
AuDeviûIÅutModeLšeIn


	)

353 
	#AuDeviûLšeModeHigh
 
AuDeviûIÅutModeMiüİhÚe


	)

361 
	#AuDeviûOuutModeNÚe
 (0L)

	)

362 
	#AuDeviûOuutModeS³ak”
 (1L)

	)

363 
	#AuDeviûOuutModeH—dphÚe
 (2L)

	)

364 
	#AuDeviûOuutModeLšeOut
 (4L)

	)

375 
	#AuEËm’tTy³ImpÜtCl›Á
 0

	)

376 
	#AuEËm’tTy³ImpÜtDeviû
 1

	)

377 
	#AuEËm’tTy³ImpÜtBuck‘
 2

	)

378 
	#AuEËm’tTy³ImpÜtWaveFÜm
 3

	)

379 
	#AuEËm’tTy³ImpÜtRadio
 4

	)

380 
	#AuEËm’tTy³BundË
 5

	)

381 
	#AuEËm’tTy³MuÉlyCÚ¡ªt
 6

	)

382 
	#AuEËm’tTy³AddCÚ¡ªt
 7

	)

383 
	#AuEËm’tTy³Sum
 8

	)

384 
	#AuEËm’tTy³ExpÜtCl›Á
 9

	)

385 
	#AuEËm’tTy³ExpÜtDeviû
 10

	)

386 
	#AuEËm’tTy³ExpÜtBuck‘
 11

	)

387 
	#AuEËm’tTy³ExpÜtRadio
 12

	)

388 
	#AuEËm’tTy³ExpÜtMÚ™Ü
 13

	)

391 
	#AU_MAX_ELEMENTS
 254

	)

392 
	#AuEËm’tAÎ
 255

	)

394 
	#AU_MAX_PARMS
 5

	)

395 
	#AuP¬msImpÜtCl›Á
 0

	)

396 
	#AuP¬msImpÜtDeviû
 0

	)

397 
	#AuP¬msImpÜtBuck‘
 1

	)

398 
	#AuP¬msImpÜtBuck‘Off£t
 0

	)

399 
	#AuP¬msImpÜtWaveFÜm
 2

	)

400 
	#AuP¬msImpÜtWaveFÜmF»qu’cy
 0

	)

401 
	#AuP¬msImpÜtWaveFÜmNumSam¶es
 1

	)

402 
	#AuP¬msImpÜtRadio
 0

	)

403 
	#AuP¬msBundË
 0

	)

404 
	#AuP¬msMuÉlyCÚ¡ªt
 1

	)

405 
	#AuP¬msMuÉlyCÚ¡ªtCÚ¡ªt
 0

	)

406 
	#AuP¬msAddCÚ¡ªt
 1

	)

407 
	#AuP¬msAddCÚ¡ªtCÚ¡ªt
 0

	)

408 
	#AuP¬msSum
 0

	)

409 
	#AuP¬msExpÜtCl›Á
 0

	)

410 
	#AuP¬msExpÜtDeviû
 0

	)

411 
	#AuP¬msExpÜtBuck‘
 1

	)

412 
	#AuP¬msExpÜtBuck‘Off£t
 0

	)

413 
	#AuP¬msExpÜtRadio
 0

	)

414 
	#AuP¬msExpÜtMÚ™Ü
 0

	)

420 
	#AuS‹Stİ
 0

	)

421 
	#AuS‹S¹
 1

	)

422 
	#AuS‹Pau£
 2

	)

423 
	#AuS‹Any
 255

	)

425 
	#AuEËm’tAùiÚChªgeS‹
 0

	)

426 
	#AuEËm’tAùiÚS’dNÙify
 1

	)

427 
	#AuEËm’tAùiÚNoİ
 2

	)

433 
	#AuWaveFÜmSqu¬e
 0

	)

434 
	#AuWaveFÜmSše
 1

	)

435 
	#AuWaveFÜmSaw
 2

	)

436 
	#AuWaveFÜmCÚ¡ªt
 3

	)

442 
	#AuEËm’tNÙifyKšdLowW©”
 0

	)

443 
	#AuEËm’tNÙifyKšdHighW©”
 1

	)

444 
	#AuEËm’tNÙifyKšdS‹
 2

	)

449 
	#AuR—sÚU£r
 0

	)

450 
	#AuR—sÚUnd”run
 1

	)

451 
	#AuR—sÚOv”run
 2

	)

452 
	#AuR—sÚEOF
 3

	)

453 
	#AuR—sÚW©”m¬k
 4

	)

454 
	#AuR—sÚH¬dw¬e
 5

	)

455 
	#AuR—sÚAny
 255

	)

460 
	#AuG¿bNÙifyKšdReque¡ed
 0

	)

461 
	#AuG¿bNÙifyKšdR–—£d
 1

	)

468 
	#AuT¿nsãrS‹R—dy
 0

	)

469 
	#AuT¿nsãrS‹P’dšg
 1

	)

470 
	#AuT¿nsãrS‹End
 2

	)

	@/usr/include/ctype.h

24 #iâdef 
_CTYPE_H


25 
	#_CTYPE_H
 1

	)

27 
	~<ã©u»s.h
>

28 
	~<b™s/ty³s.h
>

30 
	g__BEGIN_DECLS


32 #iâdeà
_ISb™


41 
	~<’dŸn.h
>

42 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


43 
	#_ISb™
(
b™
è(1 << (b™))

	)

45 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

50 
	m_ISuµ”
 = 
_ISb™
 (0),

51 
	m_ISlow”
 = 
_ISb™
 (1),

52 
	m_IS®pha
 = 
_ISb™
 (2),

53 
	m_ISdig™
 = 
_ISb™
 (3),

54 
	m_ISxdig™
 = 
_ISb™
 (4),

55 
	m_IS¥aû
 = 
_ISb™
 (5),

56 
	m_IS´št
 = 
_ISb™
 (6),

57 
	m_ISg¿ph
 = 
_ISb™
 (7),

58 
	m_ISbÏnk
 = 
_ISb™
 (8),

59 
	m_ISúŒl
 = 
_ISb™
 (9),

60 
	m_ISpunù
 = 
_ISb™
 (10),

61 
	m_IS®num
 = 
_ISb™
 (11)

81 
__cÚ¡
 **
	$__ùy³_b_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

83 
__cÚ¡
 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

85 
__cÚ¡
 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

86 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

91 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

92 
	#__tßscii
(
c
è((cè& 0x7fè

	)

94 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

96 
__BEGIN_NAMESPACE_STD


102 
	`__exùy³
 (
i§Êum
);

103 
	`__exùy³
 (
i§Íha
);

104 
	`__exùy³
 (
isúŒl
);

105 
	`__exùy³
 (
isdig™
);

106 
	`__exùy³
 (
i¦ow”
);

107 
	`__exùy³
 (
isg¿ph
);

108 
	`__exùy³
 (
i¥ršt
);

109 
	`__exùy³
 (
i¥unù
);

110 
	`__exùy³
 (
is¥aû
);

111 
	`__exùy³
 (
isuµ”
);

112 
	`__exùy³
 (
isxdig™
);

116 
	$tŞow”
 (
__c
è
__THROW
;

119 
	$touµ”
 (
__c
è
__THROW
;

121 
__END_NAMESPACE_STD


125 #ifdef 
__USE_ISOC99


126 
__BEGIN_NAMESPACE_C99


128 
	`__exùy³
 (
isbÏnk
);

130 
__END_NAMESPACE_C99


133 #ifdeà
__USE_GNU


135 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

138 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


142 
	$i§scii
 (
__c
è
__THROW
;

146 
	$tßscii
 (
__c
è
__THROW
;

150 
	`__exùy³
 (
_touµ”
);

151 
	`__exùy³
 (
_tŞow”
);

155 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

156 (
__ex‹nsiÚ__
 \

157 ({ 
__»s
; \

158 ià( (
c
) > 1) \

160 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

162 
__c
 = (
c
); \

163 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

166 
__»s
 = 
f
 
¬gs
; \

169 
__»s
 = (
a
)[(è(
c
)]; \

170 
__»s
; 
	}
}))

	)

172 #ià!
defšed
 
__NO_CTYPE
 && !defšed 
__ılu¥lus


173 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

174 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

175 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

176 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

177 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

178 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

179 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

180 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

181 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

182 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

183 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

185 #ifdeà
__USE_ISOC99


186 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

189 #ifdeà
__USE_EXTERN_INLINES


190 
__ex‹º_šlše
 

191 
__NTH
 (
	$tŞow”
 (
__c
))

193  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

194 
	}
}

196 
__ex‹º_šlše
 

197 
__NTH
 (
	$touµ”
 (
__c
))

199  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

200 
	}
}

203 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


204 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

205 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

208 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


209 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

210 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

212 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

213 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

219 #ifdeà
__USE_XOPEN2K8


233 
	~<xloÿË.h
>

237 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

238 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

240 
	#__exùy³_l
(
Çme
) \

241 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

247 
__exùy³_l
 (
i§Êum_l
);

248 
__exùy³_l
 (
i§Íha_l
);

249 
__exùy³_l
 (
isúŒl_l
);

250 
__exùy³_l
 (
isdig™_l
);

251 
__exùy³_l
 (
i¦ow”_l
);

252 
__exùy³_l
 (
isg¿ph_l
);

253 
__exùy³_l
 (
i¥ršt_l
);

254 
__exùy³_l
 (
i¥unù_l
);

255 
__exùy³_l
 (
is¥aû_l
);

256 
__exùy³_l
 (
isuµ”_l
);

257 
__exùy³_l
 (
isxdig™_l
);

259 
__exùy³_l
 (
isbÏnk_l
);

263 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

264 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

267 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

268 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

270 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


271 
	#__tŞow”_l
(
c
, 
loÿË
) \

272 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

273 
	#__touµ”_l
(
c
, 
loÿË
) \

274 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

275 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

276 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

280 #iâdeà
__NO_CTYPE


281 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

282 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

283 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

284 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

285 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

286 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

287 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

288 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

289 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

290 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

291 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

293 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

295 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


296 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

297 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

300 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

301 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

302 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

303 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

304 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

305 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

306 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

307 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

308 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

309 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

310 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

312 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

314 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


315 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

316 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

323 
__END_DECLS


	@/usr/include/dirent.h

23 #iâdef 
_DIRENT_H


24 
	#_DIRENT_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


30 
	~<b™s/ty³s.h
>

32 #ifdeà
__USE_XOPEN


33 #iâdeà
__šo_t_defšed


34 #iâdeà
__USE_FILE_OFFSET64


35 
__šo_t
 
	tšo_t
;

37 
__šo64_t
 
	tšo_t
;

39 
	#__šo_t_defšed


	)

41 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__šo64_t_defšed


42 
__šo64_t
 
	tšo64_t
;

43 
	#__šo64_t_defšed


	)

62 
	~<b™s/dœ’t.h
>

64 #ià(
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
è&& !defšed 
d_f’o


65 
	#d_šo
 
d_f’o


	)

82 #ifdeà
_DIRENT_HAVE_D_NAMLEN


83 
	#_D_EXACT_NAMLEN
(
d
è((d)->
d_ÇmËn
)

	)

84 
	#_D_ALLOC_NAMLEN
(
d
è(
	`_D_EXACT_NAMLEN
 (dè+ 1)

	)

86 
	#_D_EXACT_NAMLEN
(
d
è(
	`¡¾’
 ((d)->
d_Çme
))

	)

87 #ifdeà
_DIRENT_HAVE_D_RECLEN


88 
	#_D_ALLOC_NAMLEN
(
d
è(((*è(dè+ (d)->
d_»ş’
è- &(d)->
d_Çme
[0])

	)

90 
	#_D_ALLOC_NAMLEN
(
d
è( (d)->
d_Çme
 > 1 ?  (d)->d_name : \

91 
	`_D_EXACT_NAMLEN
 (
d
è+ 1)

	)

96 #ifdeà
__USE_BSD


100 
	mDT_UNKNOWN
 = 0,

101 
	#DT_UNKNOWN
 
DT_UNKNOWN


	)

102 
	mDT_FIFO
 = 1,

103 
	#DT_FIFO
 
DT_FIFO


	)

104 
	mDT_CHR
 = 2,

105 
	#DT_CHR
 
DT_CHR


	)

106 
	mDT_DIR
 = 4,

107 
	#DT_DIR
 
DT_DIR


	)

108 
	mDT_BLK
 = 6,

109 
	#DT_BLK
 
DT_BLK


	)

110 
	mDT_REG
 = 8,

111 
	#DT_REG
 
DT_REG


	)

112 
	mDT_LNK
 = 10,

113 
	#DT_LNK
 
DT_LNK


	)

114 
	mDT_SOCK
 = 12,

115 
	#DT_SOCK
 
DT_SOCK


	)

116 
	mDT_WHT
 = 14

117 
	#DT_WHT
 
DT_WHT


	)

121 
	#IFTODT
(
mode
è(((modeè& 0170000è>> 12)

	)

122 
	#DTTOIF
(
dœty³
è((dœty³è<< 12)

	)

128 
__dœ¡»am
 
	tDIR
;

135 
DIR
 *
	$İ’dœ
 (
__cÚ¡
 *
__Çme
è
	`__nÚnuÎ
 ((1));

137 #ifdeà
__USE_XOPEN2K8


142 
DIR
 *
	`fdİ’dœ
 (
__fd
);

150 
	$şo£dœ
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

162 #iâdeà
__USE_FILE_OFFSET64


163 
dœ’t
 *
	$»addœ
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

165 #ifdeà
__REDIRECT


166 
dœ’t
 *
	`__REDIRECT
 (
»addœ
, (
DIR
 *
__dœp
), 
»addœ64
)

167 
	`__nÚnuÎ
 ((1));

169 
	#»addœ
 
»addœ64


	)

173 #ifdeà
__USE_LARGEFILE64


174 
dœ’t64
 *
	$»addœ64
 (
DIR
 *
__dœp
è
	`__nÚnuÎ
 ((1));

177 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


183 #iâdeà
__USE_FILE_OFFSET64


184 
	$»addœ_r
 (
DIR
 *
__»¡riù
 
__dœp
,

185 
dœ’t
 *
__»¡riù
 
__’Œy
,

186 
dœ’t
 **
__»¡riù
 
__»suÉ
)

187 
	`__nÚnuÎ
 ((1, 2, 3));

189 #ifdeà
__REDIRECT


190 
	`__REDIRECT
 (
»addœ_r
,

191 (
DIR
 *
__»¡riù
 
__dœp
,

192 
dœ’t
 *
__»¡riù
 
__’Œy
,

193 
dœ’t
 **
__»¡riù
 
__»suÉ
),

194 
»addœ64_r
è
	`__nÚnuÎ
 ((1, 2, 3));

196 
	#»addœ_r
 
»addœ64_r


	)

200 #ifdeà
__USE_LARGEFILE64


201 
	$»addœ64_r
 (
DIR
 *
__»¡riù
 
__dœp
,

202 
dœ’t64
 *
__»¡riù
 
__’Œy
,

203 
dœ’t64
 **
__»¡riù
 
__»suÉ
)

204 
	`__nÚnuÎ
 ((1, 2, 3));

209 
	$»wšddœ
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

211 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


212 
	~<b™s/ty³s.h
>

215 
	$£ekdœ
 (
DIR
 *
__dœp
, 
__pos
è
__THROW
 
	`__nÚnuÎ
 ((1));

218 
	$‹Îdœ
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

221 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN2K8


224 
	$dœfd
 (
DIR
 *
__dœp
è
__THROW
 
	`__nÚnuÎ
 ((1));

226 #ià
defšed
 
__OPTIMIZE__
 && defšed 
_DIR_dœfd


227 
	#dœfd
(
dœp
è
	`_DIR_dœfd
 (dœp)

	)

230 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC


231 #iâdeà
MAXNAMLEN


233 
	~<b™s/posix1_lim.h
>

236 #ifdeà
NAME_MAX


237 
	#MAXNAMLEN
 
NAME_MAX


	)

239 
	#MAXNAMLEN
 255

	)

244 
	#__Ãed_size_t


	)

245 
	~<¡ddef.h
>

251 #iâdeà
__USE_FILE_OFFSET64


252 
	`sÿndœ
 (
__cÚ¡
 *
__»¡riù
 
__dœ
,

253 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

254 (*
__£ËùÜ
è(
__cÚ¡
 
dœ’t
 *),

255 (*
__cmp
è(
__cÚ¡
 
dœ’t
 **,

256 
__cÚ¡
 
dœ’t
 **))

257 
	`__nÚnuÎ
 ((1, 2));

259 #ifdeà
__REDIRECT


260 
	`__REDIRECT
 (
sÿndœ
,

261 (
__cÚ¡
 *
__»¡riù
 
__dœ
,

262 
dœ’t
 ***
__»¡riù
 
__Çm–i¡
,

263 (*
__£ËùÜ
è(
__cÚ¡
 
dœ’t
 *),

264 (*
__cmp
è(
__cÚ¡
 
dœ’t
 **,

265 
__cÚ¡
 
dœ’t
 **)),

266 
sÿndœ64
è
	`__nÚnuÎ
 ((1, 2));

268 
	#sÿndœ
 
sÿndœ64


	)

272 #ià
defšed
 
__USE_GNU
 && defšed 
__USE_LARGEFILE64


275 
	`sÿndœ64
 (
__cÚ¡
 *
__»¡riù
 
__dœ
,

276 
dœ’t64
 ***
__»¡riù
 
__Çm–i¡
,

277 (*
__£ËùÜ
è(
__cÚ¡
 
dœ’t64
 *),

278 (*
__cmp
è(
__cÚ¡
 
dœ’t64
 **,

279 
__cÚ¡
 
dœ’t64
 **))

280 
	`__nÚnuÎ
 ((1, 2));

284 #iâdeà
__USE_FILE_OFFSET64


285 
	$®phasÜt
 (
__cÚ¡
 
dœ’t
 **
__e1
,

286 
__cÚ¡
 
dœ’t
 **
__e2
)

287 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

289 #ifdeà
__REDIRECT


290 
	`__REDIRECT_NTH
 (
®phasÜt
,

291 (
__cÚ¡
 
dœ’t
 **
__e1
,

292 
__cÚ¡
 
dœ’t
 **
__e2
),

293 
®phasÜt64
è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 
	#®phasÜt
 
®phasÜt64


	)

299 #ià
defšed
 
__USE_GNU
 && defšed 
__USE_LARGEFILE64


300 
	$®phasÜt64
 (
__cÚ¡
 
dœ’t64
 **
__e1
,

301 
__cÚ¡
 
dœ’t64
 **
__e2
)

302 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

307 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC


312 #iâdeà
__USE_FILE_OFFSET64


313 
__ssize_t
 
	$g‘dœ’Œ›s
 (
__fd
, *
__»¡riù
 
__buf
,

314 
size_t
 
__nby‹s
,

315 
__off_t
 *
__»¡riù
 
__ba£p
)

316 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

318 #ifdeà
__REDIRECT


319 
__ssize_t
 
	`__REDIRECT_NTH
 (
g‘dœ’Œ›s
,

320 (
__fd
, *
__»¡riù
 
__buf
,

321 
size_t
 
__nby‹s
,

322 
__off64_t
 *
__»¡riù
 
__ba£p
),

323 
g‘dœ’Œ›s64
è
	`__nÚnuÎ
 ((2, 4));

325 
	#g‘dœ’Œ›s
 
g‘dœ’Œ›s64


	)

329 #ifdeà
__USE_LARGEFILE64


330 
__ssize_t
 
	$g‘dœ’Œ›s64
 (
__fd
, *
__»¡riù
 
__buf
,

331 
size_t
 
__nby‹s
,

332 
__off64_t
 *
__»¡riù
 
__ba£p
)

333 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

337 #ifdeà
__USE_GNU


339 #iâdeà
__USE_FILE_OFFSET64


340 
	$v”siÚsÜt
 (
__cÚ¡
 
dœ’t
 **
__e1
,

341 
__cÚ¡
 
dœ’t
 **
__e2
)

342 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

344 #ifdeà
__REDIRECT


345 
	`__REDIRECT_NTH
 (
v”siÚsÜt
,

346 (
__cÚ¡
 
dœ’t
 **
__e1
,

347 
__cÚ¡
 
dœ’t
 **
__e2
),

348 
v”siÚsÜt64
)

349 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

351 
	#v”siÚsÜt
 
v”siÚsÜt64


	)

355 #ifdeà
__USE_LARGEFILE64


356 
	$v”siÚsÜt64
 (
__cÚ¡
 
dœ’t64
 **
__e1
,

357 
__cÚ¡
 
dœ’t64
 **
__e2
)

358 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

362 
__END_DECLS


	@/usr/include/inttypes.h

23 #iâdeà
_INTTYPES_H


24 
	#_INTTYPES_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	~<¡dšt.h
>

31 #iâdeà
____gwch¬_t_defšed


32 #ifdeà
__ılu¥lus


33 
	#__gwch¬_t
 
wch¬_t


	)

34 #–ià
defšed
 
__WCHAR_TYPE__


35 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

37 
	#__Ãed_wch¬_t


	)

38 
	~<¡ddef.h
>

39 
wch¬_t
 
	t__gwch¬_t
;

41 
	#____gwch¬_t_defšed
 1

	)

47 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_FORMAT_MACROS


49 #ià
__WORDSIZE
 == 64

50 
	#__PRI64_PREFIX
 "l"

	)

51 
	#__PRIPTR_PREFIX
 "l"

	)

53 
	#__PRI64_PREFIX
 "Î"

	)

54 
	#__PRIPTR_PREFIX


	)

60 
	#PRId8
 "d"

	)

61 
	#PRId16
 "d"

	)

62 
	#PRId32
 "d"

	)

63 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

65 
	#PRIdLEAST8
 "d"

	)

66 
	#PRIdLEAST16
 "d"

	)

67 
	#PRIdLEAST32
 "d"

	)

68 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIdFAST8
 "d"

	)

71 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

72 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

73 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

76 
	#PRIi8
 "i"

	)

77 
	#PRIi16
 "i"

	)

78 
	#PRIi32
 "i"

	)

79 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

81 
	#PRIiLEAST8
 "i"

	)

82 
	#PRIiLEAST16
 "i"

	)

83 
	#PRIiLEAST32
 "i"

	)

84 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIiFAST8
 "i"

	)

87 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

88 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

89 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

92 
	#PRIo8
 "o"

	)

93 
	#PRIo16
 "o"

	)

94 
	#PRIo32
 "o"

	)

95 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

97 
	#PRIoLEAST8
 "o"

	)

98 
	#PRIoLEAST16
 "o"

	)

99 
	#PRIoLEAST32
 "o"

	)

100 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIoFAST8
 "o"

	)

103 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

104 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

105 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

108 
	#PRIu8
 "u"

	)

109 
	#PRIu16
 "u"

	)

110 
	#PRIu32
 "u"

	)

111 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

113 
	#PRIuLEAST8
 "u"

	)

114 
	#PRIuLEAST16
 "u"

	)

115 
	#PRIuLEAST32
 "u"

	)

116 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIuFAST8
 "u"

	)

119 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

120 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

121 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

124 
	#PRIx8
 "x"

	)

125 
	#PRIx16
 "x"

	)

126 
	#PRIx32
 "x"

	)

127 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

129 
	#PRIxLEAST8
 "x"

	)

130 
	#PRIxLEAST16
 "x"

	)

131 
	#PRIxLEAST32
 "x"

	)

132 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIxFAST8
 "x"

	)

135 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

136 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

137 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

140 
	#PRIX8
 "X"

	)

141 
	#PRIX16
 "X"

	)

142 
	#PRIX32
 "X"

	)

143 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

145 
	#PRIXLEAST8
 "X"

	)

146 
	#PRIXLEAST16
 "X"

	)

147 
	#PRIXLEAST32
 "X"

	)

148 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

150 
	#PRIXFAST8
 "X"

	)

151 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

152 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

153 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

157 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

158 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

159 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

160 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

161 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

162 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

166 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

167 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

168 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

169 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

170 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

171 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

177 
	#SCNd8
 "hhd"

	)

178 
	#SCNd16
 "hd"

	)

179 
	#SCNd32
 "d"

	)

180 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

182 
	#SCNdLEAST8
 "hhd"

	)

183 
	#SCNdLEAST16
 "hd"

	)

184 
	#SCNdLEAST32
 "d"

	)

185 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNdFAST8
 "hhd"

	)

188 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

189 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

190 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

193 
	#SCNi8
 "hhi"

	)

194 
	#SCNi16
 "hi"

	)

195 
	#SCNi32
 "i"

	)

196 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

198 
	#SCNiLEAST8
 "hhi"

	)

199 
	#SCNiLEAST16
 "hi"

	)

200 
	#SCNiLEAST32
 "i"

	)

201 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNiFAST8
 "hhi"

	)

204 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

205 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

206 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

209 
	#SCNu8
 "hhu"

	)

210 
	#SCNu16
 "hu"

	)

211 
	#SCNu32
 "u"

	)

212 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

214 
	#SCNuLEAST8
 "hhu"

	)

215 
	#SCNuLEAST16
 "hu"

	)

216 
	#SCNuLEAST32
 "u"

	)

217 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNuFAST8
 "hhu"

	)

220 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

221 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

222 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

225 
	#SCNo8
 "hho"

	)

226 
	#SCNo16
 "ho"

	)

227 
	#SCNo32
 "o"

	)

228 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

230 
	#SCNoLEAST8
 "hho"

	)

231 
	#SCNoLEAST16
 "ho"

	)

232 
	#SCNoLEAST32
 "o"

	)

233 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNoFAST8
 "hho"

	)

236 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

237 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

238 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

241 
	#SCNx8
 "hhx"

	)

242 
	#SCNx16
 "hx"

	)

243 
	#SCNx32
 "x"

	)

244 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

246 
	#SCNxLEAST8
 "hhx"

	)

247 
	#SCNxLEAST16
 "hx"

	)

248 
	#SCNxLEAST32
 "x"

	)

249 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

251 
	#SCNxFAST8
 "hhx"

	)

252 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

253 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

254 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

258 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

259 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

260 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

261 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

262 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

265 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

266 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

267 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

268 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

269 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

274 
	g__BEGIN_DECLS


276 #ià
__WORDSIZE
 == 64

281 
	mquÙ
;

282 
	m»m
;

283 } 
	timaxdiv_t
;

290 
	mquÙ
;

291 
	m»m
;

292 } 
	timaxdiv_t
;

298 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

301 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

302 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

305 
štmax_t
 
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

306 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

309 
uštmax_t
 
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

310 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

313 
štmax_t
 
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

314 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

315 
__THROW
;

318 
uštmax_t
 
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

319 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

320 
__THROW
;

322 #ifdeà
__USE_EXTERN_INLINES


324 #ià
__WORDSIZE
 == 64

326 
	$__¡¹Ş_š‹º®
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

327 **
__»¡riù
 
__’d±r
,

328 
__ba£
, 
__group
)

329 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

331 
__ex‹º_šlše
 
štmax_t


332 
	`__NTH
 (
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

333 
ba£
))

335  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

336 
	}
}

338 
	$__¡¹oul_š‹º®
 (
__cÚ¡
 *

339 
__»¡riù
 
__ÅŒ
,

340 ** 
__»¡riù
 
__’d±r
,

341 
__ba£
, 
__group
)

342 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

344 
__ex‹º_šlše
 
uštmax_t


345 
	`__NTH
 (
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

346 
ba£
))

348  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

349 
	}
}

351 
	$__wc¡Ş_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

352 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

353 
__ba£
, 
__group
)

354 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

356 
__ex‹º_šlše
 
štmax_t


357 
	`__NTH
 (
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

358 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

360  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

361 
	}
}

363 
	$__wc¡oul_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

364 
__»¡riù
 
__ÅŒ
,

365 
__gwch¬_t
 **

366 
__»¡riù
 
__’d±r
,

367 
__ba£
, 
__group
)

368 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

370 
__ex‹º_šlše
 
uštmax_t


371 
	`__NTH
 (
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

372 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

374  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

375 
	}
}

379 
__ex‹nsiÚ__


380 
	$__¡¹Şl_š‹º®
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

381 **
__»¡riù
 
__’d±r
,

382 
__ba£
, 
__group
)

383 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

385 
__ex‹º_šlše
 
štmax_t


386 
	`__NTH
 (
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

387 
ba£
))

389  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

390 
	}
}

392 
__ex‹nsiÚ__


393 
	$__¡¹ouÎ_š‹º®
 (
__cÚ¡
 *

394 
__»¡riù
 
__ÅŒ
,

396 
__»¡riù
 
__’d±r
,

397 
__ba£
,

398 
__group
)

399 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

401 
__ex‹º_šlše
 
uštmax_t


402 
	`__NTH
 (
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

403 
ba£
))

405  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

406 
	}
}

408 
__ex‹nsiÚ__


409 
	$__wc¡Şl_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

410 
__»¡riù
 
__ÅŒ
,

411 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

412 
__ba£
, 
__group
)

413 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

415 
__ex‹º_šlše
 
štmax_t


416 
	`__NTH
 (
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

417 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

419  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

420 
	}
}

423 
__ex‹nsiÚ__


424 
	$__wc¡ouÎ_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

425 
__»¡riù
 
__ÅŒ
,

426 
__gwch¬_t
 **

427 
__»¡riù
 
__’d±r
,

428 
__ba£
,

429 
__group
)

430 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

432 
__ex‹º_šlše
 
uštmax_t


433 
	`__NTH
 (
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

434 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

436  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

437 
	}
}

442 
	g__END_DECLS


	@/usr/include/linux/usbdevice_fs.h

29 #iâdeà
_LINUX_USBDEVICE_FS_H


30 
	#_LINUX_USBDEVICE_FS_H


	)

32 
	~<lšux/ty³s.h
>

33 
	~<lšux/magic.h
>

39 
	susbdevfs_ù¾Œªsãr
 {

40 
__u8
 
	mbReque¡Ty³
;

41 
__u8
 
	mbReque¡
;

42 
__u16
 
	mwV®ue
;

43 
__u16
 
	mwIndex
;

44 
__u16
 
	mwL’gth
;

45 
__u32
 
	mtimeout
;

46 *
	md©a
;

49 
	susbdevfs_bulkŒªsãr
 {

50 
	m•
;

51 
	mËn
;

52 
	mtimeout
;

53 *
	md©a
;

56 
	susbdevfs_£tš‹rçû
 {

57 
	mš‹rçû
;

58 
	m®t£‰šg
;

61 
	susbdevfs_discÚÃùsigÇl
 {

62 
	msigÄ
;

63 *
	mcÚ‹xt
;

66 
	#USBDEVFS_MAXDRIVERNAME
 255

	)

68 
	susbdevfs_g‘driv”
 {

69 
	mš‹rçû
;

70 
	mdriv”
[
USBDEVFS_MAXDRIVERNAME
 + 1];

73 
	susbdevfs_cÚÃùšfo
 {

74 
	mdevnum
;

75 
	m¦ow
;

78 
	#USBDEVFS_URB_SHORT_NOT_OK
 0x01

	)

79 
	#USBDEVFS_URB_ISO_ASAP
 0x02

	)

80 
	#USBDEVFS_URB_BULK_CONTINUATION
 0x04

	)

81 
	#USBDEVFS_URB_NO_FSBR
 0x20

	)

82 
	#USBDEVFS_URB_ZERO_PACKET
 0x40

	)

83 
	#USBDEVFS_URB_NO_INTERRUPT
 0x80

	)

85 
	#USBDEVFS_URB_TYPE_ISO
 0

	)

86 
	#USBDEVFS_URB_TYPE_INTERRUPT
 1

	)

87 
	#USBDEVFS_URB_TYPE_CONTROL
 2

	)

88 
	#USBDEVFS_URB_TYPE_BULK
 3

	)

90 
	susbdevfs_iso_·ck‘_desc
 {

91 
	mËngth
;

92 
	maùu®_Ëngth
;

93 
	m¡©us
;

96 
	susbdevfs_urb
 {

97 
	mty³
;

98 
	m’dpošt
;

99 
	m¡©us
;

100 
	mæags
;

101 *
	mbufãr
;

102 
	mbufãr_Ëngth
;

103 
	maùu®_Ëngth
;

104 
	m¡¬t_äame
;

105 
	mnumb”_of_·ck‘s
;

106 
	m”rÜ_couÁ
;

107 
	msigÄ
;

109 *
	mu£rcÚ‹xt
;

110 
usbdevfs_iso_·ck‘_desc
 
	miso_äame_desc
[0];

114 
	susbdevfs_ioùl
 {

115 
	miâo
;

116 
	mioùl_code
;

118 *
	md©a
;

123 
	susbdevfs_hub_pÜtšfo
 {

124 
	mÅÜts
;

125 
	mpÜt
 [127];

129 
	#USBDEVFS_CONTROL
 
	`_IOWR
('U', 0, 
usbdevfs_ù¾Œªsãr
)

	)

130 
	#USBDEVFS_CONTROL32
 
	`_IOWR
('U', 0, 
usbdevfs_ù¾Œªsãr32
)

	)

131 
	#USBDEVFS_BULK
 
	`_IOWR
('U', 2, 
usbdevfs_bulkŒªsãr
)

	)

132 
	#USBDEVFS_BULK32
 
	`_IOWR
('U', 2, 
usbdevfs_bulkŒªsãr32
)

	)

133 
	#USBDEVFS_RESETEP
 
	`_IOR
('U', 3, )

	)

134 
	#USBDEVFS_SETINTERFACE
 
	`_IOR
('U', 4, 
usbdevfs_£tš‹rçû
)

	)

135 
	#USBDEVFS_SETCONFIGURATION
 
	`_IOR
('U', 5, )

	)

136 
	#USBDEVFS_GETDRIVER
 
	`_IOW
('U', 8, 
usbdevfs_g‘driv”
)

	)

137 
	#USBDEVFS_SUBMITURB
 
	`_IOR
('U', 10, 
usbdevfs_urb
)

	)

138 
	#USBDEVFS_SUBMITURB32
 
	`_IOR
('U', 10, 
usbdevfs_urb32
)

	)

139 
	#USBDEVFS_DISCARDURB
 
	`_IO
('U', 11)

	)

140 
	#USBDEVFS_REAPURB
 
	`_IOW
('U', 12, *)

	)

141 
	#USBDEVFS_REAPURB32
 
	`_IOW
('U', 12, 
__u32
)

	)

142 
	#USBDEVFS_REAPURBNDELAY
 
	`_IOW
('U', 13, *)

	)

143 
	#USBDEVFS_REAPURBNDELAY32
 
	`_IOW
('U', 13, 
__u32
)

	)

144 
	#USBDEVFS_DISCSIGNAL
 
	`_IOR
('U', 14, 
usbdevfs_discÚÃùsigÇl
)

	)

145 
	#USBDEVFS_DISCSIGNAL32
 
	`_IOR
('U', 14, 
usbdevfs_discÚÃùsigÇl32
)

	)

146 
	#USBDEVFS_CLAIMINTERFACE
 
	`_IOR
('U', 15, )

	)

147 
	#USBDEVFS_RELEASEINTERFACE
 
	`_IOR
('U', 16, )

	)

148 
	#USBDEVFS_CONNECTINFO
 
	`_IOW
('U', 17, 
usbdevfs_cÚÃùšfo
)

	)

149 
	#USBDEVFS_IOCTL
 
	`_IOWR
('U', 18, 
usbdevfs_ioùl
)

	)

150 
	#USBDEVFS_IOCTL32
 
	`_IOWR
('U', 18, 
usbdevfs_ioùl32
)

	)

151 
	#USBDEVFS_HUB_PORTINFO
 
	`_IOR
('U', 19, 
usbdevfs_hub_pÜtšfo
)

	)

152 
	#USBDEVFS_RESET
 
	`_IO
('U', 20)

	)

153 
	#USBDEVFS_CLEAR_HALT
 
	`_IOR
('U', 21, )

	)

154 
	#USBDEVFS_DISCONNECT
 
	`_IO
('U', 22)

	)

155 
	#USBDEVFS_CONNECT
 
	`_IO
('U', 23)

	)

156 
	#USBDEVFS_CLAIM_PORT
 
	`_IOR
('U', 24, )

	)

157 
	#USBDEVFS_RELEASE_PORT
 
	`_IOR
('U', 25, )

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 132646

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/signal.h

23 #iâdef 
_SIGNAL_H


25 #ià!
defšed
 
__Ãed_sig_©omic_t
 && !defšed 
__Ãed_sig£t_t


26 
	#_SIGNAL_H


	)

29 
	~<ã©u»s.h
>

31 
	g__BEGIN_DECLS


33 
	~<b™s/sig£t.h
>

37 #ià
defšed
 
__Ãed_sig_©omic_t
 || defšed 
_SIGNAL_H


38 #iâdeà
__sig_©omic_t_defšed


39 
	#__sig_©omic_t_defšed


	)

40 
__BEGIN_NAMESPACE_STD


41 
__sig_©omic_t
 
	tsig_©omic_t
;

42 
	g__END_NAMESPACE_STD


44 #undeà
__Ãed_sig_©omic_t


47 #ià
defšed
 
__Ãed_sig£t_t
 || (defšed 
_SIGNAL_H
 && defšed 
__USE_POSIX
)

48 #iâdeà
__sig£t_t_defšed


49 
	#__sig£t_t_defšed


	)

50 
__sig£t_t
 
	tsig£t_t
;

52 #undeà
__Ãed_sig£t_t


55 #ifdeà
_SIGNAL_H


57 
	~<b™s/ty³s.h
>

58 
	~<b™s/signum.h
>

60 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


61 #iâdeà
__pid_t_defšed


62 
__pid_t
 
	tpid_t
;

63 
	#__pid_t_defšed


	)

65 #ifdeà
__USE_XOPEN


67 #iâdeà
__uid_t_defšed


68 
__uid_t
 
	tuid_t
;

69 
	#__uid_t_defšed


	)

73 #ifdeà
__USE_POSIX199309


75 
	#__Ãed_time¥ec


	)

76 
	~<time.h
>

79 
	~<b™s/sigšfo.h
>

84 (*
	t__sighªdËr_t
) ();

89 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

90 
__THROW
;

91 #ifdeà
__USE_GNU


92 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

93 
__THROW
;

99 
__BEGIN_NAMESPACE_STD


100 #ifdeà
__USE_BSD


101 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

102 
__THROW
;

105 #ifdeà
__REDIRECT_NTH


106 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

107 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

108 
__sysv_sigÇl
);

110 
	#sigÇl
 
__sysv_sigÇl


	)

113 
__END_NAMESPACE_STD


115 #ifdeà
__USE_XOPEN


118 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

119 
__THROW
;

125 #ifdeà
__USE_POSIX


126 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

129 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


133 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

136 
__BEGIN_NAMESPACE_STD


138 
	$¿i£
 (
__sig
è
__THROW
;

139 
__END_NAMESPACE_STD


141 #ifdeà
__USE_SVID


143 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

144 
__THROW
;

145 
	$gsigÇl
 (
__sig
è
__THROW
;

148 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN2K


150 
	`psigÇl
 (
__sig
, 
__cÚ¡
 *
__s
);

153 #ifdeà
__USE_XOPEN2K


155 
	`psigšfo
 (
__cÚ¡
 
sigšfo_t
 *
__pšfo
, __cÚ¡ *
__s
);

168 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

170 #ifdeà
__FAVOR_BSD


173 
	$sig·u£
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

175 #ifdeà
__USE_XOPEN


176 #ifdeà
__GNUC__


177 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

180 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

186 #ifdeà
__USE_BSD


193 
	#sigmask
(
sig
è
	`__sigmask
(sig)

	)

196 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

199 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

202 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

206 #ifdeà
__USE_MISC


207 
	#NSIG
 
_NSIG


	)

210 #ifdeà
__USE_GNU


211 
__sighªdËr_t
 
	tsighªdËr_t
;

215 #ifdeà
__USE_BSD


216 
__sighªdËr_t
 
	tsig_t
;

219 #ifdeà
__USE_POSIX


222 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

225 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

228 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

231 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

234 
	$sigismemb”
 (
__cÚ¡
 
sig£t_t
 *
__£t
, 
__signo
)

235 
__THROW
 
	`__nÚnuÎ
 ((1));

237 #ifdeà
__USE_GNU


239 
	$sigi£m±y£t
 (
__cÚ¡
 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

242 
	$sigªd£t
 (
sig£t_t
 *
__£t
, 
__cÚ¡
 sig£t_ˆ*
__Ëá
,

243 
__cÚ¡
 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

246 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, 
__cÚ¡
 sig£t_ˆ*
__Ëá
,

247 
__cÚ¡
 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

252 
	~<b™s/sigaùiÚ.h
>

255 
	$sig´ocmask
 (
__how
, 
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
,

256 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

263 
	$sigsu¥’d
 (
__cÚ¡
 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

266 
	$sigaùiÚ
 (
__sig
, 
__cÚ¡
 
sigaùiÚ
 *
__»¡riù
 
__aù
,

267 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

270 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

277 
	$sigwa™
 (
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

278 
	`__nÚnuÎ
 ((1, 2));

280 #ifdeà
__USE_POSIX199309


285 
	$sigwa™šfo
 (
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
,

286 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

293 
	$sigtimedwa™
 (
__cÚ¡
 
sig£t_t
 *
__»¡riù
 
__£t
,

294 
sigšfo_t
 *
__»¡riù
 
__šfo
,

295 
__cÚ¡
 
time¥ec
 *
__»¡riù
 
__timeout
)

296 
	`__nÚnuÎ
 ((1));

300 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, 
__cÚ¡
 
sigv®
 
__v®
)

301 
__THROW
;

306 #ifdeà
__USE_BSD


310 
__cÚ¡
 *__cÚ¡ 
_sys_sigli¡
[
_NSIG
];

311 
__cÚ¡
 *__cÚ¡ 
sys_sigli¡
[
_NSIG
];

314 
	ssigvec


316 
__sighªdËr_t
 
sv_hªdËr
;

317 
sv_mask
;

319 
sv_æags
;

320 
	#sv_Ú¡ack
 
sv_æags


	)

324 
	#SV_ONSTACK
 (1 << 0)

	)

325 
	#SV_INTERRUPT
 (1 << 1)

	)

326 
	#SV_RESETHAND
 (1 << 2)

	)

334 
	$sigvec
 (
__sig
, 
__cÚ¡
 
sigvec
 *
__vec
,

335 
sigvec
 *
__ovec
è
__THROW
;

339 
	~<b™s/sigcÚ‹xt.h
>

342 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

347 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


348 
	#__Ãed_size_t


	)

349 
	~<¡ddef.h
>

354 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

356 
	~<b™s/sig¡ack.h
>

357 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


359 
	~<sys/ucÚ‹xt.h
>

365 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

366 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

370 
	$sig®t¡ack
 (
__cÚ¡
 
sig®t¡ack
 *
__»¡riù
 
__ss
,

371 
sig®t¡ack
 *
__»¡riù
 
__oss
è
__THROW
;

375 #ifdeà
__USE_XOPEN_EXTENDED


379 
	$sighŞd
 (
__sig
è
__THROW
;

382 
	$sig»l£
 (
__sig
è
__THROW
;

385 
	$sigignÜe
 (
__sig
è
__THROW
;

388 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

391 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


394 
	~<b™s/±h»adty³s.h
>

395 
	~<b™s/sigth»ad.h
>

402 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

404 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

408 
__END_DECLS


	@/usr/include/sys/ioctl.h

19 #iâdef 
_SYS_IOCTL_H


20 
	#_SYS_IOCTL_H
 1

	)

22 
	~<ã©u»s.h
>

24 
	g__BEGIN_DECLS


27 
	~<b™s/ioùls.h
>

30 
	~<b™s/ioùl-ty³s.h
>

37 
	~<sys/‰ydeçuÉs.h
>

42 
	$ioùl
 (
__fd
, 
__»que¡
, ...è
__THROW
;

44 
__END_DECLS


	@/usr/include/audio/Amd.h

101 #iâdeà
XMD_H


102 
	#XMD_H
 1

	)

104 #iâdeà
AMD_H


105 
	#AMD_H
 1

	)

114 #ifdeà
CRAY


115 
	#WORD64


	)

117 #ià
defšed
 (
_LP64
) || \

118 
defšed
(
__®pha
è|| defšed(
__®pha__
) || \

119 
defšed
(
__Ÿ64__
è|| defšed(
Ÿ64
) || \

120 
defšed
(
__¥¬c64__
) || \

121 
defšed
(
__s390x__
) || \

122 (
defšed
(
__hµa__
è&& defšed(
__LP64__
)) || \

123 
defšed
(
__amd64__
è|| defšed(
amd64
) || \

124 
defšed
(
__pow”pc64__
) || \

125 (
defšed
(
sgi
è&& (
	g_MIPS_SZLONG
 == 64))

126 
	#LONG64


	)

133 #ifdeà
WORD64


134 
	#MUSTCOPY


	)

152 #ià((
defšed
(
__STDC__
è|| defšed(
__ılu¥lus
è|| defšed(
c_¶u¥lus
)è&& !defšed(
UNIXCPP
)è|| defšed(
ANSICPP
)

153 
	#_SIZEOF
(
x
è
sz_
##
	)
x

154 
	#SIZEOF
(
x
è
	`_SIZEOF
(x)

	)

156 
	#SIZEOF
(
x
è
sz_
 
	)
x

164 #ifdeà
WORD64


165 
	tINT64
;

166 
	tCARD64
;

167 
	#B32
 :32

	)

168 
	#B16
 :16

	)

169 #ifdeà
UNSIGNEDBITFIELDS


170 
	tINT32
;

171 
	tINT16
;

173 #ifdeà
__STDC__


174 sigÃd 
	tINT32
;

175 sigÃd 
	tINT16
;

177 
	tINT32
;

178 
	tINT16
;

182 
	#B32


	)

183 
	#B16


	)

184 #ifdeà
LONG64


185 
	tINT64
;

186 
	tINT32
;

188 
	tINT32
;

190 
	tINT16
;

193 #ià
defšed
(
__STDC__
è|| defšed(
sgi
è|| defšed(
AIXV3
)

194 sigÃd 
	tINT8
;

196 
	tINT8
;

199 #ifdeà
LONG64


200 
	tCARD64
;

201 
	tCARD32
;

203 
	tCARD32
;

205 
	tCARD16
;

206 
	tCARD8
;

208 
CARD32
 
	tBITS32
;

209 
CARD16
 
	tBITS16
;

211 #iâdeà
I_NEED_OS2_H


212 
CARD8
 
	tBYTE
;

213 
CARD8
 
	tBOOL
;

215 
	#BYTE
 
CARD8


	)

216 
	#BOOL
 
CARD8


	)

219 #iâdeà
WIN32


220 
BOOL
 
	tAUBOOL
;

222 
	tAUBOOL
;

229 #ià
defšed
(
WORD64
è&& defšed(
UNSIGNEDBITFIELDS
)

230 
	#cvtINT8toIÁ
(
v®
è(((v®è& 0x00000080è? ((v®è| 0xffffffffffffff00è: (v®))

	)

231 
	#cvtINT16toIÁ
(
v®
è(((v®è& 0x00008000è? ((v®è| 0xffffffffffff0000è: (v®))

	)

232 
	#cvtINT32toIÁ
(
v®
è(((v®è& 0x80000000è? ((v®è| 0xffffffff00000000è: (v®))

	)

233 
	#cvtINT8toShÜt
(
v®
è
	`cvtINT8toIÁ
(v®)

	)

234 
	#cvtINT16toShÜt
(
v®
è
	`cvtINT16toIÁ
(v®)

	)

235 
	#cvtINT32toShÜt
(
v®
è
	`cvtINT32toIÁ
(v®)

	)

236 
	#cvtINT8toLÚg
(
v®
è
	`cvtINT8toIÁ
(v®)

	)

237 
	#cvtINT16toLÚg
(
v®
è
	`cvtINT16toIÁ
(v®)

	)

238 
	#cvtINT32toLÚg
(
v®
è
	`cvtINT32toIÁ
(v®)

	)

240 
	#cvtINT8toIÁ
(
v®
è(v®)

	)

241 
	#cvtINT16toIÁ
(
v®
è(v®)

	)

242 
	#cvtINT32toIÁ
(
v®
è(v®)

	)

243 
	#cvtINT8toShÜt
(
v®
è(v®)

	)

244 
	#cvtINT16toShÜt
(
v®
è(v®)

	)

245 
	#cvtINT32toShÜt
(
v®
è(v®)

	)

246 
	#cvtINT8toLÚg
(
v®
è(v®)

	)

247 
	#cvtINT16toLÚg
(
v®
è(v®)

	)

248 
	#cvtINT32toLÚg
(
v®
è(v®)

	)

253 #ifdeà
MUSTCOPY


257 
	#NEXTPTR
(
p
,
t
è(((*èpè+ 
	`SIZEOF
Ñ))

	)

263 
	#NEXTPTR
(
p
,
t
è((Ñ *)Õ)è+ 1)

	)

	@/usr/include/bits/dirent.h

19 #iâdeà
_DIRENT_H


23 
	sdœ’t


25 #iâdeà
__USE_FILE_OFFSET64


26 
__šo_t
 
	md_šo
;

27 
__off_t
 
	md_off
;

29 
__šo64_t
 
	md_šo
;

30 
__off64_t
 
	md_off
;

32 
	md_»ş’
;

33 
	md_ty³
;

34 
	md_Çme
[256];

37 #ifdeà
__USE_LARGEFILE64


38 
	sdœ’t64


40 
__šo64_t
 
	md_šo
;

41 
__off64_t
 
	md_off
;

42 
	md_»ş’
;

43 
	md_ty³
;

44 
	md_Çme
[256];

48 
	#d_f’o
 
d_šo


	)

50 #undeà
_DIRENT_HAVE_D_NAMLEN


51 
	#_DIRENT_HAVE_D_RECLEN


	)

52 
	#_DIRENT_HAVE_D_OFF


	)

53 
	#_DIRENT_HAVE_D_TYPE


	)

	@/usr/include/bits/ioctl-types.h

20 #iâdeà
_SYS_IOCTL_H


25 
	~<asm/ioùls.h
>

28 
	swšsize


30 
	mws_row
;

31 
	mws_cŞ
;

32 
	mws_xpix–
;

33 
	mws_ypix–
;

36 
	#NCC
 8

	)

37 
	s‹rmio


39 
	mc_iæag
;

40 
	mc_oæag
;

41 
	mc_cæag
;

42 
	mc_læag
;

43 
	mc_lše
;

44 
	mc_cc
[
NCC
];

48 
	#TIOCM_LE
 0x001

	)

49 
	#TIOCM_DTR
 0x002

	)

50 
	#TIOCM_RTS
 0x004

	)

51 
	#TIOCM_ST
 0x008

	)

52 
	#TIOCM_SR
 0x010

	)

53 
	#TIOCM_CTS
 0x020

	)

54 
	#TIOCM_CAR
 0x040

	)

55 
	#TIOCM_RNG
 0x080

	)

56 
	#TIOCM_DSR
 0x100

	)

57 
	#TIOCM_CD
 
TIOCM_CAR


	)

58 
	#TIOCM_RI
 
TIOCM_RNG


	)

63 
	#N_TTY
 0

	)

64 
	#N_SLIP
 1

	)

65 
	#N_MOUSE
 2

	)

66 
	#N_PPP
 3

	)

67 
	#N_STRIP
 4

	)

68 
	#N_AX25
 5

	)

69 
	#N_X25
 6

	)

70 
	#N_6PACK
 7

	)

71 
	#N_MASC
 8

	)

72 
	#N_R3964
 9

	)

73 
	#N_PROFIBUS_FDL
 10

	)

74 
	#N_IRDA
 11

	)

75 
	#N_SMSBLOCK
 12

	)

76 
	#N_HDLC
 13

	)

77 
	#N_SYNC_PPP
 14

	)

78 
	#N_HCI
 15

	)

	@/usr/include/bits/ioctls.h

19 #iâdeà
_SYS_IOCTL_H


24 
	~<asm/ioùls.h
>

27 
	#SIOCADDRT
 0x890B

	)

28 
	#SIOCDELRT
 0x890C

	)

29 
	#SIOCRTMSG
 0x890D

	)

32 
	#SIOCGIFNAME
 0x8910

	)

33 
	#SIOCSIFLINK
 0x8911

	)

34 
	#SIOCGIFCONF
 0x8912

	)

35 
	#SIOCGIFFLAGS
 0x8913

	)

36 
	#SIOCSIFFLAGS
 0x8914

	)

37 
	#SIOCGIFADDR
 0x8915

	)

38 
	#SIOCSIFADDR
 0x8916

	)

39 
	#SIOCGIFDSTADDR
 0x8917

	)

40 
	#SIOCSIFDSTADDR
 0x8918

	)

41 
	#SIOCGIFBRDADDR
 0x8919

	)

42 
	#SIOCSIFBRDADDR
 0x891¨

	)

43 
	#SIOCGIFNETMASK
 0x891b

	)

44 
	#SIOCSIFNETMASK
 0x891ø

	)

45 
	#SIOCGIFMETRIC
 0x891d

	)

46 
	#SIOCSIFMETRIC
 0x891

	)

47 
	#SIOCGIFMEM
 0x891à

	)

48 
	#SIOCSIFMEM
 0x8920

	)

49 
	#SIOCGIFMTU
 0x8921

	)

50 
	#SIOCSIFMTU
 0x8922

	)

51 
	#SIOCSIFNAME
 0x8923

	)

52 
	#SIOCSIFHWADDR
 0x8924

	)

53 
	#SIOCGIFENCAP
 0x8925

	)

54 
	#SIOCSIFENCAP
 0x8926

	)

55 
	#SIOCGIFHWADDR
 0x8927

	)

56 
	#SIOCGIFSLAVE
 0x8929

	)

57 
	#SIOCSIFSLAVE
 0x8930

	)

58 
	#SIOCADDMULTI
 0x8931

	)

59 
	#SIOCDELMULTI
 0x8932

	)

60 
	#SIOCGIFINDEX
 0x8933

	)

61 
	#SIOGIFINDEX
 
SIOCGIFINDEX


	)

62 
	#SIOCSIFPFLAGS
 0x8934

	)

63 
	#SIOCGIFPFLAGS
 0x8935

	)

64 
	#SIOCDIFADDR
 0x8936

	)

65 
	#SIOCSIFHWBROADCAST
 0x8937

	)

66 
	#SIOCGIFCOUNT
 0x8938

	)

68 
	#SIOCGIFBR
 0x8940

	)

69 
	#SIOCSIFBR
 0x8941

	)

71 
	#SIOCGIFTXQLEN
 0x8942

	)

72 
	#SIOCSIFTXQLEN
 0x8943

	)

77 
	#SIOCDARP
 0x8953

	)

78 
	#SIOCGARP
 0x8954

	)

79 
	#SIOCSARP
 0x8955

	)

82 
	#SIOCDRARP
 0x8960

	)

83 
	#SIOCGRARP
 0x8961

	)

84 
	#SIOCSRARP
 0x8962

	)

88 
	#SIOCGIFMAP
 0x8970

	)

89 
	#SIOCSIFMAP
 0x8971

	)

93 
	#SIOCADDDLCI
 0x8980

	)

94 
	#SIOCDELDLCI
 0x8981

	)

103 
	#SIOCDEVPRIVATE
 0x89F0

	)

109 
	#SIOCPROTOPRIVATE
 0x89E0

	)

	@/usr/include/bits/posix1_lim.h

25 #iâdef 
_BITS_POSIX1_LIM_H


26 
	#_BITS_POSIX1_LIM_H
 1

	)

32 
	#_POSIX_AIO_LISTIO_MAX
 2

	)

35 
	#_POSIX_AIO_MAX
 1

	)

38 
	#_POSIX_ARG_MAX
 4096

	)

41 #ifdeà
__USE_XOPEN2K


42 
	#_POSIX_CHILD_MAX
 25

	)

44 
	#_POSIX_CHILD_MAX
 6

	)

48 
	#_POSIX_DELAYTIMER_MAX
 32

	)

52 
	#_POSIX_HOST_NAME_MAX
 255

	)

55 
	#_POSIX_LINK_MAX
 8

	)

58 
	#_POSIX_LOGIN_NAME_MAX
 9

	)

61 
	#_POSIX_MAX_CANON
 255

	)

65 
	#_POSIX_MAX_INPUT
 255

	)

68 
	#_POSIX_MQ_OPEN_MAX
 8

	)

71 
	#_POSIX_MQ_PRIO_MAX
 32

	)

74 
	#_POSIX_NAME_MAX
 14

	)

77 #ifdeà
__USE_XOPEN2K


78 
	#_POSIX_NGROUPS_MAX
 8

	)

80 
	#_POSIX_NGROUPS_MAX
 0

	)

84 #ifdeà
__USE_XOPEN2K


85 
	#_POSIX_OPEN_MAX
 20

	)

87 
	#_POSIX_OPEN_MAX
 16

	)

90 #ià!
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_GNU


93 
	#_POSIX_FD_SETSIZE
 
_POSIX_OPEN_MAX


	)

97 
	#_POSIX_PATH_MAX
 256

	)

100 
	#_POSIX_PIPE_BUF
 512

	)

104 
	#_POSIX_RE_DUP_MAX
 255

	)

107 
	#_POSIX_RTSIG_MAX
 8

	)

110 
	#_POSIX_SEM_NSEMS_MAX
 256

	)

113 
	#_POSIX_SEM_VALUE_MAX
 32767

	)

116 
	#_POSIX_SIGQUEUE_MAX
 32

	)

119 
	#_POSIX_SSIZE_MAX
 32767

	)

122 
	#_POSIX_STREAM_MAX
 8

	)

125 
	#_POSIX_SYMLINK_MAX
 255

	)

129 
	#_POSIX_SYMLOOP_MAX
 8

	)

132 
	#_POSIX_TIMER_MAX
 32

	)

135 
	#_POSIX_TTY_NAME_MAX
 9

	)

138 
	#_POSIX_TZNAME_MAX
 6

	)

140 #ià!
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_GNU


142 
	#_POSIX_QLIMIT
 1

	)

146 
	#_POSIX_HIWAT
 
_POSIX_PIPE_BUF


	)

149 
	#_POSIX_UIO_MAXIOV
 16

	)

153 
	#_POSIX_CLOCKRES_MIN
 20000000

	)

157 
	~<b™s/loÿl_lim.h
>

160 #iâdef 
SSIZE_MAX


161 
	#SSIZE_MAX
 
LONG_MAX


	)

168 #iâdef 
NGROUPS_MAX


169 
	#NGROUPS_MAX
 8

	)

	@/usr/include/bits/pthreadtypes.h

20 #iâdeà
_BITS_PTHREADTYPES_H


21 
	#_BITS_PTHREADTYPES_H
 1

	)

23 
	~<b™s/wÜdsize.h
>

25 #ià
__WORDSIZE
 == 64

26 
	#__SIZEOF_PTHREAD_ATTR_T
 56

	)

27 
	#__SIZEOF_PTHREAD_MUTEX_T
 40

	)

28 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

29 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

30 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

31 
	#__SIZEOF_PTHREAD_RWLOCK_T
 56

	)

32 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

33 
	#__SIZEOF_PTHREAD_BARRIER_T
 32

	)

34 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

36 
	#__SIZEOF_PTHREAD_ATTR_T
 36

	)

37 
	#__SIZEOF_PTHREAD_MUTEX_T
 24

	)

38 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

39 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

40 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

41 
	#__SIZEOF_PTHREAD_RWLOCK_T
 32

	)

42 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

43 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

44 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

50 
	t±h»ad_t
;

55 
	m__size
[
__SIZEOF_PTHREAD_ATTR_T
];

56 
	m__®ign
;

57 } 
	t±h»ad_©Œ_t
;

60 #ià
__WORDSIZE
 == 64

61 
	s__±h»ad_š‹º®_li¡


63 
__±h»ad_š‹º®_li¡
 *
	m__´ev
;

64 
__±h»ad_š‹º®_li¡
 *
	m__Ãxt
;

65 } 
	t__±h»ad_li¡_t
;

67 
	s__±h»ad_š‹º®_¦i¡


69 
__±h»ad_š‹º®_¦i¡
 *
	m__Ãxt
;

70 } 
	t__±h»ad_¦i¡_t
;

78 
	s__±h»ad_mu‹x_s


80 
	m__lock
;

81 
	m__couÁ
;

82 
	m__owÃr
;

83 #ià
__WORDSIZE
 == 64

84 
	m__nu£rs
;

88 
	m__kšd
;

89 #ià
__WORDSIZE
 == 64

90 
	m__¥šs
;

91 
__±h»ad_li¡_t
 
	m__li¡
;

92 
	#__PTHREAD_MUTEX_HAVE_PREV
 1

	)

94 
	m__nu£rs
;

95 
__ex‹nsiÚ__
 union

97 
	m__¥šs
;

98 
__±h»ad_¦i¡_t
 
	m__li¡
;

101 } 
	m__d©a
;

102 
	m__size
[
__SIZEOF_PTHREAD_MUTEX_T
];

103 
	m__®ign
;

104 } 
	t±h»ad_mu‹x_t
;

108 
	m__size
[
__SIZEOF_PTHREAD_MUTEXATTR_T
];

109 
	m__®ign
;

110 } 
	t±h»ad_mu‹x©Œ_t
;

119 
	m__lock
;

120 
	m__fu‹x
;

121 
__ex‹nsiÚ__
 
	m__tÙ®_£q
;

122 
__ex‹nsiÚ__
 
	m__wakeup_£q
;

123 
__ex‹nsiÚ__
 
	m__wok’_£q
;

124 *
	m__mu‹x
;

125 
	m__nwa™”s
;

126 
	m__brßdÿ¡_£q
;

127 } 
	m__d©a
;

128 
	m__size
[
__SIZEOF_PTHREAD_COND_T
];

129 
__ex‹nsiÚ__
 
	m__®ign
;

130 } 
	t±h»ad_cÚd_t
;

134 
	m__size
[
__SIZEOF_PTHREAD_CONDATTR_T
];

135 
	m__®ign
;

136 } 
	t±h»ad_cÚd©Œ_t
;

140 
	t±h»ad_key_t
;

144 
	t±h»ad_Úû_t
;

147 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


152 #ià
__WORDSIZE
 == 64

155 
	m__lock
;

156 
	m__Ä_»ad”s
;

157 
	m__»ad”s_wakeup
;

158 
	m__wr™”_wakeup
;

159 
	m__Ä_»ad”s_queued
;

160 
	m__Ä_wr™”s_queued
;

161 
	m__wr™”
;

162 
	m__sh¬ed
;

163 
	m__·d1
;

164 
	m__·d2
;

167 
	m__æags
;

168 } 
	m__d©a
;

172 
	m__lock
;

173 
	m__Ä_»ad”s
;

174 
	m__»ad”s_wakeup
;

175 
	m__wr™”_wakeup
;

176 
	m__Ä_»ad”s_queued
;

177 
	m__Ä_wr™”s_queued
;

180 
	m__æags
;

181 
	m__sh¬ed
;

182 
	m__·d1
;

183 
	m__·d2
;

184 
	m__wr™”
;

185 } 
	m__d©a
;

187 
	m__size
[
__SIZEOF_PTHREAD_RWLOCK_T
];

188 
	m__®ign
;

189 } 
	t±h»ad_rwlock_t
;

193 
	m__size
[
__SIZEOF_PTHREAD_RWLOCKATTR_T
];

194 
	m__®ign
;

195 } 
	t±h»ad_rwlock©Œ_t
;

199 #ifdeà
__USE_XOPEN2K


201 vŞ©
	t±h»ad_¥šlock_t
;

208 
	m__size
[
__SIZEOF_PTHREAD_BARRIER_T
];

209 
	m__®ign
;

210 } 
	t±h»ad_b¬r›r_t
;

214 
	m__size
[
__SIZEOF_PTHREAD_BARRIERATTR_T
];

215 
	m__®ign
;

216 } 
	t±h»ad_b¬r›¿‰r_t
;

220 #ià
__WORDSIZE
 == 32

222 
	#__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
	`__»g·rm__
 (1)))

	)

	@/usr/include/bits/sigaction.h

20 #iâdeà
_SIGNAL_H


25 
	ssigaùiÚ


28 #ifdeà
__USE_POSIX199309


32 
__sighªdËr_t
 
	m§_hªdËr
;

34 (*
	m§_sigaùiÚ
è(, 
	msigšfo_t
 *, *);

36 
	m__sigaùiÚ_hªdËr
;

37 
	#§_hªdËr
 
__sigaùiÚ_hªdËr
.
§_hªdËr


	)

38 
	#§_sigaùiÚ
 
__sigaùiÚ_hªdËr
.
§_sigaùiÚ


	)

40 
__sighªdËr_t
 
	m§_hªdËr
;

44 
__sig£t_t
 
	m§_mask
;

47 
	m§_æags
;

50 (*
	m§_»¡Ü”
) ();

54 
	#SA_NOCLDSTOP
 1

	)

55 
	#SA_NOCLDWAIT
 2

	)

56 
	#SA_SIGINFO
 4

	)

58 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_MISC


59 
	#SA_ONSTACK
 0x08000000

	)

61 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN2K8


62 
	#SA_RESTART
 0x10000000

	)

63 
	#SA_NODEFER
 0x40000000

	)

65 
	#SA_RESETHAND
 0x80000000

	)

67 #ifdeà
__USE_MISC


68 
	#SA_INTERRUPT
 0x20000000

	)

71 
	#SA_NOMASK
 
SA_NODEFER


	)

72 
	#SA_ONESHOT
 
SA_RESETHAND


	)

73 
	#SA_STACK
 
SA_ONSTACK


	)

77 
	#SIG_BLOCK
 0

	)

78 
	#SIG_UNBLOCK
 1

	)

79 
	#SIG_SETMASK
 2

	)

	@/usr/include/bits/sigcontext.h

19 #iâdeà
_BITS_SIGCONTEXT_H


20 
	#_BITS_SIGCONTEXT_H
 1

	)

22 #ià!
defšed
 
_SIGNAL_H
 && !defšed 
_SYS_UCONTEXT_H


26 
	~<b™s/wÜdsize.h
>

28 
	s_å»g


30 
	msignifiÿnd
[4];

31 
	mexpÚ’t
;

34 
	s_åx»g


36 
	msignifiÿnd
[4];

37 
	mexpÚ’t
;

38 
	m·ddšg
[3];

41 
	s_xmm»g


43 
__ušt32_t
 
	m–em’t
[4];

48 #ià
__WORDSIZE
 == 32

50 
	s_å¡©e


53 
__ušt32_t
 
	mcw
;

54 
__ušt32_t
 
	msw
;

55 
__ušt32_t
 
	mg
;

56 
__ušt32_t
 
	moff
;

57 
__ušt32_t
 
	mcs£l
;

58 
__ušt32_t
 
	md©aoff
;

59 
__ušt32_t
 
	md©a£l
;

60 
_å»g
 
	m_¡
[8];

61 
	m¡©us
;

62 
	mmagic
;

65 
__ušt32_t
 
	m_fx¤_’v
[6];

66 
__ušt32_t
 
	mmxc¤
;

67 
__ušt32_t
 
	m»£rved
;

68 
_åx»g
 
	m_fx¤_¡
[8];

69 
_xmm»g
 
	m_xmm
[8];

70 
__ušt32_t
 
	m·ddšg
[56];

73 #iâdeà
sigcÚ‹xt_¡ruù


78 
	#sigcÚ‹xt_¡ruù
 
sigcÚ‹xt


	)

81 
	ssigcÚ‹xt


83 
	mgs
, 
	m__gsh
;

84 
	mfs
, 
	m__fsh
;

85 
	mes
, 
	m__esh
;

86 
	mds
, 
	m__dsh
;

87 
	medi
;

88 
	mesi
;

89 
	mebp
;

90 
	me¥
;

91 
	mebx
;

92 
	medx
;

93 
	mecx
;

94 
	m—x
;

95 
	mŒ­no
;

96 
	m”r
;

97 
	me
;

98 
	mcs
, 
	m__csh
;

99 
	meæags
;

100 
	me¥_©_sigÇl
;

101 
	mss
, 
	m__ssh
;

102 
_å¡©e
 * 
	må¡©e
;

103 
	mŞdmask
;

104 
	mü2
;

109 
	s_å¡©e


112 
__ušt16_t
 
	mcwd
;

113 
__ušt16_t
 
	mswd
;

114 
__ušt16_t
 
	máw
;

115 
__ušt16_t
 
	mfİ
;

116 
__ušt64_t
 
	mr
;

117 
__ušt64_t
 
	mrdp
;

118 
__ušt32_t
 
	mmxc¤
;

119 
__ušt32_t
 
	mmxü_mask
;

120 
_åx»g
 
	m_¡
[8];

121 
_xmm»g
 
	m_xmm
[16];

122 
__ušt32_t
 
	m·ddšg
[24];

125 
	ssigcÚ‹xt


127 
	mr8
;

128 
	mr9
;

129 
	mr10
;

130 
	mr11
;

131 
	mr12
;

132 
	mr13
;

133 
	mr14
;

134 
	mr15
;

135 
	mrdi
;

136 
	mrsi
;

137 
	mrbp
;

138 
	mrbx
;

139 
	mrdx
;

140 
	m¿x
;

141 
	mrcx
;

142 
	mr¥
;

143 
	mr
;

144 
	meæags
;

145 
	mcs
;

146 
	mgs
;

147 
	mfs
;

148 
	m__·d0
;

149 
	m”r
;

150 
	mŒ­no
;

151 
	mŞdmask
;

152 
	mü2
;

153 
_å¡©e
 * 
	må¡©e
;

154 
	m__»£rved1
 [8];

	@/usr/include/bits/siginfo.h

20 #ià!
defšed
 
_SIGNAL_H
 && !defšed 
__Ãed_sigšfo_t
 \

21 && !
defšed
 
	g__Ãed_sigev’t_t


25 
	~<b™s/wÜdsize.h
>

27 #ià(!
defšed
 
__have_sigv®_t
 \

28 && (
defšed
 
	g_SIGNAL_H
 || defšed 
	g__Ãed_sigšfo_t
 \

29 || 
defšed
 
	g__Ãed_sigev’t_t
))

30 
	#__have_sigv®_t
 1

	)

33 
	usigv®


35 
	msiv®_št
;

36 *
	msiv®_±r
;

37 } 
	tsigv®_t
;

40 #ià(!
defšed
 
__have_sigšfo_t
 \

41 && (
defšed
 
	g_SIGNAL_H
 || defšed 
	g__Ãed_sigšfo_t
))

42 
	#__have_sigšfo_t
 1

	)

44 
	#__SI_MAX_SIZE
 128

	)

45 #ià
__WORDSIZE
 == 64

46 
	#__SI_PAD_SIZE
 ((
__SI_MAX_SIZE
 /  ()è- 4)

	)

48 
	#__SI_PAD_SIZE
 ((
__SI_MAX_SIZE
 /  ()è- 3)

	)

51 
	ssigšfo


53 
	msi_signo
;

54 
	msi_”ºo
;

56 
	msi_code
;

60 
	m_·d
[
__SI_PAD_SIZE
];

65 
__pid_t
 
	msi_pid
;

66 
__uid_t
 
	msi_uid
;

67 } 
	m_kl
;

72 
	msi_tid
;

73 
	msi_ov”run
;

74 
sigv®_t
 
	msi_sigv®
;

75 } 
	m_tim”
;

80 
__pid_t
 
	msi_pid
;

81 
__uid_t
 
	msi_uid
;

82 
sigv®_t
 
	msi_sigv®
;

83 } 
	m_¹
;

88 
__pid_t
 
	msi_pid
;

89 
__uid_t
 
	msi_uid
;

90 
	msi_¡©us
;

91 
__şock_t
 
	msi_utime
;

92 
__şock_t
 
	msi_¡ime
;

93 } 
	m_sigchld
;

98 *
	msi_addr
;

99 } 
	m_sigçuÉ
;

104 
	msi_bªd
;

105 
	msi_fd
;

106 } 
	m_sigpŞl
;

107 } 
	m_sif›lds
;

108 } 
	tsigšfo_t
;

112 
	#si_pid
 
_sif›lds
.
_kl
.
si_pid


	)

113 
	#si_uid
 
_sif›lds
.
_kl
.
si_uid


	)

114 
	#si_tim”id
 
_sif›lds
.
_tim”
.
si_tid


	)

115 
	#si_ov”run
 
_sif›lds
.
_tim”
.
si_ov”run


	)

116 
	#si_¡©us
 
_sif›lds
.
_sigchld
.
si_¡©us


	)

117 
	#si_utime
 
_sif›lds
.
_sigchld
.
si_utime


	)

118 
	#si_¡ime
 
_sif›lds
.
_sigchld
.
si_¡ime


	)

119 
	#si_v®ue
 
_sif›lds
.
_¹
.
si_sigv®


	)

120 
	#si_št
 
_sif›lds
.
_¹
.
si_sigv®
.
siv®_št


	)

121 
	#si_±r
 
_sif›lds
.
_¹
.
si_sigv®
.
siv®_±r


	)

122 
	#si_addr
 
_sif›lds
.
_sigçuÉ
.
si_addr


	)

123 
	#si_bªd
 
_sif›lds
.
_sigpŞl
.
si_bªd


	)

124 
	#si_fd
 
_sif›lds
.
_sigpŞl
.
si_fd


	)

131 
	mSI_ASYNCNL
 = -60,

132 
	#SI_ASYNCNL
 
SI_ASYNCNL


	)

133 
	mSI_TKILL
 = -6,

134 
	#SI_TKILL
 
SI_TKILL


	)

135 
	mSI_SIGIO
,

136 
	#SI_SIGIO
 
SI_SIGIO


	)

137 
	mSI_ASYNCIO
,

138 
	#SI_ASYNCIO
 
SI_ASYNCIO


	)

139 
	mSI_MESGQ
,

140 
	#SI_MESGQ
 
SI_MESGQ


	)

141 
	mSI_TIMER
,

142 
	#SI_TIMER
 
SI_TIMER


	)

143 
	mSI_QUEUE
,

144 
	#SI_QUEUE
 
SI_QUEUE


	)

145 
	mSI_USER
,

146 
	#SI_USER
 
SI_USER


	)

147 
	mSI_KERNEL
 = 0x80

148 
	#SI_KERNEL
 
SI_KERNEL


	)

155 
	mILL_ILLOPC
 = 1,

156 
	#ILL_ILLOPC
 
ILL_ILLOPC


	)

157 
	mILL_ILLOPN
,

158 
	#ILL_ILLOPN
 
ILL_ILLOPN


	)

159 
	mILL_ILLADR
,

160 
	#ILL_ILLADR
 
ILL_ILLADR


	)

161 
	mILL_ILLTRP
,

162 
	#ILL_ILLTRP
 
ILL_ILLTRP


	)

163 
	mILL_PRVOPC
,

164 
	#ILL_PRVOPC
 
ILL_PRVOPC


	)

165 
	mILL_PRVREG
,

166 
	#ILL_PRVREG
 
ILL_PRVREG


	)

167 
	mILL_COPROC
,

168 
	#ILL_COPROC
 
ILL_COPROC


	)

169 
	mILL_BADSTK


170 
	#ILL_BADSTK
 
ILL_BADSTK


	)

176 
	mFPE_INTDIV
 = 1,

177 
	#FPE_INTDIV
 
FPE_INTDIV


	)

178 
	mFPE_INTOVF
,

179 
	#FPE_INTOVF
 
FPE_INTOVF


	)

180 
	mFPE_FLTDIV
,

181 
	#FPE_FLTDIV
 
FPE_FLTDIV


	)

182 
	mFPE_FLTOVF
,

183 
	#FPE_FLTOVF
 
FPE_FLTOVF


	)

184 
	mFPE_FLTUND
,

185 
	#FPE_FLTUND
 
FPE_FLTUND


	)

186 
	mFPE_FLTRES
,

187 
	#FPE_FLTRES
 
FPE_FLTRES


	)

188 
	mFPE_FLTINV
,

189 
	#FPE_FLTINV
 
FPE_FLTINV


	)

190 
	mFPE_FLTSUB


191 
	#FPE_FLTSUB
 
FPE_FLTSUB


	)

197 
	mSEGV_MAPERR
 = 1,

198 
	#SEGV_MAPERR
 
SEGV_MAPERR


	)

199 
	mSEGV_ACCERR


200 
	#SEGV_ACCERR
 
SEGV_ACCERR


	)

206 
	mBUS_ADRALN
 = 1,

207 
	#BUS_ADRALN
 
BUS_ADRALN


	)

208 
	mBUS_ADRERR
,

209 
	#BUS_ADRERR
 
BUS_ADRERR


	)

210 
	mBUS_OBJERR


211 
	#BUS_OBJERR
 
BUS_OBJERR


	)

217 
	mTRAP_BRKPT
 = 1,

218 
	#TRAP_BRKPT
 
TRAP_BRKPT


	)

219 
	mTRAP_TRACE


220 
	#TRAP_TRACE
 
TRAP_TRACE


	)

226 
	mCLD_EXITED
 = 1,

227 
	#CLD_EXITED
 
CLD_EXITED


	)

228 
	mCLD_KILLED
,

229 
	#CLD_KILLED
 
CLD_KILLED


	)

230 
	mCLD_DUMPED
,

231 
	#CLD_DUMPED
 
CLD_DUMPED


	)

232 
	mCLD_TRAPPED
,

233 
	#CLD_TRAPPED
 
CLD_TRAPPED


	)

234 
	mCLD_STOPPED
,

235 
	#CLD_STOPPED
 
CLD_STOPPED


	)

236 
	mCLD_CONTINUED


237 
	#CLD_CONTINUED
 
CLD_CONTINUED


	)

243 
	mPOLL_IN
 = 1,

244 
	#POLL_IN
 
POLL_IN


	)

245 
	mPOLL_OUT
,

246 
	#POLL_OUT
 
POLL_OUT


	)

247 
	mPOLL_MSG
,

248 
	#POLL_MSG
 
POLL_MSG


	)

249 
	mPOLL_ERR
,

250 
	#POLL_ERR
 
POLL_ERR


	)

251 
	mPOLL_PRI
,

252 
	#POLL_PRI
 
POLL_PRI


	)

253 
	mPOLL_HUP


254 
	#POLL_HUP
 
POLL_HUP


	)

257 #undeà
__Ãed_sigšfo_t


261 #ià(
defšed
 
_SIGNAL_H
 || defšed 
__Ãed_sigev’t_t
) \

262 && !
defšed
 
	g__have_sigev’t_t


263 
	#__have_sigev’t_t
 1

	)

266 
	#__SIGEV_MAX_SIZE
 64

	)

267 #ià
__WORDSIZE
 == 64

268 
	#__SIGEV_PAD_SIZE
 ((
__SIGEV_MAX_SIZE
 /  ()è- 4)

	)

270 
	#__SIGEV_PAD_SIZE
 ((
__SIGEV_MAX_SIZE
 /  ()è- 3)

	)

273 
	ssigev’t


275 
sigv®_t
 
	msigev_v®ue
;

276 
	msigev_signo
;

277 
	msigev_nÙify
;

281 
	m_·d
[
__SIGEV_PAD_SIZE
];

285 
__pid_t
 
	m_tid
;

289 (*
	m_funùiÚ
è(
	msigv®_t
);

290 *
	m_©Œibu‹
;

291 } 
	m_sigev_th»ad
;

292 } 
	m_sigev_un
;

293 } 
	tsigev’t_t
;

296 
	#sigev_nÙify_funùiÚ
 
_sigev_un
.
_sigev_th»ad
.
_funùiÚ


	)

297 
	#sigev_nÙify_©Œibu‹s
 
_sigev_un
.
_sigev_th»ad
.
_©Œibu‹


	)

302 
	mSIGEV_SIGNAL
 = 0,

303 
	#SIGEV_SIGNAL
 
SIGEV_SIGNAL


	)

304 
	mSIGEV_NONE
,

305 
	#SIGEV_NONE
 
SIGEV_NONE


	)

306 
	mSIGEV_THREAD
,

307 
	#SIGEV_THREAD
 
SIGEV_THREAD


	)

309 
	mSIGEV_THREAD_ID
 = 4

310 
	#SIGEV_THREAD_ID
 
SIGEV_THREAD_ID


	)

	@/usr/include/bits/signum.h

20 #ifdef 
_SIGNAL_H


23 
	#SIG_ERR
 ((
__sighªdËr_t
è-1è

	)

24 
	#SIG_DFL
 ((
__sighªdËr_t
è0è

	)

25 
	#SIG_IGN
 ((
__sighªdËr_t
è1è

	)

27 #ifdeà
__USE_UNIX98


28 
	#SIG_HOLD
 ((
__sighªdËr_t
è2è

	)

33 
	#SIGHUP
 1

	)

34 
	#SIGINT
 2

	)

35 
	#SIGQUIT
 3

	)

36 
	#SIGILL
 4

	)

37 
	#SIGTRAP
 5

	)

38 
	#SIGABRT
 6

	)

39 
	#SIGIOT
 6

	)

40 
	#SIGBUS
 7

	)

41 
	#SIGFPE
 8

	)

42 
	#SIGKILL
 9

	)

43 
	#SIGUSR1
 10

	)

44 
	#SIGSEGV
 11

	)

45 
	#SIGUSR2
 12

	)

46 
	#SIGPIPE
 13

	)

47 
	#SIGALRM
 14

	)

48 
	#SIGTERM
 15

	)

49 
	#SIGSTKFLT
 16

	)

50 
	#SIGCLD
 
SIGCHLD


	)

51 
	#SIGCHLD
 17

	)

52 
	#SIGCONT
 18

	)

53 
	#SIGSTOP
 19

	)

54 
	#SIGTSTP
 20

	)

55 
	#SIGTTIN
 21

	)

56 
	#SIGTTOU
 22

	)

57 
	#SIGURG
 23

	)

58 
	#SIGXCPU
 24

	)

59 
	#SIGXFSZ
 25

	)

60 
	#SIGVTALRM
 26

	)

61 
	#SIGPROF
 27

	)

62 
	#SIGWINCH
 28

	)

63 
	#SIGPOLL
 
SIGIO


	)

64 
	#SIGIO
 29

	)

65 
	#SIGPWR
 30

	)

66 
	#SIGSYS
 31

	)

67 
	#SIGUNUSED
 31

	)

69 
	#_NSIG
 65

	)

72 
	#SIGRTMIN
 (
	`__libc_cu¼’t_sig¹mš
 ())

	)

73 
	#SIGRTMAX
 (
	`__libc_cu¼’t_sig¹max
 ())

	)

77 
	#__SIGRTMIN
 32

	)

78 
	#__SIGRTMAX
 (
_NSIG
 - 1)

	)

	@/usr/include/bits/sigset.h

21 #iâdef 
_SIGSET_H_ty³s


22 
	#_SIGSET_H_ty³s
 1

	)

24 
	t__sig_©omic_t
;

28 
	#_SIGSET_NWORDS
 (1024 / (8 *  ()))

	)

31 
	m__v®
[
_SIGSET_NWORDS
];

32 } 
	t__sig£t_t
;

43 #ià!
defšed
 
_SIGSET_H_âs
 && defšed 
_SIGNAL_H


44 
	#_SIGSET_H_âs
 1

	)

46 #iâdeà
_EXTERN_INLINE


47 
	#_EXTERN_INLINE
 
__ex‹º_šlše


	)

51 
	#__sigmask
(
sig
) \

52 (((è1è<< (((
sig
è- 1è% (8 *  ())))

	)

55 
	#__sigwÜd
(
sig
è(((sigè- 1è/ (8 *  ()))

	)

57 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

58 
	#__sigem±y£t
(
£t
) \

59 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

60 
sig£t_t
 *
__£t
 = (
£t
); \

61 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = 0; \

62 0; }))

	)

63 
	#__sigfl£t
(
£t
) \

64 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

65 
sig£t_t
 *
__£t
 = (
£t
); \

66 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = ~0UL; \

67 0; }))

	)

69 #ifdeà
__USE_GNU


73 
	#__sigi£m±y£t
(
£t
) \

74 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

75 cÚ¡ 
sig£t_t
 *
__£t
 = (
£t
); \

76 
__»t
 = 
__£t
->
__v®
[--
__út
]; \

77 !
__»t
 && --
__út
 >= 0) \

78 
__»t
 = 
__£t
->
__v®
[
__út
]; \

79 
__»t
 =ğ0; }))

	)

80 
	#__sigªd£t
(
de¡
, 
Ëá
, 
right
) \

81 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

82 
sig£t_t
 *
__de¡
 = (
de¡
); \

83 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

84 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

85 --
__út
 >= 0) \

86 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

87 & 
__right
->
__v®
[
__út
]); \

88 0; }))

	)

89 
	#__sigÜ£t
(
de¡
, 
Ëá
, 
right
) \

90 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

91 
sig£t_t
 *
__de¡
 = (
de¡
); \

92 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

93 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

94 --
__út
 >= 0) \

95 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

96 | 
__right
->
__v®
[
__út
]); \

97 0; }))

	)

104 
__sigismemb”
 (
__cÚ¡
 
__sig£t_t
 *, );

105 
__sigadd£t
 (
__sig£t_t
 *, );

106 
__sigd–£t
 (
__sig£t_t
 *, );

108 #ifdeà
__USE_EXTERN_INLINES


109 
	#__SIGSETFN
(
NAME
, 
BODY
, 
CONST
) \

110 
_EXTERN_INLINE
 \

111 
	`NAME
 (
CONST
 
__sig£t_t
 *
__£t
, 
__sig
) \

113 
__mask
 = 
	`__sigmask
 (
__sig
); \

114 
__wÜd
 = 
	`__sigwÜd
 (
__sig
); \

115  
BODY
; \

116 }

	)

118 
__SIGSETFN
 (
__sigismemb”
, (
__£t
->
__v®
[
__wÜd
] & 
__mask
è? 1 : 0, 
__cÚ¡
)

119 
__SIGSETFN
 (
__sigadd£t
, ((
__£t
->
__v®
[
__wÜd
] |ğ
__mask
), 0), )

120 
__SIGSETFN
 (
__sigd–£t
, ((
__£t
->
__v®
[
__wÜd
] &ğ~
__mask
), 0), )

122 #undeà
__SIGSETFN


	@/usr/include/bits/sigstack.h

20 #iâdeà
_SIGNAL_H


26 
	ssig¡ack


28 *
	mss_¥
;

29 
	mss_Ú¡ack
;

36 
	mSS_ONSTACK
 = 1,

37 
	#SS_ONSTACK
 
SS_ONSTACK


	)

38 
	mSS_DISABLE


39 
	#SS_DISABLE
 
SS_DISABLE


	)

43 
	#MINSIGSTKSZ
 2048

	)

46 
	#SIGSTKSZ
 8192

	)

50 
	ssig®t¡ack


52 *
	mss_¥
;

53 
	mss_æags
;

54 
size_t
 
	mss_size
;

55 } 
	t¡ack_t
;

	@/usr/include/bits/sigthread.h

20 #iâdeà
_BITS_SIGTHREAD_H


21 
	#_BITS_SIGTHREAD_H
 1

	)

23 #ià!
defšed
 
_SIGNAL_H
 && !defšed 
_PTHREAD_H


31 
	$±h»ad_sigmask
 (
__how
,

32 
__cÚ¡
 
__sig£t_t
 *
__»¡riù
 
__Ãwmask
,

33 
__sig£t_t
 *
__»¡riù
 
__Şdmask
)
__THROW
;

36 
	$±h»ad_kl
 (
±h»ad_t
 
__th»adid
, 
__signo
è
__THROW
;

38 #ifdeà
__USE_GNU


40 
	$±h»ad_sigqueue
 (
±h»ad_t
 
__th»adid
, 
__signo
,

41 cÚ¡ 
sigv®
 
__v®ue
è
__THROW
;

	@/usr/include/bits/types.h

24 #iâdef 
_BITS_TYPES_H


25 
	#_BITS_TYPES_H
 1

	)

27 
	~<ã©u»s.h
>

28 
	~<b™s/wÜdsize.h
>

31 
	t__u_ch¬
;

32 
	t__u_shÜt
;

33 
	t__u_št
;

34 
	t__u_lÚg
;

37 sigÃd 
	t__št8_t
;

38 
	t__ušt8_t
;

39 sigÃd 
	t__št16_t
;

40 
	t__ušt16_t
;

41 sigÃd 
	t__št32_t
;

42 
	t__ušt32_t
;

43 #ià
__WORDSIZE
 == 64

44 sigÃd 
	t__št64_t
;

45 
	t__ušt64_t
;

46 #–ià
defšed
 
__GLIBC_HAVE_LONG_LONG


47 
__ex‹nsiÚ__
 sigÃd 
	t__št64_t
;

48 
__ex‹nsiÚ__
 
	t__ušt64_t
;

52 #ià
__WORDSIZE
 == 64

53 
	t__quad_t
;

54 
	t__u_quad_t
;

55 #–ià
defšed
 
__GLIBC_HAVE_LONG_LONG


56 
__ex‹nsiÚ__
 
	t__quad_t
;

57 
__ex‹nsiÚ__
 
	t__u_quad_t
;

61 
	m__v®
[2];

62 } 
	t__quad_t
;

65 
__u_lÚg
 
	m__v®
[2];

66 } 
	t__u_quad_t
;

99 
	#__S16_TYPE
 

	)

100 
	#__U16_TYPE
 

	)

101 
	#__S32_TYPE
 

	)

102 
	#__U32_TYPE
 

	)

103 
	#__SLONGWORD_TYPE
 

	)

104 
	#__ULONGWORD_TYPE
 

	)

105 #ià
__WORDSIZE
 == 32

106 
	#__SQUAD_TYPE
 
__quad_t


	)

107 
	#__UQUAD_TYPE
 
__u_quad_t


	)

108 
	#__SWORD_TYPE
 

	)

109 
	#__UWORD_TYPE
 

	)

110 
	#__SLONG32_TYPE
 

	)

111 
	#__ULONG32_TYPE
 

	)

112 
	#__S64_TYPE
 
__quad_t


	)

113 
	#__U64_TYPE
 
__u_quad_t


	)

116 
	#__STD_TYPE
 
__ex‹nsiÚ__
 

	)

117 #–ià
__WORDSIZE
 == 64

118 
	t__SQUAD_TYPE
 

	)

119 
	t__UQUAD_TYPE
 

	)

120 
	t__SWORD_TYPE
 

	)

121 
	t__UWORD_TYPE
 

	)

122 
	t__SLONG32_TYPE
 

	)

123 
	t__ULONG32_TYPE
 

	)

124 
	t__S64_TYPE
 

	)

125 
	t__U64_TYPE
 

	)

127 
	t__STD_TYPE
 

	)

131 
	~<b™s/ty³sizes.h
>

134 
__STD_TYPE
 
	t__DEV_T_TYPE
 
	t__dev_t
;

135 
__STD_TYPE
 
__UID_T_TYPE
 
	g__uid_t
;

136 
__STD_TYPE
 
__GID_T_TYPE
 
	g__gid_t
;

137 
__STD_TYPE
 
__INO_T_TYPE
 
	g__šo_t
;

138 
__STD_TYPE
 
__INO64_T_TYPE
 
	g__šo64_t
;

139 
__STD_TYPE
 
__MODE_T_TYPE
 
	g__mode_t
;

140 
__STD_TYPE
 
__NLINK_T_TYPE
 
	g__Æšk_t
;

141 
__STD_TYPE
 
__OFF_T_TYPE
 
	g__off_t
;

142 
__STD_TYPE
 
__OFF64_T_TYPE
 
	g__off64_t
;

143 
__STD_TYPE
 
__PID_T_TYPE
 
	g__pid_t
;

144 
__STD_TYPE
 
__FSID_T_TYPE
 
	g__fsid_t
;

145 
__STD_TYPE
 
__CLOCK_T_TYPE
 
	g__şock_t
;

146 
__STD_TYPE
 
__RLIM_T_TYPE
 
	g__¾im_t
;

147 
__STD_TYPE
 
__RLIM64_T_TYPE
 
	g__¾im64_t
;

148 
__STD_TYPE
 
__ID_T_TYPE
 
	g__id_t
;

149 
__STD_TYPE
 
__TIME_T_TYPE
 
	g__time_t
;

150 
__STD_TYPE
 
__USECONDS_T_TYPE
 
	g__u£cÚds_t
;

151 
__STD_TYPE
 
__SUSECONDS_T_TYPE
 
	g__su£cÚds_t
;

153 
__STD_TYPE
 
__DADDR_T_TYPE
 
	g__daddr_t
;

154 
__STD_TYPE
 
__SWBLK_T_TYPE
 
	g__swblk_t
;

155 
__STD_TYPE
 
__KEY_T_TYPE
 
	g__key_t
;

158 
__STD_TYPE
 
__CLOCKID_T_TYPE
 
	g__şockid_t
;

161 
__STD_TYPE
 
__TIMER_T_TYPE
 
	g__tim”_t
;

164 
__STD_TYPE
 
__BLKSIZE_T_TYPE
 
	g__blksize_t
;

169 
__STD_TYPE
 
__BLKCNT_T_TYPE
 
	g__blkút_t
;

170 
__STD_TYPE
 
__BLKCNT64_T_TYPE
 
	g__blkút64_t
;

173 
__STD_TYPE
 
__FSBLKCNT_T_TYPE
 
	g__fsblkút_t
;

174 
__STD_TYPE
 
__FSBLKCNT64_T_TYPE
 
	g__fsblkút64_t
;

177 
__STD_TYPE
 
__FSFILCNT_T_TYPE
 
	g__fsfút_t
;

178 
__STD_TYPE
 
__FSFILCNT64_T_TYPE
 
	g__fsfút64_t
;

180 
__STD_TYPE
 
__SSIZE_T_TYPE
 
	g__ssize_t
;

184 
__off64_t
 
	t__loff_t
;

185 
__quad_t
 *
	t__qaddr_t
;

186 *
	t__ÿddr_t
;

189 
__STD_TYPE
 
__SWORD_TYPE
 
	g__šŒ_t
;

192 
__STD_TYPE
 
__U32_TYPE
 
	g__sockËn_t
;

195 #undeà
__STD_TYPE


	@/usr/include/endian.h

19 #iâdef 
_ENDIAN_H


20 
	#_ENDIAN_H
 1

	)

22 
	~<ã©u»s.h
>

32 
	#__LITTLE_ENDIAN
 1234

	)

33 
	#__BIG_ENDIAN
 4321

	)

34 
	#__PDP_ENDIAN
 3412

	)

37 
	~<b™s/’dŸn.h
>

41 #iâdeà
__FLOAT_WORD_ORDER


42 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

45 #ifdef 
__USE_BSD


46 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

47 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

48 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

49 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

52 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


53 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

54 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


55 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

59 #ifdeà
__USE_BSD


61 
	~<b™s/by‹sw­.h
>

63 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


64 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

65 
	#htŞe16
(
x
è(x)

	)

66 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

67 
	#Ë16toh
(
x
è(x)

	)

69 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

70 
	#htŞe32
(
x
è(x)

	)

71 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

72 
	#Ë32toh
(
x
è(x)

	)

74 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

75 
	#htŞe64
(
x
è(x)

	)

76 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

77 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/features.h

20 #iâdef 
_FEATURES_H


21 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC99


98 #undeà
__USE_ISOC95


99 #undeà
__USE_POSIX


100 #undeà
__USE_POSIX2


101 #undeà
__USE_POSIX199309


102 #undeà
__USE_POSIX199506


103 #undeà
__USE_XOPEN


104 #undeà
__USE_XOPEN_EXTENDED


105 #undeà
__USE_UNIX98


106 #undeà
__USE_XOPEN2K


107 #undeà
__USE_XOPEN2KXSI


108 #undeà
__USE_XOPEN2K8


109 #undeà
__USE_XOPEN2K8XSI


110 #undeà
__USE_LARGEFILE


111 #undeà
__USE_LARGEFILE64


112 #undeà
__USE_FILE_OFFSET64


113 #undeà
__USE_BSD


114 #undeà
__USE_SVID


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__FAVOR_BSD


121 #undeà
__KERNEL_STRICT_NAMES


125 #iâdeà
_LOOSE_KERNEL_NAMES


126 
	#__KERNEL_STRICT_NAMES


	)

130 
	#__USE_ANSI
 1

	)

139 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


140 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

141 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

143 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

148 #ià
defšed
 
_BSD_SOURCE
 && \

149 !(
defšed
 
	g_POSIX_SOURCE
 || defšed 
	g_POSIX_C_SOURCE
 || \

150 
defšed
 
	g_XOPEN_SOURCE
 || defšed 
	g_GNU_SOURCE
 || defšed 
	g_SVID_SOURCE
)

151 
	#__FAVOR_BSD
 1

	)

155 #ifdeà
_GNU_SOURCE


156 #undeà
_ISOC95_SOURCE


157 
	#_ISOC95_SOURCE
 1

	)

158 #undeà
_ISOC99_SOURCE


159 
	#_ISOC99_SOURCE
 1

	)

160 #undeà
_POSIX_SOURCE


161 
	#_POSIX_SOURCE
 1

	)

162 #undeà
_POSIX_C_SOURCE


163 
	#_POSIX_C_SOURCE
 200809L

	)

164 #undeà
_XOPEN_SOURCE


165 
	#_XOPEN_SOURCE
 700

	)

166 #undeà
_XOPEN_SOURCE_EXTENDED


167 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

168 #undeà
_LARGEFILE64_SOURCE


169 
	#_LARGEFILE64_SOURCE
 1

	)

170 #undeà
_BSD_SOURCE


171 
	#_BSD_SOURCE
 1

	)

172 #undeà
_SVID_SOURCE


173 
	#_SVID_SOURCE
 1

	)

174 #undeà
_ATFILE_SOURCE


175 
	#_ATFILE_SOURCE
 1

	)

180 #ià(!
defšed
 
__STRICT_ANSI__
 && !defšed 
_ISOC99_SOURCE
 && \

181 !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 && \

182 !
defšed
 
	g_XOPEN_SOURCE
 && !defšed 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
)

183 
	#_BSD_SOURCE
 1

	)

184 
	#_SVID_SOURCE
 1

	)

191 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

192 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

193 
	#__USE_ISOC99
 1

	)

197 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

198 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

199 
	#__USE_ISOC95
 1

	)

204 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

205 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

206 
	#_POSIX_SOURCE
 1

	)

207 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

208 
	#_POSIX_C_SOURCE
 2

	)

209 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

210 
	#_POSIX_C_SOURCE
 199506L

	)

211 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

212 
	#_POSIX_C_SOURCE
 200112L

	)

214 
	#_POSIX_C_SOURCE
 200809L

	)

216 
	#__USE_POSIX_IMPLICITLY
 1

	)

219 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


220 
	#__USE_POSIX
 1

	)

223 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


224 
	#__USE_POSIX2
 1

	)

227 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

228 
	#__USE_POSIX199309
 1

	)

231 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

232 
	#__USE_POSIX199506
 1

	)

235 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

236 
	#__USE_XOPEN2K
 1

	)

237 #undeà
__USE_ISOC95


238 
	#__USE_ISOC95
 1

	)

239 #undeà
__USE_ISOC99


240 
	#__USE_ISOC99
 1

	)

243 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

244 
	#__USE_XOPEN2K8
 1

	)

245 #undeà
_ATFILE_SOURCE


246 
	#_ATFILE_SOURCE
 1

	)

249 #ifdef 
_XOPEN_SOURCE


250 
	#__USE_XOPEN
 1

	)

251 #ià(
_XOPEN_SOURCE
 - 0) >= 500

252 
	#__USE_XOPEN_EXTENDED
 1

	)

253 
	#__USE_UNIX98
 1

	)

254 #undeà
_LARGEFILE_SOURCE


255 
	#_LARGEFILE_SOURCE
 1

	)

256 #ià(
_XOPEN_SOURCE
 - 0) >= 600

257 #ià(
_XOPEN_SOURCE
 - 0) >= 700

258 
	#__USE_XOPEN2K8
 1

	)

259 
	#__USE_XOPEN2K8XSI
 1

	)

261 
	#__USE_XOPEN2K
 1

	)

262 
	#__USE_XOPEN2KXSI
 1

	)

263 #undeà
__USE_ISOC95


264 
	#__USE_ISOC95
 1

	)

265 #undeà
__USE_ISOC99


266 
	#__USE_ISOC99
 1

	)

269 #ifdeà
_XOPEN_SOURCE_EXTENDED


270 
	#__USE_XOPEN_EXTENDED
 1

	)

275 #ifdeà
_LARGEFILE_SOURCE


276 
	#__USE_LARGEFILE
 1

	)

279 #ifdeà
_LARGEFILE64_SOURCE


280 
	#__USE_LARGEFILE64
 1

	)

283 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

284 
	#__USE_FILE_OFFSET64
 1

	)

287 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


288 
	#__USE_MISC
 1

	)

291 #ifdef 
_BSD_SOURCE


292 
	#__USE_BSD
 1

	)

295 #ifdef 
_SVID_SOURCE


296 
	#__USE_SVID
 1

	)

299 #ifdef 
_ATFILE_SOURCE


300 
	#__USE_ATFILE
 1

	)

303 #ifdef 
_GNU_SOURCE


304 
	#__USE_GNU
 1

	)

307 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


308 
	#__USE_REENTRANT
 1

	)

311 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

312 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

313 #ià
_FORTIFY_SOURCE
 > 1

314 
	#__USE_FORTIFY_LEVEL
 2

	)

316 
	#__USE_FORTIFY_LEVEL
 1

	)

319 
	#__USE_FORTIFY_LEVEL
 0

	)

323 
	~<b™s/´edefs.h
>

326 
	#__STDC_ISO_10646__
 200009L

	)

334 #undeà
__GNU_LIBRARY__


335 
	#__GNU_LIBRARY__
 6

	)

339 
	#__GLIBC__
 2

	)

340 
	#__GLIBC_MINOR__
 13

	)

342 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

343 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

346 #ià
defšed
 
__GNUC__
 \

347 || (
defšed
 
	g__PGI
 && defšed 
	g__i386__
 ) \

348 || (
defšed
 
	g__INTEL_COMPILER
 && (defšed 
	g__i386__
 || defšed 
	g__Ÿ64__
)) \

349 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L)

350 
	#__GLIBC_HAVE_LONG_LONG
 1

	)

354 #iâdeà
__ASSEMBLER__


355 #iâdeà
_SYS_CDEFS_H


356 
	~<sys/cdefs.h
>

361 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


362 
	#__USE_LARGEFILE
 1

	)

363 
	#__USE_LARGEFILE64
 1

	)

369 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

370 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

371 && 
defšed
 
	g__ex‹º_šlše


372 
	#__USE_EXTERN_INLINES
 1

	)

377 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

378 && (
defšed
 
	g_LIBC
 || !defšed 
	g__OPTIMIZE_SIZE__
è&& !defšed 
	g__NO_INLINE__
 \

379 && 
defšed
 
	g__ex‹º_šlše


380 
	#__USE_EXTERN_INLINES_IN_LIBC
 1

	)

388 
	~<gnu/¡ubs.h
>

	@/usr/include/linux/magic.h

1 #iâdeà
__LINUX_MAGIC_H__


2 
	#__LINUX_MAGIC_H__


	)

4 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

5 
	#AFFS_SUPER_MAGIC
 0xadff

	)

6 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

7 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

8 
	#CODA_SUPER_MAGIC
 0x73757245

	)

9 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

10 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

11 
	#DEBUGFS_MAGIC
 0x64626720

	)

12 
	#SYSFS_MAGIC
 0x62656572

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#RAMFS_MAGIC
 0x858458f6

	)

16 
	#TMPFS_MAGIC
 0x01021994

	)

17 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

18 
	#SQUASHFS_MAGIC
 0x73717368

	)

19 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

20 
	#EFS_SUPER_MAGIC
 0x414A53

	)

21 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

22 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

23 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

24 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

25 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

26 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

27 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

28 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

29 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

31 
	#MINIX_SUPER_MAGIC
 0x137F

	)

32 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

33 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

34 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

35 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

37 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

38 
	#NCP_SUPER_MAGIC
 0x564ø

	)

39 
	#NFS_SUPER_MAGIC
 0x6969

	)

40 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

41 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

42 
	#QNX4_SUPER_MAGIC
 0x002à

	)

44 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

47 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

48 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

49 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

51 
	#SMB_SUPER_MAGIC
 0x517B

	)

52 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

53 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

55 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

57 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

59 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

60 
	#SOCKFS_MAGIC
 0x534F434B

	)

61 
	#V9FS_MAGIC
 0x01021997

	)

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/stdint.h

23 #iâdeà
_STDINT_H


24 
	#_STDINT_H
 1

	)

26 
	~<ã©u»s.h
>

27 
	~<b™s/wch¬.h
>

28 
	~<b™s/wÜdsize.h
>

35 #iâdeà
__št8_t_defšed


36 
	#__št8_t_defšed


	)

37 sigÃd 
	tšt8_t
;

38 
	tšt16_t
;

39 
	tšt32_t
;

40 #ià
__WORDSIZE
 == 64

41 
	tšt64_t
;

43 
__ex‹nsiÚ__


44 
	tšt64_t
;

49 
	tušt8_t
;

50 
	tušt16_t
;

51 #iâdeà
__ušt32_t_defšed


52 
	tušt32_t
;

53 
	#__ušt32_t_defšed


	)

55 #ià
__WORDSIZE
 == 64

56 
	tušt64_t
;

58 
__ex‹nsiÚ__


59 
	tušt64_t
;

66 sigÃd 
	tšt_Ëa¡8_t
;

67 
	tšt_Ëa¡16_t
;

68 
	tšt_Ëa¡32_t
;

69 #ià
__WORDSIZE
 == 64

70 
	tšt_Ëa¡64_t
;

72 
__ex‹nsiÚ__


73 
	tšt_Ëa¡64_t
;

77 
	tušt_Ëa¡8_t
;

78 
	tušt_Ëa¡16_t
;

79 
	tušt_Ëa¡32_t
;

80 #ià
__WORDSIZE
 == 64

81 
	tušt_Ëa¡64_t
;

83 
__ex‹nsiÚ__


84 
	tušt_Ëa¡64_t
;

91 sigÃd 
	tšt_ç¡8_t
;

92 #ià
__WORDSIZE
 == 64

93 
	tšt_ç¡16_t
;

94 
	tšt_ç¡32_t
;

95 
	tšt_ç¡64_t
;

97 
	tšt_ç¡16_t
;

98 
	tšt_ç¡32_t
;

99 
__ex‹nsiÚ__


100 
	tšt_ç¡64_t
;

104 
	tušt_ç¡8_t
;

105 #ià
__WORDSIZE
 == 64

106 
	tušt_ç¡16_t
;

107 
	tušt_ç¡32_t
;

108 
	tušt_ç¡64_t
;

110 
	tušt_ç¡16_t
;

111 
	tušt_ç¡32_t
;

112 
__ex‹nsiÚ__


113 
	tušt_ç¡64_t
;

118 #ià
__WORDSIZE
 == 64

119 #iâdeà
__šŒ_t_defšed


120 
	tšŒ_t
;

121 
	#__šŒ_t_defšed


	)

123 
	tušŒ_t
;

125 #iâdeà
__šŒ_t_defšed


126 
	tšŒ_t
;

127 
	#__šŒ_t_defšed


	)

129 
	tušŒ_t
;

134 #ià
__WORDSIZE
 == 64

135 
	tštmax_t
;

136 
	tuštmax_t
;

138 
__ex‹nsiÚ__


139 
	tštmax_t
;

140 
__ex‹nsiÚ__


141 
	tuštmax_t
;

147 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_LIMIT_MACROS


149 #ià
__WORDSIZE
 == 64

150 
	#__INT64_C
(
c
èø## 
L


	)

151 
	#__UINT64_C
(
c
èø## 
UL


	)

153 
	#__INT64_C
(
c
èø## 
LL


	)

154 
	#__UINT64_C
(
c
èø## 
ULL


	)

160 
	#INT8_MIN
 (-128)

	)

161 
	#INT16_MIN
 (-32767-1)

	)

162 
	#INT32_MIN
 (-2147483647-1)

	)

163 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

165 
	#INT8_MAX
 (127)

	)

166 
	#INT16_MAX
 (32767)

	)

167 
	#INT32_MAX
 (2147483647)

	)

168 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

171 
	#UINT8_MAX
 (255)

	)

172 
	#UINT16_MAX
 (65535)

	)

173 
	#UINT32_MAX
 (4294967295U)

	)

174 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

178 
	#INT_LEAST8_MIN
 (-128)

	)

179 
	#INT_LEAST16_MIN
 (-32767-1)

	)

180 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

181 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

183 
	#INT_LEAST8_MAX
 (127)

	)

184 
	#INT_LEAST16_MAX
 (32767)

	)

185 
	#INT_LEAST32_MAX
 (2147483647)

	)

186 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

189 
	#UINT_LEAST8_MAX
 (255)

	)

190 
	#UINT_LEAST16_MAX
 (65535)

	)

191 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

192 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

196 
	#INT_FAST8_MIN
 (-128)

	)

197 #ià
__WORDSIZE
 == 64

198 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

199 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

201 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

202 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

204 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

206 
	#INT_FAST8_MAX
 (127)

	)

207 #ià
__WORDSIZE
 == 64

208 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

209 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

211 
	#INT_FAST16_MAX
 (2147483647)

	)

212 
	#INT_FAST32_MAX
 (2147483647)

	)

214 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

217 
	#UINT_FAST8_MAX
 (255)

	)

218 #ià
__WORDSIZE
 == 64

219 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

220 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

222 
	#UINT_FAST16_MAX
 (4294967295U)

	)

223 
	#UINT_FAST32_MAX
 (4294967295U)

	)

225 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

229 #ià
__WORDSIZE
 == 64

230 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

231 
	#INTPTR_MAX
 (9223372036854775807L)

	)

232 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

234 
	#INTPTR_MIN
 (-2147483647-1)

	)

235 
	#INTPTR_MAX
 (2147483647)

	)

236 
	#UINTPTR_MAX
 (4294967295U)

	)

241 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

243 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

246 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

252 #ià
__WORDSIZE
 == 64

253 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

254 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

256 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

257 
	#PTRDIFF_MAX
 (2147483647)

	)

261 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

262 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

265 #ià
__WORDSIZE
 == 64

266 
	#SIZE_MAX
 (18446744073709551615UL)

	)

268 
	#SIZE_MAX
 (4294967295U)

	)

272 #iâdeà
WCHAR_MIN


274 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

275 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

279 
	#WINT_MIN
 (0u)

	)

280 
	#WINT_MAX
 (4294967295u)

	)

287 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_CONSTANT_MACROS


290 
	#INT8_C
(
c
è
	)
c

291 
	#INT16_C
(
c
è
	)
c

292 
	#INT32_C
(
c
è
	)
c

293 #ià
__WORDSIZE
 == 64

294 
	#INT64_C
(
c
èø## 
L


	)

296 
	#INT64_C
(
c
èø## 
LL


	)

300 
	#UINT8_C
(
c
è
	)
c

301 
	#UINT16_C
(
c
è
	)
c

302 
	#UINT32_C
(
c
èø## 
U


	)

303 #ià
__WORDSIZE
 == 64

304 
	#UINT64_C
(
c
èø## 
UL


	)

306 
	#UINT64_C
(
c
èø## 
ULL


	)

310 #ià
__WORDSIZE
 == 64

311 
	#INTMAX_C
(
c
èø## 
L


	)

312 
	#UINTMAX_C
(
c
èø## 
UL


	)

314 
	#INTMAX_C
(
c
èø## 
LL


	)

315 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/sys/ttydefaults.h

40 #iâdeà
_SYS_TTYDEFAULTS_H_


41 
	#_SYS_TTYDEFAULTS_H_


	)

46 
	#TTYDEF_IFLAG
 (
BRKINT
 | 
ISTRIP
 | 
ICRNL
 | 
IMAXBEL
 | 
IXON
 | 
IXANY
)

	)

47 
	#TTYDEF_OFLAG
 (
OPOST
 | 
ONLCR
 | 
XTABS
)

	)

48 
	#TTYDEF_LFLAG
 (
ECHO
 | 
ICANON
 | 
ISIG
 | 
IEXTEN
 | 
ECHOE
|
ECHOKE
|
ECHOCTL
)

	)

49 
	#TTYDEF_CFLAG
 (
CREAD
 | 
CS7
 | 
PARENB
 | 
HUPCL
)

	)

50 
	#TTYDEF_SPEED
 (
B9600
)

	)

55 
	#CTRL
(
x
è(x&037)

	)

56 
	#CEOF
 
	`CTRL
('d')

	)

57 #ifdeà
_POSIX_VDISABLE


58 
	#CEOL
 
_POSIX_VDISABLE


	)

60 
	#CEOL
 '\0'

	)

62 
	#CERASE
 0177

	)

63 
	#CINTR
 
	`CTRL
('c')

	)

64 #ifdeà
_POSIX_VDISABLE


65 
	#CSTATUS
 
_POSIX_VDISABLE


	)

67 
	#CSTATUS
 '\0'

	)

69 
	#CKILL
 
	`CTRL
('u')

	)

70 
	#CMIN
 1

	)

71 
	#CQUIT
 034

	)

72 
	#CSUSP
 
	`CTRL
('z')

	)

73 
	#CTIME
 0

	)

74 
	#CDSUSP
 
	`CTRL
('y')

	)

75 
	#CSTART
 
	`CTRL
('q')

	)

76 
	#CSTOP
 
	`CTRL
('s')

	)

77 
	#CLNEXT
 
	`CTRL
('v')

	)

78 
	#CDISCARD
 
	`CTRL
('o')

	)

79 
	#CWERASE
 
	`CTRL
('w')

	)

80 
	#CREPRINT
 
	`CTRL
('r')

	)

81 
	#CEOT
 
CEOF


	)

83 
	#CBRK
 
CEOL


	)

84 
	#CRPRNT
 
CREPRINT


	)

85 
	#CFLUSH
 
CDISCARD


	)

93 #ifdeà
TTYDEFCHARS


94 
cc_t
 
	g‰ydefch¬s
[
NCCS
] = {

95 
CEOF
, 
CEOL
, CEOL, 
CERASE
, 
CWERASE
, 
CKILL
, 
CREPRINT
,

96 
_POSIX_VDISABLE
, 
CINTR
, 
CQUIT
, 
CSUSP
, 
CDSUSP
, 
CSTART
, 
CSTOP
, 
CLNEXT
,

97 
CDISCARD
, 
CMIN
, 
CTIME
, 
CSTATUS
, 
_POSIX_VDISABLE


99 #undeà
TTYDEFCHARS


	@/usr/include/sys/ucontext.h

19 #iâdeà
_SYS_UCONTEXT_H


20 
	#_SYS_UCONTEXT_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	~<sigÇl.h
>

24 
	~<b™s/wÜdsize.h
>

28 
	~<b™s/sigcÚ‹xt.h
>

30 #ià
__WORDSIZE
 == 64

33 
	tg»g_t
;

36 
	#NGREG
 23

	)

39 
g»g_t
 
	tg»g£t_t
[
NGREG
];

41 #ifdeà
__USE_GNU


45 
	mREG_R8
 = 0,

46 
	#REG_R8
 
REG_R8


	)

47 
	mREG_R9
,

48 
	#REG_R9
 
REG_R9


	)

49 
	mREG_R10
,

50 
	#REG_R10
 
REG_R10


	)

51 
	mREG_R11
,

52 
	#REG_R11
 
REG_R11


	)

53 
	mREG_R12
,

54 
	#REG_R12
 
REG_R12


	)

55 
	mREG_R13
,

56 
	#REG_R13
 
REG_R13


	)

57 
	mREG_R14
,

58 
	#REG_R14
 
REG_R14


	)

59 
	mREG_R15
,

60 
	#REG_R15
 
REG_R15


	)

61 
	mREG_RDI
,

62 
	#REG_RDI
 
REG_RDI


	)

63 
	mREG_RSI
,

64 
	#REG_RSI
 
REG_RSI


	)

65 
	mREG_RBP
,

66 
	#REG_RBP
 
REG_RBP


	)

67 
	mREG_RBX
,

68 
	#REG_RBX
 
REG_RBX


	)

69 
	mREG_RDX
,

70 
	#REG_RDX
 
REG_RDX


	)

71 
	mREG_RAX
,

72 
	#REG_RAX
 
REG_RAX


	)

73 
	mREG_RCX
,

74 
	#REG_RCX
 
REG_RCX


	)

75 
	mREG_RSP
,

76 
	#REG_RSP
 
REG_RSP


	)

77 
	mREG_RIP
,

78 
	#REG_RIP
 
REG_RIP


	)

79 
	mREG_EFL
,

80 
	#REG_EFL
 
REG_EFL


	)

81 
	mREG_CSGSFS
,

82 
	#REG_CSGSFS
 
REG_CSGSFS


	)

83 
	mREG_ERR
,

84 
	#REG_ERR
 
REG_ERR


	)

85 
	mREG_TRAPNO
,

86 
	#REG_TRAPNO
 
REG_TRAPNO


	)

87 
	mREG_OLDMASK
,

88 
	#REG_OLDMASK
 
REG_OLDMASK


	)

89 
	mREG_CR2


90 
	#REG_CR2
 
REG_CR2


	)

94 
	s_libc_åx»g


96 
	msignifiÿnd
[4];

97 
	mexpÚ’t
;

98 
	m·ddšg
[3];

101 
	s_libc_xmm»g


103 
__ušt32_t
 
	m–em’t
[4];

106 
	s_libc_å¡©e


109 
__ušt16_t
 
	mcwd
;

110 
__ušt16_t
 
	mswd
;

111 
__ušt16_t
 
	máw
;

112 
__ušt16_t
 
	mfİ
;

113 
__ušt64_t
 
	mr
;

114 
__ušt64_t
 
	mrdp
;

115 
__ušt32_t
 
	mmxc¤
;

116 
__ušt32_t
 
	mmxü_mask
;

117 
_libc_åx»g
 
	m_¡
[8];

118 
_libc_xmm»g
 
	m_xmm
[16];

119 
__ušt32_t
 
	m·ddšg
[24];

123 
_libc_å¡©e
 *
	tå»g£t_t
;

128 
g»g£t_t
 
	mg»gs
;

130 
å»g£t_t
 
	må»gs
;

131 
	m__»£rved1
 [8];

132 } 
	tmcÚ‹xt_t
;

135 
	sucÚ‹xt


137 
	muc_æags
;

138 
ucÚ‹xt
 *
	muc_lšk
;

139 
¡ack_t
 
	muc_¡ack
;

140 
mcÚ‹xt_t
 
	muc_mcÚ‹xt
;

141 
__sig£t_t
 
	muc_sigmask
;

142 
_libc_å¡©e
 
	m__å»gs_mem
;

143 } 
	tucÚ‹xt_t
;

148 
	tg»g_t
;

151 
	#NGREG
 19

	)

154 
g»g_t
 
	tg»g£t_t
[
NGREG
];

156 #ifdeà
__USE_GNU


160 
	mREG_GS
 = 0,

161 
	#REG_GS
 
REG_GS


	)

162 
	mREG_FS
,

163 
	#REG_FS
 
REG_FS


	)

164 
	mREG_ES
,

165 
	#REG_ES
 
REG_ES


	)

166 
	mREG_DS
,

167 
	#REG_DS
 
REG_DS


	)

168 
	mREG_EDI
,

169 
	#REG_EDI
 
REG_EDI


	)

170 
	mREG_ESI
,

171 
	#REG_ESI
 
REG_ESI


	)

172 
	mREG_EBP
,

173 
	#REG_EBP
 
REG_EBP


	)

174 
	mREG_ESP
,

175 
	#REG_ESP
 
REG_ESP


	)

176 
	mREG_EBX
,

177 
	#REG_EBX
 
REG_EBX


	)

178 
	mREG_EDX
,

179 
	#REG_EDX
 
REG_EDX


	)

180 
	mREG_ECX
,

181 
	#REG_ECX
 
REG_ECX


	)

182 
	mREG_EAX
,

183 
	#REG_EAX
 
REG_EAX


	)

184 
	mREG_TRAPNO
,

185 
	#REG_TRAPNO
 
REG_TRAPNO


	)

186 
	mREG_ERR
,

187 
	#REG_ERR
 
REG_ERR


	)

188 
	mREG_EIP
,

189 
	#REG_EIP
 
REG_EIP


	)

190 
	mREG_CS
,

191 
	#REG_CS
 
REG_CS


	)

192 
	mREG_EFL
,

193 
	#REG_EFL
 
REG_EFL


	)

194 
	mREG_UESP
,

195 
	#REG_UESP
 
REG_UESP


	)

196 
	mREG_SS


197 
	#REG_SS
 
REG_SS


	)

202 
	s_libc_å»g


204 
	msignifiÿnd
[4];

205 
	mexpÚ’t
;

208 
	s_libc_å¡©e


210 
	mcw
;

211 
	msw
;

212 
	mg
;

213 
	moff
;

214 
	mcs£l
;

215 
	md©aoff
;

216 
	md©a£l
;

217 
_libc_å»g
 
	m_¡
[8];

218 
	m¡©us
;

222 
_libc_å¡©e
 *
	tå»g£t_t
;

227 
g»g£t_t
 
	mg»gs
;

230 
å»g£t_t
 
	må»gs
;

231 
	mŞdmask
;

232 
	mü2
;

233 } 
	tmcÚ‹xt_t
;

236 
	sucÚ‹xt


238 
	muc_æags
;

239 
ucÚ‹xt
 *
	muc_lšk
;

240 
¡ack_t
 
	muc_¡ack
;

241 
mcÚ‹xt_t
 
	muc_mcÚ‹xt
;

242 
__sig£t_t
 
	muc_sigmask
;

243 
_libc_å¡©e
 
	m__å»gs_mem
;

244 } 
	tucÚ‹xt_t
;

	@/usr/include/time.h

23 #iâdef 
_TIME_H


25 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

26 ! 
defšed
 
	g__Ãed_time¥ec
)

27 
	#_TIME_H
 1

	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


34 #ifdef 
_TIME_H


36 
	#__Ãed_size_t


	)

37 
	#__Ãed_NULL


	)

38 
	~<¡ddef.h
>

42 
	~<b™s/time.h
>

45 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


46 #iâdeà
CLK_TCK


47 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

53 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

54 
	#__şock_t_defšed
 1

	)

56 
	~<b™s/ty³s.h
>

58 
__BEGIN_NAMESPACE_STD


60 
__şock_t
 
	tşock_t
;

61 
	g__END_NAMESPACE_STD


62 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


63 
	$__USING_NAMESPACE_STD
(
şock_t
)

67 #undeà
__Ãed_şock_t


69 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

70 
	#__time_t_defšed
 1

	)

72 
	~<b™s/ty³s.h
>

74 
__BEGIN_NAMESPACE_STD


76 
__time_t
 
	ttime_t
;

77 
__END_NAMESPACE_STD


78 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC
 || defšed 
__USE_SVID


79 
	$__USING_NAMESPACE_STD
(
time_t
)

83 #undeà
__Ãed_time_t


85 #ià!
defšed
 
__şockid_t_defšed
 && \

86 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

87 
	#__şockid_t_defšed
 1

	)

89 
	~<b™s/ty³s.h
>

92 
__şockid_t
 
	tşockid_t
;

95 #undeà
__şockid_time_t


97 #ià!
defšed
 
__tim”_t_defšed
 && \

98 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

99 
	#__tim”_t_defšed
 1

	)

101 
	~<b™s/ty³s.h
>

104 
__tim”_t
 
	ttim”_t
;

107 #undeà
__Ãed_tim”_t


110 #ià!
defšed
 
__time¥ec_defšed
 && \

111 ((
defšed
 
_TIME_H
 && \

112 (
defšed
 
__USE_POSIX199309
 || defšed 
__USE_MISC
)) || \

113 
defšed
 
__Ãed_time¥ec
)

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 
__cÚ¡
 *
tm_zÚe
;

149 
__tm_gmtoff
;

150 
__cÚ¡
 *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 
__BEGIN_NAMESPACE_STD


183 
şock_t
 
	$şock
 (è
__THROW
;

186 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

189 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

190 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

193 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

199 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

200 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

201 
__cÚ¡
 
tm
 *
__»¡riù
 
__
è
__THROW
;

202 
__END_NAMESPACE_STD


204 #ifdeà
__USE_XOPEN


207 *
	$¡½time
 (
__cÚ¡
 *
__»¡riù
 
__s
,

208 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
)

209 
__THROW
;

212 #ifdeà
__USE_XOPEN2K8


215 
	~<xloÿË.h
>

217 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

218 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

219 
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

220 
__loÿË_t
 
__loc
è
__THROW
;

223 #ifdeà
__USE_GNU


224 *
	$¡½time_l
 (
__cÚ¡
 *
__»¡riù
 
__s
,

225 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

230 
__BEGIN_NAMESPACE_STD


233 
tm
 *
	$gmtime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

237 
tm
 *
	$loÿÉime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

238 
__END_NAMESPACE_STD


240 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


243 
tm
 *
	$gmtime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

244 
tm
 *
__»¡riù
 
__
è
__THROW
;

248 
tm
 *
	$loÿÉime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

249 
tm
 *
__»¡riù
 
__
è
__THROW
;

252 
__BEGIN_NAMESPACE_STD


255 *
	$asùime
 (
__cÚ¡
 
tm
 *
__
è
__THROW
;

258 *
	$ùime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

259 
__END_NAMESPACE_STD


261 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


266 *
	$asùime_r
 (
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

267 *
__»¡riù
 
__buf
è
__THROW
;

270 *
	$ùime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

271 *
__»¡riù
 
__buf
è
__THROW
;

276 *
__tzÇme
[2];

277 
__daylight
;

278 
__timezÚe
;

281 #ifdef 
__USE_POSIX


283 *
tzÇme
[2];

287 
	$tz£t
 (è
__THROW
;

290 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


291 
daylight
;

292 
timezÚe
;

295 #ifdeà
__USE_SVID


298 
	$¡ime
 (
__cÚ¡
 
time_t
 *
__wh’
è
__THROW
;

304 
	#__i¦—p
(
y—r
) \

305 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

308 #ifdeà
__USE_MISC


313 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

316 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

319 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

323 #ifdeà
__USE_POSIX199309


328 
	`Çno¦“p
 (
__cÚ¡
 
time¥ec
 *
__»que¡ed_time
,

329 
time¥ec
 *
__»maššg
);

333 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

336 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

339 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, 
__cÚ¡
 
time¥ec
 *
__
)

340 
__THROW
;

342 #ifdeà
__USE_XOPEN2K


347 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

348 
__cÚ¡
 
time¥ec
 *
__»q
,

349 
time¥ec
 *
__»m
);

352 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

357 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

358 
sigev’t
 *
__»¡riù
 
__evp
,

359 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

362 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

365 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

366 
__cÚ¡
 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

367 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

370 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

371 
__THROW
;

374 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

378 #ifdeà
__USE_XOPEN_EXTENDED


390 
g‘d©e_”r
;

399 
tm
 *
	`g‘d©e
 (
__cÚ¡
 *
__¡ršg
);

402 #ifdeà
__USE_GNU


413 
	`g‘d©e_r
 (
__cÚ¡
 *
__»¡riù
 
__¡ršg
,

414 
tm
 *
__»¡riù
 
__»sbuå
);

417 
__END_DECLS


	@/usr/include/xlocale.h

21 #iâdeà
_XLOCALE_H


22 
	#_XLOCALE_H
 1

	)

28 
	s__loÿË_¡ruù


31 
__loÿË_d©a
 *
	m__loÿËs
[13];

34 cÚ¡ *
	m__ùy³_b
;

35 cÚ¡ *
	m__ùy³_tŞow”
;

36 cÚ¡ *
	m__ùy³_touµ”
;

39 cÚ¡ *
	m__Çmes
[13];

40 } *
	t__loÿË_t
;

43 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/asm/ioctls.h

1 
	~<asm-g’”ic/ioùls.h
>

	@/usr/include/asm/types.h

1 #iâdeà
_ASM_X86_TYPES_H


2 
	#_ASM_X86_TYPES_H


	)

4 
	#dma_addr_t
 
dma_addr_t


	)

6 
	~<asm-g’”ic/ty³s.h
>

	@/usr/include/bits/byteswap.h

21 #ià!
defšed
 
_BYTESWAP_H
 && !defšed 
_NETINET_IN_H
 && !defšed 
_ENDIAN_H


25 #iâdeà
_BITS_BYTESWAP_H


26 
	#_BITS_BYTESWAP_H
 1

	)

28 
	~<b™s/wÜdsize.h
>

31 
	#__bsw­_cÚ¡ªt_16
(
x
) \

32 ((è((((
x
è>> 8è& 0xffè| (((xè& 0xffè<< 8)))

	)

34 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

35 
	#__bsw­_16
(
x
) \

36 (
__ex‹nsiÚ__
 \

37 ({ 
__v
, 
__x
 = (è(
x
); \

38 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

39 
__v
 = 
	`__bsw­_cÚ¡ªt_16
 (
__x
); \

41 
	`__asm__
 ("rorw $8, %w0" \

42 : "ô" (
__v
) \

43 : "0" (
__x
) \

45 
__v
; }))

	)

48 
	#__bsw­_16
(
x
) \

49 (
__ex‹nsiÚ__
 \

50 ({ 
__x
 = (è(
x
); \

51 
	`__bsw­_cÚ¡ªt_16
 (
__x
); }))

	)

56 
	#__bsw­_cÚ¡ªt_32
(
x
) \

57 ((((
x
) & 0xff000000) >> 24) | (((x) & 0x00ff0000) >> 8) | \

58 (((
x
è& 0x0000ff00è<< 8è| (((xè& 0x000000ffè<< 24))

	)

60 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

61 #ià
__WORDSIZE
 =ğ64 || (
defšed
 
__i486__
 || defšed 
__³Áium__
 \

62 || 
defšed
 
	g__³Áium´o__
 || defšed 
	g__³Áium4__
 \

63 || 
defšed
 
	g__k8__
 || defšed 
	g__©hlÚ__
 \

64 || 
defšed
 
	g__k6__
 || defšed 
	g__nocÚa__
 \

65 || 
defšed
 
	g__cÜe2__
 || defšed 
	g__geode__
 \

66 || 
defšed
 
	g__amdçm10__
)

69 
	#__bsw­_32
(
x
) \

70 (
__ex‹nsiÚ__
 \

71 ({ 
__v
, 
__x
 = (
x
); \

72 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

73 
__v
 = 
	`__bsw­_cÚ¡ªt_32
 (
__x
); \

75 
	`__asm__
 ("bsw­ %0" : "ô" (
__v
è: "0" (
__x
)); \

76 
__v
; }))

	)

78 
	#__bsw­_32
(
x
) \

79 (
__ex‹nsiÚ__
 \

80 ({ 
__v
, 
__x
 = (
x
); \

81 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

82 
__v
 = 
	`__bsw­_cÚ¡ªt_32
 (
__x
); \

84 
	`__asm__
 ("rorw $8, %w0;" \

87 : "ô" (
__v
) \

88 : "0" (
__x
) \

90 
__v
; }))

	)

93 
	#__bsw­_32
(
x
) \

94 (
__ex‹nsiÚ__
 \

95 ({ 
__x
 = (
x
); 
	`__bsw­_cÚ¡ªt_32
 (__x); }))

	)

99 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

101 
	#__bsw­_cÚ¡ªt_64
(
x
) \

102 ((((
x
) & 0xff00000000000000ull) >> 56) \

103 | (((
x
) & 0x00ff000000000000ull) >> 40) \

104 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

105 | (((
x
) & 0x000000ff00000000ull) >> 8) \

106 | (((
x
) & 0x00000000ff000000ull) << 8) \

107 | (((
x
) & 0x0000000000ff0000ull) << 24) \

108 | (((
x
) & 0x000000000000ff00ull) << 40) \

109 | (((
x
è& 0x00000000000000ffuÎè<< 56))

	)

111 #ià
__WORDSIZE
 == 64

112 
	#__bsw­_64
(
x
) \

113 (
__ex‹nsiÚ__
 \

114 ({ 
__v
, 
__x
 = (
x
); \

115 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

116 
__v
 = 
	`__bsw­_cÚ¡ªt_64
 (
__x
); \

118 
	`__asm__
 ("bsw­ %q0" : "ô" (
__v
è: "0" (
__x
)); \

119 
__v
; }))

	)

121 
	#__bsw­_64
(
x
) \

122 (
__ex‹nsiÚ__
 \

123 ({ uniÚ { 
__ex‹nsiÚ__
 
__Î
; \

124 
__l
[2]; } 
__w
, 
__r
; \

125 ià(
	`__butš_cÚ¡ªt_p
 (
x
)) \

126 
__r
.
__Î
 = 
	`__bsw­_cÚ¡ªt_64
 (
x
); \

129 
__w
.
__Î
 = (
x
); \

130 
__r
.
__l
[0] = 
	`__bsw­_32
 (
__w
.__l[1]); \

131 
__r
.
__l
[1] = 
	`__bsw­_32
 (
__w
.__l[0]); \

133 
__r
.
__Î
; }))

	)

	@/usr/include/bits/endian.h

3 #iâdeà
_ENDIAN_H


7 
	#__BYTE_ORDER
 
__LITTLE_ENDIAN


	)

	@/usr/include/bits/local_lim.h

25 #iâdeà
NR_OPEN


26 
	#__undef_NR_OPEN


	)

28 #iâdeà
LINK_MAX


29 
	#__undef_LINK_MAX


	)

31 #iâdeà
OPEN_MAX


32 
	#__undef_OPEN_MAX


	)

34 #iâdeà
ARG_MAX


35 
	#__undef_ARG_MAX


	)

39 
	~<lšux/lim™s.h
>

42 #ifdeà
__undef_NR_OPEN


43 #undeà
NR_OPEN


44 #undeà
__undef_NR_OPEN


47 #ifdeà
__undef_LINK_MAX


48 #undeà
LINK_MAX


49 #undeà
__undef_LINK_MAX


52 #ifdeà
__undef_OPEN_MAX


53 #undeà
OPEN_MAX


54 #undeà
__undef_OPEN_MAX


57 #ifdeà
__undef_ARG_MAX


58 #undeà
ARG_MAX


59 #undeà
__undef_ARG_MAX


63 
	#_POSIX_THREAD_KEYS_MAX
 128

	)

65 
	#PTHREAD_KEYS_MAX
 1024

	)

68 
	#_POSIX_THREAD_DESTRUCTOR_ITERATIONS
 4

	)

70 
	#PTHREAD_DESTRUCTOR_ITERATIONS
 
_POSIX_THREAD_DESTRUCTOR_ITERATIONS


	)

73 
	#_POSIX_THREAD_THREADS_MAX
 64

	)

75 #undeà
PTHREAD_THREADS_MAX


79 
	#AIO_PRIO_DELTA_MAX
 20

	)

82 
	#PTHREAD_STACK_MIN
 16384

	)

85 
	#DELAYTIMER_MAX
 2147483647

	)

88 
	#TTY_NAME_MAX
 32

	)

91 
	#LOGIN_NAME_MAX
 256

	)

94 
	#HOST_NAME_MAX
 64

	)

97 
	#MQ_PRIO_MAX
 32768

	)

100 
	#SEM_VALUE_MAX
 (2147483647)

	)

	@/usr/include/bits/predefs.h

19 #iâdeà
_FEATURES_H


23 #iâdeà
_PREDEFS_H


24 
	#_PREDEFS_H


	)

27 
	#__STDC_IEC_559__
 1

	)

28 
	#__STDC_IEC_559_COMPLEX__
 1

	)

	@/usr/include/bits/time.h

24 #iâdeà
__Ãed_timev®


25 #iâdeà
_BITS_TIME_H


26 
	#_BITS_TIME_H
 1

	)

34 
	#CLOCKS_PER_SEC
 1000000l

	)

36 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


39 
	~<b™s/ty³s.h
>

40 
__syscÚf
 ();

41 
	#CLK_TCK
 ((
__şock_t
è
	`__syscÚf
 (2)è

	)

44 #ifdeà
__USE_POSIX199309


46 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

50 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

52 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

54 
	#CLOCK_MONOTONIC_RAW
 4

	)

56 
	#CLOCK_REALTIME_COARSE
 5

	)

58 
	#CLOCK_MONOTONIC_COARSE
 6

	)

61 
	#TIMER_ABSTIME
 1

	)

67 #ifdeà
__Ãed_timev®


68 #undeà
__Ãed_timev®


69 #iâdeà
_STRUCT_TIMEVAL


70 
	#_STRUCT_TIMEVAL
 1

	)

71 
	~<b™s/ty³s.h
>

75 
	stimev®


77 
__time_t
 
	mtv_£c
;

78 
__su£cÚds_t
 
	mtv_u£c
;

	@/usr/include/bits/typesizes.h

20 #iâdeà
_BITS_TYPES_H


24 #iâdef 
_BITS_TYPESIZES_H


25 
	#_BITS_TYPESIZES_H
 1

	)

30 
	#__DEV_T_TYPE
 
__UQUAD_TYPE


	)

31 
	#__UID_T_TYPE
 
__U32_TYPE


	)

32 
	#__GID_T_TYPE
 
__U32_TYPE


	)

33 
	#__INO_T_TYPE
 
__ULONGWORD_TYPE


	)

34 
	#__INO64_T_TYPE
 
__UQUAD_TYPE


	)

35 
	#__MODE_T_TYPE
 
__U32_TYPE


	)

36 
	#__NLINK_T_TYPE
 
__UWORD_TYPE


	)

37 
	#__OFF_T_TYPE
 
__SLONGWORD_TYPE


	)

38 
	#__OFF64_T_TYPE
 
__SQUAD_TYPE


	)

39 
	#__PID_T_TYPE
 
__S32_TYPE


	)

40 
	#__RLIM_T_TYPE
 
__ULONGWORD_TYPE


	)

41 
	#__RLIM64_T_TYPE
 
__UQUAD_TYPE


	)

42 
	#__BLKCNT_T_TYPE
 
__SLONGWORD_TYPE


	)

43 
	#__BLKCNT64_T_TYPE
 
__SQUAD_TYPE


	)

44 
	#__FSBLKCNT_T_TYPE
 
__ULONGWORD_TYPE


	)

45 
	#__FSBLKCNT64_T_TYPE
 
__UQUAD_TYPE


	)

46 
	#__FSFILCNT_T_TYPE
 
__ULONGWORD_TYPE


	)

47 
	#__FSFILCNT64_T_TYPE
 
__UQUAD_TYPE


	)

48 
	#__ID_T_TYPE
 
__U32_TYPE


	)

49 
	#__CLOCK_T_TYPE
 
__SLONGWORD_TYPE


	)

50 
	#__TIME_T_TYPE
 
__SLONGWORD_TYPE


	)

51 
	#__USECONDS_T_TYPE
 
__U32_TYPE


	)

52 
	#__SUSECONDS_T_TYPE
 
__SLONGWORD_TYPE


	)

53 
	#__DADDR_T_TYPE
 
__S32_TYPE


	)

54 
	#__SWBLK_T_TYPE
 
__SLONGWORD_TYPE


	)

55 
	#__KEY_T_TYPE
 
__S32_TYPE


	)

56 
	#__CLOCKID_T_TYPE
 
__S32_TYPE


	)

57 
	#__TIMER_T_TYPE
 *

	)

58 
	#__BLKSIZE_T_TYPE
 
__SLONGWORD_TYPE


	)

59 
	#__FSID_T_TYPE
 sŒuù { 
__v®
[2]; }

	)

60 
	#__SSIZE_T_TYPE
 
__SWORD_TYPE


	)

63 
	#__FD_SETSIZE
 1024

	)

	@/usr/include/bits/wchar.h

20 #iâdeà
_BITS_WCHAR_H


21 
	#_BITS_WCHAR_H
 1

	)

24 #ifdeà
__WCHAR_MAX__


25 
	#__WCHAR_MAX
 
__WCHAR_MAX__


	)

27 
	#__WCHAR_MAX
 (2147483647)

	)

32 #ifdeà
__WCHAR_UNSIGNED__


33 
	#__WCHAR_MIN
 
L
'\0'

	)

37 #–ià
L
'\0' - 1 > 0

38 
	#__WCHAR_MIN
 
L
'\0'

	)

40 
	#__WCHAR_MIN
 (-
__WCHAR_MAX
 - 1)

	)

	@/usr/include/bits/wordsize.h

3 #ià
defšed
 
__x86_64__


4 
	#__WORDSIZE
 64

	)

5 
	#__WORDSIZE_COMPAT32
 1

	)

7 
	#__WORDSIZE
 32

	)

	@/usr/include/gnu/stubs.h

4 
	~<b™s/wÜdsize.h
>

6 #ià
__WORDSIZE
 == 32

7 
	~<gnu/¡ubs-32.h
>

8 #–ià
__WORDSIZE
 == 64

9 
	~<gnu/¡ubs-64.h
>

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__NFDBITS


22 
	#__NFDBITS
 (8 * ())

	)

24 #undeà
__FD_SETSIZE


25 
	#__FD_SETSIZE
 1024

	)

27 #undeà
__FDSET_LONGS


28 
	#__FDSET_LONGS
 (
__FD_SETSIZE
/
__NFDBITS
)

	)

30 #undeà
__FDELT


31 
	#__FDELT
(
d
è((dè/ 
__NFDBITS
)

	)

33 #undeà
__FDMASK


34 
	#__FDMASK
(
d
è(1UL << ((dè% 
__NFDBITS
))

	)

37 
	mfds_b™s
 [
__FDSET_LONGS
];

38 } 
	t__k”Ãl_fd_£t
;

41 (*
	t__k”Ãl_sighªdËr_t
)();

44 
	t__k”Ãl_key_t
;

45 
	t__k”Ãl_mqd_t
;

47 
	~<asm/posix_ty³s.h
>

	@/usr/include/sys/cdefs.h

20 #iâdef 
_SYS_CDEFS_H


21 
	#_SYS_CDEFS_H
 1

	)

24 #iâdeà
_FEATURES_H


25 
	~<ã©u»s.h
>

31 #ià
defšed
 
__GNUC__
 && !defšed 
__STDC__


36 #undeà
__P


37 #undeà
__PMT


39 #ifdeà
__GNUC__


46 #ià!
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (3, 3)

47 
	#__THROW
 
	`__©Œibu‹__
 ((
__nÙhrow__
))

	)

48 
	#__NTH
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
)è
	)
fct

50 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

51 
	#__THROW
 
	`throw
 ()

	)

52 
	#__NTH
(
fù
èfù 
	`throw
 ()

	)

54 
	#__THROW


	)

55 
	#__NTH
(
fù
è
	)
fct

61 
	#__šlše


	)

63 
	#__THROW


	)

64 
	#__NTH
(
fù
è
	)
fct

66 
	#__cÚ¡
 cÚ¡

	)

67 
	#__sigÃd
 sigÃd

	)

68 
	#__vŞ©e
 vŞ©e

	)

74 
	#__P
(
¬gs
è
	)
args

75 
	#__PMT
(
¬gs
è
	)
args

80 
	#__CONCAT
(
x
,
y
èx ## 
	)
y

81 
	#__STRING
(
x
è#x

	)

84 
	#__±r_t
 *

	)

85 
	#__lÚg_doubË_t
 

	)

89 #ifdef 
__ılu¥lus


90 
	#__BEGIN_DECLS
 "C" {

	)

91 
	#__END_DECLS
 }

	)

93 
	#__BEGIN_DECLS


	)

94 
	#__END_DECLS


	)

103 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES


104 
	#__BEGIN_NAMESPACE_STD
 
Çme¥aû
 
¡d
 {

	)

105 
	#__END_NAMESPACE_STD
 }

	)

106 
	#__USING_NAMESPACE_STD
(
Çme
è
usšg
 
¡d
::Çme;

	)

107 
	#__BEGIN_NAMESPACE_C99
 
Çme¥aû
 
__c99
 {

	)

108 
	#__END_NAMESPACE_C99
 }

	)

109 
	#__USING_NAMESPACE_C99
(
Çme
è
usšg
 
__c99
::Çme;

	)

114 
	#__BEGIN_NAMESPACE_STD


	)

115 
	#__END_NAMESPACE_STD


	)

116 
	#__USING_NAMESPACE_STD
(
Çme
)

	)

117 
	#__BEGIN_NAMESPACE_C99


	)

118 
	#__END_NAMESPACE_C99


	)

119 
	#__USING_NAMESPACE_C99
(
Çme
)

	)

124 #iâdeà
__BOUNDED_POINTERS__


125 
	#__bounded


	)

126 
	#__unbounded


	)

127 
	#__±rv®ue


	)

132 
	#__bos
(
±r
è
	`__butš_objeù_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

133 
	#__bos0
(
±r
è
	`__butš_objeù_size
 (±r, 0)

	)

135 #ià
__GNUC_PREREQ
 (4,3)

136 
	#__w¬ndeş
(
Çme
, 
msg
) \

137 
	`Çme
 (è
	`__©Œibu‹__
((
	`__w¬nšg__
 (
msg
)))

	)

138 
	#__w¬Ç‰r
(
msg
è
	`__©Œibu‹__
((
	`__w¬nšg__
 (msg)))

	)

139 
	#__”rÜdeş
(
Çme
, 
msg
) \

140 
	`Çme
 (è
	`__©Œibu‹__
((
	`__”rÜ__
 (
msg
)))

	)

142 
	#__w¬ndeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

143 
	#__w¬Ç‰r
(
msg
)

	)

144 
	#__”rÜdeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

148 #ià
__GNUC_PREREQ
 (2,97)

150 
	#__æex¬r
 []

	)

152 #ifdeà
__GNUC__


153 
	#__æex¬r
 [0]

	)

155 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

156 
	#__æex¬r
 []

	)

159 
	#__æex¬r
 [1]

	)

175 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

177 
	#__REDIRECT
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

178 #ifdeà
__ılu¥lus


179 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

180 
Çme
 
´Ùo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

182 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

183 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROW


	)

185 
	#__ASMNAME
(
úame
è
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, cÇme)

	)

186 
	#__ASMNAME2
(
´efix
, 
úame
è
	`__STRING
 (´efixè
	)
cname

199 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

200 
	#__©Œibu‹__
(
xyz
è

	)

206 #ià
__GNUC_PREREQ
 (2,96)

207 
	#__©Œibu‹_m®loc__
 
	`__©Œibu‹__
 ((
__m®loc__
))

	)

209 
	#__©Œibu‹_m®loc__


	)

215 #ià
__GNUC_PREREQ
 (2,96)

216 
	#__©Œibu‹_pu»__
 
	`__©Œibu‹__
 ((
__pu»__
))

	)

218 
	#__©Œibu‹_pu»__


	)

224 #ià
__GNUC_PREREQ
 (3,1)

225 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__u£d__
))

	)

226 
	#__©Œibu‹_nošlše__
 
	`__©Œibu‹__
 ((
__nošlše__
))

	)

228 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

229 
	#__©Œibu‹_nošlše__


	)

233 #ià
__GNUC_PREREQ
 (3,2)

234 
	#__©Œibu‹_d•»ÿ‹d__
 
	`__©Œibu‹__
 ((
__d•»ÿ‹d__
))

	)

236 
	#__©Œibu‹_d•»ÿ‹d__


	)

245 #ià
__GNUC_PREREQ
 (2,8)

246 
	#__©Œibu‹_fÜm©_¬g__
(
x
è
	`__©Œibu‹__
 ((
	`__fÜm©_¬g__
 (x)))

	)

248 
	#__©Œibu‹_fÜm©_¬g__
(
x
è

	)

255 #ià
__GNUC_PREREQ
 (2,97)

256 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
) \

257 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__¡rfmÚ__
, 
a
, 
b
)))

	)

259 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
è

	)

264 #ià
__GNUC_PREREQ
 (3,3)

265 
	#__nÚnuÎ
(
·¿ms
è
	`__©Œibu‹__
 ((
__nÚnuÎ__
…¬ams))

	)

267 
	#__nÚnuÎ
(
·¿ms
)

	)

272 #ià
__GNUC_PREREQ
 (3,4)

273 
	#__©Œibu‹_w¬n_unu£d_»suÉ__
 \

274 
	`__©Œibu‹__
 ((
__w¬n_unu£d_»suÉ__
))

	)

275 #ià
__USE_FORTIFY_LEVEL
 > 0

276 
	#__wur
 
__©Œibu‹_w¬n_unu£d_»suÉ__


	)

279 
	#__©Œibu‹_w¬n_unu£d_»suÉ__


	)

281 #iâdeà
__wur


282 
	#__wur


	)

286 #ià
__GNUC_PREREQ
 (3,2)

287 
	#__®ways_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__®ways_šlše__
))

	)

289 
	#__®ways_šlše
 
__šlše


	)

294 #ià!
defšed
 
__ılu¥lus
 || 
__GNUC_PREREQ
 (4,3)

295 #ià
defšed
 
__GNUC_STDC_INLINE__
 || defšed 
__ılu¥lus


296 
	#__ex‹º_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

297 #ià
__GNUC_PREREQ
 (4,3)

298 
	#__ex‹º_®ways_šlše
 \

299 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
, 
__¬tificŸl__
))

	)

301 
	#__ex‹º_®ways_šlše
 \

302 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

305 
	#__ex‹º_šlše
 
__šlše


	)

306 #ià
__GNUC_PREREQ
 (4,3)

307 
	#__ex‹º_®ways_šlše
 \

308 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__¬tificŸl__
))

	)

310 
	#__ex‹º_®ways_šlše
 
__®ways_šlše


	)

317 #ià
__GNUC_PREREQ
 (4,3)

318 
	#__va_¬g_·ck
(è
	`__butš_va_¬g_·ck
 ()

	)

319 
	#__va_¬g_·ck_Ën
(è
	`__butš_va_¬g_·ck_Ën
 ()

	)

326 #ià!
__GNUC_PREREQ
 (2,8)

327 
	#__ex‹nsiÚ__


	)

331 #ià!
__GNUC_PREREQ
 (2,92)

332 
	#__»¡riù


	)

338 #ià
__GNUC_PREREQ
 (3,1è&& !
defšed
 
__GNUG__


339 
	#__»¡riù_¬r
 
__»¡riù


	)

341 #ifdeà
__GNUC__


342 
	#__»¡riù_¬r


	)

344 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

345 
	#__»¡riù_¬r
 
»¡riù


	)

348 
	#__»¡riù_¬r


	)

353 
	~<b™s/wÜdsize.h
>

355 #ià
defšed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && defšed 
__NO_LONG_DOUBLE_MATH


356 
	#__LDBL_COMPAT
 1

	)

357 #ifdeà
__REDIRECT


358 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

359 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
) \

360 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

361 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT_NTH
 (Çme,…rÙo,‡lŸs)

	)

362 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
) \

363 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

364 
	#__LDBL_REDIR1_DECL
(
Çme
, 
®Ÿs
) \

365 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 (#®Ÿs));

	)

366 
	#__LDBL_REDIR_DECL
(
Çme
) \

367 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 ("__Ædbl_" #Çme));

	)

368 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

369 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

370 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

371 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

374 #ià!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT


375 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm
	)
proto

376 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
èÇm
	)
proto

377 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
__THROW


	)

378 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
èÇm´ÙØ
__THROW


	)

379 
	#__LDBL_REDIR_DECL
(
Çme
)

	)

380 #ifdeà
__REDIRECT


381 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

382 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

383 
	`__REDIRECT_NTH
 (
Çme
, 
´Ùo
, 
®Ÿs
)

	)

	@/usr/include/asm-generic/ioctls.h

1 #iâdeà
__ASM_GENERIC_IOCTLS_H


2 
	#__ASM_GENERIC_IOCTLS_H


	)

4 
	~<lšux/ioùl.h
>

19 
	#TCGETS
 0x5401

	)

20 
	#TCSETS
 0x5402

	)

21 
	#TCSETSW
 0x5403

	)

22 
	#TCSETSF
 0x5404

	)

23 
	#TCGETA
 0x5405

	)

24 
	#TCSETA
 0x5406

	)

25 
	#TCSETAW
 0x5407

	)

26 
	#TCSETAF
 0x5408

	)

27 
	#TCSBRK
 0x5409

	)

28 
	#TCXONC
 0x540A

	)

29 
	#TCFLSH
 0x540B

	)

30 
	#TIOCEXCL
 0x540C

	)

31 
	#TIOCNXCL
 0x540D

	)

32 
	#TIOCSCTTY
 0x540E

	)

33 
	#TIOCGPGRP
 0x540F

	)

34 
	#TIOCSPGRP
 0x5410

	)

35 
	#TIOCOUTQ
 0x5411

	)

36 
	#TIOCSTI
 0x5412

	)

37 
	#TIOCGWINSZ
 0x5413

	)

38 
	#TIOCSWINSZ
 0x5414

	)

39 
	#TIOCMGET
 0x5415

	)

40 
	#TIOCMBIS
 0x5416

	)

41 
	#TIOCMBIC
 0x5417

	)

42 
	#TIOCMSET
 0x5418

	)

43 
	#TIOCGSOFTCAR
 0x5419

	)

44 
	#TIOCSSOFTCAR
 0x541A

	)

45 
	#FIONREAD
 0x541B

	)

46 
	#TIOCINQ
 
FIONREAD


	)

47 
	#TIOCLINUX
 0x541C

	)

48 
	#TIOCCONS
 0x541D

	)

49 
	#TIOCGSERIAL
 0x541E

	)

50 
	#TIOCSSERIAL
 0x541F

	)

51 
	#TIOCPKT
 0x5420

	)

52 
	#FIONBIO
 0x5421

	)

53 
	#TIOCNOTTY
 0x5422

	)

54 
	#TIOCSETD
 0x5423

	)

55 
	#TIOCGETD
 0x5424

	)

56 
	#TCSBRKP
 0x5425

	)

57 
	#TIOCSBRK
 0x5427

	)

58 
	#TIOCCBRK
 0x5428

	)

59 
	#TIOCGSID
 0x5429

	)

60 
	#TCGETS2
 
	`_IOR
('T', 0x2A, 
‹rmios2
)

	)

61 
	#TCSETS2
 
	`_IOW
('T', 0x2B, 
‹rmios2
)

	)

62 
	#TCSETSW2
 
	`_IOW
('T', 0x2C, 
‹rmios2
)

	)

63 
	#TCSETSF2
 
	`_IOW
('T', 0x2D, 
‹rmios2
)

	)

64 
	#TIOCGRS485
 0x542E

	)

65 #iâdeà
TIOCSRS485


66 
	#TIOCSRS485
 0x542F

	)

68 
	#TIOCGPTN
 
	`_IOR
('T', 0x30, è

	)

69 
	#TIOCSPTLCK
 
	`_IOW
('T', 0x31, è

	)

70 
	#TIOCGDEV
 
	`_IOR
('T', 0x32, è

	)

71 
	#TCGETX
 0x5432

	)

72 
	#TCSETX
 0x5433

	)

73 
	#TCSETXF
 0x5434

	)

74 
	#TCSETXW
 0x5435

	)

75 
	#TIOCSIG
 
	`_IOW
('T', 0x36, è

	)

77 
	#FIONCLEX
 0x5450

	)

78 
	#FIOCLEX
 0x5451

	)

79 
	#FIOASYNC
 0x5452

	)

80 
	#TIOCSERCONFIG
 0x5453

	)

81 
	#TIOCSERGWILD
 0x5454

	)

82 
	#TIOCSERSWILD
 0x5455

	)

83 
	#TIOCGLCKTRMIOS
 0x5456

	)

84 
	#TIOCSLCKTRMIOS
 0x5457

	)

85 
	#TIOCSERGSTRUCT
 0x5458

	)

86 
	#TIOCSERGETLSR
 0x5459

	)

87 
	#TIOCSERGETMULTI
 0x545A

	)

88 
	#TIOCSERSETMULTI
 0x545B

	)

90 
	#TIOCMIWAIT
 0x545C

	)

91 
	#TIOCGICOUNT
 0x545D

	)

97 #iâdeà
FIOQSIZE


98 
	#FIOQSIZE
 0x5460

	)

102 
	#TIOCPKT_DATA
 0

	)

103 
	#TIOCPKT_FLUSHREAD
 1

	)

104 
	#TIOCPKT_FLUSHWRITE
 2

	)

105 
	#TIOCPKT_STOP
 4

	)

106 
	#TIOCPKT_START
 8

	)

107 
	#TIOCPKT_NOSTOP
 16

	)

108 
	#TIOCPKT_DOSTOP
 32

	)

109 
	#TIOCPKT_IOCTL
 64

	)

111 
	#TIOCSER_TEMT
 0x01

	)

	@/usr/include/asm-generic/types.h

1 #iâdeà
_ASM_GENERIC_TYPES_H


2 
	#_ASM_GENERIC_TYPES_H


	)

7 
	~<asm-g’”ic/št-Î64.h
>

9 #iâdeà
__ASSEMBLY__


11 
	tumode_t
;

	@/usr/include/asm/posix_types.h

1 #ifdeà
__i386__


2 
	~"posix_ty³s_32.h
"

4 
	~"posix_ty³s_64.h
"

	@/usr/include/gnu/stubs-32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___k”Ãl_co¦


	)

11 
	#__¡ub___k”Ãl_sšl


	)

12 
	#__¡ub___k”Ãl_Æ


	)

13 
	#__¡ub_chæags


	)

14 
	#__¡ub_ç‰ach


	)

15 
	#__¡ub_fchæags


	)

16 
	#__¡ub_fd‘ach


	)

17 
	#__¡ub_g‰y


	)

18 
	#__¡ub_lchmod


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-64.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub_bdæush


	)

11 
	#__¡ub_chæags


	)

12 
	#__¡ub_ç‰ach


	)

13 
	#__¡ub_fchæags


	)

14 
	#__¡ub_fd‘ach


	)

15 
	#__¡ub_g‘msg


	)

16 
	#__¡ub_g‰y


	)

17 
	#__¡ub_lchmod


	)

18 
	#__¡ub_putmsg


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@/usr/include/linux/limits.h

1 #iâdeà
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/stddef.h

1 #iâdeà
_LINUX_STDDEF_H


2 
	#_LINUX_STDDEF_H


	)

6 #undeà
NULL


7 #ià
defšed
(
__ılu¥lus
)

8 
	#NULL
 0

	)

10 
	#NULL
 ((*)0)

	)

	@/usr/include/asm-generic/int-ll64.h

8 #iâdeà
_ASM_GENERIC_INT_LL64_H


9 
	#_ASM_GENERIC_INT_LL64_H


	)

11 
	~<asm/b™¥”lÚg.h
>

13 #iâdeà
__ASSEMBLY__


19 
__sigÃd__
 
	t__s8
;

20 
	t__u8
;

22 
__sigÃd__
 
	t__s16
;

23 
	t__u16
;

25 
__sigÃd__
 
	t__s32
;

26 
	t__u32
;

28 #ifdeà
__GNUC__


29 
__ex‹nsiÚ__
 
__sigÃd__
 
	t__s64
;

30 
__ex‹nsiÚ__
 
	t__u64
;

32 
__sigÃd__
 
	t__s64
;

33 
	t__u64
;

	@/usr/include/linux/ioctl.h

1 #iâdeà
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/ioùl.h
>

	@/usr/include/asm/bitsperlong.h

1 #iâdeà
__ASM_X86_BITSPERLONG_H


2 
	#__ASM_X86_BITSPERLONG_H


	)

4 #ifdeà
__x86_64__


5 
	#__BITS_PER_LONG
 64

	)

7 
	#__BITS_PER_LONG
 32

	)

10 
	~<asm-g’”ic/b™¥”lÚg.h
>

	@/usr/include/asm/ioctl.h

1 
	~<asm-g’”ic/ioùl.h
>

	@/usr/include/asm-generic/bitsperlong.h

1 #iâdeà
__ASM_GENERIC_BITS_PER_LONG


2 
	#__ASM_GENERIC_BITS_PER_LONG


	)

11 #iâdeà
__BITS_PER_LONG


12 
	#__BITS_PER_LONG
 32

	)

	@/usr/include/asm-generic/ioctl.h

1 #iâdeà
_ASM_GENERIC_IOCTL_H


2 
	#_ASM_GENERIC_IOCTL_H


	)

22 
	#_IOC_NRBITS
 8

	)

23 
	#_IOC_TYPEBITS
 8

	)

30 #iâdeà
_IOC_SIZEBITS


31 
	#_IOC_SIZEBITS
 14

	)

34 #iâdeà
_IOC_DIRBITS


35 
	#_IOC_DIRBITS
 2

	)

38 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

39 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

40 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

41 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

43 
	#_IOC_NRSHIFT
 0

	)

44 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

45 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

46 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

53 #iâdeà
_IOC_NONE


54 
	#_IOC_NONE
 0U

	)

57 #iâdeà
_IOC_WRITE


58 
	#_IOC_WRITE
 1U

	)

61 #iâdeà
_IOC_READ


62 
	#_IOC_READ
 2U

	)

65 
	#_IOC
(
dœ
,
ty³
,
Ä
,
size
) \

66 (((
dœ
è<< 
_IOC_DIRSHIFT
) | \

67 ((
ty³
è<< 
_IOC_TYPESHIFT
) | \

68 ((
Ä
è<< 
_IOC_NRSHIFT
) | \

69 ((
size
è<< 
_IOC_SIZESHIFT
))

	)

71 
	#_IOC_TYPECHECK
(
t
è(Ñ))

	)

74 
	#_IO
(
ty³
,
Ä
è
	`_IOC
(
_IOC_NONE
,Ñy³),Òr),0)

	)

75 
	#_IOR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

76 
	#_IOW
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

77 
	#_IOWR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

78 
	#_IOR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(size))

	)

79 
	#_IOW_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(size))

	)

80 
	#_IOWR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(size))

	)

83 
	#_IOC_DIR
(
Ä
è((Òrè>> 
_IOC_DIRSHIFT
è& 
_IOC_DIRMASK
)

	)

84 
	#_IOC_TYPE
(
Ä
è((Òrè>> 
_IOC_TYPESHIFT
è& 
_IOC_TYPEMASK
)

	)

85 
	#_IOC_NR
(
Ä
è((Òrè>> 
_IOC_NRSHIFT
è& 
_IOC_NRMASK
)

	)

86 
	#_IOC_SIZE
(
Ä
è((Òrè>> 
_IOC_SIZESHIFT
è& 
_IOC_SIZEMASK
)

	)

90 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

91 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

92 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
è<< 
_IOC_DIRSHIFT
)

	)

93 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

94 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@
1
.
1
/usr/include
81
1861
bus.c
core.c
desc.c
desc.h
dev-audio.c
dev-bluetooth.c
dev-hid.c
dev-hub.c
dev-network.c
dev-serial.c
dev-smartcard-reader.c
dev-storage.c
dev-uas.c
dev-wacom.c
hcd-ehci.c
hcd-musb.c
hcd-ohci.c
hcd-uhci.c
hcd-xhci.c
host-bsd.c
host-linux.c
host-stub.c
libhw.c
redirect.c
/usr/include/audio/audio.h
/usr/include/ctype.h
/usr/include/dirent.h
/usr/include/inttypes.h
/usr/include/linux/usbdevice_fs.h
/usr/include/linux/version.h
/usr/include/signal.h
/usr/include/sys/ioctl.h
/usr/include/audio/Amd.h
/usr/include/bits/dirent.h
/usr/include/bits/ioctl-types.h
/usr/include/bits/ioctls.h
/usr/include/bits/posix1_lim.h
/usr/include/bits/pthreadtypes.h
/usr/include/bits/sigaction.h
/usr/include/bits/sigcontext.h
/usr/include/bits/siginfo.h
/usr/include/bits/signum.h
/usr/include/bits/sigset.h
/usr/include/bits/sigstack.h
/usr/include/bits/sigthread.h
/usr/include/bits/types.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/linux/magic.h
/usr/include/linux/types.h
/usr/include/stdint.h
/usr/include/sys/ttydefaults.h
/usr/include/sys/ucontext.h
/usr/include/time.h
/usr/include/xlocale.h
/usr/include/asm/ioctls.h
/usr/include/asm/types.h
/usr/include/bits/byteswap.h
/usr/include/bits/endian.h
/usr/include/bits/local_lim.h
/usr/include/bits/predefs.h
/usr/include/bits/time.h
/usr/include/bits/typesizes.h
/usr/include/bits/wchar.h
/usr/include/bits/wordsize.h
/usr/include/gnu/stubs.h
/usr/include/linux/posix_types.h
/usr/include/sys/cdefs.h
/usr/include/asm-generic/ioctls.h
/usr/include/asm-generic/types.h
/usr/include/asm/posix_types.h
/usr/include/gnu/stubs-32.h
/usr/include/gnu/stubs-64.h
/usr/include/linux/limits.h
/usr/include/linux/stddef.h
/usr/include/asm-generic/int-ll64.h
/usr/include/linux/ioctl.h
/usr/include/asm/bitsperlong.h
/usr/include/asm/ioctl.h
/usr/include/asm-generic/bitsperlong.h
/usr/include/asm-generic/ioctl.h
